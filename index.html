
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Kevin博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Kevin">
    

    
    <meta name="description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">
<meta property="og:type" content="website">
<meta property="og:title" content="Kevin博客">
<meta property="og:url" content="https://kevin1202.github.io/index.html">
<meta property="og:site_name" content="Kevin博客">
<meta property="og:description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kevin博客">
<meta name="twitter:description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Kevin博客" title="Kevin博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Kevin博客">Kevin博客</a></h1>
				<h2 class="blog-motto">梦想还是要有的，万一实现了呢？</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" maxlength="20" placeholder="Search" />
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/05/08/详解https是如何确保安全的/" title="详解https是如何确保安全" itemprop="url">详解https是如何确保安全</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-05-08T07:56:08.000Z" itemprop="datePublished"> 发表于 2017-05-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>## </p>
<h2 id="什么是Https"><a href="#什么是Https" class="headerlink" title="什么是Https"></a>什么是Https</h2><p>HTTPS（全称：Hypertext Transfer Protocol over Secure Socket Layer），是以安全为目标的HTTP通道，简单讲是HTTP的安全版。即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL</p>
<h2 id="Https的作用"><a href="#Https的作用" class="headerlink" title="Https的作用"></a>Https的作用</h2><ul>
<li><strong>内容加密</strong> 建立一个信息安全通道，来保证数据传输的安全；</li>
<li><strong>身份认证</strong> 确认网站的真实性</li>
<li><strong>数据完整性</strong> 防止内容被第三方冒充或者篡改</li>
</ul>
<h2 id="Https的劣势"><a href="#Https的劣势" class="headerlink" title="Https的劣势"></a>Https的劣势</h2><ul>
<li><p>对数据进行加解密决定了它比http慢</p>
<blockquote>
<p>需要进行非对称的加解密，且需要三次握手。首次连接比较慢点，当然现在也有很多的优化。</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>出于安全考虑，浏览器不会在本地保存HTTPS缓存。实际上，只要在HTTP头中使用特定命令，HTTPS是可以缓存的。Firefox默认只在内存中缓存HTTPS。但是，只要头命令中有Cache-Control: Public，缓存就会被写到硬盘上。 IE只要http头允许就可以缓存https内容，缓存策略与是否使用HTTPS协议无关。</p>
</blockquote>
<h2 id="HTTPS和HTTP的区别"><a href="#HTTPS和HTTP的区别" class="headerlink" title="HTTPS和HTTP的区别"></a>HTTPS和HTTP的区别</h2><ul>
<li>https协议需要到CA申请证书。</li>
<li>http是超文本传输协议，信息是明文传输；https 则是具有安全性的ssl加密传输协议。</li>
<li>http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。</li>
<li>http的连接很简单，是无状态的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议安全。</li>
</ul>
<blockquote>
<p>http默认使用80端口，https默认使用443端口</p>
</blockquote>
<p>下面就是https的整个架构，现在的https基本都使用TLS了，因为更加安全，所以下图中的SSL应该换为<strong>SSL/TLS</strong>。</p>
<p><img src="http://mmbiz.qpic.cn/mmbiz/ibuh47bPhianbbnEUSiac5BKJCbtiaZ1uZLDFLico9mfqrX1FFibicCQ54FznUrHa02icVZKA5LrW3MzZfIOVXtWPqic4Xg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="img"></p>
<p>下面就上图中的知识点进行一个大概的介绍。</p>
<h1 id="加解密相关知识"><a href="#加解密相关知识" class="headerlink" title="加解密相关知识"></a>加解密相关知识</h1><h2 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h2><p>对称加密(也叫私钥加密)指加密和解密使用相同密钥的加密算法。有时又叫传统密码算法，就是加密密钥能够从解密密钥中推算出来，同时解密密钥也可以从加密密钥中推算出来。而在大多数的对称算法中，加密密钥和解密密钥是相同的，所以也称这种加密算法为秘密密钥算法或单密钥算法。<br>常见的对称加密有：DES（Data Encryption Standard）、AES（Advanced Encryption Standard）、RC4、IDEA</p>
<h2 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h2><p>与对称加密算法不同，非对称加密算法需要两个密钥：公开密钥（publickey）和私有密钥（privatekey）；并且加密密钥和解密密钥是成对出现的。非对称加密算法在加密和解密过程使用了不同的密钥，非对称加密也称为公钥加密，在密钥对中，其中一个密钥是对外公开的，所有人都可以获取到，称为公钥，其中一个密钥是不公开的称为私钥。</p>
<blockquote>
<p>非对称加密算法对加密内容的长度有限制，不能超过公钥长度。比如现在常用的公钥长度是 2048 位，意味着待加密内容不能超过 256 个字节。</p>
</blockquote>
<h2 id="摘要算法"><a href="#摘要算法" class="headerlink" title="摘要算法"></a>摘要算法</h2><p>数字摘要是采用单项Hash函数将需要加密的明文“摘要”成一串固定长度（128位）的密文，这一串密文又称为数字指纹，它有固定的长度，而且不同的明文摘要成密文，其结果总是不同的，而同样的明文其摘要必定一致。“数字摘要“是https能确保数据完整性和防篡改的根本原因。</p>
<h2 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h2><p>数字签名技术就是对“非对称密钥加解密”和“数字摘要“两项技术的应用，它将摘要信息用发送者的私钥加密，与原文一起传送给接收者。接收者只有用发送者的公钥才能解密被加密的摘要信息，然后用HASH函数对收到的原文产生一个摘要信息，与解密的摘要信息对比。如果相同，则说明收到的信息是完整的，在传输过程中没有被修改，否则说明信息被修改过，因此数字签名能够验证信息的完整性。</p>
<p>数字签名的过程如下：</p>
<p><code>明文 --&gt; hash运算 --&gt; 摘要 --&gt; 私钥加密 --&gt; 数字签名</code></p>
<p>数字签名有两种功效：<br>一、能确定消息确实是由发送方签名并发出来的，因为别人假冒不了发送方的签名。<br>二、数字签名能确定消息的完整性。</p>
<blockquote>
<p><strong>注意：</strong><br>数字签名只能验证数据的完整性，数据本身是否加密不属于数字签名的控制范围</p>
</blockquote>
<h2 id="数字证书"><a href="#数字证书" class="headerlink" title="数字证书"></a>数字证书</h2><h3 id="为什么要有数字证书？"><a href="#为什么要有数字证书？" class="headerlink" title="为什么要有数字证书？"></a>为什么要有数字证书？</h3><p>对于请求方来说，它怎么能确定它所得到的公钥一定是从目标主机那里发布的，而且没有被篡改过呢？亦或者请求的目标主机本本身就从事窃取用户信息的不正当行为呢？这时候，我们需要有一个权威的值得信赖的第三方机构(一般是由政府审核并授权的机构)来统一对外发放主机机构的公钥，只要请求方这种机构获取公钥，就避免了上述问题的发生。</p>
<h3 id="数字证书的颁发过程"><a href="#数字证书的颁发过程" class="headerlink" title="数字证书的颁发过程"></a>数字证书的颁发过程</h3><p>用户首先产生自己的密钥对，并将公共密钥及部分个人身份信息传送给认证中心。认证中心在核实身份后，将执行一些必要的步骤，以确信请求确实由用户发送而来，然后，认证中心将发给用户一个数字证书，该证书内包含用户的个人信息和他的公钥信息，同时还附有认证中心的签名信息(根证书私钥签名)。用户就可以使用自己的数字证书进行相关的各种活动。数字证书由独立的证书发行机构发布，数字证书各不相同，每种证书可提供不同级别的可信度。</p>
<h3 id="证书包含哪些内容"><a href="#证书包含哪些内容" class="headerlink" title="证书包含哪些内容"></a>证书包含哪些内容</h3><ul>
<li>证书颁发机构的名称</li>
<li>证书本身的数字签名</li>
<li>证书持有者公钥</li>
<li>证书签名用到的Hash算法</li>
</ul>
<h3 id="验证证书的有效性"><a href="#验证证书的有效性" class="headerlink" title="验证证书的有效性"></a>验证证书的有效性</h3><p><strong>浏览器默认都会内置CA根证书，其中根证书包含了CA的公钥</strong></p>
<ol>
<li>证书颁发的机构是伪造的：浏览器不认识，直接认为是危险证书</li>
<li>证书颁发的机构是确实存在的，于是根据CA名，找到对应内置的CA根证书、CA的公钥。用CA的公钥，对伪造的证书的摘要进行解密，发现解不了，认为是危险证书。</li>
<li>对于篡改的证书，使用CA的公钥对数字签名进行解密得到摘要A，然后再根据签名的Hash算法计算出证书的摘要B，对比A与B，若相等则正常，若不相等则是被篡改过的。</li>
<li>证书可在其过期前被吊销，通常情况是该证书的私钥已经失密。较新的浏览器如Chrome、Firefox、Opera和Internet Explorer都实现了在线证书状态协议（OCSP）以排除这种情形：浏览器将网站提供的证书的序列号通过OCSP发送给证书颁发机构，后者会告诉浏览器证书是否还是有效的。</li>
</ol>
<blockquote>
<p>1、2点是对伪造证书进行的，3是对于篡改后的证书验证，4是对于过期失效的验证。</p>
</blockquote>
<h1 id="SSL-与-TLS"><a href="#SSL-与-TLS" class="headerlink" title="SSL 与 TLS"></a>SSL 与 TLS</h1><h2 id="SSL-Secure-Socket-Layer，安全套接字层"><a href="#SSL-Secure-Socket-Layer，安全套接字层" class="headerlink" title="SSL (Secure Socket Layer，安全套接字层)"></a>SSL (Secure Socket Layer，安全套接字层)</h2><p>SSL为Netscape所研发，用以保障在Internet上数据传输之安全，利用数据加密(Encryption)技术，可确保数据在网络上之传输过程中不会被截取，当前为3.0版本。</p>
<p>SSL协议可分为两层： SSL记录协议（SSL Record Protocol）：它建立在可靠的传输协议（如TCP）之上，为高层协议提供数据封装、压缩、加密等基本功能的支持。 SSL握手协议（SSL Handshake Protocol）：它建立在SSL记录协议之上，用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。</p>
<h2 id="TLS-Transport-Layer-Security，传输层安全协议"><a href="#TLS-Transport-Layer-Security，传输层安全协议" class="headerlink" title="TLS (Transport Layer Security，传输层安全协议)"></a>TLS (Transport Layer Security，传输层安全协议)</h2><p>用于两个应用程序之间提供保密性和数据完整性。<br>TLS 1.0是IETF（Internet Engineering Task Force，Internet工程任务组）制定的一种新的协议，它建立在SSL 3.0协议规范之上，是SSL 3.0的后续版本，可以理解为SSL 3.1，它是写入了 RFC 的。该协议由两层组成： TLS 记录协议（TLS Record）和 TLS 握手协议（TLS Handshake）。较低的层为 TLS 记录协议，位于某个可靠的传输协议（例如 TCP）上面。</p>
<h2 id="SSL-TLS协议作用："><a href="#SSL-TLS协议作用：" class="headerlink" title="SSL/TLS协议作用："></a>SSL/TLS协议作用：</h2><ul>
<li>认证用户和服务器，确保数据发送到正确的客户机和服务器；</li>
<li>加密数据以防止数据中途被窃取；</li>
<li>维护数据的完整性，确保数据在传输过程中不被改变。</li>
</ul>
<h2 id="TLS比SSL的优势"><a href="#TLS比SSL的优势" class="headerlink" title="TLS比SSL的优势"></a>TLS比SSL的优势</h2><ol>
<li>对于消息认证使用密钥散列法：TLS 使用“消息认证代码的密钥散列法”（HMAC），当记录在开放的网络（如因特网）上传送时，该代码确保记录不会被变更。SSLv3.0还提供键控消息认证，但HMAC比SSLv3.0使用的（消息认证代码）MAC 功能更安全。</li>
<li>增强的伪随机功能（PRF）：PRF生成密钥数据。在TLS中，HMAC定义PRF。PRF使用两种散列算法保证其安全性。如果任一算法暴露了，只要第二种算法未暴露，则数据仍然是安全的。</li>
<li>改进的已完成消息验证：TLS和SSLv3.0都对两个端点提供已完成的消息，该消息认证交换的消息没有被变更。然而，TLS将此已完成消息基于PRF和HMAC值之上，这也比SSLv3.0更安全。</li>
<li>一致证书处理：与SSLv3.0不同，TLS试图指定必须在TLS之间实现交换的证书类型。</li>
<li>特定警报消息：TLS提供更多的特定和附加警报，以指示任一会话端点检测到的问题。TLS还对何时应该发送某些警报进行记录。</li>
</ol>
<h2 id="SSL、TLS的握手过程"><a href="#SSL、TLS的握手过程" class="headerlink" title="SSL、TLS的握手过程"></a>SSL、TLS的握手过程</h2><p>SSL与TLS握手整个过程如下图所示，下面会详细介绍每一步的具体内容：</p>
<p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="img"></p>
<h3 id="客户端首次发出请求"><a href="#客户端首次发出请求" class="headerlink" title="客户端首次发出请求"></a>客户端首次发出请求</h3><p>由于客户端(如浏览器)对一些加解密算法的支持程度不一样，但是在TLS协议传输过程中必须使用同一套加解密算法才能保证数据能够正常的加解密。在TLS握手阶段，客户端首先要告知服务端，自己支持哪些加密算法，所以客户端需要将本地支持的加密套件(Cipher Suite)的列表传送给服务端。除此之外，客户端还要产生一个随机数，这个随机数一方面需要在客户端保存，另一方面需要传送给服务端，客户端的随机数需要跟服务端产生的随机数结合起来产生后面要讲到的 Master Secret 。</p>
<p>客户端需要提供如下信息：</p>
<ul>
<li>支持的协议版本，比如TLS 1.0版</li>
<li>一个客户端生成的随机数，稍后用于生成”对话密钥”</li>
<li>支持的加密方法，比如RSA公钥加密</li>
<li>支持的压缩方法</li>
</ul>
<h3 id="服务端首次回应"><a href="#服务端首次回应" class="headerlink" title="服务端首次回应"></a>服务端首次回应</h3><p>服务端在接收到客户端的Client Hello之后，服务端需要确定加密协议的版本，以及加密的算法，然后也生成一个随机数，以及将自己的证书发送给客户端一并发送给客户端，这里的随机数是整个过程的第二个随机数。</p>
<p>服务端需要提供的信息：</p>
<ul>
<li>协议的版本</li>
<li>加密的算法</li>
<li>随机数</li>
<li>服务器证书</li>
</ul>
<h3 id="客户端再次回应"><a href="#客户端再次回应" class="headerlink" title="客户端再次回应"></a>客户端再次回应</h3><p>客户端首先会对服务器下发的证书进行验证，验证通过之后，则会继续下面的操作，客户端再次产生一个随机数（第三个随机数），然后使用服务器证书中的公钥进行加密，以及放一个ChangeCipherSpec消息即编码改变的消息，还有整个前面所有消息的hash值，进行服务器验证，然后用新秘钥加密一段数据一并发送到服务器，确保正式通信前无误。<br>客户端使用前面的两个随机数以及刚刚新生成的新随机数，使用与服务器确定的加密算法，生成一个Session Secret。</p>
<blockquote>
<p>ChangeCipherSpec<br>ChangeCipherSpec是一个独立的协议，体现在数据包中就是一个字节的数据，用于告知服务端，客户端已经切换到之前协商好的加密套件（Cipher Suite）的状态，准备使用之前协商好的加密套件加密数据并传输了。</p>
</blockquote>
<h3 id="服务器再次响应"><a href="#服务器再次响应" class="headerlink" title="服务器再次响应"></a>服务器再次响应</h3><p>服务端在接收到客户端传过来的第三个随机数的 加密数据之后，使用私钥对这段加密数据进行解密，并对数据进行验证，也会使用跟客户端同样的方式生成秘钥，一切准备好之后，也会给客户端发送一个 ChangeCipherSpec，告知客户端已经切换到协商过的加密套件状态，准备使用加密套件和 Session Secret加密数据了。之后，服务端也会使用 Session Secret 加密一段 Finish 消息发送给客户端，以验证之前通过握手建立起来的加解密通道是否成功。</p>
<h3 id="后续客户端与服务器间通信"><a href="#后续客户端与服务器间通信" class="headerlink" title="后续客户端与服务器间通信"></a>后续客户端与服务器间通信</h3><p>确定秘钥之后，服务器与客户端之间就会通过商定的秘钥加密消息了，进行通讯了。整个握手过程也就基本完成了。</p>
<blockquote>
<p>值得特别提出的是：<br>SSL协议在握手阶段使用的是非对称加密，在传输阶段使用的是对称加密，也就是说在SSL上传送的数据是使用对称密钥加密的！因为非对称加密的速度缓慢，耗费资源。其实当客户端和主机使用非对称加密方式建立连接后，客户端和主机已经决定好了在传输过程使用的对称加密算法和关键的对称加密密钥，由于这个过程本身是安全可靠的，也即对称加密密钥是不可能被窃取盗用的，因此，保证了在传输过程中对数据进行对称加密也是安全可靠的，因为除了客户端和主机之外，不可能有第三方窃取并解密出对称加密密钥！如果有人窃听通信，他可以知道双方选择的加密方法，以及三个随机数中的两个。整个通话的安全，只取决于第三个随机数（Premaster secret）能不能被破解。</p>
</blockquote>
<h3 id="其他补充"><a href="#其他补充" class="headerlink" title="其他补充"></a>其他补充</h3><p>对于非常重要的保密数据，服务端还需要对客户端进行验证，以保证数据传送给了安全的合法的客户端。服务端可以向客户端发出 Cerficate Request 消息，要求客户端发送证书对客户端的合法性进行验证。比如，金融机构往往只允许认证客户连入自己的网络，就会向正式客户提供USB密钥，里面就包含了一张客户端证书。</p>
<p>PreMaster secret前两个字节是TLS的版本号，这是一个比较重要的用来核对握手数据的版本号，因为在Client Hello阶段，客户端会发送一份加密套件列表和当前支持的SSL/TLS的版本号给服务端，而且是使用明文传送的，如果握手的数据包被破解之后，攻击者很有可能串改数据包，选择一个安全性较低的加密套件和版本给服务端，从而对数据进行破解。所以，服务端需要对密文中解密出来对的PreMaster版本号跟之前Client Hello阶段的版本号进行对比，如果版本号变低，则说明被串改，则立即停止发送任何消息。</p>
<h2 id="session的恢复"><a href="#session的恢复" class="headerlink" title="session的恢复"></a>session的恢复</h2><p>有两种方法可以恢复原来的session：一种叫做session ID，另一种叫做session ticket。</p>
<h3 id="session-ID"><a href="#session-ID" class="headerlink" title="session ID"></a>session ID</h3><p>session ID的思想很简单，就是每一次对话都有一个编号（session ID）。如果对话中断，下次重连的时候，只要客户端给出这个编号，且服务器有这个编号的记录，双方就可以重新使用已有的”对话密钥”，而不必重新生成一把。</p>
<blockquote>
<p>session ID是目前所有浏览器都支持的方法，但是它的缺点在于session ID往往只保留在一台服务器上。所以，如果客户端的请求发到另一台服务器，就无法恢复对话</p>
</blockquote>
<h3 id="session-ticket"><a href="#session-ticket" class="headerlink" title="session ticket"></a>session ticket</h3><p>客户端发送一个服务器在上一次对话中发送过来的session ticket。这个session ticket是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如对话密钥和加密方法。当服务器收到session ticket以后，解密后就不必重新生成对话密钥了。</p>
<blockquote>
<p>目前只有Firefox和Chrome浏览器支持。</p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>https实际就是在TCP层与http层之间加入了SSL/TLS来为上层的安全保驾护航，主要用到对称加密、非对称加密、证书，等技术进行客户端与服务器的数据加密传输，最终达到保证整个通信的安全性。</p>
<blockquote>
<p><strong>*参考文章</strong>数字证书的基础知识HTTPS科普扫盲帖和安全有关的那些事OpenSSL 与 SSL 数字证书概念贴基于OpenSSL自建CA和颁发SSL证书聊聊HTTPS和SSL/TLS协议SSL/TLS协议运行机制的概述图解SSL/TLS协议大型网站的 HTTPS 实践SSL/TLS原理详解扒一扒HTTPS网站的内幕白话解释 OSI模型，TLS/SSL 及 HTTPSOpenSSL HeartBleed漏洞原理漫画图解*</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/05/08/详解https是如何确保安全的/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/05/08/详解https是如何确保安全的/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/05/07/面试知识点/" title="面试知识点" itemprop="url">面试知识点</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-05-07T01:02:01.000Z" itemprop="datePublished"> 发表于 2017-05-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li><p>单元测试</p>
</li>
<li><p>对mvp框架的理解，有什么优点？ </p>
</li>
<li><p>activity的四种启动模式: standard(标准模式)、singtop 栈顶模式 singtask、singinstance</p>
</li>
<li><p>Activity生命周期？ oncreate—&gt;onrestart—&gt;onstart—&gt;onresume—&gt;onpause—&gt;onstop—&gt;ondestory</p>
</li>
<li><p>Service生命周期？这里要注意service有两种启动方式，startService()和bindService()：</p>
<p>oncreate—&gt;onstartcommand—&gt;ondestory</p>
<p>oncreate—&gt;onbind—&gt;onunbind—&gt;ondestory</p>
</li>
<li><p>理解Activity，View,Window三者关系？</p>
<p>activity 启动的时候会初始化一个Window，准确的说是phonewindow，这个phonewindow有一个ViewRoot，这个ViewRoot是一个view或viewgroup，是最初始的根布局，“ViewRoot”通过addView方法来一个个的添加View。比如TextView，Button等，这些View的事件监听，是由WindowManagerService来接受消息，并且回调Activity函数。比如onClickListener，onKeyDown等。</p>
</li>
<li><p>View的绘制流程？</p>
</li>
<li><p>Touch事件传递机制？</p>
</li>
<li><p>界面性能优化？ </p>
<ul>
<li>ui过渡绘制，</li>
<li>android 系统要求每一帧都要在16ms内完成</li>
<li>耗时操作放在非ui线程操作</li>
<li>Lint工具检测布局</li>
<li>对布局嵌套进行优化</li>
</ul>
</li>
<li><p>java内存的分配:</p>
<ul>
<li>静态存储区：编译时就分配好，在程序整个运行期间都存在。主要存在静态数据和常量</li>
<li>栈区：方法执行时，会在栈区内存中创建方法体内的局部变量，方法结束后，自动释放内存。</li>
<li>堆区：通常存放new 出来的对象，由java 垃圾回收器回收。</li>
</ul>
</li>
<li><p>四种引用类型的介绍：</p>
<ul>
<li>强引用：JVM宁可跑出oom，也不让gc回收具有强引用的对象</li>
<li>软引用：只有当内存不足的时，才会被回收的对象</li>
<li>弱引用：在GC时，一旦发现了具有弱引用的对象，不管内存是否足够与否，都会回收ta的内存</li>
<li>虚引用：任何时候都可以被GC回收</li>
</ul>
</li>
<li><p>造成内存泄漏的几个原因：</p>
<ul>
<li>单例模式</li>
<li>handle </li>
<li>context 的不正确使用</li>
<li>资源没有关闭，比如cursor， stream broadcastrevices</li>
<li>注册监听器的泄漏</li>
<li>非静态内部类的静态实例</li>
<li>Webview 造成的泄漏</li>
<li>集合中对象没有清理造成的内存泄漏</li>
<li>线程造成的内存泄漏，比如 AsyncTask， 任务没有执行完，ta 隐式的拥有activity的引用</li>
</ul>
</li>
<li><p>ANR</p>
</li>
<li><p>Threadlocal 怎么使用？</p>
</li>
<li><p>设计模式</p>
</li>
<li><p>算法</p>
</li>
<li><p>handle 原理</p>
</li>
<li><p>http tcp ip 怎么理解</p>
</li>
<li><p>对链表结构的理解？</p>
</li>
<li><p>对于集合的理解：</p>
<ul>
<li>List：有序、元素可重复，有索引<ul>
<li>ArrayList ：查询快，增删慢，不同步</li>
<li>LinkedList：查询慢，增删快，不同步</li>
</ul>
</li>
<li>Set:无序，无索引，元素不可以重复<ul>
<li>HashSet:底层是哈希表，无序，线程不同步<ul>
<li>LinkedHashSet 有序，是hashset的子类</li>
</ul>
</li>
<li>TreeSet:底层是二叉树，可对元素进行排序</li>
</ul>
</li>
<li>Map:<ul>
<li>HashTable:底层数据结构是哈希表，同步，不能存入null键和null值</li>
<li>HashMap:底层数据结构也是哈希表，不同步，能存null键和null值</li>
<li>TreeMap:底层数据结构是二叉树，不同步，可排序</li>
</ul>
</li>
</ul>
</li>
<li><p>collection与map的区别？</p>
<ul>
<li>单列集合，一次只能存入一个元素collection， map双列集合，一次存一对集合</li>
</ul>
</li>
<li><p>对于多线程的理解？</p>
<ul>
<li>进程和线程：进程是静态的，而线程是动态的，是真正执行的单元，执行的过程，线程是作为进程的一个单元存在的</li>
<li>同样作为基本的执行单位，线程是划分的比进程更小的执行单位</li>
<li>每个进程都有一段专用的内存区域。于此相反，线程却共享内存单元（包括代码和数据），通过共享的内存单元来实现数据交换，实时通信与必要的同步操作。</li>
<li>创建线程的方式：<ul>
<li>继承thread<ul>
<li>定义一个类继承Thread</li>
<li>覆盖Thread中的run方法</li>
<li>直接创建Thread子类对象</li>
<li>调用start 方法</li>
</ul>
</li>
<li>实现runnbale<ul>
<li>定义类实现runnable接口</li>
<li>覆盖Runnable接口中的run方法</li>
<li>通过Thread创建线程对象</li>
<li>将Runnable接口的子类对象作为Thread类的构造函数参数进行传递</li>
</ul>
</li>
<li>两个的区别：继承方式：线程代码放在继承thread子类的run方法中，实现方式，线程代码放在Runnable的子类run方法中，这样的好处避免了单继承的局限性，建议使用。</li>
</ul>
</li>
<li>线程的状态<ul>
<li>创建： start（）</li>
<li>临时状态</li>
<li>运行状态</li>
<li>冻结状态</li>
<li>消亡状态</li>
</ul>
</li>
<li>wait和sleep的区别?</li>
<li>进程的级别：<ul>
<li>前台进程</li>
<li>可视进程</li>
<li>服务进程</li>
<li>后台进程</li>
<li>空进程</li>
</ul>
</li>
</ul>
</li>
<li><p>android中的四大组件？</p>
</li>
<li><p>android序列化的方式 ，原理有什么区别？</p>
</li>
<li><p>线程池是什么？</p>
</li>
<li><p>位移？</p>
</li>
<li><p>xml/json解析数据区别？</p>
</li>
<li><p>怎么加载一张大图片？</p>
</li>
<li><p>android 消息推送原理？</p>
</li>
<li><p>webview的bug？</p>
</li>
<li><p>奔溃日志的处理？</p>
</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/05/07/面试知识点/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/05/07/面试知识点/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/gradle技巧之语法浅谈/" title="gradle技巧之语法浅谈" itemprop="url">gradle技巧之语法浅谈</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://trickyandroid.com/gradle-tip-2-understanding-syntax/" target="_blank" rel="external">Gradle tip #2: understanding syntax</a></li>
</ul>
<h1 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h1><p>在上一篇的博文(Gradle tip #2 : Tasks)中,我们讨论了gradle构建的基本单位Task. 并且介绍了构建过程的各个阶段及其生命周期.而本文会重点介绍gradle的语法.只有具备了gradle<br>的相关语法知识,才会大幅度的提高对于阅读、学习或者编写gradle脚本的效率,正所谓”磨刀不误砍柴工”是也.</p>
<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>gradle 是groovy语言实现的构建工具. groovy是运行在jvm平台的一门敏捷开发语言.其语法和java有诸多类似之处,然而其具备一些java没有的概念需要读者细细体会.下面会详细的介绍<br>groovy的基本语法,当然如果您已经对groovy的语法有了一定的了解.可以直接跳过这一小节.</p>
<h2 id="1、闭包的基本语法"><a href="#1、闭包的基本语法" class="headerlink" title="1、闭包的基本语法"></a>1、闭包的基本语法</h2><p>闭包是groovy中最重要的概念之一. 简单地说闭包(Closures)是一段代码块. 这个代码块可以接受参数并具有返回值. 有一点要非常注意的是, 闭包往往不是在需要使用的时候才写出来<br>这么一段代码(就像Java的匿名类那样), 通过def 关键字可以声明一个变量代表一个闭包,然后在需要的时候直接使用该变量即可,多说无益,请看如下的例子:</p>
<h4 id="一个简单的hello-world闭包"><a href="#一个简单的hello-world闭包" class="headerlink" title="一个简单的hello world闭包:"></a>一个简单的hello world闭包:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">def myClosure = &#123; println &apos;Hello world!&apos; &#125;</div><div class="line"></div><div class="line">//execute our closure</div><div class="line">myClosure()</div></pre></td></tr></table></figure>
<p>output: Hello world!</p>
<h4 id="如下是一个接受参数的闭包的例子"><a href="#如下是一个接受参数的闭包的例子" class="headerlink" title="如下是一个接受参数的闭包的例子:"></a>如下是一个接受参数的闭包的例子:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">def myClosure = &#123;String str -&gt; println str &#125;</div><div class="line"></div><div class="line">//execute our closure</div><div class="line">myClosure(&apos;Hello world!&apos;)</div></pre></td></tr></table></figure>
<p>output: Hello world!</p>
<h4 id="如果闭包只接受一个参数-这个参数在代码块中可以用it代替"><a href="#如果闭包只接受一个参数-这个参数在代码块中可以用it代替" class="headerlink" title="如果闭包只接受一个参数,这个参数在代码块中可以用it代替:"></a>如果闭包只接受一个参数,这个参数在代码块中可以用it代替:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">def myClosure = &#123;println it &#125;</div><div class="line"></div><div class="line">//execute our closure</div><div class="line">myClosure(&apos;Hello world!&apos;)</div></pre></td></tr></table></figure>
<p>output: Hello world!</p>
<h4 id="如下是接受多个参数的闭包的例子"><a href="#如下是接受多个参数的闭包的例子" class="headerlink" title="如下是接受多个参数的闭包的例子:"></a>如下是接受多个参数的闭包的例子:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">def myClosure = &#123;String str, int num -&gt; println &quot;$str : $num&quot; &#125;</div><div class="line"></div><div class="line">//execute our closure</div><div class="line">myClosure(&apos;my string&apos;, 21)</div></pre></td></tr></table></figure>
<p>output: my string : 21</p>
<h4 id="闭包里面的参数类型可以省略不写-例子如下"><a href="#闭包里面的参数类型可以省略不写-例子如下" class="headerlink" title="闭包里面的参数类型可以省略不写,例子如下:"></a>闭包里面的参数类型可以省略不写,例子如下:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">def myClosure = &#123;str, num -&gt; println &quot;$str : $num&quot; &#125;</div><div class="line"></div><div class="line">//execute our closure</div><div class="line">myClosure(&apos;my string&apos;, 21)</div></pre></td></tr></table></figure>
<p>output: my string : 21</p>
<h4 id="闭包还有一个比较酷的写法就是-可以直接调用context里面的变量-默认的context就是创建这个闭包的类-class-例子如下"><a href="#闭包还有一个比较酷的写法就是-可以直接调用context里面的变量-默认的context就是创建这个闭包的类-class-例子如下" class="headerlink" title="闭包还有一个比较酷的写法就是,可以直接调用context里面的变量,默认的context就是创建这个闭包的类(class) 例子如下:"></a>闭包还有一个比较酷的写法就是,可以直接调用context里面的变量,默认的context就是创建这个闭包的类(class) 例子如下:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">def myVar = &apos;Hello World!&apos;</div><div class="line">def myClosure = &#123;println myVar&#125;</div><div class="line">myClosure()</div></pre></td></tr></table></figure>
<p>output: Hello world!</p>
<h4 id="上面提到了闭包可以直接调用context的变量-这个context可以通过setDelegate-方法来改变-极大的增加了闭包的灵活性！"><a href="#上面提到了闭包可以直接调用context的变量-这个context可以通过setDelegate-方法来改变-极大的增加了闭包的灵活性！" class="headerlink" title="上面提到了闭包可以直接调用context的变量,这个context可以通过setDelegate()方法来改变,极大的增加了闭包的灵活性！"></a>上面提到了闭包可以直接调用context的变量,这个context可以通过setDelegate()方法来改变,极大的增加了闭包的灵活性！</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">def myClosure = &#123;println myVar&#125; //I&apos;m referencing myVar from MyClass class</div><div class="line">MyClass m = new MyClass()</div><div class="line">myClosure.setDelegate(m)</div><div class="line">myClosure()</div><div class="line"></div><div class="line">class MyClass &#123;</div><div class="line">    def myVar = &apos;Hello from MyClass!&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>output: Hello from MyClass!</p>
<h2 id="2、闭包可以作为参数进行传递"><a href="#2、闭包可以作为参数进行传递" class="headerlink" title="2、闭包可以作为参数进行传递"></a>2、闭包可以作为参数进行传递</h2><p>在groovy中,将闭包作为参数传递进函数,是将逻辑进行分离解耦的重要手段.在上述的例子中,我们已经尝试了如何将闭包作为参数进行传递.下面我们总结一下传递闭包的方法:</p>
<h4 id="1-接受一个参数的函数"><a href="#1-接受一个参数的函数" class="headerlink" title="1 接受一个参数的函数"></a>1 接受一个参数的函数</h4><p>myMethod(myClosure)</p>
<h4 id="2-如果函数只接受一个参数-括号可以忽略"><a href="#2-如果函数只接受一个参数-括号可以忽略" class="headerlink" title="2 如果函数只接受一个参数,括号可以忽略"></a>2 如果函数只接受一个参数,括号可以忽略</h4><p>myMethod myClosure</p>
<h4 id="3-可以将闭包以插入语的形式创建"><a href="#3-可以将闭包以插入语的形式创建" class="headerlink" title="3 可以将闭包以插入语的形式创建"></a>3 可以将闭包以插入语的形式创建</h4><p>myMethod {println ‘Hello World’}</p>
<h4 id="4-函数接受两个参数"><a href="#4-函数接受两个参数" class="headerlink" title="4 函数接受两个参数"></a>4 函数接受两个参数</h4><p>myMethod(arg1, myClosure)</p>
<h4 id="5-接受两个参数-同样可以用插入语创建闭包"><a href="#5-接受两个参数-同样可以用插入语创建闭包" class="headerlink" title="5 接受两个参数,同样可以用插入语创建闭包"></a>5 接受两个参数,同样可以用插入语创建闭包</h4><p>myMethod(arg1, { println ‘Hello World’ })</p>
<h4 id="6-如果存在多个参数-且最后一个参数是闭包-闭包可以不写在括号内"><a href="#6-如果存在多个参数-且最后一个参数是闭包-闭包可以不写在括号内" class="headerlink" title="6 如果存在多个参数,且最后一个参数是闭包,闭包可以不写在括号内"></a>6 如果存在多个参数,且最后一个参数是闭包,闭包可以不写在括号内</h4><p>myMethod(arg1) { println ‘Hello World’ }</p>
<p>细心的朋友们是不是觉得上述的六种用法中,第三条和第六条很眼熟？很像gradle中的scripts了？</p>
<h1 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h1><p>在知道了groovy的基本语法(尤其是闭包)之后,下面我们就以一个简单的gradle 脚本作为例子具体感受一下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath &apos;com.android.tools.build:gradle:1.2.3&apos;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结合前文的例子,我们可以很容易的理解到,buildscript是一个接受闭包作为参数的函数,这个函数会在编译的时候被gradle调用.这个函数的定义就类似于:def buildscript(Closure closure).  而allprojects 同理也是一个接受闭包作为参数的函数.</p>
<p>那么问题来了,这些函数具体会在什么时候被gradle调用呢?要回答这个问题就需要介绍另一个知识点：Project</p>
<h1 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h1><p>在这里,我觉得逐句翻译作者查阅文档的步骤没有太大的意义，我自己总结了一下作者的概念如下：</p>
<p>理解gradle配置文件中的script如何调用的关键就是理解project的相关概念.在gradle执行某个”任务”的时候,会按照各个task的依赖关系来依次执行. 而执行这些task的对象就是Project.说的在通俗一些,project就是你希望gradle为你做的事情,而要完成这些事情,需要将事情分成步骤一步一步的做,这些步骤就是task.</p>
<h1 id="Script-blocks"><a href="#Script-blocks" class="headerlink" title="Script blocks"></a>Script blocks</h1><p>通过前文的学习,我们已经很清楚的了解到scipt block就是一段接受闭包的函数,这些函数会被Project调用,默认的情况下,gradle 已经准备<br>好了很多script用于我们对项目进行配置,例如buildScript{} … … 当然你也可以自己写出符合规范的task来在编译的过程中被调用.</p>
<p>下面我们先看一下Android Studio中默认的script:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;com.android.application&apos;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 22</div><div class="line">    buildToolsVersion &quot;22.0.1&quot;</div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId &quot;com.trickyandroid.testapp&quot;</div><div class="line">        minSdkVersion 16</div><div class="line">        targetSdkVersion 22</div><div class="line">        versionCode 1</div><div class="line">        versionName &quot;1.0&quot;</div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled false</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>按照我们已经有的知识,上面的脚本说明有一个名称为android的函数,该函数接收闭包作为参数,然而其实在Gradle的文档中是不存在这个函数<br>的. 那么android脚本怎么会出现在这里呢? 答案就是最上面的apply plugin:<br>‘com.android.application’.这个插件提供了android构建所需要的各种script.</p>
<p>既然gradle官方的文档中没有android相关的script信息,那我们该怎么查阅呢? 您可以去官方的android网站上查阅,如果懒得找的话请点击这个链接:<a href="https://developer.android.com/shareables/sdk-tools/android-gradle-plugin-dsl.zip" target="_blank" rel="external">https://developer.android.com/shareables/sdk-tools/android-gradle-plugin-dsl.zip</a></p>
<p>您下载了前文连接的文档后，可以发现有一个html格式的文档的名字是AppExtension, 这个文档主要就是介绍了Android configuration blocks. 即在gradle官方文档中没有的关于Android 配置的各种gradle script都可以在这里进行查阅(几个例子):<br>1、 compileSdkVersion 在文档中的描述是Required. Compile SDK version. 即这个脚本是gradle进行Android构建之必需,并且这个脚本是<br>是用来描述编译的时候使用的sdk版本.<br>2、buildToolsVersion在文档中的描述是Required. Version of the build tools to use. 即该脚本是构建之必需,其用于告诉gradle使用<br>哪个版本的build tools<br>3 … … (详细情况请参阅文档吧:))</p>
<h1 id="Exercise"><a href="#Exercise" class="headerlink" title="Exercise"></a>Exercise</h1><p>有了前文的学习作为基础,我们已经了解了gradle语法以及android 插件的脚本查阅方法. 那么接下来我们实际运用这些知识,自定义的对我们<br>的Android项目进行一些配置. 在上述的AppExtension文档中,我查阅到了一个脚本的名字是testOptions. 这段脚本代表的是TestOption class<br>调用,TestOption class里有三个属性:reportDir、resultsDir 和unitTests. 而reportDir就是测试报告最后保存的位置,我们现在就来改一下<br>这个地方.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">......</div><div class="line">    testOptions &#123;</div><div class="line">        reportDir &quot;$rootDir/test_reports&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里,我使用了”$rootDir/test_reports”作为测试结果的储存位置, $root 指向的就是项目的根目录.现在如果我通过命令行执行<br>./gradlew connectedCheck. gradle就会进行一系列的测试程序并且将测试报告保存在项目根目录下的test_reports文件中.</p>
<p>注意一点的是,这个关于测试的小例子,别用在你真是的生产环境中,尽量保持你项目结构的”清洁”</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/gradle技巧之语法浅谈/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/gradle技巧之语法浅谈/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android-Design-Support-Library/" title="Android Design Support Library" itemprop="url">Android Design Support Library</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://android-developers.blogspot.jp/2015/05/android-design-support-library.html" target="_blank" rel="external">Android Design Support Library</a></li>
</ul>
<p>Android 5.0是有史以来最重要的Android 版本之一，这其中有很大部分要归功于Material design的引入，这种新的设计语言让整个Android的用户体验焕然一新。我们的详细专题是帮助你开始采用Material Design。但是我们也知道，这种设计对于开发者，尤其是那些在意向后兼容的开发者来说是一种挑战。在Android Design Support Library的帮助下，我们为所有的开发者，所有2.1以上的设备，带来了一些重要的Material design控件。你可以在这里面找到Navigation Drawer View，输入控件的悬浮标签，Floating Action Button，Snackbar，Tab以及将这些控件结合在一起的手势滚动框架。</p>
<p><a href="https://youtu.be/32i7ot0y78U" target="_blank" rel="external">YouTube的介绍</a></p>
<p>###Navigation View</p>
<p><a href="http://www.google.com/design/spec/patterns/navigation-drawer.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">Navigation drawer</a>是app识别度与内部导航的关键，保持这里设计上的一致性对app的可用性至关重要，尤其是对于第一次使用的用户。 NavigationView 通过提供抽屉导航所需的框架让实现更简单，同时它还能够直接通过菜单资源文件直接生成导航元素。</p>
<p><img src="http://3.bp.blogspot.com/-WmBBQQEJIKM/VWikAyy08sI/AAAAAAAABvc/1R36Txk83UI/s400/drawer.png" alt=""></p>
<p>把NavigationView作为DrawerLayout的内容视图来使用，布局如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;android.support.v4.widget.DrawerLayout</div><div class="line">        xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">        xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        android:fitsSystemWindows=&quot;true&quot;&gt;</div><div class="line"></div><div class="line">    &lt;!-- your content layout --&gt;</div><div class="line"></div><div class="line">    &lt;android.support.design.widget.NavigationView</div><div class="line">            android:layout_width=&quot;wrap_content&quot;</div><div class="line">            android:layout_height=&quot;match_parent&quot;</div><div class="line">            android:layout_gravity=&quot;start&quot;</div><div class="line">            app:headerLayout=&quot;@layout/drawer_header&quot;</div><div class="line">            app:menu=&quot;@menu/drawer&quot;/&gt;</div><div class="line">&lt;/android.support.v4.widget.DrawerLayout&gt;</div></pre></td></tr></table></figure>
<p>你会注意到 NavigationView 的两个属性：app:headerLayout  - 控制头部的布局， app:menu - 导航菜单的资源文件（也可以在运行时配置）。NavigationView处理好了和状态栏的关系，可以确保NavigationView在API21+设备上正确的和状态栏交互。</p>
<p>最简单的抽屉菜单往往是几个可点击的菜单的集合：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;group android:checkableBehavior=&quot;single&quot;&gt;</div><div class="line">    &lt;item</div><div class="line">        android:id=&quot;@+id/navigation_item_1&quot;</div><div class="line">        android:checked=&quot;true&quot;</div><div class="line">        android:icon=&quot;@drawable/ic_android&quot;</div><div class="line">        android:title=&quot;@string/navigation_item_1&quot;/&gt;</div><div class="line">    &lt;item</div><div class="line">        android:id=&quot;@+id/navigation_item_2&quot;</div><div class="line">        android:icon=&quot;@drawable/ic_android&quot;</div><div class="line">        android:title=&quot;@string/navigation_item_2&quot;/&gt;</div><div class="line">&lt;/group&gt;</div></pre></td></tr></table></figure>
<p>被点击过的item会高亮显示在抽屉菜单中，让用户知道当前是哪个菜单被选中。<br>你也可以在menu中使用subheader来为菜单分组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;item</div><div class="line">    android:id=&quot;@+id/navigation_subheader&quot;</div><div class="line">    android:title=&quot;@string/navigation_subheader&quot;&gt;</div><div class="line">    &lt;menu&gt;</div><div class="line">        &lt;item</div><div class="line">            android:id=&quot;@+id/navigation_sub_item_1&quot;</div><div class="line">            android:icon=&quot;@drawable/ic_android&quot;</div><div class="line">            android:title=&quot;@string/navigation_sub_item_1&quot;/&gt;</div><div class="line">        &lt;item</div><div class="line">            android:id=&quot;@+id/navigation_sub_item_2&quot;</div><div class="line">            android:icon=&quot;@drawable/ic_android&quot;</div><div class="line">            android:title=&quot;@string/navigation_sub_item_2&quot;/&gt;</div><div class="line">    &lt;/menu&gt;</div><div class="line">&lt;/item&gt;</div></pre></td></tr></table></figure>
<p>你可以通过设置一个OnNavigationItemSelectedListener，使用其setNavigationItemSelectedListener()来获得元素被选中的回调事件。它为你提供可以点击的<a href="http://developer.android.com/reference/android/view/MenuItem.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">MenuItem</a>，让你可以处理选择事件，改变复选框状态，加载新内容，关闭导航菜单，以及其他任何你想做的操作。</p>
<p>###Floating labels for editing text</p>
<p>即便是十分简单的EditText，在Material Design 中也有提升的空间。在EditText中，当你填入第一个字符后，hint就消失了。现在将它换成<a href="http://developer.android.com/reference/android/support/design/widget/TextInputLayout.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">TextInputLayout</a>，提示信息会变成一个显示在EditText之上的floating label，这样用户就始终知道他们现在输入的是什么。</p>
<p><img src="http://4.bp.blogspot.com/-BUKc5AwzS4A/VWihVlHr9cI/AAAAAAAABvI/rslBAoaHwzA/s1600/textinputlayout.png" alt=""></p>
<p>除此以外，还可以通过setError()设置当用户输入不合法时的Error提示；</p>
<p>###Floating Action Button</p>
<p><a href="http://www.google.com/design/spec/components/buttons-floating-action-button.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">Floating action button</a>是一个负责显示界面基本操作的圆形按钮。Design library中的<a href="http://developer.android.com/reference/android/support/design/widget/FloatingActionButton.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">FloatingActionButton</a> 实现了一个默认颜色为主题中colorAccent的悬浮操作按钮。</p>
<p><img src="http://2.bp.blogspot.com/-tdrgNYnQZyw/VWiOcfSRoYI/AAAAAAAABuU/6LsOxJFE4hE/s1600/image03.png" alt=""></p>
<p>除了一般大小的悬浮操作按钮，它还支持mini size（fabSize=”mini”）。FloatingActionButton继承自ImageView，你可以使用android:src或者ImageView的任意方法，比如<a href="http://developer.android.com/reference/android/widget/ImageView.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog#setImageDrawable(android.graphics.drawable.Drawable" target="_blank" rel="external">setImageDrawable()</a>来设置FloatingActionButton里面的图标。</p>
<p>###Snackbar</p>
<p>如果你需要一个轻量级、可以快速作出反馈的控件，可以试试<a href="http://www.google.com/design/spec/components/snackbars-toasts.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">SnackBar</a>。<a href="http://www.google.com/design/spec/components/snackbars-toasts.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">Snackbar</a>显示在屏幕的底部,包含了文字信息与一个可选的操作按钮。在指定时间结束之后自动消失。另外，用户还可以滑动删除它们。</p>
<p><a href="http://material-design.storage.googleapis.com/publish/material_v_3/material_ext_publish/0B6Okdz75tqQsLVVnZlF4UEtKRU0/components_snackbar_specs_fabtablet_002.webm" target="_blank" rel="external">example video</a></p>
<p>Snackbar，可以通过滑动或者点击进行交互，可以看作是比Toast更强大的快速反馈机制，你会发现他们的API非常相似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Snackbar</div><div class="line">  .make(parentLayout, R.string.snackbar_text, Snackbar.LENGTH_LONG)</div><div class="line">  .setAction(R.string.snackbar_action, myOnClickListener)</div><div class="line">  .show(); // Don’t forget to show!</div></pre></td></tr></table></figure>
<p>你应该注意到了make()方法中把一个View作为第一个参数，Snackbar试图找到一个合适的父亲以确保自己是被放置于底部。</p>
<p>###Tabs</p>
<p>通过选项卡的方式切换<a href="http://www.google.com/design/spec/components/tabs.html" target="_blank" rel="external">View</a>并不是Material design中才有的新概念，它们和<a href="http://www.google.com/design/spec/patterns/app-structure.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog#app-structure-top-level-navigation-strategies" target="_blank" rel="external">顶层导航模式</a>或者组织app中不同分组内容（比如，不同风格的音乐）是同一个概念。</p>
<p><img src="http://1.bp.blogspot.com/-liraQhLEn60/VWihbiaXaJI/AAAAAAAABvQ/nKi1_xcx6yk/s320/tabs.png" alt=""></p>
<p>Design library的<a href="http://developer.android.com/reference/android/support/design/widget/TabLayout.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">TabLayout</a> 既实现了固定的选项卡（View的宽度平均分配），也实现了可滚动的选项卡（View宽度不固定同时可以横向滚动）,也可以通过编写代码添加Tab。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">TabLayout tabLayout = ...;</div><div class="line">tabLayout.addTab(tabLayout.newTab().setText(&quot;Tab 1&quot;));</div></pre></td></tr></table></figure></p>
<p>如果，你使用<a href="http://developer.android.com/reference/android/support/v4/view/ViewPager.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">ViewPager</a>在tab之间横向切换，你可以直接从<a href="http://developer.android.com/reference/android/support/v4/view/PagerAdapter.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">PagerAdapter</a>的<a href="http://developer.android.com/reference/android/support/v4/view/PagerAdapter.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog#getPageTitle(int" target="_blank" rel="external">getPageTitle()</a>)中创建选项卡，然后使用setupWithViewPager()将两者联系在一起。它可以使tab的选中事件能更新ViewPager,同时ViewPager的页面改变能更新tab的选中状态。</p>
<p>###CoordinatorLayout, 动作和滚动</p>
<p>独特的视觉效果只是Material design小小的一部分：运动也是设计好一款Material designed应用的重要组成部分。而在Material design中，包括<a href="http://www.google.com/design/spec/animation/responsive-interaction.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog#responsive-interaction-surface-reaction" target="_blank" rel="external">触摸Ripple</a>和<a href="http://www.google.com/design/spec/animation/meaningful-transitions.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">有意义的转场</a>，Design library引入<a href="http://developer.android.com/reference/android/support/design/widget/CoordinatorLayout.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog0" target="_blank" rel="external">CoordinatorLayout</a>，一个从另一层面去控制子view之间触摸事件的布局，Design library中的很多控件都利用了它。</p>
<p>###CoordinatorLayout和Floating Action Buttons</p>
<p>一个很好的例子就是当你将FloatingActionButton作为一个子View添加进CoordinatorLayout并且将CoordinatorLayout传递给 Snackbar.make()，在3.0及其以上的设备上，Snackbar不会显示在悬浮按钮的上面，而是FloatingActionButton利用CoordinatorLayout提供的回调方法，在Snackbar以动画效果进入的时候自动向上移动让出位置，并且在Snackbar动画地消失的时候回到原来的位置，不需要额外的代码。</p>
<p><a href="http://material-design.storage.googleapis.com/publish/material_v_3/material_ext_publish/0B6Okdz75tqQsLWFucDNlYWEyeW8/components_snackbar_usage_fabdo_002.webm" target="_blank" rel="external">example video</a></p>
<p>CoordinatorLayout还提供了layout_anchor和layout_anchorGravity属性一起配合使用，可以用于放置floating view，比如FloatingActionButton与其他View的相对位置</p>
<p>###CoordinatorLayout 和app bar</p>
<p>另一个比较重要的场合是CoordinatorLayout结合app bar (或者action bar)和 <a href="http://www.google.com/design/spec/patterns/scrolling-techniques.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">滚动处理</a>. 你可能在你的布局里已经使用了<a href="https://developer.android.com/reference/android/support/v7/widget/Toolbar.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">Toolbar</a>, 能让你自定义外观，将应用中最显眼的部分和其他部分整合到一起. Design library采用了进一步的解决方案:使用<a href="http://developer.android.com/reference/android/support/design/widget/AppBarLayout.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">AppBarLayout</a>可以让Toolbar和其他View（例如展示Tab的TabLayout）对滚动事件作出反应，前提是他们在一个标有ScrollingViewBehavior的View中.因此，你可以创建如下的布局：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"> &lt;android.support.design.widget.CoordinatorLayout</div><div class="line">        xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">        xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line">     </div><div class="line">     &lt;! -- Your Scrollable View --&gt;</div><div class="line">    &lt;android.support.v7.widget.RecyclerView</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;match_parent&quot;</div><div class="line">            app:layout_behavior=&quot;@string/appbar_scrolling_view_behavior&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;android.support.design.widget.AppBarLayout</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;&gt;</div><div class="line">   &lt;android.support.v7.widget.Toolbar</div><div class="line">                  ...</div><div class="line">                  app:layout_scrollFlags=&quot;scroll|enterAlways&quot;&gt;</div><div class="line"></div><div class="line">        &lt;android.support.design.widget.TabLayout</div><div class="line">                  ...</div><div class="line">                  app:layout_scrollFlags=&quot;scroll|enterAlways&quot;/&gt;</div><div class="line">     &lt;/android.support.design.widget.AppBarLayout&gt;</div><div class="line">&lt;/android.support.design.widget.CoordinatorLayout&gt;</div></pre></td></tr></table></figure></p>
<p>现在，随着用户滚动RecyclerView，AppBarLayout通过子视图上的scroll flag，处理事件作出反应，控制他们如何进入，如何退出。Flag包括：</p>
<blockquote>
<ul>
<li>scroll: 所有想滚动出屏幕的view都需要设置这个flag- 没有设置这个flag的view将被固定在屏幕顶部。</li>
<li>enterAlways: 这个flag让任意向下的滚动都会导致该view变为可见，启用”快速返回”模式。</li>
<li>enterAlwaysCollapsed: 当你的视图已经设置minHeight属性又使用此标志时，你的视图只会在最小高度处进入，只有当滚动视图到达顶部时才扩大到完整高度。</li>
<li>exitUntilCollapsed: 在滚动过程中，只有当视图折叠到最小高度的时候，它才退出屏幕。</li>
</ul>
</blockquote>
<p>注意：那些使用Scroll flag的视图必须在其他视图之前声明。这样才能确保所有的视图从顶部撤离，剩下的元素固定在前面（译者注：剩下的元素压在其他元素的上面）。</p>
<p>###折叠 Toolbars</p>
<p>直接向AppBarLayout添加ToolBar，你需要添加enteralwayscollapsed和exituntilcollapsed两个滚动Flag，但是不能在细节上不同的元素对此的反应。为此，您可以使用 <a href="http://developer.android.com/reference/android/support/design/widget/CollapsingToolbarLayout.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">CollapsingToolbarLayout</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;android.support.design.widget.AppBarLayout</div><div class="line">        android:layout_height=&quot;192dp&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;&gt;</div><div class="line">    &lt;android.support.design.widget.CollapsingToolbarLayout</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;match_parent&quot;</div><div class="line">            app:layout_scrollFlags=&quot;scroll|exitUntilCollapsed&quot;&gt;</div><div class="line">        &lt;android.support.v7.widget.Toolbar</div><div class="line">                android:layout_height=&quot;?attr/actionBarSize&quot;</div><div class="line">                android:layout_width=&quot;match_parent&quot;</div><div class="line">                app:layout_collapseMode=&quot;pin&quot;/&gt;</div><div class="line">        &lt;/android.support.design.widget.CollapsingToolbarLayout&gt;</div><div class="line">&lt;/android.support.design.widget.AppBarLayout&gt;</div></pre></td></tr></table></figure>
<p>这个设置使用collapsingtoolbarlayout的layout_collapsemode =”pin” 确保在View折叠时，Toolbar本身仍然在屏幕顶部。更好的是，当你同时使用collapsingtoolbarlayout和Toolbar，当布局完全可见时，标题看上去明显变大了；当布局折叠完成后，它恢复到其默认大小。请注意，在这些情况下，你应该调用CollapsingToolbarLayout#settitle() ，而不是调用Toolbar。</p>
<p><a href="http://material-design.storage.googleapis.com/publish/material_v_3/material_ext_publish/0B0NGgBg38lWWcFhaV1hiSlB4aFU/patterns-scrollingtech-scrolling-070801_Flexible_Space_xhdpi_003.webm" target="_blank" rel="external">example video</a></p>
<p>如果你希望添加压住特定的视图效果，您可以使用app：layout_collapsemode =”parallax”（和app：layout_collapseparallaxmultiplier =“0.7”（可选,用于设置视差乘数）实现视差滚动（也就是说ImageView，作为Toolbar的兄弟节点，在collapsingtoolbarlayout中）。在这种情况下，建议在CollapsingToolbarLayout中设置<br>app:contentScrim=”?attr/colorPrimary”这一属性，这样，当视图折叠的时候，就会有蒙上纱布的渐变效果。</p>
<p><a href="http://material-design.storage.googleapis.com/publish/material_v_4/material_ext_publish/0B6Okdz75tqQscXNQY3dNdVlYeTQ/patterns-scrolling-techniques_flex_space_image_xhdpi_003.webm" target="_blank" rel="external">example video</a></p>
<p>###CoordinatorLayout与自定义控件</p>
<p>还有一件需要注意的事情，CoordinatorLayout跟FloatingActionButton或AppBarLayout需要一定的配置-它在<a href="http://developer.android.com/reference/android/support/design/widget/CoordinatorLayout.Behavior.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">Coordinator.Behavior</a>提供了一些API,子视图既可以更好地控制触摸事件也可以通过<a href="http://developer.android.com/reference/android/support/design/widget/CoordinatorLayout.Behavior.html?utm_campaign=io15&amp;utm_source=dac&amp;utm_medium=blog#onDependentViewChanged(android.support.design.widget.CoordinatorLayout,%20V,%20android.view.View" target="_blank" rel="external">onDependentViewChanged()</a>)给别人提供一个回调方法。</p>
<p>Views可以用CoordinatorLayout.DefaultBehavior(YourView.Behavior.class)注解（annotation）声明默认的Behavior,或者在你的布局文件中声明app:layout_behavior=”com.example.app.YourView$Behavior” 属性. 这样做，就可以将任何一个View和CoordinatorLayout整合在一起.</p>
<p>###马上使用吧！</p>
<p>Design library现在就可以使用，请确保已经用SDk Manager更新了Android Support Repository. 然后添加一条dependency，你就可以使用Design library了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &apos;com.android.support:design:22.2.0&apos;</div></pre></td></tr></table></figure>
<p>需要注意的是，Design library 依赖于Support v4和AppCompat Support Libraries,在你添加  Design library时，这些库也会自动的添加到依赖中。同时，这些控件在Android Studio的Layout Editor (可以在CustomView中找到)中是可用的，你可以便捷的预览一些新的控件。</p>
<p>Design library, AppCompat和所有的Android Support Library 都是开发Android的强有力工具，当你打造一个符合当代风格、好看的应用时，可以使用提供现成的模块，无需从0开始。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android-Design-Support-Library/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android-Design-Support-Library/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android-MVPR-架构模式-Part1/" title="Android MVPR 架构模式-Part1" itemprop="url">Android MVPR 架构模式-Part1</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.philosophicalhacker.com/2015/07/07/mvpr-a-flexible-testable-architecture-for-android-pt-1/" target="_blank" rel="external">MVPR: A FLEXIBLE, TESTABLE ARCHITECTURE FOR ANDROID (PT. 1)</a></li>
</ul>
<blockquote>
<p>全面的单元测试能提高内部系统的代码质量，因为系统的每一个组件都需要被测试，因此每个单元都需要在系统外被构建，在测试环境中进行测试。对对象进行单元测试需要创建该对象，提供该对象需要的依赖，并与它进行交互，最终检验测试环境的输出是否与预期一致。因此，为了让一个类易于进行单元测试，类的依赖必须明确，而且能够轻易地被替代和明确被调用和验证的责任。在软件工程领域中，这就意味着代码必须松耦合、高内聚，也就是说：设计优秀的。</p>
<p>Steve Freeman 和 Nat Pryce，也就是测试驱动的面向对象开发。</p>
</blockquote>
<p>最近我在尝试让 Google 的 IO App 变得可单元测试，我这样做的其中一个原因是验证 Freeman 和 Pryce 在引用中对单元测试的总结。即使现在我还是没有把 IOSched 中的任何一个 Activity 重构，但我已经在重构代码的过程中感受到他们所说的东西了。</p>
<p>我现在在重构的 Activity 是 SessionDetailActivity，如果你一直有在关注我的话就会知道我说的是哪个 Activity，但如果你只是第一次看我的博文，你可以看看下面这张图了解下 SessionDetailActivity 的界面是咋样的。</p>
<p><img src="http://i0.wp.com/www.philosophicalhacker.com/wp-content/uploads/2015/05/io-testing-talk-04.png?resize=169%2C300" alt=""></p>
<p>就像我在这个系列博文的序中所说，要让 SessionDetailActivity 可被单元测试，有几个麻烦必须解决。我在这个系列的上一篇博文中说过，对它动态构建的 View 进行单元测试是一个挑战，但在那篇博文中，我提到我解决这个问题的办法并不能治本，因为在 View 和 Presenter 之间存在着循环依赖。</p>
<p>循环依赖是 Android 应用架构存在大问题的征兆：Activity 和 Presenter 都违反了单一职责原则，它们至少需要完成两件事：为 View 绑定数据并对用户的输入作出相应。这也是为什么 SessionDetailActivity 这个类会作为 Android 开发的 Model 被使用，使得类的代码数超过1000行。</p>
<p>我坚信有更好的办法架构我们的应用，在接下来的博文里，我会提出一种拥有以下特性的新架构：</p>
<ol>
<li><p>将通常由 Presenter 和 Activity 负责的多重职责打破</p>
</li>
<li><p>打破一般存在于 View 间或 Activity 和 Presenter 之间的循环依赖</p>
</li>
<li><p>允许我们用构造方法对所有为用户展示数据以及相应用户输入的对象进行依赖注入</p>
</li>
<li><p>让 UI 相关的业务逻辑易于进行单元测试，而且不可能在没有必要的依赖时被构建以履行他们的职责，而且通过利用聚合和多态性修改对象的行为。</p>
</li>
</ol>
<p>在这片博文中，我会尝试总结开发新的 Android 应用架构的原因。</p>
<p>##为什么需要新的架构？</p>
<p>##Activity/Fragment/Presenter 会变得臃肿</p>
<p>Activity 和 Fragment（接下来我会统称为 Activities，但我说的也适用于 Fragment）是违反单一职责原则的典型：</p>
<ul>
<li><p>处理 View 的事件</p>
</li>
<li><p>更新数据 Model</p>
</li>
<li><p>调用其他 View</p>
</li>
<li><p>与系统组件交互</p>
</li>
<li><p>处理系统事件</p>
</li>
<li><p>基于系统事件更新 View</p>
</li>
</ul>
<p>正如 Richa 所说，这些职责大部分从 Activities 中剥离，但即使我们这样做了，Activities 还是违反了单一职责原则。即使是最简单的 Activities 还是需要将 Model 的数据和 View 绑定，并对用户输入作出相应，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionDetailActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span></span></div><div class="line">        <span class="title">LoaderManager</span>.<span class="title">LoaderCallbacks</span>&lt;<span class="title">Cursor</span>&gt;,</div><div class="line">        <span class="title">ObservableScrollView</span>.<span class="title">Callbacks</span> &#123;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="comment">//Responsibility 1: Responding to user's action (in this case, a click)</span></div><div class="line">        mAddScheduleButton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                <span class="keyword">boolean</span> starred = !mStarred;</div><div class="line">                SessionsHelper helper = <span class="keyword">new</span> SessionsHelper(SessionDetailActivity.<span class="keyword">this</span>);</div><div class="line">                showStarred(starred, <span class="keyword">true</span>);</div><div class="line">                helper.setSessionStarred(mSessionUri, starred, mTitleString);</div><div class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123;</div><div class="line">                    mAddScheduleButton.announceForAccessibility(starred ?</div><div class="line">                            getString(R.string.session_details_a11y_session_added) :</div><div class="line">                            getString(R.string.session_details_a11y_session_removed));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">/* [ANALYTICS:EVENT]</span></div><div class="line">                 * TRIGGER:   Add or remove a session from My Schedule.</div><div class="line">                 * CATEGORY:  'Session'</div><div class="line">                 * ACTION:    'Starred' or 'Unstarred'</div><div class="line">                 * LABEL:     Session title/subtitle.</div><div class="line">                 * [/ANALYTICS]</div><div class="line">                 */</div><div class="line">                AnalyticsManager.sendEvent(</div><div class="line">                        <span class="string">"Session"</span>, starred ? <span class="string">"Starred"</span> : <span class="string">"Unstarred"</span>, mTitleString, <span class="number">0L</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">//...</span></div><div class="line"></div><div class="line">        <span class="comment">//Responsibility 2: Fetching and binding data to the view</span></div><div class="line">        LoaderManager manager = getLoaderManager();</div><div class="line">        manager.initLoader(SessionsQuery._TOKEN, <span class="keyword">null</span>, <span class="keyword">this</span>);</div><div class="line">        manager.initLoader(SpeakersQuery._TOKEN, <span class="keyword">null</span>, <span class="keyword">this</span>);</div><div class="line">        manager.initLoader(TAG_METADATA_TOKEN, <span class="keyword">null</span>, <span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Google IOSched 应用中的 SessionDetailActivity 就是 Activity 即使只负责绑定数据到 View 中和响应用户输入也会变得臃肿的绝佳范例。即使我们把这部分代码从 SessionDetailActivity 中剥离，还是有一个类有700多行代码。不信我？你大可以去看看源码，Presenter 也会因为 Activity 那样的原因变得臃肿：Presenter 通常负责绑定数据以及响应用户输入，所以 Presenter 也需要像 Activity 那样通过剥离额外的职责被瘦身。</p>
<p>###Activities/Fragment/Presenter 通常在 View 间存在循环依赖</p>
<p>Activities 通常通过它们和 View 之间的循环依赖履行绑定数据到 View 和响应用户输入的职责（例如：作为 setContentView() 方法参数的 View）。下面是范例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">mAddScheduleButton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                <span class="keyword">boolean</span> starred = !mStarred;</div><div class="line">                SessionsHelper helper = <span class="keyword">new</span> SessionsHelper(SessionDetailActivity.<span class="keyword">this</span>);</div><div class="line">                showStarred(starred, <span class="keyword">true</span>);</div><div class="line">                helper.setSessionStarred(mSessionUri, starred, mTitleString);</div><div class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123;</div><div class="line">                    mAddScheduleButton.announceForAccessibility(starred ?</div><div class="line">                            getString(R.string.session_details_a11y_session_added) :</div><div class="line">                            getString(R.string.session_details_a11y_session_removed));</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">                <span class="comment">/* [ANALYTICS:EVENT]</span></div><div class="line">                 * TRIGGER:   Add or remove a session from My Schedule.</div><div class="line">                 * CATEGORY:  'Session'</div><div class="line">                 * ACTION:    'Starred' or 'Unstarred'</div><div class="line">                 * LABEL:     Session title/subtitle.</div><div class="line">                 * [/ANALYTICS]</div><div class="line">                 */</div><div class="line">                AnalyticsManager.sendEvent(</div><div class="line">                        <span class="string">"Session"</span>, starred ? <span class="string">"Starred"</span> : <span class="string">"Unstarred"</span>, mTitleString, <span class="number">0L</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>SessionDetailActivity 持有对 mAddScheduleButton 的引用，而且 mAddScheduleButton 也持有对 SessionDetailActivity 的引用。我等会会说，这样的循环依赖限制我们通常用于 Activities 中实现 UI 相关的业务逻辑的方法。</p>
<p>MVP 的 Presenter 有着和它们和 View 相同的循环依赖，在我能详细解释之前，我必须简单地介绍传统 Android 应用架构中 View 和 MVP 模式中 View 的区别。</p>
<p>MVP 模式中的 View 就像我定义的，只是 MVP 模式三巨头其中之一，通常被定义为一个接口，而且一般会在 Activity，Fragment 或 Android 传统架构中的 View 中实现。Android 传统架构中的 View 就像它的名字，是一个 View 的子类。</p>
<p>使用 MVP 模式中的 View 和 Presenter 仅仅是在它们之间无形中重新创建了和 Android 传统架构中 View 和 Activities 之间相同的循环依赖。</p>
<p><img src="http://i2.wp.com/www.philosophicalhacker.com/wp-content/uploads/2015/07/CircularDependency-011.png?resize=300%2C222" alt=""></p>
<p><img src="http://i2.wp.com/www.philosophicalhacker.com/wp-content/uploads/2015/07/CircularDependency-021.png?resize=300%2C222" alt=""></p>
<p>Presenter 需要 MVP 模式中的 View 使得它们能绑定数据到 MVP 模式中的 View，MVP 模式 中的 View 需要对 Presenter 的引用，使得它能传递点击和其他 UI 相关的事件给 Presenter。Square 的<a href="https://corner.squareup.com/2014/10/advocating-against-android-fragments.html" target="_blank" rel="external">博文</a>就有存在着循环依赖的 MVP 模式的实现。</p>
<p>循环依赖在你想要为单元测试构建对象（或通常情况下）都会产生问题。然而，通常情况下，我们都不会把 MVP 模式的 View 和 Presenter 或 Activities 和 View 间的循环依赖当作问题，因为 Activities 和 Fragment 被系统初始化，而且因为我们并没有用依赖注入去注入 Activity 和/或 Fragment 的依赖。相反的是，我们只是初始化了 Activity 在 onCreate() 方法中需要的任何依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">MVPView</span> </span>&#123;</div><div class="line"></div><div class="line">    View mButton;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_browse_sessions);</div><div class="line">        <span class="comment">//...</span></div><div class="line">        <span class="keyword">final</span> Presenter presenter = <span class="keyword">new</span> Presenter(<span class="keyword">this</span>);</div><div class="line">        mButton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                presenter.onButtonClicked();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化在 onCreate() 方法中依赖的混合类，然而，限制我们使用组合和多态性去实现 UI 相关的业务逻辑。下面是一个你应该使用多态性实现 UI 相关的业务逻辑的例子：假设你开发了一个被用户使用的应用，而且用户在不同的等级时有不同的特权，那么他们需要通过邮件验证或回答其他用户提的问题以提高等级。我们可以想象有许多按钮用于完成依赖等级完成的不同功能，或 View 由用户等级决定的初始状态。多态性为我们提供整洁，可拓展的方式去实现这样的逻辑：我们创建一个 Presenter 用于为用户绑定不同的等级，不管用户在什么等级中，我们都能把 MVP 模式中的 View 传到特定的 Presenter 子类中，并让该子类处理相应的点击事件或者基于用户的等级呈现 UI。当然了，还有许多架构 Android 应用的方式，使得我们能够在存在 Presenter 和 MVP 模式中的 View 间循环依赖的情况下利用多态性，但这些方法都不够优雅，或者说他们为了完成单元测试作出了极大的贡献。</p>
<p>这篇博文剩下的篇幅已经不足以让我一一细述我记得的那些解决方法，但我能简要的说说为什么解决 MVP 模式中的 View 和 Presenter 间循环依赖的方法不理想。你可以想象我们可以只创建一个 MVP 模式的 View 或 Presenter，而没有它们履行职责所需的任何依赖。换句话说，我们可以像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">MVPView</span> </span>&#123;</div><div class="line"> </div><div class="line">    View mButton;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_browse_sessions);</div><div class="line">        <span class="comment">//...</span></div><div class="line">        <span class="keyword">final</span> Presenter presenter = <span class="keyword">new</span> Presenter();</div><div class="line">        <span class="comment">//****</span></div><div class="line">        presenter.setView(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">//****</span></div><div class="line">        mButton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                presenter.onButtonClicked();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们就能通过多态性解决上面提到的问题，但这并没有打破循环依赖。它能做的是允许我们在无效状态创建一个对象。这并不是最简洁的解决办法，把这放在 Freeman 和 Pryce 话里：</p>
<blockquote>
<p>“创建或不创建，不需要尝试”</p>
<p>我们想要确保总是创建有效的对象，部分地创建对象然后通过设置它的属性完成它是脆弱的……</p>
</blockquote>
<p>##结论</p>
<p>Presenter 和 Activities 违反了单一职责原则，他们常常负责绑定数据到 View 中和响应用户的输入，这些都会使 Activities 和 Presenter 变得臃肿。</p>
<p>Presenter 和 Activities 常常会因为他们和 View 间的循环依赖拥有多重职责，即使这样的循环引用不会带来什么问题，但这会更难以对 View 和/或 Presenter 进行单元测试，而且会限制我们使用多态性实现 UI 相关的业务逻辑。</p>
<p>就像我之前说的，我认为会有一种架构应用的办法不会有上面这些烈士，在下一篇博文中，我会提出可供选择的架构。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android-MVPR-架构模式-Part1/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android-MVPR-架构模式-Part1/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android-Lollipop-update/" title="Android 5.1 Lollipop 升级版：Android 5.1.1面世" itemprop="url">Android 5.1 Lollipop 升级版：Android 5.1.1面世</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文连接 : <a href="http://www.androidpit.com/android-5-1-lollipop-update" target="_blank" rel="external">android-5-1-lollipop-update</a></li>
</ul>
<p>Android Lollipop自2014年推出一来，仅应用在少数几款设备上。大多数人在兴奋迎接Android5.0的时候视野已经瞄准了Android 5.1。现在让我们来一睹Android 5.1.1的芳容。请点击<a href="http://www.androidpit.com/topic/android-5-1-lollipop" target="_blank" rel="external">Android 5.1 Lollipop</a>查看所有升级资料（以及即将来袭的Android 5.1.1）。继续往下阅读，来看看哪些设备会使用这个最新系统。</p>
<ul>
<li><p><a href="http://www.androidpit.com/android-6-release-date-news-rumors" target="_blank" rel="external">Android 6.0</a>: 一起创造终极Android OS</p>
</li>
<li><p><a href="http://www.androidpit.com/android-5-0-lollipop-phone-update-news" target="_blank" rel="external">Android 5.0 Lollipop update</a>：我的设备什么时候才能使用最新系统？ </p>
</li>
</ul>
<p><img src="http://fs01.androidpit.info/userfiles/6473479/image/android-5-1/androidpit-android-5-1-teaser-picture-2.jpg" alt="pic-1"></p>
<p>Android 5.1发布日期及新特性曝光。/@ANDROIDPIT</p>
<p>###Android 5.1.1升级版已经到来了吗？</p>
<p>可以这么说。Android 5.1.1 Lollipop升级版尚未应用到手机上，但是Nexus Player的factory image已经曝光–这也是目前第一款应用5.1.1系统的设备。一旦Android 5.1.1升级版可以应用其他Nexus设备或摩托罗拉设备，我们会第一时间与大家分享最新消息。</p>
<p>###Android 5.1.1 Lollipop升级版：最新系统什么时候能用？</p>
<p>第一批使用Android 5.1升级版的设备为<a href="http://www.androidpit.com/topic/t-mobile" target="_blank" rel="external">T-Mobile</a> Nexus 6 和 <a href="http://www.androidpit.com/topic/verizon" target="_blank" rel="external">Verizon</a> Nexus 6，其他Nexus设备火速待定中。</p>
<p>####Google Nexus设备</p>
<ul>
<li><a href="http://www.androidpit.com/nexus-6-android-update" target="_blank" rel="external">Nexus 6 Android 升级版最新消息</a></li>
<li><a href="http://www.androidpit.com/nexus-5-android-update" target="_blank" rel="external">Nexus 5 Android 升级版最新消息</a></li>
<li><a href="http://www.androidpit.com/nexus-4-android-update" target="_blank" rel="external">Nexus 4 Android 升级版最新消息</a></li>
<li><a href="http://www.androidpit.com/nexus-7-2013-android-update" target="_blank" rel="external">Nexus 7 (2013) Android 升级版最新消息</a></li>
</ul>
<p><a href="http://www.androidpit.com/device/google-nexus-9" target="_blank" rel="external">Nexus 9</a>尚未进入支持Android 5.1升级之列。Google Play Edition的设备很快会进行Android 5.1.1的升级。</p>
<p>####摩托罗拉设备</p>
<p>摩托罗拉最新的中高端设备已确认支持升级到Android 5.1，而且第一代Moto X 和 Moto G也即将步入升级行列（原本的Moto X目前正在巴西进行Android 5.1系统升级测试）。Moto E的一、二代均处在等待系统升级之列。</p>
<ul>
<li><a href="http://www.androidpit.com/moto-x-2014-android-update" target="_blank" rel="external">Moto X (2014) Android 升级版最新消息</a></li>
<li><a href="http://www.androidpit.com/moto-x-2013-android-update" target="_blank" rel="external">Moto X (2013) Android 升级版最新消息</a></li>
<li><a href="http://www.androidpit.com/moto-g-2014-android-update" target="_blank" rel="external">Moto G (2014) Android 升级版最新消息</a></li>
<li><a href="http://www.androidpit.com/moto-g-android-update" target="_blank" rel="external">Moto G (LTE, 2013) Android 升级版最新消息</a></li>
<li><a href="http://www.androidpit.com/moto-e-android-update" target="_blank" rel="external">Moto E Android 升级版最新消息</a></li>
</ul>
<p>####Android One设备</p>
<p>大家可能还记得，最初是Android One提醒了我们Android 5.1的存在。Google搜索页面把Android 5.1 Lollipop列为Evercoss One X、Mito Impact 和 Nexian Journey的Android即用版。</p>
<p>###Android Wear 5.1</p>
<p><a href="http://www.androidpit.com/android-wear-update" target="_blank" rel="external">Android Wear 升级版</a>不久也会上线，新版特性包括挥手感控Android Wear智能手表（通过手腕控制通知栏，无需双手同时操作）、Wi-Fi、手绘emoji、程序切换器以及快速联系人搜索等。</p>
<p>Android Wear智能手表通常依靠蓝牙与联网智能手机连接使用，但是大部分智能手表带有预装Wi-Fi芯片，但到目前为止，这块芯片仍处于睡眠状态，毫无用处。Android Wear 5.1升级版推出之后，这一Wi-Fi组件有望被激活。</p>
<p>###Android 5.1 Lollipop 升级版有哪些新特性？</p>
<p>####中断、优先级和静音模式</p>
<p>新版系统的一个最小但最重要的改进在于其优先级设置。在新系统下我们可以将中断偏好设置为保持原样，直到下次警报为止。这在避免隔夜中断情况或“故障时间”情况下非常有用。</p>
<p><img src="http://fs04.androidpit.info/userfiles/6473479/image/android-5-1/androidpit-android-5-1-interruptions.jpg" alt="pic-2"></p>
<p>Android 5.1完善了Lollipop的优先级模式，但仍然未包含通知灯闪烁的静音模式。/@ANDROIDPIT</p>
<p>####屏幕固定</p>
<p>如果大家之前没体验过屏幕固定功能，那么现在可以试试。当别人在使用你的手机时，这是保护手机中信息隐私最好的办法。</p>
<p>屏幕固定是指将某个应用或某个文件夹锁定，当别人使用你的手机时，在未获得相应PIN码的情况下他不能退出当前应用。PIN码很容易设置，这样一来，使用你的手机的朋友、小孩或者伴侣在未获得你的允许的情况下就无法浏览你手机里的其他内容了。新系统中的这个功能更容易找到，并且说明更详细。在设置&gt;安全隐私项下可以找到。</p>
<p>说到安全隐私…</p>
<p><img src="http://fs01.androidpit.info/userfiles/6473479/image/android-5-1/androidpit-android-5-1-screen-pinning.jpg" alt="pic-3"></p>
<p>屏幕固定激活后，我们可以从“最近应用”列表中进入。</p>
<p>####安全隐私</p>
<p>Android 5.1一个新特性是锁定功能，即使手机被偷后它也能保护手机内信息安全。激活“设备保护”后，除非使用者拥有你的Google账号登陆信息，否则设备将不可用，直到恢复出厂设置。 </p>
<p>可惜的是，这个功能可不一定能帮你把手机找回来，但是能防止别人盗用你手机里的信息这一点是肯定的，这也算是一个小小的安慰吧。</p>
<p>只要你手上有一台可用的设备（但遗憾的是目前还没确定是哪些设备），屏幕安全锁定（通过pattern、PIN码或密码）并且登陆了Google账号，你就可以自动激活这个功能。</p>
<p>那如何才能确定这个功能在手机上被激活了呢？目前我们使用的唯一方法就是解除锁屏安全模式，如果跳出“设备保护功能将关闭”的通知，那么我们在锁屏的时候就可以知道这个功能是否激活了（经过一番周折，终于了解了！）。</p>
<p><img src="http://fs04.androidpit.info/userfiles/6473479/image/android-5-1/androidpit-android-5-1-device-protection.jpg" alt="pic-4"></p>
<p>兼容设备上的设备保护功能会自动激活。/@ANDROIDPIT</p>
<p>####完善快速设置菜单</p>
<p>为了增强可用性，快速设置菜单囊括了所有的的全新动画，Wi-Fi微调以及蓝牙菜单。</p>
<p>选择Wi-Fi或蓝牙网络比之前更容易操作，按钮旁的下拉箭头可以直接从快速设置菜单中找出连接列表。这真是极好的。</p>
<ul>
<li><a href="http://www.androidpit.com/how-to-get-android-5-1-lollipop-on-nexus-5" target="_blank" rel="external">如何将Nexus 5的系统升级到Android 5.1 Lollipop</a></li>
</ul>
<p><img src="http://fs01.androidpit.info/userfiles/6473479/image/android-5-1/androidpit-android-5-1-wi-fi-settings.jpg" alt="pic-5"></p>
<p>快速设置中新添加的下拉式Wi-Fi连接功能的用户反馈很好。/@ANDROIDPIT</p>
<p>####通话音质更好，支持双卡双待</p>
<p>尽管运营商本身为设备提供了高清的语音质量，在这里高清音质正式被直接编入Android 5.1代码中，也就意味着大家能够享受更高质量的通话体验。</p>
<p>其他值得一提的特性有…</p>
<ul>
<li>更好的双卡双待支持</li>
<li>Android 5.1 SDK提供了新的API支持（为迎接更好的app铺平道路）</li>
<li>完善的通知中心管理（通知栏现在可以半滑动，而不是像之前那样完全滑到上方）</li>
<li>更好的WiFi连接，Android现在知道哪个接入点的WiFi信号更好。聪明。</li>
</ul>
<p>目前还没有确切的关于什么设备能用、什么时间能用新版系统的消息，大家怀着美好的期待等待新系统的到来吧。赶紧去设置&gt;关于手机&gt;软件更新，燥起来吧！如果你玩的是摩托罗拉的手机，Nexus设备或Google Play Edition，很有可能你就是第一个体验新系统的人哟。</p>
<ul>
<li><a href="http://www.androidpit.com/android-5-0-lollipop-problems-and-solutions" target="_blank" rel="external">Android 5.0 problems and solutions</a></li>
</ul>
<p><img src="http://fs04.androidpit.info/userfiles/2692059/image/Blog/AndroidPIT-Galaxy-S5-Lollipop-KitKat.JPG" alt="pic-6"></p>
<p>Android平台越来越优秀。/@ANDROIDPIT</p>
<p>你的设备已经升级到Android 5.1了吗？觉得怎么样？</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android-Lollipop-update/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android-Lollipop-update/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android-M的App-Links实现详解/" title="Android M的App Links实现详解" itemprop="url">Android M的App Links实现详解</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.randomlytyping.com/blog/2015/6/5/things-you-may-not-know-about-onresumefragments" target="_blank" rel="external">THINGS YOU MAY NOT KNOW: ONRESUMEFRAGMENTS</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/jianghejie" target="_blank" rel="external">jianghejie</a> </li>
</ul>
<p>谷歌2015年的I/O大会上宣布了一个<a href="http://www.androidpolice.com/2015/05/28/io-2015-android-m-will-support-app-deep-linking-without-that-annoying-selector-prompt/" target="_blank" rel="external">新特性</a>：允许开发者将app和他们的web域名关联。这一举措是为了最小化用户遇到“打开方式”对话框的概率。</p>
<p>比如，我们安装了两个Twitter应用 - 官方的和<a href="https://play.google.com/store/apps/details?id=com.jv.materialfalcon" target="_blank" rel="external">Falcon Pro</a>。当你在某个地方点击了Twitter URL的时候，你会看到如下的对话框：</p>
<p><img src="https://chris.orr.me.uk/img/posts/app-links-sms.png" alt="Clicking a Twitter link in the Android messaging app"> <img src="https://chris.orr.me.uk/img/posts/app-links-intent-chooser-dialog.png" alt="app-links-intent-chooser-dialog.png" title="1433755732968129.png"></p>
<p>但是在安卓M中，如果一个app明确的指定了App链接-这个对话框将不复存在。点击一个链接将立即打开官方的app，没有第三方app的机会，更不会打开一个浏览器。</p>
<p>在上图的例子中，当你点击了那个链接，安卓系统会检查是否有一个app可以处理twitter.com URL，然后跟twitter.com核对哪个app（s）可以处理该域名的链接，这样我们就能避免影响用户。</p>
<p>注意安卓并不会在点击链接的时候才核对这些链接，因此在安卓决定使用哪个app之前并不会有网络阻塞。关于这点后面有更多讨论。</p>
<p>虽然这会使安卓更方便- 多数情况下，你确实希望点击一个链接打开的是最合适的那个app- 但是对于那些喜欢使用第三方app的人来说，似乎是一件坏事。不过这种行为可以在Android M的系统设置中关掉。</p>
<h2 id="app开发者如何实现App-Links"><a href="#app开发者如何实现App-Links" class="headerlink" title="app开发者如何实现App Links"></a>app开发者如何实现App Links</h2><p>实现的细节可以在<a href="https://developer.android.com/preview/features/app-linking.html" target="_blank" rel="external">Android Developers&#39; Preview 网站</a>上找到。</p>
<p>如果你有一个需要处理链接（比如example.com）的app，你应该：</p>
<ul>
<li>有上传文件到example.com根路径的权限，如果没有，你无法让你的app成为这些链接的默认打开方式。</li>
<li>在build.gradle文件中设置compileSdkVersion &#39;android-MNC&#39;。</li>
<li>为每个这样的&lt;intent-filter&gt;标签</li>
</ul>
<pre class="brush:js;toolbar:false">&lt;intent-filter&gt;
    &lt;data android:scheme=&quot;http&quot; /&gt;
    ...
&lt;/intent-filter&gt;</pre>

<p>添加属性android:autoVerify=&quot;true&quot;。http也可以是https。</p>
<p>注：这里对filter的写法略去了很多，其实官网（上面的那个链接）有完整的示例：</p>
<pre class="brush:js;toolbar:false">&lt;activity ...&gt;
    &lt;intent-filter android:autoVerify=&quot;true&quot;&gt;
        &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;
        &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;
        &lt;category android:name=&quot;android.intent.category.BROWSABLE&quot; /&gt;
        &lt;data android:scheme=&quot;http&quot; android:host=&quot;www.android.com&quot; /&gt;
        &lt;data android:scheme=&quot;https&quot; android:host=&quot;www.android.com&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/activity&gt;</pre>

<p>认证是以主机名为单位的而不是以intent filter为单位的，因此从技术上讲，并不需要为每个标签都添加该属性，但是添加了也不会出什么问题。</p>
<h3 id="创建JSON文件"><a href="#创建JSON文件" class="headerlink" title="创建JSON文件"></a>创建JSON文件</h3><p>为了能让安卓可以认证，你的app需要被允许使用app链接行为，为此，需要提供一个JSON文件，JSON文件中需要包含app的ID以及APK的公钥证书。</p>
<p>这个文件必须包含一个JSON数组，数组中可以有一个或者多个对象，每个对象对应一个你想认证的app ID:</p>
<pre class="brush:js;toolbar:false">[
  {
    &quot;relation&quot;: [&quot;delegate_permission/common.handle_all_urls&quot;],
    &quot;target&quot;: {
      &quot;namespace&quot;: &quot;android_app&quot;,
      &quot;package_name&quot;: &quot;com.example.myapp&quot;,
      &quot;sha256_cert_fingerprints&quot;: [&quot;6C:EC:C5:0E:34:AE....EB:0C:9B&quot;]
    }
  }
]</pre>

<p>比如，你现在有一个com.example.myapp的发行版app，同时还有一个叫com.example.myapp.beta的beta版app，你可以通过在数组中设置两个对象来允许两者都可以接受认证，每个对象带有各自的app ID和公钥值。</p>
<p>注意，这个文件的验证是非常严格的：数组中的每个对象都必须和上面的那个一模一样。在数组中添加了任意其他的对象，或者对象中有额外的属性都会导致整个验证失败。- 即便这个app对象是有效的。</p>
<p>为了防止为同一个构建注册了不同的key，貌似一个app可以指定多个SHA256指纹证书，不管怎样，指纹证书可以通过如下方式获得：</p>
<pre class="brush:js;toolbar:false">echo | keytool -list -v -keystore app.keystore 2&gt; /dev/null | grep SHA256:</pre>

<h3 id="上传JSON文件"><a href="#上传JSON文件" class="headerlink" title="上传JSON文件"></a>上传JSON文件</h3><p>创建完文件之后，你需要上传它同时保证它可以使用这个URL访问<a href="http://example.com/.well-known/statements.json。" target="_blank" rel="external">http://example.com/.well-known/statements.json。</a></p>
<p>目前这个URL是http的，最终的M版本将只允许通过HTTPS访问该URL。<br>在第一个M预览版中，重定向到HTTPS，或者任何其他重定向（301，302或者307）貌似都会被忽略并被视为失败。</p>
<p>URL的scheme和&lt;intent-filter&gt;标签中的android:scheme值是互不相干的，即使你有一个只接受HTTPS URLs的filter，认证URL仍然需要通过HTTP访问。</p>
<p>在了解了安卓如何使用这些信息之后，我们来看看如果debug这个过程。</p>
<h2 id="Android-M是如何实现App-Links的"><a href="#Android-M是如何实现App-Links的" class="headerlink" title="Android M是如何实现App Links的"></a>Android M是如何实现App Links的</h2><p>App链接认证涉及到安卓系统的两个组建：Package Manager和Intent Filter Verifier。</p>
<p><strong>PackageManager</strong>是一个无处不在的标准组建 - 它负责验证所安装的apk是否有效，授予app权限，另外还可以通过它知道系统上安装了些什么app。</p>
<p>而<strong>Intent Filter Verifier</strong>则是Android M上才有的新玩意儿。这个组建负责获取链接指向的JSON认证，解析它，验证它，然后将报告返回给PackageManger。</p>
<p>虽然这个组建不是用户轻易就能替换的，但似乎系统中只能有一个活动状态的Intent Filter Verifier - 想要注册成为一个verifier，必须要有android.permission.INTENT_FILTER_VERIFICATION_AGENT权限，而这个权限只有签名了系统密钥的app才能得到。</p>
<p>你可以通过如下的命令查看当前激活的intent filter verifier：</p>
<pre class="brush:js;toolbar:false">adb shell dumpsys package ifv</pre>

<p>在第一个M预览版中，com.android.statementservice完全扮演了这个角色。</p>
<h3 id="How-App-Links-are-verified"><a href="#How-App-Links-are-verified" class="headerlink" title="How App Links are verified"></a>How App Links are verified</h3><p>App链接认证在安装的时候就一次性完成。这就是为什么刚刚我们说不必在每次点击链接的时候都阻塞网络。</p>
<p><img src="https://chris.orr.me.uk/img/posts/app-links-system-diagram.png" alt=""></p>
<p>当一个package安装的时候，或者现有的package升级的时候：</p>
<ul>
<li>1.PackageManager对即将安装的apk做常规的验证。</li>
<li>2.如果成功，这个package将被安装，同时发出一个带有android.intent.action.INTENT_FILTER_NEEDS_VERIFICATION的广播intent，intent中还携带有该package的信息。</li>
<li>3.Intent Filter Verifier的广播接收器将获取这个广播。</li>
<li>4.从package的&lt;intent-filter&gt;标签中编译出一个特有主机名的列表。</li>
<li>5.verifier尝试从每个特有的主机名中获取statements.json。</li>
<li>6.每一个被获取的JSON文件都会检查它的application ID和安装包的证书。</li>
<li>7.只有当所有文件同时满足时，才会发送成功信息到PackageManager，否则失败。</li>
<li>8.PackageManager存储结果。</li>
</ul>
<p>如果认证失败，app链接将无法指向你的app - 你的app会像往常一样出现在“打开方式”对话框中（除非另一个app通过了同一域名的验证）。</p>
<p>就我所了解的而言，认证只会在安装和升级的时候会发生，因此对大多数用户来说，再次通过验证的机会是在app下一次升级的时候。</p>
<h3 id="Intent-Filter-Verifier的行为"><a href="#Intent-Filter-Verifier的行为" class="headerlink" title="Intent Filter Verifier的行为"></a>Intent Filter Verifier的行为</h3><p><strong>主机名</strong></p>
<p>example.com和www.example.com会被认为是两个独立的主机名。因此要求statements.json在两个主机名下都是可直达的。</p>
<p>比如，如果你将所有的请求都重定向到<a href="http://www.example.com/*" target="_blank" rel="external">http://www.example.com/*</a> to <a href="https://example.com/*，则会让这个主机名的认证失败，从而导致整个app链接认证失败。" target="_blank" rel="external">https://example.com/*，则会让这个主机名的认证失败，从而导致整个app链接认证失败。</a></p>
<p>这种情况下，你可能需要为你的web服务器做特殊的配置，确保每个对于statements.json的请求都有能直接返回HTTP 200。这个约束在后面的版本中可能会有所放松。</p>
<p><strong>响应时间</strong></p>
<p>如果verifier不能在5秒之内和你的web服务器建立链接并接收到HTTP响应，认证会失败。</p>
<p><strong>缺少链接环境</strong></p>
<p>同样的，如果在认证开始的时候设备是离线的，或者网络环境很差，认证也会失败。</p>
<p><strong>HTTP 缓存</strong></p>
<p>目前Intent Filter Verifier的实现基本遵循HTTP缓存规则。</p>
<p>如果你的statements.json响应包含了Cache-Control: max-age=[seconds]头部，那么这个响应将被verifier缓存到磁盘。虽然 60秒以下的’max-age’会被忽略，但是60秒似乎也足够了。同样的一个<code>Expires</code> header 也会被缓存。</p>
<p>如果你有ETag或者最近更新的headers，那么verifier将在下一次视情况使用这些值来验证相应的主机。据我所知，如果这些header子退出之后没有明确指定缓存控制头，那么响应的缓存时间将是不确定的。</p>
<p>缓存头部只理会http 200的响应，如果是一个404响应，那么下次将忽略，verifier需要直接连接主机。</p>
<h3 id="Debugging-App-Links"><a href="#Debugging-App-Links" class="headerlink" title="Debugging App Links"></a>Debugging App Links</h3><p>当安卓系统试图认证你的app链接时，PackageManager除了向logcat中报告true/false值之外，还有一些其他反馈，比如：</p>
<pre class="brush:js;toolbar:false">IntentFilter ActivityIntentInfo{1a61a0a com.example.myapp/.MainActivity}
 verified with result:true and hosts:example.com www.example.com</pre>

<p>但是，你可在任意时刻向系统查询package的app链接认证状态：</p>
<pre class="brush:js;toolbar:false">adb shell dumpsys package d</pre>

<p>这会返回如下的认证条目信息：</p>
<pre class="brush:js;toolbar:false">Package Name: com.example.myapp
Domains: example.com www.example.com
Status: always</pre>

<p>可能会有多个关于你package的条目：一个是系统的，零个或者多个用户的- 有些用户的偏好覆盖了系统参数。</p>
<p>可能会产生的状态值大致如下：</p>
<ul>
<li><p><strong>undefined</strong> —&nbsp; app没有在manifest中启用链接自动验证功能。</p>
</li>
<li><p><strong>ask</strong> — app验证失败（会通过打开方式对话框询问用户）</p>
</li>
<li><p><strong>always</strong> — app通过了验证（点击这个域名总是打开这个app）</p>
</li>
<li><p><strong>never</strong> — app通过了验证，但是系统设置关闭了此功能。</p>
</li>
</ul>
<p>如果你没能通过认证，你可以再次尝试重新安装同一版本：</p>
<pre class="brush:js;toolbar:false">adb install -r app/build/outputs/apk/app-debug.apk</pre>

<p>如果你在安装的时候没有在服务器上看见statements.json URL的请求，你可以清空Intent Verifier服务的HTTP缓存，这样下次就会直接请求服务器：</p>
<pre class="brush:js;toolbar:false">adb shell pm clear com.android.statementservice</pre>

<p>如果你不知道statements.json的内容是否正确返回，可以使用安卓模拟器的-tcpdump选项来检查网络上发送的是什么 - 注意安卓M最终版出来之后就没那么容易了，因为数据是加密的。</p>
<p>还有一种选择，那就是使用模拟器的-http-proxy选项，让所有的网络请求都通过代理，比如<a href="http://charlesproxy.com/" target="_blank" rel="external">Charles</a>代理。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>虽然在开始我担心App Links会取代目前安卓上非常酷的intent机制，但是也乐于看到这对于大多数情况都是有用的，况且如果用户不喜欢，使用简单的方法就可以把它关掉。</p>
<p>考虑到verifier服务对JSON解析和HTTP请求异常严格，希望这里所提到的一些细节对你实现app linking有所帮助。祝你好运！</p>
<p>​    </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android-M的App-Links实现详解/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android-M的App-Links实现详解/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android-Support库22.1版/" title="Android Support库 22.1" itemprop="url">Android Support库 22.1</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://android-developers.blogspot.com/2015/04/android-support-library-221.html" target="_blank" rel="external">Android Support Library 22.1</a></li>
</ul>
<p>你可能听过这么一句话 “最好的代码就是没有代码。” 然而我想对你说的是：你写下的每一行代码应该能为应用增加独特的价值，而不是为应用添加一行又一行繁复、无趣的模板代码。Android提供支持库的初衷正是如此：让 Android 开发工程师把精力更多地放在逻辑实现上，而不是写业务代码。</p>
<p>最新发布的Android支持库一如既往地添加了许多实用的组件，并对Support V4、AppCompat、Leanback、RecyclerView、Palette和Renderscript库的内部实现逻辑作出改变。从新的 <a href="http://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">AppCompatActivity</a>和<a href="http://developer.android.com/reference/android/support/v7/app/AppCompatDialog.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">AppCompatDialog</a> 到Android TV全新的引导流程我们可以发现，新的库确实带来许多让我们耳目一新的惊喜。</p>
<h2 id="Support-V4"><a href="#Support-V4" class="headerlink" title="Support V4"></a>Support V4</h2><p>Support V4 库作为众多 Android 支持库的基础，包含许多向下兼容的类，大大简化了向下兼容的具体实现。</p>
<p><a href="http://developer.android.com/reference/android/support/v4/graphics/drawable/DrawableCompat.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">DrawableCompat</a>现在使drawable着色绘制向下兼容到了API 4：现在只需要通过<a href="http://developer.android.com/reference/android/support/v4/graphics/drawable/DrawableCompat.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog#wrap(android.graphics.drawable.Drawable" target="_blank" rel="external">DrawableCompat.wrap(Drawable)</a>)简单封装你的Drawable，然后<a href="http://developer.android.com/reference/android/support/v4/graphics/drawable/DrawableCompat.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog#setTint(android.graphics.drawable.Drawable,%20int" target="_blank" rel="external">setTint()</a>)、<a href="http://developer.android.com/reference/android/support/v4/graphics/drawable/DrawableCompat.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog#setTintList(android.graphics.drawable.Drawable,%20android.content.res.ColorStateList" target="_blank" rel="external">setTintList()</a>)、<a href="http://developer.android.com/reference/android/support/v4/graphics/drawable/DrawableCompat.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog#setTintMode(android.graphics.drawable.Drawable,%20android.graphics.PorterDuff.Mode" target="_blank" rel="external">setTintMode()</a>)就能完成着色绘制：完全不需要为了支持多种颜色而去创建和维护几个不同的 Drawable 文件！</p>
<p>此外，我们正在通过 <a href="http://developer.android.com/reference/android/support/v4/graphics/ColorUtils.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">ColorUtils</a> 类做一些适用于所有使用场景的 <a href="https://developer.android.com/reference/android/support/v7/graphics/Palette.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">Palette</a> 内部构件，ColorUtils 可以很容易地计算出颜色之间的对比度，确定维持最小对比度的最小透明度值（完美地保证文字的阅读体验），或者将颜色转换为对应的 HSL 值（译者注：Hue[hju]色调，Saturation[‘sætʃə’reʃən]饱和度，Luminance[‘lumɪnəns]亮度）。</p>
<p>插值器是所有动画系统的重要组成部分，它负责控制一个动画中某项数值改变的比率（例如加速、减速等）。Lollipop 中的<a href="http://developer.android.com/reference/android/R.interpolator.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">android.R.interpolator</a>已经内置了许多插值器，例如用于<a href="http://www.google.com/design/spec/animation/authentic-motion.html" target="_blank" rel="external">建立真实感的动效</a>的fast_out_linear_in、fast_out_slow_in、and linear_out_slow_in。但现在我们可以用代码调用 <a href="http://developer.android.com/reference/android/support/v4/view/animation/FastOutLinearInInterpolator.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">FastOutLinearInInterpolator</a>、<a href="http://developer.android.com/reference/android/support/v4/view/animation/FastOutSlowInInterpolator.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">FastOutSlowInInterpolator</a>、<a href="http://developer.android.com/reference/android/support/v4/view/animation/LinearOutSlowInInterpolator.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">LinearOutSlowInInterpolator</a> 类为动画添加这些插值器。除了那些预建的插值器，我们还创建了允许你创建二次方或三次方贝塞尔曲线的 <a href="http://developer.android.com/reference/android/support/v4/view/animation/PathInterpolatorCompat.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">PathInterpolatorCompat</a> 类。</p>
<p>这个版本的支持库还把<a href="http://developer.android.com/reference/android/support/v4/widget/Space.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">Space</a>控件从GridLayout库移动到了Support V4，使其不需要在项目中添加单独的依赖。Space控件是一种轻量的、无形的控件，可用于创建控件间的间隙效果。</p>
<h2 id="AppCompat"><a href="#AppCompat" class="headerlink" title="AppCompat"></a>AppCompat</h2><p>AppCompat支持库开始地很低调，却是一个很重要的开端：为API 7及以上的设备提供了一个一致的Action Bar。<br>在<a href="http://android-developers.blogspot.com/2014/10/appcompat-v21-material-design-for-pre.html" target="_blank" rel="external">版本21的修订中</a>，它承担了新的职责：带来了<a href="http://developer.android.com/training/material/theme.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog#ColorPalette" target="_blank" rel="external">material color palette</a>、控件着色、Toolbar支持，还有更多支持所有API 7+的设备。单从ActionBarActivity名字上看是体现不出它全部功能的。</p>
<p>在此版本中，ActionBarActivity已经过时了，新的替代者是<a href="http://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">AppCompatActivity</a>。然而，这不只是一个重命名。事实上，AppCompat的内在逻辑现在可以通过<a href="http://developer.android.com/reference/android/support/v7/app/AppCompatDelegate.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">AppCompatDelegate</a>实现-这是一个可以在所有Activity中包含的类，与合适的生命周期方法挂钩，并得到一致的主题、着色等，而不需要使用AppCompatActivity （尽管这仍然是最简单的开始方式）。</p>
<p>在全新AppCompatDelegate类的帮助下，我们继续增加了一致性体验的支持，通过<a href="http://developer.android.com/reference/android/support/v7/app/AppCompatDialog.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">AppCompatDialog</a>类增加了材料设计规范对话框的支持。如果你之前使用过<a href="http://developer.android.com/guide/topics/ui/dialogs.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog#AlertDialog" target="_blank" rel="external">AlertDialog </a>，你会很高心，因为现在支持库中也有其对应的版本：<a href="http://developer.android.com/reference/android/support/v7/app/AlertDialog.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">support.v7.app.AlertDialog</a>，让你用相同的API享受 AppCompatDialog 带来的便利。</p>
<p>在使用AppCompat时，自动为控件着色的能力是在你的应用程序中保持品牌烙印和一致性体验中的重要保证。因为在填充布局时AppCompat会自动地为你将诸如Button、TextView 这些传统控件替换为AppCompatButton、AppCompatTextView 等新控件，以确保布局内的每一个控件都能支持着色。而在新的支持库中，色彩感知控件现在已经被公开，让控件类对自动着色的支持能延续到子类中。</p>
<p>这个列表囊括了目前所有的色彩感知控件：</p>
<blockquote>
<ul>
<li>AppCompatAutoCompleteTextView</li>
<li>AppCompatButton</li>
<li>AppCompatCheckBox</li>
<li>AppCompatCheckedTextView</li>
<li>AppCompatEditText</li>
<li>AppCompatMultiAutoCompleteTextView</li>
<li>AppCompatRadioButton</li>
<li>AppCompatRatingBar</li>
<li>AppCompatSpinner</li>
<li>AppCompatTextView</li>
</ul>
</blockquote>
<p>Lollipop增加了在一个view中通过view级别上的XML属性android:theme实现重写主题的能力-非常有用的特性，如在亮色activities上的黑色action bars。现在，AppCompat允许你为Toolbars使用android:theme（不赞成使用之前的app:theme）,更好地带来为API 11+的所有views的android:theme支持。</p>
<p>如果你刚开始接触AppCompat，那么看看下面的视频，可以察觉出是多么容易上手，这就能为你所有的用户带来了一致性的设计：</p>
<p><a href="https://youtu.be/5Be2mJzP-Uw" target="_blank" rel="external"><img src="http://img.youtube.com/vi/5Be2mJzP-Uw/0.jpg" alt="Android Support Library: Consistent Design with AppCompat"></a></p>
<h2 id="Leanback"><a href="#Leanback" class="headerlink" title="Leanback"></a>Leanback</h2><p>Leanback库作为Android电视应用程序的最佳实践的集合，我们曾忽略去不使一个更美好的10的经验作为发行版的一部分。你会注意到加载后立即更新Leanback例子新功能的引导步骤。<br><img src="http://4.bp.blogspot.com/-I4Bjzlx8AzI/VS1fgphZnYI/AAAAAAAABhs/L5SfjRk_k40/s640/image00.png" alt=""></p>
<p>这组类和主题可以用来构建一个多步骤的过程，这在Android TV上看起来很棒。它是由一个左边上的指导视图和右边的列表操作建立了起来。每一个都是可定制的，通过一些主题与Theme.Leanback.GuidedStep 的父类或其它，如果需要更多的定制，通过自定义一个<a href="http://developer.android.com/reference/android/support/v17/leanback/widget/GuidanceStylist.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">GuidanceStylist</a>和<a href="http://developer.android.com/reference/android/support/v17/leanback/widget/GuidedActionsStylist.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">GuidedActionsStylist。</a>。</p>
<p>你还会发现大量的bug修复，性能改进，以及使它更完美贯穿在库中-所有与制作Leanback的经验，更多就是为用户和开发人员所喜欢。</p>
<h2 id="RecyclerView"><a href="#RecyclerView" class="headerlink" title="RecyclerView"></a>RecyclerView</h2><p>除了一系列正确的bug修复，此版本增加了一个新的<a href="http://developer.android.com/reference/android/support/v7/util/SortedList.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">SortedList</a>数据结构。此集合可以很容易地保持自定义对象的排序列表，通过<a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.Adapter.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">RecyclerView.Adapter</a>正确地分发数据改变的事件：维护item的 添加/删除/移动/改变 时RecyclerView提供的动画。</p>
<p>此外，SortedList还支持成批地一起改变，调度只是适配器上一个单一的集操作，确保大量items改变时的最佳的用户体验。</p>
<h2 id="Palette"><a href="#Palette" class="headerlink" title="Palette"></a>Palette</h2><p>如果你已经使用Palette从图像中提取出颜色，你会很高兴地知道，现在在不会丢失品质下速度是之前的6~8倍！</p>
<p>Palette现在使用建造者模式来实例化。不是直接调用Palette.generate(Bitmap)或者其它相似的操作，你会使用<a href="http://developer.android.com/reference/android/support/v7/graphics/Palette.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog#from(android.graphics.Bitmap" target="_blank" rel="external">Palette.from(Bitmap)</a>)来取回一个<a href="http://developer.android.com/reference/android/support/v7/graphics/Palette.Builder.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">Palette.Builder</a>实例。然后，在调用generate()或者generateAsync()检索颜色的色板之前，您可以随意更改的最大颜色数来生成并设置图像的最大尺寸来重新运行Palette。</p>
<h2 id="Renderscript"><a href="#Renderscript" class="headerlink" title="Renderscript"></a>Renderscript</h2><p>Renderscript给你巨大的计算潜力，此外这个支持库版本使得一些预先定义的脚本和调用脚本内部函数在API 8+的设备上变得可用。这个版本改善了所有设备的可靠性和性能，这些提升取决于本地Renderscript可用时通过一种改进的图像边缘检测算法实现-确保最快和最可靠的实现总是我们的选择。两个额外的内部函数也被添加在此版本中：<a href="http://developer.android.com/reference/android/support/v8/renderscript/ScriptIntrinsicHistogram.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">ScriptIntrinsicHistogram</a>和<a href="http://developer.android.com/reference/android/support/v8/renderscript/ScriptIntrinsicResize.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">ScriptIntrinsicResize</a>，完成采集到10。</p>
<h2 id="SDK-现在可用了！"><a href="#SDK-现在可用了！" class="headerlink" title="SDK 现在可用了！"></a>SDK 现在可用了！</h2><p>没有比这更好的时间来开始使用Android支持库。今天你就可以使用这个库开始开发了，从Android SDK Manager下载Android支持库和Android支持资源吧。</p>
<p>要了解更多关于Android的支持库和它提供给你的API，请访问Android开发者官网上的<a href="http://developer.android.com/tools/support-library/index.html?utm_campaign=ASL221-415&amp;utm_source=dac&amp;utm_medium=blog" target="_blank" rel="external">支持库章节</a>的网页。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android-Support库22.1版/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android-Support库22.1版/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android中的MVP-Part2/" title="Android中的MVP-Part2" itemprop="url">Android中的MVP-Part2</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.tinmegali.com/en/model-view-presenter-mvp-in-android-part-2/" target="_blank" rel="external">Model View Presenter (MVP) in Android, Part 2</a></li>
<li>原文作者 : <a href="https://medium.com/@tinmegali" target="_blank" rel="external">TinMegali</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/DroidWorkerLYF" target="_blank" rel="external">DroidWorkerLYF</a> </li>
<li>校对者: <a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a>  </li>
<li>状态 :  完成</li>
</ul>
<p><img src="https://github.com/DroidWorkerLYF/Translate/blob/master/Model-View-Presenter%20(MVP" alt="Model View Presenter Class
Diagram">/1.png?raw=true)</p>
<p>在上一篇<a href="http://www.tinmegali.com/model-view-presenter-mvp-no-android-introducao/" target="_blank" rel="external">文章</a>中我们谈论了<a href="https://pt.wikipedia.org/wiki/Model-view-presenter" target="_blank" rel="external">Model View Presenter<br>(MVP)</a>的概念和在Android开发中的优点。这是系列文章的第二篇，我们来动手实践一下，将使用<a href="https://en.wikipedia.org/wiki/Canonical_form" target="_blank" rel="external">典型的形式</a>实现一个MVP结构，不使用任何Android SDK或JAVA以外的库。</p>
<p>我们会开发一个简单的工程，但是由于涉及大量的对象，可能使项目看起来有些复杂。但是，一旦你掌握了，你就会明白MVP模式如何能帮助你。如果你想直接看代码，<a href="https://github.com/tinmegali/simple-mvp/tree/master/AndroidMVP/mvp/src/main/java/com/tinmegali/mvp/mvp" target="_blank" rel="external">在这里</a>。</p>
<ul>
<li><a href="http://wp.me/p7gH7l-2x" target="_blank" rel="external">Model View Presenter (MVP) in Android, part<br>1</a></li>
<li><a href="http://wp.me/p7gH7l-34" target="_blank" rel="external">Model View Presenter (MVP) in Android,<br>  part 3</a></li>
</ul>
<h2 id="设计MVP"><a href="#设计MVP" class="headerlink" title="设计MVP"></a>设计MVP</h2><h5 id="MVP在Android中的主要概念"><a href="#MVP在Android中的主要概念" class="headerlink" title="MVP在Android中的主要概念"></a>MVP在Android中的主要概念</h5><blockquote>
<h4 id="Presenter"><a href="#Presenter" class="headerlink" title="Presenter"></a><strong>Presenter</strong></h4><p>Presenter是View和Model的中间人。它从Model层获取数据，格式化后返回给View层。<br>但是和典型的MVC模式不同的是，它还决定如何处理你和视图的交互。</p>
<h4 id="View"><a href="#View" class="headerlink" title="View"></a><strong>View</strong></h4><p>视图层，通常是由Activity实现，其中包含有presenter的引用。视图层唯一要做的事就是响应<br>用户的操作，调用Presenter层的方法。</p>
<h4 id="Model"><a href="#Model" class="headerlink" title="Model"></a><strong>Model</strong></h4><p>在有良好分层结构的应用中，Model层只是domain层或者业务逻辑的入口。把它看做视图层<br>数据的提供者就好。</p>
<p><em>以上优秀的定义提取自<a href="http://antonioleiva.com/mvp-android/" target="_blank" rel="external">Antonio Leiva’s article</a></em></p>
</blockquote>
<p>使用MVP模式的最大任务是增加我们项目的<a href="https://en.wikipedia.org/wiki/Separation_of_concerns" target="_blank" rel="external">关注分离</a>.因此我们需要确保Model层，View层和Presenter层的隔离。这种情况下，<strong>View层和Model层无法直接通信</strong>，因此<strong>Presenter负责各层的通讯</strong></p>
<h3 id="Model-View-Presenter行为图"><a href="#Model-View-Presenter行为图" class="headerlink" title="Model View Presenter行为图"></a>Model View Presenter行为图</h3><p>让我们设想一个简单的应用，它允许用户在旅途中做笔记。主要就是用户记录笔记，系统保存和展示数据。如果我们沿着输入笔记的行为，结合MVP模式，我们会得到下图：</p>
<p><img src="https://github.com/DroidWorkerLYF/Translate/blob/master/Model-View-Presenter%20(MVP" alt="Model View Presenter (MVP) action
diagram">/2.png?raw=true)<br>Model View Presenter (MVP) 行为图</p>
<ol>
<li>用户点击输入笔记。<strong>视图层</strong>将笔记内容传入<strong>Presenter层</strong>的newNote(textNote)方法。</li>
<li><strong>Presenter层</strong>调用<strong>Model层</strong>的insertNote(note, this)方法，将传入的string创建为一个新的笔记。</li>
<li><strong>Model层</strong>在数据库中插入笔记并且使用onSuccess()方法通知<strong>Presenter层</strong>成功/失败的结果</li>
<li><strong>Presenter层</strong>处理结果后调用showToast()方法让<strong>View层</strong>展示一个toast </li>
</ol>
<p>这个映射给了我们对类设计的灵感。上述不同层之间的通信过程实现可能会不一样：直接调用对象的方法，使用接口或者使用EventBus。然而，既然我们的实现方式遵循典型方式，并且意在增加关注分离，所以我们只用原始简单的接口。</p>
<h3 id="Model-View-Presenter类图"><a href="#Model-View-Presenter类图" class="headerlink" title="Model View Presenter类图"></a>Model View Presenter类图</h3><p>让我们根据上面的<em>行为图</em>来构造我们的MVP模式<a href="https://en.wikipedia.org/wiki/Class_diagram" target="_blank" rel="external">类图</a>。我们会对概念做一点改动，把<em>callback</em>换成<em>interface</em>，来将结果从<strong>Model层</strong>传回<strong>Presenter层</strong>。我相信这种方式更高效，但是有人会对此有争议，认为<em>callback</em>会增加关注分离。</p>
<p><img src="https://github.com/DroidWorkerLYF/Translate/blob/master/Model-View-Presenter%20(MVP" alt="Model View Presenter Class
Diagram">/1.png?raw=true)<br>Model View Presenter 类图</p>
<ol>
<li><strong>Presenter层</strong>实现<strong>PresenterOps接口</strong></li>
<li><strong>View层</strong>接受<strong>PresenterOps</strong>的引用来访问<strong>Presenter</strong></li>
<li><strong>Model层</strong>实现<strong>ModelOps接口</strong></li>
<li><strong>Presenter层</strong>接受<strong>ModelOps</strong>的引用来访问<strong>Model</strong></li>
<li><strong>Presenter层</strong>实现<strong>RequiredPresenterOps接口</strong></li>
<li><strong>Model层</strong>接受<strong>RequiredPresenterOps</strong>的引用来访问<strong>Presenter</strong></li>
<li><strong>View层</strong>实现<strong>RequiredViewOps接口</strong></li>
<li><strong>Presenter层</strong>接受<strong>RequiredViewOps</strong>的引用来访问<strong>View</strong></li>
</ol>
<h2 id="在Android中实现MVP"><a href="#在Android中实现MVP" class="headerlink" title="在Android中实现MVP"></a>在Android中实现MVP</h2><p>事不宜迟，让我们动起来！先定义操作。为了更好的结构组织，我们使用一个“umbrella”类，包含所有层次间通讯的接口。</p>
<blockquote>
<p><strong>注意</strong>：由于实现MVP模式已经很复杂了，我不会实现其他多余的内容。我假设读者都对Android SDK有很好的理解，因此不需要我关注这些。</p>
</blockquote>
<h3 id="Interface-MainMVP"><a href="#Interface-MainMVP" class="headerlink" title="Interface MainMVP"></a>Interface MainMVP</h3><pre><code>/*
 * Aggregates all communication operations between MVP pattern layer: 
 * Model, View and Presenter 
 */ 
 public interface MainMVP { 
     /**
      * View mandatory methods. Available to Presenter 
      * Presenter -&gt; View 
      */ 
      interface RequiredViewOps { 
          void showToast(String msg); 
          void showAlert(String msg); 
          // any other ops 
      } 

      /** 
       * Operations offered from Presenter to View 
       * View -&gt; Presenter 
       */ 
       interface PresenterOps { 
             void onConfigurationChanged(RequiredViewOps view); 
             void onDestroy(boolean isChangingConfig); 
             void novaNota(String textoNota);
             void deletaNota(Nota nota); 
             // any other ops to be called from View 
       }

       /** 
        * Operations offered from Presenter to Model 
        * Model -&gt; Presenter 
        */ 
        interface RequiredPresenterOps { 
                void onNotaInserida(Nota novaNota); 
                void onNotaRemovida(Nota notaRemovida); 
                void onError(String errorMsg); 
                // Any other returning operation Model -&gt; Presenter 
        }

        /** 
         * Model operations offered to Presenter 
         * Presenter -&gt; Model
         */ 
         interface ModelOps { 
              void insereNota(Nota nota); 
              void removeNota(Nota nota); 
              void onDestroy(); 
              // Any other data operation 
         } 
 }
</code></pre><h3 id="MainPresenter-Class"><a href="#MainPresenter-Class" class="headerlink" title="MainPresenter Class"></a>MainPresenter Class</h3><pre><code>public class MainPresenter implements MainMVP.RequiredPresenterOps, MainMVP.PresenterOps {

    // Layer View reference
    private WeakReference&amp;lt;MainMVP.RequiredViewOps&amp;gt; mView;
    // Layer Model reference
    private MainMVP.ModelOps mModel;

    // Configuration change state
    private boolean mIsChangingConfig;

    public MainPresenter(MainMVP.RequiredViewOps mView) {
        this.mView = new WeakReference&amp;lt;&amp;gt;(mView);
        this.mModel = new MainModel(this);
    }

    /**
      * Sent from Activity after a configuration changes
      * @param view  View reference
      */
    @Override
    public void onConfigurationChanged(MainMVP.RequiredViewOps view) {
        mView = new WeakReference&amp;lt;&amp;gt;(view);
    }

    /**
      * Receives {@link MainActivity#onDestroy()} event
      * @param isChangingConfig  Config change state
      */
    @Override
    public void onDestroy(boolean isChangingConfig) {
        mView = null;
        mIsChangingConfig = isChangingConfig;
        if ( !isChangingConfig ) {
            mModel.onDestroy();
        }
    }

    /**
      * Called by user interaction from {@link MainActivity}
      * creates a new Note
      */
    @Override
    public void newNote(String noteText) {
        Note note = new Note();
        note.setText(textoNota);
        note.setDate(getDate());
        mModel.insertNote(note);
    }

    /**
      * Called from {@link MainActivity},
      * Removes a Note
      */
    @Override
    public void removeNote(Note note) {
        mModel.removeNote(note);
    }

    /**
      * Called from {@link MainModel}
      * when a Note is inserted successfully
      */
    @Override
    public void onNoteInsert(Note newNote) {
        mView.get().showToast(&quot;New register added at &quot; + newNote.getDate());
    }

    /**
      * Receives call from {@link MainModel}
      * when Note is removed
      */
    @Override
    public void onNoteRemoved(Note noteRemoved) {
        mView.get().showToast(&quot;Note removed);
    }

    /**
      * receive errors
      */
    @Override
    public void onError(String errorMsg) {
        mView.get().showAlert(errorMsg);
    }
}
</code></pre><h3 id="MainModel-Class"><a href="#MainModel-Class" class="headerlink" title="MainModel Class"></a>MainModel Class</h3><pre><code>public class MainModel implements MainMVP.ModelOps {

    // Presenter reference
    private MainMVP.RequiredPresenterOps mPresenter;

    public MainModel(MainMVP.RequiredPresenterOps mPresenter) {
        this.mPresenter = mPresenter;
    }

    /**
      * Sent from {@link MainPresenter#onDestroy(boolean)}
      * Should stop/kill operations that could be running
      * and aren&apos;t needed anymore
      */
    @Override
    public void onDestroy() {
        // destroying actions
    }

    // Insert Note in DB
    @Override
    public void insertNote(Note note) {
        // data business logic
        // ...
        mPresenter.onNoteInserted(note);
    }

    // Removes Note from DB
    @Override
    public void removeNote(Note note) {
        // data business logic
        // ...
        mPresenter.onNoteRemoved(note);
    }
}
</code></pre><h3 id="处理Android相关的特性"><a href="#处理Android相关的特性" class="headerlink" title="处理Android相关的特性"></a>处理Android相关的特性</h3><p>在我们的MVP模式中，<strong>视图层</strong>负责创建<strong>Presenter层</strong>，<strong>Presenter层</strong>负责实例化<strong>Model层</strong>对象。考虑到使用<strong>Activity</strong>来实现<strong>View层</strong>，我们需要考虑一些Android的细节，尤其是销毁和创建activities及其对象的<a href="http://developer.android.com/training/basics/activity-lifecycle/index.html" target="_blank" rel="external">生命周期</a>。</p>
<p>这就是说，我们需要增加第四个元素<strong>StateMaintainer</strong>，负责在生命周期的变化中维护Presenter和Model的状态。使用retained fragment来实现这个对象，如下是一个简化的MVP模式Activity生命周期：</p>
<p><img src="https://github.com/DroidWorkerLYF/Translate/blob/master/Model-View-Presenter%20(MVP" alt="MVP Objects destruction and reconstruction during Activity lifecycle
changes">/3.png?raw=true)<br>Activity生命周期变化时MVP模式中对象的销毁和创建</p>
<ol>
<li><strong>Activity</strong>创建一个<strong>Presenter</strong>的实例并持有<strong>PresenterOps</strong>的引用。<strong>Presenter</strong>存储在<strong>StateMaintainer</strong>中</li>
<li><strong>Presenter</strong>在创建时接受<strong>RequiredViewOps</strong>类型参数并且创建一个<strong>Model</strong>对象</li>
<li><strong>Model</strong>接受<strong>RequiredPresenterOps</strong>类型参数</li>
<li>当Activity被销毁时，会通知<strong>Presenter</strong></li>
<li><strong>Presenter</strong>处理信息，作必要的处理后传递给<strong>Model</strong></li>
<li><strong>Activity</strong>从<strong>StateMaintainer</strong>中恢复<strong>Presenter</strong>，并且传递<strong>RequiredViewOps</strong>，通知他的激活状态。</li>
</ol>
<h3 id="StateMaintainer-Class"><a href="#StateMaintainer-Class" class="headerlink" title="StateMaintainer Class"></a>StateMaintainer Class</h3><p><strong>StateMaintainer</strong>的这种实现可以用来存储任何对象的状态。</p>
<p><strong>StateMainainer</strong></p>
<pre><code>public class StateMaintainer {
    protected final String TAG = getClass().getSimpleName();

    private final String mStateMaintenerTag;
    private final WeakReference&amp;lt;FragmentManager&amp;gt; mFragmentManager;
    private StateMngFragment mStateMaintainerFrag;

    /**
      * Constructor
      * @param fragmentManager       FragmentManager reference
      * @param stateMaintainerTAG    the TAG used to insert the state maintainer fragment
      */
    public StateMaintainer(FragmentManager fragmentManager, String stateMaintainerTAG) {
        mFragmentManager = new WeakReference&amp;lt;&amp;gt;(fragmentManager);
        mStateMaintenerTag = stateMaintainerTAG;
    }

    /**
      * Create the state maintainer fragment
      * @return  true: the frag was created for the first time
      *          false: recovering the object
      */
    public boolean firstTimeIn() {
        try {
            // Recovering the reference
            mStateMaintainerFrag = (StateMngFragment)mFragmentManager.get().findFragmentByTag(mStateMaintenerTag);

            // Creating a new RetainedFragment
            if (mStateMaintainerFrag == null) {
                Log.d(TAG, &quot;Creating a new RetainedFragment &quot; + mStateMaintenerTag);
                mStateMaintainerFrag = new StateMngFragment();
                mFragmentManager.get().beginTransaction()
                    .add(mStateMaintainerFrag,mStateMaintenerTag).commit();
                return true;
            } else {
                Log.d(TAG, &quot;Returns a existent retained fragment existente &quot; + mStateMaintenerTag);
                return false;
            }
        } catch (NullPointerException e) {
            Log.w(TAG, &quot;Error firstTimeIn()&quot;);
            return false;
        }
    }


    /**
      * Insert Object to be preserved during configuration change
      * @param key   Object&apos;s TAG reference
      * @param obj   Object to maintain
      */
    public void put(String key, Object obj) {
        mStateMaintainerFrag.put(key, obj);
    }

    /**
      * Insert Object to be preserved during configuration change
      * Uses the Object&apos;s class name as a TAG reference
      * Should only be used one time by type class
      * @param obj   Object to maintain
      */
    public void put(Object obj) {
        put(obj.getClass().getName(), obj);
    }


    /**
      * Recovers saved object
      * @param key   TAG reference
      * @param &amp;lt;T&amp;gt;   Class type
      * @return      Objects
      */
    @SuppressWarnings(&quot;unchecked&quot;)
    public &amp;lt;T&amp;gt; T get(String key)  {
        return mStateMaintainerFrag.get(key);
    }

    /**
      * Verify the object existence 
     * @param key   Obj TAG
      */
    public boolean hasKey(String key) {
        return mStateMaintainerFrag.get(key) != null;
    }


    /**
      * Save and manages objects that show be preserved
      * during configuration changes.
      */
    public static class StateMngFragment extends Fragment {
        private HashMap&amp;lt;String, Object&amp;gt; mData = new HashMap&amp;lt;&amp;gt;();

        @Override
        public void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);
            // Grants that the frag will be preserved
            setRetainInstance(true);
        }

        /**
         * Insert objects
         * @param key   reference TAG
         * @param obj   Object to save
         */
        public void put(String key, Object obj) {
            mData.put(key, obj);
        }

        /**
         * Insert obj using class name as TAG
         * @param object    obj to save
         */
        public void put(Object object) {
            put(object.getClass().getName(), object);
        }

        /**
          * Recover obj
         * @param key   reference TAG
         * @param &amp;lt;T&amp;gt;   Class
         * @return      Obj saved
         */
        @SuppressWarnings(&quot;unchecked&quot;)
        public &amp;lt;T&amp;gt; T get(String key) {
            return (T) mData.get(key);
        }
    }
}
</code></pre><h3 id="MainActivity-Activity-View-layer"><a href="#MainActivity-Activity-View-layer" class="headerlink" title="MainActivity Activity (View layer)"></a>MainActivity Activity (View layer)</h3><pre><code>public class MainActivity extends AppCompatActivity implements MainMVP.RequiredViewOps {

    protected final String TAG = getClass().getSimpleName();

    // Responsible to maintain the Objects state
    // during changing configuration
    private final StateMaintainer mStateMaintainer = new StateMaintainer( this.getFragmentManager(), TAG );

    // Presenter operations
    private MainMVP.PresenterOps mPresenter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        startMVPOps();
        setContentView(R.layout.activity_main);
        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);
        setSupportActionBar(toolbar);
        FloatingActionButton fab = (FloatingActionButton)findViewById(R.id.fab);
    }

    /**
      * Initialize and restart the Presenter.
      * This method should be called after {@link Activity#onCreate(Bundle)}
      */
    public void startMVPOps() {
        try {
            if ( mStateMaintainer.firstTimeIn() ) {
                Log.d(TAG, &quot;onCreate() called for the first time&quot;);
                initialize(this);
            } else {
                Log.d(TAG, &quot;onCreate() called more than once&quot;);
                reinitialize(this);
            }
        } catch ( InstantiationException | IllegalAccessException e ) {
            Log.d(TAG, &quot;onCreate() &quot; + e );
            throw new RuntimeException( e );
        }
    }


    /**
      * Initialize relevant MVP Objects.
      * Creates a Presenter instance, saves the presenter in {@link StateMaintainer}
      */
    private void initialize( MainMVP.RequiredViewOps view ) throws InstantiationException, IllegalAccessException{
        mPresenter = new MainPresenter(view);
        mStateMaintainer.put(MainMVP.PresenterOps.class.getSimpleName(), mPresenter);
    }

    /**
      * Recovers Presenter and informs Presenter that occurred a config change.
      * If Presenter has been lost, recreates a instance
      */
    private void reinitialize( MainMVP.RequiredViewOps view)
        throws InstantiationException, IllegalAccessException {
        mPresenter = mStateMaintainer.get( MainMVP.PresenterOps.class.getSimpleName() );

        if ( mPresenter == null ) {
            Log.w(TAG, &quot;recreating Presenter&quot;);
            initialize( view );
        } else {
            mPresenter.onConfigurationChanged( view );
        }
    }

    // Show AlertDialog
    @Override
    public void showAlert(String msg) {
        // show alert Box
    }

    // Show Toast
    @Override
    public void showToast(String msg) {
        Toast.makeText(getApplicationContext(), msg, Toast.LENGTH_SHORT).show;
    }
}
</code></pre><h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a><a href="https://github.com/tinmegali/simple-mvp/tree/master/AndroidMVP/mvp/src/main/java/com/tinmegali/mvp/mvp" target="_blank" rel="external">源码</a></h4><h3 id="下一篇文章"><a href="#下一篇文章" class="headerlink" title="下一篇文章"></a>下一篇文章</h3><p>我知道这篇文章有一点长了，很抱歉。但我真的希望可以帮到谁。下一遍文章，我们会讨论如何使用<a href="https://github.com/tinmegali/Android-Model-View-Presenter-MVP" target="_blank" rel="external">最终的框架</a>，它包含了一些可以加快MVP实现的抽象，我们也会谈论一些适配的小问题。</p>
<p>回头见！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android中的MVP-Part2/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android中的MVP-Part2/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/通过Jenkins并行完成UI的自动化测试/" title="通过Jenkins并行完成UI的自动化测试" itemprop="url">通过Jenkins并行完成UI的自动化测试</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.hidroh.com/2015/04/14/concurrent-android-ui-automation-jenkins/" target="_blank" rel="external">Concurrent Android UI automation with Jenkins</a></li>
</ul>
<p><img src="http://www.hidroh.com/assets/img/parallel-cover.jpg" alt=""></p>
<p>现在的 IT 公司会为了进入不同的市场开发相应的 App，来自同一家公司的 App 总会具有相似的 UI 逻辑，但 UI 的细节、风格又各有区分。随着产品的发展，抑或是在产品应用于新市场的过程中产生了旧 UI 逻辑的变种，用于测试所有 UI 逻辑的时间会与新 UI 的数量呈正比例关系增长。即使有 UI 的自动化框架可以用来减少测试所需的时间（例如 Calabash Android），使得每天只需要2个小时就能完成对 UI 的测试，但在这套 UI 衍生出四套“变种 UI”后，却要花费8个小时才能完成测试。</p>
<p>这篇博文将利用 Continuous Integration (CI) 服务，同时在不同的设备中执行 UI 测试，并介绍一种从根源上减少这种实际场景下自动化测试所需时间的方法。此外，我们的测试都是在真机上运行，而不是虚拟机。</p>
<p>更贴近现实的自动化测试：有很多东西只能通过真机来反映，像内存消耗，CPU 消耗：虚拟机通常都是消耗电脑的资源，而真机基本不会消耗电脑资源。</p>
<p>而且用真机进行测试性价比较高！Android 设备都很便宜，所以你可以在需要设备进行测试的时候毫不犹豫地买买买，如果用虚拟机测试的话，由于虚拟机会消耗很多电脑资源而且拓展电脑硬件很烧钱，这无疑会限制测试设备的数量。</p>
<p>虽说博文里同时使用了 Calabash Android 自动化框架 和 <a href="https://jenkins-ci.org/" target="_blank" rel="external">Jenkins CI</a>，但我提到的大部分方法可以通过运行在任意 CI 服务上的 <a href="https://wiki.jenkins-ci.org/display/JENKINS/Distributed+builds#Distributedbuilds-RunningMultipleSlavesontheSameMachine" target="_blank" rel="external">Android Debug Bridge (ADB)</a> 应用于其他的自动化测试框架里。</p>
<h2 id="创建-Jenkins-slaves-和-slave-group"><a href="#创建-Jenkins-slaves-和-slave-group" class="headerlink" title="创建 Jenkins slaves 和 slave group"></a>创建 Jenkins slaves 和 slave group</h2><p>完成<a href="https://wiki.jenkins-ci.org/display/JENKINS/Distributed+builds" target="_blank" rel="external">分布式构建</a>的第一步就是创建 Jenkins slave，授权它管理多个“奴隶”。我们可以通过 Jenkins -&gt; Manage Jenkins -&gt; Manage Nodes 导航到 Jenkins slaves/nodes 的配置界面。</p>
<p>根据定义，Jenkins slave 用于完成 Jenkins 主机分发下来的任务。在我们的使用场景中，需要完成的任务则是运行在 Android 设备上的自动化测试。为了完成这项任务，所有奴隶都可以<a href="https://wiki.jenkins-ci.org/display/JENKINS/Distributed+builds#Distributedbuilds-RunningMultipleSlavesontheSameMachine" target="_blank" rel="external">运行在相同的机器上</a>，也就是通过 USB 连接在电脑上的，具有执行 ADB 命令的 Android 设备。</p>
<p>下面是一个与 Samsung S3 关联的奴隶的安装细节：</p>
<p><img src="http://www.hidroh.com/assets/img/parallel-slave-1.png" alt=""></p>
<p>当所有奴隶都运行在同一台机器上时，我建议为不同的奴隶结点提供不同的系统 roots 文件，因为它们很可能会在测试结果处被存储，如果它们指向同一个 root 文件，可能会让测试结果被不同的结点重写。我们可以通过 Remote FS root 进行这样的设置。</p>
<blockquote>
<p><strong>Remote FS root</strong></p>
<p>每个奴隶都需要拥有 Jenkins 中的一个专用目录，我们在奴隶中为其指定绝对路径，如：’/var/jenkins’ 或 ‘c:\jenkins’，而且该路径应该是奴隶设备中的本地路径。但是该路径不需要对 Jenkins 可见，怎么正常怎么来就行。</p>
<p>奴隶不会持有重要数据（不同于最后创建于其上的项目的活跃工作区），所以你可以将奴隶的工作区设置到一个临时目录。这样做的唯一缺点在于：你可能会在奴隶设备关机后失去最新的工作区。</p>
</blockquote>
<p>当 separate FS roots 和多处理器允许 Calabash 的并行操作时，ADB_DEVICE_ARG 环境变量需要用于通知 Calabash，因为 Calabash 运行的设备应该向其发送 ADB 命令，防止设备的多重连接。底层中，Calabash 通过 ADB 设备命令自动化 UI，当一个设备匹配于另一个奴隶结点，ADB_DEVICE_ARG 应该通过环境变量的配置应用到 node 结点层中，并在其后在任务层变为可用。</p>
<blockquote>
<p><strong>环境变量</strong></p>
<p>这些键值对将会应用于结点上的每一个构建，并重写任意全局值，所以他们能在 Jenkins 的配置中被使用（如 $key 或 ${key}），而且将会被添加到构建上启动的进程。</p>
</blockquote>
<p>在 Nexus 4 中设置奴隶的方式如上</p>
<p><img src="http://www.hidroh.com/assets/img/parallel-slave-2.png" alt=""></p>
<p>如果你留心注意一些细节你会发现，所有奴隶结点都被配置了相同的 android-group 标签。这样做的目的主要是将奴隶分组，使得当我们需要使用奴隶时，方便我们调用特定分组里的所有奴隶。</p>
<blockquote>
<p>标签</p>
<p>标签（AKA 标签）用于将多个奴隶分到一个逻辑组中，而每一个标签都会消耗空间。例如 ‘regression java6’ 将为为结点分配 ‘regression’ 和 ‘java6’ 标签。</p>
<p>举例来说吧，如果你有多个窗口奴隶，而且你要完成的任务需要窗口，那么你可以让你的所有窗口奴隶持有 ‘windows’ 标签，然后将需要执行的任务与 ‘windows’ 标签绑定。这使得你的任务在所有窗口奴隶中被执行，而不是被随意执行。</p>
</blockquote>
<p><img src="http://www.hidroh.com/assets/img/parallel-slave-group.png" alt=""></p>
<p>现在如果我们检查 android-group，我们会得到一个所有结点都带着 android-group 标签的列表，把其他设备添加到这个组里就像拷贝一个已存在的结点和更新 ADB_DEVICE_ARG 环境变量一样简单。</p>
<h2 id="使用奴隶群建立并行任务"><a href="#使用奴隶群建立并行任务" class="headerlink" title="使用奴隶群建立并行任务"></a>使用奴隶群建立并行任务</h2><p>在进行了上面的配置以后，我们现在可以创建一个 Jenkins 任务使用连接到电脑的设备，通过各自的奴隶和具有 android-group 的奴隶群执行 Calabash Android。</p>
<p><img src="http://www.hidroh.com/assets/img/parallel-downstream-1.png" alt=""></p>
<p>通过选中“如果必要的话，执行并行构建”和“限制项目运行位置”两个配置选项，使得任务可以被并行执行，主题对结点可用，仅使用标有“android-group”标签的结点。但其中的限制是：需要确保只有与已连接的设备关联的结点才能用于自动化测试，因为我们有用于完成其他任务的其他与未连接设备关联的结点。</p>
<blockquote>
<p><strong>如果必要的话，执行并行构建</strong></p>
<p>如果需要并行执行构建，Jenkins 会安排并并行执行多个构建（假设你有足够的执行器和传入的构建请求），这对于耗时长的构建和测试任务来说非常有用……此外，参数化构建也是非常实用的，因为每一个执行器的执行任务与其他执行器的执行任务相互独立。</p>
</blockquote>
<p>现在假设我们有4个自动化测试的请求和三个已连接的设备，处理完所有请求将需要两轮操作（第一轮三个设备将会被使用，剩下一个请求在队列中等待处理，当某个设备变为空闲状态则会处理该请求）。这就意味着我们可以使4个产品风格自动化测试的时间从8小时减少为4小时，如果我们再买一台或者多台设备的话，时间甚至会更少。</p>
<p>##通过上游任务触发并行的下游任务</p>
<p>写到这里，我们已经能够随心所欲地对我们想要的设备（连接在 USB 端口处可用的设备！）手动地触发并行的自动化测试。但是，我们为什么要手动地完成这些工作呢？我们可以用 Jenkins Parameterized Trigger Plugin 设置上游任务，通过相应的参数触发多个下游任务。</p>
<p>例如，如果我们想要使用所有可用设备并行地测试多个应用 UI，那么我们可以设置一个这样的上游任务，并执行它：</p>
<p><img src="http://www.hidroh.com/assets/img/parallel-upstream-2.png" alt=""></p>
<p><img src="http://www.hidroh.com/assets/img/parallel-upstream-3.png" alt=""></p>
<p>上面的配置完成后，我们可以触发三个并行的 MOBILE_TEST 下游任务（必须进行了“如果必要的话，执行并行构建”的配置），每一个下游任务将会测试一个指定的 App 风格“cherry”，“tomato”，“rasberry”，并通过一个叫作风格的参数发送到下游任务。上游任务将会被阻塞，等待所有下游任务完成任务并因此设置构建状态。</p>
<p>我建议大家把上游任务运行在不同的奴隶结点/奴隶组中，而不是运行在和下游任务相同的奴隶结点/奴隶组中，否则它将占着设备不处理，浪费了资源</p>
<p><img src="http://www.hidroh.com/assets/img/parallel-upstream-1.png" alt=""></p>
<p>所以从今天开始，让我们一起回收这些被淘汰的设备，让它为我们贡献最后一丝价值吧！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/通过Jenkins并行完成UI的自动化测试/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/通过Jenkins并行完成UI的自动化测试/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/2015-Google-IO带来的新Android开发工具 /" title="2015 Google IO带来的新 Android 开发工具" itemprop="url">2015 Google IO带来的新 Android 开发工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://robovm.com/google-io-summary-whats-new-in-android-development-tools/" target="_blank" rel="external">Google I/O Summary: What’s new in Android Development Tools</a></li>
<li>原文作者 : <a href="http://robovm.com/author/mario/" target="_blank" rel="external">Mario Zechner</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="http://reondz.github.io/" target="_blank" rel="external">ReonDz</a> </li>
</ul>
<p>每年我们都非常期待 Youtube 中Google IO上那些关于 Android 的精彩讲解。然而，观看这些视频太耗费时间了。因此我们做了撰写了总结性的文字，来介绍这次的 Google IO 带来了哪些新的 Android 开发工具。（<a href="https://www.youtube.com/watch?v=f7ihSQ44WO0" target="_blank" rel="external">对应的讲演视频</a>）</p>
<h2 id="便于设计"><a href="#便于设计" class="headerlink" title="便于设计"></a>便于设计</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 10.18.10-OI2RFWPbn6.png" alt="image">  </p>
<p>Android Design Support Library 帮助我们遵循最新的最杰出的 material design 特性。这个库还附带了好几个 material design 组件诸如 navigation drawer, <a href="http://arjunu.com/2015/05/floating-labels-for-edittext/" target="_blank" rel="external">floating labels for editing text</a>(这个简单来说就是edittext 在获得焦点后，hint 会有个上升动画变成一个放置在 edittext上方的 textview 作为 label)，floating action buttons(Android L时代推出的产物，总算有了官方的低版本兼容支持)以及 支持Android 2.1及其以上版本的snackbar。   </p>
<p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 10.24.57-nwuvL0kS8W.png" alt="image"> </p>
<p>Android L 介绍了对 vector drawables 的支持。而通过 Android Studio 1.3+给 Android Gradle plugin 带来的新功能，我们可以让编译打包系统通过 开发者提供的SVG图 或者 vector drawables 生成不同 dpi 的光栅图。<br>最后，整个开发团队开始重写了所有的可视化设计编辑器。从而支持开发者所见即所得的编辑与设计而不是被 XML 文件搞的无比心烦。下面会有更详细的内容。   </p>
<h2 id="提升-Gradle-插件以及编译打包系统"><a href="#提升-Gradle-插件以及编译打包系统" class="headerlink" title="提升 Gradle 插件以及编译打包系统"></a>提升 Gradle 插件以及编译打包系统</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 10.30.01-Grz81dvubp.png" alt="image"></p>
<p>Android Gradle plugin  有的时候给人一种靠不住的感觉，特别是它的依赖管理。处理测试依赖时一些极端情况带来的问题现在已经被修复。同样，可选依赖 Gradle 还没有做到真正的支持。然而在 Android Gradle plugin 上已经解决了这一问题。      </p>
<p>开发者对 Android Gradle plugin 抱怨最多的就是它居高不下的打包消耗时间了。开发团队从多个层级入手追踪这个问题。       </p>
<p><a href="http://tools.android.com/tech-docs/jackandjill" target="_blank" rel="external">Jack</a> , Java Android Compiler Kit 的缩写，可以将 Java 源码直接编译并转换为 Dex 文件。Jack 基于 Eclipse Java 编译器。缩减了打 Dex 之前把 Java 源码编译成 JVM 字节码的步骤。 额外的，Jack 还支持增量编译打包。     </p>
<p>缩减 PNG 图片是另外一个考虑来缩减打包时间的步骤。开发团队提高了它的性能，将500张 PNG 图片和.9 图的缩减时间从 4秒 降低到了 400ms。     </p>
<p>aapt, 打包应用的dex 和 资源文件的工具同样得到了提升。     </p>
<p>另外一个影响打包时间的因素是 Gradle 本身的巨大开销。当 Gradle 开始它的打包任务时，它必须先创建描述模型比如 variant (flavor + build type)，解决所有 variants 的依赖关系（即使你只有一个）以及执行开发者自定义的逻辑。开发团队和 Gradle Ware 紧密合作工作从而提高这些步骤的性能。以下是最后的结果：   </p>
<p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 10.42.57-cl8MWwzzYC.png" alt="image"></p>
<p>这还没完。目前开发者团队正在为了一个新的  Android Gradle plugin 而工作, 它基于 Gradle Ware 正在研发的新API  。而这些新的 API 允许这些模型被 Gradle 直接管理，从而可以做诸如缓存，并发以及增量构建这些事。下面是尚未完成的新 Android Gradle plugin 的结果数据：</p>
<p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 10.46.01-KoHuJyeq0F.png" alt="image"></p>
<p>以上的数据并没有算上用上缓存的带来的提升，目前缓存的特性还没有提供出来。新插件有一个小瑕疵，因为它使用了全新的 DSL 所以无法做到完全的向后兼容。新插件的预览版会在几周内开放，最后的正式版会在今年晚一点的时候开放。   </p>
<p>开发者团队还介绍了一个新的东西，叫做 <a href="https://developer.android.com/tools/data-binding/guide.html" target="_blank" rel="external">Data Binding Library</a>。这个库需要编译构建系统的支持，因为它会通过XML中特殊声明的一些代码去生成对应的 Java 代码。老版本和新版本的 Android Gradle plugin 都能支持它。下面会有更详细的内容。   </p>
<p>最后，我们实现了对 NDK C以及C++完整的支持。这是基于Gradle native 代码的支持，所以只会在新版本中提供，它重写了Android Gradle plugin。NDK支持也带入到了Android Studio中，同时还打包了<a href="https://www.jetbrains.com/clion/" target="_blank" rel="external">CLion</a>（JetBrain旗下的C,C++ IDE）, 并免费提供。下面会有更详细的内容。   </p>
<h2 id="测试有关"><a href="#测试有关" class="headerlink" title="测试有关"></a>测试有关</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/testing_device.jpeg" alt="image">  </p>
<p>今年Android 测试最大的亮点便是最近公布的 <a href="https://developers.google.com/cloud-test-lab/" target="_blank" rel="external">Cloud Test Lab</a> 。它可以帮助开发者使用 Google 测试云平台上的虚拟设备以及真机设备测试他们开发的应用。无论是虚拟设备还是真机设备，测试实验室(test lab)都支持机器爬虫遍历应用而不需要手动的去写测试用例。就当作是有一只猴子在各种设备上玩你的应用吧=w=。当然，你还是可以自己写测试用例的。     </p>
<p>到目前为止，单元测试主要还是用于跑在 JVM 上老的Junit 测试。虽然那样可以提高测试的迭代速度，但是它并不能测试到 Android 中一些特定的代码，若没有类似的Android 库的支持的话（Roboelectric就是为此而生的）。      </p>
<p>为了支持在虚拟机或者设备上的集成测试，开发团队增加了对外部测试工程的支持。他们就在你的应用程序工程边上，引用它以及它的依赖然后进行集成测试。   </p>
<h2 id="模拟器"><a href="#模拟器" class="headerlink" title="模拟器"></a>模拟器</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.03.20-c1DKPt2w8Y.png" alt="image"></p>
<p>并没有大的进展。开发团队主要工作集中在稳定性，正确性以及配置上。 Android Studio 会下载安装 <a href="https://01.org/zh/android-ia/q-and-a/what-haxm" target="_blank" rel="external">HAXM</a>（Intel 为 Android x86平台提供的硬件加速执行管理器） 并且为你配置好它。同时，还有大量的用于OpenGL ES 模拟器的提升，相信它会给开发者带来更好的更接近于真机的模拟器表现。<a href="http://www.droid-life.com/2015/05/28/google-announces-native-fingerprint-support-in-android-m/" target="_blank" rel="external">指纹识别支持</a>以及一个特殊的 <a href="http://www.android.com/auto/" target="_blank" rel="external">Android Auto</a> 模拟器也已有提供。  </p>
<p>##Android Studio对C以及C++的支持</p>
<p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.13.41-NPAwYYVN8B.png" alt="image"></p>
<p>除了在打包系统中集成了 NDK 的支持，开发团队还与 <a href="http://robovm.com/google-io-summary-whats-new-in-android-development-tools/jetbrains.comhttp://robovm.com/google-io-summary-whats-new-in-android-development-tools/jetbrains.com" target="_blank" rel="external">JetBrains</a> 合作，将他们新的C/C++ IDE <a href="https://www.jetbrains.com/clion/" target="_blank" rel="external">CLion</a> 直接集成在了Android Studio 。并且这一切都是免费的。     </p>
<p>这次结合满足了你对一个 JetBrains的产品抱有的所有期待: 强大的重构能力，代码分析工具，代码导航，语义查询代码用例遗迹更多的特性。除此以外，还有两个能改变游戏规则的重量级功能来给native 层的开发带来便捷。     </p>
<p>Android Studio 现在支持使用 <a href="http://www.gnu.org/software/gdb/" target="_blank" rel="external">GDB</a> 或者 <a href="http://lldb.llvm.org/" target="_blank" rel="external">LLDB</a> 来debug代码。Debug native 的代码在以前是一件非常麻烦的事情，而现在，耳目一新的感觉吧？      </p>
<p>更为称道的消息是 C/C++代码 和 Java/JNI 代码的紧密融合。为了让 C/C++ 代码可以与 Java 代码相互调用。你需要为它们创建连接的桥梁。这便要通过 Java Native Interface（即JNI来实现），本质上就是一个可以让我们从Java 代码调用 C/C++代码的 C/C++ API，反之亦然。你可以在声明 Java 方法时，带上 native 的 修饰词，这样就意味着该方法是在C/C++ 层面去实现的。而对应的方法则需要按照严格的规范命名，并规定管理好传参的规则。    </p>
<p>而现在， Android Studio 帮助你用简单的方式完成以上所有工作。你可以在 Java 层声明好方法，然后 Android Studio 就会自动的帮你生成 JNI 代码。还包括了一些预定义类型的处理，比如 string，arrays。更令人印象深刻的是， 重构以及查找用例都如你所想要的可以使用。在某个文件上做重构，另外一侧的文件也会被修改到。    </p>
<p>JNI 层的开发依然十分烦杂，但这些改变可以让它变得好受一点。   </p>
<h2 id="新支持的Annotations"><a href="#新支持的Annotations" class="headerlink" title="新支持的Annotations"></a>新支持的Annotations</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.15.21-WL33x5ckez.png" alt="image"> </p>
<p>Java annotations（注解，即使@后面的那个）可以让开发者在编译期以及运行时做一些神奇的事情。开发者团队新增了13个 annotations 来帮助开发者避免一些特定类型的 bug 。    </p>
<p>举个例子，@WorkerThread 这个 annotation, 带有该 annotation 的方法会自动检查该方法中是否有代码职能在UI线程上执行的。Android Studio 会高亮出类似错误，比如设置一个按钮的文字，在一个worker 线程执行了。 开发团队已经将很多 Android 运行库中的方法标记了该 annotation 所以开发者并不需要自己去动手添加。   </p>
<p>另外一个例子就是@RequiresPermission。和@WorkerThread 一样，大多数的Android 运行库方法已经被注解过了。这是防止开发者使用了一个需要特定权限的API，但是却没有在 manifest 文件中声明权限，Android Studio 会弹框告诉你问题并为你提供插入对应权限的选项。在 Android M 中，权限管理有一定的修改，用户可以在应用运行时决定给予或禁止一些权限。这就意味着，你的应用需要处理无权限的情况。对于这种情况，Android Studio 也会自动的插入处理代码的框架。        </p>
<p>还有一些 annotations 是用于 debug 中将标志值对应标志名的问题，或者识别 编码过的颜色，资源或者view id的问题。   </p>
<p>这个讲解新 annotations 的文档目前还没有完全完工，你应该可以很快在<a href="https://developer.android.com/reference/android/support/annotation/package-summary.html" target="_blank" rel="external">这里</a>看到它们。</p>
<h2 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.25.52-zEtMZXmuok.png" alt="image"></p>
<p>当开发UI界面时，通常会将布局和视图从代码中分离到 xml 文件中然后写一些简单Java 对象(POJOs) 以及 一些 Java 代码。例如使用 findViewById() 在布局被加载后去获取对应的UI 视图的对象。   </p>
<p>Data Binding 库可以帮助开发者更简单的完成工作。不需要手动的去处理数据和视图的合作，而是声明一些简单的对象，通过一系列简单对象引用一些值并且在 布局 XML 文件中去监听这些值。这个很像 .NET里<a href="https://msdn.microsoft.com/en-us/library/ms752059%28v=vs.110%29.aspx" target="_blank" rel="external">XAML</a>的做法。    </p>
<p>为了调解 Java 类和布局 xml 文件，编译打包系统会编译期生成一个捆绑 Java 类。这个可以帮助开发者debug 调试问题。   </p>
<p>你还可以将这变成一个双向的过程，通过让你的简单 Java 对象实现 android.databings.Observable 接口，改变简单对象的值会 影响 UI展现，反之亦然。（setText 后，bind的值也会变化的意思）   </p>
<p>data binding 库目前还处于 beta 阶段，需要 Android Studio 1.3.0-beta1 以及最新的Android Gradle plugin.<br>点击<a href="https://developer.android.com/tools/data-binding/guide.html" target="_blank" rel="external">这里</a>查看更多信息。   </p>
<h2 id="分析工具"><a href="#分析工具" class="headerlink" title="分析工具"></a>分析工具</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.34.27-cSn9mmzu7x.png" alt="image">   </p>
<p>内存和性能分析工具得到了全面的改变。现在你可以在Android Studio中通过简单的图形界面操作直接获取并保存堆栈以及方法调用情况(method traces)的快照并且找出问题原因了。新的分析工具还具备了可视化视图查询的功能。你再也不需要手动的去转换 <a href="http://docs.oracle.com/javase/7/docs/technotes/samples/hprof.html" target="_blank" rel="external">HPROF</a> 文件了。   </p>
<p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.37.27-Mz8F5wmRnK.png" alt="image"></p>
<p>新的内存快照具备简洁明了的向下钻能力（drill down我理解是一层一层的点下去。。）。它提供了对象调试视图，从而让你可以查看到还在堆内存中的对象们。它还允许你顺着引用链一直找到最近的GC 节点从而轻松的找到是什么被持有住了。   </p>
<h2 id="开发者服务"><a href="#开发者服务" class="headerlink" title="开发者服务"></a>开发者服务</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.39.04-fWLlwnIlHC.png" alt="image"></p>
<p>Google 提供了广告，数据分析等服务。而如今 Android Studio 1.3 可以帮助你通过一系列定制 UI 更容易的使用这些服务，比如API Keys等。这个新功能同样会帮助添加所需要的依赖，权限以及模版类从而可以花最少的时间使用这些服务。   </p>
<h2 id="即将发布的新功能"><a href="#即将发布的新功能" class="headerlink" title="即将发布的新功能"></a>即将发布的新功能</h2><p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.41.57-iWXIUx6z6S.png" alt="image"> </p>
<p>新的可视化设计视图暂时还没有被集入到Android Studio 1.3中。尽管如此，它们还是非常令人兴奋的，因为可以为开发者减轻创建UI界面的负担。<br>上面的截图展示了新的主题编辑器。它让你可以可视化的检查以及修改主题文件。它还可以展示使用该主题的控件的预览。   </p>
<p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.46.16-xrH2DGgL94.png" alt="image"></p>
<p>而布局编辑器则被完全的重写，多了很多新功能。上述截图展示了蓝图模式，这可以让你专注于你的布局，字体风格等。它还与设计库集成，从而可以通过拖拉直接添加设计元素到布局中。   </p>
<p><img src="http://7xiegl.com1.z0.glb.clouddn.com/Screen Shot 2015-05-30 at 11.48.28-98HlY6FuwA.png" alt="image"></p>
<p>而 XML 文件预览模式现在有能力展示系统Preference了(以前是无法预览Preference的)。更重要的一个功能是完全的对布局文件预览窗口直接操作的所见即所得编辑，包括一些控件的拖动。   </p>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><p>很不幸，Q&amp;A环节十分的短暂。而在其中最有意思的问题是 Android 什么时候支持 Java 8。而回答则是，“这是一个平台性问题”(“that’s a platform issue”)。   </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/2015-Google-IO带来的新Android开发工具 /#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/2015-Google-IO带来的新Android开发工具 /" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android上MVP的介绍/" title="MVP在Android平台上的应用" itemprop="url">MVP在Android平台上的应用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://konmik.github.io/introduction-to-model-view-presenter-on-android.html" target="_blank" rel="external">Introduction to Model-View-Presenter on Android</a></li>
</ul>
<p>#Android平台上MVP的介绍</p>
<p>这篇文章向你介绍Android平台上的MVP模式，从一个简浅的例子开始实践之路。文章也会介绍一个一个库让你在Android平台上轻松的实现MVP</p>
<p>##简单吗？我怎么才能从中受益？</p>
<p>###什么是MVP？</p>
<ul>
<li><strong>View</strong>层主要是用于展示数据并对用户行为做出反馈。在Android平台上，他可以对应为Activity, Fragment,View或者对话框。</li>
<li><strong>Model</strong>是数据访问层，往往是数据库接口或者服务器的API。</li>
<li><strong>Presenter</strong>层可以想View层提供来自数据访问层的数据，除此以外，他也会处理一些后台事务。</li>
</ul>
<p>在Android平台上，MVP可以将后台事务从Activity/View/Fragment中分离出来，让它们独立于大部分生命周期事件。这样，一个应用将会变得简单， 整个应用可靠性可以提高10倍，应用的代码将会变短, 代码的可维护性提高，开发者也为此感到高兴。</p>
<p>###Android为什么需要MVP</p>
<p>####理由1：尽量简单</p>
<p>如果你还有读过这篇文章，请阅读它：<a href="https://people.apache.org/~fhanik/kiss.html" target="_blank" rel="external">Kiss原则</a>（Keep It Stupid Simple）</p>
<ul>
<li>大部分的安卓应用只使用View-Model结构</li>
<li>程序员现在更多的是和复杂的View打交道而不是解决业务逻辑。</li>
</ul>
<p>当你在应用中只使用Model-View时，到最后，你会发现“所有的事物都被连接到一起”。<br><img src="http://konmik.github.io/images/mvp_everything_is_connected_with_everything.png" alt=""></p>
<p>如果这张图看上去还不是很复杂，那么请你想象一下以下情况：每一个View在任意一个时刻都有可能出现或者消失。不要忘记View的保存和恢复，在临时的view上挂载一个后台任务。</p>
<p>“所有的事物都被连接到一起”的替代品是一个万能对象(god object)。</p>
<p><img src="http://konmik.github.io/images/mvp_a_god_object.png" alt=""></p>
<p>god object是十分复杂的，他的每一个部分都不能重复利用，无法轻易的测试、或者调试和重构。</p>
<p>###With MVP</p>
<p>###使用MVP</p>
<p><img src="http://konmik.github.io/images/mvp_mvp.png" alt=""></p>
<p>复杂的任务被分成细小的任务，并且很容易解决。越小的东西，bug越少，越容易debug，更好测试。在MVP模式下的View层将会变得简单，所以即便是他请求数据的时候也不需要回调函数。View逻辑变成十分直接。</p>
<p>理由2：后台任务</p>
<p>当你编写一个Actviity、Fragment、自定义View的时候，你会把所有的和后台任务相关的方法写在一个静态类或者外部类中。这样，你的Task不再和Activity联系在一起，这既不会导致内存泄露，也不依赖于Activity的重建。</p>
<p>这里有若干种方法处理后台任务，但是它们的可靠性都不及MVP。</p>
<p>###为什么它是可行的？</p>
<p>这里有一张表格，用于展示在configuration改变、Activity 重启、Out-Of-Memory时，不同的应用部分会发生什么？</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">情景 1</th>
<th style="text-align:center">情景 2</th>
<th style="text-align:center">情景 3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">配置改变</td>
<td style="text-align:center">Activity 重启</td>
<td style="text-align:center">进程重启</td>
</tr>
<tr>
<td style="text-align:center">对话框</td>
<td style="text-align:center">重置</td>
<td style="text-align:center">重置</td>
<td style="text-align:center">重置</td>
</tr>
<tr>
<td style="text-align:center">Activity, View, Fragment</td>
<td style="text-align:center">保存/恢复</td>
<td style="text-align:center">保存/恢复</td>
<td style="text-align:center">保存/恢复</td>
</tr>
<tr>
<td style="text-align:center">Fragment with setRetainInstance(true)</td>
<td style="text-align:center">无变化</td>
<td style="text-align:center">保存/恢复</td>
<td style="text-align:center">保存/恢复</td>
</tr>
<tr>
<td style="text-align:center">Static variables and threads</td>
<td style="text-align:center">无变化</td>
<td style="text-align:center">无变化</td>
<td style="text-align:center">重置</td>
</tr>
</tbody>
</table>
<p>情景 1: 当用户切换屏幕、更改语言设置或者链接外部的模拟器时，往往意味着设置改变。 相关更多请阅读<a href="http://developer.android.com/reference/android/R.attr.html#configChanges" target="_blank" rel="external">这里</a>。</p>
<p>情景 2:Activity的重启发生在当用户在开发者选项中选中了“Don’t keep activities”（“中文下为 不保留活动”）的复选框，然后另一个Activity在最顶上的时候。</p>
<p>情景 3: 进程的重启发生在应用运行在后台，但是这个时候内存不够的情况下。</p>
<p>###总结</p>
<p>现在你可以发现，一个setRetainInstance(true)的Fragment也不奏效，我们还是希望这样的Fragment在所有的情景下为保存/恢复的状态模式，所以为简化问题，我们暂不考虑上述情况的Fragment。<a href="http://en.wikipedia.org/wiki/Occam&#39;s_razor" target="_blank" rel="external">Occam’s razor</a></p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">配置改变,   Activity重启</th>
<th style="text-align:center">进程重启</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Activity, View, Fragment, DialogFragment</td>
<td style="text-align:center">保存/恢复</td>
<td style="text-align:center">保存/恢复</td>
</tr>
<tr>
<td style="text-align:center">Static variables and threads</td>
<td style="text-align:center">无变化</td>
<td style="text-align:center">重置</td>
</tr>
</tbody>
</table>
<p>现在，看上去更舒服了，我们只需要写两段代码为了恢复应用：</p>
<ul>
<li><p>保存/恢复 for Activity, View, Fragment, DialogFragment;</p>
</li>
<li><p>重启后台请求由于进程重启</p>
</li>
</ul>
<p>第一个部分,用Android的API可以实现。第二个部分，就是Presenter的作用了。Presenter只会记住有哪些请求需要执行，当进程在执行过程中重启时，Presenter将会再次执行它们。</p>
<p>#####一个简单的例子(no MVP)</p>
<p>这个例子用于从远程服务器加载数据并呈现，当发生异常时，会通过Toast提示。</p>
<p>我推荐使用<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="external">RxJava</a>构建Presenter，因为这个库更容易控制数据流。</p>
<p>我想对创造如此简单的API的伙计说声谢谢，我把它用于<a href="http://www.icndb.com/" target="_blank" rel="external">The Internet Chuck Norris Database</a></p>
<p>无MVP的<a href="https://github.com/konmik/MVPExamples/tree/master/example00" target="_blank" rel="external">例子00</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_NAME = <span class="string">"Chuck Norris"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ArrayAdapter&lt;ServerAPI.Item&gt; adapter;</div><div class="line">    <span class="keyword">private</span> Subscription subscription;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        ListView listView = (ListView)findViewById(R.id.listView);</div><div class="line">        listView.setAdapter(adapter = <span class="keyword">new</span> ArrayAdapter&lt;&gt;(<span class="keyword">this</span>, R.layout.item));</div><div class="line">        requestItems(DEFAULT_NAME);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        unsubscribe();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestItems</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        unsubscribe();</div><div class="line">        subscription = App.getServerAPI()</div><div class="line">            .getItems(name.split(<span class="string">"\\s+"</span>)[<span class="number">0</span>], name.split(<span class="string">"\\s+"</span>)[<span class="number">1</span>])</div><div class="line">            .delay(<span class="number">1</span>, TimeUnit.SECONDS)</div><div class="line">            .observeOn(AndroidSchedulers.mainThread())</div><div class="line">            .subscribe(<span class="keyword">new</span> Action1&lt;ServerAPI.Response&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(ServerAPI.Response response)</span> </span>&#123;</div><div class="line">                    onItemsNext(response.items);</div><div class="line">                &#125;</div><div class="line">            &#125;, <span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable error)</span> </span>&#123;</div><div class="line">                    onItemsError(error);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemsNext</span><span class="params">(ServerAPI.Item[] items)</span> </span>&#123;</div><div class="line">        adapter.clear();</div><div class="line">        adapter.addAll(items);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemsError</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, throwable.getMessage(), Toast.LENGTH_LONG).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribe</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (subscription != <span class="keyword">null</span>) &#123;</div><div class="line">            subscription.unsubscribe();</div><div class="line">            subscription = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有经验的开发者会注意到这个例子有以下不妥：</p>
<p>当用户翻转屏幕时候会开始请求，应用发起了过多的请求，将会是屏幕在切换的时候呈现空白的界面。</p>
<p>当用户频繁的切换屏幕，这将会造成内存泄露，请求运行时，每一个回调将会持有MainActivity的引用，让其保存在内存中。因此引起的OOM和应用反应迟缓，会引发应用的Crash。</p>
<p>MVP模式下的<a href="https://github.com/konmik/MVPExamples/tree/master/example01" target="_blank" rel="external">例子 01</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainPresenter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_NAME = <span class="string">"Chuck Norris"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ServerAPI.Item[] items;</div><div class="line">    <span class="keyword">private</span> Throwable error;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MainActivity view;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainPresenter</span><span class="params">()</span> </span>&#123;</div><div class="line">        App.getServerAPI()</div><div class="line">            .getItems(DEFAULT_NAME.split(<span class="string">"\\s+"</span>)[<span class="number">0</span>], DEFAULT_NAME.split(<span class="string">"\\s+"</span>)[<span class="number">1</span>])</div><div class="line">            .delay(<span class="number">1</span>, TimeUnit.SECONDS)</div><div class="line">            .observeOn(AndroidSchedulers.mainThread())</div><div class="line">            .subscribe(<span class="keyword">new</span> Action1&lt;ServerAPI.Response&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(ServerAPI.Response response)</span> </span>&#123;</div><div class="line">                    items = response.items;</div><div class="line">                    publish();</div><div class="line">                &#125;</div><div class="line">            &#125;, <span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">                    error = throwable;</div><div class="line">                    publish();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTakeView</span><span class="params">(MainActivity view)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.view = view;</div><div class="line">        publish();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (items != <span class="keyword">null</span>)</div><div class="line">                view.onItemsNext(items);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (error != <span class="keyword">null</span>)</div><div class="line">                view.onItemsError(error);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从严格意义上来说，MainPresenter有三个事件处理线程： <em>onNext</em>, <em>onError</em>, <em>onTakeView</em>。他们在<code>publish()</code>方法中被回调，<em>onNext</em> 或 <em>onError</em>的值将会在由onTakeView方法传入的View实例,也就是MainActivity中来发布。      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ArrayAdapter&lt;ServerAPI.Item&gt; adapter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MainPresenter presenter;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        ListView listView = (ListView)findViewById(R.id.listView);</div><div class="line">        listView.setAdapter(adapter = <span class="keyword">new</span> ArrayAdapter&lt;&gt;(<span class="keyword">this</span>, R.layout.item));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (presenter == <span class="keyword">null</span>)</div><div class="line">            presenter = <span class="keyword">new</span> MainPresenter();</div><div class="line">        presenter.onTakeView(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        presenter.onTakeView(<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> (isFinishing())</div><div class="line">            presenter = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemsNext</span><span class="params">(ServerAPI.Item[] items)</span> </span>&#123;</div><div class="line">        adapter.clear();</div><div class="line">        adapter.addAll(items);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemsError</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, throwable.getMessage(), Toast.LENGTH_LONG).show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MainActivty构建了MainPresenter，将其维持在onCreate/onDestroy周期外，MainActivity持有MainPresenter的静态引用，所以每一个进程由于OOM重启时，MainActivity可以确认Presenter是否仍然存在，必要时创建。</p>
<p>当然，确认和使用静态变量可能是代码变得臃肿，稍后我们会告诉你如何好看些：。:)</p>
<p>####重要思路：</p>
<ul>
<li>示例程序不会在每次切换屏幕的时候都开始一个新的请求</li>
<li>当进程重启时，示例程序将会重新加载数据。</li>
<li>当MainActivity销毁时，MainPresenter不会持有MainActivity的引用，因此不会在切换屏幕的时候发生内存泄漏，而且没必要去unsubscribe请求。</li>
</ul>
<p>###<a href="https://github.com/konmik/nucleus" target="_blank" rel="external">Nucleus</a></p>
<p>Nucleus是我从<a href="https://github.com/square/mortar" target="_blank" rel="external">Mortar</a>和 Keep It Stupid Simple 这篇文章得到的灵感而建立的库。</p>
<p>它有以下特征：</p>
<ul>
<li><p>它支持在View/Fragment/Activity的Bundle中保存/恢复Presenter的状态，一个Presenter可以保存它的请求参数到bundles中，以便之后重启它们</p>
</li>
<li><p>只需要一行代码，它就可以直接将请求结果和错误反馈给View，所以你不需要写<code>!= null</code>之类的非空判断语句。</p>
</li>
<li><p>它允许一个view实例可以持有多个Presenter。不过你不能在用<a href="http://square.github.io/dagger/" target="_blank" rel="external">Dagger</a>实例化的presenter中这样使用(传统方法).</p>
</li>
<li><p>它可以用一行代码快速的将View和Presenter绑定。</p>
</li>
<li><p>它提供一些现成的基类，例如: <code>NucleusView</code>, <code>NucleusFragment</code>, <code>NucleusSupportFragment</code>, <code>NucleusActivity</code>. 你可以将他们的代码拷贝出来改造出一个自己的类以利用Nucleus的presenter。</p>
</li>
<li><p>支持在进程重启后，自动重新发起请求，在<code>onDestroy</code>方法中，自动的退订RxJava的订阅。</p>
</li>
<li><p>最后，它简洁明了，每一个开发者都会理解，以上这些只用了180行代码来驱动Presenter这个类,加上230行RxJava的依赖。</p>
</li>
</ul>
<p>使用了<a href="https://github.com/konmik/nucleus" target="_blank" rel="external">Nucleus</a> 的<a href="https://github.com/konmik/MVPExamples/tree/master/example02" target="_blank" rel="external">例 02</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainPresenter</span> <span class="keyword">extends</span> <span class="title">RxPresenter</span>&lt;<span class="title">MainActivity</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_NAME = <span class="string">"Chuck Norris"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedState);</div><div class="line"></div><div class="line">        App.getServerAPI()</div><div class="line">            .getItems(DEFAULT_NAME.split(<span class="string">"\\s+"</span>)[<span class="number">0</span>], DEFAULT_NAME.split(<span class="string">"\\s+"</span>)[<span class="number">1</span>])</div><div class="line">            .delay(<span class="number">1</span>, TimeUnit.SECONDS)</div><div class="line">            .observeOn(AndroidSchedulers.mainThread())</div><div class="line">            .compose(<span class="keyword">this</span>.&lt;ServerAPI.Response&gt;deliverLatestCache())</div><div class="line">            .subscribe(<span class="keyword">new</span> Action1&lt;ServerAPI.Response&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(ServerAPI.Response response)</span> </span>&#123;</div><div class="line">                    getView().onItemsNext(response.items);</div><div class="line">                &#125;</div><div class="line">            &#125;, <span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">                    getView().onItemsError(throwable);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@RequiresPresenter</span>(MainPresenter.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">NucleusActivity</span>&lt;<span class="title">MainPresenter</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ArrayAdapter&lt;ServerAPI.Item&gt; adapter;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        ListView listView = (ListView)findViewById(R.id.listView);</div><div class="line">        listView.setAdapter(adapter = <span class="keyword">new</span> ArrayAdapter&lt;&gt;(<span class="keyword">this</span>, R.layout.item));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemsNext</span><span class="params">(ServerAPI.Item[] items)</span> </span>&#123;</div><div class="line">        adapter.clear();</div><div class="line">        adapter.addAll(items);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemsError</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, throwable.getMessage(), Toast.LENGTH_LONG).show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正如你看到的，跟上一个代码相比，这个例子十分简洁。Nucleus 可以构造/销毁/保存 Presenter, 绑定/解绑 View ，并且自动向已经绑定的view发送请求的结果。</p>
<p><code>MainPresenter</code>的代码比较短，因为它使用<code>deliverLatestCache（）</code>的操作，延迟了由一个数据源发出所有的数据和错误，直到View可用。它还把数据缓存在内存中，以便它可以在Configuration change时可以被重用。</p>
<p><code>MainActivity</code>的代码比较短，因为主Presenter的创作由<code>NucleusActivity</code>管理。当你需要绑定一个Presenter的时候，只需要添加注解<code>@RequiresPresenter（MainPresenter.class）</code>。</p>
<p>警告！注释！在Android中，如果你使用注解，这是最好检查以下这么做会不会降低性能。以我使用的’Galaxy S`（2010年设备）为例，处理此批注耗时不超过0.3毫秒。只在实例化view的时候才会发生，因此注解在这里对性能的影响可以忽略。</p>
<p>####更多例子</p>
<p>一个扩展的例子,带有请求参数的Presenter：<a href="https://github.com/konmik/nucleus/tree/master/nucleus-example" target="_blank" rel="external">Nucleus Example</a>。</p>
<p>带有单元测试的例子： <a href="https://github.com/konmik/nucleus/tree/master/nucleus-example-with-tests" target="_blank" rel="external">Nucleus Example With Tests</a></p>
<p>####<code>deliverLatestCache()</code> 方法</p>
<p>这个RxPresenter的工具方法有三个变种：</p>
<ul>
<li><p><code>deliver()</code> will just delay all onNext, onError and onComplete emissions until a View becomes available. Use it for cases when you’re doing a one-time request, like logging in to a web service. <a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onCreate(android.os.Bundle" target="_blank" rel="external">Javadoc</a>)</p>
</li>
<li><p><code>deliver()</code>只是推迟onNext、onError、onComplete的调用，直到视图有效。使用它，你只需要一次请求，就像发起登陆web服务一样。<a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onCreate(android.os.Bundle" target="_blank" rel="external">Javadoc</a>)</p>
</li>
<li><p><code>deliverLatest（）</code>当有新的的onNext值，将会舍弃原有的值，如果你有可更新的数据源，这将让你去除那些不需要的数据。<a href="http://konmik.github.io/nucleus/nucleus/presenter/RxPresenter.html#deliverLatest" target="_blank" rel="external">Javadoc</a></p>
</li>
<li><p><code>deliverLatestCache（）</code>，和<code>deliverLatest（）</code>一样，但除了它会在内存中保存最新的结果外，当View的另一个实例可用（例如：在配置更改的时候）时，还是会触发一次。如果你不想组织请求在你的View中的保存/恢复事务（比方说，结果太大或者不能很容易地保存在Bundle中），这个方法可以让用户体验更好。<a href="http://konmik.github.io/nucleus/nucleus/presenter/RxPresenter.html#deliverLatestCache" target="_blank" rel="external">Javadoc</a></p>
</li>
</ul>
<p>####Presenter的生命周期</p>
<p>相比Android组件，Presenter的生命周期更加简短。</p>
<ul>
<li><p><code>void onCreate(Bundle savedState)</code> - 每一个Presenter构造时 .  <a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onCreate(android.os.Bundle" target="_blank" rel="external">Javadoc</a>)</p>
</li>
<li><p><code>void onDestroy()</code> - 用户离开View时调用 . <a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onDestroy(" target="_blank" rel="external">Javadoc</a>)</p>
</li>
<li><p><code>void onSave(Bundle state)</code> - 在View的<code>onSaveInstanceState</code>方法中调用，用于持有Presenter的状态.  <a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onSave(android.os.Bundle" target="_blank" rel="external">Javadoc</a>)</p>
</li>
<li><p><code>void onTakeView(ViewType view)</code> - 在Activity或者Fragment的<code>onResume()</code>方法中或者<code>android.view.View#onAttachedToWindow()</code>调用.  <a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onTakeView(ViewType" target="_blank" rel="external">Javadoc</a>)</p>
</li>
<li><p><code>void onTakeView(ViewType view)</code> - 在Activity或者Fragment的<code>onResume()</code>方法中或者<code>android.view.View#onAttachedToWindow()</code>调用.  <a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onTakeView(ViewType" target="_blank" rel="external">Javadoc</a>)</p>
</li>
<li><p><code>void onDropView()</code> -  在Activity或者Fragment的<code>onPause()</code>方法中或者<code>android.view.View#onDetachedFromWindow()</code>调用. <a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onDropView" target="_blank" rel="external">Javadoc</a></p>
</li>
</ul>
<p>####View的回收与View栈</p>
<p>通常来说,你的view（比如fragment或者自定义的view）在用户的交互过程中挂载与解挂（attached and detached）都是随机发生的。 这倒是不让presenter在view每次解挂（detached）的时候都销毁的一个启发。你可以在任何时候挂载与解挂view，但是presenter可以在这些行为中幸存下来，继续后台的工作。</p>
<p>这里还存在着一个关于View回收的问题：一个Fragment在Configuration change或者从stack中弹出的情况下，不知道自身有没有解挂（detached）。</p>
<p>默认只在Activity处于finish时，才在调用View的<code>onDetachedFromWindow()</code>/<code>onDestroy()</code> 销毁Presenter。</p>
<p>所以，当你在常规的Activity生命周期内，销毁View，你需要给给View一个销毁Presenter的信号。在这里，公有方法<code>NucleusLayout.destroyPresenter()</code> and <code>NucleusFragment.destroyPresenter()</code>就派上用场了。</p>
<p>例如，在我的项目中，下面的是我如何进行FragmentManager的<code>pop()</code>操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fragment = fragmentManager.findFragmentById(R.id.fragmentStackContainer);</div><div class="line">fragmentManager.popBackStackImmediate();</div><div class="line"><span class="keyword">if</span> (fragment <span class="keyword">instanceof</span> NucleusFragment)</div><div class="line">    ((NucleusFragment)fragment).destroyPresenter();</div></pre></td></tr></table></figure>
<p>在进行<em>replace</em>Fragment栈和对处于底部的Fragment进行<em>push</em>操作时，你可能需要进行相同的操作。</p>
<p>在View从Activity解挂（detached）时，您可能会选择摧毁Presenter来避免问题的发生，但是，这将意味着当View解挂（detached）时，后台任务无法继续进行。</p>
<p>所以这一节的 “view recycling”完全留你你自己考虑，也许有一天我会找到更好的解决办法，如果你有一个办法，请告诉我。</p>
<p>####最佳实践</p>
<p>在Presenter中保存你的请求参数。</p>
<p>规则很简单：Presenter的主要作用是管理请求。所以，View不应该自己处理或者重启请求。从View中，我们可以看见，后台事务不会消失，总是会返回结果或者错误，<em>而不是通过回调的方式</em>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainPresenter</span> <span class="keyword">extends</span> <span class="title">RxPresenter</span>&lt;<span class="title">MainActivity</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String name = DEFAULT_NAME;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedState);</div><div class="line">        <span class="keyword">if</span> (savedState != <span class="keyword">null</span>)</div><div class="line">            name = savedState.getString(NAME_KEY);</div><div class="line">        ...</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSave</span><span class="params">(@NonNull Bundle state)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onSave(state);</div><div class="line">        state.putString(NAME_KEY, name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我推荐使用一个很棒的库<a href="https://github.com/frankiesardo/icepick" target="_blank" rel="external">Icepick</a>。在不使用运行时注解的前提下，它可以减少代码量，并简化应用程序逻辑 - 所有的事都在编译过程中已经处理好了。这个库和<a href="http://jakewharton.github.io/butterknife" target="_blank" rel="external">ButterKnife</a>搭配是个不错的选择。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainPresenter</span> <span class="keyword">extends</span> <span class="title">RxPresenter</span>&lt;<span class="title">MainActivity</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Icicle</span> String name = DEFAULT_NAME;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedState);</div><div class="line">        Icepick.restoreInstanceState(<span class="keyword">this</span>, savedState);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSave</span><span class="params">(@NonNull Bundle state)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onSave(state);</div><div class="line">        Icepick.saveInstanceState(<span class="keyword">this</span>, state);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你有不止一对请求参数，这个库在不使用运行时注解的前提下。您可以创建<code>BasePresenter</code>并把<em>Icepick</em>到该类中，所有的子类将会自动保存标有<code>@Icicle</code>这一注解的变量，而你将不再需要去实现<code>OnSave</code>。这也适用于保存Activity，Fragment，View的状态。</p>
<p>####在主线程中调用<code>onTakeView</code>进行即时查询<a href="http://konmik.github.io/nucleus/nucleus/presenter/Presenter.html#onTakeView(ViewType" target="_blank" rel="external">Javadoc</a>)</p>
<p>有时候，你要进行少量的数据查询，如从数据库中读取少量的数据。虽然你可以很容易地用Nucleus创建一个可重启的请求，你不必到处使用这个强大的工具。如果你在fragment创建的时候初始化一个后台请求，即使只有几毫秒，用户也会看到一会儿的空白屏。因此，为了使代码更短，用户体验更好，可以使用主线程。</p>
<h4 id="不要让Presenter控制你的View"><a href="#不要让Presenter控制你的View" class="headerlink" title="不要让Presenter控制你的View"></a>不要让Presenter控制你的View</h4><p>这不是很好的工作方式 - 由于这种不自然的方式，应用程序逻辑变得太复杂。</p>
<p>自然的方式是操作流由用户发起，通过View，Presenter和Model，最后流向数据。毕竟，用户将使用应用,用户是控制应用程序的源头。因此，控制应该从用户开始而不是一些应用的内部结构。</p>
<p>从view，到presenter到model是很直接的形式，很容易书写这样的代码。你将得到以下序列： <strong>user -&gt; view -&gt; presenter -&gt; model -&gt; data</strong> 。但是，当控制流变成这样时: <strong>user -&gt; view -&gt; presenter -&gt; view -&gt; presenter -&gt; model -&gt; data</strong>，它只是违反KISS原则.</p>
<p>Fragments？不好意思它是违背了这种自然操作流程的。它们太复杂。这里是一个非常好讲诉Fragment的文章：<a href="http://corner.squareup.com/2014/10/advocating-against-android-fragments.html" target="_blank" rel="external">抨击Android的Fragment</a>。fragment的替代者<a href="https://github.com/square/flow" target="_blank" rel="external">Flow</a> 并没有简化多少东西。</p>
<p>####MVC</p>
<p>如果你对MVC（模型-View-控制器）-不要去使用。模型-View-控制器和MVP完全不同，不能解决接口开发者面对的问题。</p>
<p>####What is MVC?</p>
<p>####什么是MVC?</p>
<ul>
<li><p><strong>Model</strong>代表着应用程序的内部状态。它可以负责存储，当然也可以不考虑。</p>
</li>
<li><p><strong>View</strong>是唯一的与MVP相同的部分 - 它用于将模型呈现在屏幕上，应用程序的一部分。</p>
</li>
<li><p><strong>Controller</strong>表示输入装置，如键盘，鼠标或操纵杆。</p>
</li>
</ul>
<p>MVC在过去以键盘为驱动的应用中（比如游戏），是比较好的模式。没有窗口和图形用户界面的交互——应用接受输入(Controller),维持状态（Model），产生输出（View）。同样，数据和控制的关系是这样的。<strong>controller -&gt; model -&gt; view</strong>。这种模式是在Android绝对无用。</p>
<p>这里有一些关于MVC的困惑。人们（Web开发人员）觉得他们使用MVC，而实际上，他们使用的MVP。许多Android开发者认为Controller是用于控制View的，所以他们试图在创建View时，从视图（View）中提取视图逻辑，交由专门的控制器控制。我个人是没有看出这种架构的好处。</p>
<h4 id="在数据复杂的项目中使用固定的数据结构"><a href="#在数据复杂的项目中使用固定的数据结构" class="headerlink" title="在数据复杂的项目中使用固定的数据结构"></a>在数据复杂的项目中使用固定的数据结构</h4><p>在这方面，<a href="https://github.com/google/auto/tree/master/value" target="_blank" rel="external">AutoValue</a>是十分好的库，在它的描述中，你会发现一大堆好处，我建议你阅读它。Android平台上还有一个接口：<a href="https://github.com/frankiesardo/auto-parcel" target="_blank" rel="external">AutoParcel</a>。其主要原因是，你可以四处传递，而不用关心是否在程序的某个地方被修改了。而且他们也是线程安全的。</p>
<p>###总结</p>
<p>试试MVP吧，然后告诉你的朋友。:)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android上MVP的介绍/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android上MVP的介绍/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android测试框架Dagger 2 + Espresso 2 + Mockito/" title="Android测试框架Dagger 2 + Espresso 2 + Mockito" itemprop="url">Android测试框架Dagger 2 + Espresso 2 + Mockito</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://blog.sqisland.com/2015/04/dagger-2-espresso-2-mockito.html" target="_blank" rel="external">Dagger 2 + Espresso 2 + Mockito</a></li>
</ul>
<p>我一直在用Dagger, Espresso和Mockito做Android测试，爱死这个组合了！为了庆祝<a href="http://google.github.io/dagger/" target="_blank" rel="external">Dagger 2</a>的推出，我分享了一个用Dagger 2, Espresso 2和Mockito做Android测试的<a href="https://github.com/chiuki/android-test-demo" target="_blank" rel="external">Demo</a></p>
<h3 id="Dagger-组件-Components"><a href="#Dagger-组件-Components" class="headerlink" title="Dagger 组件(Components)"></a>Dagger 组件(Components)</h3><p><a href="http://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="external">Dependency injection(依赖注入)</a> 允许我们在App开发和测试中可以获取到不同的模块，非常有利于创建可重用的测试用例，这个Demo App的功能是以<code>&quot;yyyy-MM-dd&quot;</code>格式显示今天的日期，我们需要测试一下来应对一些已知的日期，而非依赖于运行测试时的真实日期。</p>
<p>在<code>Dagger 2</code>中，一个组件(Component)接口可以给整个App提供模块，并且定义了在哪注入它们。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoComponent</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity mainActivity)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Singleton</span></div><div class="line"><span class="meta">@Component</span>(modules = ClockModule.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationComponent</span> <span class="keyword">extends</span> <span class="title">DemoComponent</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Singleton</span></div><div class="line"><span class="meta">@Component</span>(modules = MockClockModule.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestComponent</span> <span class="keyword">extends</span> <span class="title">DemoComponent</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivityTest mainActivityTest)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>ApplicationComponent</code></strong>组件用于App的正常运行, 而<strong><code>TestComponent</code></strong>组件则用于测试，这两个组件都可以被注入到<strong><code>MainActivity</code></strong>中。</p>
<p><strong><code>MainActivity</code></strong>如何知道使用的哪个组件(component)? 答案是通过<strong><code>DemoApplication</code></strong>来注入, 它保存着该组件(component)的引用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> DemoComponent component = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onCreate();</div><div class="line">	<span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</div><div class="line">		component = DaggerDemoApplication_ApplicationComponent</div><div class="line">					.builder()</div><div class="line">					.clockModule(<span class="keyword">new</span> ClockModule())</div><div class="line">					.build();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setComponent</span><span class="params">(DemoComponent component)</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>.component = component;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> DemoComponent <span class="title">component</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> component;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试时，我们需要在<strong><code>onCreate()</code></strong>方法执行之前调用<strong><code>setComponent()</code></strong>方法，将组件设置为<strong><code>TestComponent</code></strong>。而App正常运行时,组件在<strong><code>onCreate()</code></strong>方法中就被设置为<strong><code>ApplicationComponent</code></strong>了。</p>
<h3 id="Mockito"><a href="#Mockito" class="headerlink" title="Mockito"></a>Mockito</h3><p>App中有一个<strong><code>Clock</code></strong>类，其中有一个方法可以返回当前的时间:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> DateTime <span class="title">getNow</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> DateTime();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>TestComponent</code></strong>组件中包含<strong><code>MockClockModule</code></strong>模块，后者使用<a href="http://mockito.org/" target="_blank" rel="external">Mockito</a>提供了一个模拟的<strong><code>Clock</code></strong>。这样<a href="https://github.com/chiuki/android-test-demo/blob/master/app/src/androidTest/java/com/sqisland/android/test_demo/MainActivityTest.java" target="_blank" rel="external"><strong><code>MainActivityTest</code></strong></a>就可以在测试期间提供一个预先设置的日期了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mockito.when(clock.getNow()).thenReturn(<span class="keyword">new</span> DateTime(<span class="number">2008</span>, <span class="number">9</span>, <span class="number">23</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</div></pre></td></tr></table></figure>
<p>因为我们使用了单例, 相同的模拟<strong><code>Clock</code></strong>将为整个App提供日期，这样就能被显示提供的日期，而非今天的日期了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">onView(withId(R.id.date)).check(matches(withText(<span class="string">"2008-09-23"</span>)));</div></pre></td></tr></table></figure>
<h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>这里还有很多示例, 包括使用intent启动的activity的测试和使用JUnit测试的单元测试，请点击下面链接查看:</p>
<p><a href="https://github.com/chiuki/android-test-demo" target="_blank" rel="external">Click Me</a></p>
<p>相关阅读:</p>
<blockquote>
<ul>
<li><a href="http://engineering.circle.com/instrumentation-testing-with-dagger-mockito-and-espresso/" target="_blank" rel="external">Instrumentation Testing with Dagger, Mockito, and Espresso</a></li>
<li><a href="https://gist.github.com/JakeWharton/1c2f2cadab2ddd97f9fb" target="_blank" rel="external">A JUnit @Rule which launches an activity when your test starts</a></li>
<li><a href="https://code.google.com/p/android-test-kit/wiki/EspressoStartGuide" target="_blank" rel="external">EspressoStartGuide</a> </li>
<li><a href="http://wiebe-elsinga.com/blog/whats-new-in-android-testing/" target="_blank" rel="external">What’s new in Android Testing</a></li>
<li><a href="https://github.com/googlesamples/android-testing" target="_blank" rel="external">https://github.com/googlesamples/android-testing</a></li>
</ul>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android测试框架Dagger 2 + Espresso 2 + Mockito/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android测试框架Dagger 2 + Espresso 2 + Mockito/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android架构演化之路/" title="Android架构演化之路" itemprop="url">Android架构演化之路</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://fernandocejas.com/2015/07/18/architecting-android-the-evolution/" target="_blank" rel="external">Architecting Android…The evolution</a></li>
</ul>
<p>大家好!  过了一好阵子了(在此期间我收到了大量的读者反馈) 我决定是时候回到手机程序架构这个话题上了(这里用android代码举例),  <strong><em>给大家另一个我认为好的解决方案.</em></strong></p>
<p>在开始之前, 我这里假设大家都读过了我之前<a href="http://fernandocejas.com/2014/09/03/architecting-android-the-clean-way/" target="_blank" rel="external">用简洁的办法架构Android程序</a>一文. 如果你还没有读过, 现在应该去读一下那篇文章, 读过之后可以更好的理解我下面要讲的内容.</p>
<p><img src="http://fernandocejas.com/wp-content/uploads/2014/09/clean_architecture1.png" alt="上一篇文章截图"></p>
<h2 id="架构的演化"><a href="#架构的演化" class="headerlink" title="架构的演化"></a>架构的演化</h2><p><strong><em>演化是指一个事物变化成为另一个不同的事物的一个平缓过程, 通常情况下会变得更加复杂或者变成更好.</em></strong></p>
<p>软件开发一直在进化和改变.  <strong><em>实际上, 一个好的代码结构必须帮助我们成长, 这意味着不用重新写所有代码就可以扩展功能.</em></strong> (尽管有些情况下应该大量的重写代码, 但那又是另一回事了, 这里先不做探讨).</p>
<p>这篇文章的重点是<strong><em>如何保持android代码的清晰直观</em></strong>, 为了阐述这一问题, 我将会带着大家看几个我认为重要的关键点. 记住下面这个图我们就可以开始了.</p>
<p><img src="http://fernandocejas.com/wp-content/uploads/2014/09/clean_architecture_android.png" alt="Presentation,Domain,Data三层架构示意图"></p>
<h3 id="反应式方法-RxJava"><a href="#反应式方法-RxJava" class="headerlink" title="反应式方法: RxJava"></a>反应式方法: RxJava</h3><p>在这里我就不讲RxJava的好处了(<a href="https://github.com/ReactiveX/RxJava/wiki" target="_blank" rel="external">我猜大家都已经自己体会过了</a>) , 因为已经有很多<a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">文章</a>和<a href="https://speakerdeck.com/benjchristensen" target="_blank" rel="external">坏蛋们</a>都讲过了, 而且讲的还都不错. <strong><em>这里我要讲的是它是怎么使得android开发变得非常有趣的, 还有它是如何帮助我完成搭建第一个干净简洁的架构的.</em></strong></p>
<p>首先, 我选择一个反应式模式让用例(在简洁的架构命名规范中叫做interactor) 都返回Observables<t>, 这样的话所有子类都必须遵守这个规则也返回Observables<t></t></t></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">UseCase</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadExecutor threadExecutor;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> PostExecutionThread postExecutionThread;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Subscription subscription = Subscriptions.empty();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">UseCase</span><span class="params">(ThreadExecutor threadExecutor,</span></span></div><div class="line">    PostExecutionThread postExecutionThread) &#123;</div><div class="line">    <span class="keyword">this</span>.threadExecutor = threadExecutor;</div><div class="line">    <span class="keyword">this</span>.postExecutionThread = postExecutionThread;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Observable <span class="title">buildUseCaseObservable</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Subscriber UseCaseSubscriber)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.subscription = <span class="keyword">this</span>.buildUseCaseObservable()</div><div class="line">    .subscribeOn(Schedulers.from(threadExecutor))</div><div class="line">    .observeOn(postExecutionThread.getScheduler())</div><div class="line">    .subscribe(UseCaseSubscriber);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unsubscribe</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!subscription.isUnsubscribed()) &#123;</div><div class="line">        subscription.unsubscribe();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出,所有的子用例都继承自这个抽象类,并在<strong><em>buildUseCaseObservable()</em></strong>这个抽象方法中构造一个可以完成耗时操作并返回需要数据的<strong><em>Observable<t></t></em></strong></p>
<p><strong><em>需要注意的是execute()这个方法, 我们保证了Observable<t>让自己执行在一个单独的线程中</t></em></strong>, 这样的话就可以最小限度的减少在主线程耗时.  然后通过主线程的scheduler机制把Observable<t>的执行结果返回给主线程.</t></p>
<p><strong><em>到现在为止, 我们已经有了Observable<t> , 但是它产生的数据得有人来处理</t></em></strong> . 所以我这里将presenter(<strong><em>MVP</em></strong> 三层架构中的presentation层的一部分)改为了 <strong><em>Subscribers</em></strong> ,当用例产生数据后可以及时更新UI.</p>
<p>也就是下面这样的subscriber:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserListSubscriber</span> <span class="keyword">extends</span></span></div><div class="line">    <span class="title">DefaultSubscriber</span>&lt;<span class="title">List</span>&lt;<span class="title">User</span>&gt;&gt; &#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">      UserListPresenter.<span class="keyword">this</span>.hideViewLoading();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        UserListPresenter.<span class="keyword">this</span>.hideViewLoading();</div><div class="line">        UserListPresenter.<span class="keyword">this</span>.showErrorMessage(<span class="keyword">new</span> DefaultErrorBundle((Exception) e));</div><div class="line">        UserListPresenter.<span class="keyword">this</span>.showViewRetry();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;User&gt; users)</span> </span>&#123;</div><div class="line">        UserListPresenter.<span class="keyword">this</span>.showUsersCollectionInView(users);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DefaultSubscriber<t>只是简单实现了对错误的处理, 每一个subscriber都是presenter中的一个继承自 <strong><em>DefaultSubscriber<t></t></em></strong> 的内部类.</t></p>
<p>从下面这张图中, 你可以得到一个比较完整的思路.</p>
<p><img src="http://fernandocejas.com/wp-content/uploads/2015/07/clean_architecture_evolution.png" alt="使用RxJava的完整思路"></p>
<p>我们来总结一下RxJava带给我们的好处:</p>
<ul>
<li><p><strong><em>实现了Observables 和 Subscribers的解耦</em></strong>: 保持了结构稳定并简化了测试.</p>
</li>
<li><p><strong><em>使得异步任务变得简单</em></strong>: 多层异步任务被执行时, java的thread和future的操作和同步会变得非常复杂, 使用 scheduler 可以让我们在异步线程和主线程之间跳转变得非常简单(省去了多余的步骤), 特别是我们需要更新UI界面的时候. 同时也避免了使代码变成非常难以理解的”回调地狱”.</p>
</li>
<li><p><strong><em>数据的传递/组合</em></strong>: 我们可以使多个Observables<t>组合起来而不影响到client端, 这样提高了整套解决方案的可扩展性.</t></p>
</li>
<li><p><strong><em>异常处理</em></strong>: 任何一个Observable<t>.出现异常都会通知到consumer.</t></p>
</li>
</ul>
<p>从我的角度看这里有一个小问题, 也是必须要付出的代价, 就是<strong><em>对这一概念不太熟悉的开发者的学习过程</em></strong>. 但是你会从中学到非常有价值的内容.  <strong><em>为了成功学习Reactive吧!</em></strong></p>
<h3 id="依赖注入-Dagger-2"><a href="#依赖注入-Dagger-2" class="headerlink" title="依赖注入: Dagger 2"></a>依赖注入: Dagger 2</h3><p>我这里不会讲太多关于依赖注入的例子, 因为我之前写过<a href="http://fernandocejas.com/2015/04/11/tasting-dagger-2-on-android/" target="_blank" rel="external">一篇专门说依赖注入的文章</a>, 为了跟上我这里的脚步, 强烈推荐大家读一读这篇文章.</p>
<p>值得强调的是, 像Dagger 2一样的依赖注入框架可以带给我们:</p>
<ul>
<li><p><strong><em>组件的重用</em></strong>, 因为依赖可以被从外部配置和注入.</p>
</li>
<li><p>最为合作者对抽象进行依赖注入时, 我们可以单单修改任何对象的实现, 而不用大量修改底层代码, 因为<strong><em>类的实现对象独立而解耦的存在于另一个地方</em></strong>.</p>
</li>
<li><p>依赖可以被注入到组件中去: <strong><em>注入依赖的测试实现是有可能的, 这就使得测试变得更加容易.</em></strong></p>
</li>
</ul>
<h3 id="Lambda-表达式-Retrolambda"><a href="#Lambda-表达式-Retrolambda" class="headerlink" title="Lambda 表达式: Retrolambda"></a>Lambda 表达式: Retrolambda</h3><p><strong><em>没有人会反对在我们的代码中使用Java 8 的 Lambdas</em></strong>, 使用Lambdas可以省去大量的样板代码, 就像下面的代码块:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Action1&lt;UserEntity&gt; saveToCacheAction =</div><div class="line">    userEntity -&gt; &#123;</div><div class="line">         <span class="keyword">if</span> (userEntity != <span class="keyword">null</span>) &#123;</div><div class="line">             CloudUserDataStore.<span class="keyword">this</span>.userCache.put(userEntity);</div><div class="line">         &#125;</div><div class="line">   &#125;;</div></pre></td></tr></table></figure>
<p>但是这个问题我非常纠结. 在我们<a href="https://developers.soundcloud.com/blog/" target="_blank" rel="external">@SoundCloud</a>, 曾经有过一次关于<br> <a href="https://github.com/orfjackal/retrolambda" target="_blank" rel="external">Retrolambda</a>的讨论, <strong><em>主要的分歧是要不要用它</em></strong> 讨论的结果是:</p>
<ol>
<li><p>利:</p>
<ul>
<li>Lambda 和方法的引用</li>
<li>尝试着用资源的方式.</li>
<li>Dev karma</li>
</ul>
</li>
<li><p>弊:</p>
<ul>
<li>java 8新特性的意外使用.</li>
<li>第三方jar包很扰人.</li>
<li>要在Android工程中使用它,必须引入第三方gradle插件.</li>
</ul>
</li>
</ol>
<p>最终我们决定Retrolambda并不是一个能解决我们任何问题的库: <strong><em>使用了Retrolambda后代码的确好看易理解, 但这对我们来说并不是必须的, 因为现在大部分的IDE已经可以是实现这一功能, 至少是以可以接受的方式</em></strong></p>
<p>老实说, 我在这里提到Retrolambda的主要原因是想用一用它, 体验一把在Android代码里使用lambda是什么感觉. 也许<strong><em>在我的业余项目中可能会用到这个库</em></strong>. 我只是把我的想法放在这里, 用不用它的最终决定权在大家手里. <strong><em>当然了, 该<a href="https://github.com/orfjackal" target="_blank" rel="external">作者</a>创造了这么伟大的一个库也非常值得赞扬</em></strong></p>
<h3 id="测试途径"><a href="#测试途径" class="headerlink" title="测试途径"></a>测试途径</h3><p>说到测试, 和之前的例子并没有什么太大的不同.</p>
<ul>
<li><p><strong><em>Presentation层</em></strong> : 用Espresso 2 和 Android Instrumentation 测试UI界面.</p>
</li>
<li><p><strong><em>Domain 层:</em></strong> 因为只是正常的java模块,所以用JUnit + Mockito测试就好了.</p>
</li>
<li><p><strong><em>Data层</em></strong>: 用 Robolectric 3 + JUnit + Mockito做迁移测试. 因为以前(案例第一个版本的时候)<strong><em>没有内置单元测试支持,手动构造一个类似robolectric的框架非常复杂而且为了使它正常工作,还要一系列hack操作.</em></strong></p>
</li>
</ul>
<p>庆幸的是那都过去了, 现在所有的东西都可以直接用, 所以我重新把它们放在了数据模块中, 特别是可以放在默认的测试文件夹 <strong><em>src/test/java</em></strong> 下.</p>
<h3 id="包结构组织"><a href="#包结构组织" class="headerlink" title="包结构组织"></a>包结构组织</h3><p>我认为代码/包的组织是一个良好架构的关键要素之一: <strong><em>包结构是一个程序员看项目代码时最先注意到的</em></strong> 其他的一切要素都由它而来,也都取决于它.</p>
<p>下面是组织包结构常见的两种方式:</p>
<ul>
<li><p><strong><em>根据层级关系的不同</em></strong>: 单独看每个包下面的代码通常情况下并没有什么联系, 这就降低了单个包里的内聚性和模块性,而提高了包与包之间的耦合程度. 修改一个功能需要同时修改多个包下的多个文件.而且, 要删除一个功能也变得不是那么简单.</p>
</li>
<li><p><strong><em>根据功能的不同</em></strong>: 根据不同的包名可以找到对应的功能, 将功能(而且是只有此功能)下的所有组件全都放在了一起. 这就提高了包里的内举性和模块性,而降低了包与包之间的耦合程度. 将协同工作的代码放在了一起,而不是将它们分布在程序的各个地方.</p>
</li>
</ul>
<p><strong><em>我的建议是根据功能的不同来组织包结构</em></strong>, 可以带来下面这些好处:</p>
<ul>
<li><p><strong><em>更完善的模块化</em></strong></p>
</li>
<li><p><strong><em>代码更加容易查阅</em></strong></p>
</li>
<li><p><strong><em>最小化代码的作用域</em></strong></p>
</li>
</ul>
<p>有趣的是, 如果你在一个所谓的 <strong><em>功能性团队</em></strong> 工作,(比如<a href="https://twitter.com/soundcloud" target="_blank" rel="external">@SoundCloud</a>), <strong><em>代码结构的分配会变得更加容易更加模块化</em></strong>, 如果许多工程师在同样的基础代码上开发时这个优点就变得格外明显.</p>
<p><img src="http://fernandocejas.com/wp-content/uploads/2015/07/package_organization-795x1024.png" alt="包结构组织样图"></p>
<p>大家可以看出, 我的包结构看起来像是根据层级关系组织的: <strong><em>这里可能有举例不太恰当的地方(比如将一切都放在’user’下面)</em></strong> 但是我会<strong><em>原谅自己这一次</em></strong>, 因为举这个例子是为了供大家学习,为了表达我的观点,主要目的是包含简洁的架构思路. <strong><em>照我说的做, 而不是照我做的做</em></strong> :)</p>
<h3 id="附加彩蛋-组织你的打包逻辑"><a href="#附加彩蛋-组织你的打包逻辑" class="headerlink" title="附加彩蛋: 组织你的打包逻辑"></a>附加彩蛋: 组织你的打包逻辑</h3><p><strong><em>我们都知道房子都是从地基开始修筑的</em></strong>. 软件开发也是一个道理, 我这里要强调的是,  <strong><em>代码架构中, 打包系统(及其组织架构)是非常重要的一部分</em></strong></p>
<p>在Android开发中, 我们使用一个叫做gradle的非常强大的打包系统.  这里有 <strong><em>一系列窍门</em></strong> 帮助大家在组织打包脚本时变得格外轻松:</p>
<ul>
<li>根据功能的不同, 将打包系统分成多个脚本文件.</li>
</ul>
<p><img src="http://fernandocejas.com/wp-content/uploads/2015/07/gradle_organization-283x300.png" alt="脚本结构截图"></p>
<p>ci.gradle:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">def ciServer = &apos;TRAVIS&apos;</div><div class="line">def executingOnCI = &quot;true&quot;.equals(System.getenv(ciServer))</div><div class="line"></div><div class="line">// Since for CI we always do full clean builds, we don&apos;t want to pre-dex</div><div class="line">// See http://tools.android.com/tech-docs/new-build-system/tips</div><div class="line">subprojects &#123;</div><div class="line">  project.plugins.whenPluginAdded &#123; plugin -&gt;</div><div class="line">    if (&apos;com.android.build.gradle.AppPlugin&apos;.equals(plugin.class.name) ||</div><div class="line">        &apos;com.android.build.gradle.LibraryPlugin&apos;.equals(plugin.class.name)) &#123;</div><div class="line">      project.android.dexOptions.preDexLibraries = !executingOnCI</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>build.gradle:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">apply from: &apos;buildsystem/ci.gradle&apos;</div><div class="line">apply from: &apos;buildsystem/dependencies.gradle&apos;</div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">  repositories &#123;</div><div class="line">    jcenter()</div><div class="line">  &#125;</div><div class="line">  dependencies &#123;</div><div class="line">    classpath &apos;com.android.tools.build:gradle:1.2.3&apos;</div><div class="line">    classpath &apos;com.neenbedankt.gradle.plugins:android-apt:1.4&apos;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">  ext &#123;</div><div class="line">	...</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>如上图, 你可以利用 “<strong><em>apply from: ‘buildsystem/ci.gradle’</em></strong>“ 将配置文件导入任意build脚本中. <strong><em>不要将所有打包脚本写在一个build.gradle文件中, 否则你会慢慢制造出一个怪物. 我已经受过教训了</em></strong>.</p>
<ul>
<li>将依赖整合到map中</li>
</ul>
<p>dependencies.gradle:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"></div><div class="line">ext &#123;</div><div class="line">  //Libraries</div><div class="line">  daggerVersion = &apos;2.0&apos;</div><div class="line">  butterKnifeVersion = &apos;7.0.1&apos;</div><div class="line">  recyclerViewVersion = &apos;21.0.3&apos;</div><div class="line">  rxJavaVersion = &apos;1.0.12&apos;</div><div class="line"></div><div class="line">  //Testing</div><div class="line">  robolectricVersion = &apos;3.0&apos;</div><div class="line">  jUnitVersion = &apos;4.12&apos;</div><div class="line">  assertJVersion = &apos;1.7.1&apos;</div><div class="line">  mockitoVersion = &apos;1.9.5&apos;</div><div class="line">  dexmakerVersion = &apos;1.0&apos;</div><div class="line">  espressoVersion = &apos;2.0&apos;</div><div class="line">  testingSupportLibVersion = &apos;0.1&apos;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  domainDependencies = [</div><div class="line">      daggerCompiler:     &quot;com.google.dagger:dagger-compiler:$&#123;daggerVersion&#125;&quot;,</div><div class="line">      dagger:             &quot;com.google.dagger:dagger:$&#123;daggerVersion&#125;&quot;,</div><div class="line">      javaxAnnotation:    &quot;org.glassfish:javax.annotation:$&#123;javaxAnnotationVersion&#125;&quot;,</div><div class="line">      rxJava:             &quot;io.reactivex:rxjava:$&#123;rxJavaVersion&#125;&quot;,</div><div class="line">  ]</div><div class="line"></div><div class="line">  domainTestDependencies = [</div><div class="line">      junit:              &quot;junit:junit:$&#123;jUnitVersion&#125;&quot;,</div><div class="line">      mockito:            &quot;org.mockito:mockito-core:$&#123;mockitoVersion&#125;&quot;,</div><div class="line">  ]</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  dataTestDependencies = [</div><div class="line">      junit:              &quot;junit:junit:$&#123;jUnitVersion&#125;&quot;,</div><div class="line">      assertj:            &quot;org.assertj:assertj-core:$&#123;assertJVersion&#125;&quot;,</div><div class="line">      mockito:            &quot;org.mockito:mockito-core:$&#123;mockitoVersion&#125;&quot;,</div><div class="line">      robolectric:        &quot;org.robolectric:robolectric:$&#123;robolectricVersion&#125;&quot;,</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>build.gradle:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;java&apos;</div><div class="line"></div><div class="line">sourceCompatibility = 1.7</div><div class="line">targetCompatibility = 1.7</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">  def domainDependencies = rootProject.ext.domainDependencies</div><div class="line">  def domainTestDependencies = rootProject.ext.domainTestDependencies</div><div class="line"></div><div class="line">  provided domainDependencies.daggerCompiler</div><div class="line">  provided domainDependencies.javaxAnnotation</div><div class="line"></div><div class="line">  compile domainDependencies.dagger</div><div class="line">  compile domainDependencies.rxJava</div><div class="line"></div><div class="line">  testCompile domainTestDependencies.junit</div><div class="line">  testCompile domainTestDependencies.mockito</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><em>如果你希望在不同的模块中重复利用相同的依赖的版本,上面的建议就会变得非常有用</em></strong>  或者你想将不同的依赖版本放到不同的模块中去也是一样的. 另一个好处是 <strong><em>可以在一个地方控制所有的依赖</em></strong></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这差不多就是我要说的了, 大家要记住 <strong><em>并没有包治百病的药, 但是一个好的程序架构可以帮助我们保持代码的整洁和健康, 同时也保证整了灵活性和可维护性</em></strong></p>
<p>下面是一些我想指出的当你遇到程序问题时应有的态度:</p>
<ul>
<li><p><strong><em>遵守 SOLID 原则</em></strong></p>
</li>
<li><p><strong><em>不要想的太多(不要过度开发)</em></strong></p>
</li>
<li><p><strong><em>要实际</em></strong></p>
</li>
<li><p><strong><em>最大限度的在工程中减少对 android 框架的依赖</em></strong></p>
</li>
</ul>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><ol>
<li><p><a href="https://github.com/android10/Android-CleanArchitecture" target="_blank" rel="external">Clean architecture github repository – master branch</a></p>
</li>
<li><p><a href="https://github.com/android10/Android-CleanArchitecture/releases" target="_blank" rel="external">Clean architecture github repository – releases</a></p>
</li>
</ol>
<h3 id="更多阅读"><a href="#更多阅读" class="headerlink" title="更多阅读:"></a>更多阅读:</h3><ol>
<li><a href="http://fernandocejas.com/2014/09/03/architecting-android-the-clean-way/" target="_blank" rel="external">Architecting Android..the clean way</a></li>
<li><a href="http://fernandocejas.com/2015/04/11/tasting-dagger-2-on-android/" target="_blank" rel="external">Tasting Dagger 2 on Android</a></li>
<li><a href="https://speakerdeck.com/android10/the-mayans-lost-guide-to-rxjava-on-android" target="_blank" rel="external">The Mayans Lost Guide to RxJava on Android</a></li>
<li><a href="https://speakerdeck.com/android10/it-is-about-philosophy-culture-of-a-good-programmer" target="_blank" rel="external">It is about philosophy: Culture of a good programmer</a></li>
</ol>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><ol>
<li><a href="https://github.com/ReactiveX/RxJava/wiki" target="_blank" rel="external">RxJava wiki by Netflix</a></li>
<li><a href="https://blog.8thlight.com/uncle-bob/2014/05/11/FrameworkBound.html" target="_blank" rel="external">Framework bound by Uncle Bob</a></li>
<li><a href="https://docs.gradle.org/current/userguide/userguide.html" target="_blank" rel="external">Gradle user guide</a></li>
<li><a href="http://www.javapractices.com/topic/TopicAction.do?Id=205" target="_blank" rel="external">Package by feature, not layer</a></li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android架构演化之路/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android架构演化之路/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android自动截屏工具/" title="Android 自动截屏工具" itemprop="url">Android 自动截屏工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/@swanhtet1992/automating-android-screenshots-5b7574c0621d" target="_blank" rel="external">Automating Android Screenshots</a></li>
</ul>
<p>随着mac版本AndroidTool的发布，获取android应用截屏变得非常简单。与此同时，感谢开发商！这对于我们开发者来说真是太好了！</p>
<p>对于简单应用来说，AndroidTool是足够满足截屏的功能需求了，然而，我需要在在我正在开发的一款app上完成一个完全自动化的截图过程，并且将截图发布到应用市场。我认为这将不简单，所以，我尽量避免复杂的实现过程，而是想办法如何更好的结合AndroidTool来完成这个功能。</p>
<p>然而当我昨天阅读了<a href="https://medium.com/@enriquelopezmanas" target="_blank" rel="external">Enrique López Mañas yesterday</a>的<a href="https://medium.com/google-developer-experts/automating-android-development-6daca3a98396" target="_blank" rel="external">Automating Android development</a>文章，我意识到，他在博客中讨论的话题我已经完成了4/5。唯一我还没有做的就是测试。我不喜欢测试，然而，那篇文章激励着我去尝试写测试代码。。 所以，我今天早上尝试了一下。经过几个小时编写测试代码，我意外的找到了自动化截图的解决方案。</p>
<p>在这片文章中，我将会谈论关于如何通过ui 测试来完成自动截图和提交这些截图到应用商店。</p>
<p>##UI Automator查看器</p>
<p>‘uiautomatorviewer’是一个非常强大的工具来查看views，当发现极好的布局时，我通常会使用‘uiautomatorviewer’来查看，如果你运行这个工具将会获得下图所示。</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/2000/1*2GVDSxydFfqY4WvXBBVQ1Q.png" alt=""></p>
<p>通过这个工具你可以看到UI对象，在这里，我可以检测TextView的id，这个技巧在稍后会变得非常有用。。</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/2000/1*9yNBO3PwetoOv7EWEChsag.png" alt=""></p>
<p>##UI Automator</p>
<p>Google在<a href="https://developer.android.com/tools/testing-support-library/index.html" target="_blank" rel="external">Android Testing Support Library</a>里面同时也提供了一个叫做‘UI Automator’ 的库，它允许开发者自动化获取用户交互过程。</p>
<p>使用UI Automator时，你需要在你的项目中添加依赖，具体配置信息需要填写在<code>build.gradle</code>里面。</p>
<p>正如<a href="https://developer.android.com/training/testing/ui-testing/uiautomator-testing.html#run" target="_blank" rel="external">文档</a>中所说。你需要指定<a href="https://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner.html" target="_blank" rel="external">AndroidJUnitRunner</a>作为你默认的测试工具。</p>
<p>UI Automator 里面频繁使用的类有：UiDevice, UiSelector, UiObject, and UiScrollable.</p>
<p>我们将会在androidTestScreenshot文件夹下创建一个简单的测试类，并且这个类继承InstrumentationTestCase。</p>
<p>这个过程很直接：</p>
<p>首先，监听设备点击“Home”键时，执行UiDevice 的方法pressHome()。在每一个测试里面，我们做这样重复性的工作：</p>
<p>从最开始的地方打开app。我个人发现一个简答的方法去获取截屏。你可以使用UiDevice的pressBack()方法为其他测试。</p>
<p>获取想要的UI交互可以使用UiSelector, UiScrollable, and UiObject。</p>
<p>使用SystemClock.sleep方法，为异步任务的执行腾出一些时间（异步任务的执行可能在截屏之后），以此来避免发生截屏获取的为空异常和UiObject not found异常。</p>
<p>最后我们截屏并且将获取的截屏保存在指定的位置。</p>
<p>到目前为止，你可能已经了解了如何使用uiautomatorviewer来帮助我们获取许多我们想要的UI元素，然而，我使用UiSelector().resourceId，因为我们可以通过我们在layout里面使用的id来完成截屏，这样不是更加简单了吗？你也可以有其他选择，比如使用 className, text, etc… 来完成这一过程。</p>
<p>##Product Flavor</p>
<p>我不知道为什么UiAutomator下的minSdkVersion是18，因为我需要minSdk至少是14，我需要使用这个额外的方法。如果这里有任何其他方法可以避免我自己去实现截屏的，请让我知道。</p>
<p>Android使用androidTest来实现主要的测试工作，也为了实现不同产品的写测试需要，我们需要写我们的测试在androidTestFlavorName文件夹。这就是为什么我们在androidTestScreenshot路径下创建SimpleUiTest 类的原因。</p>
<p>万事具备，现在，运行<code>gradle connectedAndroidTestScreenshotDebug</code>。在这个测试完成后你将会获得屏幕截图。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android自动截屏工具/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android自动截屏工具/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android进行单元测试难在哪-part1/" title="Android 进行单元测试难在哪-part1" itemprop="url">Android 进行单元测试难在哪-part1</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://philosophicalhacker.com/2015/04/17/why-android-unit-testing-is-so-hard-pt-1/" target="_blank" rel="external">WHY ANDROID UNIT TESTING IS SO HARD (PT 1)</a></li>
</ul>
<p>正如我在<a href="issue-8/Android 进行单元测试难在哪-序.md">序</a>中所说，在 Android 中难于进行测试是众多 Android 开发者的共识。上一篇博文发出后，有许多同行回复了我，并对我的观点表示支持：</p>
<blockquote>
<p>— Andy Dyer (@dammitandy) April 13, 2015</p>
<p>@philosohacker大大发话了！他写了一篇有关如何能更好地测试 Android 应用的博文，<a href="http://t.co/gQCJKIOrSN" target="_blank" rel="external">地址戳我</a><br>— Andy Dyer (@dammitandy) April 13, 2015</p>
<p>卧槽，我终于知道在 Android 上测试应用的正确姿势了！感谢：<a href="http://t.co/8gIqfoFVnL" target="_blank" rel="external">地址戳我</a></p>
<p>非常赞同“Android SDK 排斥 Android 测试单元”的看法。你应该让你的代码和 SDK 的的联系尽可能地小。</p>
<p>— Pascal Hartig (@passy) April 12, 2015</p>
</blockquote>
<p>所以在 Android 中进行单元测试困难的问题，我提到的这些已经说得足够清楚了。但事实上，问题的根源比这更显而易见。难于进行单元测试的一部分原因是：为了启动 Roboletric 使你的测试单元能够以一种合理的速度运作，你往往需要做许多繁复且没有意义的事。不过在我看来，这并不是关键因素，关键在于：Google 设计的 Android SDK 和 Google 官方提倡的应用架构模式让测试变得困难，在某些情况下，进行测试甚至是不可能的。</p>
<p>这样说可能让人感觉是泛泛而谈，为了证明我的结论，我今天将会用一整个系列的博文来论证我的观点。在接下来的博文里，我会尽可能解释为什么官方鼓励的应用开发方式会使进行单元测试困难，甚至不可能。除此以外，我还会在这些博文里通过重构应用架构探索增强 Android 可测试性的办法，使得应用的代码不需要直接依赖于 Android SDK。通过介绍 Android 怎么让测试变得困难，我会延伸出我想到的重构应用的几个建议，我会在系列博文的第四篇里把它们列出来。</p>
<h2 id="一个（看似）简单的测试示例"><a href="#一个（看似）简单的测试示例" class="headerlink" title="一个（看似）简单的测试示例"></a>一个（看似）简单的测试示例</h2><p>要分析这个问题，我们不妨先从一个简单的测试范例开始研究。示例里面用的是 Google IOsched 应用的源码，因为我在第一篇博文里就说道：IOsched 就是 Android 开发者的参考模板。</p>
<p>IOsched 应用里有一个有关 IO 大会细节的页面：</p>
<p><img src="https://philosophicalhacker.files.wordpress.com/2015/04/screenshot-0646am-apr-17-2015.png?w=169&amp;h=300" alt=""></p>
<p>页面里有一个“+”按钮，我们能通过这个按钮将 IO 大会添加日历的对应日期里，如果 IO 大会已经被添加到日历中，“+”按钮则会变成“check”按钮；如果用户再次点击“check”按钮，IO 大会则会从日历中被移除。打开相应的源码我们会发现：这个按钮的状态储存在一个叫作 mStarred 的实例变量里，Activity 会根据按钮的状态启动一个 Service，Service 将在它的 onStop() 方法中将对应的 IO 大会添加到用户的日历中/将对应的 IO 大会从用户的日历中移除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onStop();</div><div class="line">    <span class="keyword">if</span> (mInitStarred != mStarred) &#123;</div><div class="line">        <span class="keyword">if</span> (UIUtils.getCurrentTime(<span class="keyword">this</span>) &lt; mSessionStart) &#123;</div><div class="line">            <span class="comment">// Update Calendar event through the Calendar API on Android 4.0 or new versions.</span></div><div class="line">            Intent intent = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line">                <span class="comment">// Set up intent to add session to Calendar, if it doesn't exist already.</span></div><div class="line">                intent = <span class="keyword">new</span> Intent(SessionCalendarService.ACTION_ADD_SESSION_CALENDAR,</div><div class="line">                        mSessionUri);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_START,</div><div class="line">                        mSessionStart);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_END,</div><div class="line">                        mSessionEnd);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_ROOM, mRoomName);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_TITLE, mTitleString);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Set up intent to remove session from Calendar, if exists.</span></div><div class="line">                intent = <span class="keyword">new</span> Intent(SessionCalendarService.ACTION_REMOVE_SESSION_CALENDAR,</div><div class="line">                        mSessionUri);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_START,</div><div class="line">                        mSessionStart);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_END,</div><div class="line">                        mSessionEnd);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_TITLE, mTitleString);</div><div class="line">            &#125;</div><div class="line">            intent.setClass(<span class="keyword">this</span>, SessionCalendarService.class);</div><div class="line">            startService(intent);</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line">                setupNotification();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这样的代码里写一个测试单元看起来是个明智的选择，但问题就来了：你无法为这样的代码写一个测试单元。你可能就不懂了，为什么不能写啊？别急，为了找到问题所在，我们不妨回到 Android 系统里，并想一想通常情况下，是什么让代码可以被测试。</p>
<p>我们都知道，一个测试单元包含了三个步骤：准备，测试，断言。为了顺利地展示我们测试中的断言步骤，我们需要获得程序在执行测试步骤中的代码后的状态。我们不妨将这个状态称为“测试后状态”。对一个测试单元来说，只有三种办法能获得测试后状态。</p>
<p>第一种办法就是检查测试步骤中执行的方法的返回值，写下这样的测试代码倒不难：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSquare</span><span class="params">()</span> </span>&#123;</div><div class="line">    </div><div class="line">    MathNerd mathNerd = <span class="keyword">new</span> MathNerd();</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> result = mathNerd.square(<span class="number">2</span>);</div><div class="line">    </div><div class="line">    assertEquals(result, <span class="number">4</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第二种办法就是获得被测试对象中那些可访问的属性的引用，并断言你取得的这些属性就是你想要的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSquare</span><span class="params">()</span> </span>&#123;</div><div class="line">    </div><div class="line">    MathNerd mathNerd = <span class="keyword">new</span> MathNerd();</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> result = mathNerd.square(<span class="number">2</span>);</div><div class="line">    </div><div class="line">    assertTrue(mathNerd.didDoMath());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第三种办法是检查对象中被注入的依赖的状态。这些依赖或许是不可访问的，但因为你在测试函数中对它们进行注入，那么你肯定会持有它们的引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSquare</span><span class="params">()</span> </span>&#123;</div><div class="line">    </div><div class="line">    Calculator calculator = <span class="keyword">new</span> Calculator();</div><div class="line">    </div><div class="line">    TerribleMathStudent terribleMathStudent = <span class="keyword">new</span> TerribleMathStudent(calculator);</div><div class="line">    </div><div class="line">    <span class="comment">//terribleMathStudent uses calculator to do this</span></div><div class="line">    <span class="keyword">int</span> result = terribleMathStudent.square(<span class="number">2</span>);</div><div class="line">    The IOsched app has a IO session detail screen that looks like <span class="keyword">this</span>:</div><div class="line">    assertTrue(calculator.didDoMath());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么我们现在已经把能够在一个测试单元中完成断言步骤的方法都列出来了，接下来就该解释为什么刚刚的 Android 代码无法被测试了：答案很简单，我们根本没有办法在 onStop() 方法里完成测试单元的断言步骤——因为 onStop() 方法根本就没有返回值。SessionDetailActivity 里也不存在能帮助我们验证 SessionCalendarService 是否通过正确的命令启动的可访问属性。最后，启动 SessionCalendarService 的代码也不属于注入到 SessionDetailActivity 中的依赖。</p>
<p>你以为这样就完了吗？很不幸，还有比这更糟糕的。在 onStop() 里完成测试单元的准备步骤也是不可能的。为了在测试单元中完成准备步骤，你必须能够改变影响程序测试后状态的所有因素，不妨把它们叫作“预测试状态”。而我们没有任何办法能够在 onStop() 方法里改变预测试状态，所以我们不能对应用进行单元测试。</p>
<p>onStop() 方法里，预测试状态是一个叫作 mInitStarred 的布尔值，你看看写在 onStop() 里的代码估计就懂我的意思了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onStop();</div><div class="line">    <span class="keyword">if</span> (mInitStarred != mStarred) &#123;</div><div class="line">        <span class="keyword">if</span> (UIUtils.getCurrentTime(<span class="keyword">this</span>) &lt; mSessionStart) &#123;</div><div class="line">            <span class="comment">// Update Calendar event through the Calendar API on Android 4.0 or new versions.</span></div><div class="line">            Intent intent = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line">                <span class="comment">// Set up intent to add session to Calendar, if it doesn't exist already.</span></div><div class="line">                intent = <span class="keyword">new</span> Intent(SessionCalendarService.ACTION_ADD_SESSION_CALENDAR,</div><div class="line">                        mSessionUri);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_START,</div><div class="line">                        mSessionStart);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_END,</div><div class="line">                        mSessionEnd);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_ROOM, mRoomName);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_TITLE, mTitleString);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Set up intent to remove session from Calendar, if exists.</span></div><div class="line">                intent = <span class="keyword">new</span> Intent(SessionCalendarService.ACTION_REMOVE_SESSION_CALENDAR,</div><div class="line">                        mSessionUri);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_START,</div><div class="line">                        mSessionStart);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_END,</div><div class="line">                        mSessionEnd);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_TITLE, mTitleString);</div><div class="line">            &#125;</div><div class="line">            intent.setClass(<span class="keyword">this</span>, SessionCalendarService.class);</div><div class="line">            startService(intent);</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line">                setupNotification();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个布尔值会在 ContentProvider 的查询操作完成后通过回调方法被设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSessionQueryComplete</span><span class="params">(Cursor cursor)</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> inMySchedule = cursor.getInt(SessionsQuery.IN_MY_SCHEDULE) != <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!mIsKeynote) &#123;</div><div class="line">        showStarredDeferred(mInitStarred = inMySchedule, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>让 mInitStarred 在 Loader 回调方法里被初始化的原因是：如果用户向他们的日历添加了在 SessionDetailActivity 中选择的 IO 大会事件，那么用于标识该 IO 大会是否被添加到用户日历中的变量将会被存储到数据库中包含所有 IO 大会的表中。我们都知道，Google 希望我们使用 Loader 去获得数据库中的数据，所以 mInitStarred 在 Loader 回调方法里被初始化。</p>
<blockquote>
<p>注：但是 Google 自己用 Loader 取数据都非常困难，详见视频：<a href="https://www.youtube.com/watch?v=qrPoIF6A9gM" target="_blank" rel="external">Click me!</a></p>
</blockquote>
<p>mInitStarred 用于判断应用是否必须启动 SessinCalendarService 更新用户的日历，添加/移除某个 IO 大会的信息。如果从数据库中查询获得的信息表示用户的日历已经添加了该大会，而且添加按钮已经转换为“check”，我们就不需要进行任何操作。</p>
<p>所以，如果我们要在 onStop() 方法里进行测试，我们想要确定 onStop() 方法是否真正启动了一个根据“+”按钮的状态去更新用户日历的 Service。但很不幸，mInitStarred 是一个在 Loader 回调中被初始化的私有实例变量，如果要在测试单元里改变它的值，一定会非常麻烦。那我们现在不妨再来想想改变测试单元预测试状态的办法。</p>
<p>第一个办法是，改变影响对象预测试状态的公有属性：</p>
<blockquote>
<p>注：改变测试状态的公有属性显然有很多办法。但如果，我举个例子，预测试状态由被测试对象的依赖决定，那我们当然也可以通过改变对象依赖的公有属性改变被测试对象的预测试状态。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSquare</span><span class="params">()</span> </span>&#123;</div><div class="line">    </div><div class="line">    TerribleMathStudent terribleMathStudent = <span class="keyword">new</span> TerribleMathStudent();</div><div class="line">    terribleMathStudent.setCalculator(<span class="keyword">new</span> BrokenCalculator());</div><div class="line">    </div><div class="line">    <span class="comment">//terribleMathStudent uses broken calculator to do this, so this student really sucks</span></div><div class="line">    <span class="keyword">int</span> result = terribleMathStudent.square(<span class="number">2</span>);</div><div class="line">    </div><div class="line">    assertNotEquals(result, <span class="number">4</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//we pity the terrible math student, so we give him a working calculator</span></div><div class="line">    terribleMathStudent.setCalculator(<span class="keyword">new</span> Calculator());</div><div class="line">    </div><div class="line">    result = terribleMathStudent.square(<span class="number">2</span>);</div><div class="line">    </div><div class="line">    assertEquals(result, <span class="number">4</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第二个办法是改变传入被测试方法的参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSquare</span><span class="params">()</span> </span>&#123;</div><div class="line">    </div><div class="line">    MathNerd mathNerd = <span class="keyword">new</span> MathNerd();</div><div class="line">    </div><div class="line">    <span class="comment">//Math nerds only use calculators when they need them</span></div><div class="line">    <span class="keyword">int</span> result = mathNerd.squareBigNumber(<span class="keyword">new</span> BrokenCalculator(), <span class="number">54321</span>);</div><div class="line">    </div><div class="line">    assertNotEquals(result, <span class="number">2950771041</span>);</div><div class="line">    </div><div class="line">    result = mathNerd.squareBigNumber(<span class="keyword">new</span> Calculator(), <span class="number">54321</span>);</div><div class="line">    </div><div class="line">    assertEquals(result, <span class="number">2950771041</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就像改变测试后状态一样，这两个办法都不能解决我们的问题，所以我们根本不可能在 onStop() 方法里面完成测试单元的准备步骤，问题的根源在于：SessionDetailActivity 里根本不存在能用于改变 mInitStarred 的公有属性。除此以外，onStop() 方法也不会把 mInitStarred 当作一个参数，所以我们无法通过改变 onStop() 的参数值来改变预测试状态。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>经过上面一系列源码的分析，每一个希冀进行单元测试的开发者都站在了悬崖的边缘上：即便是 Google 官方所谓的开发模板应用 - IOsched 中一个看起来非常简单的模块，要进行单元测试都困难重重。如果你曾经为了在 Activity 里为你的业务逻辑添加相应的测试单元绞尽脑汁，我现在可以告诉你为什么会这么蛋疼：大部分情况下，要在 Activity 里添加相应的测试单元只是不能实现而已。某些情况下，因为你没有办法改变被测试对象的预测试状态，使得你无法完成单元测试的准备步骤。在另一些情况下，因为你无法访问相关的测试后状态，使得你无法完成对象的断言步骤。而 SessionDetailActivity 的 onStop() 方法就是完美的示例，因为上面的两种情况在它身上体现地淋漓尽致。</p>
<p>Android 里还有许多类似的代码也是无法测试的，这让我不禁怀疑：让我们写下无法测试的代码的罪魁祸首，会不会就是带有 Android 平台特性的应用架构方式。所以在下一篇博文里，我将会深入探索这个假设。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android进行单元测试难在哪-part1/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android进行单元测试难在哪-part1/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android进行单元测试难在哪-part4/" title="Android 进行单元测试难在哪-part4" itemprop="url">Android 进行单元测试难在哪-part4</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://philosophicalhacker.com/2015/05/08/how-to-make-our-android-apps-unit-testable-pt-2/" target="_blank" rel="external">HOW TO MAKE OUR ANDROID APPS UNIT TESTABLE (PT. 2)</a></li>
<li>原文作者 : <a href="http://philosophicalhacker.com/" target="_blank" rel="external">Matthew Dupree</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a> </li>
<li>校对者: <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a>  </li>
<li>状态 :  完成</li>
</ul>
<p>在<strong><a href="https://github.com/bboyfeiyu/android-tech-frontier/blob/master/issue-11/Android%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%9A%BE%E5%9C%A8%E5%93%AA-part3.md" target="_blank" rel="external">上一篇博文</a></strong>中，我给大家介绍了新的应用架构方式 - Square 大法，就像我之前说的，Square 大法是 Square 用于使 Fragment 内的业务逻辑能够进行单元测试的通用方法，我还给大家展示了如何使用 Square 大法重构 Google 的 IOSched 应用的 SessionCalendarService 类，使得对 SessionCalendarService 类内的业务逻辑进行单元测试由几乎不可能变为可行。而在今天的这篇博文中，我会和大家一起继续探索 Square 大法，让我们对应用的 UI 组件进行单元测试成为可能，也让测试变得容易。</p>
<h2 id="这篇博文有“依赖”"><a href="#这篇博文有“依赖”" class="headerlink" title="这篇博文有“依赖”"></a>这篇博文有“依赖”</h2><p>将 Sqaure 大法应用到 App 的 UI 组件中（例如 Activity 和 Fragment） 比起将它应用到无 UI 的应用中要复杂一些，造成这种情况的根源正好与我们重构代码的核心方法相关联，解决了这些额外的复杂性问题，我们也就能够改变对 UI 组件进行单元测试时需要使用的预测试状态，以及修改测试后状态。如果你听到“预测试状态”和“测试后状态”后感觉一头雾水，或者觉得有一点点印象却不记得具体是什么意思的话，最好复习复习我之前写的<code>[Android 进行单元测试难在哪-part1](https://github.com/bboyfeiyu/android-tech-frontier/blob/master/issue-9/Android%20%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%9A%BE%E5%9C%A8%E5%93%AA-part1.md)</code>。如果你清楚地理解这两个概念的话，确保你知道 SessionDetailActivity 干了啥。为了学习该如何将 Square 大法应用到应用的 UI 组件类中，我们将重构 SessionDetailActivity 类的代码，使我们能够对类中的 onStop() 方法中的业务逻辑进行单元测试。</p>
<p>开始之前我在唠叨几句吧，如果你有了解过 MVP 模式的话对你理解用 Square 大法重构应用 UI 组件大有裨益，不过呢，由于 Square 已经写了一篇非常精彩的<a href="https://corner.squareup.com/2014/10/advocating-against-android-fragments.html" target="_blank" rel="external">博文</a>介绍 MVP 模式了，我就不再给大家介绍啦，有兴趣的话看 Square 写的博文就好了。如果你在学习 MVP 模式的时候觉得很难理解与 View 相关的操作，不妨看看我之前写的一篇<a href="http://philosophicalhacker.com/2015/04/05/dont-call-it-mvp/" target="_blank" rel="external">博文</a>，这篇博文能帮你区分进行 Android 开发时我们使用的 View 和 MVP 模式中的“View”。除此以外，我在这篇博文中将 Presenter 用于更新应用界面显示的对象称为 “ViewTranslator” 而不是 “View”。</p>
<h2 id="用-Square-大法重构应用-UI-组件类"><a href="#用-Square-大法重构应用-UI-组件类" class="headerlink" title="用 Square 大法重构应用 UI 组件类"></a>用 Square 大法重构应用 UI 组件类</h2><p>虽然用 Square 大法重构应用的 UI 组件可能会更复杂些，但我们的重构策略始终没有发生变化：抽取出应用组件类中的业务逻辑（例如 Activity，Fragment，Service），并将业务逻辑放到我之前说的被进行了依赖注入的“业务对象”中，也就是与 Android 无关接口的 Android 特定实现。</p>
<p>下面是重构后的 onStop() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onStop();</div><div class="line">    <span class="keyword">if</span> (mInitStarred != mStarred) &#123;</div><div class="line">        <span class="keyword">if</span> (UIUtils.getCurrentTime(<span class="keyword">this</span>) &lt; mSessionStart) &#123;</div><div class="line">            <span class="comment">// Update Calendar event through the Calendar API on Android 4.0 or new versions.</span></div><div class="line">            Intent intent = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line">                <span class="comment">// Set up intent to add session to Calendar, if it doesn't exist already.</span></div><div class="line">                intent = <span class="keyword">new</span> Intent(SessionCalendarService.ACTION_ADD_SESSION_CALENDAR,</div><div class="line">                        mSessionUri);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_START,</div><div class="line">                        mSessionStart);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_END,</div><div class="line">                        mSessionEnd);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_ROOM, mRoomName);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_TITLE, mTitleString);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Set up intent to remove session from Calendar, if exists.</span></div><div class="line">                intent = <span class="keyword">new</span> Intent(SessionCalendarService.ACTION_REMOVE_SESSION_CALENDAR,</div><div class="line">                        mSessionUri);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_START,</div><div class="line">                        mSessionStart);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_END,</div><div class="line">                        mSessionEnd);</div><div class="line">                intent.putExtra(SessionCalendarService.EXTRA_SESSION_TITLE, mTitleString);</div><div class="line">            &#125;</div><div class="line">            intent.setClass(<span class="keyword">this</span>, SessionCalendarService.class);</div><div class="line">            startService(intent);</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line">                setupNotification();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正如我之前提到的，这段代码存在一个问题：代码并没有通过被注入到 SessionDetailActivity 的依赖中的方法启动 SessionCalendarService。那我们现在就用 Square 大法来解决这个问题。首先，我们将业务逻辑抽取出来，并放入业务对象中，Square 的工程师们为这个在 Activity（或 Fragment，或其他……）中使用的业务对象起了一个名字 —— “Presenter”。</p>
<p>Presenter 负责用 Model 中的数据更新 View，为了使单元测试在 Presenter 中是可行的，这就意味着 Model 和 View 都必须是注入到 Presenter 中的依赖。也正是这三个对象的组合使用构成了我们所说的 MVP 架构模式。</p>
<p>下面就是 SessionDetailPresenter 中与 onStop() 方法等价的实现啦：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionDetailViewPresenter</span> <span class="keyword">implements</span> <span class="title">RepositoryManagerCallbacks</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SessionDetailViewPresenter</span><span class="params">(SessionDetailView sessionDetailView,</span></span></div><div class="line">                                      RepositoryManager loaderManager,</div><div class="line">                                      ServiceStarter serviceStarter,</div><div class="line">                                      <span class="keyword">long</span> calendarId</div><div class="line">                                      ) &#123;</div><div class="line"> </div><div class="line">        mSessionDetailView = sessionDetailView;</div><div class="line">        mLoaderManager = loaderManager;</div><div class="line">        mServiceStarter = serviceStarter;</div><div class="line">        mCalendarId = calendarId;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewTranslatorStopped</span><span class="params">()</span> </span>&#123;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (mInitStarred != mStarred) &#123;</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &lt; mSessionStart) &#123;</div><div class="line"> </div><div class="line">                CalendarSession calendarSession = <span class="keyword">new</span> CalendarSession(mSessionUri, mSessionStart, mSessionEnd, mTitleString, mRoomName);</div><div class="line"> </div><div class="line">                <span class="keyword">if</span> (mStarred) &#123;</div><div class="line"> </div><div class="line">                    mServiceStarter.startAddCalendarSessionService(mCalendarId, calendarSession);</div><div class="line"> </div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line"> </div><div class="line">                    mServiceStarter.startRemoveCalendarSessionService(mCalendarId, calendarSession);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line"> </div><div class="line">                setupSessionNotification();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成这个类的关键在于：SessionDetailPresenter 的依赖通过它的构造器传递，因为这些依赖都被注入了，所以我们现在可以修改 SessionDetailPresenter 类中 onViewTranslatorStopped() 方法的测试单元的测试后状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.google.samples.apps.iosched.test;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> com.google.samples.apps.iosched.service.CalendarSession;</div><div class="line"><span class="keyword">import</span> com.google.samples.apps.iosched.ui.RepositoryManager;</div><div class="line"><span class="keyword">import</span> com.google.samples.apps.iosched.ui.ServiceStarter;</div><div class="line"><span class="keyword">import</span> com.google.samples.apps.iosched.ui.sessiondetail.SessionDetailViewPresenter;</div><div class="line"><span class="keyword">import</span> com.google.samples.apps.iosched.ui.sessiondetail.SessionDetailViewTranslator;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> junit.framework.TestCase;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Matchers.any;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Matchers.anyLong;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Mockito.mock;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Mockito.verify;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by MattDupree on 5/8/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionDetailPresnterTests</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testShouldLaunchAddSessionService</span><span class="params">()</span> </span>&#123;</div><div class="line"> </div><div class="line">        <span class="comment">//Arrange</span></div><div class="line">        SessionDetailViewTranslator sessionDetailViewTranslator = mock(SessionDetailViewTranslator.class);</div><div class="line"> </div><div class="line">        RepositoryManager repositoryManager = mock(RepositoryManager.class);</div><div class="line"> </div><div class="line">        ServiceStarter serviceStarter = mock(ServiceStarter.class);</div><div class="line"> </div><div class="line">        <span class="keyword">long</span> calendarId = <span class="number">0</span>;</div><div class="line"> </div><div class="line">        SessionDetailViewPresenter sessionDetailViewPresenter = <span class="keyword">new</span> SessionDetailViewPresenter(sessionDetailViewTranslator,</div><div class="line">                                                                                               repositoryManager,</div><div class="line">                                                                                               serviceStarter,</div><div class="line">                                                                                               calendarId);</div><div class="line">        sessionDetailViewPresenter.onViewCreated(<span class="keyword">null</span>);</div><div class="line"> </div><div class="line">        <span class="comment">//Act</span></div><div class="line">        sessionDetailViewPresenter.onViewStopped();</div><div class="line"> </div><div class="line">        <span class="comment">//Assert</span></div><div class="line">        verify(serviceStarter).startAddCalendarSessionService(anyLong(), any(CalendarSession.class));</div><div class="line"> </div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然我们现在可以修改测试单元的测试后状态了，但这还不够，因为这个测试单元无法完成测试。为什么呢？我们不妨一起看看 onViewTranslatorStopped() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewTranslatorStopped</span><span class="params">()</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (mInitStarred != mStarred) &#123;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (System.currentTimeMillis() &lt; mSessionStart) &#123;</div><div class="line"> </div><div class="line">            CalendarSession calendarSession = <span class="keyword">new</span> CalendarSession(mSessionUri, mSessionStart, mSessionEnd, mTitleString, mRoomName);</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line"> </div><div class="line">                mServiceStarter.startAddCalendarSessionService(mCalendarId, calendarSession);</div><div class="line"> </div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"> </div><div class="line">                mServiceStarter.startRemoveCalendarSessionService(mCalendarId, calendarSession);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (mStarred) &#123;</div><div class="line"> </div><div class="line">            setupSessionNotification();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>onViewTranslatorStopped() 方法的代码被包裹在一个判断模块中，只有在“starred button”的状态与其初始化状态相异时才会执行判断模块中的代码。mInitStarred 将会在 Loader 回调中被初始化，IOSched 应用检索数据库以判断用户选中的 I/O 大会是否已经被添加到日历中，并在用户返回到 SessionDetailActivity 后通过消息更新 UI。但在上面这段业务逻辑的测试单元中，mInitStarred  和 mStarred 都将有一个初始值 <code>false</code>，使得判断模块内的代码永远不会被执行。</p>
<p>即使我们能执行判断模块内的代码，我们还是不能获得进行单元测试所需要的一切，因为启动 SessionCalendarService 的代码在另一个用于确保在 System.currentTimeMillis() 的返回值小于 mSessionStart 时才执行相关代码的判断模块中。既然我们不能修改 mSessionStart 的值，也就不能保证启动 SessionCalendarService 的代码会被运行。</p>
<p>这些问题都是我思考如何在 Android 中进行单元测试时想到的普遍问题的极端例子：我们常常缺乏对测试单元预测试状态的控制力。然而，由于我们将 SessionRepositoryManager 注入到 SessionDetailPresenter 中，我们现在可以判断 mSessionStart 和 mInitStarred 的值了，因为 SessionRepositoryManager 是一个 Android 无关的接口¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.google.samples.apps.iosched.ui;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> com.google.samples.apps.iosched.io.model.Session;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"> * </div><div class="line"> * Created by MattDupree on 5/6/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SessionRepositoryManager</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initRepository</span><span class="params">(<span class="keyword">int</span> id, Bundle bundle, SessionRepositoryManagerCallbacks repositoryManagerCallbacks)</span></span>;</div><div class="line"> </div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">SessionRepositoryManagerCallbacks</span> </span>&#123;</div><div class="line"> </div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLoadFinished</span><span class="params">(Session session)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然而，当我们创建 SessionDetailPresenter，我们注入了包含 LoaderManager 的 Android 无关接口 <code>SessionRepositoryManager</code> 的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionDetailActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">SessionDetailViewTranslator</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span></div><div class="line">    </div><div class="line">        <span class="comment">//...</span></div><div class="line">    </div><div class="line">        ServiceStarter serviceStarter = <span class="keyword">new</span> AndroidServiceStarter(<span class="keyword">this</span>);</div><div class="line"> </div><div class="line">        SessionRepositoryManager repositoryManager = <span class="keyword">new</span> AndroidSessionRepositoryManager(getLoaderManager());</div><div class="line"> </div><div class="line">        mSessionDetailViewPresenter = <span class="keyword">new</span> SessionDetailViewPresenter(<span class="keyword">this</span>, repositoryManager, </div><div class="line">                                                                     serviceStarter, calendarId);</div><div class="line">        mSessionDetailViewPresenter.onViewCreated(savedInstanceState);</div><div class="line">    </div><div class="line">        <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为 SessionRepositoryManager 只是一个接口，所以我们能轻松地定义 MockRepositoryManager 帮助我们完成单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.google.samples.apps.iosched.ui.sessiondetail;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> com.google.samples.apps.iosched.io.model.Session;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by MattDupree on 5/8/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockSessionRepositoryManager</span> <span class="keyword">implements</span> <span class="title">SessionRepositoryManager</span></span>&#123;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="keyword">private</span> Session mSession;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MockSessionRepositoryManager</span><span class="params">(Session session)</span> </span>&#123;</div><div class="line"> </div><div class="line">        mSession = session;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initRepository</span><span class="params">(<span class="keyword">int</span> id, Bundle bundle,</span></span></div><div class="line">                               SessionRepositoryManagerCallbacks repositoryManagerCallbacks) &#123;</div><div class="line">        </div><div class="line">        repositoryManagerCallbacks.onLoadFinished(mSession);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不知道大家有没有注意到：当有操作通过向构造器传递一个 Session 对象调用 initRepository() 方法时，我们能够指定 MockSessionRepositoryManager 的返回值。SessionDetailPresenter 中类似 mSessionStart 这样的值能在 Session 的模板对象中通过 startTimeStamp 实例初始化。这样一来，我们就能掌控这些值了，也就是说，我们现在几乎拥有了在对 onViewTranslatorStopped() 方法进行单元测试时，准备阶段所需要的一切。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testShouldLaunchAddSessionService</span><span class="params">()</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="comment">//Arrange</span></div><div class="line">    SessionDetailViewTranslator sessionDetailViewTranslator = mock(SessionDetailViewTranslator.class);</div><div class="line"> </div><div class="line">    Session session = <span class="keyword">new</span> Session();</div><div class="line">    session.startTimestamp = <span class="string">"1431081943"</span>;</div><div class="line"> </div><div class="line">    SessionRepositoryManager repositoryManager = <span class="keyword">new</span> MockSessionRepositoryManager(session);</div><div class="line"> </div><div class="line">    ServiceStarter serviceStarter = mock(ServiceStarter.class);</div><div class="line"> </div><div class="line">    <span class="keyword">long</span> calendarId = <span class="number">0</span>;</div><div class="line"> </div><div class="line">    SessionDetailViewPresenter sessionDetailViewPresenter = <span class="keyword">new</span> SessionDetailViewPresenter(sessionDetailViewTranslator,</div><div class="line">                                                                                           repositoryManager,</div><div class="line">                                                                                           serviceStarter,</div><div class="line">                                                                                           calendarId);</div><div class="line">    sessionDetailViewPresenter.onViewCreated(<span class="keyword">null</span>);</div><div class="line"> </div><div class="line">    <span class="comment">//Act</span></div><div class="line">    sessionDetailViewPresenter.onViewStopped();</div><div class="line"> </div><div class="line">    <span class="comment">//Assert</span></div><div class="line">    verify(serviceStarter).startAddCalendarSessionService(anyLong(), any(CalendarSession.class));</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我之所以说“几乎”，是因为 onViewTranslatorStopped() 方法中还有一个地方不能通过上面的代码处理。在 onViewTranslatorStopped() 方法的最下面有一个只有在 mStarred 的值为 true 时才会运行的代码块。这段代码会启动一个 Service 提醒用户参与并且/或者排列他们添加到日历中的 IO 大会：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionDetailViewPresenter</span> <span class="keyword">implements</span> <span class="title">RepositoryManagerCallbacks</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SessionDetailViewPresenter</span><span class="params">(SessionDetailView sessionDetailView,</span></span></div><div class="line">                                      RepositoryManager loaderManager,</div><div class="line">                                      ServiceStarter serviceStarter,</div><div class="line">                                      <span class="keyword">long</span> calendarId</div><div class="line">                                      ) &#123;</div><div class="line"> </div><div class="line">        mSessionDetailView = sessionDetailView;</div><div class="line">        mLoaderManager = loaderManager;</div><div class="line">        mServiceStarter = serviceStarter;</div><div class="line">        mCalendarId = calendarId;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewTranslatorStopped</span><span class="params">()</span> </span>&#123;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (mInitStarred != mStarred) &#123;</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &lt; mSessionStart) &#123;</div><div class="line"> </div><div class="line">                CalendarSession calendarSession = <span class="keyword">new</span> CalendarSession(mSessionUri, mSessionStart, mSessionEnd, mTitleString, mRoomName);</div><div class="line"> </div><div class="line">                <span class="keyword">if</span> (mStarred) &#123;</div><div class="line"> </div><div class="line">                    mServiceStarter.startAddCalendarSessionService(mCalendarId, calendarSession);</div><div class="line"> </div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line"> </div><div class="line">                    mServiceStarter.startRemoveCalendarSessionService(mCalendarId, calendarSession);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (mStarred) &#123;</div><div class="line"> </div><div class="line">                setupSessionNotification();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了让这段代码运行，我们需要确保 mStarred 的值为 true。我们能通过调用 SessionDetailPresenter 的 onSessionStarred() 方法完成这项工作，因为 onSessionStarred() 方法就是在用户点击 star button 时 SessionDetailViewTranslator（如果你觉得这些命名让你觉得晕乎乎的，你可以把它当作 SessionDetailView）调用的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onToggleSessionStarred</span><span class="params">()</span> </span>&#123;</div><div class="line"> </div><div class="line">    mStarred = !mStarred;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testShouldLaunchAddSessionService</span><span class="params">()</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="comment">//Arrange</span></div><div class="line">    SessionDetailViewTranslator sessionDetailViewTranslator = mock(SessionDetailViewTranslator.class);</div><div class="line"> </div><div class="line">    Session session = <span class="keyword">new</span> Session();</div><div class="line">    session.startTimestamp = <span class="string">"1431081943"</span>;</div><div class="line"> </div><div class="line">    SessionRepositoryManager repositoryManager = <span class="keyword">new</span> MockSessionRepositoryManager(session);</div><div class="line"> </div><div class="line">    ServiceStarter serviceStarter = mock(ServiceStarter.class);</div><div class="line"> </div><div class="line">    <span class="keyword">long</span> calendarId = <span class="number">0</span>;</div><div class="line"> </div><div class="line">    SessionDetailViewPresenter sessionDetailViewPresenter = <span class="keyword">new</span> SessionDetailViewPresenter(sessionDetailViewTranslator,</div><div class="line">                                                                                           repositoryManager,</div><div class="line">                                                                                           serviceStarter,</div><div class="line">                                                                                           calendarId);</div><div class="line">    sessionDetailViewPresenter.onViewCreated(<span class="keyword">null</span>);</div><div class="line">    <span class="comment">//****** We call onToggleSessionStarred() to make sure that mStarrred is true</span></div><div class="line">    sessionDetailViewPresenter.onToggleSessionStarred();</div><div class="line">    <span class="comment">//******</span></div><div class="line">    </div><div class="line">    <span class="comment">//Act</span></div><div class="line">    sessionDetailViewPresenter.onViewStopped();</div><div class="line"> </div><div class="line">    <span class="comment">//Assert</span></div><div class="line">    verify(serviceStarter).startAddCalendarSessionService(anyLong(), any(CalendarSession.class));</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把上面提到的所有工作万仇后，我们终于能够在 onViewTranslatorStopped() 方法中进行单元测试了。</p>
<p>##结论</p>
<p>你可能觉得我们为单元测试的准备阶段进行了大量的工作，我不得不承认你的感觉是对的。最后，我提一点个人想法：我认为 SessionDetailActivity 类中的代码实在是太多了，都有1000多行……正是这个原因，使得为其实现测试单元变得如此艰难。此外，因为这篇博文的目的只是展示 Square 大法的核心用法，所以我并不打算讨论优化单元测试的方案。²</p>
<p>Square 大法是告别传统 Android 开发架构的里程碑，因为我们确实发现了遵循传统架构进行开发的种种缺陷。为此，我将在下一篇博文中指出 Square 大法潜在的问题，并提出可能的解决办法。此外，本系列的最后一篇博文也会告诉大家 Square 大法的种种优点，而且我所说的优点可不是只有增强应用的可测试性哦。</p>
<p>##注：</p>
<ol>
<li><p>严格来说这个接口并不是 Android 无关的，因为它的核心方法使用 Bundle 作为参数，但我不确定这会不会带来什么问题，毕竟 Bundle 非常普通，并不会是什么我们想要测试的东西。退一万步说，即使要对它进行测试也没啥麻烦。</p>
</li>
<li><p>在 Droidcon Montreal 中，Richa Khandelwal 在 Coursa 上开了一节课建议我们使用<a href="https://speakerdeck.com/richk/clean-android-architecture" target="_blank" rel="external">更简洁、更易于测试的架构进行开发</a>，这或许也能让实现单元测试变得简单些。</p>
</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android进行单元测试难在哪-part4/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android进行单元测试难在哪-part4/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android进行单元测试难在哪-终/" title="Android 进行单元测试难在哪-终" itemprop="url">Android 进行单元测试难在哪-终</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.philosophicalhacker.com/2015/05/22/what-ive-learned-from-trying-to-make-an-android-app-unit-testable/" target="_blank" rel="external">WHAT I’VE LEARNED FROM TRYING TO MAKE AN ANDROID APP UNIT TESTABLE</a></li>
</ul>
<p>在前面的博文中，我给大家介绍并展示了要怎么使用 Square 大法架构 Android 应用，事实上，Square 开发新的 Android 应用架构本意只是增强应用的可测试性。正如我在<a href="https://github.com/bboyfeiyu/android-tech-frontier/blob/master/issue-8/Android%20%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%9A%BE%E5%9C%A8%E5%93%AA-%E5%BA%8F.md" target="_blank" rel="external">Android 进行单元测试难在哪-序</a>中所说，要在 Android 中进行单元测试在大多数情况下都很费时，尝试一些奇技淫巧或者第三方库情况可能会好一些。为了实现高效且不依赖第三方库的测试单元，Square 大法应运而生。</p>
<p>此外，我们在<a href="https://github.com/bboyfeiyu/android-tech-frontier/blob/master/issue-9/Android%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%9A%BE%E5%9C%A8%E5%93%AA-part1.md" target="_blank" rel="external"> Android 进行单元测试难在哪-part1</a>和<a href="https://github.com/bboyfeiyu/android-tech-frontier/blob/master/issue-11/Android%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%9A%BE%E5%9C%A8%E5%93%AA-part3.md" target="_blank" rel="external"> Android 进行单元测试难在哪-part3</a>两篇博文就这个问题进行了研究，最后成功地通过 Square 大法为 Android 应用实现了测试单元，这篇文章则是对 Square 大法进行评估，我将从下面三个方面进行：</p>
<ol>
<li><p>为 Android 应用实现高效的测试单元并不需要移除所有对 Android SDK 的编译时依赖。（事实上这样做有些不切实际。）</p>
</li>
<li><p>加入我们重新设计 Square 大法，使 Square 大法的使用不需要移除所有对 Android SDK 的编译时依赖，尝试将 Square 大法运营到项目中唯一会发生的问题是：实现一大堆模板代码。幸运的是，许多诸如此类的模板代码都可以通过 Android Studio 自动生成。</p>
</li>
<li><p>依赖注入确实是让 Square 大法成为应用可测试性治病良方的好办法。</p>
</li>
</ol>
<p>##移除所有对 Android SDK 的编译时依赖既不必要也不切合实际</p>
<p>完成这个系列博文的最初愿望就是通过让 Android 应用栈变成下图那样，增强应用的可测试性：</p>
<p><img src="http://i2.wp.com/www.philosophicalhacker.com/wp-content/uploads/2015/04/androidstack-02.png?resize=279%2C172" alt=""></p>
<p>接下来我将告诉大家，这个想法一直误导着我们。要使应用的可测试性增强，我们还需要利用依赖注入的其它特性，而不仅仅是用它将业务逻辑代码和 Android SDK 解耦。最初的原因是对象的 Android 依赖可以通过类似 Mockito 的东西模拟出来，而且如果我们无法单独通过 Mocktio 完全控制测试单元的预测试状态的话，我们还可以用具有 mock 实现的接口代替这些 Android 依赖。而这也正是我们在<a href="https://github.com/bboyfeiyu/android-tech-frontier/blob/master/issue-12/Android%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%9A%BE%E5%9C%A8%E5%93%AA-part4.md" target="_blank" rel="external"> Android 进行单元测试难在哪-part4</a>中重构 SessionRepositoryManager 的办法。</p>
<p>移除依赖不仅是不必要的，将它完全与 Android SDK 解耦也是不切实际的，问题在于：当你尝试完成这个目标时，不妨回顾你已经完成的工作，你会很明显地感觉这是不必要的，所以我只打算在此简要地陈述个中因由。</p>
<p>要移除移除应用中所有对 Android SDK 的编译时依赖可能会导致下面的问题：</p>
<ol>
<li><p>应用必须为此定义许多方法和类。</p>
</li>
<li><p>添加的接口和已有的 Android 接口几乎一样。</p>
</li>
<li><p>由于有些情况下，对象需要被注入；有些情况下，对象不需要被注入，带有依赖的类构造器会因此变得很臃肿。</p>
</li>
</ol>
<p>虽然 Square 大法存在一些问题，但这并不影响我在之前的博文中有关 Square 的讲解，Square 的这些特性依旧是实用，值得尝试的。由于 Android SDK 供予我们使用的应用组件类都没有被依赖注入，我们要在 Android 应用中进行单元测试确实很困难，但有了 Square 大法后，只要我们将业务逻辑交给被依赖注入的纯 Java 对象，就能轻易地对 Android 应用进行单元测试。尽管 Square 大法减小了移除 Android SDK 依赖的需求，但 Square 大法仍然是增强应用可测试性的屠龙宝刀。但我个人还是希望对 Square 大法进行优化，使得 Square 大法能无视这个需求，换句话说，我希望能够找到一种不需要我们移除所有对 Android SDK 依赖的架构方法，</p>
<p>##乏味的模板代码是阻碍应用变得可测试的绊脚石</p>
<p>如果我们对 Square 大法进行优化，使其不再要求我们移除对 Android SDK的依赖，Square 大法看起来真的是天下第一的神功了。委以业务逻辑的纯 Java 对象将被应用组件类引用，使它们能够访问所有组件类内的属性和回调。因此，将业务逻辑转移到进行了依赖注入的纯 Java 对象，不应该将那些拥有履行自身职责的数据的对象排除在外。</p>
<p>如果这是正确的，那么唯一阻止我们使用 Square 大法的就是实现乏味的模板代码。幸运的是，Android Studio 为我们提供了过渡到 Square 大法的重构选项——the Extract Delegate option。利用这个选项，可以自动地将类的方法和实例变量转移到一个委托类中，并让原始类通过调用委托类处理逻辑，而不用依赖类自身的方法。</p>
<p>这个<a href="www.youtube.com/embed/N0F7w4wEnQ8">视频</a>向我们展示了如何利用 <code>the Extract Delegate option</code> 完成重构 SessionDetailActivity 的 onStop() 并使之能够进行单元测试必要的操作。我曾在之前的博文中给大家解释过进行这样的重构为什么是必要的，很显然，手动操作无法涵盖所有情况，而且你需要为此不断重复实现代码语句块中分离 Activity View 和数据的方法，这样重复而又没有意义的工作无异于浪费生命，因此这个选项真的非常实用。</p>
<p>##依赖注入是 Square 大法的精髓</p>
<p><a href="https://github.com/bboyfeiyu/android-tech-frontier/blob/master/issue-11/Android%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%9A%BE%E5%9C%A8%E5%93%AA-part3.md" target="_blank" rel="external">Android 进行单元测试难在哪-part3</a>的秘密在于：<strong>依赖注入</strong>。</p>
<p>— Chris Arriola (@arriolachris) <a href="https://twitter.com/arriolachris/status/599232312492982273" target="_blank" rel="external">May 15, 2015</a></p>
<p>Square 大法之所以能解决 Android 的单元测试问题，是因为它允许我们对持有业务逻辑的类进行真正的依赖注入，我之所以强调 Square 允许我们进行的是<strong>真正的</strong>依赖注入，是因为依赖注入这个概念在 Dagger 库中也被提到过，然而，Dagger 并不能真正简化 Android 应用进行单元测试的代码。</p>
<p>这是因为 Dagger 就像它介绍的那样，确实是一个 Service 定位库，正是如此，Dagger 强迫我们实现一个模块，使之为我们想要进行单元测试的对象提供 mock 依赖。为了能利用这些模块，我们还要确保由这些 mock 提供者模块构建的对象图与我们尝试进行单元测试的对象使用的对象图相同。</p>
<p>而正是这样的操作使得 Dagger 的依赖注入不如 Square 大法中真正的依赖注入那样简便，解释为什么 Dagger 不能简化对 Android 应用进行单元测试的过程完全可以写一篇博文，所以现在，我唯一能做的就是先指出这个问题，如果我们理解<a href="http://martinfowler.com/articles/injection.html#InversionOfControl" target="_blank" rel="external"> Martin Fowler 对依赖注入的定义</a>（这篇博文确实值得一读，因为他创建了一个新的术语），就会发现 Dagger 确实只是一个 Service 定位库，而且 Google 官方有关测试的博客也有<a href="http://martinfowler.com/articles/injection.html#InversionOfControl" target="_blank" rel="external">一篇博文</a>对此作出解释。</p>
<p>##结论</p>
<p>如果想让 Android 应用可以进行单元测试，那就用 Square 大法吧，当然了，如果有其他解决办法的话我也会支持的。在这里友情提示一下哈：我只是列出我了解的几种办法，我可没有说 Square 大法天下第一无人可敌，事实上增强应用可测试性应该还会有其他办法的。</p>
<p>这篇博文的发布也预示着这系列博文走向终结啦，我非常感谢每一个关注本系列博文的 Android 开发者的支持，感谢每一个人对我的鼓励、转发以及大家在社交媒体上对我的褒奖，我感恩这一切。这些积极的反馈使我认识到讨论和思考对 Android 应用进行测试的重要性，正是完成这个系列博文给我带来的启示使我决定：我要在未来花费更多的时间在博客中研究 Android 测试方面的知识。我会在每个周五更新博客，希望能学习更多有关测试的知识，和大家一起进步。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android进行单元测试难在哪-终/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android进行单元测试难在哪-终/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/还在用Toast？你Out啦，试试Snackbar吧！/" title="还在用Toast？你Out啦，试试Snackbar吧！" itemprop="url">还在用Toast？你Out啦，试试Snackbar吧！</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.technotalkative.com/part-2-welcome-snackbar-goodbye-toast/" target="_blank" rel="external">Welcome Snackbar, Goodbye Toast!</a></li>
</ul>
<p>欢迎来到Android design support library系列教程第二部分，第一部分我们讨论了<a href="http://www.technotalkative.com/part-1-floating-action-button/" target="_blank" rel="external">Floating action button</a>的一些attributes 和 常见issues。</p>
<p>今天我们讨论一下另一个组件”Snackbar”.</p>
<p>Welcome Snackbar, Goodbye Toast!</p>
<blockquote>
<p>“Providing lightweight, quick feedback about an operation is a perfect opportunity to use a snackbar.”</p>
</blockquote>
<p>Snackbar是design support library中另一个组件，使用Snackbar我们可以在屏幕底部(大多时候)快速弹出消息，它和Toast非常相似，但是它更灵活一些。</p>
<ul>
<li>当它显示一段时间后或用户与屏幕交互时它会自动消失。</li>
<li>可以自定义action-可选操作。</li>
<li>swiping it off the screen可以让FAB消失</li>
<li>它是context sensitive message(自己理解吧),所以这些消息是UI screen的一部分并且它是显示在所有屏幕其它元素之上(屏幕最顶层)，并不是像Toast一样覆盖在屏幕上。</li>
<li>同一时间只能显示一个snackbar。</li>
</ul>
<p>Snackbar基本上继承了和Toast一样的方法和属性，例如LENGTH_LONG 和 LENGTH_SHORT用于设置显示时长。</p>
<p>##如何使用</p>
<p>我们看一下如何使用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Snackbar.make(view, message, duration)</div><div class="line">       .setAction(action message, click listener)</div><div class="line">       .show();</div></pre></td></tr></table></figure>
<p>###方法:</p>
<ul>
<li><em><font color="red">make()</font></em>  – 生成Snackbar消息</li>
<li><em><font color="red">setAction()</font></em>  – 设置action</li>
<li><em><font color="red">make()</font></em>  – 显示Snackbar消息</li>
</ul>
<p>###属性:</p>
<ul>
<li>make()方法的第一个参数是一个view, snackbar会试着寻找一个父view来hold这个view. Snackbar将遍历整个view tree 来寻找一个合适的父view，它可能是一个coordinatorLayout也可能是window decor’s content view,随便哪一个都行。</li>
<li>正如上面所提到，duration参数和Toast中的duration参数类似，只能是LENGTH_SHORT 或 LENGTH_LONG，不能是其它任何随机数。</li>
</ul>
<p>###示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Snackbar.make(rootlayout, <span class="string">"Hello SnackBar!"</span>, Snackbar.LENGTH_SHORT)</div><div class="line">       .setAction(<span class="string">"Undo"</span>, <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">               <span class="comment">// Perform anything for the action selected</span></div><div class="line">           &#125;</div><div class="line">       &#125;)</div><div class="line">       .show();</div></pre></td></tr></table></figure>
<p>部局文件中rootlayout是framelayout并且添加了FAB(Floating action button)，看一下FAB示例：</p>
<p>点击FAB查看结果：</p>
<p><img src="http://www.technotalkative.com/wp-content/uploads/2015/06/Snackbar-framelayout1.gif" alt=""></p>
<p>程序没问题，但是对于用户体验来说并不太好，它应该向上移一些，如下图所示：</p>
<blockquote>
<p>Having a CoordinatorLayout in your view hierarchy allows Snackbar to enable certain features, such as swipe-to-dismiss and automatically moving of widgets like FloatingActionButton.</p>
</blockquote>
<p>我们在该系列文章的下一部分讨论CoordinatorLayout。</p>
<p><img src="http://www.technotalkative.com/wp-content/uploads/2015/06/Snackbar-with-CoordinatorLayout1.gif" alt=""></p>
<p>###配置Snackbar可选操作</p>
<p>我们可以使用额外的可选操作来配置snackbar，比如<em><font color="red">setActionTextColor</font></em> 和 <em><font color="red">setDuration</font></em>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Snackbar.make(rootlayout, <span class="string">"Hello SnackBar!"</span>, Snackbar.LENGTH_SHORT)</div><div class="line">       .setAction(<span class="string">"Undo"</span>, <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">               <span class="comment">// Perform anything for the action selected</span></div><div class="line">           &#125;</div><div class="line">       &#125;)</div><div class="line">       .setActionTextColor(R.color.material_blue)</div><div class="line">       .setDuration(<span class="number">4000</span>).show();</div></pre></td></tr></table></figure>
<p>下载示例代码：<a href="https://github.com/PareshMayani/DesignSupportLibraryExamples" target="_blank" rel="external">https://github.com/PareshMayani/DesignSupportLibraryExamples</a></p>
<p>参考文档：<br><a href="https://developer.android.com/reference/android/support/design/widget/Snackbar.html" target="_blank" rel="external">https://developer.android.com/reference/android/support/design/widget/Snackbar.html</a></p>
<p>###总结</p>
<p>在这部分文章中，我们讨论了Snackbar，它和TOAST很相似，但是它更灵活一些。Snackbar中可以定义action，当用户与屏幕交互时或者显示一段时间后会自动消失。</p>
<p>通过 CoordinatorLayout我们可以看到更多的effects 和 behaviours，在该系列文章中后续会讨论它。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/还在用Toast？你Out啦，试试Snackbar吧！/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/还在用Toast？你Out啦，试试Snackbar吧！/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Code Review最佳实践/" title="Code Review最佳实践" itemprop="url">Code Review最佳实践</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://kevinlondon.com/2015/05/05/code-review-best-practices.html" target="_blank" rel="external">Code Review Best Practices</a></li>
</ul>
<p>在Wiredrive上，我们做了很多的Code Review。在此之前我从来没有做过，这对于我来说是一个全新的体验，下面来总结一下在Code Review中做的事情以及说说谈论Code Review的最好方式。</p>
<p>简单的说，Code Review是开发者之间讨论修改代码来解决问题的过程。很多文章谈论了Code Review的诸多好处，包括知识共享，代码的质量，开发者的成长，却很少讨论审查什么、如何审查。</p>
<p>###审查的内容</p>
<p>####体系结构和代码设计</p>
<ul>
<li><p><a href="http://en.wikipedia.org/wiki/Single_responsibility_principle" target="_blank" rel="external">单一职责原则：</a>一个类有且只能一个职责。我通常使用这个原则去衡量，如果我们必须使用“和”来描述一个方法做的事情，这可能在抽象层上出了问题。</p>
</li>
<li><p><a href="http://en.wikipedia.org/wiki/Open/closed_principle" target="_blank" rel="external">开闭原则</a>如果是面向对象的语言，对象对可扩展开放、对修改关闭。如果我们需要添加另外的内容会怎样？</p>
</li>
<li><p>代码复用：根据<a href="http://c2.com/cgi/wiki?ThreeStrikesAndYouRefactor" target="_blank" rel="external">“三振法”</a>,如果代码被复制一次，虽然如喜欢这种方式，但通常没什么问题。但如果再一次被复制，就应该通过提取公共的部分来重构它。</p>
</li>
<li><p><a href="http://robertheaton.com/2014/06/20/code-review-without-your-eyes/" target="_blank" rel="external">换位考虑</a>，如果换位考虑，这行代码是否有问题？用这种模式是否可以发现代码中的问题。</p>
</li>
<li><p>用更好的代码： 如果在一块混乱的代码做修改，添加几行代码也许更容易，但我建议更进一步，用比原来更好的代码。</p>
</li>
<li><p>潜在的bugs：是否会引起的其他错误？循环是否以我们期望的方式终止？</p>
</li>
<li><p>错误处理：错误确定被优雅的修改？会导致其他错误？如果这样，修改是否有用？</p>
</li>
<li><p>效率： 如果代码中包含算法，这种算法是否是高效？ 例如，在字典中使用迭代，遍历一个期望的值，这是一种低效的方式。</p>
</li>
</ul>
<p>####代码风格</p>
<ul>
<li><p>方法名： 在计算机科学中，命名是一个难题。一个函数被命名为==get_message_queue_name==，但做的却是完全不同的事情，比如从输入内容中清除html，那么这是一个不准确的命名，并且可能会误导。</p>
</li>
<li><p>值名：对于数据结构，==foo== or ==bar== 可能是无用的名字。相比==exception==， ==e==同样是无用的。如果需要(根据语言)尽可能详细，在重新查看代码时，那些见名知意的命名是更容易理解的。</p>
</li>
<li><p>函数长度： 对于一个函数的长度，我的经验值是小于20行，如果一个函数在50行以上，最好把它分成更小的函数块。</p>
</li>
</ul>
<ul>
<li><p>类的长度：我认为类的长度应该小于300行，最好在100内。把较长的类分离成独立的类，这样更容易理解类的功能。</p>
</li>
<li><p>文件的长度： 对于Python，一个文件最多1000行代码。任何高于此的文件应该把它分离成更小更内聚,看一下是否违背的“单一职责” 原则。</p>
</li>
<li><p>文档：对于复杂的函数来说，参数个数可能较多，在文档中需要指出每个参数的用处，除了那些显而易见的。</p>
</li>
<li><p>注释代码： 移除任何注释代码行。</p>
</li>
<li>函数参数个数：不要太多， 一般不要超过3个。。</li>
<li>可读性： 代码是否容易理解？在查看代码时要不断的停下来分析它？</li>
</ul>
<p>####测试</p>
<ul>
<li>测试的范围：我喜欢测试新功能。测试是否全面？是否涵盖了故障的情况【比如：网络，信号等，译者注】？是否容易使用？是否稳定？大多的测试？性能的快慢？</li>
<li>合乎规范的测试：当复查测试时，确保我们用适当的方式。换句话说，当我们在一个较低水平测试却要求期望的功能？Gary Bernhardt建议95％的单元测试，5％的集成测试。特别是在Django项目中，在较高的测试水平上，很容易发现意外bug，创建一个详细的测试用例，认真仔细也是很重要的。</li>
</ul>
<p>####审查代码<br>在提交代码之前，我经常用git添加改变的文件/文件夹,然后通过git diff 来查看做了哪些修改。通常，我会关注如下几点：</p>
<ul>
<li>是否有注释？</li>
<li>变量名是否见名知意？</li>
<li>…等上面提到的</li>
</ul>
<p>和著名的橡皮鸭调试法（Rubber Duck Debugging）一样，每次提交前整体把自己的代码过一遍非常有帮助，尤其是看看有没有犯低级错误。</p>
<p>####如何进行Code Review<br>当Code Review时，会遇到不少问题，我也学会了如何处理，下面是一些方法：</p>
<ul>
<li>提问： 这个函数是如何生效的？如果需求变更，应该做什么改变？怎么更容易维护？</li>
<li>表扬/奖励良好的做法：Code Review重要的一点是奖励开发者的成长和努力。得到别人的肯定是一件很不错的事情，我尽可能多的给人积极的评论。</li>
<li>当面讨论代替评论。 大部分情况下小组内的同事是坐在一起的，当面的 code review是非常有效的。</li>
<li>说明理由 ：是否还有跟好的方式，证明为什么这样做是好的。</li>
</ul>
<p>####心态上</p>
<ul>
<li>作为一个Developer , 不仅要Deliver working code, 还要Deliver maintable code.</li>
<li>必要时进行重构，随着项目的迭代，在计划新增功能的同时，开发要主动计划重构的工作项。</li>
<li>开放的心态，虚心接受大家的Review Comments。</li>
</ul>
<p>####参考<br>一些关于clean code的书籍，如下：</p>
<ul>
<li><a href="http://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882" target="_blank" rel="external">Clean Code</a></li>
<li><a href="http://www.amazon.com/Refactoring-Improving-Design-Existing-Code/dp/0201485672" target="_blank" rel="external">Refactoring</a></li>
<li><a href="https://www.youtube.com/watch?v=8bZh5LMaSmE&amp;index=1&amp;list=LLlt4ZSW8NUcXLWiB3NMnK_w" target="_blank" rel="external">All the Small Things by Sandi Metz</a></li>
<li><a href="https://www.youtube.com/watch?v=aAb7hSCtvGw&amp;list=LLlt4ZSW8NUcXLWiB3NMnK_w&amp;index=48" target="_blank" rel="external">How to Design a Good API and Why it Matters</a></li>
<li><a href="https://news.ycombinator.com/item?id=9517892" target="_blank" rel="external">Discussion on Hacker News</a></li>
</ul>
<p>##译者注</p>
<p>#####一. 参考了 <a href="http://jimhuang.cn/?p=59" target="_blank" rel="external">http://jimhuang.cn/?p=59</a></p>
<p>#####二. 国内阿里的<a href="http://coolshell.cn/articles/author/haoel" target="_blank" rel="external">陈皓</a>写的关于codereview的文章，也很有见底，推荐大家看看</p>
<p>######1.<a href="http://coolshell.cn/articles/1302.html" target="_blank" rel="external">Code Review中的几个提示</a></p>
<ul>
<li>先Review设计实现思路，然后Review设计模式，接着Review成形的骨干代码，最后Review完成的代码，如果程序复杂的话，需要拆成几个单元或模块分别Review</li>
<li>Code Review不要太正式，而且要短</li>
<li>学会享受Code Reivew</li>
</ul>
<p>######2.<a href="http://coolshell.cn/articles/11432.html/comment-page-1#comments" target="_blank" rel="external">从Code Review 谈如何做技术</a></p>
<p>#####三. Code Review 工具<br><a href="https://github.com/reviewboard/reviewboard" target="_blank" rel="external">Review Board</a></p>
<p>#####四.<br>在Code Review时，要在 <strong>意识</strong> <strong>方法</strong> <strong>心态</strong> <strong>习惯</strong> 这几个方面上下功夫，坚持code review，相信我们会在各方面有很大的提升。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Code Review最佳实践/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Code Review最佳实践/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="kevin1202" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/git/" title="git">git<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/mac/" title="mac">mac<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/git/" title="git">git<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mac/" title="Mac">Mac<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Library/" title="Library">Library<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Spannable/" title="Spannable">Spannable<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/TimerTask/" title="TimerTask">TimerTask<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Timer/" title="Timer">Timer<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/size/" title="size">size<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Travis-CI/" title="Travis-CI">Travis-CI<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 每天进步一点，就是要付诸行动。光有进步一点的想法，而不付诸行动，那么这种想  <br/>
			法只是空想，是永远也不会有进步的。”路行之而成”，路是人走出来的；进步也是人 </p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/5052645262" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/kevin1202" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:yangkai1202@126.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Kevin">Kevin</a>
		
		
		</p>
		<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','DBjSFU5kGEcv8E-m-m_m','2.0.0');
</script>
</div></footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?575e1640d293c4bdc82c5d203e895c4f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
