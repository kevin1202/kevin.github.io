
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Kevin博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Kevin">
    

    
    <meta name="description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">
<meta property="og:type" content="website">
<meta property="og:title" content="Kevin博客">
<meta property="og:url" content="https://kevin1202.github.io/page/2/index.html">
<meta property="og:site_name" content="Kevin博客">
<meta property="og:description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kevin博客">
<meta name="twitter:description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Kevin博客" title="Kevin博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Kevin博客">Kevin博客</a></h1>
				<h2 class="blog-motto">梦想还是要有的，万一实现了呢？</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" maxlength="20" placeholder="Search" />
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/自动化截图－应用分发时的自动截图方案/" title="自动化截图－应用分发时的自动截图方案" itemprop="url">自动化截图－应用分发时的自动截图方案</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://flavienlaurent.com/blog/2014/12/05/screenshot_automation/" target="_blank" rel="external">Screenshots Through Automation</a></li>
</ul>
<p>在发布 App 到应用商店时有一件的事情不得不做，就是上传最新的高清无码截图到应用商店上。可是如果你的 App 有许多页面，那你每次发布更新都可能是一场梦魇，因为你需要一页一页地去截图。为了解决众多 App 开发者的这个痛点，我将在这篇博文中介绍一个实现自动化截图的方法：</p>
<p>刚到 <a href="https://www.capitainetrain.com/" target="_blank" rel="external">Capitaine Train</a> 公司里，就有人让我造个能自动截图的轮子，因为我们公司的 App 每次版本更新都让人很头疼：问题在于我们的 App 对应有3种设备，4种语言，也就是有 12 种版本。此外，我们有6个需要截图的页面，也就是说，我们每次版本更新都需要72张截图。我们无法忍受这种低效并浪费时间的工作，于是我们经过不懈的努力，找到了一个自动化截图的方案，在这个方案中，要实现自动化截图有三个关键点：uiautomator 自动化测试, accessibility 和 bash脚本。</p>
<h2 id="修改-uiautomator"><a href="#修改-uiautomator" class="headerlink" title="修改 uiautomator"></a>修改 uiautomator</h2><p>uiautomator 是一个用部分封装代码将 UI 处理成一个 JUnit 测试用例的框架。这里需要注意的是：被测试的 App 里没有包含这些测试用例，因为他们在一个独立的进程中运行。换句话说，你可以把 uiautomator 框架看作一个独立的机器人，它能帮你在设备上完成诸如：点击，滚动，截图等简单动作。</p>
<p><strong>预备知识</strong></p>
<p>在继续讲解之前，我建议你花些时间阅读官方文档，这能帮助你更好地理解接下来的内容。</p>
<p>uiautomator 框架的 API 非常简单，里面有三个类分别代表了不同类型的 UI 界面元素：</p>
<ul>
<li><p>UiObject: 基本界面元素，例如：TextView</p>
</li>
<li><p>UiCollection: 包含多个 UiObject 的界面元素，例如：LinearLayout</p>
</li>
<li><p>UiScrollable: 包含多个 UiObject ，并能滚动的界面元素，例如：ListView</p>
</li>
</ul>
<p><img src="http://flavienlaurent.com/media/2014-12-05-screenshot_automation/uml.png" alt=""></p>
<p>框架里这两个类你也需要了解：</p>
<ul>
<li><p>UiDevice：用于执行设备常见的动作，例如：点击按钮，截图等等</p>
</li>
<li><p>UiSelector：通过 id, 类型等获得屏幕上的 UI 界面元素</p>
</li>
</ul>
<p>最后，UiAutomatorTestCase 是框架里你绝对不能忽略的类，因为我们必须通过继承它来获得一个 uiautomator 测试用例。</p>
<p>当然了，我刚刚提到的这些类在官方文档里面都有详细的解释，此外，文档还提供了一些示例来帮助我们熟悉 uiautomator 。</p>
<p><strong>安装，创建和运行</strong></p>
<p>接下来我们要做的就是创建 uiautomator ，但很不幸，uiautomator 并没有一个官方的 Gradle 整合模块，所以我们必须自己去完成这项工作。把这些工作都完成后，才能在我们的 App 上使用 uiautomator。uiautomator 测试用例的最终输出应该是一个独立的 JAR 包。具体步骤如下：</p>
<p>在你的项目里新建一个 Gradle 模块，并在其中添加与 local.properties 相同的 android.jar 依赖包：</p>
<p>.build.gradle</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'java'</span></div><div class="line"></div><div class="line">Properties props = <span class="keyword">new</span> Properties()</div><div class="line">props.load(<span class="keyword">new</span> FileInputStream(file(<span class="string">"../local.properties"</span>)))</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: props[<span class="string">'sdk.dir'</span>] + <span class="string">'/platforms/'</span> + androidSdkTarget, include: <span class="string">'*.jar'</span>)</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过使用 local.properties 和 gradle.properties 新建一个 ant 文件，使其获得与项目相同的配置信息(target, sdk path)：</p>
<p>build.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">name</span>=<span class="string">"uiautomator"</span> <span class="attr">default</span>=<span class="string">"help"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">loadproperties</span> <span class="attr">srcFile</span>=<span class="string">"../local.properties"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">loadproperties</span> <span class="attr">srcFile</span>=<span class="string">"gradle.properties"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"target"</span> <span class="attr">value</span>=<span class="string">"$&#123;androidSdkTarget&#125;"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">file</span>=<span class="string">"$&#123;sdk.dir&#125;/tools/ant/uibuild.xml"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>使用ant 构建JAR（不要使用Gradle构建），并把它加到你的设备中，然后运行你的测试用例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ant build</div><div class="line">$ adb push uiautomator.jar data/local/tmp</div><div class="line">$ adb shell uiautomator runtest uiautomator.jar -c com.your.TestCase</div></pre></td></tr></table></figure>
<p><strong>自动切换设置信息</strong></p>
<p>现在我准备讲解怎么在设置中自动切换设置项和设置信息（特别是从一个语言切换到另一个语言）。首先，这是一个练习使用 uiautomator 的机会。同时，这也是自动化截图的关键步骤。但你要记住，我接下来介绍的只是一个能在 Android 5.0 系统上正常使用的办法，如果你有更好的建议或者想法，也可以通过留言和我交流，一起优化这个步骤。</p>
<ul>
<li>打开快捷设置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mUiDevice.openQuickSettings();</div></pre></td></tr></table></figure>
<ul>
<li>点击设置按钮以打开设置界面</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> UiObject(<span class="keyword">new</span> UiSelector().resourceId(<span class="string">"com.android.systemui:id/settings_button"</span>)).click();</div></pre></td></tr></table></figure>
<ul>
<li>因为在设置界面里我们没有可用的 View 的 id 值，所以我们必须根据设置栏的文字改变相对应的语言设置。所以我们滚动到某一项（FrameLayout）并点击它</li>
</ul>
<p><img src="http://flavienlaurent.com/media/2014-12-05-screenshot_automation/settings_app.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">UiScrollable scrollable = <span class="keyword">new</span> UiScrollable(<span class="keyword">new</span> UiSelector().resourceId(<span class="string">"com.android.settings:id/dashboard"</span>));</div><div class="line"></div><div class="line">scrollable.getChildByText(<span class="keyword">new</span> UiSelector().className(FrameLayout.class), <span class="string">"Language &amp; input"</span>, <span class="keyword">true</span>).click();</div></pre></td></tr></table></figure>
<ul>
<li>通过上面的代码处理，整个“寻找并点击”的自动化逻辑已经能在语言设置栏里被使用了。<br><img src="http://flavienlaurent.com/media/2014-12-05-screenshot_automation/settings_language.png" alt=""></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">UiScrollable scrollable = <span class="keyword">new</span> UiScrollable(<span class="keyword">new</span> UiSelector().className(ListView.class));</div><div class="line">scrollable.getChildByText(<span class="keyword">new</span> UiSelector().className(LinearLayout.class), <span class="string">"Language"</span>, <span class="keyword">true</span>).click();</div></pre></td></tr></table></figure>
<ul>
<li>添加这样的代码后，就能使得目标语言被选中了。</li>
</ul>
<p><img src="http://flavienlaurent.com/media/2014-12-05-screenshot_automation/settings_language_selection.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">UiScrollable scrollable = <span class="keyword">new</span> UiScrollable(<span class="keyword">new</span> UiSelector().className(ListView.class));</div><div class="line">scrollable.getChildByText(<span class="keyword">new</span> UiSelector().className(LinearLayout.class), <span class="string">"Français (France)"</span>, <span class="keyword">true</span>).click();</div><div class="line">Locale.setDefault(<span class="keyword">new</span> Locale(<span class="string">"fr"</span>));</div></pre></td></tr></table></figure>
<p>完成了上面的操作后，你还需要强制设置新的语言环境以避免 uiautomator 操作过程中保存了翻译缓存。</p>
<p><strong>小提示</strong></p>
<ul>
<li><p>为了保证 uiautomator 的稳定性，当你在使用 uiautomator 时，必须关掉设备上的所有动画效果（你可以通过下面的设置完成：Settings &gt; Developer options &gt; Window animation|Transition animation|Animator duration scale）</p>
</li>
<li><p>如果你想打 Log 方便你的调试，你可以使用 android.util.Log。为了更好地区分 Log 信息，你可以使用特定的标记来筛选它们。</p>
</li>
<li><p>每一次你需要在 View 的不同层级间切换都要使用 uiautomatorviewer。因为它能为你提供一个精确的选择器，使你能够获得目标 UI 界面元素（uiautomatorviewer 在 sdk/tools/uiautomatorviewer 里）。</p>
</li>
<li><p>记住，uiautomator 测试用例不是 Android 的测试用例，所以你不需要使用任何形式的 Context。</p>
</li>
<li><p>你不能通过 uiautomator 进入你的 App 类，你只能引用 Android 框架中的类。</p>
</li>
<li><p>你可以在命令行中使用 -e 命令把 uiautomator 命令行的参数传递到测试用例类中，又或者是使用测试用例类中的 UiAutomatorTestCase.html#getParams()。</p>
</li>
</ul>
<p>这样处理下来，你会发现自动完成语言的切换很简单对吧？uiautomator 虽然是个很好的工具，但如果你的 App 不是可访问的，它就没什么用了。特别是你的 App 需要创建完全自定义的 View 时，就可能会出现各种问题，所以接下来我们要解决的问题就是让 App 可以被访问，特别是自定义 View。</p>
<h2 id="让自定义-View-可访问"><a href="#让自定义-View-可访问" class="headerlink" title="让自定义 View 可访问"></a>让自定义 View 可访问</h2><p>可访问性对一个 App 来说非常重要，其作用主要体现在两个方面：有些用户/开发者需要它（但总有开发者会忽略这个需求），此外，uiautomator 都以可访问性为基础，也就是说，如果一个应用不能提供可访问的入口，我们将无法在其中使用 uiautomator 自动化测试工具。</p>
<p>大部分情况下，你都没有必要让你的 App 可以被其他应用访问。但事实上，大部分 View 都是可访问的，例如 TextView，ListView 等等。不过在你使用自定义 View 时，获得访问性可能会麻烦点，因为这需要你花费一些功夫去改变其中的代码。</p>
<p>在 Capitaine Train App 里，为了满足对日历视图的特殊需求，我们创建了一个自定义 View。这个 View 是基于 ListView 设计的，ListView 中的每一项都有好几个自定义 View，并且每一个自定义 View 都代表一个月（我们称为 MonthView）。MonthView 是一个纯粹的 View，它继承于 View，并没有子类。这样使得 MonthView 中的一切都需要通过 onDraw() 方法进行绘制。因此，MonthView 在默认情况下不能被访问。</p>
<p>首先要做的事情很简单：使用 View#setContentDescription 方法为每一个 MonthView 设置内容描述，这样我们能够把 ListView 滚动到一个特殊的月份上。</p>
<p>然后，一旦 ListView 停留在某一个给定的月份上，我们希望我们能够选择一个确定的日期。为了实现这个需求，我们需要使 MonthView 的内容是可访问的。幸运的是，Android 的支持库在类似的处理上提供了一个很有用的 Helper类：ExploreByTouchHelper。由于 MonthView 不是以树形结构结合展示其中的 View 集合，所以创建伪树状结构的 View 集合需要基于触摸反馈实现。</p>
<p><strong>为自定义 View 实现 ExploreByTouchHelper</strong></p>
<p>我们有四个方法可以实现：</p>
<ul>
<li><p>getVirtualViewAt(float x, float y)<br>返回参数 x,y处所对应的虚拟 View 的 id。如果对应位置上没有虚拟 View，则返回 ExploreByTouchHelper.INVALID_ID</p>
</li>
<li><p>getVisibleVirtualViews(List<integer> virtualViewIds)<br>将自定义 View 中所有虚拟 View 的 id 添加到 virtualViewIds 数组中。</integer></p>
</li>
<li><p>onPopulateEventForVirtualView(int virtualViewId, AccessibilityEvent event)<br>让虚拟 View 的相关信息可以被访问，例如：文字，内容描述</p>
</li>
<li><p>onPopulateNodeForVirtualView(int virtualViewId, AccessibilityNodeInfo node)<br>让给定结点能够访问虚拟 View 的相关信息，例如文字，内容描述，类名，与父类的关系。如果两者之间产生了交互，你必须在给定结点中说明。</p>
</li>
<li><p>onPerformActionForVirtualView(int virtualViewId, int action, Bundle arguments)<br>在虚拟 View 中实现某种动作（在前面的方法中被指定）</p>
</li>
</ul>
<p>怎么让 ExploreByTouchHelper 的接口变得更简单：</p>
<ul>
<li>创建一个 VirtualView 类去持有虚拟 View 的各种信息，例如：id，文字，内容描述，与父类的关系。</li>
<li>在你的自定义 View 中使用一系列的 VirtualView。尽快初始化它们，并在绘制后更新它们</li>
</ul>
<p>YourAccessibilityTouchHelper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">YourAccessibilityTouchHelper</span> <span class="keyword">extends</span> <span class="title">ExploreByTouchHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YourAccessibilityTouchHelper</span><span class="params">(View forView)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(forView);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getVirtualViewAt</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> VirtualView vw = findVirtualViewByPosition(x, y);</div><div class="line">        <span class="keyword">if</span> (vw == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> ExploreByTouchHelper.INVALID_ID;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> vw.id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">getVisibleVirtualViews</span><span class="params">(List&lt;Integer&gt; virtualViewIds)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mVirtualViews.size(); i++) &#123;</div><div class="line">            mVirtualViews.add(mVirtualViews.get(i).id);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPopulateEventForVirtualView</span><span class="params">(<span class="keyword">int</span> virtualViewId, AccessibilityEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> VirtualDayView vw = findVirtualViewById(virtualViewId);</div><div class="line">        <span class="keyword">if</span> (vw == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        event.getText().add(vw.description);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPopulateNodeForVirtualView</span><span class="params">(<span class="keyword">int</span> virtualViewId, AccessibilityNodeInfoCompat node)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> VirtualDayView vw = findVirtualViewById(virtualViewId);</div><div class="line">        <span class="keyword">if</span> (vw == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        node.setText(Integer.toString(vw.text));</div><div class="line">        node.setContentDescription(vw.description);</div><div class="line">        node.setClassName(vw.className);</div><div class="line">        node.setBoundsInParent(vw.boundsInParent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>在你的自定义 View 中使用 Helper 类</strong></p>
<p>我们需要在 ListView.getView 方法被执行后通过 setAccessibilityDelegate() 方法重设代理，因为我们需要实现 dispatchHoverEvent() 方法来激活对触摸事件的探索。（如果你的自定义 View 没有在 ListView 中被使用的话，只需要在构造器中设置代理）。</p>
<p>YourCustomView.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YourCustomView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> YourAccessibilityTouchHelper mTouchHelper;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">YourCustomView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(context, attrs, defStyle);</div><div class="line">      mTouchHelper = <span class="keyword">new</span> YourAccessibilityTouchHelper(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setAccessibilityDelegate</span><span class="params">()</span> </span>&#123;</div><div class="line">      setAccessibilityDelegate(mTouchHelper);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  [...]</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchHoverEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (mTouchHelper.dispatchHoverEvent(event)) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.dispatchHoverEvent(event);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><strong>用 uiautmatorviewer 检查你的接口能否正常运行</strong></p>
<p>如果一切都正常运行，在你用 uiautmatorviewer 截图后，你应该能在虚拟 View 图层看到在可访问结点中预设置的所有信息。</p>
<p><img src="http://flavienlaurent.com/media/2014-12-05-screenshot_automation/accessibility_calendar_uiautomator.png" alt=""></p>
<p>另一方面，在我写这篇博文的时候我发现 Capitaine Train App里的一个问题：每一个虚拟 View 的类名都是 com.capitainetrain.x，因为我们忘了用 Proguard。</p>
<p>现在 App 中的一切都是可访问的，我们总算可以在 App 中顺利使用 uiautomator 进行自动化截图了。打铁趁热，我们不妨对我们的代码稍作修改，让它能够“优雅地截图”。</p>
<h2 id="优雅地截取图片"><a href="#优雅地截取图片" class="headerlink" title="优雅地截取图片"></a>优雅地截取图片</h2><p>这篇博文要讲解的最后一个问题就是怎么改进 uiautomator ，使得它能在多种语言中优雅地自动截图。实现这个功能需要两个步骤：第一，使用 bash 脚本运行 uiautomator 测试用例，并按照你需要的图片数量进行自动化截图，之后用 imagemagick 处理你获得的照片。</p>
<p>首先要做的就是创建 uiautomator JAR包，然后运行测试用例。因为你已经在前面的讲解中学习了怎么在测试用例中转换语言，所以你只需要传递两个参数到测试用例中：当前设置中使用的语言和你将要切换的语言。</p>
<p>screenshot.sh</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># Build and push the uiautomator JAR</div><div class="line">ant build</div><div class="line">adb push bin/uiautomator.jar data/local/tmp</div><div class="line"></div><div class="line">adb shell uiautomator runtest uiautomator.jar</div><div class="line">  -e current_language $&#123;currentLanguage&#125;</div><div class="line">  -e new_language $&#123;newLanguage&#125;</div><div class="line">  -c com.your.TestCase</div></pre></td></tr></table></figure>
<p>接下来我们只要再创建一个能够切换语言，打开 App并截图的简单测试用例就可以啦：</p>
<p>TestCase.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCase</span> <span class="keyword">extends</span> <span class="title">UiAutomatorTestCase</span> </span>&#123;</div><div class="line">  [...]</div><div class="line">  <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">super</span>.setUp();</div><div class="line">        <span class="keyword">final</span> Bundle params = getParams();</div><div class="line">        mCurrentLanguage = params.getString(<span class="string">"current_language"</span>);</div><div class="line">        mNewLanguage = params.getString(<span class="string">"new_language"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        switchLanguage(mCurrentLanguage, mNewLanguage);</div><div class="line">        openApp();</div><div class="line">        takeScreenshot(<span class="string">"data/local/tmp/screenshots"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>switchLanguage(String,String)只需要使用我在”修改 uiautomator”中讲解的方法就能轻松地实现 </li>
<li>openApp() 在 <a href="https://developer.android.com/tools/testing/testing_ui.html#sample" target="_blank" rel="external">这里</a>有详细的解释</li>
<li>takeScreenshot() 使用了 UiDevice#takeScreenshot 方法。在这里只有一个小提示：如果一个 App 使用了可滚动的 View，在滚动条消失之前我们必须安静地等一会儿，不然的话我们会在最后的截图里看到它。</li>
</ul>
<p>现在截图都被储存在设备里了，我们只需要把它们取出来就大功告成了：</p>
<p>screenshot.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir screenshots</div><div class="line">adb pull data/local/tmp/screenshots screenshots</div></pre></td></tr></table></figure>
<p>在多语言环境中运行测试用例。它会从设备当前使用的语言开始运行，因为我找不到一个合适的方式去表示它，然后会在不同的语言环境下（我们需要截图的那些语言）运行测试用例。</p>
<p>screenshot.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">screenshot() &#123;</div><div class="line">    currentLanguage=$1</div><div class="line">  newLanguage=$2</div><div class="line">  adb shell uiautomator runtest uiautomator.jar</div><div class="line">      -e current_language $&#123;currentLanguage&#125;</div><div class="line">      -e new_language $&#123;newLanguage&#125;</div><div class="line">      -c com.your.TestCase</div><div class="line">&#125;</div><div class="line"></div><div class="line">screenshot $deviceLanguage fr</div><div class="line">screenshot fr en</div><div class="line">screenshot en de</div></pre></td></tr></table></figure>
<p>App 每次卸载/安装后在相同的环境下运行测试用例都能正常地实现自动化截图的功能：</p>
<p>screenshot.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">screenshot() &#123;</div><div class="line">    currentLanguage=$1</div><div class="line">  newLanguage=$2</div><div class="line"></div><div class="line">  # Uninstall/Install the app</div><div class="line">  adb uninstall com.your.app</div><div class="line">  adb install ../app/build/outputs/apk/yourapp-release.apk</div><div class="line">  </div><div class="line">  adb shell uiautomator runtest uiautomator.jar</div><div class="line">      -e current_language $&#123;currentLanguage&#125;</div><div class="line">      -e new_language $&#123;newLanguage&#125;</div><div class="line">      -c com.your.TestCase</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后把所有模块糅合在一起：</p>
<p>screenshot.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">screenshot() &#123;</div><div class="line">  currentLanguage=$1</div><div class="line">  newLanguage=$2</div><div class="line"></div><div class="line">  # Uninstall/Install the app</div><div class="line">  adb uninstall com.your.app</div><div class="line">  adb install ../app/build/outputs/apk/yourapp-release.apk</div><div class="line"></div><div class="line">  # Run the test case</div><div class="line">  adb shell uiautomator runtest uiautomator.jar</div><div class="line">      -e current_language $&#123;currentLanguage&#125;</div><div class="line">      -e new_language $&#123;newLanguage&#125;</div><div class="line">      -c com.your.TestCase</div><div class="line">      </div><div class="line">  mkdir screenshots</div><div class="line">  adb pull data/local/tmp/screenshots screenshots</div><div class="line">&#125;</div><div class="line"></div><div class="line"># Build and push the uiautomator JAR</div><div class="line">ant build</div><div class="line">adb push bin/uiautomator.jar data/local/tmp</div><div class="line"></div><div class="line"># Build the APK</div><div class="line">cd .. &amp;&amp; ./gradlew assembleRelease &amp;&amp; cd uiautomator</div><div class="line"></div><div class="line"># Screenshot everything</div><div class="line">screenshot $currentLanguage fr</div><div class="line">screenshot fr en</div><div class="line">screenshot en de</div></pre></td></tr></table></figure>
<p><strong>美化截图</strong><br>分享一篇好文：<a href="http://cyrilmottier.com/2012/07/11/creating-professional-looking-screenshots/" target="_blank" rel="external">Creating professional looking screenshots</a>。</p>
<p>每一个 App 的运营者都应该尽其所能美化 App 的截图，因为这是用户在应用商店中对 App 的第一印象。大多数情况下，用户都不会阅读应用的描述，而是直接打开应用的截图，因为阅读文字比看图片更费劲。虽然不能说经过下面的处理能获得完美无瑕的图片，但也在水平线以上了。那么什么样的 App 截图是优雅的截图呢？</p>
<ul>
<li><p>始终保持状态栏的整洁</p>
</li>
<li><p>移除导航栏</p>
</li>
<li><p>适配多种屏幕的尺寸</p>
</li>
</ul>
<p>第二点可以用一个超神奇的工具—imagemagick 实现，虽然它的官方文档非常大，但我们用不到那么多的特性，所以我们只需要关注两个特性：组合和转换。</p>
<p><strong>用组合图覆盖状态栏</strong></p>
<p>组合图是用来把一个图片覆盖到另一个上面的，这是获得简洁状态栏的完美办法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composite -quality <span class="number">100</span> -compose atop clean_status_bar.png screenshot.png clean_screenshot.png</div></pre></td></tr></table></figure>
<p><strong>通过转换裁剪导航栏</strong></p>
<p>转换特性被用于转换图片的格式，使其格式与裁剪后的图片相同，这是从截图中移除导航栏的完美办法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">convert -quality <span class="number">100</span> screenshot.png -gravity South -chop <span class="number">0x144</span> clean_screenshot.png</div></pre></td></tr></table></figure>
<p>144是在Nexu5上导航栏的高度像素值。</p>
<p><strong>结论</strong></p>
<p>因为有了这篇博文，通常要花费半天，甚至一天的截图工作现在能通过 Capitaine Train 上用的这个自动化截图工具缩短到 20～30 分钟完成（我相信没有人想手动地做这些工作，或者因为嫌弃这样的工作，从不更新 App 的截图）。这个工具能高效地节省时间，如果能够更多的人和资源投入到这个工具的开发之中，我相信这个工具还能变得更好，也不会那么容易出错和崩溃。</p>
<p>接下来可能做的：</p>
<p>使用 Google Play 发布的 API 简化上传这些自动生成的截图的流程，并把这个工具整合到 Jenkins 里，让 App 每一次版本更新都能自动地获取最新的截图，并将其显示在应用商店中。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/自动化截图－应用分发时的自动截图方案/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/自动化截图－应用分发时的自动截图方案/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Google推荐的图片加载库Glide介绍/" title="Google推荐的图片加载库Glide介绍" itemprop="url">Google推荐的图片加载库Glide介绍</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接:<a href="http://inthecheesefactory.com/blog/get-to-know-glide-recommended-by-google/en" target="_blank" rel="external">Google推荐的图片加载库Glide介绍</a></li>
</ul>
<p>在泰国举行的谷歌开发者论坛上，谷歌为我们介绍了一个名叫 <a href="https://github.com/bumptech/glide" target="_blank" rel="external">Glide</a> 的图片加载库，作者是bumptech。这个库被广泛的运用在google的开源项目中，包括2014年google I/O大会上发布的官方app。</p>
<p>毫无疑问，这个库引起了我的兴趣。于是我花了一个晚上研究和把玩它，将它的实现原理分析清楚以后，我决定写一篇博文分享一些自己的经验。在开始之前我想说，Glide和Picasso有90%的相似度，准确的说，我觉得它就像 Picasso 的克隆体。</p>
<p>不管怎样，Glide 和 Picasso在细节上还是有不少区别的，接下来我会让你们了解到其中的差异。</p>
<p>##导入库</p>
<p>Picasso和Glide都在jcenter上。在项目中添加依赖非常简单：<br>Picasso<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup.picasso:picasso:2.5.1'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Glide<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.github.bumptech.glide:glide:3.5.2'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:support-v4:22.0.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不管怎样，Glide 需要 Android Support Library v4 包，千万不要忘了像上面的代码做的那样添加 Android Support Library v4 包的依赖。不过这都不是什么大问题，因为现在 Android Support Library v4 基本是每一个新 Android 项目的标配了。</p>
<p>##基础</p>
<p>就如我所说的Glide和Picasso非常相似，Glide加载图片的方法和Picasso如出一辙。</p>
<p>Picasso<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Picasso.with(context)</div><div class="line">    .load(<span class="string">"http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg"</span>)</div><div class="line">    .into(ivImg);</div></pre></td></tr></table></figure></p>
<p>Glide</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Glide.with(context)</div><div class="line">    .load(<span class="string">"http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg"</span>)</div><div class="line">    .into(ivImg);</div></pre></td></tr></table></figure>
<p>虽然两者看起来非常相似，但是 Glide 的代码无疑设计得更好，因为 Glide 的 with() 方法不光接受 Context，还接受 Activity 和 Fragment。此外，with() 方法还能自动地从你放入的各种东西里面提取出 Context，供它自己使用。</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427445293711143.png" alt=""></p>
<p>同 时将Activity/Fragment作为with()参数的好处是：图片加载会和Activity/Fragment的生命周期保持一致，比如 Paused状态在暂停加载，在Resumed的时候又自动重新加载。所以我建议传参的时候传递Activity 和 Fragment给Glide，而不是Context。</p>
<p>##默认Bitmap格式是RGB_565</p>
<p>下面是加载图片时和Picasso的比较（1920x1080 像素的图片加载到768x432的ImageView中）</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427445293137409.jpg" alt=""></p>
<p>可以看到Glide加载的图片质量要差于Picasso（ps：我看不出来哈），为什么？这是因为Glide默认的Bitmap格式是RGB_565 ，比ARGB_8888格式的内存开销要小一半。下面是Picasso在ARGB8888下与Glide在RGB565下的内存开销图（应用自身占用了8m，因此以8为基准线比较）：</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427445293965030.png" alt=""></p>
<p>如果你觉得 Glide 在默认的 RGB_565 格式下加载的图片质量可以接受的话，可以什么都不做。但如果你觉得难以接受，或者是你的实际需求对图片的质量有更高的要求的话，你可以像下面的代码那样创建一个 GlideModule 子类，把 Bitmap 的格式转换到 ARGB_8888：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlideConfiguration</span> <span class="keyword">implements</span> <span class="title">GlideModule</span> </span>&#123;</div><div class="line">  </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyOptions</span><span class="params">(Context context, GlideBuilder builder)</span> </span>&#123;</div><div class="line">        <span class="comment">// Apply options to the builder here.</span></div><div class="line">        builder.setDecodeFormat(DecodeFormat.PREFER_ARGB_8888);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerComponents</span><span class="params">(Context context, Glide glide)</span> </span>&#123;</div><div class="line">        <span class="comment">// register ModelLoaders here.</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在AndroidManifest.xml中将GlideModule定义为meta-data</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;meta-data android:name=<span class="string">"com.inthecheesefactory.lab.glidepicasso.GlideConfiguration"</span></div><div class="line">            android:value=<span class="string">"GlideModule"</span>/&gt;</div></pre></td></tr></table></figure>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427445294447874.jpg" alt=""></p>
<p>这样看起来就会好很多。</p>
<p>我们再来看看内存开销图，虽然看起来这次 Glide 的内存开销接近于上次的两倍，但是Picasso的内存开销仍然远大于Glide。</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427445294918728.png" alt=""></p>
<p>但是上面那样做的问题在于你需要手动计算 ImageView 的尺寸，又或者是你对 ImageView 设置了具体的尺寸大小，为了解决这样的麻烦，你可以在 Picasso 中通过这样做简化你的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">    .load(<span class="string">"http://nuuneoi.com/uploads/source/playstore/cover.jpg"</span>)</div><div class="line">    .resize(<span class="number">768</span>, <span class="number">432</span>)</div><div class="line">    .into(ivImgPicasso);</div></pre></td></tr></table></figure>
<p>但是问题在于你需要主动计算ImageView的大小，或者说你的ImageView大小是具体的值（而不是wrap_content），你也可以这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">    .load(<span class="string">"http://nuuneoi.com/uploads/source/playstore/cover.jpg"</span>)</div><div class="line">    .fit()</div><div class="line">    .centerCrop()</div><div class="line">    .into(ivImgPicasso);</div></pre></td></tr></table></figure>
<p>现在Picasso的内存开销就和Glide差不多了。</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427445294433243.png" alt=""></p>
<p>虽然内存开销差距不大，但是在这个问题上Glide完胜Picasso。因为Glide可以自动计算出任意情况下的ImageView大小。</p>
<p>##Image质量的细节</p>
<p>这是将ImageView还原到真实大小时的比较。<br><img src="http://jcodecraeer.com/uploads/20150327/1427445294704430.png" alt=""></p>
<p>很显然，Glide 加载的图片有些像素点变得很模糊，看起来也没有 Picasso 那么平滑。而且直到现在，我也没有找到一个可以直观改变图片大小调整算法的方法。</p>
<p>但是这并不算什么坏事，因为很难察觉。</p>
<p>##磁盘缓存</p>
<p>Picasso和Glide在磁盘缓存策略上有很大的不同。我们刚刚做了一个使用 Glide 和 Picasso 加载同一张高清图片的实验，我在实验后检查缓存目录时发现： Glide 缓存的图片和 ImageView 的尺寸相同，而 Picasso 缓存的图片和原始图片的尺寸相同。</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427445294110987.jpg" alt=""></p>
<p>上面提到的平滑度的问题依然存在，而且如果加载的是RGB565图片，那么缓存中的图片也是RGB565。</p>
<p>我 尝试将ImageView调整成不同大小，但不管大小如何Picasso只缓存一个全尺寸的。Glide则不同，它会为每种大小的ImageView缓存 一次。尽管一张图片已经缓存了一次，但是假如你要在另外一个地方再次以不同尺寸显示，需要重新下载，调整成新尺寸的大小，然后将这个尺寸的也缓存起来。</p>
<p>具体说来就是：假如在第一个页面有一个200x200的ImageView，在第二个页面有一个100x100的ImageView，这两个ImageView本来是要显示同一张图片，却需要下载两次。</p>
<p>不过，你可以改变这种行为，让Glide既缓存全尺寸又缓存其他尺寸：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Glide.with(<span class="keyword">this</span>)</div><div class="line">     .load(<span class="string">"http://nuuneoi.com/uploads/source/playstore/cover.jpg"</span>)</div><div class="line">     .diskCacheStrategy(DiskCacheStrategy.ALL)</div><div class="line">     .into(ivImgGlide);</div></pre></td></tr></table></figure>
<p>下次在任何ImageView中加载图片的时候，全尺寸的图片将从缓存中取出，重新调整大小，然后缓存。</p>
<p>Glide的这种方式优点是加载显示非常快。而Picasso的方式则因为需要在显示之前重新调整大小而导致一些延迟，即便你添加了这段代码来让其立即显示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Picasso</span></div><div class="line">.noFade();</div></pre></td></tr></table></figure></p>
<p><img src="http://jcodecraeer.com/uploads/allimg/150327/163Aa632-0.gif" alt=""></p>
<p>Picasso 和 Glide 在磁盘缓存策略上各有所长，你应该根据自己的需求选择最合适的。</p>
<p>对我而言，我更喜欢Glide，因为它远比Picasso快，虽然需要更大的空间来缓存。</p>
<p>##特性</p>
<p>你可以做到几乎和Picasso一样多的事情，代码也几乎一样。</p>
<p>Image Resizing<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Picasso</span></div><div class="line">.resize(<span class="number">300</span>, <span class="number">200</span>);</div><div class="line">  </div><div class="line"><span class="comment">// Glide</span></div><div class="line">.override(<span class="number">300</span>, <span class="number">200</span>);</div></pre></td></tr></table></figure></p>
<p>Center Cropping<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Picasso</span></div><div class="line">.centerCrop();</div><div class="line">  </div><div class="line"><span class="comment">// Glide</span></div><div class="line">.centerCrop();</div></pre></td></tr></table></figure></p>
<p>Transforming<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Picasso</span></div><div class="line">.transform(<span class="keyword">new</span> CircleTransform())</div><div class="line">  </div><div class="line"><span class="comment">// Glide</span></div><div class="line">.transform(<span class="keyword">new</span> CircleTransform(context))</div></pre></td></tr></table></figure></p>
<p>设置占位图或者加载错误图：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Picasso</span></div><div class="line">.placeholder(R.drawable.placeholder)</div><div class="line">.error(R.drawable.imagenotfound)</div><div class="line">  </div><div class="line"><span class="comment">// Glide</span></div><div class="line">.placeholder(R.drawable.placeholder)</div><div class="line">.error(R.drawable.imagenotfound)</div></pre></td></tr></table></figure></p>
<p>正如我在博文开头所说，如果你已经熟悉如何使用 Picasso，那从Picasso转换到Glide对你来说就是小菜一碟。</p>
<p>##有什么Glide可以做而Picasso 做不到</p>
<p>Glide可以加载GIF动态图，而Picasso不能。</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427445366503084.gif" alt=""></p>
<p>同时因为Glide和Activity/Fragment的生命周期是一致的，因此gif的动画也会自动的随着Activity/Fragment的状态暂停、重放。Glide 的缓存在gif这里也是一样，调整大小然后缓存。</p>
<p>但是从我的一次测试结果来看，用 Glide 显示动画会消耗很多内存，因此谨慎使用。</p>
<p>除了gif动画之外，Glide还可以将任意本地视频解码成一张静态图片。</p>
<p>还有一个特性是你可以配置图片显示的动画，而Picasso只有一种动画：fading in。</p>
<p>最后一个是可以使用thumbnail()产生一个你所加载图片的thumbnail。</p>
<p>其实还有一些特性，不过不是非常重要，比如将图像转换成字节数组等。<br>配置</p>
<p>有许多可以配置的选项，比如大小，缓存的磁盘位置，最大缓存空间，位图格式等等。可以在这个页面查看这些配置 Configuration 。</p>
<p>##库的大小</p>
<p>Picasso (v2.5.1)的大小约118kb，而Glide (v3.5.2)的大小约430kb。</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427453389115686.png" alt=""></p>
<p>不过312kb的差距并不是很重要。</p>
<p>Picasso和Glide的方法个数分别是840和2678个。</p>
<p><img src="http://jcodecraeer.com/uploads/20150327/1427453390188737.png" alt=""></p>
<p>必须指出，对于DEX文件65535个方法的限制来说，2678是一个相当大的数字了。建议在使用Glide的时候开启ProGuard。</p>
<p>##总结</p>
<p>Glide和Picasso都是非常完美的库。Glide加载图像以及磁盘缓存的方式都要优于Picasso，速度更快，并且Glide更有利于减少OutOfMemoryError的发生，GIF动画是Glide的杀手锏。不过Picasso的图片质量更高。你更喜欢哪个呢？</p>
<p>虽然我使用了很长时间的Picasso，但是我得承认现在我更喜欢Glide。我的建议是使用Glide，但是将Bitmap格式换成 ARGB_8888、让Glide缓存同时缓存全尺寸和改变尺寸两种。</p>
<p>##相关资源</p>
<ul>
<li><a href="http://google-opensource.blogspot.com/2014/09/glide-30-media-management-library-for.html" target="_blank" rel="external">Glide 3.0: a media management library for Android</a> </li>
<li><a href="https://github.com/bumptech/glide/wiki" target="_blank" rel="external">Glide Wiki</a> </li>
<li><a href="http://pluu.github.io/android%20study/2015/01/15/android-glide-picasso/" target="_blank" rel="external">Android Picasso vs Glide</a> </li>
<li><a href="http://vardhan-justlikethat.blogspot.com/2014/09/android-image-loading-libraries-picasso.html" target="_blank" rel="external">Android: Image loading libraries Picasso vs Glide</a> </li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Google推荐的图片加载库Glide介绍/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Google推荐的图片加载库Glide介绍/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Gradle小知识1/" title="Gradle小知识#1：tasks" itemprop="url">Gradle小知识#1：tasks</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li><p>原文链接 : <a href="http://trickyandroid.com/gradle-tip-1-tasks/" target="_blank" rel="external">Gradle tip #1: tasks</a></p>
<p>​</p>
</li>
</ul>
<p>从这篇博文开始我打算开启关于Gradle相关知识的一些列博文。现在想想，如果我刚开始接触Gradle的时候知道这些知识的话那该多好啊。 </p>
<p>今天我们来聊聊Gradle的<strong>任务</strong>，尤其是任务的配置和执行部分。因为这块知识对很多读者来说还不是很清楚，所以通过一个真实的例子来说明下就再好不过了。大体上(抱歉有点超前)我们是想要弄清楚下面这三个例子到底有啥区别：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> myTask &#123;</div><div class="line">    <span class="keyword">println</span> <span class="string">"Hello, World!"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">task</span> myTask &#123;</div><div class="line">    <span class="keyword">doLast</span> &#123;</div><div class="line">        <span class="keyword">println</span> <span class="string">"Hello, World!"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">task</span> myTask &lt;&lt; &#123;</div><div class="line">    <span class="keyword">println</span> <span class="string">"Hello, World!"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我的目的是创建一个任务，当这个任务被执行的时候它能打印”Hello， World!”。一开始，我是这样实现的：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> myTask &#123;</div><div class="line">    <span class="keyword">println</span> <span class="string">"Hello, World!"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们执行下这个任务！</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">user$ gradle myTask</div><div class="line">Hello, World!</div><div class="line">:myTask UP-TO-DATE</div></pre></td></tr></table></figure>
<p>这好像没啥问题。正确的打印出了“Hello, World!”<br><strong>但是，</strong>这并没有按照我们预想的那样工作。下面让我告诉你为什么。我们试着调用下<code>gradle tasks</code>看看还有其他什么能执行的任务没：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">user$ gradle tasks</div><div class="line">Hello, World!</div><div class="line">:tasks</div><div class="line"></div><div class="line">------------------------------------------------------------</div><div class="line">All tasks runnable <span class="keyword">from</span> root <span class="keyword">project</span></div><div class="line">------------------------------------------------------------</div><div class="line"></div><div class="line">Build Setup tasks</div><div class="line">-----------------</div><div class="line">init - Initializes a <span class="keyword">new</span> Gradle build. [incubating]</div><div class="line">..........</div></pre></td></tr></table></figure>
<p>等等！为什么打印了”Hello, World!”？我只是调用了<code>tasks</code>，我并没有调用我定义的任务呀！</p>
<p>原因就是在Gradle<code>任务</code>的生命周期中，有两个重要的阶段：</p>
<ul>
<li>配置阶段</li>
<li>执行阶段</li>
</ul>
<p>我对这些专业术语可能不太熟悉，但类比一下可以帮助我更好的理解Gradle的任务。</p>
<p>事情是这样的，Gradle在真正进行构建<strong>之前</strong>，<strong>必须把构建脚本中定义的所有任务配置一下</strong>。不管这个任务会不会被执行，它都要先配置一下。</p>
<p>既然了解了这一点，但我又该怎么知道任务中哪部分是在配置阶段执行，哪部分又是在执行阶段执行呢？答案就是：任务中的顶层部分是<strong>配置阶段</strong>会执行的代码。比如：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> myTask &#123;</div><div class="line">    <span class="keyword">def</span> name = <span class="string">"Pavel"</span> <span class="comment">//&lt;-- this is evaluated during configuration</span></div><div class="line">    <span class="keyword">println</span> <span class="string">"Hello, World!"</span><span class="comment">////&lt;-- this is also evaluated during configuration</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这就是为什么我只是调用了<code>gradle tasks</code>，但却打印了”Hello, World!”。因为这部分代码在配置阶段执行了。但这并不是我想要的。我想要的是这段代码只有在我调用我的任务的时候才去执行。</p>
<p>那么，我该怎么告诉Gradle当我执行我的任务的时候才去做一些事情呢？</p>
<p>这时我就需要给任务指定一个动作。最简单的做法就是通过<a href="https://www.gradle.org/docs/current/dsl/org.gradle.api.Task.html#org.gradle.api.Task:doLast(groovy.lang.Closure" target="_blank" rel="external">Task#doLast()</a>)方法：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> myTask &#123;</div><div class="line">    <span class="keyword">def</span> text = <span class="string">'Hello, World!'</span> <span class="comment">//configure my task</span></div><div class="line">    <span class="keyword">doLast</span> &#123;</div><div class="line">        <span class="keyword">println</span> text <span class="comment">//this is executed when my task is called</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，”Hello, World!”只有在我显式的调用<code>gradle myTask</code>的时候才会打印出来。</p>
<p>Cool！现在我知道怎么配置任务并且让任务只有在我明确调用的时候才会做真正的工作。那么第三个例子中的<code>&lt;&lt;</code>又是啥？：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">task myTask2 &lt;&lt; &#123;</div><div class="line">    println &quot;Hello, World!&quot; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这只是<code>doLast</code>的简写版本而已。这跟下面的写法完全一样：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> myTask &#123;</div><div class="line">    <span class="keyword">doLast</span> &#123;</div><div class="line">        <span class="keyword">println</span> <span class="string">'Hello, World!'</span> <span class="comment">//this is executed when my task is called</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是，既然所有的代码都在执行部分了，那我就不能像<code>doLast</code>写法那样配置我的任务了(放心吧，还是可以的，只是稍微有点不同而已)。这种简写方式对那些不需要进行配置的小任务来说很方便。但是，如果你的任务不仅仅像打印”Hello, World!”这么简单的话，那还是建议考虑使用<code>doLast</code>这种写法。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Gradle小知识1/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Gradle小知识1/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Gradle小知识2/" title="Gradle小知识#2：学学语法" itemprop="url">Gradle小知识#2：学学语法</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://trickyandroid.com/gradle-tip-2-understanding-syntax/" target="_blank" rel="external">Gradle tip #2: understanding syntax</a></li>
</ul>
<p>在第一部分，我们聊了下Gradle中的任务以及构建过程中的不同阶段。但是，在我发布上篇文章之后我意识到在继续深入Gradle之前，我们最好了解下Gradle的语法。以免被复杂的<code>build.gradle</code>脚本吓到。所以这篇我们来聊聊Gradle的语法。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>Gradle构建脚本是使用<a href="http://www.groovy-lang.org/" target="_blank" rel="external">Groovy</a>语言写的。所以在继续深入之前我想说几个Groovy中比较重要的概念。Groovy的语法跟Java语法很类似，所以希望你在理解上不会有大问题。 </p>
<p>如果你对Groovy比较熟悉，那你可以跳过这部分。</p>
<p>要理解Gradle脚本，你需要明白Groovy中很重要的一个概念——闭包。</p>
<h4 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h4><p>要理解Gradle就必须搞明白<a href="http://www.groovy-lang.org/closures.html" target="_blank" rel="external"><code>闭包</code></a>这个重要的概念。闭包是一个独立的代码块，它可以接收参数、可以有返回值，而且还可以赋值给变量。有点像<code>Callable</code>接口、<code>Future</code>和方法指针的混合体，随便你怎么叫。</p>
<p>大体来说就是个代码块，当你调用它的时候它才会执行，而非创建时就执行。下面是一个简单的闭包的例子：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myClosure = &#123; <span class="keyword">println</span> <span class="string">'Hello world!'</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">//execute our closure</span></div><div class="line">myClosure()</div><div class="line"></div><div class="line">#output: Hello world!</div></pre></td></tr></table></figure>
<p>亦或是接收一个参数的闭包：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myClosure = &#123;String str -&gt; <span class="keyword">println</span> str &#125;</div><div class="line"></div><div class="line"><span class="comment">//execute our closure</span></div><div class="line">myClosure(<span class="string">'Hello world!'</span>)</div><div class="line"></div><div class="line">#output: Hello world!</div></pre></td></tr></table></figure>
<p>如果闭包只有一个参数，那这个参数可以通过<code>it</code>来引用：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myClosure = &#123;<span class="keyword">println</span> it &#125;</div><div class="line"></div><div class="line"><span class="comment">//execute our closure</span></div><div class="line">myClosure(<span class="string">'Hello world!'</span>)</div><div class="line"></div><div class="line">#output: Hello world!</div></pre></td></tr></table></figure>
<p>接收多个参数的闭包：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myClosure = &#123;String str, <span class="keyword">int</span> num -&gt; <span class="keyword">println</span> <span class="string">"$str : $num"</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">//execute our closure</span></div><div class="line">myClosure(<span class="string">'my string'</span>, <span class="number">21</span>)</div><div class="line"></div><div class="line">#output: my string : <span class="number">21</span></div></pre></td></tr></table></figure>
<p>顺便插一句，闭包的参数类型是可选的。所以上面的例子可以简写成下面这样：  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myClosure = &#123;str, num -&gt; <span class="keyword">println</span> <span class="string">"$str : $num"</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">//execute our closure</span></div><div class="line">myClosure(<span class="string">'my string'</span>, <span class="number">21</span>)</div><div class="line"></div><div class="line">#output: my string : <span class="number">21</span></div></pre></td></tr></table></figure>
<p>闭包可以引用它所在上下文环境中的变量，这一点非常酷。这个上下文环境默认是闭包被创建时所在的类：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myVar = <span class="string">'Hello World!'</span></div><div class="line"><span class="keyword">def</span> myClosure = &#123;<span class="keyword">println</span> myVar&#125;</div><div class="line">myClosure()</div><div class="line"></div><div class="line">#output: Hello world!</div></pre></td></tr></table></figure>
<p>另一个比较酷的特性是：闭包的上下文环境可以通过<code>Closure#setDelegate()</code>进行改变。这个特性在以后会非常重要：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myClosure = &#123;<span class="keyword">println</span> myVar&#125; <span class="comment">//I'm referencing myVar from MyClass class</span></div><div class="line">MyClass m = <span class="keyword">new</span> MyClass()</div><div class="line">myClosure.setDelegate(m)</div><div class="line">myClosure()</div><div class="line"></div><div class="line"><span class="keyword">class</span> MyClass &#123;</div><div class="line">    <span class="keyword">def</span> myVar = <span class="string">'Hello from MyClass!'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">#output: Hello <span class="keyword">from</span> MyClass!</div></pre></td></tr></table></figure>
<p>如你所见，在我们创建闭包的时候，<code>myVar</code>变量还不存在。但这都不是事，只要我们执行闭包的时候，它存在于闭包的上下文环境中就行。</p>
<p>在这个例子中，在闭包执行之前，我修改了闭包的上下文环境。所以<code>myVar</code>就可以被引用到了。  </p>
<h4 id="把闭包当做参数来传递"><a href="#把闭包当做参数来传递" class="headerlink" title="把闭包当做参数来传递"></a>把闭包当做参数来传递</h4><p>闭包的真正好处是：你可以把它当做参数传递给不同的方法。这可以帮助我们解耦执行逻辑。</p>
<p>其实前面我们已经使用过这个特性了。接下来我们详细说下方法接收闭包作为参数时的调用方式：</p>
<ol>
<li>如果方法接收一个闭包参数<br><code>myMethod(myClosure)</code></li>
<li>如果方法只接收一个参数而且这个参数是闭包，那么圆括弧可以省略：<br><code>myMethod myClosure</code></li>
<li>也可以以内联的方式调用闭包<br><code>myMethod {println &#39;Hello World&#39;}</code></li>
<li>接收两个参数的方法<br><code>myMethod(arg1, myClosure)</code></li>
<li>或者跟‘4’一样，但是闭包是内联的<br><code>myMethod(arg1, { println &#39;Hello World&#39; })</code></li>
<li>如果最后一个参数是闭包，那就可以把它移到圆括弧外面<br><code>myMethod(arg1) { println &#39;Hello World&#39; }</code>  </li>
</ol>
<p>尤其要注意下‘3’和‘6’，是否看起来有点眼熟？  </p>
<h3 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h3><p>了解到这里也差不多了，下面我们结合真实的Gradle脚本来演示下，这也能让我们更好的理解上面讲到的东西：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">buildscript</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">dependencies</span> &#123;</div><div class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:1.2.3'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">allprojects</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>瞅瞅！知道Groovy语法的话就大概能理解上面那些代码是啥意思了！</p>
<ul>
<li>在某个地方定义了一个<code>buildscript</code>方法，并且这个方法接收一个闭包：<br><code>def buildscript(Closure closure)</code></li>
<li>在某个地方定义了一个<code>allprojects</code>方法，并且这个方法接收一个闭包：<br><code>def allprojects(Closure closure)</code></li>
</ul>
<p>….等等等等。</p>
<p>挺不错的嘛，但仅仅知道这些并没多大用。在某个地方又是啥意思？我想知道定义这个方法的确切位置。</p>
<p>问题的答案就是-<a href="https://docs.gradle.org/current/dsl/org.gradle.api.Project.html" target="_blank" rel="external">Project</a>  </p>
<h3 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h3><p>Project是理解Gradle脚本的关键：  </p>
<blockquote>
<p>构建脚本中所有的顶级语句都会被代理到<code>Project</code>实例上。</p>
</blockquote>
<p>这就意味着我们要从<a href="https://docs.gradle.org/current/dsl/org.gradle.api.Project.html" target="_blank" rel="external">Project</a>开始找起。  </p>
<p>我们先试着查找下<code>buildscript</code>方法。  </p>
<p>如果我们查找<code>buildscript</code>就会找到<a href="https://docs.gradle.org/current/dsl/org.gradle.api.Project.html#org.gradle.api.Project:buildscript(groovy.lang.Closure" target="_blank" rel="external">buildscript {}</a>)脚本块。但是脚本块又是个什么鬼？<a href="https://docs.gradle.org/current/dsl/" target="_blank" rel="external">官方文档</a>是这么解释的：  </p>
<blockquote>
<p>脚本块就是接收一个闭包为参数的回调方法。  </p>
</blockquote>
<p>没错，就是它了。当我们调用<code>buildscript</code>方法的时候，就是调用了<code>buildscript { ... }</code>脚本块，它接收一个闭包作为参数。  </p>
<p>如果我们继续查阅<code>buildscript</code>文档，有这么一句话：<em>从buildscript代理到<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/initialization/dsl/ScriptHandler.html" target="_blank" rel="external">ScriptHandler</a>。</em>也就是说在执行阶段，作为参数穿进去的闭包会被变成ScriptHandler。在我们的例子中，我们传递了执行<code>repositories(Closure)</code> 和 <code>dependencies(Closure)</code> 方法的闭包。既然闭包会被代理到<code>ScriptHandler</code>上，那就在<code>ScriptHandler</code>类中查下<code>dependencies</code>方法。  </p>
<p>我们找到了<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/initialization/dsl/ScriptHandler.html#dependencies(groovy.lang.Closure" target="_blank" rel="external">void dependencies(Closure configureClosure)</a>)，文档的解释是：给脚本配置依赖。这里我们又碰到个术语：在DependencyHandler上执行给定闭包。这跟<strong>代理到某某某</strong>是一个意思——这个闭包将会在另外一个类的作用域内执行。(在我们的例子中就是<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/artifacts/dsl/DependencyHandler.html" target="_blank" rel="external">DependencyHandler</a>)  </p>
<blockquote>
<p>“<strong>代理到某某某</strong>“和”<strong>配置某某某</strong>“这两句话完全是一个意思——闭包会在某个指定的类上执行。  </p>
</blockquote>
<p>Gradle中大量用到这种代理策略，所以理解这个术语非常重要。  </p>
<p>让我们把剩下的讲完，我们来看看在<code>DependencyHandler</code>上下文中执行<code>{classpath &#39;com.android.tools.build:gradle:1.2.3&#39;}</code>闭包会发生什么。文档中是这么描述的：用给定的配置来配置依赖。语法是：<code>&lt;configurationName&gt; &lt;dependencyNotation1&gt;</code>  </p>
<p>所以我们的闭包就是用<code>classpath</code>这个配置把<code>com.android.tools.build:gradle:1.2.3</code>配置为依赖。  </p>
<h3 id="脚本块"><a href="#脚本块" class="headerlink" title="脚本块"></a>脚本块</h3><p><code>Project</code>中默认定义了一些脚本块，但是你可以通过Gradle插件定义新的脚本块。  </p>
<p>这就意味着如果你在你的构建脚本中看到类似<code>something { ... }</code>的代码，但你却在文档中找不到这个脚本块或者类似的接收闭包的方法。很可能就是你使用了某个插件，这个插件定义了这个脚本块。  </p>
<h4 id="android脚本块"><a href="#android脚本块" class="headerlink" title="android脚本块"></a><code>android</code>脚本块</h4><p>我们来看一眼Android项目的默认构建脚本，它位于项目的<code>app/build.gradle</code>路径中：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;com.android.application&apos;</div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 22</div><div class="line">    buildToolsVersion &quot;22.0.1&quot;</div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId &quot;com.trickyandroid.testapp&quot;</div><div class="line">        minSdkVersion 16</div><div class="line">        targetSdkVersion 22</div><div class="line">        versionCode 1</div><div class="line">        versionName &quot;1.0&quot;</div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled false</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，好像应该有一个叫<code>android</code>的方法，这个方法接收一个闭包作为参数。但是，如果我们在<code>Project</code>文档中找不到这个方法。原因很简单，Project中本来就没有这个方法。 </p>
<p>如果你仔细看看构建脚本，你会发现在执行<code>android</code>方法之前，我们使用了<code>com.android.application</code>插件！这就是问题的答案了！Android应用插件继承了<code>Project</code>，定义了<code>android</code>脚本块(接收闭包作为参数并且代理到<code>AppExtension</code>类<a href="http://trickyandroid.com/gradle-tip-2-understanding-syntax/#fn:1" target="_blank" rel="external">1</a>)  </p>
<p>那我们去哪找Android插件的文档呢？你可以去<a href="https://developer.android.com/tools/building/plugin-for-gradle.html" target="_blank" rel="external">Android工具网</a>的官网下载这个文档，或者用这个<a href="https://developer.android.com/shareables/sdk-tools/android-gradle-plugin-dsl.zip" target="_blank" rel="external">下载链接</a>直接下载。  </p>
<p>如果我们打开<code>AppExtension</code>文档看看，我们我可找到所有在构建脚本中看到的方法和属性：</p>
<ol>
<li><code>compileSdkVersion 22</code>。如果搜索下<code>compileSdkVersion</code>就能找到这个属性。上面的例子中给这个属性赋值<code>22</code>  </li>
<li><code>buildToolsVersion</code>也是类似的  </li>
<li><code>defaultConfig</code>是个脚本块，它被代理给了<code>ProductFlavor</code>类  </li>
<li>等等……  </li>
</ol>
<p>现在我们就能理解Gradle构建脚本的语法并且会查阅文档了。  </p>
<p>###练习<br>学了这么多新技能，接下来我们来操练操练，试着重新配置下一些东西。</p>
<p>在<code>AppExtension</code>中我发现了<code>testOptions</code>脚本块，它的闭包被代理到<code>TestOptions</code>类。查看<code>TestOptions</code>类，我们发现它有两个属性：<code>reportDir</code>和<code>resultsDir</code>。根据文档的解释：<code>reportDir</code>的作用是制定测试报告的存储路径。我们更改下它的值！</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">......</div><div class="line">    testOptions &#123;</div><div class="line">        reportDir <span class="string">"$rootDir/test_reports"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里使用了<code>Project</code>的<code>rootDir</code>属性，它指向工程的根目录。  </p>
<p>所以，如果我们现在执行<code>./gradlew connectedCheck</code>,测试报告就会被存放到<code>[rootProject]/test_reports</code>目录底下。  </p>
<p>为了避免破坏了你的项目结构，千万不要在你的实际项目中这么干。因为所有的构建内容默认都会存放在<code>build</code>目录中。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Gradle小知识2/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Gradle小知识2/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Gradle小知识3/" title="Gradle小知识#3：任务的顺序" itemprop="url">Gradle小知识#3：任务的顺序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://trickyandroid.com/gradle-tip-3-tasks-ordering/" target="_blank" rel="external">Gradle tip #3: Tasks ordering</a></li>
</ul>
<p>我发现在使用Gradle的过程中遇到的很多问题都跟任务的顺序有关系，不管是已经存在的任务还是我自定义的任务。很显然，如果任务能在正确的时间执行的话，构建任务就能更好的工作了。</p>
<p>所以让我们深入了解下怎么更改任务的执行上顺序这个问题。</p>
<h3 id="dependsOn"><a href="#dependsOn" class="headerlink" title="dependsOn"></a>dependsOn</h3><p>我觉得让某个任务在另一个任务之后执行的最简单的方法就是使用<a href="https://docs.gradle.org/current/dsl/org.gradle.api.Task.html#org.gradle.api.Task:dependsOn(java.lang.Object[]" target="_blank" rel="external"><code>dependsOn</code></a>)方法。  </p>
<p>假设有一个任务<code>A</code>，现在我们要添加一个任务<code>B</code>并且任务<code>B</code>只有在任务<code>A</code>执行后它才会执行：  </p>
<p><img src="http://trickyandroid.com/content/images/2015/07/1-3.png" alt="">  </p>
<p>先来定义两个任务，任务<code>A</code>和<code>B</code>：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> A &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from A'</span>&#125;</div><div class="line"><span class="keyword">task</span> B &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from B'</span>&#125;</div></pre></td></tr></table></figure>
<p>然后你要做的就是告诉Gradle任务<code>B</code>依赖于任务<code>A</code></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">B.dependsOn A</div></pre></td></tr></table></figure>
<p>这样不管什么时候我执行任务<code>B</code>，Gradle也会执行任务<code>A</code></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">paveldudka$ gradle B</div><div class="line">:A</div><div class="line">Hello <span class="keyword">from</span> A</div><div class="line">:B</div><div class="line">Hello <span class="keyword">from</span> B</div></pre></td></tr></table></figure>
<p>另外，你也可以在任务的配置部分声明类似的依赖关系：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> A &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from A'</span>&#125;</div><div class="line"><span class="keyword">task</span> B &#123;</div><div class="line">    dependsOn A</div><div class="line">    <span class="keyword">doLast</span> &#123;</div><div class="line">        <span class="keyword">println</span> <span class="string">'Hello from B'</span>  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>效果是一样的。  </p>
<p>但是如果想把我们的任务插入到已经存在的任务流中该怎么做？  </p>
<p><img src="http://trickyandroid.com/content/images/2015/07/2.png" alt="">   </p>
<p>步骤基本是一样的。  </p>
<p>原本的任务流程是这样的：  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> A &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from A'</span>&#125;</div><div class="line"><span class="keyword">task</span> B &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from B'</span>&#125;</div><div class="line"><span class="keyword">task</span> C &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from C'</span>&#125;</div><div class="line"></div><div class="line">B.dependsOn A</div><div class="line">C.dependsOn B</div></pre></td></tr></table></figure>
<p>我们的新任务是这样的：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> B1 &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from B1'</span>&#125;</div><div class="line">B1.dependsOn B</div><div class="line">C.dependsOn B1</div></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">paveldudka$ gradle C</div><div class="line">:A</div><div class="line">Hello <span class="keyword">from</span> A</div><div class="line">:B</div><div class="line">Hello <span class="keyword">from</span> B</div><div class="line">:B1</div><div class="line">Hello <span class="keyword">from</span> B1</div><div class="line">:C</div><div class="line">Hello <span class="keyword">from</span> C</div></pre></td></tr></table></figure>
<p>可以看到<strong>dependsOn</strong>方法把新任务添加到一个依赖序列当中去了。因此一个任务依赖多个任务也是完全可以的：  </p>
<p><img src="http://trickyandroid.com/content/images/2015/07/3.png" alt="">  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> B1 &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from B1'</span>&#125;</div><div class="line">B1.dependsOn B</div><div class="line">B1.dependsOn Q</div></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">paveldudka$ gradle B1</div><div class="line">:A</div><div class="line">Hello <span class="keyword">from</span> A</div><div class="line">:B</div><div class="line">Hello <span class="keyword">from</span> B</div><div class="line">:Q</div><div class="line">Hello <span class="keyword">from</span> Q</div><div class="line">:B1</div><div class="line">Hello <span class="keyword">from</span> B1</div></pre></td></tr></table></figure>
<h3 id="mustRunAfter"><a href="#mustRunAfter" class="headerlink" title="mustRunAfter"></a>mustRunAfter</h3><p>想象一下我们的任务依赖其他两个任务。下面我会使用一个更真实点的例子。假如我有一个任务执行单元测试，另一个任务做UI测试，还有一个任务单元测试和UI测试都做：  </p>
<p><img src="http://trickyandroid.com/content/images/2015/07/4.png" alt="">  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> unit &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from unit tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> ui &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from UI tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> tests &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from all tests!'</span>&#125;</div><div class="line"></div><div class="line">tests.dependsOn unit</div><div class="line">tests.dependsOn ui</div></pre></td></tr></table></figure>
<p>输出： </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">paveldudka$ gradle tests</div><div class="line">:ui</div><div class="line">Hello <span class="keyword">from</span> UI tests</div><div class="line">:unit</div><div class="line">Hello <span class="keyword">from</span> unit tests</div><div class="line">:tests</div><div class="line">Hello <span class="keyword">from</span> all tests!</div></pre></td></tr></table></figure>
<p>尽管<code>unit</code>任务和<code>UI</code>测试任务会在<code>tests</code>任务之前执行，但是<code>unit</code>和<code>UI</code>这两个任务的执行顺序并不确定。现在我猜测他们是按照字母表的顺序执行的，但这种行为只是通过实践而猜测出来的，你不应该依赖于这种猜测。  </p>
<p>我们知道UI测试的执行时间要比单元测试的执行时间长的多，所以我想让单元测试的任务先执行，只有单元测试执行正确然后才执行UI测试的任务。那么我应该怎么做才能达到这样的效果，即单元测试任务在UI测试任务之前执行？  </p>
<p><img src="http://trickyandroid.com/content/images/2015/07/5.png" alt="">  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> unit &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from unit tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> ui &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from UI tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> tests &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from all tests!'</span>&#125;</div><div class="line"></div><div class="line">tests.dependsOn unit</div><div class="line">tests.dependsOn ui</div><div class="line">ui.dependsOn unit <span class="comment">// &lt;-- I added this dependency</span></div></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">paveldudka$ gradle tests</div><div class="line">:unit</div><div class="line">Hello <span class="keyword">from</span> unit tests</div><div class="line">:ui</div><div class="line">Hello <span class="keyword">from</span> UI tests</div><div class="line">:tests</div><div class="line">Hello <span class="keyword">from</span> all tests!</div></pre></td></tr></table></figure>
<p>这样写单元测试就会在UI测试之前执行了！还不错！  </p>
<p><strong>但是！</strong> 这样写有一个比较恶心的问题！UI测试其实并不会依赖于单元测试。我想要UI测试可以单独的执行，但是现在的情况是每次我想执行UI测试的任务，单元测试的任务也会被执行！    </p>
<p><a href="https://docs.gradle.org/current/dsl/org.gradle.api.Task.html#org.gradle.api.Task:mustRunAfter(java.lang.Object[]" target="_blank" rel="external"><code>mustRunAfter</code></a>)就可以解决这样的问题。它通过方法参数告诉Gradle该任务在哪个任务<code>之后</code>执行。因此，我们不需要为单元测试和UI测试指定依赖关系，而是当他们两个任务同时执行的时候，会给单元测试更高的执行优先级。这样单元测试就先于UI测试执行了：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> unit &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from unit tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> ui &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from UI tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> tests &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from all tests!'</span>&#125;</div><div class="line"></div><div class="line">tests.dependsOn unit</div><div class="line">tests.dependsOn ui</div><div class="line">ui.mustRunAfter unit</div></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">paveldudka$ gradle tests</div><div class="line">:unit</div><div class="line">Hello <span class="keyword">from</span> unit tests</div><div class="line">:ui</div><div class="line">Hello <span class="keyword">from</span> UI tests</div><div class="line">:tests</div><div class="line">Hello <span class="keyword">from</span> all tests!</div></pre></td></tr></table></figure>
<p>现在依赖关系就是这样的了：  </p>
<p><img src="http://trickyandroid.com/content/images/2015/07/6.png" alt="">  </p>
<p>可以看到UI测试和单元测试没有显式的依赖关系！现在如果我单独执行UI测试，单元测试就不会被执行。</p>
<blockquote>
<p>需要注意的是： 在Gradle2.4中<code>mustRunAfter</code>被标记为<em>“测试的”</em>。这就意味着这个特性是个试验性质的，它的行为在将来的版本中可能被修改。</p>
</blockquote>
<h3 id="finalizedBy"><a href="#finalizedBy" class="headerlink" title="finalizedBy"></a>finalizedBy</h3><p>现在我有个可以运行UI测试和单元测试的任务。假如每个测试都会生成一份测试报告，所以我想创建一个任务把这两份测试报告合并成一份：  </p>
<p><img src="http://trickyandroid.com/content/images/2015/07/7.png" alt="">  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> unit &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from unit tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> ui &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from UI tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> tests &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from all tests!'</span>&#125;</div><div class="line"><span class="keyword">task</span> mergeReports &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Merging test reports'</span>&#125;</div><div class="line"></div><div class="line">tests.dependsOn unit</div><div class="line">tests.dependsOn ui</div><div class="line">ui.mustRunAfter unit</div><div class="line">mergeReports.dependsOn tests</div></pre></td></tr></table></figure>
<p>现在如果我想要两个测试的报告，我就会执行<code>mergeReports</code>这个任务：  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">paveldudka$ gradle mergeReports</div><div class="line">:unit</div><div class="line">Hello <span class="keyword">from</span> unit tests</div><div class="line">:ui</div><div class="line">Hello <span class="keyword">from</span> UI tests</div><div class="line">:tests</div><div class="line">Hello <span class="keyword">from</span> all tests!</div><div class="line">:mergeReports</div><div class="line">Merging test reports</div></pre></td></tr></table></figure>
<p>虽然正常运行了，但却有点问题。站在用户(指开发人员)的角度来看，<code>mergeReports</code>好像没啥实际意义。我想执行<code>tests</code>任务就能获得相应的报告。显然，我可以把合并报告的逻辑放在<code>tests</code>任务中，但是我更愿意把<code>mergeReports</code>的逻辑分离出来。  </p>
<p><a href="https://docs.gradle.org/current/dsl/org.gradle.api.Task.html#org.gradle.api.Task:finalizedBy(java.lang.Object[]" target="_blank" rel="external">finalizedBy</a>)方法可以帮你解决这个问题。从它的名字就可以看出，它是某个任务的终结者任务。  </p>
<p>现在我们可以像下面这样修改我们的脚本：  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> unit &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from unit tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> ui &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from UI tests'</span>&#125;</div><div class="line"><span class="keyword">task</span> tests &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Hello from all tests!'</span>&#125;</div><div class="line"><span class="keyword">task</span> mergeReports &lt;&lt; &#123;<span class="keyword">println</span> <span class="string">'Merging test reports'</span>&#125;</div><div class="line"></div><div class="line">tests.dependsOn unit</div><div class="line">tests.dependsOn ui</div><div class="line">ui.mustRunAfter unit</div><div class="line">mergeReports.dependsOn tests</div><div class="line"></div><div class="line">tests.finalizedBy mergeReports</div></pre></td></tr></table></figure>
<p>现在我可以执行<code>tests</code>任务，而且还能得到测试报告：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">paveldudka$ gradle tests</div><div class="line">:unit</div><div class="line">Hello <span class="keyword">from</span> unit tests</div><div class="line">:ui</div><div class="line">Hello <span class="keyword">from</span> UI tests</div><div class="line">:tests</div><div class="line">Hello <span class="keyword">from</span> all tests!</div><div class="line">:mergeReports</div><div class="line">Merging test reports</div></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是：在Gradle2.4中<code>finalizedBy</code>被标记为<em>“测试的”</em>，也就是说这是个实验性质的特性，它的行为在将来的版本中可能会被修改。</p>
</blockquote>
<p>差不多也就这么多内容了。使用这三个方法你就可以很好的控制你的构建过程了。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Gradle小知识3/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Gradle小知识3/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Gradle小知识4/" title="Gradle小知识#4：把单元测试的日志打印到控制台" itemprop="url">Gradle小知识#4：把单元测试的日志打印到控制台</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://trickyandroid.com/gradle-tip-4-log-unit-test-execution-events-into-console/" target="_blank" rel="external">Gradle tip #4: Log unit test execution events into console</a></li>
</ul>
<p>今天的只是比较少，但希望会有用。  </p>
<p>我个人经常使用命令行手动的进行Android的单元测试(<code>./gradlew test</code>),个人习惯而已。但是，默认情况下Gradle只是安静的运行着单元测试的各个步骤。当某个单元测试失败了测试任务也就失败了：  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">:app:processDebugJavaRes UP-TO-DATE</div><div class="line">:app:processDebugUnitTestJavaRes UP-TO-DATE</div><div class="line">:app:compileDebugUnitTestSources</div><div class="line">:app:mockableAndroidJar UP-TO-DATE</div><div class="line">:app:assembleDebugUnitTest</div><div class="line">:app:testDebugUnitTest</div><div class="line"></div><div class="line">BUILD SUCCESSFUL</div><div class="line">Total time: <span class="number">4.725</span> secs</div></pre></td></tr></table></figure>
<p>我觉得如果让Gradle告诉我们什么测试正在运行，那一定很有用。向下面这样：  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">:app:testDebugUnitTest</div><div class="line">com.trickyandroid.testproj.ExampleUnitTest &gt; exampleTest1 PASSED</div><div class="line">com.trickyandroid.testproj.ExampleUnitTest &gt; exampleTest2 PASSED</div><div class="line">com.trickyandroid.testproj.ExampleUnitTest &gt; exampleTest3 PASSED</div><div class="line"></div><div class="line">BUILD SUCCESSFUL</div><div class="line">Total time: <span class="number">4.107</span> secs</div></pre></td></tr></table></figure>
<p>你只需要把下面的这段脚本添加到你的<code>build.gradle</code>的顶级位置，而不是<code>android</code>闭包里：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tasks.matching &#123;it <span class="keyword">instanceof</span> Test&#125;.all &#123;</div><div class="line">    testLogging.events = [<span class="string">"failed"</span>, <span class="string">"passed"</span>, <span class="string">"skipped"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它的作用是：配置所有的单元测试的任务打印信息到控制台，不管是测试失败/测试通过/跳过测试都会打印响应的信息。  </p>
<p>更多关于测试任务的配置请参见<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/tasks/testing/Test.html" target="_blank" rel="external">官网</a> </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Gradle小知识4/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Gradle小知识4/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Gradle提示和使用技巧/" title="Gradle提示和使用技巧" itemprop="url">Gradle提示和使用技巧</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/@cesarmcferreira/gradle-tips-tricks-to-survive-the-zombie-apocalypse-3dd996604341#.k8a9o93ww" target="_blank" rel="external">Gradle tips &amp; tricks to survive the zombie apocalypse</a></li>
</ul>
<p>#Gradle提示和使用技巧<br>Rick Grimes不能帮助你，所以让我们一起获得它！</p>
<p><a href="http://www.gradle.org/" target="_blank" rel="external">Gradle</a> 虽然之前一直存在于<a href="https://developer.android.com/sdk/installing/studio.html" target="_blank" rel="external">Android Studio</a>中，但是它变成热门的转折点是Android Studio成为官方开发IDE。但是，我们充分利用这个伟大的构建自动化系统了吗？</p>
<h2 id="工程和构建专门的全局变量"><a href="#工程和构建专门的全局变量" class="headerlink" title="工程和构建专门的全局变量"></a>工程和构建专门的全局变量</h2><p>使用gradle，会自动生成一个<strong>BuildConfig</strong>类文件并且我们有能力在它里面生成额外的字段。这对于像配置服务器URL和切换开关这类功能都是非常有用的。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">defaultConfig &#123;</div><div class="line">    buildConfigField <span class="string">"String"</span>, <span class="string">"TWITTER_TOKEN"</span>, <span class="string">'"SDASJHDKAJSK"'</span></div><div class="line">&#125;</div><div class="line">buildTypes &#123;</div><div class="line">    debug &#123;</div><div class="line">      buildConfigField <span class="string">"String"</span>, <span class="string">"API_URL"</span>, <span class="string">'"http://api.dev.com/"'</span></div><div class="line">      buildConfigField <span class="string">"boolean"</span>, <span class="string">"REPORT_CRASHES"</span>, <span class="string">"true"</span></div><div class="line">    &#125;</div><div class="line">    release &#123;</div><div class="line">      buildConfigField <span class="string">"String"</span>, <span class="string">"API_URL"</span>, <span class="string">'"http://api.prod.com/"'</span></div><div class="line">      buildConfigField <span class="string">"boolean"</span>, <span class="string">"REPORT_CRASHES"</span>, <span class="string">"false"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>BuildConfig.TWITTER_TOKEN</strong>, <strong>BuildConfig.REPORT_CRASHES</strong> 和 <strong>BuildConfig.API_URL</strong> 都是能够通过<strong>BuildConfig</strong>这个final class访问的。（后面两个变量的值根据构建类型而不同）</p>
<h2 id="每个构建类型不同的名称，版本名和APP-ID"><a href="#每个构建类型不同的名称，版本名和APP-ID" class="headerlink" title="每个构建类型不同的名称，版本名和APP ID"></a>每个构建类型不同的名称，版本名和APP ID</h2><p>这个可以让你有release和debug两个版本的应用在同一时间被安装（记住android不让你安装相同的包名的不同的应用）！</p>
<p>你可以在你的崩溃报告工具中通过不同的版本名来过滤问题/崩溃。</p>
<p>通过查看应用名称很容易发现你当前运行的是哪一个！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    buildTypes &#123;</div><div class="line">        debug &#123;</div><div class="line">            applicationIdSuffix &quot;.debug&quot;</div><div class="line">            versionNameSuffix &quot;-debug&quot;</div><div class="line">            resValue &quot;string&quot;, &quot;app_name&quot;, &quot;CoolApp (debug)&quot;</div><div class="line">            signingConfig signingConfigs.debug</div><div class="line">        &#125;</div><div class="line">        release &#123;</div><div class="line">            resValue &quot;string&quot;, &quot;app_name&quot;, &quot;CoolApp&quot;</div><div class="line">            signingConfig signingConfigs.release</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="私有信息"><a href="#私有信息" class="headerlink" title="私有信息"></a>私有信息</h2><p>Android要求所有的应用被安装之前用一个证书进行数字签名。Android使用这个证书识别应用的作者，尽管这是一些不应该让其它人看见的敏感信息。</p>
<p>你永远不应该提交这种信息到版本控制工具上。</p>
<p>一些人认为你应该有一个本地配置文件或者甚至是一个全局~/.gradle/build.gradle使用这些值，但如果你正在做连续的集成/部署并且你没有自己专门的CI服务器，在你的版本控制器上不应该有任何带着证书用纯文本的方式展示的这种文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">signingConfigs &#123;</div><div class="line">    release &#123;</div><div class="line">        storeFile     &quot;$&#123;System.env.COOL_APP_PRIVATE_KEY&#125;&quot;</div><div class="line">        keyAlias      &quot;$&#123;System.env.COOL_APP_ALIAS&#125;&quot;</div><div class="line">        storePassword &quot;$&#123;System.env.COOL_APP_STORE_PW&#125;&quot;</div><div class="line">        keyPassword   &quot;$&#123;System.env.COOL_APP_PW&#125;&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过这种方式我可以将敏感信息提交到我自己的CI服务器而不用担心提交到公司的CVS上。</p>
<h2 id="自动生成-versionName-和-versionCode"><a href="#自动生成-versionName-和-versionCode" class="headerlink" title="自动生成 versionName 和 versionCode"></a>自动生成 versionName 和 versionCode</h2><p>把你的版本信息从逻辑组件分离出来并且分别管理它们。不用再烦恼如何放置正确的版本号与版本名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">def versionMajor = 1</div><div class="line">def versionMinor = 0</div><div class="line">def versionPatch = 0</div><div class="line">android &#123;</div><div class="line">    defaultConfig &#123;</div><div class="line">        versionCode versionMajor * 10000 + versionMinor * 100 + versionPatch</div><div class="line">        versionName &quot;$&#123;versionMajor&#125;.$&#123;versionMinor&#125;.$&#123;versionPatch&#125;&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加git-hash和构建时间到你的BuildConfig"><a href="#添加git-hash和构建时间到你的BuildConfig" class="headerlink" title="添加git hash和构建时间到你的BuildConfig"></a>添加git hash和构建时间到你的BuildConfig</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">def gitSha = &apos;git rev-parse --short HEAD&apos;.execute([], project.rootDir).text.trim()</div><div class="line">def buildTime = new Date().format(&quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss&apos;Z&apos;&quot;, TimeZone.getTimeZone(&quot;UTC&quot;))</div><div class="line">android &#123;</div><div class="line">    defaultConfig &#123;</div><div class="line">        buildConfigField &quot;String&quot;, &quot;GIT_SHA&quot;, &quot;\&quot;$&#123;gitSha&#125;\&quot;&quot;</div><div class="line">        buildConfigField &quot;String&quot;, &quot;BUILD_TIME&quot;, &quot;\&quot;$&#123;buildTime&#125;\&quot;&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在有两个变量可以用，BuildConfig.GIT_SHA 和BuildConfig.BUILD_TIME ，这在绑定提交/构建时间到log里面是非常方便的！</p>
<h2 id="扣紧安全带"><a href="#扣紧安全带" class="headerlink" title="扣紧安全带"></a>扣紧安全带</h2><p>对于快速部署只需要创建一个叫做<strong>dev</strong>的flavour 并且设置minSdkVersion 为21.通过这么做需要注意的是你不会得到你真正的minSdk的linting检查提示，显而易见的是这仅仅会被用于日常工作而不是发布。这会允许Android gradle插件预编译（pre-dex） 每个module并且编译的APK可以在Android Lollipop（ 5.0）及以上进行测试而不需要花费dex 合并处理时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    productFlavors </div><div class="line">        dev &#123;</div><div class="line">            minSdkVersion 21</div><div class="line">        &#125;</div><div class="line">        prod &#123;</div><div class="line">            // The actual minSdkVersion for the application.</div><div class="line">            minSdkVersion 14</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="单元测试直接输出到控制台"><a href="#单元测试直接输出到控制台" class="headerlink" title="单元测试直接输出到控制台"></a>单元测试直接输出到控制台</h2><p>一个小窍门因此我们可以看到android单元测试它们发生的日志结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">  ...</div><div class="line"></div><div class="line">  testOptions.unitTests.all &#123;</div><div class="line">    testLogging &#123;</div><div class="line">      events &apos;passed&apos;, &apos;skipped&apos;, &apos;failed&apos;, &apos;standardOut&apos;, &apos;standardError&apos;</div><div class="line">      outputs.upToDateWhen &#123; false &#125;</div><div class="line">      showStandardStreams = true</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在运行你的测试它们将输出类似于这样的东西：</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*njDARwtg9P9NdL5GfhIjqA.png" alt="image"></p>
<p>单元测试日志输出</p>
<h2 id="Gradle-告诉我我很漂亮"><a href="#Gradle-告诉我我很漂亮" class="headerlink" title="Gradle,告诉我我很漂亮"></a>Gradle,告诉我我很漂亮</h2><p>一个有组织地方式使用它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">    buildTypes &#123;</div><div class="line">        def BOOLEAN = &quot;boolean&quot;</div><div class="line">        def TRUE = &quot;true&quot;</div><div class="line">        def FALSE = &quot;false&quot;</div><div class="line">        def LOG_HTTP_REQUESTS = &quot;LOG_HTTP_REQUESTS&quot;</div><div class="line">        def REPORT_CRASHES = &quot;REPORT_CRASHES&quot;</div><div class="line">        def DEBUG_IMAGES = &quot;DEBUG_IMAGES&quot;</div><div class="line"> </div><div class="line">        debug &#123;</div><div class="line">            ...</div><div class="line">            buildConfigField BOOLEAN, LOG_HTTP_REQUESTS, TRUE</div><div class="line">            buildConfigField BOOLEAN, REPORT_CRASHES, FALSE</div><div class="line">            buildConfigField BOOLEAN, DEBUG_IMAGES, TRUE</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        release &#123;</div><div class="line">            ...</div><div class="line">            buildConfigField BOOLEAN, LOG_HTTP_REQUESTS, FALSE</div><div class="line">            buildConfigField BOOLEAN, REPORT_CRASHES, TRUE</div><div class="line">            buildConfigField BOOLEAN, DEBUG_IMAGES, FALSE</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你有任何问题在 <a href="https://twitter.com/cesarmcferreira" target="_blank" rel="external">@cesarmcferreira</a>和我联系</p>
<p>感谢<a href="https://medium.com/@jacoelho" target="_blank" rel="external">José Coelho</a>.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Gradle提示和使用技巧/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Gradle提示和使用技巧/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/自动化Android开发/" title="自动化 Android 开发" itemprop="url">自动化 Android 开发</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接：<a href="https://medium.com/google-developer-experts/automating-android-development-6daca3a98396" target="_blank" rel="external">Automating Android development</a></li>
</ul>
<p>我最近已经在 <a href="http://es.droidcon.com/2015/" target="_blank" rel="external">DroidCon Spain</a> 和 <a href="http://it.droidcon.com/2015/" target="_blank" rel="external">DroidCon Italy</a> 讨论过关于如何自动化传统的Android工作流。<br>令我惊讶的是，仍然还有很多组织缺少执行持续集成（CI）的策略。这是一个巨大的灾难！<br>我决定用文字表达我的思想，就是如何高效的实现持续集成（CI）。</p>
<p>作为一个软件攻城狮，你的目标应该是尽可能多的自动化许多工作流程。<br>计算机比人更高效，它们不需要吃饭睡觉，它们的任务表现没有错误，并且它们使你的生活更轻松。<br>请记住：<em>做的越多是为了了做的更少</em></p>
<p>持续集成（CI）尽管是一个包含许多不同要点的综合领域，并且你需要把它们整合在一起。<br>比如，你需要讨论 Jira，你需要关心测试和分支，你需要脚本和构建。</p>
<p>这里有一大块我想在这个帖子中介绍的。他们的每一点都值得展开介绍，但这不是这篇文章的目的。其目的是展示给你每个基础知识，以及如何组合他们。</p>
<ol>
<li>定义一个分支策略。</li>
<li>使用敏捷方法</li>
<li>Gradle和构建脚本</li>
<li>测试</li>
<li>使用CI服务器。</li>
</ol>
<h3 id="分支策略"><a href="#分支策略" class="headerlink" title="分支策略"></a>分支策略</h3><p>分支是重要的。当你正在构建一个新的产品，你想建立一个协议如何工作。<br>人们怎么应该提交自己的特性？我们如何发布？我们如何保证不正在破坏什么东西？<br>要回答这些问题，你需要采用分支策略。</p>
<p>我正在使用一个经过轻微修改的由 <a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="external">Vincent Driessen</a> 提出的分支策略。<br>让我们考虑我们应用程序的三种状态：<strong>alpha</strong>, <strong>beta</strong> 和 <strong>release</strong>.</p>
<ul>
<li><strong>Alpha</strong> 的状态是你的系统正在开发。</li>
<li><strong>Beta</strong> 当你测试的功能已被批准和合并。</li>
<li><strong>Release</strong> 是当系统可交付的状态。</li>
</ul>
<blockquote>
<p>(一些人喜欢叫 alpha 为 “develop” ，并且 beta 为 “stage”. 我认为希腊字母表的字母总是更cool的).</p>
</blockquote>
<p>下面的图片是一个项目的第一个状态。你有一个初始的提交到了master分支。</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*CWNjrbmm5jQ0uvp-L53EYg.png" alt="image"></p>
<p>我们的系统才刚刚开始。只有第一个提交在master分支，其他分支还是空的。<br>追着工作时间的进行。你需要从初始状态进入到develop过程。这将是你的1.0.1版本。</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*JLekFIGh6ciEvj52w3hddA.png" alt="image"></p>
<blockquote>
<p>在这个点上，alpha的确与master相同</p>
</blockquote>
<p>现在，你会在功能特性上开始工作。对于每一个特性，你会创建一个分支。<br>使用正确的命名是很重要的，有几种方法可以做到这一点。如果您使用的是一个问题跟踪系统像 <a href="https://www.atlassian.com/software/jira" target="_blank" rel="external">Jira</a>，你可能会用一个与功能相关联的标签名（比如 FEATURE-123）。<br>当我提交特性时，我会包括分支名在提交信息里，并添加一个完整的描述。</p>
<pre><code>*[FEATURE-123] Created a new screen that performs an action.*
</code></pre><p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*wKF9mdhTLC8MFdy02WJ1EQ.png" alt="image"></p>
<p>注意，在每个分支的项目里都有自己的版本号。您可以使用 <a href="http://git-scm.com/book/en/v2/Git-Basics-Tagging" target="_blank" rel="external">git tags</a> 来执行版本号的控制</p>
<p>当一个功能已经完成，一个 pull request 就开放了，所以你的组织的其他成员就可以批准它。这是为了确保你提供高质量软件的一个关键部分。在 <a href="http://www.sixt.de/mobileapps/" target="_blank" rel="external">Sixt</a>，另一成员被分配到你的代码审查，这个人会通读你全部的代码。<br>我们保证我们的代码是符合我们的<a href="https://speakerdeck.com/kikoso/android-coding-guidelines" target="_blank" rel="external">coding conventions</a>和我们对过程中严格的要求，典型的如在XML文件中有一个额外的空格。我们评论的命名（“函数名我不清楚”），检查我们的设计是完美的（“你的文本视图的颜色 #DCDCDC 但设计是 #DEDEDE”）有一个功能测试去检查该特性是覆盖了在问题跟踪里编写的验收标准的。<br>我们甚至进行一些哲学讨论，比如关于null和void或empty变量的意义。这听起来令人讨厌，但它是有趣的。如果是充满热情的做了这一切，到时候你就知道你的代码达到了产品需要的提交质量。</p>
<h3 id="敏捷和迭代"><a href="#敏捷和迭代" class="headerlink" title="敏捷和迭代"></a>敏捷和迭代</h3><p>你可能会在执行<a href="http://en.wikipedia.org/wiki/Scrum_%28software_development%29" target="_blank" rel="external">SCRUM</a>, <a href="http://en.wikipedia.org/wiki/Kanban_%28development%29" target="_blank" rel="external">Kanban</a>或另外的敏捷方法。通常你会进行在几个星期的冲刺工作。我们认为是一个好主意，把冲刺分到两周：第一周是用来开发特性，而第二周将稳定在第一阶段创造的特性。在第二个冲刺中，我们将修复发现的漏洞，实现完美的布局或提高重构我们的代码。这项工作是在 <strong>beta/stage</strong> 分支完成的。<br>如下图所示</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*7lynNxY8iQpFHCee_Rkjjg.png" alt="image"></p>
<blockquote>
<p>这些黄点属于bug修复和稳定性阶段</p>
</blockquote>
<p>如果你遵循我们的约定，敏捷结束时你将会有一个可交付的成果。这将是一个准备发表在谷歌商店的可交付文件。此时此刻，我们的应用程序的最后版本已经合并到了master。<br>另一个非常重要的课题是如何创建一个热修复补丁。我们的模型试图通过使用代码检查和修复bug和产品稳定的第二周来阻止他们发生，但错误确实已经发生。这是发生在生产时，这种模式要求错误直接被修正在 <strong>master</strong> 分支。</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*sdL8HDfMgoNuhnLKu7Soew.png" alt="image"></p>
<p>你有没有意识到这个模型的标志？是的，就是那！该热修复补丁是不存在在我们的 <strong>alpha/beta</strong> 的分支。经过修复和稳定期后（第二周），我们的 <strong>alpha</strong> 分支是旧状态，错误仍然是存在的。我们需要立即合并到各分支来保证正确，从而确保每一个修复是存在所有的分支的。</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*Rijzdkk4SA4T9T3koBAXCg.png" alt="image"></p>
<p>很难理解？可能是读起来比实施来的难。<br>如果你没有一个分支策略，只是试图使用这个模型来开发一个特性。你会发现很容易工作，而且你甚至会开始定制！</p>
<h3 id="Gradle-和脚本化"><a href="#Gradle-和脚本化" class="headerlink" title="Gradle 和脚本化"></a>Gradle 和脚本化</h3><p>现在您已经阅读分支模型，我们准备继续讨论接下来的步骤。Gradle是一个工具,将帮助我们自动完成很多事情。你可能熟悉Gradle(或其它家族成员,Maven和Ant)。Gradle是一个项目的自动化工具，当我们正在建设我们的应用程序时，可以使用执行功能和定义属性。它介绍了一种基于Groovy的领域语言，它能做到的基本上只受限于我们的想象力。</p>
<p>我以前写的一个 <a href="http://codetalk.de/?p=112" target="_blank" rel="external">post</a> 和一些技巧来使用工具。他们中的一些将非常有用，包括对于你的应用，但之后也有一些我已经应用的，我想在这里介绍。</p>
<h4 id="构建配置（BuildConfig）的力量"><a href="#构建配置（BuildConfig）的力量" class="headerlink" title="构建配置（BuildConfig）的力量"></a>构建配置（BuildConfig）的力量</h4><p>当我们编译Android应用程序时，<em>BuildConfig</em> 是一个自动生成的文件。这个文件，默认情况下，看起来如下：</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*wkoXjbSYaYymUhZrO8-jRw.png" alt="image"></p>
<p>BuildConfig 包含一个字段，叫 <strong>DEBUG</strong>，指示应用程序是否已经编译在调试模式。这个文件是高度可定制的，当我们工作在不同的构造类型时，这是非常便利的。</p>
<p>应用程序通常使用服务工具追踪其行为 <a href="http://www.google.com/analytics/ce/mws/" target="_blank" rel="external">Google Analytics</a>, <a href="https://try.crashlytics.com/" target="_blank" rel="external">Crashlytics</a> 或其他平台。当我们正在开发应用时，我们可能不想影响这些指标（想象一个用户界面的测试，自动发布的每一天，跟踪您的登录屏幕？）。我们也会根据我们的构建有不同的域名（例如development.domain.com, staging.domain.com…），我们要使用自动的。但我们怎么可以做的干净利落？容易！在Gradle的buildTypes域，我们可以添加任何我们希望的新域。这些域将通过<em>BuildConfig</em> 在以后可用（这意味着，我们可以使用 BuildType.FIELD 来读取它们）。</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*Z_YYrTPF7FTShHAt5tqW3g.png" alt="image"></p>
<p>在 <a href="http://codetalk.de/?p=112" target="_blank" rel="external">this post</a> 我展示了如何使用不同的图标和如何改变包的名称。利用这个我们可以安装我们应用程序的不同版本。这能够非常方便的同时看到我们的 beta, alpha 和 release 版本。</p>
<h3 id="保持测试"><a href="#保持测试" class="headerlink" title="保持测试"></a>保持测试</h3><p>测试本身，和整个过程都有它自己的中间环节。当我们谈论测试就是我们在谈论模拟的组件，关于UI测试和集成测试，关于仪器，和所有对于Android可用的不同框架。</p>
<p>测试是非常重要的，因为它可以防止开发者破坏现有的东西。没有测试，当我们开发一个新的功能B时，我们可以很容易地干扰一个旧的特性A。当一个新的特征被提交，是很难手动测试整个系统的，但自动的做这些就更容易控制一个系统的稳定性。</p>
<p>这里有了许多不同的测试可以在移动设备上实施：只是列举几个，我们可以考虑，集成测试，功能测试，性能测试和用户界面测试。每一种都有不同的功能，它们一般是定期触发以确保新功能没有破坏或干扰系统。</p>
<p>为了展示一个基本的例子，如何将测试在 Jenkins 集成（以及他们如何实现生成出错时停止的功能）<br>我们将看到一个做UI测试的小例子 <a href="https://code.google.com/p/android-test-kit/wiki/Espresso" target="_blank" rel="external">Espresso</a> 每次都是在 Jenkins 构建测试我们的Android应用程序。</p>
<h3 id="一个应用程序的示例"><a href="#一个应用程序的示例" class="headerlink" title="一个应用程序的示例"></a>一个应用程序的示例</h3><p>我创建了一个小示例应用程序并上传到 <a href="https://github.com/kikoso/Android-Testing-Espresso" target="_blank" rel="external">GitHub</a>，所以你可以来这里看看。也有一些分支使用命名约定和 pull requests，直到现在你可以看到审查的一切解释。该应用程序是相当基本的：它有一个TextView屏幕。还有三个已在文件执行的UI测试单元<br><a href="https://github.com/kikoso/Android-Testing-Espresso/blob/master/src/androidTest/java/com/dropsport/espressoreadyproject/tests/MainActivityInstrumentationTest.java" target="_blank" rel="external">MainActivityInstrumentationTest</a>:</p>
<ol>
<li>检查在屏幕上存在一个TextView。</li>
<li>检查TextView包含文本“Hello World!”</li>
<li>检查TextView包含文本“What a label!”</li>
</ol>
<p>最后的两个试验是互斥的（这意味着，无论是一个或另一个是成功的，但不能两者同时成立）。我们通过以下命令对应用进行测试：</p>
<pre><code>./gradlew clean connectedCheck.
</code></pre><p>如果你检出了代码，你可以自己试试注释功能 <em>testFalseLabel</em>。这将使测试失败。</p>
<h3 id="把一切都集成在-Jenkins"><a href="#把一切都集成在-Jenkins" class="headerlink" title="把一切都集成在 Jenkins"></a>把一切都集成在 Jenkins</h3><p>现在，我们已经检查了一些事情，让我们看看他们如何适配 Jenkins。如果你没有安装它，你可以从网站下载 <a href="https://jenkins-ci.org/" target="_blank" rel="external">last version</a>。</p>
<p>我们没有提到一些东西，但这里也有分支策略。<br>有许多不同的方法，它们都具有各自的优点和缺点：</p>
<ol>
<li>你可以在分支构建前触发测试。</li>
<li>你可以晚上或每日构建，不要阻止构建，但如果失败仍然要发出通知。</li>
</ol>
<p>在本教程中我选择了第一种方法，也是为了显示 Jenkins 的一大特征：jobs 之间的依赖关系。让我们创造三个 jobs：<strong>Job Beta</strong>, <strong>Job Alpha</strong> and <strong>Job Tests</strong>。</p>
<ol>
<li><strong>Job Alpha</strong> 将构建 alpha 分支 (通过 ./gradlew clean assembleAlpha)</li>
<li><strong>Job Beta</strong> 将做同样的工作在 beta 分支上（通过 ./gradlew clean assemblebeta）。这是每一次有分支合并到 beta 分支上就会执行的</li>
<li><strong>Job Tests</strong> 每次有分支合并到 alpha 分支时都将触发。如果它成功了，它会引发 <strong>Job Alpha</strong>。</li>
</ol>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*OPzV-aZLBGxdPYWPIip8Bg.png" alt="image"></p>
<p>Jenkins 是一个基于大量的插件的平台。许多公司正在为他们的产品不断地发布插件，他们将集成在 Jenkins，我们可以很容易地与其他平台连接。<br>让我们看看在 Jenkins 的一些选项</p>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><p>使用依赖 Jenkins 可以互连项目。也许我们要连接测试 jobs 和基于试验结果来控制启动。或许我们在实际构建应用之前，部分逻辑首先存在需要编译的lib库里。</p>
<h4 id="通知"><a href="#通知" class="headerlink" title="通知"></a>通知</h4><p>Jenkins 可以通知一个人或一个工作组或构建错误。通知一般是电子邮件，但也有插件可以通过IM系统发送消息，如 <a href="https://wiki.jenkins-ci.org/display/JENKINS/Skype+Plugin" target="_blank" rel="external">Skype</a> 或者 <a href="https://wiki.jenkins-ci.org/display/JENKINS/SMS+Notification" target="_blank" rel="external">SMS</a>（最新版当你有重要的测试失败时可以很方便的通知）。</p>
<h4 id="交付"><a href="#交付" class="headerlink" title="交付"></a>交付</h4><p>你可能知道，在这一点上 <a href="http://hockeyapp.net/" target="_blank" rel="external">HockeyApp</a> 或另一个 <a href="http://alternativeto.net/software/hockeyapp/" target="_blank" rel="external">delivery platforms</a>。他们基本上可以存储二进制文件，创建组，并当应用程序被上传时通知他们。想象看测试者自动在他/她的设备上接收每次他们被创造的文件，和产品所有者被通知有新的beta版的情景。这里有一个Jenkins 插件 <a href="https://wiki.jenkins-ci.org/display/JENKINS/HockeyApp+Plugin" target="_blank" rel="external">HockeyApp plugin</a> 能够上传二进制文件到 Hockey（甚至通知成员，或作为你最近提交的 release notes 使用）。</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*P6-P4hBkKfAG7Ls0bzXeEQ.png" alt="image"></p>
<p>我还是喜欢保持手动发布产品的步骤，这可能是由于在出版过程中不经过人工控制的一种担心。但是，确实有一个 <a href="https://wiki.jenkins-ci.org/display/JENKINS/Google+Play+Android+Publisher+Plugin" target="_blank" rel="external">plugin</a> 用来直接发步到 Google Play。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>在 <em>building</em>, <em>testing</em>, <em>delivering</em> 和 <em>publishing</em> 实现自动化，主要是在一个团队工作中选择正确的决策。当这个决定是明确的，我们才可以继续去技术上实现。</p>
<p>有一件事情是肯定的：错误会由于以往人们的行动而大幅度减少，并结合强大的测试覆盖率，我们的软件质量将大大提高。这里我借用同事的座右铭 <a href="https://developers.google.com/experts/people/cyril-mottier" target="_blank" rel="external">Cyril Mottier</a>：</p>
<blockquote>
<p>致精而大</p>
</blockquote>
<p>这是你职业生涯中的一个重要时刻！当你想在工作中保证 <strong>质量</strong> 而努力，而不是 <strong>数量</strong> 的多少。我了解这件事，第一步是尽你所能的实现自动化。事实上，我可以用以前的口号改述为另一句话，我将在我的日常生活里：</p>
<blockquote>
<p>自动化的更多，所以你被动化的更少</p>
</blockquote>
<p>祝：快乐编程！</p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/fit/c/63/63/1*AV6Ju95BJPkkIXg1x8Ni1w.jpeg" alt="image" title="Enrique López Mañas"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/自动化Android开发/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/自动化Android开发/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/结合RxJava更简单地使用SQLite/" title="结合RxJava更简单地使用SQLite" itemprop="url">结合RxJava更简单地使用SQLite</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://beust.com/weblog/2015/06/01/easy-sqlite-on-android-with-rxjava/" target="_blank" rel="external">Easy SQLite on Android with RxJava</a></li>
<li>原文作者 : <a href="http://beust.com/weblog/about-2/" target="_blank" rel="external">Cédric Beust</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/tiiime" target="_blank" rel="external">tiiime</a> </li>
<li>校对者:  <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a> </li>
<li>状态 :   完成</li>
</ul>
<p>我经常想在项目中使用 ORM 来简化操作，但是最终都将这个念头打消。主要有以下几点原因：</p>
<ul>
<li>我的数据模型远远没有复杂到需要 ORM 帮助</li>
<li>出于 Android 性能上的考虑，自动生成的SQL语句可能没有被优化</li>
</ul>
<p>不过最近，我开始使用一个简单的设计模式，使用 RxJava 来提供一个简单的数据库访问管理。<br>我称它为 “Async Rx Read” 设计模式，很渣的一个名字哈，不过是我能想到最好的了，命名总是程序员的难题嘛。</p>
<p>#Easy Read<br>Android 开发中有一条很重要的设计原则，永远不要在主线程执行 I/O 操作，显然这条规则对数据库访问也适用。<br>RxJava 很适用于解决这个问题。<br>在以前，我通常为每个 table 创建一个 Java 类，然后通过我的 <a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html" target="_blank" rel="external">SQLiteOpenHelper</a> 来管理这些 table。<br>现在使用这个新的方法后，我将这个工具类扩展成所有事物读写 SQL table 的唯一入口。<br>我们来想个简单的例子：一个由 UserTable 类管理的 USERS 表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UserTable.java</span></div><div class="line"><span class="function">List&lt;User&gt; <span class="title">getUsers</span><span class="params">(SQLiteDatabase db, String userId)</span> </span>&#123;</div><div class="line">  <span class="comment">// select * from users where _id = &#123;userId&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的方法有一个缺点，就是你一不小心可能会在主线程调用它，这里面是由调用者确保它是在后台线程中被执行的<br>(如果需要更新 UI 的话，再将结果返回给主线程)。而不是依赖一个线程池管理，或者更糟点，使用 <code>AsyncTask</code> 管理，<br>我们将使用 RxJava 替我们管理线程模型。</p>
<p>让我们重写这个方法返回一个 callback ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UserTable.java</span></div><div class="line">Callable&lt;List&lt;User&gt;&gt; getUsers(SQLiteDatabase db, String userId) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Callable&lt;List&lt;User&gt;&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// select * from users where _id is userId</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上，我们只是重构了一下这个方法返回一个 lazy result ，使得 database helper 可以将这个<br>result 转变成一个 <code>Observable</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MySqliteOpenHelper.java</span></div><div class="line">Observable&lt;List&lt;User&gt;&gt; getUsers(String userId) &#123;</div><div class="line">  <span class="keyword">return</span> makeObservable(mUserTable.getUsers(getReadableDatabase(), userId))</div><div class="line">    .subscribeOn(Schedulers.computation()) <span class="comment">// note: do not use Schedulers.io()</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意到将 lazy result 转换成一个 <code>Observable</code> 时，helper 强制 subscription 运行在后台线程<br>(这里使用的是 computation scheduler;不要使用 <code>Schedulers.io()</code> 因为它是由 unbounded executor 支持的)。<br>这样调用者就不必担心这个方法会阻塞主线程了。</p>
<p>最后，<code>makeObservable()</code> 方法的实现很简单(而且是完全通用的)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MySqliteOpenHelper.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">makeObservable</span><span class="params">(<span class="keyword">final</span> Callable&lt;T&gt; func)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> Observable.create(</div><div class="line">      <span class="keyword">new</span> Observable.OnSubscribe&lt;T&gt;() &#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              subscriber.onNext(func.call());</div><div class="line">            &#125; <span class="keyword">catch</span>(Exception ex) &#123;</div><div class="line">              Log.e(TAG, <span class="string">"Error reading from the database"</span>, ex);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，我们的 database 读取已经变成了 <code>observables</code>，保证查询是执行在后台线程的。<br>访问数据库操作也是很标准的 Rx code：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DisplayUsersFragment.java</span></div><div class="line"><span class="meta">@Inject</span></div><div class="line">MySqliteOpenHelper mDbHelper;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"></div><div class="line">mDbHelper.getUsers(userId)</div><div class="line">  .observeOn(AndroidSchedulers.mainThread())</div><div class="line">  .subscribe(<span class="keyword">new</span> Action1&lt;List&lt;User&gt;&gt;()) &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;User&gt; users)</span> </span>&#123;</div><div class="line">      <span class="comment">// Update our UI with the users</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你不需要返回结果更新你的 UI，那么你只需要 observe 一个后台线程。<br>然后你的 database 层会返回 observables，当获得结果时很容易将它组合变换。<br>例如，假定 <code>ContactTable</code> 是一个底层类， model (User class) 对它是不可见的，<br>它应该返回底层 object (可能是 <code>Cursor</code> 或者 <code>ContentValues</code>)。然后你可以用<br>Rx 去 <code>map</code> 这些底层值，把它们转换成你的 model 类，实现更加清晰的分离层。</p>
<p>两个提示：</p>
<ul>
<li><p>你的 Table 类不应该包含 public 方法：只能有 package 的 protected 方法(仅允许相同 package 内的 Helper 访问 ) 和 private 方法，<br>其他类不能直接访问 Table 类。</p>
</li>
<li><p>这个方法对依赖注入兼容性很好：很轻松就可以同时实现 database helper 和注入单个 Table<br>(意外收获：使用 Dagger 2，你的 table 可以拥有自己的组件，因为 database helper<br>是实例化它们所需的唯一参考资料 )。</p>
</li>
</ul>
<p>这是一个很简单的设计模式，它显著提升了 RxJava 在项目中发挥的效果。<br>我正在扩展这层结构，让它可以为 list view adapter update 提供更灵活的通知机制<br>(和 SQLBrite 提供的不同)，会在以后的文章中介绍。</p>
<p>这项工作还在进行中，欢迎反馈。</p>
<hr>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/结合RxJava更简单地使用SQLite/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/结合RxJava更简单地使用SQLite/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Parcelable vs Serializable对比/" title="Parcelable vs Serializable" itemprop="url">Parcelable vs Serializable</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://www.developerphil.com/parcelable-vs-serializable/" target="_blank" rel="external">原文链接</a></p>
<p>当你开始写android时，我们所学到的是不能直接向Activities和Fragments传递对象，我们不得不借助Intent或者Bundle来传递它们。</p>
<p>当我们看api文档的时候，我们认识到有两种选择，我们的对象要么是Parcelable或者Serializable型，作为一个java开发者，我们已经知道Serializable的机制，那为什么还要去研究Parcelable呢？</p>
<p>为了回答这个问题，我们来看两个方法。</p>
<p>####Serializable，简洁的鼻祖####</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// access modifiers, accessors and constructors omitted for brevity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializableDeveloper</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span></div><div class="line">    <span class="title">String</span> <span class="title">name</span>;</div><div class="line">    <span class="keyword">int</span> yearsOfExperience;</div><div class="line">    List&lt;Skill&gt; skillSet;</div><div class="line">    <span class="keyword">float</span> favoriteFloat;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Skill</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">        String name;</div><div class="line">        <span class="keyword">boolean</span> programmingRelated;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>仅仅需要在它和它的子类上实现Serializable接口就能完成一个漂亮的Serializable功能，他是一个标记接口，意味着不需要实现任何方法，java虚拟机将简单高效地完成序列化工作。</p>
<p>这里面有个问题就是这种序列化是通过反射机制从而削弱了性能，这种机制也创建了大量的临时对象从而引起GC频繁回收调用资源。</p>
<p>####Parcelable, 速度之王####<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// access modifiers, accessors and regular constructors ommited for brevity</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParcelableDeveloper</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line">    String name;</div><div class="line">    <span class="keyword">int</span> yearsOfExperience;</div><div class="line">    List&lt;Skill&gt; skillSet;</div><div class="line">    <span class="keyword">float</span> favoriteFloat;</div><div class="line"></div><div class="line">    ParcelableDeveloper(Parcel in) &#123;</div><div class="line">        <span class="keyword">this</span>.name = in.readString();</div><div class="line">        <span class="keyword">this</span>.yearsOfExperience = in.readInt();</div><div class="line">        <span class="keyword">this</span>.skillSet = <span class="keyword">new</span> ArrayList&lt;Skill&gt;();</div><div class="line">        in.readTypedList(skillSet, Skill.CREATOR);</div><div class="line">        <span class="keyword">this</span>.favoriteFloat = in.readFloat();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        dest.writeString(name);</div><div class="line">        dest.writeInt(yearsOfExperience);</div><div class="line">        dest.writeTypedList(skillSet);</div><div class="line">        dest.writeFloat(favoriteFloat);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;ParcelableDeveloper&gt; CREATOR</div><div class="line">            = <span class="keyword">new</span> Parcelable.Creator&lt;ParcelableDeveloper&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="function">ParcelableDeveloper <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ParcelableDeveloper(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ParcelableDeveloper[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ParcelableDeveloper[size];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Skill</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line">        String name;</div><div class="line">        <span class="keyword">boolean</span> programmingRelated;</div><div class="line"></div><div class="line">        Skill(Parcel in) &#123;</div><div class="line">            <span class="keyword">this</span>.name = in.readString();</div><div class="line">            <span class="keyword">this</span>.programmingRelated = (in.readInt() == <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">            dest.writeString(name);</div><div class="line">            dest.writeInt(programmingRelated ? <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;Skill&gt; CREATOR</div><div class="line">            = <span class="keyword">new</span> Parcelable.Creator&lt;Skill&gt;() &#123;</div><div class="line"></div><div class="line">            <span class="function">Skill <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Skill(in);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Skill[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Skill[size];</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>按照google工程师的说话，这段代码将跑起来非常快，其中一个原因是运用真实的序列化处理代替反射，为了完成这个目的代码也做了大量的优化。</p>
<p>然而，显而易见的是实现Parcelable接口并不是无成本的，创建了大量的引入代码从而导致整个类变得很重同时加大了维护成本。</p>
<p>####Speed Tests####</p>
<p>当然，我们想知道Parcelable到底有多快</p>
<p>测试步骤<br>1：模拟这个操作通过Bundle的writeToParcel（Parcel, int）向Activity传递对象，然后观察它。<br>2：循环这个操作1000次。<br>3：大概模拟10次，观察内存回收情况，以及app的cpu使用率，等等。<br>4：这个被测试的对象分别是SerializableDeveloper和ParcelableDeveloper。<br>5：在多种机型和版本上做测试<br>LG Nexus 4 - Android 4.2.2<br>Samsung Nexus 10 - Android 4.2.2<br>HTC Desire Z - Android 2.3.3</p>
<p>测试结果：<br><img src="http://img.blog.csdn.net/20160318115133497" alt="这里写图片描述"></p>
<p>Nexus 10</p>
<p>Serializable: 1.0004ms,  Parcelable: 0.0850ms - 10.16x improvement.</p>
<p>Nexus 4</p>
<p>Serializable: 1.8539ms - Parcelable: 0.1824ms - 11.80x improvement.</p>
<p>Desire Z</p>
<p>Serializable: 5.1224ms - Parcelable: 0.2938ms - 17.36x improvement.</p>
<p>分析：<br>Parcelable比Serializable速度快10倍，在Nexus 10测试过程中得到了有趣的结果，仅仅通过1毫秒就完成了整个的序列化与反序列化过程。</p>
<p>总结：<br>假如你想成为一个好的码农，找个时间替换成Parcelable吧，他将提高十倍的速度并且用更少的资源。</p>
<p>然而，在大部分的案例里，这种缓慢的Serializable序列化过程并没有被注意到，有时候仅仅是为了成本比较低才会使用它但是要记住Serialization是要付出很大的代价的，所以还是尽量少使用这种方式。</p>
<p>假如你想传递成百上千的序列化对象，整个序列化的过程可能会超过一秒，当你对手机屏幕进行横竖屏切换将感觉有点延迟。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Parcelable vs Serializable对比/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Parcelable vs Serializable对比/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/MVP框架Mosby架构详解/" title="Ted Mosby - 软件架构" itemprop="url">Ted Mosby - 软件架构</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>作者：Hannes Dorfmann</li>
<li>原文链接 : [<a href="http://hannesdorfmann.com/android/mosby/" target="_blank" rel="external">http://hannesdorfmann.com/android/mosby/</a>]<br>(<a href="http://hannesdorfmann.com/android/mosby/" target="_blank" rel="external">http://hannesdorfmann.com/android/mosby/</a>)</li>
<li>文章出自 : <a href="https://github.com/bboyfeiyu/android-tech-frontier" target="_blank" rel="external">Android开发技术前线</a></li>
<li>译者 : <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a></li>
</ul>
<p>我给这篇关于Android库的博客起的名字灵感来源于《老爸老妈浪漫史》中的建筑设计师Ted Mosby。这个Mosby库可以帮助大家在Android上通过Model-View-Presenter模式做出一个完善稳健、可重复使用的软件，还可以借助ViewState轻松实现屏幕翻转。</p>
<h2 id="Model-View-Presenter-MVP"><a href="#Model-View-Presenter-MVP" class="headerlink" title="Model-View-Presenter (MVP)"></a>Model-View-Presenter (MVP)</h2><p><strong>MVP</strong>模式是一个把view从低层模型分离出来的一种现代模式。<strong>MVP</strong>由model–view–controller (MVC)软件模式衍生而来，常用于构建UI</p>
<ul>
<li><strong>MVP</strong>中的<strong>M</strong>（model）代表的是将会显示在view（UI）中的数据。</li>
<li><strong>MVP</strong>中的<strong>V</strong>（view）是显示数据（model）并且将用户指令（events）传送到presenter以便作用于那些数据的一个接口。View通常含有Presenter的引用。</li>
<li><strong>MVP</strong>中的<strong>P</strong>（presenter）扮演的是“中间人”的作用（就如MVC中的controller），且presenter同时引用view和model。值得注意的是，“Model”这个词并不正确。严格意义上来说，它指的应该是检索或控制一个Model的业务逻辑层。举个例子，比如你的数据库里面包含了User，而你的View想要显示一个User列表，那么Presenter会引用数据库中的业务逻辑层（比如DAO）从而查询到一个User列表。如图1-1.<br> <img src="http://hannesdorfmann.com/images/mosby/mvp-overview.png" alt=""></li>
</ul>
<p>从数据库中查询或显示User列表的具体流程如图1-2：<br><img src="http://hannesdorfmann.com/images/mosby/mvp-workflow.png" alt=""></p>
<p>以上工作流程图应该能够说明问题了。但是，还有以下几点值得注意的地方：</p>
<ul>
<li><p><strong>Presenter</strong>不是一个<strong>OnClickListener</strong>。<strong>View</strong>主要是负责处理用户输入并调用presenter相应的方法。那么问题来了，为什么不把<strong>Presenter</strong> 直接做成一个<strong>OnClickListener</strong>，从而把“转发流程”给省略掉呢？大家想想，如果这样做的话，首先，<strong>presenter</strong>需要知道view的内部构件。举个例子，如果一个View有两个按钮，且这个view在这两个按钮上都把<strong>Presenter</strong> 注册成<strong>OnClickListener</strong>的话，那么发生点击事件时Presenter （在不知道view中按钮引用等内部构件的情况下）怎么能够区分出是哪一个按钮被点击了呢？Model，View和Presenter三者应解耦。其次，如果让Presenter 执行OnClickListener，Presenter就被绑定到了Android平台上。理论上来说<strong>presenter</strong>和业务逻辑层都是纯旧式的能够与桌面应用或其他任何java应用共享的java代码。</p>
</li>
<li><p>大家在第1步和第2步中可以看到，<strong>View</strong> 只执行<strong>Presenter</strong> 指示的操作：用户点击“load user button”（第1步）后，view并没有直接显示加载动画，而是在第2步presenter明确告诉其显示加载动画后才显示的。这一Model-View-Presenter的变体称之为MVP 被动视图。这个view可以说是要多笨有多笨。这时我们需要让presenter以一种更抽象的方式来控制view。比如，presenter在调用 <strong>view.showLoading()</strong> 时并不控制view的诸如动画等具体事项。所以presenter不应调用<strong>view.startAnimation()</strong> 等方法。</p>
</li>
<li><p>通过执行<strong>MVP</strong>被动视图，并发性以及多线程更容易处理。大家可以看到，第3步中数据库查询异步运行，并且<strong>presenter作为Listener/Observer</strong>，在数据准备显示时presenter收到通知。</p>
</li>
</ul>
<p>##<strong>Android</strong>上的<strong>MVP</strong></p>
<p>目前为止一切顺利。但是大家怎么样把MVP运用到自己的Android 应用上呢？第一个问题在于，我们要把MVP模式运用到什么地方？Activity上、Fragment上、还是像RelativeLayout这类的ViewGroup上？我们来看看Android平板上的Gmail应用，如图1-3：</p>
<p><img src="http://hannesdorfmann.com/images/mosby/mvp-gmail.png" alt=""></p>
<p>在我看来，上图屏幕中有四个可以使用MVP的地方。我所说的“可以使用MVP的地方”是指屏幕上显示的、在逻辑上属于一个整体的UI元素。因此这些地方也可以称为是可以运用MVP的一个单独的UI单元。如图 1-4.</p>
<p><img src="http://hannesdorfmann.com/images/mosby/mvp-gmail-candidates.png" alt=""></p>
<p>看起来MVP似乎很适合运用到Activity，特别是Fragment上。通常Fragment只负责显示单一的如ListView之类的内容，就像依靠<strong>MailProvider</strong> 来获取一系列<strong>Mails</strong>的<strong>InboxPresenter</strong> 控制下的 <strong>InboxView</strong>一样。但是，<strong>MVP</strong>不仅仅限于Fragment或Activity，它还可以运用到SearchView中显示的ViewGroup中。在我的大多数app里面我都在Fragment运用MVP模式。但是大家可以自行决定把MVP运用到什么地方，前提是view是独立的，这样这样presenter才能在不与其他Presenter冲突的情况下控制View。</p>
<p>##我们为什么要实现<strong>MVP</strong>？</p>
<p>我们如何在不使用MVP模式时显示Email列表到Fragment? 通常，我们需要获取并且合并本地SQL数据库和从IMAP邮件服务器获取的邮件列表，然后将邮件列表绑定到收件箱view中。那么，此时fragment的代码又会是怎么样的呢？我们需要运行两个<strong>AsyncTasks</strong> 并实现一个“等待机制”（等到两个任务将两者的加载数据合并到一个单独的mail列表）。我们还需要注意的是在加载时要显示加载动画（ProgressBar），之后用ListView替代。我们需要把所有的代码放到Fragment中吗？要是加载过程中出现错误怎么办？屏幕翻转怎么办？谁来负责撤销<strong>AsyncTasks</strong> ？这一系列的问题都可以通过MVP得到解决。让我们跟那些带有上千行大杂烩代码的activity和fragment说拜拜吧</p>
<p>但是，在我们深入研究如何将MVP运用到Android中之前，我们需要弄清楚的一个问题是：Activity或Fragment究竟是一个View还是一个Presenter。Activity或Fragment似乎既是<strong>View</strong>也是<strong>Presenter</strong>，因为它们都有 <strong>onCreate()</strong> 或<strong>onDestroy()</strong>之类的生命周期回调功能，并且它们负责从一个UI控件到另一个UI 控件的转换（比如在加载时显示ProgressBar，然后显示带有数据的ListView）等View操作。大家可能会觉得这里的Activity或Fragment就是一个Controller，我猜可能也是这么一个初衷。但是在经历了几年的Android应用开发之后，我得出这么一个结论：我们应该把Activity或Fragment看作是一个不太智能的View，而不是把它们看作一个Presenter。后文我会给出原因。</p>
<p>综上，我想给大家介绍一个在Android平台上开发基于MVP的应用的一个 <strong>Mosby</strong>库。<br><strong>Mosby</strong></p>
<p>大家可以在<a href="https://github.com/sockeqwe/mosby" target="_blank" rel="external">Github</a>和Maven Central上找到Mosby库。Mosby分为几个子模块，大家可以根据自己的需要选取组件。我们来回顾一下最重要的一个模块。</p>
<p>##核心模块 ( Core Module)</p>
<p>《老爸老妈浪漫史》中的建筑设计师Ted Mosby想建造一栋摩天大楼。而建造这样一栋宏伟的建筑必须打好坚实的地基。这对Android应用的开发来说是也是一样的道理。基本上，<strong>Core Module</strong> 分为两种类型：<strong>MosbyActivity</strong> 和<strong>MosbyFragment</strong>。这两者是所有其他activity或fragment子类的基类（相当于建筑的地基）。两者都使用我们大家所熟知的APT <strong>（Annotation Processing Tool）</strong>来减少一些样板式代码。<strong>MosbyActivity</strong> 和<strong>MosbyFragment</strong> 使用Butterknife进行view的注入，使用Icepick 将实例状态保存和存储到Bundle中，使用FragmentArgs注入Fragment参数。我们不需要再调用Butterknife.inject(this)等插入方法。这类代码已经包含在了MosbyActivity 和 MosbyFragment中。它是即时可用的。我们需要做的就是使用子类中相应的注解。核心模块与MVP没有关联，它只是写一个大型软件的基础。</p>
<p>##MVP模块( MVP Module )</p>
<p>Mosby库中的MVP模块使用泛型来确保类型安全。所有view的基类是<strong>MvpView</strong>。从根本上说这只是一个空的interface 。Presenter的基类是<strong>MvpPresenter</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public interface MvpView&#123;&#125;</div><div class="line"></div><div class="line">public interface MvpPresenter&lt;V extends MvpView&gt;&#123;</div><div class="line">	public void attachView(V view);</div><div class="line">	public void detachView(boolean retainInstance);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上文提到，我们把<strong>Activity</strong>和<strong>Fragment</strong>看做View。因此Mosby库的MVP模块提供了 属于<strong>MvpViews</strong> 的<strong>MvpActivity</strong>和<strong>MvpFragment</strong>作为<strong>Activity</strong>和<strong>Fragment</strong>的基类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">public abstract class MvpActivity&lt;P extends MvpPresenter&gt; extends MosbyActivity implements MvpView&#123;</div><div class="line"></div><div class="line">	protected P presenter;</div><div class="line">	@Override  protected void onCreate(Bundle savedInstanceState)&#123;</div><div class="line">		super.onCreate(savedInstanceState);</div><div class="line">		presenter = createPresenter();</div><div class="line">		presenter.attachView(this);</div><div class="line">		super.onDestroy();</div><div class="line">		presenter.detachView(false);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	protected abstract PcreatePresenter();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public abstract class MvpFragment&lt;P extends MvpPresenter&gt; MosbyFragment implements MvpView&#123;</div><div class="line">	protected Ppresenter;</div><div class="line"></div><div class="line">	@Override public void onViewCreated(View view,@Nullable Bundle savedInstanceState)&#123;</div><div class="line">		super.onViewCreated(view,savedInstanceState);</div><div class="line">		// Create the presenter if needed</div><div class="line">		if(presenter == null)&#123;</div><div class="line">			presenter = createPresenter();</div><div class="line">		&#125;</div><div class="line">		presenter.attachView(this);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override public void onDestroyView()&#123;</div><div class="line">		super.onDestroyView();</div><div class="line">		presenter.detachView(getRetainInstance());</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	protected abstract PcreatePresenter();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override protected void onDestroy()&#123;</div></pre></td></tr></table></figure>
<p>这一理念主要是一个<strong>MvpView</strong> (也就是Fragment or Activity)会关联一个MvpPresenter，并且管理<strong>MbpPresenter</strong>的声明周期。大家从上面的代码片段可以看到，Mosby使用Activity和Fragement生命周期来实现这一目的。通常presenter是绑定在该生命周期上的。所以初始化或者清理一些东西等操作（例如撤销异步运行任务）应该在 <strong>presenter.onAttach()</strong>和 presenter.onDetach()上进行。我们稍后会谈到presenter如何使用setRetainInstanceState(true) “避开”Fragment中的生命周期。我相信大家也注意到了， MvpPresenter是一个interface 。MVP模块提供一个 <strong>MvpBasePresenter</strong>，这个<strong>MvpBasePresenter</strong>只持有View（是一个Fragment或Activity）的弱引用，从而避免内存泄露。因此，当<strong>presenter</strong>想要调用view方法时，我们需要查看<strong>isViewAttached()</strong> 并使用<strong>getView()</strong>来获取引用，以检查view是否连接到了presenter。</p>
<p>##Loading-Content-Error (LCE)</p>
<p>通常Fragment会一直重复做某一件事。它在后台加载数据，同时显示加载view（即ProgressBar），并在屏幕上显示加载的数据，或者当加载失败时显示view错误。如今，下拉刷新支持很容易实现，因为SwipeRefreshLayout是Android支持库的组成部分。为了避免重复执行这一工作流，Mosby库的<strong>MVP</strong>模块提供了<strong>MvpLceView</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public interface MvpLceView&lt;M&gt; extends MvpView&#123;</div><div class="line">	/**</div><div class="line">	   * 显示一个加载中的视图</div><div class="line">	   * loading view 必须有个id 为 R.id.loadingView的View</div><div class="line">	   * @param pullToRefresh 如果是true,那么表示下拉刷新被触发了</div><div class="line">	   */</div><div class="line">	public void showLoading(boolean pullToRefresh);</div><div class="line">	/**</div><div class="line">	   * 显示 content view.</div><div class="line">	   * &lt;content view 的id必须是R.id.contentView</div><div class="line">	   */</div><div class="line">	public void showContent();</div><div class="line"></div><div class="line">	/**</div><div class="line">	   * 显示错误信息</div><div class="line">	   * @param e The Throwable that has caused this error</div><div class="line">	   * @param pullToRefresh true, if the exception was thrown during pull-to-refresh, otherwise</div><div class="line">	   * false.</div><div class="line">	   */</div><div class="line">	public void showError(Throwable e,boolean pullToRefresh);</div><div class="line"></div><div class="line">	/**</div><div class="line">	   * The data that should be displayed with &#123;@link #showContent()&#125;</div><div class="line">	   */</div><div class="line">	public void setData(M data);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>针对那种类型的view我们可以采用 <strong>MvpLceActivity  implements  MvpLceView 和 MvpLceFragment  implements  MvpLceView。</strong>两者均假设解析的xml布局包括了含有<strong>R.id.loadingView,R.id.contentView和R.id.errorView的view</strong>。</p>
<p>示例<br>接下来要举的例子<a href="https://github.com/sockeqwe/mosby/tree/master/sample" target="_blank" rel="external">Github</a>上也有中，我们使用CountriesAsyncLoader加载一系列的Country，并将其显示在Fragment的RecyclerView中。大家可以从这个链接 <a href="https://db.tt/ycrCwt1L" target="_blank" rel="external">https://db.tt/ycrCwt1L</a>下载。</p>
<p>首先我们要定义<strong>CountriesView</strong>这一view interface 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public interface CountriesView extends MvpLceView&lt;List&lt;Country&gt;&gt;&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为什么要为View定义接口呢？<br>1.因为定义了这个接口之后我们可以更改view的实现。我们可以简单地把代码从一个继承自 Activity的实现转移到继承自 Fragment的实现。</p>
<p>2.模块性：我们可以移动独立的库项目中的整个业务逻辑层、Presenter以及View 接口，然后把这个包含了Presenter的库应用到各类app当中。下图中左侧是使用了嵌入在ViewPager中的Activity的<strong>kicker app</strong>，以及使用嵌入在ViewPager中的Fragment的<strong>meinVerein app</strong>，如图1-5。 两者采用的是同一个定义了View接口和Presenter且测试了单元的库。</p>
<p><img src="http://hannesdorfmann.com/images/mosby/mvp-reuse.png" alt=""></p>
<p>由于我们可以通过执行view接口来模拟view，所以我们可以很容易地编写单元测试。还有一个更简单的方法就是在presenter中引入java接口并使用模拟presenter对象来编写单元测试。<br>还有一个良性副作用就是，定义了view接口之后，我们不用直接从presenter再回调activity/fragment方法。我们这样区分开来是因为在执行presenter时我们在IDE自动完成上看到的方法只是关于view接口的方法。就我个人体会来说，我觉得这个方法非常有用，特别是团队一起工作的时候。需要注意的是，除了定义一个CountriesView接口之外，我们还可以采用<strong>MvpLceView<list<country>&gt;</list<country></strong> 。但是，定义一个专门的接口可以提高代码可读性，并且将来可以灵活地定义更多其他的与View相关的方法。</p>
<p>Next we define our views xml layout file with the required ids:</p>
<p>下一步我们需要按照指定的id来定义view xml 布局文件.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">FrameLayoutxmlns:android="http:</span>//<span class="attr">schemas.android.com</span>/<span class="attr">apk</span>/<span class="attr">res</span>/<span class="attr">android</span>"</span></div><div class="line"><span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line"><span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">&gt;</div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- Loading View --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">ProgressBar</span></span></div><div class="line">	<span class="attr">android:id</span>=<span class="string">"@+id/loadingView"</span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">	<span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></div><div class="line">	<span class="attr">android:indeterminate</span>=<span class="string">"true"</span></div><div class="line">	/&gt;</div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- Content View --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">android.support.v4.widget.SwipeRefreshLayout</span></span></div><div class="line">	<span class="attr">android:id</span>=<span class="string">"@+id/contentView"</span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">	&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/recyclerView"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">	/&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;/<span class="name">android.support.v4.widget.SwipeRefreshLayout</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- Error view --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/errorView"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">	/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>CountriesPresenter控制CountriesView并运行CountriesAsyncLoader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountriesPresenter</span> <span class="keyword">extends</span> <span class="title">MvpBasePresenter</span>&lt;<span class="title">CountriesView</span>&gt;</span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadCountries</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> pullToRefresh)</span></span>&#123;</div><div class="line">		getView().showLoading(pullToRefresh);</div><div class="line">		</div><div class="line">		CountriesAsyncLoader countriesLoader = <span class="keyword">new</span> CountriesAsyncLoader(</div><div class="line">		<span class="keyword">new</span> CountriesAsyncLoader.CountriesLoaderListener()&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;Country&gt; countries)</span></span>&#123;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(isViewAttached())&#123;</div><div class="line">				getView().setData(countries);</div><div class="line">				getView().showContent();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>&#123;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(isViewAttached())&#123;</div><div class="line">				getView().showError(e,pullToRefresh);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">		countriesLoader.execute();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现<strong>CountriesView</strong>接口 的<strong>CountriesFragment</strong> 如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountriesFragment</span></span></div><div class="line"> <span class="keyword">extends</span> <span class="title">MvpLceFragment</span>&lt;<span class="title">SwipeRefreshLayout</span>,<span class="title">List</span>&lt;<span class="title">Country</span>&gt;,<span class="title">CountriesView</span>,<span class="title">CountriesPresenter</span>&gt;</div><div class="line"> <span class="keyword">implements</span> <span class="title">CountriesView</span>,<span class="title">SwipeRefreshLayout</span>.<span class="title">OnRefreshListener</span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@InjectView</span>(R.id.recyclerView)RecyclerViewrecyclerView;</div><div class="line">	CountriesAdapteradapter;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewCreated</span><span class="params">(View view,@Nullable Bundle savedInstance)</span></span>&#123;</div><div class="line">	<span class="keyword">super</span>.onViewCreated(view,savedInstance);</div><div class="line"></div><div class="line">		<span class="comment">// Setup contentView == SwipeRefreshView</span></div><div class="line">		contentView.setOnRefreshListener(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">	<span class="comment">// Setup recycler view</span></div><div class="line">		adapter = <span class="keyword">new</span> CountriesAdapter(getActivity());</div><div class="line">		recyclerView.setLayoutManager(<span class="keyword">new</span> LinearLayoutManager(getActivity()));</div><div class="line">		recyclerView.setAdapter(adapter);</div><div class="line">		loadData(<span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">(<span class="keyword">boolean</span> pullToRefresh)</span></span>&#123;</div><div class="line">		presenter.loadCountries(pullToRefresh);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> CountriesPresenter <span class="title">createPresenter</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleCountriesPresenter();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Just a shorthand that will be called in onCreateView()</span></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getLayoutRes</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> R.layout.countries_list;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(List&lt;Country&gt; data)</span></span>&#123;</div><div class="line">		adapter.setCountries(data);</div><div class="line">		adapter.notifyDataSetChanged();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span></span>&#123;</div><div class="line">		loadData(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码数量也并不是很多嘛，对吧？这是因为基类已经执行了从加载view到content view或error view的转换。我们可能第一眼看到那一列<strong>MvpLceFragment</strong>类属参数会觉得灰心。但是我要解释一下：第一种类属参数代表的是content view的类型；第二种是指以fragment显示的Model；第三种是View接口;最后一种是Presenter的类型。总结起来就是：<strong>MvpLceFragment<androidview, model,="" view接口,="" presenter=""></androidview,></strong>。</p>
<p>大家可能还注意到的一个点就是 <strong>getLayoutRes()</strong>，它是<strong>MosbyFragment</strong>引入的用于解析xml view布局的速记法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater,ViewGroup container,Bundle savedInstanceState)</span></span>&#123;</div><div class="line">	Return  inflater.inflate(getLayoutRes(),container,<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因此，我们不用重写<strong>onCreateView()</strong>，只需重写<strong>getLayoutRes()</strong>。一般来说，onCreateView()只能创建view而<strong>onViewCreated()</strong>需要被重写，以便为RecyclerView初始化Adapter等项。因此，千万不要忘记调用super.OnViewCreated()；</p>
<p>##ViewState模块</p>
<p>看到这里大家应该大概了解了如何运用Mosby库。Mosby中的ViewState模块能帮助我们在Android开发中解决一些棘手的难题：处理屏幕旋转。</p>
<p>问：如果把正在运行country这个例子的app并显示了一列country的设备从横屏旋转到竖屏，会出现什么情况？</p>
<p>答：大家到这个视频链接<a href="https://youtu.be/9iSBGEIZmUw" target="_blank" rel="external">https://youtu.be/9iSBGEIZmUw</a>中看看，结果是一个新的 CountriesFragment会被实例化，app开始显示ProgressBar（并重新加载country列表）而不再在RecyclerView中显示country列表（屏幕旋转前的状态）</p>
<p>Mosby引入了<strong>ViewState</strong>来解决这个问题。原理就是，我们跟踪presenter从关联的View中调用的方法。比如，<strong>presenter</strong>调用的是view.showContent()，一旦showContent()被调用，view就会意识到其状态变更为<strong>“showing content”</strong>，从而view把这一信息存储到一个ViewState。如果view在方向改变过程中遭到破坏，那么ViewState 就会被存储到<strong>Activity.onSaveInstanceState(Bundle) 或 Fragment.onSaveInstanceState(Bundle)中，并在Activity.onCreate(Bundle) 或Fragment.onActivityCreated(Bundle)</strong>中修复。</p>
<p>由于不是每种数据都能存储在Bundle中，所以不同的数据类型采用不同的ViewState 实现：数据类型<strong>ArrayList<parcelable></parcelable></strong>采用<strong>ArrayListLceViewState</strong>；数据类型Parcelable 采用<strong>Parcelable DataLceViewState</strong>；数据类型<strong>Serializeable</strong>采用<strong>SerializeableLceViewState</strong>。如果使用的是一个可保持( Retaining )的Fragment，那么 ViewState在屏幕旋转时不会被破坏，所以也就不需要存储到Bundle中。因此，它可以存储任何类型的数据。在这种情况下，我们需要使用<strong>RetainingFragmentLceViewState</strong>。存储一个ViewState比较容易。由于我们的架构比较整洁，我们的View又有接口，ViewState 可以向presenter一样通过调用同样的接口方法来修复相关联的view。举个例子，MvpLceView一般有3种状态，即：显示<strong>showContent()，showLoading()和showError()</strong>，所以ViewState本身会调用相应的方法来修复view的状态。</p>
<p>那只是一些内部构件。如果大家想编写自定义的ViewState，了解以上内容就够了。ViewStates的使用非常简单。事实上，要把MvpLceFragment 迁移到MvpLceViewStateFragment ，我们只需要另外执行<strong>createViewState()</strong> 和 <strong>getData()</strong>。下面我们就在CountriesFragment中实践一下吧：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountriesFragment</span></span></div><div class="line"> <span class="keyword">extends</span> <span class="title">MvpLceViewStateFragment</span>&lt;<span class="title">SwipeRefreshLayout</span>,<span class="title">List</span>&lt;<span class="title">Country</span>&gt;,<span class="title">CountriesView</span>,<span class="title">CountriesPresenter</span>&gt;</div><div class="line"> <span class="keyword">implements</span> <span class="title">CountriesView</span>,<span class="title">SwipeRefreshLayout</span>.<span class="title">OnRefreshListener</span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@InjectView</span>(R.id.recyclerView)RecyclerView recyclerView;</div><div class="line">	CountriesAdapter adapter;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="keyword">public</span> LceViewState&lt;List&lt;Country&gt;,CountriesView&gt; createViewState()&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RetainingFragmentLceViewState&lt;List&lt;Country&gt;,CountriesView&gt;(<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> List&lt;Country&gt; <span class="title">getData</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> adapter == <span class="keyword">null</span>? <span class="keyword">null</span> : adapter.getCountries();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// The code below is the same as before</span></div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewCreated</span><span class="params">(Viewview,@Nullable Bundle savedInstance)</span></span>&#123;</div><div class="line">	<span class="keyword">super</span>.onViewCreated(view,savedInstance);</div><div class="line"></div><div class="line">	<span class="comment">// Setup contentView == SwipeRefreshView</span></div><div class="line">	contentView.setOnRefreshListener(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">	<span class="comment">// Setup recycler view</span></div><div class="line">		adapter = <span class="keyword">new</span> CountriesAdapter(getActivity());</div><div class="line">		recyclerView.setLayoutManager(<span class="keyword">new</span> LinearLayoutManager(getActivity()));</div><div class="line">		recyclerView.setAdapter(adapter);</div><div class="line">		loadData(<span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">(<span class="keyword">boolean</span> pullToRefresh)</span></span>&#123;</div><div class="line">		presenter.loadCountries(pullToRefresh);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> CountriesPresenter <span class="title">createPresenter</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleCountriesPresenter();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Just a shorthand that will be called in onCreateView()</span></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getLayoutRes</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> R.layout.countries_list;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(List&lt;Country&gt; data)</span></span>&#123;</div><div class="line">		adapter.setCountries(data);</div><div class="line">		adapter.notifyDataSetChanged();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span></span>&#123;</div><div class="line">		loadData(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上就是全部过程啦。我们不必更改presenter或其他代码。<a href="https://youtu.be/9iSBGEIZmUw" target="_blank" rel="external">这里</a> 是一个关于我们的获得ViewState支持的CountriesFragment的视频。在这个视频中我们可以看到，view在方位转变之后仍然处于同样的“状态”，即，view横屏显示country列表，随后横屏显示country列表。View能横屏显示下拉刷新指示，变更为竖屏时也能显示。</p>
<p>##自定义ViewState</p>
<p>ViewState确实是一个强大且灵活的概念。看到这里我相信大家都了解了LCE (Loading-Content-Error) ViewState的易用性。下面我们就一起来编写自己的View和ViewState吧。我们的View只显示两类不同的数据对象：A和B。结果应该像这个视频 <a href="https://youtu.be/9iSBGEIZmUw" target="_blank" rel="external">https://youtu.be/9iSBGEIZmUw</a> 中演示的这样：</p>
<p>大家心里肯定觉得，这也不怎么样啊！别介啊，我只是想演示一下创建自己的ViewState是一件多么容易的事。</p>
<p>View 接口和数据对象（model）如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line">	String  name;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(String  name)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.name=name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String  <span class="title">getName</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line">	String  foo;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(String  foo)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.foo=foo;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String  <span class="title">getFoo</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> foo;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyCustomView</span> <span class="keyword">extends</span> <span class="title">MvpView</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showA</span><span class="params">(A a)</span></span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showB</span><span class="params">(B b)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个简单的例子中我们没有加入业务逻辑层。因为我们假设在实际的app中如果有业务逻辑层的话会使整个生成A或B的操作变得复杂。<strong>Presenter</strong>如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCustomPresenter</span> <span class="keyword">extends</span> <span class="title">MvpBasePresenter</span>&lt;<span class="title">MyCustomView</span>&gt;</span>&#123;</div><div class="line">	Random random = <span class="keyword">new</span> Random();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doA</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">		A a = <span class="keyword">new</span> A(<span class="string">"My name is A "</span>+random.nextInt(<span class="number">10</span>));</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(isViewAttached())&#123;</div><div class="line">			getView().showA(a);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doB</span><span class="params">()</span></span>&#123;</div><div class="line">		B b = <span class="keyword">new</span> B(<span class="string">"I am B "</span>+random.nextInt(<span class="number">10</span>));</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(isViewAttached())&#123;</div><div class="line">			getView().showB(b);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们定义了实现了MyCustomView接口的<strong>MyCustomActivity</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCustomActivity</span> <span class="keyword">extends</span> <span class="title">MvpViewStateActivity</span>&lt;<span class="title">MyCustomPresenter</span>&gt;</span></div><div class="line"> <span class="keyword">implements</span> <span class="title">MyCustomView</span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@InjectView</span>(R.id.textViewA) TextViewaView;</div><div class="line">	<span class="meta">@InjectView</span>(R.id.textViewB) TextViewbView;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span>&#123;</div><div class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		setContentView(R.layout.my_custom_view);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> RestoreableViewState <span class="title">createViewState</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MyCustomViewState();<span class="comment">// Our ViewState implementation</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Will be called when no view state exist yet,</span></div><div class="line">	<span class="comment">// which is the case the first time MyCustomActivity starts</span></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> onNew <span class="title">ViewStateInstance</span><span class="params">()</span></span>&#123;</div><div class="line">		presenter.doA();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> MyCustomPresenter <span class="title">createPresenter</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MyCustomPresenter();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showA</span><span class="params">(A a)</span></span>&#123;</div><div class="line">		MyCustomViewState vs = ((MyCustomViewState)viewState);</div><div class="line">		vs.setShowingA(<span class="keyword">true</span>);</div><div class="line">		vs.setData(a);</div><div class="line">		aView.setText(a.getName());</div><div class="line">		aView.setVisibility(View.VISIBLE);</div><div class="line">		bView.setVisibility(View.GONE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showB</span><span class="params">(B b)</span></span>&#123;</div><div class="line">		MyCustomViewState vs=((MyCustomViewState)viewState);</div><div class="line">		vs.setShowingA(<span class="keyword">false</span>);</div><div class="line">		vs.setData(b);</div><div class="line">		bView.setText(b.getFoo());</div><div class="line">		aView.setVisibility(View.GONE);</div><div class="line">		bView.setVisibility(View.VISIBLE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@OnClick</span>(R.id.loadA)<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadAClicked</span><span class="params">()</span></span>&#123;</div><div class="line">		presenter.doA();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@OnClick</span>(R.id.loadB)<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadBClicked</span><span class="params">()</span></span>&#123;</div><div class="line">		presenter.doB();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于我们没有LCE(Loading-Content-Error)，所以不把 <strong>MvpLceActivity</strong>作为基类。我们采用的是最普遍的支持 ViewState的<strong>MvpViewStateActivity</strong>作为基类。基本上我们的View只显示aView 或 bView。</p>
<p>在<strong>onNew ViewStateInstance()</strong>中，我们需要明确在第一个Activity运行时需要做什么，因为先前并不存在ViewState 例子用于修复。在showA(A a) 和 showB(B b)中，我们需要将显示A 或 B的信息存储到ViewState。到这一步，我们就差不多完成了，现在只差MyCustomViewState执行这一步啦：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">ublic <span class="class"><span class="keyword">class</span> <span class="title">MyCustomViewState</span> <span class="keyword">implements</span> <span class="title">RestoreableViewState</span>&lt;<span class="title">MyCustomView</span>&gt;</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span>  <span class="keyword">final</span> String  KEY_STATE=<span class="string">"MyCustomViewState-flag"</span>;</div><div class="line">	<span class="keyword">private</span>  <span class="keyword">final</span> String  KEY_DATA=<span class="string">"MyCustomViewState-data"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> showingA=<span class="keyword">true</span>;<span class="comment">// if false, then show B</span></div><div class="line">	<span class="keyword">public</span> Parcelable  data;<span class="comment">// Can be A or B</span></div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveInstanceState</span><span class="params">(Bundle out)</span></span>&#123;</div><div class="line">		out.putBoolean (KEY_STATE,showingA);</div><div class="line">		out.putParcelable (KEY_DATA,data);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">restoreInstanceState</span><span class="params">(Bundle in)</span></span>&#123;</div><div class="line">		<span class="keyword">if</span>(in==<span class="keyword">null</span>)&#123;</div><div class="line">		 <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		showingA = in.getBoolean (KEY_STATE,<span class="keyword">true</span>);</div><div class="line">		data = in.getParcelable (KEY_DATA);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(MyCustomView view,<span class="keyword">boolean</span> retained)</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(showingA)&#123;</div><div class="line">			view.showA((A)data);</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			view.showB((B)data);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	   * <span class="doctag">@param</span> a true if showing a, false if showing b</div><div class="line">	   */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setShowingA</span><span class="params">(<span class="keyword">boolean</span> a)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.showingA=a;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(Parcelable data)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.data=data;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大家可以看到，我们需要把<strong>ViewState</strong>保存到从<strong>Activity.onSaveInstanceState()</strong>调用的 <strong>saveInstanceState()</strong>中，并且在从Activity.onCreate()调用的<strong>restoreInstanceState()</strong>中修复viewstate的数据。apply()方法将会从Activity中调用以修复view state。我们像presenter一样通过调用同样的View interface  方法showA() 或 showB()来实现这一操作。</p>
<p>大家可以看到，我们需要把ViewState保存到从<strong>Activity.onSaveInstanceState()</strong>调用的 <strong>saveInstanceState()</strong>中，并且在从Activity.onCreate()调用的<strong>restoreInstanceState()</strong>中修复viewstate的数据。apply()方法将会从Activity中调用以修复view state。我们像presenter一样通过调用同样的View interface  方法showA() 或 showB()来实现这一操作。</p>
<p>这个外部的<strong>ViewState</strong>把view state修复的复杂性和职责从Activity代码中剥离，并入到这个单独的类中。而编写<strong>ViewState</strong>类的单元测试要比Activity类的单元测试容易得多。</p>
<p>##怎样处理后台线程？<br>通常，<strong>Presenter</strong>会管理后台线程。Presenter如何处理后台线程取决于它所关联的Activity或者Fragment ，具体分为两种情况：</p>
<ul>
<li>可保持的Fragment : 如果你调用了Fragment的setRetainInstanceState(true)那么这个Fragment在屏幕旋转时就不会被销毁。只有该Fragment的GUI会被销毁，并且在屏幕旋转时重新调用onCreateView创建视图。这就是说当屏幕旋转时Fragment所有的成员成员变量和Presenter不会发生变化。在这个示例中，我们将新的视图关联到Presenter中。因此，Presenter不需要去掉任何正在运行中的后台任务，因为Presenter已经关联了新的视图。例如:</li>
</ul>
<p>1.竖屏情况下启动应用<br>2.实例化Fragment时会调用onCreate()、onCreateView()、createPresenter(), 然后通过调用presenter的attachView()函数将View关联到Presenter中。</p>
<ol>
<li>下一步我们旋转手机屏幕，从竖屏切换到横屏；</li>
<li>此时onDestroyView() 会调用，而onDestroyView() 又会调用presenter的detachView(true)函数。我们注意到detachView有个参数为true,这是告诉presenter这个Fragment是可持有的Fragment（否则这个参数应该为false）。通过这个参数，presenter就知道它不需要取消正在运行的后台任务；</li>
<li>应用现在是横屏状态了，在旋转时onCreateView方法会被调用，但是createPresenter()函数不会被调用，因为我们会对presenter 进行不为空的判断，当presenter为空时才调用createPresenter()函数。而Fragment的setRetainInstanceState(true)会保持这个presenter对象，因此presenter此时不会被重新创建；</li>
<li>在调用了presenter的attachView()之后新创建的View会被重新关联到presenter中。</li>
<li>ViewState会被恢复，但是没有后台任务会被取消，因此也没有后台任务需要重新启动。</li>
</ol>
<ul>
<li>Activity和不保持的Fragment :在这个示例中工作流非常的简单。所有的东西都会被销毁，包括presenter。因此presenter对象应该取消所有正在运行的任务。例如 :<br>我们采用非保持fragment在竖屏情况下启动app。</li>
</ul>
<p>8.我们采用非保持fragment在竖屏情况下启动app。<br>9.Fragment被实例化之后，调用onCreate()， onCreateView()，和createPresenter()，然后通过调用<strong>presenter.attachView()</strong>将<strong>view（fragment）</strong>附着到presenter。<br>10.下一步我们旋转设备屏幕，从竖屏切换到横屏。<br>11.此时onDestroyView() 会调用，而<strong>onDestroyView()</strong> 又会调用<strong>presenter</strong>的<strong>detachView(true)</strong>函数。<strong>Presenter</strong>取消后台任务。</p>
<ol>
<li><strong>onSaveInstanceState(Bundle)</strong>被调用， <strong>ViewState</strong>被保存到Bundle中。</li>
<li><strong>App</strong>现在出于横屏状态。新的Fragment被实例化并调用onCreate()，onCreateView()和 <strong>createPresenter()</strong>来创建一个新的presenter例子，通过调用<strong>presenter.attachView()</strong>将新的view附着到新的presenter</li>
<li><strong>ViewState</strong>会从<strong>Bundle</strong>中恢复，且view的状态也会被恢复。如果ViewState是showLoading，那么<strong>presenter</strong>会重新启动后台线程来加载数据。</li>
<li>以下是获得ViewState支持的Activity的生命周期图解，如图1-6：<br><img src="http://hannesdorfmann.com/images/mosby/mvp-activity-lifecycle.png" alt=""></li>
</ol>
<p>以下是获得ViewState支持的Fragment的生命周期图解， 如图 1-7：<br><img src="http://hannesdorfmann.com/images/mosby/mvp-fragment-lifecycle.png" alt=""></p>
<p>##Retrofit模块</p>
<p>Mosby提供了 <strong>LceRetrofitPresenter</strong> 和 <strong>LceCallback</strong>。为获得LCE方法showLoading(), showContent() 和 showError()支持的Retrofit编写presenter ，几行代码就能搞定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MembersPresenter</span> <span class="keyword">extends</span> <span class="title">LceRetrofitPresenter</span>&lt;<span class="title">MembersView</span>,<span class="title">List</span>&lt;<span class="title">User</span>&gt;&gt;</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span>  GithubApigithubApi;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MembersPresenter</span><span class="params">(GithubApi githubApi)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.githubApi=githubApi;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadSquareMembers</span><span class="params">(<span class="keyword">boolean</span> pullToRefresh)</span></span>&#123;</div><div class="line">		githubApi.getMembers(<span class="string">"square"</span>,<span class="keyword">new</span> LceCallback(pullToRefresh));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##Dagger模块<br>   想在不依靠注入式的情况下写应用？Ted Mosby告诉你，这是行不通滴！Dagger是java依赖注入式框架最常用的方法，也是Android开发者们的心头好。Mosby支持Dagger1。Mosby通过一个叫做getObjectGraph()的方法提供Injector界面。通常，我们的应用模块非常广泛。要想轻松分享这一模块，我们需要把android.app.Application归入子类，使其执行Injector。之后所有的Activity和Fragment都可以通过调用getObjectGraph()来存取ObjectGraph，因为<strong>DaggerActivity and DaggerFragment</strong>也都是Injector。我们也可以通过重写Activity 或 Fragment中的 getObjcetGraph() ，从而调用plus(Module)以增加模块。我个人已经用到Dagger2了，它与Mosby也兼容。大家可以在Github上找到关于Dagger1 和 Dagger2的示例。点此这个链接<a href="https://db.tt/3fVqVdAz" target="_blank" rel="external">https://db.tt/3fVqVdAz</a>Dagger1示例 apk；点此这个链接<a href="https://db.tt/z85y4fSY" target="_blank" rel="external">https://db.tt/z85y4fSY</a>Dagger2 示例 apk。</p>
<p>##Rx模块<br>   <strong>Observables</strong>赞爆了！现在稍微潮一点的小伙儿们都用RxJava了好吗！你猜结果怎么着？RxJava确实是太酷了！所以，Mosby给大家提供一个本质上是Subscriber的MvpLceRxPresenter，它能帮我们自动处理<strong>onNext()， onCompleted() 和 onError()并回调相应的LCE方法，比如showLoading(), shwoContent() </strong>和 showError()。它还将 RxAndroid 附带到observerOn() Android主要 UI 线程。你可能觉得，要是用了RxJava的话就不再需要Model View Presenter了。呃，那只是你的一家之言。在我看来，把View和Model清晰地区分开来非常重要。而且我也认为其中的某些好用的功能在没有MVP的情况下不容易执行。最后，大家要是还想回到过去那个Activity和Fragment包含了上千条又臭又长的代码行时代，那么我祝你在面条式代码的地狱里过得愉快。好了，废话不多说，我介绍的方法不属于面条式代码是因为Observerables引入了一个结构齐整的工作流，把Activity或Fragment做成一个BLOB的想法已经近在咫尺了。</p>
<p>##测试模块<br>大家可能注意到这里存在着一个测试模块。这个模块用于Mosby库的内部测试。但是，它也可以为我们自己的app所用。它使用Robolectric为我们的LCE Presenter， Activities 和 Fragments提供单元测试模板。它的基本功能是查看测试中的Presenter是否正确工作：通过观察presenter时候调用showLoading()，<br><strong>showContent()</strong> 和 <strong>showError()</strong>。我们还可以验证setData()中的数据。所以我们可以为Presenter和底层编写类似黑匣子的测试。Mosby的测试模块也提供了测试MvpLceFragment 或 <strong>MvpLceActivity</strong>的可能性。它相当于一种“精简版”的UI 测试。这些测试通过查看xml布局是否包含R.id.loadingView， R.id.contentView 和R.id.errorView之类的指定id、loadingView是否可视，在加载view时，是否是错误的view可视、content view能否处理由setData()提交的已加载数据等方面来检验Fragment或Activity是否正常工作，是否遇到crashing。它和Espresso类的UI测试并不相同。我觉得没有必要为LCE View单独写一个UI 测试。</p>
<p>以下是Ted Mosby库的一些测试小建议：</p>
<ol>
<li>编写传统的单元测试来测试业务逻辑层和model。</li>
<li>使用<strong>MvpLcePresenterTest</strong>来测试presenter。<br>3.使用<strong>MvpLceFragmentTest</strong> 和 <strong>MvpLceActivityTest</strong>来测试MvpLceFragment 和 Activity。<br>4.如果有必要，可以使用Espresso来编写UI测试。</li>
</ol>
<p>测试模块尚未完成。大家可以看到这个模块是测试版，因为Robolectric 3.0还没完成，而且Android gradle plugin也没用完全支持传统的单元测试。android gradle plugin </p>
<p>1.2应该会好得多。Robolectric 和 androids gradle plugin可以用了之后我会再写一篇关于Mosby，Dagger，Retrofit和RxJava单元测试的博客。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/MVP框架Mosby架构详解/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/MVP框架Mosby架构详解/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/NotRxJava懒人专用指南/" title="NotRxJava懒人专用指南" itemprop="url">NotRxJava懒人专用指南</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://yarikx.github.io/NotRxJava/" target="_blank" rel="external">NotRxJava guide for lazy folks</a></li>
</ul>
<p>如果你是一位 Android 开发者，那么这些天你可能已经听到或看到一些关于 RxJava 满天飞的宣传了。RxJava 是一个能让你摆脱编写一些复杂繁琐的代码去处理异步事件的库。一旦开始在你的项目中使用，你会对它爱不释手的。</p>
<p>然而，RxJava 有个缺陷，它需要一个陡峭的学习过程。对于一个从未接触使用过 RxJava 的人来说，是很难一次就领会到它的精髓所在的，对于它的一些使用方法你也可能会很迷惑。在项目中使用它意味着你需要稍微地改变一下你的代码编写思路，另外，这样的学习曲线会使得在项目中因为大规模的使用RxJava而引发一些问题。</p>
<p>当然，关于如何去使用 RxJava 已经有许多的教程和代码范例了。感兴趣的开发者可以访问 RxJava 的官方 <a href="https://github.com/ReactiveX/RxJava/wiki" target="_blank" rel="external">Wiki</a>，里面有关于什么是 Observable 以及它和 Iterable、Future 之间关系的很好的解释。Wiki 里有一篇很有用的文章：<a href="https://github.com/ReactiveX/RxJava/wiki/How-To-Use-RxJava" target="_blank" rel="external">How To Use RxJava</a>，这篇文章包含怎么去发送事件流并且打印出它们的介绍以及它的样例代码。</p>
<p>但我们要明确的是在还没有学习什么是 Observable 的前提下了解 RxJava 用来解决什么问题以及它是怎么帮助我们组织起异步代码的。</p>
<p>我这篇文章的定位就是 RxJava 官方文档的“前篇”，读完这篇文章能更好地去理解 RxJava 所解决的问题。文章中也有一个小 Demo，就是自己怎么去整理那些凌乱的代码，然后看看我们在没有使用 RxJava 的情况下是怎么去遵循 RxJava 基本原则的。</p>
<p>所以，如果你仍有足够的好奇的话就让我们开始吧！</p>
<h2 id="Cat-应用程序"><a href="#Cat-应用程序" class="headerlink" title="Cat 应用程序"></a>Cat 应用程序</h2><p>让我们来创建一个真实世界的例子。我们都知道猫是我们技术发展的引擎，所以就让我们也来创建这么一个用来下载猫图片的典型应用吧。</p>
<p><strong>任务描述</strong></p>
<blockquote>
<p>我们有个 Web API，能根据给定的查询请求搜索到整个互联网上猫的图片。每个图片包含可爱指数的参数（描述图片可爱度的整型值）。我们的任务将会下载到一个猫列表的集合，选择最可爱的那个，然后把它保存到本地。</p>
</blockquote>
<p>我们只关心下载、处理和保存猫的数据。</p>
<p>我们开始吧~</p>
<h2 id="模型和-API"><a href="#模型和-API" class="headerlink" title="模型和 API"></a>模型和 API</h2><p>下面是描述“猫”的简单数据结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Cat</span>&gt;</span>&#123;</div><div class="line">    Bitmap image;</div><div class="line">    <span class="keyword">int</span> cuteness;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Cat another)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Integer.compare(cuteness, another.cuteness);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还有我们传统阻塞式风格的 API，它被打包进 cat-sdk.jar 中了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="function">List&lt;Cat&gt; <span class="title">queryCats</span><span class="params">(String query)</span></span>;</div><div class="line">    <span class="function">Uri <span class="title">store</span><span class="params">(Cat cat)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这足够清楚了吗？当然！那就让我们开始编写业务逻辑吧：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">saveTheCutestCat</span><span class="params">(String query)</span></span>&#123;</div><div class="line">        List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">        Cat cutest = findCutest(cats);</div><div class="line">        Uri savedUri = api.store(cutest);</div><div class="line">        <span class="keyword">return</span> savedUri;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>唉，这样清晰简单的代码帅到让我窒息啊。来理清一下代码的炫酷之处吧。主方法 saveTheCutestCat 只包含了 3 个其它方法，然后花个几分钟来看看代码和思考这些方法。你给方法提供了输入参数然后就能得到结果返回了，在这个方法工作的时候我们需要等待它的完成。</p>
<p>简洁而有用，让我们再看看组合方法的其它优势：</p>
<p><strong>组合</strong></p>
<p>正如我们看到的，根据其它 3 个方法而新创建了一个方法（<code>saveTheCutestCat</code>），因此我们组合了它们。像乐高积木那样，我们把方法之间连接起来组成了乐高积木（实际上可以在之后组合起来）。组合方法是很简单的，从一个方法得到返回结果然后再把它传递给另外的方法做为输入参数，这不简单吗？</p>
<p><strong>错误的传递</strong></p>
<p>另外一个好处就是我们处理错误的方式了。任何一个方法都可能因执行时发生错误而被终止，这个错误能在任何层次上被处理掉，Java 中我们叫它抛出了异常，然后这个错误在 try/catch 代码块中做处理。这里的关键点是我们不需要为组合方法里的每个方法都做异常处理，仅需要对这些组合起来的方法做统一处理，像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">    Cat cutest = findCutest(cats);</div><div class="line">    Uri savedUri = api.store(cutest);</div><div class="line">    <span class="keyword">return</span> savedUri;</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    e.printStackTrace()</div><div class="line">    <span class="keyword">return</span> someDefaultValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个情况下，我们处理了所有执行时的错误，或者说如果我们没有使用 try/catch 代码块我们能够把错误传递到下一个层次上。</p>
<h2 id="走向异步"><a href="#走向异步" class="headerlink" title="走向异步"></a>走向异步</h2><p>要知道我们身在一个对等待很敏感的世界里，我们也知道不可能只有阻塞式的调用。在 Android 中我们也总需要处理异步代码。</p>
<p>拿 Android 的 <code>OnClickListener</code> 举个例子，当你需要处理一个控件的点击事件时，你必须提供一个监听器（回调）以供在用户点击控件时被调用。这没有理由使用阻塞的方式去接受点击事件的回调，所以对点击来说总是异步的。现在，让我们也使用异步编程吧。</p>
<p><strong>异步的网络调用</strong></p>
<p>开始想象下使用没有阻塞的 HTTP client（例如<a href="https://github.com/koush/ion" target="_blank" rel="external">Ion</a>），还有就是我们的<code>cats-sdk.jar</code>已经更新。它的 API 也换成了异步的方式调用。</p>
<p>新 API 的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">CatsQueryCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, CatsQueryCallback catsQueryCallback)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Uri <span class="title">store</span><span class="params">(Cat cat)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以现在我们能异步的获取猫的信息集合列表了，返回正确或错误的结果时都会通过 <code>CatsQueryCallback</code>回调接口。</p>
<p>因为 API 改变了所以我们也不得不改变我们的<code>CatsHelper</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CutestCatCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCutestCatSaved</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, CutestCatCallback cutestCatCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                Uri savedUri = api.store(cutest);</div><div class="line">                cutestCatCallback.onCutestCatSaved(savedUri);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们已经不能使用阻塞的 API 了，我们也不能把我们的客户端上写成阻塞式的调用（实际上是可以的，但需要明确的在线程中使用<code>synchronized</code>、<code>CountdownLatch</code>、等等，也需要在下层中使用异步处理）。所以我们不能在 <code>saveTheCutestCat</code>方法中直接返回一个值，我们需要对它进行异步回调处理。</p>
<p>让我们再深入一点，如果我们 API 的两个方法调用都是异步的，举个例子，我们正在使用非阻塞IO去写进一个文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">CatsQueryCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">StoreCallback</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, CatsQueryCallback catsQueryCallback)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(Cat cat, StoreCallback storeCallback)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还有我们的 helper：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CutestCatCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCutestCatSaved</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, CutestCatCallback cutestCatCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                api.store(cutest, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onCutestCatSaved(uri);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在再来看看代码，跟之前一样优雅吗？明显不是了，这很糟糕！现在它有了更多无关代码和花括号，但是逻辑是一样的。</p>
<p>那么组合在哪呢？他已经不见了！现在你不能像之前那样组合操作了。对于每一个异步操作你都必须创建出回调接口并在代码中插入它们，每一次都需要手动地加入！</p>
<p>错误传递又在哪？又是一个否定！在这样的代码中错误不会自动地传递，我们需要在更深一层上通过自己手动地再让它传递下去（请看<code>onStoreFailed</code>和<code>onQueryFailed</code>方法）。</p>
<p>我们很难对这样的代码进行阅读和找出潜在的 bugs。</p>
<p><strong>结束了？</strong></p>
<p>结束了又怎样？我们能拿它来干嘛？我们被困在这个没有组合回调的地狱里了吗？前方高能，请抓紧你的安全带哦，我们将努力的去把这些干掉！</p>
<h2 id="更美好的世界！"><a href="#更美好的世界！" class="headerlink" title="更美好的世界！"></a>更美好的世界！</h2><h3 id="泛型回调"><a href="#泛型回调" class="headerlink" title="泛型回调"></a>泛型回调</h3><p>可以从我们的回调接口中找到共同的模式：</p>
<ul>
<li><p>都有一个分发结果的方法（<code>onCutestCatSaved</code>,<code>onCatListReceived</code>,<code>onCatStored</code>）</p>
</li>
<li><p>它们中大多数（在我们的例子中是全部）有一个用于错误处理的方法（<code>onError</code>,<code>onQueryFailed</code>,<code>onStoreFailed</code>）</p>
</li>
</ul>
<p>所以我们可以创建一个泛型回调接口去替代原来所有的接口。但是我们不能去改变 API 的调用方法的签名，我们必须创建包装类来间接调用。</p>
<p>所以我们的泛型回调接口看起来是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们来创建<code>ApiWrapper</code>来改变一下调用方法的签名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, Callback&lt;List&lt;Cat&gt;&gt; catsCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                catsCallback.onResult(cats);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                catsCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">store</span><span class="params">(Cat cat, Callback&lt;Uri&gt; uriCallback)</span></span>&#123;</div><div class="line">        api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                uriCallback.onResult(uri);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                uriCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以这仅仅是对于<code>Callback</code>的一些传递 resuts/errors 的调用转发逻辑。</p>
<p>最后我们的<code>CatsHelper</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span></span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, Callback&lt;Uri&gt; cutestCatCallback)</span></span>&#123;</div><div class="line">        apiWrapper.queryCats(query, <span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                apiWrapper.store(cutest, cutestCatCallback);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到比之前的简明了一些。我们可以通过直接传递一个顶级的<code>cutestCatCallback</code>回调接口给<code>apiWrapper.store</code>来减少回调间的层级调用，此外作为回调方法的签名是一样的。</p>
<p>但是我们可以做的更好！</p>
<h3 id="你必须把它分开"><a href="#你必须把它分开" class="headerlink" title="你必须把它分开"></a>你必须把它分开</h3><p>让我们来看看我们的异步操作（<code>queryCats</code>，<code>queryCats</code>，还有<code>saveTheCutestCat</code>），它们都遵循了相同的模式。调用它们的方法有一些参数（<code>query</code>、<code>cat</code>）也包括一个回调对象。再次说明：任何异步操作需要携带所需的常规参数和一个回调实例对象。如果我们试图去分开这几个阶段，每个异步操作仅仅将会携带一个参数对象，然后返回一些携带着回调（信息）的临时对象。</p>
<p>我们来应用下这样的模式，看看是否对我们有所帮助。</p>
<p>如果在异步操作中返回一些临时对象，我们需要定义一个出来。这样的一个对象需要包括常见的行为（以回调为单一参数），我们将定义这样的类给所有的异步操作使用，这个类就叫它<code>AsyncJob</code>。</p>
<blockquote>
<p>P.S. 称之为<code>AsyncTask</code>更合适一点，但是我不希望你混淆了异步操作跟另外一个存在的抽象概念之间的关系（这是不好的一点）。</p>
</blockquote>
<p>所以：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>非常的简单，<code>Callback</code>传进方法后就会开始它的工作任务。</p>
<p>然后更改包装 API 的调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> AsyncJob&lt;List&lt;Cat&gt;&gt; queryCats(String query) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;List&lt;Cat&gt;&gt; catsCallback)</span> </span>&#123;</div><div class="line">                api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                        catsCallback.onResult(cats);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        catsCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">store</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; uriCallback)</span> </span>&#123;</div><div class="line">                api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        uriCallback.onResult(uri);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        uriCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>目前一切顺利，我们只是部分运用我们的包装过的 API 调用在程序之中。现在我们可以开始使用<code>AsyncJob</code>去做我们想要的了，当然也到更改<code>CatsHelper</code>的时间了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                apiWrapper.queryCats(query)</div><div class="line">                        .start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                                Cat cutest = findCutest(cats);</div><div class="line">                                apiWrapper.store(cutest)</div><div class="line">                                        .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                            <span class="meta">@Override</span></div><div class="line">                                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                                cutestCatCallback.onResult(result);</div><div class="line">                                            &#125;</div><div class="line"></div><div class="line">                                            <span class="meta">@Override</span></div><div class="line">                                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                                cutestCatCallback.onError(e);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125;);</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                cutestCatCallback.onError(e);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哇，之前的版本更简单些啊，我们现在的优势是什么？答案就是现在我们可以给客户端返回“组合”操作的<code>AsyncJob&lt;Uri&gt;</code>。所以一个客户端（在 activity 或者 fragment 处）可以用组合起来的工作来操作。</p>
<h3 id="Breaking-things"><a href="#Breaking-things" class="headerlink" title="Breaking things"></a>Breaking things</h3><p>这是我们的逻辑数据流：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">         (async)                 (sync)           (async)</div><div class="line">query ===========&gt; List&lt;Cat&gt; -------------&gt; Cat ==========&gt; Uri</div><div class="line">       queryCats              findCutest           store</div></pre></td></tr></table></figure></p>
<p>为了让我们的代码拥有之前的可读性，我们从这个事件流中强行进入到里面的操作里。但有件事需要注意，如果某些操作（方法）是异步的，然后调用它的操作（方法）又是异步的，就比如，查询猫的操作是异步的，然后寻找出最可爱的猫（即使有一个阻塞调用）也是一个异步操作（客户端希望接收的结果）。</p>
<p>所以我们可以使用 AsyncJobs 把我们的方法分解成更小的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Cat&gt; callback)</span> </span>&#123;</div><div class="line">                catsListAsyncJob.start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; result)</span> </span>&#123;</div><div class="line">                        callback.onResult(findCutest(result));</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                cutestCatAsyncJob.start(<span class="keyword">new</span> Callback&lt;Cat&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Cat cutest)</span> </span>&#123;</div><div class="line">                        apiWrapper.store(cutest)</div><div class="line">                                .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onResult(result);</div><div class="line">                                    &#125;</div><div class="line"></div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onError(e);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码量多了许多，但是更加清晰了。低层次嵌套的回调，利于理解的变量名（<code>catsListAsyncJob</code>、<code>cutestCatAsyncJob</code>、<code>storedUriAsyncJob</code>）。</p>
<p>看起来好了许多，但我们要再做一些事情：</p>
<h3 id="简单映射"><a href="#简单映射" class="headerlink" title="简单映射"></a>简单映射</h3><p>现在看看 <code>AsyncJob&lt;Cat&gt; cutestCatAsyncJob</code>的部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">AsyncJob&lt;Cat&gt; cutestCatAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Cat&gt; callback)</span> </span>&#123;</div><div class="line">                catsListAsyncJob.start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; result)</span> </span>&#123;</div><div class="line">                        callback.onResult(findCutest(result));</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div></pre></td></tr></table></figure>
<p>这 16 行代码只有一行是对我们有用（对于逻辑来说）的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">findCutest(result)</div></pre></td></tr></table></figure>
<p>剩下的仅仅是开启另外一个<code>AsyncJob</code>和传递结果与错误的样板代码。此外，这些代码并不用于特定的任务，我们可以把其移动到其它地方而不影响编写我们真正需要的业务代码。</p>
<p>我们该怎么写呢？我们必须做下面的两件事情：</p>
<ul>
<li><p><code>AsyncJob</code>是我们转换的结果</p>
</li>
<li><p>转换方法</p>
</li>
</ul>
<p>这又有另外一个问题，因为在 Java 中不能直接传递方法（函数）所以我们需要通过类（和接口）来间接实现这样的功能，然后我们就来定义这个 “方法”：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Func</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;</div><div class="line">    <span class="function">R <span class="title">call</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>相当简单，<code>Func</code>接口有两个类型成员，<code>T</code>对应于参数类型而<code>R</code>对应于返回类型。</p>
<p>当我们从一个<code>AsyncJob</code>中装换处结果后我们就需要做一些值之间的映射，这样的方法我们就叫它<code>map</code>。定义这个方法实例（Func 类型）最好的地方就在<code>AsyncJob</code>类中，所以<code>AsyncJob</code>代码里看起来就是这样了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">map</span><span class="params">(Func&lt;T, R&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        R mapped = func.call(result);</div><div class="line">                        callback.onResult(mapped);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>赞，这时<code>CatsHelper</code>就是下面这样了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                cutestCatAsyncJob.start(<span class="keyword">new</span> Callback&lt;Cat&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Cat cutest)</span> </span>&#123;</div><div class="line">                        apiWrapper.store(cutest)</div><div class="line">                                .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onResult(result);</div><div class="line">                                    &#125;</div><div class="line"></div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onError(e);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在好多了，创建<code>AsyncJob&lt;Cat&gt; cutestCatAsyncJob</code>只需要 6 行代码而回调也只有一个层级了。</p>
<h3 id="高级映射"><a href="#高级映射" class="headerlink" title="高级映射"></a>高级映射</h3><p>前面的那些已经很赞了，但是创建<code>AsyncJob&lt;Uri&gt; storedUriAsyncJob</code>的部分还有些不忍直视。能在这里创建映射吗？我们来试试吧：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.map(<span class="keyword">new</span> Func&lt;Cat, Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Uri <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">        <span class="comment">//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ will not compile</span></div><div class="line">        <span class="comment">//      Incompatible types:</span></div><div class="line">        <span class="comment">//      Required: Uri</span></div><div class="line">        <span class="comment">//      Found: AsyncJob&lt;Uri&gt;                </span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>呃呃。。。并不容易哦，我们来修改下结果的类型变量，试下其它方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        AsyncJob&lt;AsyncJob&lt;Uri&gt;&gt; storedUriAsyncJob = cutestCatAsyncJob.map(<span class="keyword">new</span> Func&lt;Cat, AsyncJob&lt;Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">        <span class="comment">//^^^^^^^^^^^^^^^^^^^^^^^ will not compile</span></div><div class="line">        <span class="comment">//      Incompatible types:</span></div><div class="line">        <span class="comment">//      Required: AsyncJob&lt;Uri&gt;</span></div><div class="line">        <span class="comment">//      Found: AsyncJob&lt;AsyncJob&lt;Uri&gt;&gt;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在目前这点上我们只能有<code>AsyncJob&lt;AsyncJob&lt;Uri&gt;&gt;</code>。我们需要往更深处挖吗？我们希望的是，去把<code>AsyncJob</code>在一个级别上的两个异步操作扁平化成一个单一的异步操作。</p>
<p>现在我们需要的是得到能使方法返回映射成<code>R</code>类型也是<code>AsyncJob&lt;R&gt;</code>类型的操作。这个操作应该像<code>map</code>，但在最后应该<code>flatten</code>我们嵌套的<code>AsyncJob</code>。我们叫它为<code>flatMap</code>吧，然后就是来实现它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">map</span><span class="params">(Func&lt;T, R&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        R mapped = func.call(result);</div><div class="line">                        callback.onResult(mapped);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">flatMap</span><span class="params">(Func&lt;T, AsyncJob&lt;R&gt;&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        AsyncJob&lt;R&gt; mapped = func.call(result);</div><div class="line">                        mapped.start(<span class="keyword">new</span> Callback&lt;R&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(R result)</span> </span>&#123;</div><div class="line">                                callback.onResult(result);</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                callback.onError(e);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>FlatMap 的粗略实现，但这些东西的实现都在一个地方了，在客户端的业务代码中不会再见到它。接下来我们修复下<code>CatsHelper</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.flatMap(<span class="keyword">new</span> Func&lt;Cat, AsyncJob&lt;Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哈哈！它能用了，读和写也简单了不少。</p>
<h3 id="最后的要点"><a href="#最后的要点" class="headerlink" title="最后的要点"></a>最后的要点</h3><p>再来看看我们编写的代码，眼熟吗？如果我们使用 Java 8 的 lambdas（逻辑是一样的但是看起来更爽一些） 代码会更加地简洁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(cats -&gt; findCutest(cats));</div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.flatMap(cat -&gt; apiWrapper.store(cat));</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它看起来会更好吗？我认为这样的代码跟我们第一次阻塞的版本差不多：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">saveTheCutestCat</span><span class="params">(String query)</span></span>&#123;</div><div class="line">        List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">        Cat cutest = findCutest(cats);</div><div class="line">        Uri savedUri = api.store(cutest);</div><div class="line">        <span class="keyword">return</span> savedUri;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>是的，就是这样，逻辑是相似的！也有可能会复杂些（语义是一样的）。<br>我们这样的代码有组合性吗？请大声的说有！我们组合了所有的异步操作然后作为返回结果我们仅需一个组合后的结果对象而已。<br>错误传递呢？当然也有！所有的错误都会传递到最后的回调中。<br>接下来的最后呢。。。</p>
<h2 id="RxJava"><a href="#RxJava" class="headerlink" title="RxJava"></a><a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="external">RxJava</a></h2><p>嘿，你不需要把那些代码拷到你的项目中，因为我们还是实现地不够完全的，仅仅算是非线程安全的 RxJava 的一小部分而已。</p>
<p>它们之间只有一些差异：</p>
<ul>
<li><p><code>AsyncJob&lt;T&gt;</code> 就是实际上的 <a href="http://reactivex.io/documentation/observable.html" target="_blank" rel="external">Observable<t></t></a>，它不仅可以只分发一个单一的结果也可以是一个序列（可以为空）。</p>
</li>
<li><p><code>Callback&lt;T&gt;</code> 就是 <a href="http://reactivex.io/documentation/operators/subscribe.html" target="_blank" rel="external">Observer<t></t></a>，除了 Callback 少了<code>onNext(T t)</code>方法。Observer<t> 中在<code>onError(Throwable t)</code>方法被调用后，会继而调用<code>onCompleted()</code>，然后 Observer 会包装好并发送出事件流（因为它能发送一个序列）。</t></p>
</li>
<li><p><code>abstract void start(Callback&lt;T&gt; callback)</code>对应 <a href="http://reactivex.io/RxJava/javadoc/rx/Observable.html#subscribe(rx.Observer" target="_blank" rel="external">Subscription subscribe(final Observer&lt;? super T&gt; observer)</a>)，这个方法也返回 <a href="http://reactivex.io/RxJava/javadoc/rx/Subscription.html" target="_blank" rel="external">Subscription</a> ，在不需要它时你可以决定取消接收事件流。</p>
</li>
<li><p>除了<code>map</code>和<code>flatMap</code>方法，<code>Observable</code>在 Observalbes 之上也有一些<a href="http://reactivex.io/documentation/operators.html" target="_blank" rel="external">其它</a>有用的操作。</p>
</li>
</ul>
<p>下面的代码是使用 RxJava 来完成我们前面自己写的代码的功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Observable&lt;List&lt;Cat&gt;&gt; queryCats(<span class="keyword">final</span> String query) &#123;</div><div class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> List&lt;Cat&gt;&gt; subscriber)</span> </span>&#123;</div><div class="line">                api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                        subscriber.onNext(cats);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        subscriber.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Uri&gt; <span class="title">store</span><span class="params">(<span class="keyword">final</span> Cat cat)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> Uri&gt; subscriber)</span> </span>&#123;</div><div class="line">                api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        subscriber.onNext(uri);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        subscriber.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        Observable&lt;List&lt;Cat&gt;&gt; catsListObservable = apiWrapper.queryCats(query);</div><div class="line">        Observable&lt;Cat&gt; cutestCatObservable = catsListObservable.map(<span class="keyword">new</span> Func1&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> CatsHelper.<span class="keyword">this</span>.findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        Observable&lt;Uri&gt; storedUriObservable = cutestCatObservable.flatMap(<span class="keyword">new</span> Func1&lt;Cat, Observable&lt;? extends Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> Observable&lt;? extends Uri&gt; call(Cat cat) &#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriObservable;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以看到代码是相同的，除了使用<code>Observable</code>来替代<code>AsyncJob</code>。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>我们看到，通过简单的转化我们可以把异步操作给抽象出来。这个抽象出来的东西可以被用来操作和组合异步操作就像简单的方法那样。通过这种方法我们可以摆脱嵌套的回调，在处理异步结果时也能手动处理错误的传递。</p>
<p>如果你看到了这里的话建议你放松下，思考下 sync/async 之间的二元关系，然后看看这个很棒的来自<a href="http://en.wikipedia.org/wiki/Erik_Meijer_(computer_scientist" target="_blank" rel="external">Erik Meijer</a>)的<a href="https://channel9.msdn.com/Events/Lang-NEXT/Lang-NEXT-2014/Keynote-Duality" target="_blank" rel="external">视频</a>。</p>
<h2 id="一些有用的链接"><a href="#一些有用的链接" class="headerlink" title="一些有用的链接"></a>一些有用的链接</h2><ul>
<li><a href="http://reactivex.io" target="_blank" rel="external">http://reactivex.io</a></li>
<li><a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="external">https://github.com/ReactiveX/RxJava</a></li>
<li><a href="https://github.com/ReactiveX/RxJava/wiki" target="_blank" rel="external">https://github.com/ReactiveX/RxJava/wiki</a></li>
<li><a href="http://queue.acm.org/detail.cfm?id=2169076" target="_blank" rel="external">http://queue.acm.org/detail.cfm?id=2169076</a></li>
<li><a href="https://www.coursera.org/course/reactive" target="_blank" rel="external">https://www.coursera.org/course/reactive</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1</a></li>
</ul>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>感谢我的朋友 Alexander Yakushev 帮忙翻译。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/NotRxJava懒人专用指南/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/NotRxJava懒人专用指南/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Retrofit指南/" title="Retrofit指南" itemprop="url">Retrofit指南</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://themakeinfo.com/2015/04/retrofit-android-tutorial/" target="_blank" rel="external">Retrofit Android Tutorial</a></li>
</ul>
<p>这是一篇关于如何使用Retrofit写一个Android的REST客户端的小教程。</p>
<p><img src="http://img.my.csdn.net/uploads/201504/13/1428932650_8819.jpg" alt="Retrofit+Android"></p>
<h2 id="我为什么选择Retrofit？"><a href="#我为什么选择Retrofit？" class="headerlink" title="我为什么选择Retrofit？"></a>我为什么选择Retrofit？</h2><p>在使用square的<a href="http://square.github.io/retrofit/" target="_blank" rel="external">Retrofit</a>之前，我尝试过Volley和AsyncTask。但在使用过Retrofit之后，我的工作变得更加简单了。在开始阅读教程之前，建议先阅读一下下面的几个话题。这是一个入门项目，可以让你了解如何使用Retrofit从API获取数据。</p>
<p>这个项目也加到了<a href="https://github.com/basil2style/Retrofit-Android-Basic" target="_blank" rel="external">我的Github</a>中。</p>
<p><a href="https://instructure.github.io/blog/2013/12/09/volley-vs-retrofit/" target="_blank" rel="external">AsyncHttp ,Volley和Retrofit的对比</a></p>
<p><img src="http://img.my.csdn.net/uploads/201504/13/1428929622_5444.png" alt="volley-vs-retrofit"></p>
<p>与Retrofit相比，Volley是一个小型的、缺乏正式文档说明库。Retrofit是<a href="https://github.com/square" target="_blank" rel="external">Square</a>开发的，后者还开发过okhttp，picasso…等一些著名的库(你可以在<a href="https://square.github.io/#android" target="_blank" rel="external">这里</a>找到其他的库)。如果你需要Volley的指引，你可以在<a href="https://developer.android.com/training/volley/index.html" target="_blank" rel="external">Google Training</a>或者<a href="https://github.com/DWorkS/VolleyPlus" target="_blank" rel="external">Volley Plus from DWork</a>找到相关文档。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a href="http://square.github.io/retrofit/" target="_blank" rel="external">Retrofit</a>是<a href="http://square.github.io/" target="_blank" rel="external">Square</a>开发的一个Android和Java的REST客户端库。这个库非常简单并且具有很多特性，相比其他的网络库，更容易让初学者快速掌握。它可以处理GET、POST、PUT、DELETE…等请求，还可以使用picasso加载图片。在使用Picasso或Volley之前，可以先来读读<a href="https://www.bignerdranch.com/blog/solving-the-android-image-loading-problem-volley-vs-picasso/" target="_blank" rel="external">这个</a>。</p>
<p>别纠结简介了，开始编码吧!!!</p>
<p>Demo里使用是Github的API : <a href="https://api.github.com/users/basil2style" target="_blank" rel="external">https://api.github.com/users/basil2style</a></p>
<p>你可以使用这个Demo App来搜索github的用户详细信息</p>
<p><a href="https://github.com/basil2style/Retrofit-Android-Basic" target="_blank" rel="external">GITHUB</a></p>
<p><img src="http://img.my.csdn.net/uploads/201504/13/1428929608_5673.png" alt="Download-Code"></p>
<p><a href="https://github.com/basil2style/Retrofit-Android-Basic/blob/master/APK/Retrofit%20Example.apk" target="_blank" rel="external">Download APK </a></p>
<p><a href="https://github.com/basil2style/Retrofit-Android-Basic/blob/master/APK/Retrofit%20Example.apk" target="_blank" rel="external"><img class="" src="http://img.my.csdn.net/uploads/201504/13/1428929607_5991.png" alt="qr code" width="196" height="196"></a></p>
<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1) 概述"></a>1) 概述</h2><p><img src="http://img.my.csdn.net/uploads/201504/13/1428929609_1240.png" alt="Retrofit-3-classes"></p>
<p>1) <strong>POJO或模型实体类</strong> : 从服务器获取的JSON数据将被填充到这种类的实例中。</p>
<p>2) <strong>接口</strong> : 我们需要创建一个接口来管理像GET,POST…等请求的URL，这是一个服务类。</p>
<p>3) <strong>RestAdapter类</strong> : 这是一个REST客户端(RestClient)类，retrofit中默认用的是Gson来解析JSON数据，你也可以设置自己的JSON解析器，比如jackson，我们将在下面的教程中详细解说明。</p>
<h2 id="2-添加Retrofit库到项目中"><a href="#2-添加Retrofit库到项目中" class="headerlink" title="2) 添加Retrofit库到项目中"></a>2) 添加Retrofit库到项目中</h2><p><em><strong>Gradle</strong></em> :</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'com.squareup.retrofit:retrofit:1.9.0'</span></div></pre></td></tr></table></figure>
<p>目前，1.9.0是最新的版本. 你可以在<a href="https://github.com/square/retrofit" target="_blank" rel="external">这里</a>获取更新的版本。</p>
<p><em><strong>JAR</strong></em> :</p>
<p> <a href="https://search.maven.org/remote_content?g=com.squareup.retrofit&amp;a=retrofit&amp;v=LATEST" target="_blank" rel="external">下载Jar包</a></p>
<h2 id="3-创建项目"><a href="#3-创建项目" class="headerlink" title="3) 创建项目"></a>3) 创建项目</h2><p>1) 在Android Studio中创建新项目: <strong>File  =&gt;  New Project</strong> ，填写描述信息并点击<strong>Next</strong>.</p>
<p>2) 填写<strong>minimum SDK</strong>，我用的是<strong>4.0+</strong>(Retrofit支持Android <strong>2.3+</strong>或Java <strong>6</strong>以上)</p>
<p>3) 选择<strong>Blank Activity</strong>然后填写<strong>Activity Name</strong>和<strong>Layout Name</strong>，最后点击 <strong>Finish</strong>.</p>
<p>4) <strong>Gradle</strong> : 你可以在<strong>app =&gt;build.gradle</strong>中添加Retrofit的库文件。</p>
<p><img src="http://img.my.csdn.net/uploads/201504/13/1428929609_9928.png" alt="gradle-dependencies"></p>
<p>Jar包的添加方式 :  将jar包添加到libs文件夹下，右键点击Add as Library.</p>
<p>5) 创建两个包：<strong>API</strong>和<strong>model</strong>。</p>
<p>6) 在<strong>API</strong>包下右键点击<strong>New</strong> =&gt; <strong>Java Class</strong> , 填写<strong>Name</strong>为<font style="color: #ff0000;">gitapi</font>并设置为<font style="color: #ff0000;">Interface</font>。</p>
<p>6) 在<strong>API</strong>包下创建名<font style="color: #ff0000;">gitapi</font>的<font style="color: #ff0000;">接口</font>。</p>
<p>7) 在<strong>model</strong>包下右键点击<strong>New</strong> =&gt; <strong>Java Class</strong>, 填写<strong>Name</strong>为<font style="color: #ff0000;">gitmodel</font>并设置为<font style="color: #ff0000;">Class</font>。</p>
<p><img src="http://img.my.csdn.net/uploads/201504/13/1428929622_5732.png" alt="proj-structure"></p>
<h2 id="4-Android-Manifest"><a href="#4-Android-Manifest" class="headerlink" title="4) Android Manifest"></a>4) Android Manifest</h2><p>1) 添加<font style="color: #ff0000;">INTERNET PERMISSION</font>权限</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>你的<code>Manifest</code>文件看起来应该是这样的 :</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>  </span></div><div class="line">          <span class="attr">package</span>=<span class="string">"com.makeinfo.flowerpi"</span> &gt;</div><div class="line">   <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span></div><div class="line">   	   <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">       <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></div><div class="line">       <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span> &gt;</div><div class="line">       <span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">           <span class="attr">android:name</span>=<span class="string">".MainActivity"</span></div><div class="line">           <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> &gt;</div><div class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="5-模型类"><a href="#5-模型类" class="headerlink" title="5) 模型类"></a>5) 模型类</h2><p>首先，我们需要创建一个POJO或模型类。服务器返回的JSON数据不能在Java里直接使用，所以我们需要用模型类来做转换。</p>
<p>URL的结构是这样的：<a href="https://api.github.com/users/" target="_blank" rel="external">https://api.github.com/users/</a> + “search term”</p>
<p>举个栗子：<a href="https://api.github.com/users/basil2style" target="_blank" rel="external">https://api.github.com/users/basil2style</a></p>
<p>我们的JSON返回数据是这样的：</p>
<p><img src="http://img.my.csdn.net/uploads/201504/13/1428929583_4905.jpg" alt="json object response"></p>
<p>这是一个<strong>JSON Object</strong>，如果你不了解<strong>JSON Array</strong>和<strong>JSON Object</strong>的区别，请看<a href="http://stackoverflow.com/questions/12289844/difference-between-jsonobject-and-jsonarray" target="_blank" rel="external">这里</a>。</p>
<p>使用<a href="http://www.jsonschema2pojo.org/" target="_blank" rel="external">jsonschema2pojo</a>来创建POJO更加简单，不要每一个JSON数据的POJO转换都用它，有时候会报错。选择源代码类型为<strong>Json</strong>，注解类型是<strong>Gson</strong>,然后点击<strong>preview</strong>。</p>
<p>点击<a href="http://pastebin.com/4xckerN1" target="_blank" rel="external">这里</a>(需翻墙)查看<code>gitmodel.java</code>源代码。</p>
<h2 id="6-gitapi-java"><a href="#6-gitapi-java" class="headerlink" title="6) gitapi.java"></a>6) gitapi.java</h2><p>1) 现在我们需要使用接口调用URL.</p>
<p><strong><code>@GET(&quot;/users/{user}&quot;)</code></strong>, 添加这个注解会调用服务器，参数url基于BASE URL，服务调用的参数以’/‘开头，其中<font style="color: #ff0000;">{user}</font>是从EditText获取的字符串。</p>
<p><strong><code>@Path(&quot;user&quot;) String user</code></strong> 就是我们从EditText获取的字符串。</p>
<p>服务器端响应的数据则会被存储到POJO实例中去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">gitapi</span> </span>&#123;</div><div class="line">   </div><div class="line">    <span class="meta">@GET</span>(<span class="string">"/users/&#123;user&#125;"</span>)      <span class="comment">// here is the other url part.best way is to start using /</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getFeed</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user, Callback&lt;gitmodel&gt; response)</span>;</div><div class="line">     <span class="comment">// string user is for passing values from edittext for eg: user=basil2style,google</span></div><div class="line">   	 <span class="comment">// response is the response from the server which is now in the POJO</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-RestAdapter"><a href="#7-RestAdapter" class="headerlink" title="7) RestAdapter"></a>7) RestAdapter</h2><p>现在该主要部分了，你需要设置<code>Rest Adapter</code>和<code>service</code>类.</p>
<p>1) <font style="color: #ff0000;">API</font>就是<code>Base URL</code>.</p>
<p>2) 我们需要设置<strong><code>Endpoint(API)</code></strong>并调用<strong><code>buid()</code></strong>方法来创建一个<strong><code>RestAdapter</code></strong>对象。</p>
<p>3) 使用我们的<strong><code>gitapi</code></strong>来创建一个服务适配器(service for adapter)。</p>
<p>4) 调用函数并获得响应数据，回调接口是用来异步的获取模型实例的，我们的回调接口需要实现成功回调方法(success request)和错误处理方法(error handling)。</p>
<p>5) 我们解析好的json数据的现在就存在于POJO实例中了，你可以每次调用一条。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">String API = <span class="string">"https://api.github.com"</span>;</div><div class="line"></div><div class="line">RestAdapter restAdapter = <span class="keyword">new</span> RestAdapter.Builder().setLogLevel(RestAdapter.LogLevel.FULL).setEndpoint(API).build(); </div><div class="line"></div><div class="line">gitapi git = restAdapter.create(gitapi.class);</div><div class="line"></div><div class="line">git.getFeed(user, <span class="keyword">new</span> Callback&lt;gitmodel&gt;() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">success</span><span class="params">(gitmodel gitmodel, Response response)</span> </span>&#123;</div><div class="line">		tv.setText(<span class="string">"Github Name :"</span> + gitmodel.getName() + </div><div class="line">		           <span class="string">"\nWebsite :"</span> + gitmodel.getBlog() + </div><div class="line">		           <span class="string">"\nCompany Name :"</span> + gitmodel.getCompany());</div><div class="line"></div><div class="line">		pbar.setVisibility(View.INVISIBLE); <span class="comment">// disable progressbar</span></div><div class="line"> 	&#125;</div><div class="line"></div><div class="line"> 	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failure</span><span class="params">(RetrofitError error)</span> </span>&#123;</div><div class="line"> 		tv.setText(error.getMessage());</div><div class="line"> 		pbar.setVisibility(View.INVISIBLE); <span class="comment">//disable progressbar</span></div><div class="line"> 	&#125;</div><div class="line"> &#125;);</div></pre></td></tr></table></figure>
<p>完整的<code>MainActivty.java</code>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.makeinfo.flowerpi;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> android.support.v7.app.ActionBarActivity;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.view.Menu;</div><div class="line"><span class="keyword">import</span> android.view.MenuItem;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.Button;</div><div class="line"><span class="keyword">import</span> android.widget.EditText;</div><div class="line"><span class="keyword">import</span> android.widget.ProgressBar;</div><div class="line"><span class="keyword">import</span> android.widget.TextView;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> com.makeinfo.flowerpi.API.gitapi;</div><div class="line"><span class="keyword">import</span> com.makeinfo.flowerpi.model.gitmodel;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> retrofit.Callback;</div><div class="line"><span class="keyword">import</span> retrofit.RestAdapter;</div><div class="line"><span class="keyword">import</span> retrofit.RetrofitError;</div><div class="line"><span class="keyword">import</span> retrofit.client.Response;</div><div class="line"> </div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">ActionBarActivity</span> </span>&#123;</div><div class="line"> </div><div class="line">    Button click;</div><div class="line">    TextView tv;</div><div class="line">    EditText edit_user;</div><div class="line">    ProgressBar pbar;</div><div class="line">    String API = <span class="string">"https://api.github.com"</span>;	<span class="comment">// BASE URL</span></div><div class="line">   </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"> </div><div class="line">        click = (Button) findViewById(R.id.button);</div><div class="line">        tv = (TextView) findViewById(R.id.tv);</div><div class="line">        edit_user = (EditText) findViewById(R.id.edit);</div><div class="line">        pbar = (ProgressBar) findViewById(R.id.pb);</div><div class="line">        pbar.setVisibility(View.INVISIBLE);</div><div class="line">       </div><div class="line">        click.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                String user = edit_user.getText().toString();</div><div class="line">                pbar.setVisibility(View.VISIBLE);</div><div class="line">               </div><div class="line">                <span class="comment">// Retrofit section start from here...</span></div><div class="line">                <span class="comment">// create an adapter for retrofit with base url</span></div><div class="line">                RestAdapter restAdapter = <span class="keyword">new</span> RestAdapter.Builder().setEndpoint(API).build(); </div><div class="line">                       </div><div class="line">                <span class="comment">// creating a service for adapter with our GET class       </span></div><div class="line">                gitapi git = restAdapter.create(gitapi.class);	</div><div class="line"> </div><div class="line">                <span class="comment">// Now ,we need to call for response</span></div><div class="line">                <span class="comment">// Retrofit using gson for JSON-POJO conversion</span></div><div class="line">               </div><div class="line">                git.getFeed(user,<span class="keyword">new</span> Callback&lt;gitmodel&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">success</span><span class="params">(gitmodel gitmodel, Response response)</span> </span>&#123;</div><div class="line">                        <span class="comment">// we get json object from github server to our POJO or model class</span></div><div class="line">                       </div><div class="line">                        tv.setText(<span class="string">"Github Name :"</span> + gitmodel.getName() + </div><div class="line">                                    <span class="string">"\nWebsite :"</span>+gitmodel.getBlog() + </div><div class="line">                                    <span class="string">"\nCompany Name :"</span>+gitmodel.getCompany());</div><div class="line">                       </div><div class="line">                        pbar.setVisibility(View.INVISIBLE);	<span class="comment">// disable progressbar</span></div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failure</span><span class="params">(RetrofitError error)</span> </span>&#123;</div><div class="line">                     	tv.setText(error.getMessage());</div><div class="line">                        pbar.setVisibility(View.INVISIBLE);	<span class="comment">// disable progressbar</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">        <span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></div><div class="line">        getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</div><div class="line">        <span class="comment">// Handle action bar item clicks here. The action bar will</span></div><div class="line">        <span class="comment">// automatically handle clicks on the Home/Up button, so long</span></div><div class="line">        <span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></div><div class="line">        <span class="keyword">int</span> id = item.getItemId();</div><div class="line"> </div><div class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Retrofit指南/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Retrofit指南/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/RxJava-Observables单元测试/" title="RxJava Observables单元测试" itemprop="url">RxJava Observables单元测试</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/ribot-labs/unit-testing-rxjava-6e9540d4a329" target="_blank" rel="external">Unit Testing RxJava Observables</a></li>
</ul>
<p>##RxJava Observables单元测试</p>
<p>RxJava是一个非常棒的类库，但是它不容易上手，在这里，我们列出了不同的方法来对Observables进行单元测试。</p>
<p>在<a href="http://ribot.co.uk/" target="_blank" rel="external">ribot</a>时，我们几个月前开始使用RxJava，而现在它已经成为我们开发的安卓应用的核心架构元素。使用RxJava有很多益处，但是学习(使用)的过程是曲折的，很多时候，我们发现我们试图让自己的头脑中环绕着那些解释操作过程如何工作的“美丽”蓝图。</p>
<p>改变我们架构的第一步就是改变那些定义在数据层的方法，让他们返回Observables。下一个问题是：我们如何对此进行单元测试？</p>
<p>###丑陋的方式</p>
<p>我们头脑中首先想到的是以同样的方式简单地描述我们的外部测试结果，然后将结果保存在一个全局变量，可以在以后进行断言。例如，假设我们有一个方法在一个database helper类中，负责加载用户对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public Observable&lt;User&gt; loadUser() &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后，针对这个方法的测试就会如同下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">User mUser;</div><div class="line">@Test</div><div class="line">public void shouldLoadUser() throw Exception &#123;</div><div class="line">   databaseHelper.loadUser()</div><div class="line">       .subscribe(new Action1&lt;User&gt;() &#123;</div><div class="line">           @Override</div><div class="line">           public void call(User user) &#123;</div><div class="line">               mUser = user;</div><div class="line">           &#125;</div><div class="line">        &#125;);</div><div class="line">   assertNotNull(mUser);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>默认情况下，这段代码将会执行，因为Observable会在同一个线程上执行。<br>因此，在结果设置为全局变量后断言会一直执行。</p>
<p>###更好的方式<br>我们很快意识到先前的解决方式是不完美的。尽管先前的方法能够工作，(但是)它需要大量的模版代码。所以，我们决定创建一个类，该类提供一个名称为subscribeAssertingThat()的静态方法。这个类允许我们subscribe 一个observable，保存测试结果并且以一种清晰的方式执行一些断言。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void shouldLoadTwoUsers() throw Exception &#123;</div><div class="line"> 	 subscribeAssertingThat(databaseHelper.loadUser())</div><div class="line">      .completesSuccessfully()</div><div class="line">      .hasSize(2)</div><div class="line">      .emits(user1, user2)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过100行左右的代码，我们称为RxAssertions的这个类使我们的测试可读性和可写性更好。你可以在<a href="https://gist.github.com/ivacf/874dcb476bfc97f4d555" target="_blank" rel="external">这里</a>找到RxAssertions类的代码。</p>
<p>###标准方式<br>后来，我们发现RxJava 提供了一个称为<a href="http://reactivex.io/RxJava/javadoc/rx/observers/TestSubscriber.html#TestSubscriber%28rx.Subscriber%29" target="_blank" rel="external">TestSubscriber</a>的subscriber专用类型。</p>
<p>TestSubscriber由各种各样的<a href="http://reactivex.io/RxJava/javadoc/rx/Subscriber.html" target="_blank" rel="external">Subscriber</a>(组成)，你可以用于单元测试，执行断言，检查接收到的事件，或封装mocked类型的Subscriber。</p>
<p>与第二个解决方案类似，测试subscriber允许你通过结果执行断言。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void shouldLoadTwoUsers() throw Exception &#123;</div><div class="line"> 	 	TestSubscriber&lt;User&gt; testSubscriber = new TestSubscriber&lt;&gt;();</div><div class="line">  		databaseHelper.loadUser().subscribe(testSubscriber);</div><div class="line"> 	 	testSubscriber.assertNoErrors();</div><div class="line">  		testSubscriber.assertReceivedOnNext(Arrays.asList(user1, user2))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们还没有频繁的使用TestSubscriber，但你可以看到上面的代码是相当优雅和可读。除了不同的断言，通过 Observable调用getOnNextEvents()方法，它也允许你恢复整个发现的问题列表。</p>
<p>当使用TestSubscriber时，你会发现链接的断言是不可能的，因为断言方法不返回TestSubscriber。这个能力将是一个很好的改善(方向)。</p>
<p>###总结<br>TestSusbcriber可能是目前最好的选择，因为它是RxJava codebase的一部分，它会不断的改进以及将新功能合并。能够了解别的开发者如何进行Observables的单元测试时很棒的。除了那些我在这里提到的其他方法，你还有什么方法(用于测试)？</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/RxJava-Observables单元测试/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/RxJava-Observables单元测试/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Service测试/" title="Service测试" itemprop="url">Service测试</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://developer.android.com/tools/testing/service_testing.html" target="_blank" rel="external">Service Testing</a></li>
</ul>
<p>Android为Service对象提供了一套测试框架，框架可以独立的运行，并且提供了模拟对象。这个测试用例类的名字叫做<a href="http://developer.android.com/tools/testing/service_testing.html" target="_blank" rel="external">ServiceTestCase</a>。因为这个Service类是独立于客户端的，所以，你不用使用<code>instrumentation</code>就可以测试Service对象。</p>
<p>这篇文档描述了测试Service对象的技术。如果你对Service不熟悉，请阅读<a href="http://developer.android.com/guide/components/services.html" target="_blank" rel="external">Service</a>文档。如果你不熟悉Android测试，请阅读介绍Android测试和instrumentation框架的<a href="http://developer.android.com/tools/testing/testing_android.html" target="_blank" rel="external">测试文档</a>。</p>
<h2 id="Service设计和测试"><a href="#Service设计和测试" class="headerlink" title="Service设计和测试"></a><strong><em>Service设计和测试</em></strong></h2><p>当你设计一个Service的时候，你应该考虑你的测试用例怎么样才能测试Service的整个生命周期。如果启动了Service，比如调用了<code>onCreate()</code>或者<code>onStartCommand()</code>，但并没有设置一个检测是否成功的全局变量，你可能想要提供一个以测试为目的的变量。</p>
<p>大多数其他的测试可以通过<a href="http://developer.android.com/tools/testing/service_testing.html" target="_blank" rel="external">ServiceTestCase</a>的测试用例类来方便地进行测试。例如，<code>getService()</code>方法在测试中返回一个处理Service的句柄，通过这个句柄你可以确定Service是否正在运行。</p>
<p>##<strong><em>ServiceTestCase</em></strong></p>
<p>ServiceTestCase扩展了JUnit<a href="http://developer.android.com/reference/junit/framework/TestCase.html" target="_blank" rel="external">测试用例</a>，添加测试应用权限、控制应用和Service的方法。它还提供了独立于系统的mock application和Context对象。</p>
<p>ServiceTestCase)会在你调用<code>ServiceTestCase.startService()</code>或<code>ServiceTestCase.bindService()</code>的时候初始化测试环境。这是为了允许你在启动Service之前初始化测试环境，尤其是你的mock对象。</p>
<p>注意：<code>Service.bindService()</code>的参数不同于<code>ServiceTestCase.bindService()</code>。因为<code>ServiceTestCase</code>的版本，你只能提供一个<code>Intent</code>。<code>ServiceTestCase.bindService()</code>会返回一个IBinder子对象，代替一个<code>boolean</code>值。</p>
<p>ServiceTestCase中的<code>setUp()</code>方法会在每次测试的时候调用。任何方法调用它，它都会创建一个当前系统的上下文的拷贝。你可以通过调用<code>getSystemContext()</code>查看这个上下文对象。如果，你重写该方法，你必须在重写的方法中首先调用<code>super.setUp()</code>。</p>
<p><code>setApplication()</code>和<code>setContext(Context) setContext()</code>允许你在开启Service之前为Service设置一个模拟的<code>Context</code>和<code>Application</code>（或者两者）。这些模拟的对象在<a href="#mock">模拟对象集合</a>中。</p>
<p>默认情况下，ServiceTestCase运行<code>testAndroidTestCaseSetupProperly()</code>方法，去声明在测试启动之前已经成功的创建<code>Context</code>。</p>
<p><b id="mock"></b></p>
<h2 id="模拟对象集合"><a href="#模拟对象集合" class="headerlink" title="模拟对象集合"></a><strong><em>模拟对象集合</em></strong></h2><p>ServiceTestCase假定你在测试环境中将会使用模拟的<code>Context</code>和<code>Application</code>（或者两者）。这些对象是跟系统分离的。如果你在启动Service之前不创建这些对象的实例，那么，ServiceTestCase会创建它内部的实例并将它们注入到Service中。你可以在开启Service之前通过创建和注入你自己的实例对象来实现这一功能。</p>
<p>在测试的时候，将一个模拟对象注入到Service中。<br>首先，创建一个<a href="http://developer.android.com/reference/android/test/mock/MockApplication.html" target="_blank" rel="external">MockApplication</a>的子类。<code>MockApplication</code>是Applicatoin的子类。然后，使用<code>setApplication()</code>将它注入到Service中。这个模拟对象允许你操作Service中的值，并且不受真实的系统影响。另外，当你运行测试的时候，你的Service中任何隐藏的应用依赖将会被当做异常处理。</p>
<p>在测试中，你使用<code>setContext()</code>方法注入一个模拟<code>Context</code>到Service中。在<a href="http://developer.android.com/tools/testing/testing_android.html#MockObjectClasses" target="_blank" rel="external">基础测试</a>中，模拟的<code>Context</code>可以描述更多细节。</p>
<h2 id="测试什么"><a href="#测试什么" class="headerlink" title="测试什么"></a><strong><em>测试什么</em></strong></h2><p>测试什么这一主题下列出了测试android组件一般需要考虑的问题。这些是测试Service的具体指导：</p>
<p>确保调用<code>Context.startService()</code>或<code>Context.bindService()</code>时<code>onCreate()</code>做出了响应。同理，调用<code>Context.stopService()</code>,<code>Context.unbindService()</code>,<code>stopSelf()</code>, 或者<code>stopSelfResult()</code>时<code>onDestroy()</code>做出了响应。</p>
<p>多次调用<code>Context.startService()</code>只有第一次才会触发<code>Service.onCreate()</code>方法，但是所有的调用都会触发<code>Service.onStartCommand()</code>。</p>
<p>另外，记着<code>startService()</code>不能够嵌套调用。所以，<code>Context.stopService()</code>或者<code>Service.stopSelf()</code>（不是<code>stopSelf(int)</code>）任意一个方法都可以停止Service。你应该测试你的Service是不是在正确的时间点关闭。<br>测试Service中的每个业务逻辑。业务逻辑包括无效值的检查，算法的计算等等。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Service测试/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Service测试/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/简化Android的UI开发/" title="简化Android的UI开发" itemprop="url">简化Android的UI开发</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://zserge.com/blog/android-mvx.html" target="_blank" rel="external">android ui development made easy</a></li>
</ul>
<p>如果你觉得这篇文章太长，而且还没有往下阅读的话，我可以给你简要的介绍文章要讲的内容：我使用纯 Java 通过数据绑定的方式提供了一种</p>
<p>Android UI 开发的代码往往是支离破碎的，写出来的代码通常都是大量的模板化代码，而且没有结构可言。下面是一些问题（纯属个人见解）：</p>
<ul>
<li><p>Android UI 开发很少符合 MVC 模式（或者是 M-V-其他任何东西）</p>
</li>
<li><p>XML文件通常包含了很多重复的代码，在代码复用方面比较糟糕</p>
</li>
<li><p>XMLS 非常脆弱，这使得你在写 XML 文件时，即使输入了 TextVeiw ，在编译过程中编译器也不会警告你，但在 App 运行时又会抛出 InflateException 异常</p>
</li>
<li><p>缺少对 styles 的支持，缺少对变量的支持，不支持宏和计算结果（例如 10dp + 2px)</p>
</li>
<li><p>没有数据绑定，这使得你必须自己把所有的 findViewById 和 setOn…Listener 写好</p>
</li>
<li><p>你可以通过 Java 实现你的布局，但是写出来的代码有如天书</p>
</li>
</ul>
<h2 id="使用-mithril-js-建立用户接口"><a href="#使用-mithril-js-建立用户接口" class="headerlink" title="使用 mithril.js 建立用户接口"></a>使用 mithril.js 建立用户接口</h2><p>在 Web 开发中，开发者们很快就意识到在没有 MVx 的情况下开发复杂的应用会很吃力，这使得他们意识到 jQuery 中存在的问题，并开发了 Backbone，Knockout，Angular，Ember…等等，来提高他们的开发效率</p>
<p>但在 Android 中，我们还在通过那一点点函数毫无章法可言地设置 View 的属性，就像在 jQuery 里一样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'.myview'</span>).text(<span class="string">'Hello'</span>);</div><div class="line">$(<span class="string">'.myview'</span>).on(<span class="string">'click'</span>, function() &#123;</div><div class="line"></div><div class="line">&#125;);</div><div class="line"></div><div class="line">myView.setText(<span class="string">"Hello"</span>);</div><div class="line">myView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123; ...&#125;);</div></pre></td></tr></table></figure>
<p>我们在一个目录下定义了我们的 Layout ，又在另一个目录中使用它们，然后在 UI 开发的代码里改变<br>，这样并不好。</p>
<p>React.js 对 Web 开发有一点点影响：他们以树状关系的自定义对象创建了一个虚拟的 DOM 概念，并以此展示实际的 HTML 布局。虚拟树创建和切换的时间都很短，所以当实际的 DOM 需要被渲染，两棵虚拟树（前一棵和新的那棵）将进行对比，只有不匹配的部分才会被渲染。</p>
<p>Mithril.js 是一个精悍、短小的框架，使用它能使 React.js 的实现更整洁。在 Mithril 中，除了纯 JavaScript，你几乎能摆脱一切，同时，它还能让你在写布局的时候感受到图灵完备的语言所具备的力量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> m(<span class="string">'div'</span>,</div><div class="line">         m(<span class="string">'p'</span>, someText),</div><div class="line">         m(<span class="string">'ul'</span>,</div><div class="line">           items.map((item) =&gt; m(<span class="string">'li'</span>, item))),</div><div class="line">         m(<span class="string">'button'</span>, &#123;onclick: myClickHandler&#125;));</div></pre></td></tr></table></figure>
<p>因此，你能用循环生成许多 View，你能用判断语句改变布局中的某个部分，最后你能绑定数据和设置事件监听器。</p>
<p>那这个方法能在 Android 中被使用吗？</p>
<h2 id="虚拟布局"><a href="#虚拟布局" class="headerlink" title="虚拟布局"></a>虚拟布局</h2><p>虚拟布局（使用类似 Web 中虚拟 DOM 的概念）是树状的自定义Java对象集合，被用于展示实际的 Android 布局。虽然 App 的数据改变多少次，树就会被构建多少次，但布局改变的内容应该仅仅是前后不一致的部分（当前的布局和改变前布局）。</p>
<p>我们的框架只导入一个静态类，所以所有类中的静态方法都不需要类名前缀就能被使用（例如我们只需要使用 v()，而不是 Render.v()），这是语言特性带来的好处。下面是我们如何创建布局的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">v(LinearLayout.class,</div><div class="line">    orientation(LinearLayout.VERTICAL),</div><div class="line">    v(TextView.class,</div><div class="line">        text(someText)),</div><div class="line">    v(Button.class,</div><div class="line">        text(<span class="string">"Click me"</span>),</div><div class="line">        onClick(someClickHandler)));</div></pre></td></tr></table></figure>
<p>第一个 v() 方法返回了一个虚拟布局，每一次调用后它会返回当前应用状态的实际展示（不是实际的 View！）</p>
<p>当一些文字变量被改变 - 虚拟树会获得一个被用于下次渲染的发生了改变的结点值，然后调用 setText()改变相应的 TextView 实例。但是其余的布局不会发生任何变化。</p>
<p>一棵虚拟布局树在理想情况下应该只是一个类，我们就把它叫作结点吧。但是结点主要有两种类型：View 结点（TextView.class等等）和属性设置结点，例如text（someText)</p>
<p>那这就意味着结点应该任意包含一个 View 类和一个方法去改变 View 的属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AttributeSetter</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(View v)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</div><div class="line">    List&lt;Node&gt; attrs = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</div><div class="line">    Class&lt;? extends View&gt; viewClass; <span class="comment">// for view nodes</span></div><div class="line">    AttributeSetter setter;          <span class="comment">// for attribute setter nodes</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(Class&lt;? extends View&gt; c)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.viewClass = c;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(AttributeSetter setter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setter = setter;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们需要定义类在产生虚拟布局的时候实际能干的事情了，那就让我们来调用可渲染类吧。一个可渲染类可以是一个 Activity，或者一个自定义的 ViewGroup，或者 Fragment 也凑合。每一个可渲染类都应该有一个用于返回虚拟布局的方法，此外，如果这个方法指定了它将要作用于实际布局中的哪个 View 会更好。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Renderable</span> </span>&#123;</div><div class="line">    <span class="function">Node <span class="title">view</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">ViewGroup <span class="title">getRootView</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于 v() 方法的第一个参数是 View 子类的泛型，所以你不用担心类型安全问题。剩下的参数都是结点类型，所以我们只需要把它们添加到 list 中，无视掉空结点的话效果会更好一些。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Node <span class="title">v</span><span class="params">(<span class="keyword">final</span> Class&lt;? extends View&gt; cls, <span class="keyword">final</span> Node ...nodes)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node(cls) ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here’s an example of the text() attribute setter (the real code is a bit different, but it could have been implemented like this):</p>
<p>下面是一个 text() 属性的设置方法（实际代码会有点不一样，但是也能像下面这样实现）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Node <span class="title">text</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node(<span class="keyword">new</span> AttributeSetter() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            ((TextView) v).setText(s);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其他类似的工具方法也能用于改变线性布局的方向，View 的大小、页边距、间距，总之所有 View 的参数都能被改变。</p>
<h2 id="那么，我们要怎么去渲染呢？"><a href="#那么，我们要怎么去渲染呢？" class="headerlink" title="那么，我们要怎么去渲染呢？"></a>那么，我们要怎么去渲染呢？</h2><p>现在我们需要一个“渲染者”。这是一个能够根据类名创建 View ，使用 AttributeSetters修改对应的参数并且递归地添加子 View的方法。（同样的，下面的代码也是被简化的，实际的代码会有些不一样，主要差别在于当结点没有被改变的时候，我们应该如何避免视图的渲染）<br>​<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> View <span class="title">inflateNode</span><span class="params">(Context c, Node node, ViewGroup parent)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (node.viewClass == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Root is not a view!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Exception handling skipped here to make the code look shorter</span></div><div class="line">    View v = (View) node.viewClass.getConstructor(Context.class).newInstance(c);</div><div class="line">    parent.addView(v);</div><div class="line">    <span class="keyword">for</span> (Node subnode: node.attrs) &#123;</div><div class="line">        <span class="keyword">if</span> (subnode.setter != <span class="keyword">null</span>) &#123;</div><div class="line">            subnode.setter.set(v);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            View subview = inflateNode(c, subnode, (ViewGroup) v);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在我们真的可以摆脱 XMLS，并以一种简洁的方式通过 Java 进行布局了。</p>
<p>布局结点不应该直接地被使用，而应该是通过 render(Renderer r) 和 render()被使用。前者用于重渲染某一个 View，后者用于重渲染所有被展示的 View。Renderer 通过一个弱哈希表存储，使得在 View 被移除或者 Activity 被销毁的同时 - 他们的渲染者也不会再被使用。</p>
<h2 id="什么时候去渲染呢？"><a href="#什么时候去渲染呢？" class="headerlink" title="什么时候去渲染呢？"></a>什么时候去渲染呢？</h2><p>这个框架的核心在于 自动进行重渲染，使得 UI 总能展示当前的虚拟布局状态。这就意味着 render() 应该在某个特定的节点被调用。</p>
<p>我参考 Mithril 的方法，把每一个 On…Listener 和 调用 render 的方法捆绑在每一次 UI 的交互中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Node <span class="title">onClick</span><span class="params">(<span class="keyword">final</span> View.OnClickListener listener)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node(<span class="keyword">new</span> AttributeSetter() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            v.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                    listener.onClick(v);</div><div class="line">                    <span class="comment">// After the click was processed - some data may have been changed</span></div><div class="line">                    <span class="comment">// so we try to re-render the UI</span></div><div class="line">                    render();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我觉得这样做是有道理的，因为大多数 Android 应用的数据都是在发生用户交互的时候被改变的。如果你的数据是因为其他因素被改变的 - 那就只能手动通过 render()渲染了。</p>
<h2 id="总的来说"><a href="#总的来说" class="headerlink" title="总的来说"></a>总的来说</h2><p>这个方法虽然简单，却非常有用：</p>
<ul>
<li><p>你能用类似 XML 的方式定义你的布局结构（通过嵌套调用 v() 方法）</p>
</li>
<li><p>你能用一种清晰易懂的方式绑定数据和监听器</p>
</li>
<li><p>布局都是类型安全的，并且你的编译器会自动完成相应的工作</p>
</li>
<li><p>没有运行时产生的开销，没有使用反射机制，没有自动生成代码</p>
</li>
<li><p>你能在任何地方使用 Java（变量，语句，宏）生成布局</p>
</li>
<li><p>你能用自定义 View 和自定义的属性设置方法</p>
</li>
<li><p>因为你的所有 UI 数据都被保存在属性中，因此你能轻易的保存它们</p>
</li>
<li><p>使用纯 Java 实现这些逻辑需要的代码还不到 250 行！</p>
</li>
</ul>
<p>以上证明了这个方法是可行的。现在我在想，如果有人想要用这个方法开发一个功能齐全的库呢？</p>
<p>设计一个好的“区分”算法会是其中的关键。基本地，它应该能判断一个结点是否被添加/移除/修改，而文件就在于属性节点。简单的数据类型我们只要调用 equals() 去比较两个值就可以了，但是监听器呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">v(SomeView.java,</div><div class="line">    onClick(v =&gt; ...));</div></pre></td></tr></table></figure>
<p>这样做的话每一次虚拟树被创建，都会创建一个对应的监听器对象。那怎么去比较它们？还是永远都不更新监听器，只更新发生了改变的监听器类？或者使用某种事件分发机制分发事件，而不是使用监听器？</p>
<p>另一件需要被注意的是：我不想自己把所有属性设置方法写好。这里有一个更好的方法，也就是 Kotlin 他们在 koan 库中做的那样。</p>
<p>我现在在研究怎么从 android.jar 的类中自动生成设置器，以使得这个项目更有用。</p>
<p>不管怎样，现在的代码我都放在 <a href="https://github.com/zserge/anvil" target="_blank" rel="external">Github</a> 上了，有 MIT 的许可。欢迎大家来评论和 PR！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/简化Android的UI开发/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/简化Android的UI开发/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Square：从今天开始抛弃Fragment吧！/" title="Square：从今天开始抛弃Fragment吧！" itemprop="url">Square：从今天开始抛弃Fragment吧！</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://corner.squareup.com/2014/10/advocating-against-android-fragments.html" target="_blank" rel="external">Advocating Against Android Fragments</a></li>
<li>原文作者 : <a href="http://twitter.com/Piwai" target="_blank" rel="external">Pierre-Yves Ricau</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a> </li>
<li>校对者: <a href="www.belial.me">Belial</a></li>
<li>状态 :  完成</li>
</ul>
<p>最近我在 Droidcon Paris 上进行了<a href="http://fr.droidcon.com/2014/agenda/detail?title=D%C3%A9fragmentez+vos+apps+avec+Mortar+%21" target="_blank" rel="external">一个技术相关的演讲</a>，我在这次演讲中给大家展示了 Square 使用 Fragment 进行开发时遇到的种种问题，以及其他 Android 开发者是怎么避免在项目中使用 Fragment 的。</p>
<p>在 2011 年那会，由于下面的原因我们决定使用 Fragment：</p>
<ul>
<li><p>在那会，虽然我们很想让应用能在平板设备上被使用，但我们确实没能为平板提供平台支持。而 Fragment 能帮助我们完成这项愿望，建立响应式 UI 界面。</p>
</li>
<li><p>Fragment 是视图控制器，它们能够将一大块耦合严重的业务逻辑模块解耦，并使得解耦后的业务逻辑能够被测试。</p>
</li>
<li><p>Fragment 的 API 能够进行回退栈管理（例如，它能反射某个 Activity 内 Activity 栈的具体操作）</p>
</li>
<li><p>因为 Fragment 处于视图层的顶层，而为 View 设置动画并不麻烦，使得 Fragment 为设置页面切换的过渡效果提供了更好的支持。</p>
</li>
<li><p>Google 建议我们使用 Fragment，而我们作为开发者都想让自己的代码符合标准。</p>
</li>
</ul>
<p>在 2011年之后，我们在为 Square 进行开发的过程中发现了比使用 Fragment 更好的方法。</p>
<p>#关于 Fragment 你不知道的事</p>
<p>##The lolcycle</p>
<p>在 Android 中，Context 就像一个<a href="http://en.wikipedia.org/wiki/God_object" target="_blank" rel="external">上帝对象</a>，因为在 Context 类中涵盖了太多 Android 系统的信息和相关的操作，使得 Context 在 Android 系统中相当于一个全知全能的上帝，而 Activity 就是为 Context 添加了生命周期的子类。不过让上帝具有生命周期还是有些讽刺的。虽然 Fragment 不是上帝对象，但 Fragment 为了能够完成 Activity 中能完成的各种操作，使 Fragment 自身的生命周期变得异常复杂。</p>
<p>Steve Pomeroy 做了一张<a href="https://github.com/xxv/android-lifecycle" target="_blank" rel="external"> Fragment 的完整生命周期图</a>，我相信任谁看到这张图都不会好受：</p>
<p><img src="https://corner.squareup.com/images/no-fragments/lifecycle.png" alt=""></p>
<p>这张图由 Steve Pomeroy 完成，图中移除了 Activity 的生命周期，分享这张图需要获得 <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="external">CC BY-SA 4.0</a> 许可。</p>
<p>整个 Fragment 的生命周期让你很头疼要怎样使用这些回调方法，它们是同步调用的呢，还是只是一次性全部调用呢，还是其它情况……？</p>
<p>##难于调试</p>
<p>当你的应用出现 Bug，你得用调试工具一步一步地执行代码才能知道到底发生了什么，虽说一般情况下这样做 Bug 都能解决，但如果你在调试的时候发现 Bug 和 FragmentManagerImpl 类存在某种联系，那么我可要好好恭喜你即将中大奖了！</p>
<p>因为要跟踪 FragmentManagerImpl 类内代码的执行顺序，并进行调试是很困难的，这也使得修复应用中相关的 Bug 也变得异常困难：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (f.mState) &#123;</div><div class="line">    <span class="keyword">case</span> Fragment.INITIALIZING:</div><div class="line">        <span class="keyword">if</span> (f.mSavedFragmentState != <span class="keyword">null</span>) &#123;</div><div class="line">            f.mSavedViewState = f.mSavedFragmentState.getSparseParcelableArray(</div><div class="line">                    FragmentManagerImpl.VIEW_STATE_TAG);</div><div class="line">            f.mTarget = getFragment(f.mSavedFragmentState,</div><div class="line">                    FragmentManagerImpl.TARGET_STATE_TAG);</div><div class="line">            <span class="keyword">if</span> (f.mTarget != <span class="keyword">null</span>) &#123;</div><div class="line">                f.mTargetRequestCode = f.mSavedFragmentState.getInt(</div><div class="line">                        FragmentManagerImpl.TARGET_REQUEST_CODE_STATE_TAG, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">            f.mUserVisibleHint = f.mSavedFragmentState.getBoolean(</div><div class="line">                    FragmentManagerImpl.USER_VISIBLE_HINT_TAG, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">if</span> (!f.mUserVisibleHint) &#123;</div><div class="line">                f.mDeferStart = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">if</span> (newState &gt; Fragment.STOPPED) &#123;</div><div class="line">                    newState = Fragment.STOPPED;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你曾经需要解决应用旋转后产生一个与旋转前 UI 相同（方向发生变化）的独立的 Fragment 的需求，我想你应该懂我在说什么。（别给我提嵌套使用的 Fragment！）</p>
<p>我想下面这张图很好地诠释了这类代码给程序员带来的伤害（由于版权问题我得放出这张图的出处哈：<a href="http://www.osnews.com/story/19266/WTFs_m" target="_blank" rel="external">this cartoon</a>）：</p>
<p><img src="https://corner.squareup.com/images/no-fragments/code-quality.png" alt=""></p>
<p>在多年的深度分析中我得出结论：操蛋程度/调试耗费的时间 = 2^m，m 为 Fragment 的个数。</p>
<p>##Fragment 是视图控制器？想太多</p>
<p>因为 Fragment 需要创建、绑定和配置 View，它们包含了许多与 View 关联的结点，这就意味着 View 类代码中的业务逻辑并没有真正地被解耦，正是这个原因使得我们要为 Fragment 实现测试单元将会变得很困难。</p>
<p>##Fragment transactions</p>
<p>Fragment 的 transaction 允许你执行一系列的 Fragment 操作，但不幸的是，提交 transaction 是异步操作，并且在 UI 线程的 Handler 队列的队尾被提交。这会在接收多个点击事件或配置发生改变时让你的 App 处在未知的状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BackStackRecord</span> <span class="keyword">extends</span> <span class="title">FragmentTransaction</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">commitInternal</span><span class="params">(<span class="keyword">boolean</span> allowStateLoss)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mCommitted)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"commit already called"</span>);</div><div class="line">        mCommitted = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mAddToBackStack) &#123;</div><div class="line">            mIndex = mManager.allocBackStackIndex(<span class="keyword">this</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mIndex = -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        mManager.enqueueAction(<span class="keyword">this</span>, allowStateLoss);</div><div class="line">        <span class="keyword">return</span> mIndex;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##创建 Fragment 可能带来的问题</p>
<p>Fragment 的实例能够通过 Fragment Manager 创建，例如下面的代码看起来没有什么问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DialogFragment dialogFragment = <span class="keyword">new</span> DialogFragment() &#123;</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Dialog <span class="title">onCreateDialog</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123; ... &#125;</div><div class="line">&#125;;</div><div class="line">dialogFragment.show(fragmentManager, tag);</div></pre></td></tr></table></figure>
<p>然而，当我们需要存储 Activity 实例的状态时，Fragment Manager 可能会通过反射机制重新创建该 Fragment 的实例，又因为这是一个匿名内部类，该类有一个隐藏的构造器的参数正是外部类的引用，如果大家有看过<a href="http://blog.csdn.net/u012403246/article/details/45666369" target="_blank" rel="external">这篇博文</a>的话就会知道，拥有外部引用可能会带来内存泄漏的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">android.support.v4.app.Fragment$InstantiationException:</div><div class="line">    Unable to instantiate fragment com.squareup.MyActivity$<span class="number">1</span>:</div><div class="line">    make sure <span class="class"><span class="keyword">class</span> <span class="title">name</span> <span class="title">exists</span>, <span class="title">is</span> <span class="title">public</span>, <span class="title">and</span> <span class="title">has</span> <span class="title">an</span> <span class="title">empty</span></span></div><div class="line">    <span class="title">constructor</span> <span class="title">that</span> <span class="title">is</span> <span class="title">public</span></div></pre></td></tr></table></figure>
<p>##Fragment 教给我们的思想</p>
<p>尽管 Fragment 有着上面提到的缺点，但也是 Fragment 教给我们许多代码架构的思想：</p>
<ul>
<li><p>独立的 Activity 接口：实际上我们并不需要为每一个页面创建一个 Activity，我们大可以将应用切分成许多解耦的视图组件，按照我们的实际需求把它们组装成我们想要的界面。这样做也能简化生命周期和动画设置，因为我们还能将视图组件切分为 view 组件和控制器组件。</p>
</li>
<li><p>回退栈不是 Activity 的特有概念，也就意味着你能在 Activity 内部实现回退栈。</p>
</li>
<li><p>不需要添加新的 API，我们需要的只是 Activity，View 和 LayoutInflater。</p>
</li>
</ul>
<p>#响应式 UI：Fragment VS Custom View</p>
<p>##Fragment</p>
<p>我们不妨先来看看一个 Fragment 的<a href="http://developer.android.com/shareables/training/FragmentBasics.zip" target="_blank" rel="external">范例</a>，界面中显示了一个 list。</p>
<p>HeadlinesFragment 就是显示 List 的简单 Fragment：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeadlinesFragment</span> <span class="keyword">extends</span> <span class="title">ListFragment</span> </span>&#123;</div><div class="line">  OnHeadlineSelectedListener mCallback;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnHeadlineSelectedListener</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onArticleSelected</span><span class="params">(<span class="keyword">int</span> position)</span></span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setListAdapter(</div><div class="line">        <span class="keyword">new</span> ArrayAdapter&lt;String&gt;(getActivity(),</div><div class="line">            R.layout.fragment_list,</div><div class="line">            Ipsum.Headlines));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onAttach(activity);</div><div class="line">    mCallback = (OnHeadlineSelectedListener) activity;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onListItemClick</span><span class="params">(ListView l, View v, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">    mCallback.onArticleSelected(position);</div><div class="line">    getListView().setItemChecked(position, <span class="keyword">true</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在有趣的事情来了：ListFragmentActivity 必须控制 list 是否处于同一个页面中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListFragmentActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span></span></div><div class="line">    <span class="keyword">implements</span> <span class="title">HeadlinesFragment</span>.<span class="title">OnHeadlineSelectedListener</span> &#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.news_articles);</div><div class="line">    <span class="keyword">if</span> (findViewById(R.id.fragment_container) != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (savedInstanceState != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      HeadlinesFragment firstFragment = <span class="keyword">new</span> HeadlinesFragment();</div><div class="line">      firstFragment.setArguments(getIntent().getExtras());</div><div class="line">      getFragmentManager()</div><div class="line">          .beginTransaction()</div><div class="line">          .add(R.id.fragment_container, firstFragment)</div><div class="line">          .commit();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onArticleSelected</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    ArticleFragment articleFrag =</div><div class="line">        (ArticleFragment) getFragmentManager()</div><div class="line">            .findFragmentById(R.id.article_fragment);</div><div class="line">    <span class="keyword">if</span> (articleFrag != <span class="keyword">null</span>) &#123;</div><div class="line">      articleFrag.updateArticleView(position);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      ArticleFragment newFragment = <span class="keyword">new</span> ArticleFragment();</div><div class="line">      Bundle args = <span class="keyword">new</span> Bundle();</div><div class="line">      args.putInt(ArticleFragment.ARG_POSITION, position);</div><div class="line">      newFragment.setArguments(args);</div><div class="line">      getFragmentManager()</div><div class="line">          .beginTransaction()</div><div class="line">          .replace(R.id.fragment_container, newFragment)</div><div class="line">          .addToBackStack(<span class="keyword">null</span>)</div><div class="line">          .commit();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##自定义 View</p>
<p>我们不妨重新实现一个简化版的只使用了 View 的代码</p>
<p>首先，我们会引入一个叫作“容器”的概念，“容器”的作用是帮助我们展示一项内容并处理后退操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Container</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showItem</span><span class="params">(String item)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">onBackPressed</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Acitivity 将假设始终存在容器，并且几乎不会将业务交给容器处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> Container container;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.main_activity);</div><div class="line">    container = (Container) findViewById(R.id.container);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Container <span class="title">getContainer</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> container;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> handled = container.onBackPressed();</div><div class="line">    <span class="keyword">if</span> (!handled) &#123;</div><div class="line">      finish();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>要显示的 List 也只是个平凡的 List。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemListView</span> <span class="keyword">extends</span> <span class="title">ListView</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ItemListView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onFinishInflate();</div><div class="line">    <span class="keyword">final</span> MyListAdapter adapter = <span class="keyword">new</span> MyListAdapter();</div><div class="line">    setAdapter(adapter);</div><div class="line">    setOnItemClickListener(<span class="keyword">new</span> OnItemClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; parent, View view,</span></span></div><div class="line">            <span class="keyword">int</span> position, <span class="keyword">long</span> id) &#123;</div><div class="line">        String item = adapter.getItem(position);</div><div class="line">        MainActivity activity = (MainActivity) getContext();</div><div class="line">        Container container = activity.getContainer();</div><div class="line">        container.showItem(item);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样做的好处是：能够基于资源文件夹在不同的 XML 布局文件</p>
<p><code>res/layout/main_activity.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.squareup.view.SinglePaneContainer</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/container"</span></div><div class="line">    &gt;</div><div class="line">  <span class="tag">&lt;<span class="name">com.squareup.view.ItemListView</span></span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">      /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">com.squareup.view.SinglePaneContainer</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>res/layout-land/main_activity.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.squareup.view.DualPaneContainer</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/container"</span></div><div class="line">    &gt;</div><div class="line">  <span class="tag">&lt;<span class="name">com.squareup.view.ItemListView</span></span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_weight</span>=<span class="string">"0.2"</span></div><div class="line">      /&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/detail"</span></span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_weight</span>=<span class="string">"0.8"</span></div><div class="line">      /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">com.squareup.view.DualPaneContainer</span>&gt;</span></div></pre></td></tr></table></figure>
<p>下面是这些容器类的简单实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DualPaneContainer</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> <span class="keyword">implements</span> <span class="title">Container</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> MyDetailView detailView;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DualPaneContainer</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onFinishInflate();</div><div class="line">    detailView = (MyDetailView) getChildAt(<span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showItem</span><span class="params">(String item)</span> </span>&#123;</div><div class="line">    detailView.setItem(item);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SinglePaneContainer</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">Container</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> ItemListView listView;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SinglePaneContainer</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onFinishInflate();</div><div class="line">    listView = (ItemListView) getChildAt(<span class="number">0</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!listViewAttached()) &#123;</div><div class="line">      removeViewAt(<span class="number">0</span>);</div><div class="line">      addView(listView);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showItem</span><span class="params">(String item)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (listViewAttached()) &#123;</div><div class="line">      removeViewAt(<span class="number">0</span>);</div><div class="line">      View.inflate(getContext(), R.layout.detail, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    MyDetailView detailView = (MyDetailView) getChildAt(<span class="number">0</span>);</div><div class="line">    detailView.setItem(item);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">listViewAttached</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> listView.getParent() != <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不难想象：将容器类抽象，并用这种的方式开发 App，不但不需要 Fragment，还能架构出容易理解的代码。</p>
<p>##View 和 Presenter</p>
<p>自定义 View 在应用中非常有用，但我们希望将业务逻辑从 View 中剥离，转交给特定的控制器处理，也就是接下来我们所说的 Presenter，引入 Presenter 能提高代码的可读性和可测试性。如果你不信的话，不妨看看重构后的 MyDetailView：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDetailView</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</div><div class="line">  TextView textView;</div><div class="line">  DetailPresenter presenter;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyDetailView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs);</div><div class="line">    presenter = <span class="keyword">new</span> DetailPresenter();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onFinishInflate();</div><div class="line">    presenter.setView(<span class="keyword">this</span>);</div><div class="line">    textView = (TextView) findViewById(R.id.text);</div><div class="line">    findViewById(R.id.button).setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        presenter.buttonClicked();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItem</span><span class="params">(String item)</span> </span>&#123;</div><div class="line">    textView.setText(item);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们来看看 Square 注册界面中编辑账户的页面吧！</p>
<p><img src="https://corner.squareup.com/images/no-fragments/edit-discounts.png" alt=""></p>
<p>Presenter 将在更高层级中操控 View：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EditDiscountPresenter</span> </span>&#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveDiscount</span><span class="params">()</span> </span>&#123;</div><div class="line">    EditDiscountView view = getView();</div><div class="line">    String name = view.getName();</div><div class="line">    <span class="keyword">if</span> (isBlank(name)) &#123;</div><div class="line">      view.showNameRequiredWarning();</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isNewDiscount()) &#123;</div><div class="line">      createNewDiscountAsync(name, view.getAmount(), view.isPercentage());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      updateNewDiscountAsync(discountId, name, view.getAmount(),</div><div class="line">        view.isPercentage());</div><div class="line">    &#125;</div><div class="line">    close();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大家可以看到，为这个 Presenter 实现测试单元犹如一缕春风拂面来，甚是舒心爽快呐～</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cannot_save_discount_with_empty_name</span><span class="params">()</span> </span>&#123;</div><div class="line">  startEditingLoadedPercentageDiscount();</div><div class="line">  when(view.getName()).thenReturn(<span class="string">""</span>);</div><div class="line">  presenter.saveDiscount();</div><div class="line">  verify(view).showNameRequiredWarning();</div><div class="line">  assertThat(isSavingInBackground()).isFalse();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##回退栈管理</p>
<p>通过异步处理来管理回退栈实在是牛刀杀鸡，大材小用了……我们只需要用一个超轻量级库——Flow，就可以达到目的。有关 Flow 的介绍 Ray Ryan 已经写过博客了，我就不在此赘述啦。</p>
<p>##我把 UI 相关的代码全都写在 Fragment 里了咋办呀，在线等，急！！！</p>
<p>别理你的 Fragment，你就一点一点地把 View 相关的代码移到自定义 View 里，然后把涉及到的业务逻辑交给能够与 View 进行交互的 Presenter，然后你就会发现 Fragment 沦为空壳，只有一些初始化自定义 View 和连接 View 和 Presenter 的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DetailFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater,</span></span></div><div class="line">    ViewGroup container, Bundle savedInstanceState) &#123;</div><div class="line">    <span class="keyword">return</span> inflater.inflate(R.layout.my_detail_view, container, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>事实上到了这一步你已经可以抛弃 Fragment 了。</p>
<p>抛弃 Fragment 确实得花很大的功夫，但我们已经做到了，感谢<a href="https://twitter.com/dnkoutso" target="_blank" rel="external"> Dimitris Koutsogiorgas </a>和<a href="https://twitter.com/rjrjr" target="_blank" rel="external"> Ray Ryan </a>的伟大贡献！</p>
<p>##Dagger 和 Mortar 是什么？</p>
<p>Dagger &amp; Mortar 与 Fragment 成正交关系，换句话说，两者间各自的变化不会影响对方，使用 Dagger &amp; Mortar 既可以用 Fragment，也可以不用 Fragment。</p>
<p><a href="http://square.github.io/dagger/" target="_blank" rel="external">Dagger</a> 能帮你将应用模块化为一张由解耦组件构成的图，它考虑了所有类间的连接关系并简化了抽取依赖的操作，并实现一个与此相关的单例对象。</p>
<p><a href="https://github.com/square/mortar" target="_blank" rel="external">Mortar</a> 在 Dagger 的顶层进行操作，主要优势有如下两点：</p>
<ul>
<li><p>Mortar 为被注入组件提供简单的生命周期回调，使你能实现不会因旋转被销毁的单例 Presenter，不过需要注意的是，Mortar 将当前界面元素的状态储存在 Bundle 中，使数据不会随进程的结束而被清除。</p>
</li>
<li><p>Mortar 为你管理 Dagger 的子图，并帮你将它们与 Activity 的生命周期关联在一起，这种功能让你能有效地实现“域”：当一个 View 被添加进来，它的 Presenter 和依赖都会作为子图被创建；当 View 被移除，你能轻易地销毁“域”，并让垃圾回收机制去完成它的工作。</p>
</li>
</ul>
<p>##结论</p>
<p>我们曾为 Fragment 的诞生满心欢喜，幻想着 Fragment 能为我们带来种种便利，然而这一切不过是场虚空大梦，我们最后发现骑着白马的 Fragment 既不是王子也不是唐僧，只不过是人品爆发捡了只白马的乞丐罢了：</p>
<ul>
<li><p>我们遇到的大多数难以解决的 Bug 都与 Fragment 的生命周期有关。</p>
</li>
<li><p>我们只需要 View 创建响应式 UI，实现回退栈以及屏幕事件的处理，不用 Fragment 也能满足实际开发的需求。</p>
</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Square：从今天开始抛弃Fragment吧！/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Square：从今天开始抛弃Fragment吧！/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/检测和解决Android应用的性能问题/" title="检测和解决Android应用的性能问题" itemprop="url">检测和解决Android应用的性能问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://code.tutsplus.com/tutorials/detect-and-resolve-performance-problems-on-android--cms-24058" target="_blank" rel="external">Detect and Resolve Performance Problems on Android</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a> </li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>无论你的应用多么有创新性、有用，如果它卡得要命，或者非常消耗内存，那么没人将会愿意使用它。</p>
<p>因此，性能变得尤为重要。当你忙碌于构建精美的用户界面或者完成新的特性时，你可能容易忘却掉一些性能相关的事情。</p>
<p>这也是为什么有Google Play的应用审核机制的原因之一。</p>
<p>这篇文章中，你会看到每个Android工程师需要了解的一些性能问题。你将会学会使用Android SDK提供的、已安装在你的设备中的工具来测试这些问题是否发生在你自己的应用中。</p>
<p>如果在你的应用中发现了一个性能问题，你肯定会想修复它。我们还会看一看如何使用Android SDK 工具来获取更多关于那些没有覆盖到的性能问题的相关信息。一旦你有了这些信息，你将会对如何提升应用性能有一个更深刻的理解，并且能够构建出让用户喜爱的App。</p>
<h2 id="过度绘制"><a href="#过度绘制" class="headerlink" title="过度绘制"></a>过度绘制</h2><h3 id="步骤1-问题描述"><a href="#步骤1-问题描述" class="headerlink" title="步骤1 : 问题描述"></a>步骤1 : 问题描述</h3><p>你应用的用户界面是连接用户的纽带，但是创建漂亮的界面只是挑战的其中一面，你还需要确保用户界面流畅的运行。</p>
<p>一个常见的问题就是用户界面卡顿，出现这种情况的原因可能是<strong>overdraw</strong>。Overdraw是屏幕上的某个像素在同一帧的时间内被绘制了多次。</p>
<p>例如，想象一下一个有蓝色的背景文本，Android不仅会绘制对用户可见的蓝色区域，而是会绘制整个蓝色的背景以及上面的文本。这意味着一些像素会被两次绘制，这就是过度绘制。</p>
<p>一些如上述例子所说的过度绘制示例是不可避免的。然而，过多的多度绘制会引发明显的性能问题，因此你必须将过度绘制的可能性降到最小。</p>
<p>检测应用中的过度绘制相对来说比较简单。大量的过度绘制会引出其他用户界面相关问题，例如视图层级过于复杂等。基于这些原因，当你测试你的App的性能问题时，从过度绘制开始是一个明智的选择。</p>
<h3 id="步骤2-检测过度绘制"><a href="#步骤2-检测过度绘制" class="headerlink" title="步骤2 : 检测过度绘制"></a>步骤2 : 检测过度绘制</h3><p>好消息是你的Android设备上已经内置了检测过度绘制的工具。</p>
<p>因此你需要做的第一步就是安装你要测试的App到你的设备中。然后打开设置页面，选择开发选项（Developer Options）-&gt;调试GPU 过度绘制（Debug GPU Overdraw），然后选择“显示过度绘制区域（Show overdraw area）”。如下图所示。</p>
<p><img src="http://img.blog.csdn.net/20150722114732363" alt="On your device select Settings Developer Options Debug GPU Overdraw
Show overdraw
area"></p>
<p>这个工具使用色块来代表不同数量的过度绘制。剩下的事情就是启动你要测试的应用，然后观察它的过度绘制情况。</p>
<p><img src="http://img.blog.csdn.net/20150722114815803" alt="Launch your app and check the amount of
overdraw"><br>​    </p>
<ul>
<li><strong>没颜色 :</strong> 没有过度绘制，也就是说一个像素只被绘制了一次。</li>
<li><strong>蓝色 :</strong> 过度绘制了一次，也就是一个像素点被绘制了两次。</li>
<li><strong>绿色 :</strong> 过度绘制了2次. 也就是一个像素点被绘制了三次，通常，你需要集中精力优化过度绘制次数大于等于2次的情况。</li>
<li><strong>浅红色 :</strong> 过度绘制3次。这取决于你的应用，小范围的3次过度绘制可能是不可避免的，但是如果你看到了中等或者大量的红色区域那么你就需要查找出现这个问题的原因了。</li>
<li><strong>深红色 :</strong> 过度绘制4次，像素点被绘制了5次，甚至更多次。出现这种问题你绝逼要找到原因，并且解决它。</li>
</ul>
<p><img src="http://img.blog.csdn.net/20150722125805062" alt=""></p>
<h3 id="步骤3-：-最小化过度绘制"><a href="#步骤3-：-最小化过度绘制" class="headerlink" title="步骤3 ： 最小化过度绘制"></a>步骤3 ： 最小化过度绘制</h3><p>一旦你发现了某个区域有严重的过度绘制，最简单的方法就是打开你应用的xml文件找到过度重叠的区域，特别是那些不可见的drawable对象和被绘制在其他控件上的背景，以此来降低这些地方的过度绘制。</p>
<p>你也应该查找那些背景属性设置为白色，并且它的父视图背景也设置为白色的区域。所有这些都会引起严重的过度绘制。</p>
<p>Android系统能自动的降低一些简单的过度绘制，但是这些对于复杂的自定义View并没有什么价值，因为Android不会知道你如何绘制你的内容。</p>
<p>如果你在App中使用了复杂的自定义View，你可以为使用<code>clipRect</code>函数为你的视图定义可绘制区域的边界。更新相关信息可以参考<a href="http://developer.android.com/reference/android/graphics/Canvas.html" target="_blank" rel="external">official Android<br>documentation</a>.</p>
<h2 id="2-Android-图形渲染"><a href="#2-Android-图形渲染" class="headerlink" title="2. Android 图形渲染"></a>2. Android 图形渲染</h2><hr>
<h3 id="步骤1-问题描述-1"><a href="#步骤1-问题描述-1" class="headerlink" title="步骤1 : 问题描述"></a>步骤1 : 问题描述</h3><p>另一个常见的性能问题就是应用的视图层级。为了渲染每个视图，Android都会经历这三个阶段 : </p>
<ol>
<li>测量</li>
<li>布局</li>
<li>绘制</li>
</ol>
<p>花在这三个阶段的时间与View层级中的View的数量成正比，这就意味着降低App渲染时间的最简单的方法就是识别和移除那些并没有什么卵用的UI元素。</p>
<p>即使在你的视图层级上的所有View都是必须的，不同的布局方式也可能对测量过程产生重要的影响。通常来说，你的视图层级越深，花在测量视图的时间就越长。</p>
<p>在视图渲染期间，每个View都要向它的父View提供它自己的尺寸。如果父view发现了任意一个尺寸问题，那么它会强制要求所有的子视图重新测量。</p>
<p>即使没有错误发生，重新测量也可能出现。例如，为了正确的进行布局RelativeLayout通常会对它们的子视图进行两次测量。子视图使用了<code>layout_weight</code>属性的LinearLayout也会对它的子视图进行两次测量。</p>
<p>这些都取决于你的布局方式，测量和重新测量的代价非常昂贵，它会严重影响你的渲染速度。</p>
<p>确保你的用户界面渲染流畅的关键就是移除任何非必须的View以及减少你的View层级。</p>
<p><strong>Hierarchy Viewer</strong>是一个能够将你完整的View层级可视化的工具，这个工具能够帮助你发现冗余的View以及嵌套的布局。</p>
<h3 id="步骤2：使用-Hierarchy-Viewer"><a href="#步骤2：使用-Hierarchy-Viewer" class="headerlink" title="步骤2：使用 Hierarchy Viewer"></a>步骤2：使用 Hierarchy Viewer</h3><p>在我们进一步了解<strong>Hierarchy Viewer</strong>之前，你需要知道它的一些规则。首先<strong>Hierarchy Viewer</strong>只能与正在运行的App进行交互，而不是你的源代码。这就是说你需要将App安装到你的设备或者模拟器上。</p>
<p>还有一个最重要的问题，就是默认情况下<strong>Hierarchy Viewer</strong>只能与运行开发版Android系统的设备进行交互（译者注: 一般来说，使用模拟器即可）。如果你没有开发设备，那你需要添加<a href="https://github.com/romainguy/ViewServer" target="_blank" rel="external"><code>ViewServer</code><br>class</a>到你的应用中。</p>
<p>了解这些之后就让我们打开Android Studio，并且选择”tools” -&gt; “Android” -&gt; “Android Device Monitor”，如图所示。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-open-Android-Device-Monitor.jpg" alt="Select Tools Android Android Device
Monitor"></p>
<p>然后点击<strong>Hierarchy View</strong>按钮，如下图所示。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-select-Hierarchy-viewer.jpg" alt="Select the Hierarchy View button from the
toolbar"></p>
<p>屏幕左边的<strong>Windows</strong>标签下列出了所有Android设备和模拟器。选择你的设备后，你会看到你设备上运行的所有进程。选中你要检测的进程，然后你会看到三个自动更新的视图层级区域。</p>
<p>这三个窗口提供了视图层级的三个不同可视化展示。</p>
<ul>
<li><strong>Tree View:</strong> <em>**</em> 视图层级窗口，每个节点代表了一个View;</li>
<li><strong>Tree Overview:</strong> 整个视图层级的缩略布局;</li>
<li><strong>Layout View:</strong> 当前视图层级的轮廓.</li>
</ul>
<p>Hierarchy View中有三个窗口。如果你在一个窗口中选择了一个View，那么它会在另外两个中高亮显示。你能同时使用这三个窗口查找View层级中的冗余视图。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-tree%20overview.jpg" alt="Select a view in one window and itll appear highlighted in the other
two"></p>
<p>如果你不确定一个View是否是UI界面中的必须元素，最简单的方法就是到Tree View窗口点击这个节点。你将会看到该View是如何显示在屏幕的预览，此时你就可以确切地知道该View是否是必须的。</p>
<p>但是即使一个View对最终的渲染效果有贡献也并不意味着它不会引起严重的性能问题。你已经看到了如何通过Hierarchy Viewer来找到明显的嵌套布局，但是如果这引起的性能问题并不那么明显呢？或者还有其他的原因使得该视图渲染得非常慢？</p>
<p>好消息就是你还可以通过Hierarchy Viewer来剖析每个View在不同的渲染阶段的耗时。当性能问题的原因不那么明显时，这是你发现问题的另一途径。</p>
<p>下个章节我将为你展示如何通过Hierarchy Viewer来剖析每个View的渲染时间来找到潜伏在问题表面的性能问题。</p>
<h3 id="步骤3-节点的性能分析"><a href="#步骤3-节点的性能分析" class="headerlink" title="步骤3 : 节点的性能分析"></a>步骤3 : 节点的性能分析</h3><p>定位你的用户界面瓶颈的最简单方法就是收集每个View分别完成测量、布局、绘制的时间。</p>
<p>你不仅可以通过Hierarchy Viewer收集这些信息，Hierarchy Viewer还可以通俗易懂地向你展示这些数据，因此你可以通过这种形式来找到性能问题。</p>
<p>Hierarchy Viewer默认并不会显示渲染时间。你需要到Tree View窗口添加这个信息，然后选择你想要测试的根节点。下一步，在Hierarchy Viewer上点击由绿、红、紫的三个圆形色块组成的按钮，如图所示。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-venn-diagram.jpg" alt=""></p>
<p>三个圆点色块就会显示在每个节点上，从左到右，这些圆点分别代表 :</p>
<ul>
<li>用于测量的时间</li>
<li>用于布局的时间</li>
<li>用于绘制的时间</li>
</ul>
<p>每个圆点都有颜色 : </p>
<ul>
<li><strong>绿色</strong> 代表该View的渲染速度至少要快于一半以上的其他参与测试的节点。例如，一个在布局位置上的绿色的圆点代表它的布局速度要快于50%以上的其他节点；</li>
<li><strong>黄色</strong> 代表该View慢于50%以上的其他节点;</li>
<li><strong>红色</strong> 代表该View的渲染速度比其他所有参与测试的节点都慢。</li>
</ul>
<p><img src="http://img.blog.csdn.net/20150723140449454" alt=""></p>
<p>当收集了这些数据之后，你不仅知道哪些View需要优化，你还会确切地知道是在渲染的哪个阶段导致的问题。</p>
<p>哪些黄色、红色的地方就是你需要开始优化的地方，这些性能指标与该视图层级下的其他剖析节点也有关系。换句话说，你肯定会有一些视图渲染得比其他的慢。</p>
<p>在开始改良你的View相关的代码之前，摸着你的良心问一句该View渲染得比其他视图慢是否有一个合理的原因，如果答案是否定的，那么就开始你的View优化之旅吧。</p>
<h2 id="3-Memory-Leaks-内存泄漏"><a href="#3-Memory-Leaks-内存泄漏" class="headerlink" title="3. Memory Leaks 内存泄漏"></a>3. Memory Leaks 内存泄漏</h2><h3 id="步骤1：问题描述"><a href="#步骤1：问题描述" class="headerlink" title="步骤1：问题描述"></a>步骤1：问题描述</h3><p>Android是一个自动管理内存的开发环境，不要让这个句话蒙蔽了，因为内存泄漏依旧是可能发生的。这是因为垃圾回收器只会移除那些不可达的对象。如果它不是一个不可达的对象，那么该对象就不会被释放掉。</p>
<p>这些不可达的对象阴魂不散，聚集在你的堆内存中，占用App的内存控件。如果你继续泄漏对象，那么可用的内存空间将会越来越小，GC操作就会频繁触发。</p>
<p>有两个原因表明这是一个坏消息。首先，GC操作通常不会明显地影响你的App性能，但是当内存控件较小时大量的GC操作会使你的App变慢，此时UI就不会那么流畅了。第二问题是移动设备的内存空间相对来说较小，因此内存泄漏会快速地升级为内存溢出，导致应用Crash。</p>
<p>内存泄漏难以被检测出。可能只有当用户开始抱怨你的应用时你才能发觉内存泄漏问题。幸运地是，Android SDK提供了一些有用的工具来让你找到这些问题。（译者注 : Square的开源库<a href="https://github.com/square/leakcanary" target="_blank" rel="external">LeakCanary</a>是查找内存泄漏的优秀工具,强烈建议大家使用）。</p>
<h3 id="步骤2-内存监视器-（Memory-Monitor）"><a href="#步骤2-内存监视器-（Memory-Monitor）" class="headerlink" title="步骤2 : 内存监视器 （Memory Monitor）"></a>步骤2 : 内存监视器 （Memory Monitor）</h3><p><strong>Memory Monitor</strong>是一个能够实时获取应用内存使用情况的工具。需要注意的是这个工具只能作用于正在运行的应用，因此确保你的要测试的应用已经安装到你的设备中，并且你的设备已经连接到你的电脑上。</p>
<p><strong>Memory Monitor</strong>已经内置在Android Studio中，因此你可以点击Android Studio的底部的”Memory”这个tab来切换到内存监视页面。当你切换到该页面的时候，Memory Monitor就开始记录你的内存使用情况了。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-memory-monitor.jpg" alt="Memory Monitor is built into Android Studio you can access it by
clicking the Memory
tab"></p>
<p>如果Memory Monitor没有开始记录，那么确保你的设备是已经被选中的状态。</p>
<p>如果Memory Monitor提示<strong>No debuggable applications</strong>，那么你可以打开Android Studio的”Tools”菜单，选择”Android”，然后确保选中了<strong>Enable adb integration</strong>。这个功能还不是很稳定，所以有时候你需要手动切换它的状态。你也可以断开设备与电脑的连接，然后再重连，这样可能就OK了。</p>
<p>一旦Memory Monitor检测到正在运行的应用，它就会显示这个应用的内存使用情况。已使用的内存会被表示为深蓝色，未分配的内存则会变为浅蓝色。</p>
<p>花一些时间与你的设备交互，并且关注你的内存使用情况。最终已分配的内存会增长，直到没有内存可用。此时，系统就会释放触发GC释放内存，当你看到已分配的内存明显的下降时就代表GC操作被触发了。</p>
<p>GC通常情况下会将无用的内存释放掉，但是当你看到App在短时间内快速增长或者GC变得非常频繁，此时你就需要倍加小心了，这就是发生内存泄漏的信号！</p>
<p>如果你通过Memory Monitor来追踪一个可疑的内存泄漏问题，你可能会看到Android系统会为你的App增大可用内存，TODO : 。</p>
<p>最终，你可能会看到你的App消耗了非常多的内存以至于系统无法再给你的应用更多的可用内存。如果你看到这种场景，那么说明你在内存使用上犯了很严重的错误。</p>
<h3 id="步骤3-Android-Device-Monitor"><a href="#步骤3-Android-Device-Monitor" class="headerlink" title="步骤3 : Android Device Monitor"></a>步骤3 : Android Device Monitor</h3><p>另一个能够帮助你收集更新关于内存泄漏信息和其他内存相关问题的工具是Android Device Monitor的DDMMS工具下的<strong>Heap</strong>。</p>
<p><strong>Heap</strong>工具能够通过显示系统为你分配了多少内存来帮助你诊断内存泄漏问题。正如上面提到的，如果已分配的内存不断地增长，那么这是发生内存泄漏的明显信号。</p>
<p>但是这个工具还提供了许多关于你的应用堆内存使用情况的数据，包含你的App内分配的各种对象、分配的对象数量以及这些对象占用了多少空间。这些额外的信息对于你追踪内存泄漏极为有用。</p>
<p>你可以在Android Device Monitor工具中选择DDMS，在Devices中选择你要检测的App。然后选择Heap标签，如图所示。然后花一些时间与你的App进行交互以收集内存信息。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-heap-tab.jpg" alt="Launch Android Debug Monitor select DDMS and then click the Heap
tab"></p>
<p>heap输出信息会在GC事件之后，因为你可以手动点击<strong>Cause GC</strong>来触发GC，使得Heap内存数据尽快地显示出来。</p>
<p>一旦GC事件被触发了，heap标签下就会更新App的堆内存使用信息，这些信息会在每次GC时更新。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><hr>
<p>在这篇文章中，我们学习了一些开发中最常见的性能问题，过度绘制、内存泄漏、缓慢的UI渲染。</p>
<p>相信你已经掌握了如何使用工具来检查这些问题，以及如何获取更新的信息来判断你的应用中是否出现了这些性能问题。你有越多的信息，就越容易追踪到问题的原因并且修复它。</p>
<p>Android SDK有很多工具可以供你诊断和定位性能问题。如果你想学习更多这方面的知识，你可以访问u这两篇官方文档 <a href="http://developer.android.com/tools/debugging/debugging-tracing.html" target="_blank" rel="external">Traceview and dmtracedump</a>和 <a href="http://developer.android.com/tools/debugging/ddms.html#alloc" target="_blank" rel="external">Allocation Tracker</a>.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/检测和解决Android应用的性能问题/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/检测和解决Android应用的性能问题/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/chap1/" title="RxJava开发精要1-从.NET到RxJava" itemprop="url">RxJava开发精要1-从.NET到RxJava</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文出自《RxJava Essentials》</li>
</ul>
<ul>
<li>原文作者 : <a href="https://www.packtpub.com/books/info/authors/ivan-morgillo" target="_blank" rel="external">Ivan Morgillo</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/yuxingxin" target="_blank" rel="external">yuxingxin</a> </li>
<li>项目地址 : <a href="https://github.com/yuxingxin/RxJava-Essentials-CN" target="_blank" rel="external">RxJava-Essentials-CN</a></li>
</ul>
<h2 id="RX-从-NET到RxJava"><a href="#RX-从-NET到RxJava" class="headerlink" title="RX - 从.NET到RxJava"></a>RX - 从.NET到RxJava</h2><p>响应式编程是一种基于异步数据流概念的编程模式。数据流就像一条河：它可以被观测，被过滤，被操作，或者为新的消费者与另外一条流合并为一条新的流。</p>
<p>响应式编程的一个关键概念是事件。事件可以被等待，可以触发过程，也可以触发其它事件。事件是唯一的以合适的方式将我们的现实世界映射到我们的软件中：如果屋里太热了我们就打开一扇窗户。同样的，当我们更改电子表（变化的传播）中的一些数值时，我们需要更新整个表格或者我们的机器人碰到墙时会转弯（响应事件）。</p>
<p>今天，响应式编程最通用的一个场景是UI：我们的移动App必须做出对网络调用、用户触摸输入和系统弹框的响应。在这个世界上，软件之所以是事件驱动并响应的是因为现实生活也是如此。</p>
<h2 id="微软响应式扩展"><a href="#微软响应式扩展" class="headerlink" title="微软响应式扩展"></a>微软响应式扩展</h2><p>函数响应式编程是一个来自90年代后期受微软的一名计算机科学家Erik Meijer启发的思想，用来设计和开发微软的Rx库。</p>
<p>Rx 是微软.NET的一个响应式扩展。Rx借助可观测的序列提供一种简单的方式来创建异步的，基于事件驱动的程序。开发者可以使用Observables模拟异步数据流，使用LINQ语法查询Observables，并且很容易管理调度器的并发。</p>
<p>Rx让众所周知的概念变得易于实现和消费，例如<strong>push方法</strong>。在响应式的世界里，我们不能假装作用户不关注或者是不抱怨它而一味的等待函数的返回结果，网络调用，或者数据库查询的返回结果。我们时刻都在等待某些东西，这就让我们失去了并行处理其他事情的机会，提供更好的用户体验，让我们的软件免受顺序链的影响，而阻塞编程。</p>
<p>下表列出的与.NET 枚举相关的.NET Observable</p>
<table>
<thead>
<tr>
<th>.NET Observable</th>
<th style="text-align:center">一个返回值</th>
<th style="text-align:right">多个返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pull/Synchronous/Interactive</td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:right"><code>IEnumerable&lt;T&gt;</code></td>
</tr>
<tr>
<td>Push/Asynchronous/Reactive</td>
<td style="text-align:center"><code>Task&lt;T&gt;</code></td>
<td style="text-align:right"><code>IObservable&lt;T&gt;</code></td>
</tr>
</tbody>
</table>
<p>push方法把这个问题逆转了：取而代之的是不再等待结果，开发者只是简单的请求结果，而当它返回时得到一个通知即可。开发者对即将发生的事件提供一个清晰的响应链。对于每一个事件，开发者都作出相应的响应；例如，用户被要求登录的时候，提交一个携带他的用户名和密码的表单。应用程序执行登录的网络请求，接下来将要发生的情况有：</p>
<ul>
<li>显示一个成功的信息，并保存用户的个人信息。</li>
<li>显示一个错误的信息</li>
</ul>
<p>正如你用push方法所看到的，开发者不需要等待结果。而是在结果返回时通知他。在这期间，他可以做他想做的任何事情：</p>
<ul>
<li>显示一个进度对话框</li>
<li>为下次登录保存用户名和密码</li>
<li>预加载一些他认为登录成功后需要耗时处理的事情</li>
</ul>
<h2 id="来到Java世界-Netflix-RxJava"><a href="#来到Java世界-Netflix-RxJava" class="headerlink" title="来到Java世界 - Netflix RxJava"></a>来到Java世界 - Netflix RxJava</h2><p>Netflix在2012年开始意识到他们的架构要满足他们庞大的用户群体已经变得步履维艰。因此他们决定重新设计架构来减少REST调用的次数。取代几十次的REST调用，而是让客户端自己处理需要的数据，他们决定基于客户端需求创建一个专门优化过的REST调用。</p>
<p>为了实现这一目标，他们决定尝试响应式，开始将.NET Rx迁移到JVM上面。他们不想只基于Java语言；而是整个JVM，从而有可能为市场上的每一种基于JVM的语言：如Java、Closure、Groovy、Scala等等提供一种新的工具。</p>
<p>2013年二月份,Ben Christensen 和 Jafar Husain发在Netflix技术博客的一篇文章第一次向世界展示了RxJava。</p>
<p>主要特点有：</p>
<ul>
<li>易于并发从而更好的利用服务器的能力。</li>
<li>易于有条件的异步执行。</li>
<li>一种更好的方式来避免回调地狱。</li>
<li>一种响应式方法。</li>
</ul>
<p>正如.NET,RxJava Observable 是push 迭代的等价体，即pull。pull方法是阻塞并等待的方法：消费者从源头pull值，并阻塞线程直到生产者提供新的值。</p>
<p>push方法作用于订阅和响应：消费者订阅新值的发射，当它们可用时生产者push这些新值并通知消费者。在这一点上，消费者消费了它们。push方法很明显更灵活，因为从逻辑和实践的观点来看，开发者只需忽略他需要的数据是来自同步还是异步；他的代码将仍然起作用。</p>
<h2 id="RxJava的与众不同之处"><a href="#RxJava的与众不同之处" class="headerlink" title="RxJava的与众不同之处"></a>RxJava的与众不同之处</h2><p>从纯Java的观点看，RxJava Observable类源自于经典的Gang Of Four的观察者模式。</p>
<p>它添加了三个缺少的功能：</p>
<ul>
<li>生产者在没有更多数据可用时能够发出信号通知：onCompleted()事件。</li>
<li>生产者在发生错误时能够发出信号通知：onError()事件。</li>
<li>RxJava Observables 能够组合而不是嵌套，从而避免开发者陷入回调地狱。</li>
</ul>
<p>Observables和Iterables共用一个相似的API：我们在Iterable可以执行的许多操作也都同样可以在Observables上执行。当然，由于Observables流的本质，没有如Iterable.remove()这样相应的方法。</p>
<table>
<thead>
<tr>
<th>Pattern</th>
<th style="text-align:center">一个返回值</th>
<th style="text-align:right">多个返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td>Synchronous</td>
<td style="text-align:center"><code>T getData()</code></td>
<td style="text-align:right"><code>Iterable&lt;T&gt;</code></td>
</tr>
<tr>
<td>Asynchronous</td>
<td style="text-align:center"><code>Future&lt;T&gt; getData()</code></td>
<td style="text-align:right"><code>Observable&lt;T&gt; getData()</code></td>
</tr>
</tbody>
</table>
<p>从语义的角度来看，RxJava就是.NET Rx。从语法的角度来看，Netflix考虑到了对应每个Rx方法,保留了Java代码规范和基本的模式。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章中，我们初步探索了响应式的世界。从微软的.NET到Netflix的RxJava，我们了解了Rx是如何诞生的，我们也了解到传统的方法与响应式方法相比之间的相似和不同。</p>
<p>下一章，我们将学习到Observables是什么，以及如何创建它并把响应式编程应用到我们的日常编码中去。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/chap1/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/chap1/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/chap2/" title="RxJava开发精要2-为什么是Observables?" itemprop="url">RxJava开发精要2-为什么是Observables?</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文出自《RxJava Essentials》</li>
</ul>
<ul>
<li>原文作者 : <a href="https://www.packtpub.com/books/info/authors/ivan-morgillo" target="_blank" rel="external">Ivan Morgillo</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/yuxingxin" target="_blank" rel="external">yuxingxin</a> </li>
<li>项目地址 : <a href="https://github.com/yuxingxin/RxJava-Essentials-CN" target="_blank" rel="external">RxJava-Essentials-CN</a></li>
</ul>
<h2 id="为什么是Observables"><a href="#为什么是Observables" class="headerlink" title="为什么是Observables?"></a>为什么是Observables?</h2><p>在面向对象的架构中，开发者致力于创建一组解耦的实体。这样的话，实体就可以在不用妨碍整个系统的情况下可以被测试、复用和维护。设计这种系统就带来一个棘手的负面影响：维护相关对象之间的统一。</p>
<p>在Smalltalk MVC架构中，创建模式的第一个例子就是用来解决这个问题的。用户界面框架提供一种途径使UI元素与包含数据的实体对象相分离，并且同时，它提供一种灵活的方法来保持它们之间的同步。</p>
<p>在这本畅销的四人组编写的《设计模式——可复用面向对象软件的基础》一书中，观察者模式是最有名的设计模式之一。它是一种行为模式并提供一种以一对多的依赖来绑定对象的方法：即当一个对象发生变化时，依赖它的所有对象都会被通知并且会自动更新。</p>
<p>在本章中，我们将会对观察者模式有一个概述，它是如何实现的以及如何用RxJava来扩展，Observable是什么，以及Observables如何与Iterables相关联。</p>
<h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><p>在今天，观察者模式是出现的最常用的软件设计模式之一。它基于subject这个概念。subject是一种特殊对象，当它改变时，那些由它保存的一系列对象将会得到通知。而这一系列对象被称作Observers,它们会对外暴漏了一个通知方法,当subject状态发生变化时会调用的这个方法。</p>
<p>在上一章中，我们看到了电子表单的例子。现在我们可以展开这个例子讲，展示一个更复杂的场景。让我们考虑这样一个填着账户数据的电子表单。我们可以把这些数据比作一张表，或者是3D柱状图，或者是饼状图。它们中每一个代表的意义都取决于同一组要展示的数据。每一个都是一个观察者，都依赖于那一个subject，维护着全部信息。</p>
<p>3D柱状图这个类、饼状图类、表这个类以及维护这些数据的类是完全解耦的：它们彼此相互独立复用，但也能协同工作。这些表示类彼此不清楚对方，但是正如它们所做的：它们知道在哪能找到它们需要展示的信息，它们也知道一旦数据发生变化就通知需要更新数据表示的那个类。</p>
<p>这有一张图描述了Subject/Observer的关系是怎样的一对多的关系：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter2_1.png" alt=""></p>
<p>上面这张图展示了一个Subject为3个Observers提供服务。很明显，没有理由去限制Observers的数量：如果有需要，一个Subject可以有无限多个Observers,当subject状态发生变化时，这些Observers中的每一个都会收到通知。</p>
<h2 id="你什么时候使用观察者模式？"><a href="#你什么时候使用观察者模式？" class="headerlink" title="你什么时候使用观察者模式？"></a>你什么时候使用观察者模式？</h2><p>观察者模式很适合下面这些场景中的任何一个：</p>
<ul>
<li>当你的架构有两个实体类，一个依赖另一个，你想让它们互不影响或者是独立复用它们时。</li>
<li>当一个变化的对象通知那些与它自身变化相关联的未知数量的对象时。</li>
<li>当一个变化的对象通知那些无需推断具体类型的对象时。</li>
</ul>
<h2 id="RxJava观察者模式工具包"><a href="#RxJava观察者模式工具包" class="headerlink" title="RxJava观察者模式工具包"></a>RxJava观察者模式工具包</h2><p>在RxJava的世界里，我们有四种角色：</p>
<ul>
<li>Observable</li>
<li>Observer</li>
<li>Subscriber</li>
<li>Subjects</li>
</ul>
<p>Observables和Subjects是两个“生产”实体，Observers和Subscribers是两个“消费”实体。</p>
<h2 id="Observable"><a href="#Observable" class="headerlink" title="Observable"></a>Observable</h2><p>当我们异步执行一些复杂的事情，Java提供了传统的类，例如Thread、Future、FutureTask、CompletableFuture来处理这些问题。当复杂度提升，这些方案就会变得麻烦和难以维护。最糟糕的是，它们都不支持链式调用。</p>
<p>RxJava Observables被设计用来解决这些问题。它们灵活，且易于使用，也可以链式调用，并且可以作用于单个结果程序上，更有甚者，也可以作用于序列上。无论何时你想发射单个标量值，或者一连串值，甚至是无穷个数值流，你都可以使用Observable。</p>
<p>Observable的生命周期包含了三种可能的易于与Iterable生命周期事件相比较的事件，下表展示了如何将Observable async/push 与 Iterable sync/pull相关联起来。</p>
<table>
<thead>
<tr>
<th>Event</th>
<th style="text-align:center">Iterable(pull)</th>
<th style="text-align:right">Observable(push)</th>
</tr>
</thead>
<tbody>
<tr>
<td>检索数据</td>
<td style="text-align:center"><code>T next()</code></td>
<td style="text-align:right"><code>onNext(T)</code></td>
</tr>
<tr>
<td>发现错误</td>
<td style="text-align:center"><code>throws Exception</code></td>
<td style="text-align:right"><code>onError(Throwable)</code></td>
</tr>
<tr>
<td>完成</td>
<td style="text-align:center"><code>!hasNext()</code></td>
<td style="text-align:right"><code>onCompleted()</code></td>
</tr>
</tbody>
</table>
<p>使用Iterable时，消费者从生产者那里以同步的方式得到值，在这些值得到之前线程处于阻塞状态。相反，使用Observable时，生产者以异步的方式把值推给观察者，无论何时，这些值都是可用的。这种方法之所以更灵活是因为即便值是同步或异步方式到达，消费者在这两种场景都可以根据自己的需要来处理。</p>
<p>为了更好地复用Iterable接口，RxJava Observable类扩展了GOF观察者模式的语义。引入了两个新的接口：</p>
<ul>
<li>onCompleted() 即通知观察者Observable没有更多的数据。</li>
<li>onError() 即观察者有错误出现了。</li>
</ul>
<h3 id="热Observables和冷Observables"><a href="#热Observables和冷Observables" class="headerlink" title="热Observables和冷Observables"></a>热Observables和冷Observables</h3><p>从发射物的角度来看，有两种不同的Observables:热的和冷的。一个”热”的Observable典型的只要一创建完就开始发射数据，因此所有后续订阅它的观察者可能从序列中间的某个位置开始接受数据（有一些数据错过了）。一个”冷”的Observable会一直等待，直到有观察者订阅它才开始发射数据，因此这个观察者可以确保会收到整个数据序列。</p>
<h3 id="创建一个Observable"><a href="#创建一个Observable" class="headerlink" title="创建一个Observable"></a>创建一个Observable</h3><p>在接下来的小节中将讨论Observables提供的两种创建Observable的方法。</p>
<h4 id="Observable-create"><a href="#Observable-create" class="headerlink" title="Observable.create()"></a>Observable.create()</h4><p>create()方法使开发者有能力从头开始创建一个Observable。它需要一个OnSubscribe对象,这个对象继承Action1,当观察者订阅我们的Observable时，它作为一个参数传入并执行call()函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Object&gt;()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Object&gt; subscriber)</span> </span>&#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Observable通过使用subscriber变量并根据条件调用它的方法来和观察者通信。让我们看一个“现实世界”的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Observable&lt;Integer&gt; observableString = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; observer)</span> </span>&#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">                observer.onNext(i);</div><div class="line">            &#125;</div><div class="line">            observer.onCompleted();</div><div class="line">        &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">Subscription subscriptionPrint = observableString.subscribe(<span class="keyword">new</span> Observer&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Observable completed"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Oh,no! Something wrong happened！"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer item)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Item is "</span> + item);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>例子故意写的简单，是因为即便是你第一次见到RxJava的操作，我想让你明白接下来要发生什么。</p>
<p>我们创建一个新的<code>Observable&lt;Integer&gt;</code>,它执行了5个元素的for循环，一个接一个的发射他们，最后完成。</p>
<p>另一方面，我们订阅了Observable，返回一个Subscription<br>。一旦我们订阅了，我们就开始接受整数，并一个接一个的打印出它们。我们并不知道要接受多少整数。事实上，我们也无需知道是因为我们为每种场景都提供对应的处理操作：</p>
<ul>
<li>如果我们接收到了整数，那么就打印它。</li>
<li>如果序列结束，我们就打印一个关闭的序列信息。</li>
<li>如果错误发生了，我们就打印一个错误信息。</li>
</ul>
<h4 id="Observable-from"><a href="#Observable-from" class="headerlink" title="Observable.from()"></a>Observable.from()</h4><p>在上一个例子中，我们创建了一个整数序列并一个一个的发射它们。假如我们已经有一个列表呢？我们是不是可以不用for循环而也可以一个接一个的发射它们呢？</p>
<p>在下面的例子代码中，我们从一个已有的列表中创建一个Observable序列：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">List&lt;Integer&gt; items = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">items.add(<span class="number">1</span>);</div><div class="line">items.add(<span class="number">10</span>);</div><div class="line">items.add(<span class="number">100</span>);</div><div class="line">items.add(<span class="number">200</span>);</div><div class="line"></div><div class="line">Observable&lt;Integer&gt; observableString = Observable.from(items);</div><div class="line">Subscription subscriptionPrint = observableString.subscribe(<span class="keyword">new</span> Observer&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Observable completed"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Oh,no! Something wrong happened！"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer item)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Item is "</span> + item);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>输出的结果和上面的例子绝对是一样的。</p>
<p><code>from()</code>创建符可以从一个列表/数组来创建Observable,并一个接一个的从列表/数组中发射出来每一个对象，或者也可以从Java <code>Future</code>类来创建Observable，并发射Future对象的<code>.get()</code>方法返回的结果值。传入<code>Future</code>作为参数时，我们可以指定一个超时的值。Observable将等待来自<code>Future</code>的结果；如果在超时之前仍然没有结果返回，Observable将会触发<code>onError()</code>方法通知观察者有错误发生了。</p>
<h4 id="Observable-just"><a href="#Observable-just" class="headerlink" title="Observable.just()"></a>Observable.just()</h4><p>如果我们已经有了一个传统的Java函数，我们想把它转变为一个Observable又改怎么办呢？我们可以用<code>create()</code>方法，正如我们先前看到的，或者我们也可以像下面那样使用以此来省去许多模板代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; observableString = Observable.just(helloWorld());</div><div class="line"></div><div class="line">Subscription subscriptionPrint = observableString.subscribe(<span class="keyword">new</span> Observer&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Observable completed"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Oh,no! Something wrong happened!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        System.out.println(message);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p><code>helloWorld()</code>方法比较简单，像这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">helloWorld</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"Hello World"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不管怎样，它可以是我们想要的任何函数。在刚才的例子中，我们一旦创建了Observable，<code>just()</code>执行函数，当我们订阅Observable时，它就会发射出返回的值。</p>
<p><code>just()</code>方法可以传入一到九个参数，它们会按照传入的参数的顺序来发射它们。<code>just()</code>方法也可以接受列表或数组，就像<code>from()</code>方法，但是它不会迭代列表发射每个值,它将会发射整个列表。通常，当我们想发射一组已经定义好的值时会用到它。但是如果我们的函数不是时变性的，我们可以用just来创建一个更有组织性和可测性的代码库。</p>
<p>最后注意<code>just()</code>创建符，它发射出值后，Observable正常结束，在上面那个例子中，我们会在控制台打印出两条信息：“Hello World”和“Observable completed”。</p>
<h4 id="Observable-empty-Observable-never-和Observable-throw"><a href="#Observable-empty-Observable-never-和Observable-throw" class="headerlink" title="Observable.empty(),Observable.never(),和Observable.throw()"></a>Observable.empty(),Observable.never(),和Observable.throw()</h4><p>当我们需要一个Observable毫无理由的不再发射数据正常结束时，我们可以使用<code>empty()</code>。我们可以使用<code>never()</code>创建一个不发射数据并且也永远不会结束的Observable。我们也可以使用<code>throw()</code>创建一个不发射数据并且以错误结束的Observable。</p>
<h2 id="Subject-Observable-Observer"><a href="#Subject-Observable-Observer" class="headerlink" title="Subject = Observable + Observer"></a>Subject = Observable + Observer</h2><p><code>subject</code>是一个神奇的对象，它可以是一个Observable同时也可以是一个Observer：它作为连接这两个世界的一座桥梁。一个Subject可以订阅一个Observable，就像一个观察者，并且它可以发射新的数据，或者传递它接受到的数据，就像一个Observable。很明显，作为一个Observable，观察者们或者其它Subject都可以订阅它。</p>
<p>一旦Subject订阅了Observable，它将会触发Observable开始发射。如果原始的Observable是“冷”的，这将会对订阅一个“热”的Observable变量产生影响。</p>
<p>RxJava提供四种不同的Subject：</p>
<ul>
<li>PublishSubject</li>
<li>BehaviorSubject</li>
<li>ReplaySubject.</li>
<li>AsyncSubject</li>
</ul>
<h3 id="PublishSubject"><a href="#PublishSubject" class="headerlink" title="PublishSubject"></a>PublishSubject</h3><p>Publish是Subject的一个基础子类。让我们看看用PublishSubject实现传统的Observable <code>Hello World</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">PublishSubject&lt;String&gt; stringPublishSubject = PublishSubject.create();</div><div class="line">Subscription subscriptionPrint = stringPublishSubject.subscribe(<span class="keyword">new</span> Observer&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Observable completed"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Oh,no!Something wrong happened!"</span>);                </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        System.out.println(message);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">stringPublishSubject.onNext(<span class="string">"Hello World"</span>);</div></pre></td></tr></table></figure></p>
<p>在刚才的例子中，我们创建了一个<code>PublishSubject</code>，用<code>create()</code>方法发射一个<code>String</code>值，然后我们订阅了PublishSubject。此时，没有数据要发送，因此我们的观察者只能等待，没有阻塞线程，也没有消耗资源。就在这随时准备从subject接收值，如果subject没有发射值那么我们的观察者就会一直在等待。再次声明的是，无需担心：观察者知道在每个场景中该做什么，我们不用担心什么时候是因为它是响应式的：系统会响应。我们并不关心它什么时候响应。我们只关心它响应时该做什么。</p>
<p>最后一行代码展示了手动发射字符串“Hello World”,它触发了观察者的<code>onNext()</code>方法，让我们在控制台打印出“Hello World”信息。</p>
<p>让我们看一个更复杂的例子。话说我们有一个<code>private</code>声明的Observable，外部不能访问。Observable在它生命周期内发射值，我们不用关心这些值，我们只关心他们的结束。</p>
<p>首先，我们创建一个新的PublishSubject来响应它的<code>onNext()</code>方法，并且外部也可以访问它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> PublishSubject&lt;Boolean&gt; subject = PublishSubject.create();</div><div class="line">        </div><div class="line">subject.subscribe(<span class="keyword">new</span> Observer&lt;Boolean&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Boolean aBoolean)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Observable Completed"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>然后，我们创建“私有”的Observable，只有subject才可以访问的到。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; subscriber)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">            subscriber.onNext(i);</div><div class="line">        &#125;</div><div class="line">        subscriber.onCompleted();</div><div class="line">    &#125;</div><div class="line">&#125;).doOnCompleted(<span class="keyword">new</span> Action0() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">        subject.onNext(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;).subscribe();</div></pre></td></tr></table></figure></p>
<p><code>Observable.create()</code>方法包含了我们熟悉的for循环，发射数字。<code>doOnCompleted()</code>方法指定当Observable结束时要做什么事情：在subject上发射true。最后，我们订阅了Observable。很明显，空的<code>subscribe()</code>调用仅仅是为了开启Observable，而不用管已发出的任何值，也不用管完成事件或者错误事件。为了这个例子我们需要它像这样。</p>
<p>在这个例子中，我们创建了一个可以连接Observables并且同时可被观测的实体。当我们想为公共资源创建独立、抽象或更易观测的点时，这是极其有用的。</p>
<h3 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h3><p>简单的说，BehaviorSubject会首先向他的订阅者发送截至订阅前最新的一个数据对象（或初始值）,然后正常发送订阅后的数据流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BehaviorSubject&lt;Integer&gt; behaviorSubject = BehaviorSubject.create(<span class="number">1</span>);</div></pre></td></tr></table></figure>
<p>在这个短例子中，我们创建了一个能发射整形(Integer)的BehaviorSubject。由于每当Observes订阅它时就会发射最新的数据，所以它需要一个初始值。</p>
<h3 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h3><p>ReplaySubject会缓存它所订阅的所有数据,向任意一个订阅它的观察者重发:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ReplaySubject&lt;Integer&gt; replaySubject = ReplaySubject.create();</div></pre></td></tr></table></figure></p>
<h3 id="AsyncSubject"><a href="#AsyncSubject" class="headerlink" title="AsyncSubject"></a>AsyncSubject</h3><p>当Observable完成时AsyncSubject只会发布最后一个数据给已经订阅的每一个观察者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AsyncSubject&lt;Integer&gt; asyncSubject = AsyncSubject.create();</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章中，我们了解到了什么是观察者模式，为什么Observables在今天的编程场景中如此重要，以及如何创建Observables和subjects。</p>
<p>下一章中，我们将创建第一个基于RxJava的Android应用程序，学习如何检索数据来填充listview，以及探索如何创建一个基于RxJava的响应式UI。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/chap2/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/chap2/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="carrie1217" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/git/" title="git">git<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/mac/" title="mac">mac<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/git/" title="git">git<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mac/" title="Mac">Mac<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Library/" title="Library">Library<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Spannable/" title="Spannable">Spannable<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/TimerTask/" title="TimerTask">TimerTask<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Timer/" title="Timer">Timer<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/size/" title="size">size<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Travis-CI/" title="Travis-CI">Travis-CI<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 活着就要学习，学习不是为了活着。 <br/>
			情况是在不断的变化，要使自己的思想适应新的情况，就得学习。</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/carrie1217" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Kevin">Kevin</a>
		
		
		</p>
		<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','DBjSFU5kGEcv8E-m-m_m','2.0.0');
</script>
</div></footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
