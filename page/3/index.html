
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Kevin博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Kevin">
    

    
    <meta name="description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">
<meta property="og:type" content="website">
<meta property="og:title" content="Kevin博客">
<meta property="og:url" content="https://kevin1202.github.io/page/3/index.html">
<meta property="og:site_name" content="Kevin博客">
<meta property="og:description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kevin博客">
<meta name="twitter:description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Kevin博客" title="Kevin博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Kevin博客">Kevin博客</a></h1>
				<h2 class="blog-motto">梦想还是要有的，万一实现了呢？</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" maxlength="20" placeholder="Search" />
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/chap4/" title="RxJava开发精要4 - Observables过滤" itemprop="url">RxJava开发精要4 - Observables过滤</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文出自《RxJava Essentials》</li>
<li>原文作者 : <a href="https://www.packtpub.com/books/info/authors/ivan-morgillo" target="_blank" rel="external">Ivan Morgillo</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/yuxingxin" target="_blank" rel="external">yuxingxin</a> </li>
<li>项目地址 : <a href="https://github.com/yuxingxin/RxJava-Essentials-CN" target="_blank" rel="external">RxJava-Essentials-CN</a></li>
</ul>
<h2 id="过滤Observables"><a href="#过滤Observables" class="headerlink" title="过滤Observables"></a>过滤Observables</h2><p>在上一章中，我们学习了使用RxJava创建一个Android工程以及如何创建一个可观测的列表来填充RecyclerView。我们现在知道了如何从头、从列表、从一个已存在的传统Java函数来创建Observable。</p>
<p>这一章中，我们将研究可观测序列的本质：过滤。我们将学到如何从发射的Observable中选取我们想要的值，如何获取有限个数的值，如何处理溢出的场景，以及更多的有用的技巧。</p>
<h2 id="过滤序列"><a href="#过滤序列" class="headerlink" title="过滤序列"></a>过滤序列</h2><p>RxJava让我们使用<code>filter()</code>方法来过滤我们观测序列中不想要的值，在上一章中，我们在几个例子中使用了已安装的应用列表，但是我们只想展示以字母<code>C</code>开头的已安装的应用该怎么办呢？在这个新的例子中，我们将使用同样的列表，但是我们会过滤它，通过把合适的谓词传给<code>filter()</code>函数来得到我们想要的值。</p>
<p>上一章中<code>loadList()</code>函数可以改成这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable.from(apps)</div><div class="line">            .filter((appInfo) -&gt;</div><div class="line">            appInfo.getName().startsWith(<span class="string">"C"</span>))</div><div class="line">            .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">                    mAddedApps.add(appInfo); </div><div class="line">                    mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们从上一章中的<code>loadList()</code>函数中添加下面一行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.fliter((appInfo -&gt; appInfo.getName().startsWith(<span class="string">"C"</span>))</div></pre></td></tr></table></figure></p>
<p>创建Observable完以后，我们从发出的每个元素中过滤掉开头字母不是C的。为了让这里更清楚一些，我们用Java 7的语法来实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.filter(<span class="keyword">new</span> Func1&lt;AppInfo,Boolean&gt;()&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(AppInfo appInfo)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> appInfo.getName().startsWith(<span class="string">"C"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>我们传一个新的<code>Func1</code>对象给<code>filter()</code>函数，即只有一个参数的函数。<code>Func1</code>有一个<code>AppInfo</code>对象来作为它的参数类型并且返回<code>Boolean</code>对象。只要条件符合<code>filter()</code>函数就会返回<code>true</code>。此时，值会发射出去并且所有的观察者都会接收到。</p>
<p>正如你想的那样，从一个我们得到的可观测序列中创建一个我们需要的序列<code>filter()</code>是很好用的。我们不需要知道可观测序列的源或者为什么发射这么多不同的数据。我们只是想要这些元素的子集来创建一个可以在应用中使用的新序列。这种思想促进了我们编码中的分离性与抽象性。</p>
<p><code>filter()</code>函数最常用的用法之一时过滤<code>null</code>对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.filter(<span class="keyword">new</span> Func1&lt;AppInfo,Boolean&gt;()&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(AppInfo appInfo)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> appInfo != <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>这看起来简单，对于简单的事情有许多模板代码，但是它帮我们免去了在<code>onNext()</code>函数调用中再去检测<code>null</code>值，让我们把注意力集中在应用业务逻辑上。</p>
<p>下图展示了过滤出的C字母开头的已安装的应用列表。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_1.png" width="240"></p>
<h2 id="获取我们需要的数据"><a href="#获取我们需要的数据" class="headerlink" title="获取我们需要的数据"></a>获取我们需要的数据</h2><p>当我们不需要整个序列时，而是只想取开头或结尾的几个元素，我们可以用<code>take()</code>或<code>takeLast()</code>。</p>
<h2 id="Take"><a href="#Take" class="headerlink" title="Take"></a>Take</h2><p>如果我们只想要一个可观测序列中的前三个元素那将会怎么样，发射它们，然后让Observable完成吗？<code>take()</code>函数用整数N来作为一个参数，从原始的序列中发射前N个元素，然后完成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable.from(apps)</div><div class="line">            .take(<span class="number">3</span>)</div><div class="line">            .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">                    mAddedApps.add(appInfo); </div><div class="line">                    mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下图中展示了发射数字的一个可观测序列。我们对这个可观测序列应用<code>take(2)</code>函数，然后我们创建一个只发射可观测源的第一个和第二个数据的新序列。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_2.png" alt=""></p>
<h2 id="TakeLast"><a href="#TakeLast" class="headerlink" title="TakeLast"></a>TakeLast</h2><p>如果我们想要最后N个元素，我们只需使用<code>takeLast()</code>函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Observable.from(apps)</div><div class="line">        .takeLast(<span class="number">3</span>)</div><div class="line">        .subscribe(https:<span class="comment">//github.com/yuxingxin/RxJava-Essentials-CN/raw/master.);</span></div></pre></td></tr></table></figure></p>
<p>正如听起来那样不值一提，重点注意<code>takeLast()</code>函数由于用一组有限的发射数的本质使得它仅可用于完成的序列。</p>
<p>下图中展示了如何从可观测源中发射最后一个元素来创建一个新的序列：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_3.png" alt=""></p>
<p>下图中展示了我们在已安装的应用列表使用<code>take()</code>和<code>takeLast()</code>函数后发生的结果：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_4.png" alt=""></p>
<h2 id="有且仅有一次"><a href="#有且仅有一次" class="headerlink" title="有且仅有一次"></a>有且仅有一次</h2><p>一个可观测序列会在出错时重复发射或者被设计成重复发射。<code>distinct()</code>和<code>distinctUntilChanged()</code>函数可以方便的让我们处理这种重复问题。</p>
<h2 id="Distinct"><a href="#Distinct" class="headerlink" title="Distinct"></a>Distinct</h2><p>如果我们想对一个指定的值仅处理一次该怎么办？我们可以对我们的序列使用<code>distinct()</code>函数去掉重复的。就像<code>takeLast()</code>一样，<code>distinct()</code>作用于一个完整的序列，然后得到重复的过滤项，它需要记录每一个发射的值。如果你在处理一大堆序列或者大的数据记得关注内存使用情况。</p>
<p>下图展示了如何在一个发射1和2两次的可观测源上创建一个无重的序列：<br><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_5.png" alt=""></p>
<p>为了创建我们例子中序列，我们将使用我们至今已经学到的几个方法：</p>
<ul>
<li><code>take()</code>：它有一小组的可识别的数据项。</li>
<li><code>repeat()</code>：创建一个有重复的大的序列。</li>
</ul>
<p>然后，我们将应用<code>distinct()</code>函数来去除重复。</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>我们用程序实现一个重复的序列，然后过滤出它们。这听起来时不可思议的，但是为了实现这个例子来使用我们至今为止已学习到的东西则是个不错的练习。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Observable&lt;AppInfo&gt; fullOfDuplicates = Observable.from(apps)</div><div class="line">    .take(<span class="number">3</span>)</div><div class="line">    .repeat(<span class="number">3</span>);</div></pre></td></tr></table></figure>
<p><code>fullOfDuplicates</code>变量里把我们已安装应用的前三个重复了3次：有9个并且许多重复的。然后，我们使用<code>distinct()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">fullOfDuplicates.distinct()</div><div class="line">            .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">                    mAddedApps.add(appInfo); </div><div class="line">                    mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果，很明显，我们得到：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_6.png" width="240"></p>
<h2 id="DistinctUntilsChanged"><a href="#DistinctUntilsChanged" class="headerlink" title="DistinctUntilsChanged"></a>DistinctUntilsChanged</h2><p>如果在一个可观测序列发射一个不同于之前的一个新值时让我们得到通知这时候该怎么做？我们猜想一下我们观测的温度传感器，每秒发射的室内温度：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">21°https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master.21°https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master.21°https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master.21°https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master.22°https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master.</div></pre></td></tr></table></figure></p>
<p>每次我们获得一个新值，我们都会更新当前正在显示的温度。我们出于系统资源保护并不想在每次值一样时更新数据。我们想忽略掉重复的值并且在温度确实改变时才想得到通知。<code>ditinctUntilChanged()</code>过滤函数能做到这一点。它能轻易的忽略掉所有的重复并且只发射出新的值。</p>
<p>下图用图形化的方式展示了我们如何将<code>distinctUntilChanged()</code>函数应用在一个存在的序列上来创建一个新的不重复发射元素的序列。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_7.png" alt=""></p>
<h2 id="First-and-last"><a href="#First-and-last" class="headerlink" title="First and last"></a>First and last</h2><p>下图展示了如何从一个从可观测源序列中创建只发射第一个元素的序列。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_8.png" alt=""></p>
<p><code>first()</code>方法和<code>last()</code>方法很容易弄明白。它们从Observable中只发射第一个元素或者最后一个元素。这两个都可以传<code>Func1</code>作为参数，：一个可以确定我们感兴趣的第一个或者最后一个的谓词：</p>
<p>下图展示了<code>last()</code>应用在一个完成的序列上来创建一个仅仅发射最后一个元素的新的Observable。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_9.png" alt=""></p>
<p>与<code>first()</code>和<code>last()</code>相似的变量有：<code>firstOrDefault()</code>和<code>lastOrDefault()</code>.这两个函数当可观测序列完成时不再发射任何值时用得上。在这种场景下，如果Observable不再发射任何值时我们可以指定发射一个默认的值</p>
<h2 id="Skip-and-SkipLast"><a href="#Skip-and-SkipLast" class="headerlink" title="Skip and SkipLast"></a>Skip and SkipLast</h2><p>下图中展示了如何使用<code>skip(2)</code>来创建一个不发射前两个元素而是发射它后面的那些数据的序列。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_10.png" alt=""></p>
<p><code>skip()</code>和<code>skipLast()</code>函数与<code>take()</code>和<code>takeLast()</code>相对应。它们用整数N作参数，从本质上来说，它们不让Observable发射前N个或者后N个值。如果我们知道一个序列以没有太多用的“可控”元素开头或结尾时我们可以使用它。</p>
<p>下图与前一个场景相对应：我们创建一个新的序列，它会跳过后面两个元素从源序列中发射剩下的其他元素。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_11.png" alt=""></p>
<h2 id="ElementAt"><a href="#ElementAt" class="headerlink" title="ElementAt"></a>ElementAt</h2><p>如果我们只想要可观测序列发射的第五个元素该怎么办？<code>elementAt()</code>函数仅从一个序列中发射第n个元素然后就完成了。</p>
<p>如果我们想查找第五个元素但是可观测序列只有三个元素可供发射时该怎么办？我们可以使用<code>elementAtOrDefault()</code>。下图展示了如何通过使用<code>elementAt(2)</code>从一个序列中选择第三个元素以及如何创建一个只发射指定元素的新的Observable。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_12.png" alt=""></p>
<h2 id="Sampling"><a href="#Sampling" class="headerlink" title="Sampling"></a>Sampling</h2><p>让我们再回到那个温度传感器。它每秒都会发射当前室内的温度。说实话，我们并不认为温度会变化这么快，我们可以使用一个小的发射间隔。在Observable后面加一个<code>sample()</code>，我们将创建一个新的可观测序列，它将在一个指定的时间间隔里由Observable发射最近一次的数值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Observable&lt;Integer&gt; sensor = [...]</div><div class="line"></div><div class="line">sensor.sample(<span class="number">30</span>,TimeUnit.SECONDS)</div><div class="line">    .subscribe(<span class="keyword">new</span> Observable&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">           </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer currentTemperature)</span> </span>&#123;</div><div class="line">            updateDisplay(currentTemperature)</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>例子中Observable将会观测温度Observable然后每隔30秒就会发射最后一个温度值。很明显，<code>sample()</code>支持全部的时间单位：秒，毫秒，天，分等等。</p>
<p>下图中展示了一个间隔发射字母的Observable如何采样一个发射数字的Observable。Observable的结果将会发射每个已发射字母的最后一组数据：1，4，5.</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_13.png" alt=""></p>
<p>如果我们想让它定时发射第一个元素而不是最近的一个元素，我们可以使用<code>throttleFirst()</code>。</p>
<h2 id="Timeout"><a href="#Timeout" class="headerlink" title="Timeout"></a>Timeout</h2><p>假设我们工作的是一个时效性的环境，我们温度传感器每秒都在发射一个温度值。我们想让它每隔两秒至少发射一个，我们可以使用<code>timeout()</code>函数来监听源可观测序列,就是在我们设定的时间间隔内如果没有得到一个值则发射一个错误。我们可以认为<code>timeout()</code>为一个Observable的限时的副本。如果在指定的时间间隔内Observable不发射值的话，它监听的原始的Observable时就会触发<code>onError()</code>函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Subscription subscription = getCurrentTemperature()</div><div class="line">    .timeout(<span class="number">2</span>,TimeUnit.SECONDS)</div><div class="line">    .subscribe(<span class="keyword">new</span> Observable&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">           </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            Log.d(<span class="string">"RXJAVA"</span>,<span class="string">"You should go check the sensor, dude"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer currentTemperature)</span> </span>&#123;</div><div class="line">            updateDisplay(currentTemperature)</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>和<code>sample()</code>一样，<code>timeout()</code>使用<code>TimeUnit</code>对象来指定时间间隔。</p>
<p>下图中展示了一旦Observable超过了限时就会触发<code>onError()</code>函数：因为超时后它才到达，所以最后一个元素将不会发射出去。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_14.png" alt=""></p>
<h2 id="Debounce"><a href="#Debounce" class="headerlink" title="Debounce"></a>Debounce</h2><p><code>debounce()</code>函数过滤掉由Observable发射的速率过快的数据；如果在一个指定的时间间隔过去了仍旧没有发射一个，那么它将发射最后的那个。</p>
<p>就像<code>sample()</code>和<code>timeout()</code>函数一样，<code>debounce()</code>使用<code>TimeUnit</code>对象指定时间间隔。</p>
<p>下图展示了多久从Observable发射一次新的数据，<code>debounce()</code>函数开启一个内部定时器，如果在这个时间间隔内没有新的数据发射，则新的Observable发射出最后一个数据：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter4_15.png" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这一章中，我们学习了如何过滤一个可观测序列。我们现在可以使用<code>filter()</code>，<code>skip()</code>，和<code>sample()</code>来创建我们想要的Observable。</p>
<p>下一章中，我们将学习如何转换一个序列，将函数应用到每个元素，给它们分组和扫描来创建我们所需要的能完成目标的特定Observable。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/chap4/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/chap4/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/chap3/" title="RxJava开发精要3-向响应式世界问好" itemprop="url">RxJava开发精要3-向响应式世界问好</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文出自《RxJava Essentials》</li>
<li>原文作者 : <a href="https://www.packtpub.com/books/info/authors/ivan-morgillo" target="_blank" rel="external">Ivan Morgillo</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/yuxingxin" target="_blank" rel="external">yuxingxin</a> </li>
<li>项目地址 : <a href="https://github.com/yuxingxin/RxJava-Essentials-CN" target="_blank" rel="external">RxJava-Essentials-CN</a></li>
</ul>
<h2 id="向响应式世界问好"><a href="#向响应式世界问好" class="headerlink" title="向响应式世界问好"></a>向响应式世界问好</h2><p>在上一章中，我们对观察者模式有个理论上的快速概述。我们也看了从头开始、从列表、或者从已经存在的函数来创建Observables。在本章中，我们将用我们学到的来创建我们第一个响应式Android应用程序。首先，我们需要搭建环境，导入需要的库和有用的库。然后我们将创建一个简单的应用程序，在不同的flavors中包含几个用RxJava填充的RecycleView items。</p>
<h2 id="启动引擎"><a href="#启动引擎" class="headerlink" title="启动引擎"></a>启动引擎</h2><p>我们将使用IntelliJ IDEA/Android Studio来创建这个工程，因此你会对截图看起来比较熟悉。</p>
<p>让我们开始创建一个新的Android工程。你可以创建你自己的工程或者用本书中提供的导入。选择你自己喜欢的创建方式这取决于你。</p>
<p>如果你想用Android Studio创建一个新的工程，通常你可以参考官方文档：<a href="http://developer.android.com/intl/zh-cn/training/basics/firstapp/creating-project.html" target="_blank" rel="external">http://developer.android.com/intl/zh-cn/training/basics/firstapp/creating-project.html</a></p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter3_1.png" alt=""></p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>很明显，我们将使用<strong>Gradle</strong>来管理我们的依赖列表。我们的build.gradble文件看起来像这样：<br> <img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter3_2.png" alt=""><br> <img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter3_3.png" alt=""><br>正如你看到的我们引入了RxAndroid。RxAndroid是RxJava的增强版，尤其是针对Android设计的。</p>
<h3 id="RxAndroid"><a href="#RxAndroid" class="headerlink" title="RxAndroid"></a>RxAndroid</h3><p>RxAndroid是RxJava家族的一部分。它基于RxJava1.0.x,在普通的RxJava基础上添加了几个有用的类。大多数情况下，它为Android添加了特殊的调度器。我们将在第七章Schedulers-Defeating the Android MainThread Issue再讨论它。</p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>出于实用，我们引入了Lombok 和 Butter Knife。这两个可以帮助我们在Android应用程序中少写许多模板类代码。</p>
<h3 id="Lombok"><a href="#Lombok" class="headerlink" title="Lombok"></a>Lombok</h3><p>Lombok使用注解的方式为你生成许多代码。我们将使用它老生成<code>getter/setter</code>、<code>toString()</code>、<code>equals()</code>、<code>hashCode()</code>。它借助于Gradle依赖和一个Android Studio插件。</p>
<h3 id="Butter-Knife"><a href="#Butter-Knife" class="headerlink" title="Butter Knife"></a>Butter Knife</h3><p>Butter Knife使用注解的方式来帮助我们免去写<code>findViewById()</code>和设置点击监听的痛苦。至于Lombok,我们可以通过导入依赖和安装Android Studio插件来获得更好的体验。</p>
<h3 id="Retrolambda"><a href="#Retrolambda" class="headerlink" title="Retrolambda"></a>Retrolambda</h3><p>最后，我们导入Retrolambda，是因为我们开发的Android是基于Java 1.6，然后我们可以借助它来实现Java 8 Lambda函数从而减少许多模板代码。</p>
<h2 id="我们的第一个Observable"><a href="#我们的第一个Observable" class="headerlink" title="我们的第一个Observable"></a>我们的第一个Observable</h2><p>在我们的第一个列子里，我们将检索安装的应用列表并填充RecycleView的item来展示它们。我们也设想一个下拉刷新的功能和一个进度条来告知用户当前任务正在执行。</p>
<p>首先，我们创建Observable。我们需要一个函数来检索安装的应用程序列表并把它提供给我们的观察者。我们一个接一个的发射这些应用程序数据，将它们分组到一个单独的列表中，以此来展示响应式方法的灵活性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;AppInfo&gt; <span class="title">getApps</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.create(subscriber -&gt; &#123;</div><div class="line">        List&lt;AppInfoRich&gt; apps = <span class="keyword">new</span> ArrayList&lt;AppInfoRich&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Intent mainIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN,<span class="keyword">null</span>);</div><div class="line">        mainIntent.addCategory(Intent.CATEGORY_LAUNCHER);</div><div class="line"></div><div class="line">        List&lt;ResolveInfo&gt; infos = getActivity().getPackageManager().queryIntentActivities(mainIntent, <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span>(ResolveInfo info : infos)&#123;</div><div class="line">            apps.add(<span class="keyword">new</span> AppInfoRich(getActivity(),info));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (AppInfoRich appInfo:apps) &#123;</div><div class="line">            Bitmap icon = Utils.drawableToBitmap(appInfo.getIcon());</div><div class="line">            String name = appInfo.getName();</div><div class="line">            String iconPath = mFilesDir + <span class="string">"/"</span> + name;</div><div class="line">            Utils.storeBitmap(App.instance, icon,name);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (subscriber.isUnsubscribed())&#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            subscriber.onNext(<span class="keyword">new</span> AppInfo(name,iconPath,appInfo.getLastUpdateTime()));                </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!subscriber.isUnsubscribed())&#123;</div><div class="line">            subscriber.onCompleted();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AppInfo对象如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Data</span></div><div class="line"><span class="meta">@Accessors</span>(prefix = <span class="string">"m"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppInfo</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">long</span> mLastUpdateTime;</div><div class="line">    String mName;</div><div class="line">    String mIcon;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppInfo</span><span class="params">(String nName, <span class="keyword">long</span> lastUpdateTime, String icon)</span> </span>&#123;</div><div class="line">        mName = nName;</div><div class="line">        mIcon = icon;</div><div class="line">        mLastUpdateTime = lastUpdateTime;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object another)</span> </span>&#123;</div><div class="line">        AppInfo f = (AppInfo)another;</div><div class="line">        <span class="keyword">return</span> getName().compareTo(f.getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要重点注意的是在发射新的数据或者完成序列之前要检测观察者的订阅情况。这样的话代码会更高效，因为如果没有观察者等待时我们就不生成没有必要的数据项。</p>
<p>此时，我们可以订阅Observable并观察它。订阅一个Observable意味着当我们需要的数据进来时我们必须提供对应的操作来执行它。</p>
<p>当前的场景是什么？我们展示一个进度条来等待数据。当数据到来时，我们需要隐藏掉进度条,填充list,最终展示列表。现在，我们知道当一切都准备好了该做什么。那么错误的场景呢？对于错误这种情况，我们仅仅是用Toast展示一个错误的信息。</p>
<p>使用Butter Knife,我们得到list和下拉刷新组件的引用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@InjetcView</span>(R.id.fragment_first_example_list)</div><div class="line">RecyclerView mRecycleView;</div><div class="line">    </div><div class="line"><span class="meta">@InjectView</span>(R.id.fragment_first_example_swipe_container)</div><div class="line">SwipeRefreshLayout mSwipeRefreshLayout;</div></pre></td></tr></table></figure>
<p>我们使用Android 5的标准组件：RecyclerView和SwipeRefreshLayout。截屏展示了我们这个简单App的list Fragment的layout文件：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter3_4.png" alt=""></p>
<p>我们使用一个下拉刷新方法，因此列表数据可以来自初始化加载，或由用户触发的一个刷新动作。针对这两个场景，我们用同样的行为，因此我们把我们的观察者放在一个易被复用的函数里面。下面是我们的观察者，定义了成功、失败、完成要做的事情：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshTheList</span><span class="params">()</span> </span>&#123;</div><div class="line">    getApps().toSortedList()</div><div class="line">            .subscribe(<span class="keyword">new</span> Observable&lt;List&lt;AppInfo&gt;&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;AppInfo&gt; appInfos)</span> </span>&#123;</div><div class="line">                    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">                    mAdapter.addApplications(appInfos);</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义一个函数使我们能够用同样一个block来处理两种场景成为了可能。当fragment加载时我们只需调用<code>refreshTheList()</code>方法并设置<code>refreshTheList()</code>方法作为用户下拉这一行为所触发的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mSwipeRefreshLayout.setOnRefreshListener(<span class="keyword">this</span>::refreshTheList);</div></pre></td></tr></table></figure>
<p>我们第一个例子现在完成了，运行跑一下。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter3_5.png" alt=""></p>
<h2 id="从列表创建一个Observable"><a href="#从列表创建一个Observable" class="headerlink" title="从列表创建一个Observable"></a>从列表创建一个Observable</h2><p>在这个例子中，我们将引入<code>from()</code>函数。使用这个特殊的“创建”函数，我们可以从一个列表中创建一个Observable。Observable将发射出列表中的每一个元素，我们可以通过订阅它们来对这些发出的元素做出响应。</p>
<p>为了实现和第一个例子同样的结果，我们在每一个<code>onNext()</code>函数更新我们的适配器，添加元素并通知插入。</p>
<p>我们将复用和第一个例子同样的结构。主要的不同的是我们不再检索已安装的应用列表。列表由外部实体提供：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mApps = ApplicationsList.getInstance().getList();</div></pre></td></tr></table></figure>
<p>获得列表后，我们仅需将它响应化并填充RecyclerView的item:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable.from(apps)</div><div class="line">            .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">                    mAddedApps.add(appInfo); </div><div class="line">                    mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你看到的，我们将已安装的应用程序列表作为参数传进<code>from()</code>函数，然后我们订阅生成的Observable。观察者和我们第一个例子中的观察者十分相像。一个主要的不同是我们在<code>onCompleted()</code>函数中停掉进度条是因为我们一个一个的发射元素；第一个例子中的Observable发射的是整个list,因此在<code>onNext()</code>函数中停掉进度条的做法是安全的。</p>
<h2 id="再多几个例子"><a href="#再多几个例子" class="headerlink" title="再多几个例子"></a>再多几个例子</h2><p>在这一节中，我们将基于RxJava的<code>just()</code>,<code>repeat()</code>,<code>defer()</code>,<code>range()</code>,<code>interval()</code>,和<code>timer()</code>方法展示一些例子。</p>
<h3 id="just"><a href="#just" class="headerlink" title="just()"></a>just()</h3><p>假如我们只有3个独立的AppInfo对象并且我们想把他们转化为Observable并填充到RecyclerView的item中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">List&lt;AppInfo&gt; apps = ApplicationsList.getInstance().getList();</div><div class="line"></div><div class="line">AppInfo appOne = apps.get(<span class="number">0</span>);</div><div class="line"></div><div class="line">AppInfo appTwo = apps.get(<span class="number">10</span>);</div><div class="line"></div><div class="line">AppInfo appThree = apps.get(<span class="number">24</span>);</div><div class="line"></div><div class="line">loadApps(appOne,appTwo,appThree);</div></pre></td></tr></table></figure></p>
<p>我们可以像我们之前的例子那样检索列表并提取出这三个元素。然后我们将他们传到这个<code>loadApps()</code>函数里面：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadApps</span><span class="params">(AppInfo appOne,AppInfo appTwo,AppInfo appThree)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable.just(appOne,appTwo,appThree)</div><div class="line">            .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">                    mAddedApps.add(appInfo); </div><div class="line">                    mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你看到的，代码和之前的例子很像。这种方法让我们有机会来考虑一下代码的复用。</p>
<p>你可以将一个函数作为参数传给<code>just()</code>方法，你将会得到一个已存在代码的原始Observable版本。在一个新的响应式架构的基础上迁移已存在的代码，这个方法可能是一个有用的开始点。</p>
<h3 id="repeat"><a href="#repeat" class="headerlink" title="repeat()"></a>repeat()</h3><p>假如你想对一个Observable重复发射三次数据。例如，我们用<code>just()</code>例子中的Observable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadApps</span><span class="params">(AppInfo appOne,AppInfo appTwo,AppInfo appThree)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable.just(appOne,appTwo,appThree)</div><div class="line">            .repeat(<span class="number">3</span>)</div><div class="line">            .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">                    mAddedApps.add(appInfo); </div><div class="line">                    mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正如你看到的，我们在<code>just()</code>创建Observable后追加了<code>repeat(3)</code>，它将会创建9个元素的序列，每一个都单独发射。</p>
<h3 id="defer"><a href="#defer" class="headerlink" title="defer()"></a>defer()</h3><p>有这样一个场景，你想在这声明一个Observable但是你又想推迟这个Observable的创建直到观察者订阅时。看下面的<code>getInt()</code>函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;Integer&gt; <span class="title">getInt</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.create(subscriber -&gt; &#123;</div><div class="line">        <span class="keyword">if</span>(subscriber.isUnsubscribed())&#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        App.L.debug(<span class="string">"GETINT"</span>);</div><div class="line">        subscriber.onNext(<span class="number">42</span>);</div><div class="line">        subscriber.onCompleted();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这比较简单，并且它没有做太多事情，但是它正好为我们服务。现在，我们可以创建一个新的Observable并且应用<code>defer()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Observable&lt;Integer&gt; deferred = Observable.defer(<span class="keyword">this</span>::getInt);</div></pre></td></tr></table></figure>
<p>这次，<code>deferred</code>存在，但是<code>getInt()</code> <code>create()</code>方法还没有调用:logcat日志也没有“GETINT”打印出来:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">deferred.subscribe(number -&gt; &#123;</div><div class="line">    App.L.debug(String.valueOf(number));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>但是一旦我们订阅了，<code>create()</code>方法就会被调用并且我们也可以在logcat日志中得到下卖弄两个：GETINT和42。</p>
<h3 id="range"><a href="#range" class="headerlink" title="range()"></a>range()</h3><p>你需要从一个指定的数字X开始发射N个数字吗？你可以用<code>range</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Observable.range(<span class="number">10</span>,<span class="number">3</span>)</div><div class="line">    .subscribe(<span class="keyword">new</span> Observable&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Yeaaah!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer number)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"I say "</span> + number, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<p><code>range()</code>函数用两个数字作为参数：第一个是起始点，第二个是我们想发射数字的个数。</p>
<h3 id="interval"><a href="#interval" class="headerlink" title="interval()"></a>interval()</h3><p><code>interval()</code>函数在你需要创建一个轮询程序时非常好用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Subscription stopMePlease = Observable.interval(<span class="number">3</span>,TimeUnit.SECONDS)</div><div class="line">    .subscribe(<span class="keyword">new</span> Observable&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Yeaaah!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer number)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"I say "</span> + number, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<p><code>interval()</code>函数的两个参数：一个指定两次发射的时间间隔，另一个是用到的时间单位。</p>
<h3 id="timer"><a href="#timer" class="headerlink" title="timer()"></a>timer()</h3><p>如果你需要一个一段时间之后才发射的Observable，你可以像下面的例子使用<code>timer()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Observable.timer(<span class="number">3</span>,TimeUnit.SECONDS)</div><div class="line">    .subscribe(<span class="keyword">new</span> Observable&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Long number)</span> </span>&#123;</div><div class="line">            Log.d(<span class="string">"RXJAVA"</span>, <span class="string">"I say "</span> + number);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>它将3秒后发射0,然后就完成了。让我们使用<code>timer()</code>的第三个参数，就像下面的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Observable.timer(<span class="number">3</span>,<span class="number">3</span>,TimeUnit.SECONDS)</div><div class="line">    .subscribe(<span class="keyword">new</span> Observable&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Long number)</span> </span>&#123;</div><div class="line">            Log.d(<span class="string">"RXJAVA"</span>, <span class="string">"I say "</span> + number);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<p>用这个代码，你可以创建一个以初始值来延迟（上一个例子是3秒）执行的<code>interval()</code>版本，然后每隔N秒就发射一个新的数字（前面的例子是3秒）。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在本章中，我们创建了第一个由RxJava强化的Android应用程序。我们从头、从已有的列表、从已有的函数来创建Observable。我们也学习了如何创建重复发射的Observables，间隔发射的Observables以及延迟发射的Observables。</p>
<p>在下一章中，我们将掌握过滤操作，能够从我们接收到的序列中创建我们需要的序列。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/chap3/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/chap3/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/chap5/" title="RxJava开发精要5 - Observables变换" itemprop="url">RxJava开发精要5 - Observables变换</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文出自《RxJava Essentials》</li>
<li>原文作者 : <a href="https://www.packtpub.com/books/info/authors/ivan-morgillo" target="_blank" rel="external">Ivan Morgillo</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/yuxingxin" target="_blank" rel="external">yuxingxin</a> </li>
<li>项目地址 : <a href="https://github.com/yuxingxin/RxJava-Essentials-CN" target="_blank" rel="external">RxJava-Essentials-CN</a></li>
</ul>
<p>在上一章中，我们探索了RxJava通用过滤方法。我们学习了如何使用<code>filter()</code>方法过滤我们不需要的值，如何使用<code>take()</code>得到发射元素的子集，如何使用<code>distinct()</code>函数来去除重复的。我们学习了如何使用<code>timeout()</code>，<code>sample()</code>，以及<code>debounce()</code>来利用时间。</p>
<p>这一章中，我们将学习如何变换可观测序列来创建一个更好满足我们需求的序列。</p>
<h2 id="map家族"><a href="#map家族" class="headerlink" title="*map家族"></a>*map家族</h2><p>RxJava提供了几个mapping函数：<code>map()</code>,<code>flatMap()</code>,<code>concatMap()</code>,<code>flatMapIterable()</code>以及<code>switchMap()</code>.所有这些函数都作用于一个可观测序列，然后变换它发射的值，最后用一种新的形式返回它们。让我们用“真实世界”合适的例子一个个的学习下。</p>
<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p>RxJava的<code>map</code>函数接收一个指定的<code>Func</code>对象然后将它应用到每一个由Observable发射的值上。下图展示了如何将一个乘法函数应用到每个发出的值上以此创建一个新的Observable来发射转换的数据。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_1.png" alt=""></p>
<p>考虑我们已安装的应用列表。我们怎么才能够显示同样的列表，但是所有的名字都是小写。</p>
<p>我们的<code>loadList()</code>函数可以改成这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable.from(apps)</div><div class="line">        .map(<span class="keyword">new</span> Func1&lt;AppInfo,AppInfo&gt;()&#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Appinfo <span class="title">call</span><span class="params">(AppInfo appInfo)</span></span>&#123;</div><div class="line">                String currentName = appInfo.getName();</div><div class="line">                String lowerCaseName = currentName.toLowerCase();</div><div class="line">                appInfo.setName(lowerCaseName);</div><div class="line">                <span class="keyword">return</span> appInfo;</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">                mAddedApps.add(appInfo); </div><div class="line">                mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你看到的，像往常一样创建我们发射的Observable，我们加一个<code>map</code>调用，我们可以创建一个简单的函数来更新<code>AppInfo</code>对象并提供一个名字小写的新版本给观察者。</p>
<h2 id="FlatMap"><a href="#FlatMap" class="headerlink" title="FlatMap"></a>FlatMap</h2><p>在复杂的场景中，我们有一个这样的Observable：它发射一个数据序列，这些数据本身也可以发射Observable。RxJava的<code>flatMap()</code>函数提供一种铺平序列的方式，然后合并这些Observables发射的数据，最后将合并后的结果作为最终的Observable。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_2.png" alt=""></p>
<p>当我们在处理可能有大量的Observables时，重要是记住任何一个Observables发生错误的情况，<code>flatMap()</code>函数将会触发它自己的<code>onError()</code>函数并放弃整个链。</p>
<p>重要的一点是关于合并部分：它允许交叉。正如上图所示，这意味着<code>flatMap()</code>函数在最后的Observable中不能够保证源Observables确切的发射顺序。</p>
<h2 id="ConcatMap"><a href="#ConcatMap" class="headerlink" title="ConcatMap"></a>ConcatMap</h2><p>RxJava的<code>concatMap()</code>函数解决了<code>flatMap()</code>的交叉问题，提供了一种能够把发射的值连续在一起的铺平函数，而不是合并它们，如下图所示：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_3.png" alt=""></p>
<h2 id="FlatMapIterable"><a href="#FlatMapIterable" class="headerlink" title="FlatMapIterable"></a>FlatMapIterable</h2><p>作为*map家族的一员，<code>flatMapInterable()</code>和<code>flatMap()</code>很像。仅有的本质不同是它将源数据两两结成对，然后生成Iterable而不是原始数据和生成的Observables。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_4.png" alt=""></p>
<h2 id="SwitchMap"><a href="#SwitchMap" class="headerlink" title="SwitchMap"></a>SwitchMap</h2><p>如下图所示，<code>switchMap()</code>和<code>flatMap()</code>很像，除了一点：当原始Observable发射一个新的数据（Observable）时，它将取消订阅并停止监视之前那个数据的Observable产生的Observable，并开始监视当前这一个。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_5.png" alt=""></p>
<h2 id="Scan"><a href="#Scan" class="headerlink" title="Scan"></a>Scan</h2><p>RxJava的<code>scan()</code>函数可以看做是一个累加器函数。<code>scan()</code>函数对原始Observable发射的每一项数据都应用一个函数，它将函数的结果填充回可观测序列，等待和下一次发射的数据一起使用。</p>
<p>作为一个通用的例子，给出一个累加器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</div><div class="line">        .scan((sum,item) -&gt; sum + item)</div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                Log.d(<span class="string">"RXJAVA"</span>, <span class="string">"Sequence completed."</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                Log.e(<span class="string">"RXJAVA"</span>, <span class="string">"Something went south!"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer item)</span> </span>&#123;</div><div class="line">                Log.d(<span class="string">"RXJAVA"</span>, <span class="string">"item is: "</span> + item);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure></p>
<p>我们得到的结果是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">RXJAVA: item is: <span class="number">1</span></div><div class="line">RXJAVA: item is: <span class="number">3</span></div><div class="line">RXJAVA: item is: <span class="number">6</span></div><div class="line">RXJAVA: item is: <span class="number">10</span></div><div class="line">RXJAVA: item is: <span class="number">15</span></div><div class="line">RXJAVA: Sequence completed.</div></pre></td></tr></table></figure></p>
<p>我们也可以创建一个新版本的<code>loadList()</code>函数用来比较每个安装应用的名字从而创建一个名字长度递增的列表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable.from(apps)</div><div class="line">            .scan((appInfo,appInfo2) -&gt; &#123;</div><div class="line">                <span class="keyword">if</span>(appInfo.getName().length &gt; appInfo2.getName().length())&#123;</div><div class="line">                    <span class="keyword">return</span> appInfo;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">return</span> appInfo2;</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .distinct()</div><div class="line">            .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                    Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">                    mAddedApps.add(appInfo); </div><div class="line">                    mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_6.png" width="240"></p>
<p>有一个<code>scan()</code>函数的变体，它用初始值作为第一个发射的值，方法特征就像：<code>scan(R,Func2)</code>，就像下图中的例子这样：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_7.png"></p>
<h2 id="GroupBy"><a href="#GroupBy" class="headerlink" title="GroupBy"></a>GroupBy</h2><p>拿第一个例子开始，我们安装的应用程序列表按照字母表的顺序排序。然而，如果现在我们想按照最近更新日期来排序我们的App时该怎么办？RxJava提供了一个有用的函数从列表中按照指定的规则：<code>groupBy()</code>来分组元素。下图中的例子展示了<code>groupBy()</code>如何将发射的值根据他们的形状来进行分组。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_8.png" alt=""></p>
<p>这个函数将源Observable变换成一个发射Observables的新的Observable。它们中的每一个新的Observable都发射一组指定的数据。</p>
<p>为了创建一个分组了的已安装应用列表，我们在<code>loadList()</code>函数中引入了一个新的元素：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Observable&lt;GroupedObservable&lt;String,AppInfo&gt;&gt; groupedItems = Observable.from(apps)</div><div class="line">    .groupBy(<span class="keyword">new</span> Func1&lt;AppInfo,String&gt;()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(AppInfo appInfo)</span></span>&#123;</div><div class="line">            SimpleDateFormat formatter = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"MM/yyyy"</span>);</div><div class="line">            <span class="keyword">return</span> formatter.format(<span class="keyword">new</span> Date(appInfo.getLastUpdateTime()));</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<p>现在我们创建了一个新的Observable，<code>groupedItems</code>，将会发射一个带有<code>GroupedObservable</code>的序列。<code>GroupedObservable</code>是一个特殊的Observable，它源自一个分组的key。在这个例子中，key就是<code>String</code>，代表的意思是<code>Month/Year</code>格式化的最近更新日期。</p>
<p>这一点，我们已经创建了几个发射<code>AppInfo</code>数据的Observable，用来填充我们的列表。我们想保留字母排序和分组排序。我们将创建一个新的Observable将所有的联系起来，像通常一样然后订阅它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Observable.concat(groupedItems)</div><div class="line">    .subscribe(<span class="keyword">new</span> Observable&lt;AppInfo&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">            mAddedApps.add(appInfo); </div><div class="line">            mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>,appInfo);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>我们的<code>loadList()</code>函数完成了，结果是：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_9.png" width="240"></p>
<h2 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h2><p>RxJava中的<code>buffer()</code>函数将源Observable变换一个新的Observable，这个新的Observable每次发射一组列表值而不是一个一个发射。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_10.png" alt=""></p>
<p>上图中展示了<code>buffer()</code>如何将<code>count</code>作为一个参数来指定有多少数据项被包在发射的列表中。实际上，<code>buffer()</code>函数有几种变体。其中有一个时允许你指定一个<code>skip</code>值：此后每当收到skip项数据，用count项数据就填充缓存。如下图所示：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_11.png" alt=""></p>
<p><code>buffer()</code>带一个<code>timespan</code>的参数，会创建一个每隔timespan时间段就会发射一个列表的Observable。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_12.png" alt=""></p>
<h2 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h2><p>RxJava的<code>window()</code>函数和<code>buffer()</code>很像，但是它发射的时Observable而不是列表。下图展示了<code>window()</code>如何缓存3个数据项并把它们作为一个新的Observable发射出去。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_13.png" alt=""></p>
<p>这些Observables中的每一个都发射原始Observable数据的一个子集，数量由<code>count</code>指定,最后发射一个<code>onCompleted()</code>结束。正如<code>buffer()</code>一样,<code>window()</code>也有一个<code>skip</code>变体,如下图所示：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_14.png" alt=""></p>
<h2 id="Cast"><a href="#Cast" class="headerlink" title="Cast"></a>Cast</h2><p>RxJava的<code>cast()</code>函数是本章中最后一个操作符。它是<code>map()</code>操作符的特殊版本。它将源Observable中的每一项数据都转换为新的类型，把它变成了不同的<code>Class</code>。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter5_15.png" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这一章中，我们学习了RxJava时如何控制和转换可观测序列。用我们现在所学的知识，我们可以创建、过滤、转换我们所想要的任何种类的可观测序列。</p>
<p>下一章，我们将学习如何组合Observable，合并它们，连接它们，再或者打包它们。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/chap5/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/chap5/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/chap6/" title="RxJava开发精要6 - 组合Observables" itemprop="url">RxJava开发精要6 - 组合Observables</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文出自《RxJava Essentials》</li>
<li>原文作者 : <a href="https://www.packtpub.com/books/info/authors/ivan-morgillo" target="_blank" rel="external">Ivan Morgillo</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/yuxingxin" target="_blank" rel="external">yuxingxin</a> </li>
<li>项目地址 : <a href="https://github.com/yuxingxin/RxJava-Essentials-CN" target="_blank" rel="external">RxJava-Essentials-CN</a></li>
</ul>
<p>上一章中，我们学到如何转换可观测序列。我们也看到了<code>map()</code>,<code>scan()</code>,<code>groupBY()</code>,以及更多有用的函数的实际例子，它们帮助我们操作Observable来创建我们想要的Observable。</p>
<p>本章中，我们将研究组合函数并学习如何同时处理多个Observables来创建我们想要的Observable。</p>
<h2 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h2><p>在异步的世界经常会创建这样的场景，我们有多个来源但是只想有一个结果：多输入，单输出。RxJava的<code>merge()</code>方法将帮助你把两个甚至更多的Observables合并到他们发射的数据里。下图给出了把两个序列合并在一个最终发射的Observable。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_1.png" alt=""></p>
<p>正如你看到的那样，发射的数据被交叉合并到一个Observable里面。注意如果你同步的合并Observable，它们将连接在一起并且不会交叉。</p>
<p>像通常一样，我们用我们的App和已安装的App列表来创建了一个“真实世界”的例子。我们还需要第二个Observable。我们可以创建一个单独的应用列表然后逆序。当然没有实际的意义，只是为了这个例子。第二个列表，我们的<code>loadList()</code>函数像下面这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    List reversedApps = Lists.reverse(apps);</div><div class="line">    Observable&lt;AppInfo&gt; observableApps =Observable.from(apps);</div><div class="line">    Observable&lt;AppInfo&gt; observableReversedApps =Observable.from(reversedApps);</div><div class="line">    Observable&lt;AppInfo&gt; mergedObserbable = Observable.merge(observableApps,observableReversedApps);</div><div class="line">    </div><div class="line">    mergedObserbable.subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"One of the two Observable threw an error!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfoappInfo)</span> </span>&#123;</div><div class="line">            mAddedApps.add(appInfo);</div><div class="line">            mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>, appInfo);</div><div class="line">        &#125; </div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们创建了Observable和observableApps数据以及新的observableReversedApps逆序列表。使用<code>Observable.merge()</code>，我们可以创建新的<code>ObservableMergedObservable</code>在单个可观测序列中发射源Observables发出的所有数据。</p>
<p>正如你能看到的,每个方法签名都是一样的，因此我们的观察者无需在意任何不同就可以复用代码。结果如下：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_2.png" width="240"></p>
<p>注意错误时的toast消息，你可以认为每个Observable抛出的错误将会打断合并。如果你需要避免这种情况，RxJava提供了<code>mergeDelayError()</code>，它能从一个Observable中继续发射数据即便是其中有一个抛出了错误。当所有的Observables都完成时，<code>mergeDelayError()</code>将会发射<code>onError()</code>，如下图所示：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_3.png" alt=""></p>
<h2 id="ZIP"><a href="#ZIP" class="headerlink" title="ZIP"></a>ZIP</h2><p>我们在处理多源时可能会带来这样一种场景：多从个Observables接收数据，处理它们，然后将它们合并成一个新的可观测序列来使用。RxJava有一个特殊的方法可以完成：<code>zip()</code>合并两个或者多个Observables发射出的数据项，根据指定的函数<code>Func*</code>变换它们，并发射一个新值。下图展示了<code>zip()</code>方法如何处理发射的“numbers”和“letters”然后将它们合并一个新的数据项：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_4.png" alt=""></p>
<p>对于“真实世界”的例子来说，我们将使用已安装的应用列表和一个新的动态的Observable来让例子变得有点有趣味。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Observable&lt;Long&gt; tictoc = Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>
<p><code>tictoc</code>Observable变量使用<code>interval()</code>函数每秒生成一个Long类型的数据：简单且高效，正如之前所说的，我们需要一个<code>Func</code>对象。因为它需要传两个参数，所以是<code>Func2</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> AppInfo <span class="title">updateTitle</span><span class="params">(AppInfoappInfo, Long time)</span> </span>&#123;</div><div class="line">    appInfo.setName(time + <span class="string">" "</span> + appInfo.getName());</div><div class="line">    <span class="keyword">return</span> appInfo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们的<code>loadList()</code>函数变成这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable&lt;AppInfo&gt; observableApp = Observable.from(apps);</div><div class="line">    </div><div class="line">    Observable&lt;Long&gt; tictoc = Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS);</div><div class="line">    </div><div class="line">    Observable.zip(observableApp, tictoc,</div><div class="line">    (AppInfo appInfo, Long time) -&gt; updateTitle(appInfo, time))</div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfoappInfo)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mSwipeRefreshLayout.isRefreshing()) &#123;</div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            &#125; </div><div class="line">            mAddedApps.add(appInfo);</div><div class="line">            <span class="keyword">int</span> position = mAddedApps.size() - <span class="number">1</span>;</div><div class="line">            mAdapter.addApplication(position, appInfo);</div><div class="line">            mRecyclerView.smoothScrollToPosition(position);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你看到的那样，<code>zip()</code>函数有三个参数：两个Observables和一个<code>Func2</code>。</p>
<p>仔细一看会发现<code>observeOn()</code>函数。它将在下一章中讲解：现在我们可以小试一下。</p>
<p>结果如下：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_5.png" width="320"></p>
<h2 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h2><p>前面两个方法，<code>zip()</code>和<code>merge()</code>方法作用在发射数据的范畴内，在决定如何操作值之前有些场景我们需要考虑时间的。RxJava的<code>join()</code>函数基于时间窗口将两个Observables发射的数据结合在一起。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_6.png" alt=""></p>
<p>为了正确的理解上一张图，我们解释下<code>join()</code>需要的参数：</p>
<ul>
<li>第二个Observable和源Observable结合。</li>
<li><code>Func1</code>参数：在指定的由时间窗口定义时间间隔内，源Observable发射的数据和从第二个Observable发射的数据相互配合返回的Observable。</li>
<li><code>Func1</code>参数：在指定的由时间窗口定义时间间隔内，第二个Observable发射的数据和从源Observable发射的数据相互配合返回的Observable。</li>
<li><code>Func2</code>参数：定义已发射的数据如何与新发射的数据项相结合。</li>
<li>如下练习的例子，我们可以修改<code>loadList()</code>函数像下面这样：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    </div><div class="line">    Observable&lt;AppInfo&gt; appsSequence =</div><div class="line">    Observable.interval(<span class="number">1000</span>, TimeUnit.MILLISECONDS)</div><div class="line">                .map(position -&gt; &#123;</div><div class="line">                    <span class="keyword">return</span> apps.get(position.intValue());</div><div class="line">                &#125;);</div><div class="line">                </div><div class="line">    Observable&lt;Long&gt; tictoc = Observable.interval(<span class="number">1000</span>,TimeUnit.MILLISECONDS);</div><div class="line">    </div><div class="line">    appsSequence.join(</div><div class="line">        tictoc, </div><div class="line">        appInfo -&gt; Observable.timer(<span class="number">2</span>,TimeUnit.SECONDS),</div><div class="line">        time -&gt; Observable.timer(<span class="number">0</span>, TimeUnit.SECONDS),</div><div class="line">        <span class="keyword">this</span>::updateTitle)</div><div class="line">        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">        .take(<span class="number">10</span>)</div><div class="line">        .subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>); </div><div class="line">                Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfoappInfo)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mSwipeRefreshLayout.isRefreshing()) &#123;</div><div class="line">                    mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125; </div><div class="line">                mAddedApps.add(appInfo);</div><div class="line">                <span class="keyword">int</span> position = mAddedApps.size() - <span class="number">1</span>;</div><div class="line">                mAdapter.addApplication(position, appInfo);</div><div class="line">                mRecyclerView.smoothScrollToPosition(position);</div><div class="line">            &#125; </div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>我们有一个新的对象<code>appsSequence</code>，它是一个每秒从我们已安装的app列表发射app数据的可观测序列。<code>tictoc</code>这个Observable数据每秒只发射一个新的<code>Long</code>型整数。为了合并它们，我们需要指定两个<code>Func1</code>变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">appInfo -&gt; Observable.timer(<span class="number">2</span>, TimeUnit.SECONDS)</div><div class="line"></div><div class="line">time -&gt; Observable.timer(<span class="number">0</span>, TimeUnit.SECONDS)</div></pre></td></tr></table></figure>
<p>上面描述了两个时间窗口。下面一行描述我们如何使用<code>Func2</code>将两个发射的数据结合在一起。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>::updateTitle</div></pre></td></tr></table></figure></p>
<p>结果如下：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_7.png" width="240"></p>
<p>它看起来有点乱，但是注意app的名字和我们指定的时间窗口，我们可以看到：一旦第二个数据发射了我们就会将它与源数据结合，但我们用同一个源数据有2秒钟。这就是为什么标题重复数字累加的原因。</p>
<p>值得一提的是，为了简单起见，也有一个<code>join()</code>操作符作用于字符串然后简单的和发射的字符串连接成最终的字符串。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_8.png" alt=""></p>
<h2 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h2><p>RxJava的<code>combineLatest()</code>函数有点像<code>zip()</code>函数的特殊形式。正如我们已经学习的，<code>zip()</code>作用于最近未打包的两个Observables。相反，<code>combineLatest()</code>作用于最近发射的数据项：如果<code>Observable1</code>发射了A并且<code>Observable2</code>发射了B和C，<code>combineLatest()</code>将会分组处理AB和AC，如下图所示：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_9.png" alt=""></p>
<p><code>combineLatest()</code>函数接受二到九个Observable作为参数，如果有需要的话或者单个Observables列表作为参数。</p>
<p>从之前的例子中把<code>loadList()</code>函数借用过来，我们可以修改一下来用于<code>combineLatest()</code>实现“真实世界”这个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    Observable&lt;AppInfo&gt; appsSequence = Observable.interval(<span class="number">1000</span>, TimeUnit.MILLISECONDS)</div><div class="line">              .map(position -&gt;apps.get(position.intValue()));</div><div class="line">    Observable&lt;Long&gt; tictoc = Observable.interval(<span class="number">1500</span>, TimeUnit.MILLISECONDS);</div><div class="line">    Observable.combineLatest(appsSequence, tictoc,</div><div class="line">               <span class="keyword">this</span>::updateTitle)</div><div class="line">       .observeOn(AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfoappInfo)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mSwipeRefreshLayout.isRefreshing()) &#123;</div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            &#125; </div><div class="line">            mAddedApps.add(appInfo);</div><div class="line">            <span class="keyword">int</span> position = mAddedApps.size() - <span class="number">1</span>;</div><div class="line">            mAdapter.addApplication(position, appInfo);</div><div class="line">            mRecyclerView.smoothScrollToPosition(position);</div><div class="line">        &#125; </div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这我们使用了两个Observables：一个是每秒钟从我们已安装的应用列表发射一个App数据，第二个是每隔1.5秒发射一个<code>Long</code>型整数。我们将他们结合起来并执行<code>updateTitle()</code>函数，结果如下：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_10.png" width="240"></p>
<p>正如你看到的，由于不同的时间间隔，<code>AppInfo</code>对象如我们所预料的那样有时候会重复。</p>
<h2 id="And-Then和When"><a href="#And-Then和When" class="headerlink" title="And,Then和When"></a>And,Then和When</h2><p>在将来还有一些<code>zip()</code>满足不了的场景。如复杂的架构，或者是仅仅为了个人爱好，你可以使用And/Then/When解决方案。它们在RxJava的joins包下，使用Pattern和Plan作为中介，将发射的数据集合并到一起。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_11.png" alt=""></p>
<p>我们的<code>loadList()</code>函数将会被修改从这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line"></div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line"></div><div class="line">    Observable&lt;AppInfo&gt; observableApp = Observable.from(apps);</div><div class="line">    </div><div class="line">    Observable&lt;Long&gt; tictoc = Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS);</div><div class="line">    </div><div class="line">    Pattern2&lt;AppInfo, Long&gt; pattern = JoinObservable.from(observableApp).and(tictoc); </div><div class="line">    </div><div class="line">    Plan0&lt;AppInfo&gt; plan = pattern.then(<span class="keyword">this</span>::updateTitle);</div><div class="line">    </div><div class="line">    JoinObservable</div><div class="line">        .when(plan)</div><div class="line">        .toObservable()</div><div class="line">        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123;</div><div class="line">        </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>); </div><div class="line">                Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfoappInfo)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mSwipeRefreshLayout.isRefreshing()) &#123; </div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                &#125; </div><div class="line">                mAddedApps.add(appInfo);</div><div class="line">                <span class="keyword">int</span> position = mAddedApps.size() - <span class="number">1</span>;</div><div class="line">                mAdapter.addApplication(position, appInfo); mRecyclerView.smoothScrollToPosition(position);</div><div class="line">            &#125; </div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>和通常一样，我们有两个发射的序列，<code>observableApp</code>，发射我们安装的应用列表数据，<code>tictoc</code>每秒发射一个<code>Long</code>型整数。现在我们用<code>and()</code>连接源Observable和第二个Observable。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JoinObservable.from(observableApp).and(tictoc);</div></pre></td></tr></table></figure>
<p>这里创建一个<code>pattern</code>对象，使用这个对象我们可以创建一个<code>Plan</code>对象:”我们有两个发射数据的Observables,<code>then()</code>是做什么的？”<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pattern.then(<span class="keyword">this</span>::updateTitle);</div></pre></td></tr></table></figure></p>
<p>现在我们有了一个<code>Plan</code>对象并且当plan发生时我们可以决定接下来发生的事情。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.when(plan).toObservable()</div></pre></td></tr></table></figure></p>
<p>这时候，我们可以订阅新的Observable，正如我们总是做的那样。</p>
<h2 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h2><p>有这样一个复杂的场景就是在一个<code>subscribe-unsubscribe</code>的序列里我们能够从一个Observable自动取消订阅来订阅一个新的Observable。</p>
<p>RxJava的<code>switch()</code>，正如定义的，将一个发射多个Observables的Observable转换成另一个单独的Observable，后者发射那些Observables最近发射的数据项。</p>
<p>给出一个发射多个Observables序列的源Observable，<code>switch()</code>订阅到源Observable然后开始发射由第一个发射的Observable发射的一样的数据。当源Observable发射一个新的Observable时，<code>switch()</code>立即取消订阅前一个发射数据的Observable（因此打断了从它那里发射的数据流）然后订阅一个新的Observable，并开始发射它的数据。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_12.png" alt=""></p>
<h2 id="StartWith"><a href="#StartWith" class="headerlink" title="StartWith"></a>StartWith</h2><p>我们已经学到如何连接多个Observables并追加指定的值到一个发射序列里。RxJava的<code>startWith()</code>是<code>concat()</code>的对应部分。正如<code>concat()</code>向发射数据的Observable追加数据那样，在Observable开始发射他们的数据之前， <code>startWith()</code>通过传递一个参数来先发射一个数据序列。  </p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter6_13.png" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这章中，我们学习了如何将两个或者更多个Observable结合来创建一个新的可观测序列。我们将能够<code>merge</code> Observable，<code>join</code> Observables ，<code>zip</code> Observables 并在几种情况下把他们结合在一起。</p>
<p>下一章，我们将介绍调度器，它将很容易的帮助我们创建主线程以及提高我们应用程序的性能。我们也将学习如何正确的执行长任务或者I/O任务来获得更好的性能。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/chap6/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/chap6/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/chap7/" title="RxJava开发精要7 - Schedulers-解决Android主线程问题" itemprop="url">RxJava开发精要7 - Schedulers-解决Android主线程问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>原文出自《RxJava Essentials》</p>
<ul>
<li>原文作者 : <a href="https://www.packtpub.com/books/info/authors/ivan-morgillo" target="_blank" rel="external">Ivan Morgillo</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/yuxingxin" target="_blank" rel="external">yuxingxin</a> </li>
<li>项目地址 : <a href="https://github.com/yuxingxin/RxJava-Essentials-CN" target="_blank" rel="external">RxJava-Essentials-CN</a></li>
</ul>
<p>前面一章是最后一章关于RxJava的Observable的创建和操作的章节。我们学习到了如何将两个或更多的Observables合并在一起，<code>join</code>它们，<code>zip</code>它们，<code>merge</code>它们以及如何创建一个新的Observable来满足我们特殊的需求。</p>
<p>本章中，我们提升标准看看如何使用RxJava的调度器来处理多线程和并发编程的问题。我们将学习到如何以响应式的方式创建网络操作，内存访问，以及耗时任务。</p>
<h2 id="StrictMode"><a href="#StrictMode" class="headerlink" title="StrictMode"></a>StrictMode</h2><p>为了获得更多出现在代码中的关于公共问题的信息，我们激活了<code>StrictMode</code>模式。</p>
<p><code>StrictMode</code>帮助我们侦测敏感的活动，如我们无意的在主线程执行磁盘访问或者网络调用。正如你所知道的，在主线程执行繁重的或者长时的任务是不可取的。因为Android应用的主线程时UI线程，它被用来处理和UI相关的操作：这也是获得更平滑的动画体验和响应式App的唯一方法。</p>
<p>为了在我们的App中激活<code>StrictMode</code>，我们只需要在<code>MainActivity</code>中添加几行代码，即<code>onCreate()</code>方法中这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123; </div><div class="line">    <span class="keyword">super</span>.onCreate();</div><div class="line">    <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</div><div class="line">        StrictMode.setThreadPolicy(<span class="keyword">new</span> StrictMode.ThreadPolicy.Builder().detectAll().penaltyLog().build()); </div><div class="line">        StrictMode.setVmPolicy(<span class="keyword">new</span> StrictMode.VmPolicy.Builder().detectAll().penaltyLog().build());</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们并不想它总是激活着，因此我们只在debug构建时使用。这种配置将报告每一种关于主线程用法的违规做法，并且这些做法都可能与内存泄露有关：<code>Activities</code>、<code>BroadcastReceivers</code>、<code>Sqlite</code>等对象。</p>
<p>选择了<code>penaltyLog()</code>，当违规做法发生时，<code>StrictMode</code>将会在logcat打印一条信息。</p>
<h2 id="避免阻塞I-O的操作"><a href="#避免阻塞I-O的操作" class="headerlink" title="避免阻塞I/O的操作"></a>避免阻塞I/O的操作</h2><p>阻塞I/O的操作将使App能够进行下一步操作前会强制使其等待结果的返回。在UI线程上执行一个阻塞操作将强制使UI卡住，这将直接产生不好的用户体验。</p>
<p>我们激活<code>StrictMode</code>后，我们开始收到了关于我们的App错误操作磁盘I/O的不友好信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">D/StrictMode  StrictMode policy violation; ~duration=<span class="number">998</span> ms: android.os.StrictMode$StrictModeDiskReadViolation: policy=<span class="number">31</span> violation=<span class="number">2</span></div><div class="line">at android.os.StrictMode$AndroidBlockGuardPolicy.onReadFromDisk (StrictMode.java:<span class="number">1135</span>)</div><div class="line">at libcore.io.BlockGuardOs.open(BlockGuardOs.java:<span class="number">106</span>) at libcore.io.IoBridge.open(IoBridge.java:<span class="number">393</span>)</div><div class="line">at java.io.FileOutputStream.&lt;init&gt;(FileOutputStream.java:<span class="number">88</span>) </div><div class="line">at android.app.ContextImpl.openFileOutput(ContextImpl.java:<span class="number">918</span>) </div><div class="line">at android.content.ContextWrapper.openFileOutput(ContextWrapper. java:<span class="number">185</span>)</div><div class="line">at com.packtpub.apps.rxjava_essentials.Utils.storeBitmap (Utils.java:<span class="number">30</span>)</div></pre></td></tr></table></figure>
<p>上一条信息告诉我们<code>Utils.storeBitmap()</code>函数执行完耗时998ms：在UI线程上近1秒的不必要的工作和App上近1秒不必要的迟钝。这是因为我们以阻塞的方式访问磁盘。我们的<code>storeBitmap()</code>函数包含了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FileOutputStream fOut = context.openFileOutput(filename, Context.MODE_PRIVATE);</div></pre></td></tr></table></figure></p>
<p>它直接访问智能手机的固态存储然后就慢了。我们该如何提高访问速度呢？<code>storeBitmap()</code>函数保存了已安装App的图标。他返回了<code>void</code>，因此在执行下一个操作前我们毫无理由去等待直到它完成。我们可以启动它并让它执行在不同的线程。Android中这些年线程管理的变化产生了App诡异的行为。我们可以使用<code>AsyncTask</code>，但是我们要避免掉入前几章里的<code>onPrehttps://github.com/yuxingxin/RxJava-Essentials-CN/raw/master. onPosthttps://github.com/yuxingxin/RxJava-Essentials-CN/raw/master.doInBackGround</code>地狱。我们将使用RxJava的方式;万岁的调度器！</p>
<h2 id="Schedulers"><a href="#Schedulers" class="headerlink" title="Schedulers"></a>Schedulers</h2><p>调度器以一种最简单的方式将多线程用在你的Apps的中。它们时RxJava重要的一部分并能很好地与Observables协同工作。它们无需处理实现、同步、线程、平台限制、平台变化而可以提供一种灵活的方式来创建并发程序。</p>
<p>RxJava提供了5种调度器：</p>
<ul>
<li><code>.io()</code></li>
<li><code>.computation()</code></li>
<li><code>.immediate()</code></li>
<li><code>.newThread()</code></li>
<li><code>.trampoline()</code></li>
</ul>
<p>让我们一个一个的来看下它们：</p>
<h2 id="Schedulers-io"><a href="#Schedulers-io" class="headerlink" title="Schedulers.io()"></a>Schedulers.io()</h2><p>这个调度器时用于I/O操作。它基于根据需要，增长或缩减来自适应的线程池。我们将使用它来修复我们之前看到的<code>StrictMode</code>违规做法。由于它专用于I/O操作，所以并不是RxJava的默认方法；正确的使用它是由开发者决定的。</p>
<p>重点需要注意的是线程池是无限制的，大量的I/O调度操作将创建许多个线程并占用内存。一如既往的是，我们需要在性能和简捷两者之间找到一个有效的平衡点。</p>
<h2 id="Schedulers-computation"><a href="#Schedulers-computation" class="headerlink" title="Schedulers.computation()"></a>Schedulers.computation()</h2><p>这个是计算工作默认的调度器，它与I/O操作无关。它也是许多RxJava方法的默认调度器：<code>buffer()</code>,<code>debounce()</code>,<code>delay()</code>,<code>interval()</code>,<code>sample()</code>,<code>skip()</code>。</p>
<h2 id="Schedulers-immediate"><a href="#Schedulers-immediate" class="headerlink" title="Schedulers.immediate()"></a>Schedulers.immediate()</h2><p>这个调度器允许你立即在当前线程执行你指定的工作。它是<code>timeout()</code>,<code>timeInterval()</code>,以及<code>timestamp()</code>方法默认的调度器。</p>
<h2 id="Schedulers-newThread"><a href="#Schedulers-newThread" class="headerlink" title="Schedulers.newThread()"></a>Schedulers.newThread()</h2><p>这个调度器正如它所看起来的那样：它为指定任务启动一个新的线程。</p>
<h2 id="Schedulers-trampoline"><a href="#Schedulers-trampoline" class="headerlink" title="Schedulers.trampoline()"></a>Schedulers.trampoline()</h2><p>当我们想在当前线程执行一个任务时，并不是立即，我们可以用<code>.trampoline()</code>将它入队。这个调度器将会处理它的队列并且按序运行队列中每一个任务。它是<code>repeat()</code>和<code>retry()</code>方法默认的调度器。</p>
<h2 id="非阻塞I-O操作"><a href="#非阻塞I-O操作" class="headerlink" title="非阻塞I/O操作"></a>非阻塞I/O操作</h2><p>现在我们知道如何在一个指定I/O调度器上来调度一个任务，我们可以修改<code>storeBitmap()</code>函数并再次检查<code>StrictMode</code>的不合规做法。为了这个例子，我们可以在新的<code>blockingStoreBitmap()</code>函数中重排代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">blockingStoreBitmap</span><span class="params">(Context context, Bitmap bitmap, String filename)</span> </span>&#123;</div><div class="line">    FileOutputStream fOut = <span class="keyword">null</span>; </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        fOut = context.openFileOutput(filename, Context.MODE_PRIVATE);</div><div class="line">        bitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, fOut); </div><div class="line">        fOut.flush();</div><div class="line">        fOut.close();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123; </div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (fOut != <span class="keyword">null</span>) &#123;</div><div class="line">                fOut.close();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e); </div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们可以使用<code>Schedulers.io()</code>创建非阻塞的版本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">storeBitmap</span><span class="params">(Context context, Bitmap bitmap, String filename)</span> </span>&#123;</div><div class="line">    Schedulers.io().createWorker().schedule(() -&gt; &#123;</div><div class="line">        blockingStoreBitmap(context, bitmap, filename);</div><div class="line">    &#125;); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每次我们调用<code>storeBitmap()</code>，RxJava处理创建所有它需要从I / O线程池一个特定的I/ O线程执行我们的任务。所有要执行的操作都避免在UI线程执行并且我们的App比之前要快上1秒：logcat上也不再有<code>StrictMode</code>的不合规做法。</p>
<p>下图展示了我们在<code>storeBitmap()</code>场景看到的两种方法的不同：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter7_1.png" alt=""></p>
<h2 id="SubscribeOn-and-ObserveOn"><a href="#SubscribeOn-and-ObserveOn" class="headerlink" title="SubscribeOn and ObserveOn"></a>SubscribeOn and ObserveOn</h2><p>我们学到了如何在一个调度器上运行一个任务。但是我们如何利用它来和Observables一起工作呢？RxJava提供了<code>subscribeOn()</code>方法来用于每个Observable对象。<code>subscribeOn()</code>方法用<code>Scheduler</code>来作为参数并在这个Scheduler上执行Observable调用。</p>
<p>在“真实世界”这个例子中，我们调整<code>loadList()</code>函数。首先，我们需要一个新的<code>getApps()</code>方法来检索已安装的应用列表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;AppInfo&gt; <span class="title">getApps</span><span class="params">()</span> </span>&#123; </div><div class="line">    <span class="keyword">return</span> Observable.create(subscriber -&gt; &#123;</div><div class="line">        List&lt;AppInfo&gt; apps = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        SharedPreferences sharedPref = getActivity().getPreferences(Context.MODE_PRIVATE);</div><div class="line">        Type appInfoType = <span class="keyword">new</span> TypeToken&lt;List&lt;AppInfo&gt;&gt;()&#123;&#125;.getType();</div><div class="line">        String serializedApps = sharedPref.getString(<span class="string">"APPS"</span>, <span class="string">""</span>);</div><div class="line">        <span class="keyword">if</span> (!<span class="string">""</span>.equals(serializedApps)) &#123;</div><div class="line">            apps = <span class="keyword">new</span> Gson().fromJson(serializedApps,appInfoType); </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (AppInfo app : apps) &#123;</div><div class="line">            subscriber.onNext(app);</div><div class="line">        &#125;</div><div class="line">        subscriber.onCompleted(); </div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>getApps()</code>方法返回一个<code>AppInfo</code>的Observable。它先从Android的SharePreferences读取到已安装的应用程序列表。反序列化，并一个接一个的发射AppInfo数据。使用新的方法来检索列表，<code>loadList()</code>函数改成下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">()</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    getApps().subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123;</div><div class="line">            mAddedApps.add(appInfo);</div><div class="line">                mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>, appInfo);</div><div class="line">        &#125; </div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们运行代码，<code>StrictMode</code>将会报告一个不合规操作，这是因为<code>SharePreferences</code>会减慢I/O操作。我们所需要做的是指定<code>getApps()</code>需要在调度器上执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">getApps().subscribeOn(Schedulers.io())</div><div class="line">        .subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123; [https:<span class="comment">//github.com/yuxingxin/RxJava-Essentials-CN/raw/master.]</span></div></pre></td></tr></table></figure>
<p><code>Schedulers.io()</code>将会去掉<code>StrictMode</code>的不合规操作，但是我们的App现在崩溃了是因为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">at rx.internal.schedulers.ScheduledAction.run(ScheduledAction.jav a:<span class="number">58</span>)</div><div class="line">at java.util.concurrent.Executors$RunnableAdapter.call(Executors. java:<span class="number">422</span>)</div><div class="line">at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">237</span>) </div><div class="line">at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutu reTask.access$<span class="number">201</span>(ScheduledThreadPoolExecutor.java:<span class="number">152</span>)</div><div class="line">at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutu reTask.run(ScheduledThreadPoolExecutor.java:<span class="number">265</span>)</div><div class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolEx ecutor.java:<span class="number">1112</span>)</div><div class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolE xecutor.java:<span class="number">587</span>)</div><div class="line">at java.lang.Thread.run(Thread.java:<span class="number">841</span>) Caused by:</div><div class="line">    android.view.ViewRootImpl$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views.</div></pre></td></tr></table></figure></p>
<p>Only the original thread that created a view hierarchy can touch its views.</p>
<p>我们再次回到Android的世界。这条信息简单的告诉我们我们试图在一个非UI线程来修改UI操作。意思是我们需要在I/O调度器上执行我们的代码。因此我们需要和I/O调度器一起执行代码，但是当结果返回时我们需要在UI线程上操作。RxJava让你能够订阅一个指定的调度器并观察它。我们只需在<code>loadList()</code>函数添加几行代码，那么每一项就都准备好了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">getApps()</div><div class="line">.onBackpressureBuffer()</div><div class="line">.subscribeOn(Schedulers.io())</div><div class="line">.observeOn(AndroidSchedulers.mainThread())</div><div class="line">.subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123; [https:<span class="comment">//github.com/yuxingxin/RxJava-Essentials-CN/raw/master.]</span></div></pre></td></tr></table></figure>
<p><code>observeOn()</code>方法将会在指定的调度器上返回结果：如例子中的UI线程。<code>onBackpressureBuffer()</code>方法将告诉Observable发射的数据如果比观察者消费的数据要更快的话，它必须把它们存储在缓存中并提供一个合适的时间给它们。做完这些工作之后，如果我们运行App，就会出现已安装的程序列表：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter7_2.png" width="240"></p>
<h2 id="处理耗时的任务"><a href="#处理耗时的任务" class="headerlink" title="处理耗时的任务"></a>处理耗时的任务</h2><p>我们已经知道如何处理缓慢的I/O操作。让我们看一个与I/O无关的耗时的任务。例如，我们修改<code>loadList()</code>函数并创建一个新的<code>slow</code>函数发射我们已安装的app数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;AppInfo&gt; <span class="title">getObservableApps</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable .create(subscriber -&gt; &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">double</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000000</span>; i++) &#123;</div><div class="line">            <span class="keyword">double</span> y = i * i;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (AppInfo app : apps) &#123;</div><div class="line">            subscriber.onNext(app);</div><div class="line">        &#125;</div><div class="line">        subscriber.onCompleted(); </div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正如你看到的，这个函数执行了一些毫无意义的计算，只是针对这个例子消耗时间，然后从<code>List&lt;AppInfo&gt;</code>对象中发射我们的<code>AppInfo</code>数据，现在，我们重排<code>loadList()</code>函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadList</span><span class="params">(List&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">    mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">    getObservableApps(apps)</div><div class="line">        .subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                Toast.makeText(getActivity(), <span class="string">"Here is the list!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                Toast.makeText(getActivity(), <span class="string">"Something went wrong!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">                mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(AppInfo appInfo)</span> </span>&#123; </div><div class="line">                mAddedApps.add(appInfo);  </div><div class="line">                mAdapter.addApplication(mAddedApps.size() - <span class="number">1</span>, appInfo);</div><div class="line">            &#125; </div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们运行这段代码，当我们点击<code>Navigation Drawer</code>菜单项时App将会卡住一会，然后你能看到下图中半关闭的菜单:</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter7_3.png" width="240"></p>
<p>如果我们不够走运的话，我们可以看到下图中经典的ANR信息框：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter7_4.png" width="240"></p>
<p>可以确定的是，我们将会看到下面在logcat中不愉快的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">I/Choreographer  Skipped <span class="number">598</span> frames! The application may be doing too much work on its main thread.</div></pre></td></tr></table></figure>
<p>这条信息比较清楚，Android在告诉我们用户体验非常差的原因是我们用不必要的工作量阻塞了UI线程。但是我们已经知道了如何处理它：我们有调度器！我们只须添加几行代码到我们的Observable链中就能去掉加载慢和<code>Choreographer</code>信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">getObservableApps(apps)</div><div class="line">    .onBackpressureBuffer()</div><div class="line">    .subscribeOn(Schedulers.computation())</div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(<span class="keyword">new</span> Observer&lt;AppInfo&gt;() &#123; [https:<span class="comment">//github.com/yuxingxin/RxJava-Essentials-CN/raw/master.]</span></div></pre></td></tr></table></figure>
<p>用这几行代码，我们将可以快速关掉<code>Navigation Drawer</code>,一个漂亮的进度条，一个工作在独立的线程缓慢执行的计算任务，并在主线程返回结果让我们更新已安装的应用列表。</p>
<h2 id="执行网络任务"><a href="#执行网络任务" class="headerlink" title="执行网络任务"></a>执行网络任务</h2><p>网络在今天是99%的移动应用的一部分：我们总是连接远端服务器来检索我们App需要的信息。</p>
<p>作为网络访问的第一个方法，我们将创建下面这样一个场景:</p>
<ul>
<li>加载一个进度条。</li>
<li>用一个按钮开始文件下载。</li>
<li>下载过程中更新进度条。</li>
<li>下载完后开始视频播放。</li>
</ul>
<p>我们的用户界面非常简单，我们只需要一个有趣的进度条和一个下载按钮。</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter7_5.png" width="240"></p>
<p>首先，我们创建<code>mDownloadProgress</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PublishSubject&lt;Integer&gt;mDownloadProgress = PublishSubject.create();</div></pre></td></tr></table></figure>
<p>这个主题我们用来管理进度的更新，它和<code>download</code>函数协同工作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">downloadFile</span><span class="params">(String source, String destination)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    InputStream input = <span class="keyword">null</span>; </div><div class="line">    OutputStream output = <span class="keyword">null</span>; </div><div class="line">    HttpURLConnection connection = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        URL url = <span class="keyword">new</span> URL(source);</div><div class="line">        connection = (HttpURLConnection) url.openConnection(); </div><div class="line">        connection.connect();</div><div class="line">        <span class="keyword">if</span> (connection.getResponseCode() != HttpURLConnection.HTTP_OK) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> fileLength = connection.getContentLength();</div><div class="line">        input = connection.getInputStream();</div><div class="line">        output = <span class="keyword">new</span> FileOutputStream(destination);</div><div class="line">        <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</div><div class="line">        <span class="keyword">long</span> total = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> count;</div><div class="line">        <span class="keyword">while</span> ((count = input.read(data)) != -<span class="number">1</span>) &#123;</div><div class="line">            total += count;</div><div class="line">            <span class="keyword">if</span> (fileLength &gt;<span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">int</span> percentage = (<span class="keyword">int</span>) (total * <span class="number">100</span> / fileLength);</div><div class="line">                mDownloadProgress.onNext(percentage);</div><div class="line">            &#125;</div><div class="line">            output.write(data, <span class="number">0</span>, count); </div><div class="line">        &#125;</div><div class="line">        mDownloadProgress.onCompleted(); </div><div class="line">        result = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123; </div><div class="line">        mDownloadProgress.onError(e);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123; </div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (output != <span class="keyword">null</span>) &#123; </div><div class="line">                output.close();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (input != <span class="keyword">null</span>) &#123;</div><div class="line">                input.close(); </div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;    </div><div class="line">            mDownloadProgress.onError(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</div><div class="line">            connection.disconnect();</div><div class="line">            mDownloadProgress.onCompleted();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的这段代码将会触发<code>NetworkOnMainThreadException</code>异常。我们可以创建RxJava版本的函数进入我们挚爱的响应式世界来解决这个问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;Boolean&gt; <span class="title">obserbableDownload</span><span class="params">(String source, String destination)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.create(subscriber -&gt; &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">boolean</span> result = downloadFile(source, destination); </div><div class="line">            <span class="keyword">if</span> (result) &#123;</div><div class="line">                subscriber.onNext(<span class="keyword">true</span>);</div><div class="line">                subscriber.onCompleted(); </div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                subscriber.onError(<span class="keyword">new</span> Throwable(<span class="string">"Download failed."</span>));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; </div><div class="line">            subscriber.onError(e);</div><div class="line">        &#125; </div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们需要触发下载操作，点击下载按钮:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@OnClick</span>(R.id.button_download)</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">download</span><span class="params">()</span> </span>&#123;</div><div class="line">    mButton.setText(getString(R.string.downloading));</div><div class="line">    mButton.setClickable(<span class="keyword">false</span>);</div><div class="line">    mDownloadProgress.distinct()</div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(<span class="keyword">new</span> Observer&lt;Integer&gt;() &#123;</div><div class="line">    </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;  </div><div class="line">            App.L.debug(<span class="string">"Completed"</span>);</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            App.L.error(e.toString()); </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer progress)</span> </span>&#123;</div><div class="line">            mArcProgress.setProgress(progress);</div><div class="line">        &#125; </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    String destination = <span class="string">"sdcardsoftboy.avi"</span>;</div><div class="line">    obserbableDownload(<span class="string">"http://archive.blender.org/fileadmin/movies/softboy.avi"</span>, destination)</div><div class="line">        .subscribeOn(Schedulers.io())</div><div class="line">        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(success -&gt; &#123;</div><div class="line">            resetDownloadButton();</div><div class="line">            Intent intent = <span class="keyword">new</span> Intent(android.content.Intent.ACTION_VIEW);</div><div class="line">            File file = <span class="keyword">new</span> File(destination);</div><div class="line">            intent.setDataAndType(Uri.fromFile(file),<span class="string">"video/avi"</span>);</div><div class="line">            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); </div><div class="line">            startActivity(intent);</div><div class="line">        &#125;, error -&gt; &#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"Something went south"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            resetDownloadButton();</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们使用Butter Knife的注解<code>@OnClick</code>来绑定按钮的方法并更新按钮信息和点击状态：我们不想让用户点击多次从而触发多次下载事件。</p>
<p>然后，我们创建一个subscription来观察下载进度并相应的更新进度条。很明显，我们我们观测主线程是因为进度条是UI元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">obserbableDownload(<span class="string">"http://archive.blender.org/fileadmin/movies/softboy.avi"</span>, <span class="string">"sdcardsoftboy.avi"</span>;)</div></pre></td></tr></table></figure>
<p>这是一个下载Observable。网络调用是一个I/O任务和我们预料的那样使用I/O调度器。当下载完成时，我们在<code>onNext()</code>启动视频播放器，并且播放器将会在目的URL找到下载的文件.。</p>
<p>下图展示了下载进度和视频播放器对话框：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter7_6.png" width="240"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这一章中，我们学习了如何简单的将多线程应用在我们的App中。RxJava为此提供了极其有用的工具：调度器。调度器来自不同的指定优化场景并且我们也不避免了<code>StrictMode</code>不合法操作以及阻塞I/O函数。我们现在可以用简单的，响应式的并在整个App中保持一致的方式来访问内存和网络。</p>
<p>下一章中，我们将会提高风险并创建一个<code>真实世界</code>App，并使用Square公司开源的REST API库Retrofit从不同的远程资源获取数据来创建一个复杂的material design UI。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/chap7/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/chap7/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/chap8/" title="RxJava开发精要8 - 与REST无缝结合-RxJava和Retrofit" itemprop="url">RxJava开发精要8 - 与REST无缝结合-RxJava和Retrofit</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>原文出自《RxJava Essentials》</p>
<ul>
<li>原文作者 : <a href="https://www.packtpub.com/books/info/authors/ivan-morgillo" target="_blank" rel="external">Ivan Morgillo</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>转载声明: 本译文已授权<a href="http://toutiao.io/download" target="_blank" rel="external">开发者头条</a>享有独家转载权，未经允许，不得转载!</li>
<li>译者 : <a href="https://github.com/yuxingxin" target="_blank" rel="external">yuxingxin</a> </li>
<li>项目地址 : <a href="https://github.com/yuxingxin/RxJava-Essentials-CN" target="_blank" rel="external">RxJava-Essentials-CN</a></li>
</ul>
<p>在上一章中，我们学习了如何使用调度器在不同于UI线程的线程上操作。我们学习了如何高效的运行I/O任务而不用阻塞UI以及如何运行耗时的计算任务而不耗损应用性能。在最后一章中，我们将创建一个最终版的<code>真实世界</code>的例子，用Retrofit映射到远程的API,异步的查询数据，从而不费力的创造一个丰富的UI。</p>
<h2 id="项目目标"><a href="#项目目标" class="headerlink" title="项目目标"></a>项目目标</h2><p>我们将在已存在的例子中创建一个新的<code>Activity</code>。这个<code>Activity</code>将会使用StackExchange API从stackoverflow检索最活跃的10位用户。使用这个信息，App将会展示一个用户的头像，姓名，名望数以及住址列表。对于每一位用户，app将会使用其居住城市和OpenWeatherMap API 来检索当地的天气预报，并展示一个小的天气图标。基于从StackOverflow检索的信息，app对列表的每一位用户将会提供一个<code>onClick</code>事件，它将会打开他们在个人信息中指定的个人网站或者打开Stack Overflow的个人主页。</p>
<h2 id="Retrofit"><a href="#Retrofit" class="headerlink" title="Retrofit"></a>Retrofit</h2><p>Retrofit是Square公司专为Android和Java设计的一个类型安全的REST客户端。它帮助你很容易的和任何REST API交互，它完美的集成R小Java：所有的JSON响应对象都被映射成原始的Java对象，并且所有的网络调用都基于Rxjava Observable这些对象。</p>
<p>使用API文档，我们可以定义我们从服务器接收的JSON响应数据。为了很容易的将JSON响应数据映射为我们的Java代码，我们将使用jsonschema2pojo(<a href="http://www.jsonschema2pojo.org)，这个灵活的服务将会生成我们所需要映射JSON响应数据的所有Java类。" target="_blank" rel="external">http://www.jsonschema2pojo.org)，这个灵活的服务将会生成我们所需要映射JSON响应数据的所有Java类。</a></p>
<p>当我们把所有的Java model准备好后，我们就可以开始建立Retrofit。Retrofi使用标准的Java接口来映射API路由。例如例子中，我们将使用来自API的一个路由，下面是我们Retrofit的接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StackExchangeService</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"2.2users?order=desc&amp;sort=reputation&amp;site=stackoverflow"</span>)</div><div class="line">    Observable&lt;User sResponse&gt; getMostPopularSOusers(<span class="meta">@Query</span>(<span class="string">"pagesize"</span>) <span class="keyword">int</span> howmany);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>interface</code>接口只包含一个方法，即<code>getMostPopularSOusers</code>。这个方法用整型<code>howmany</code>作为一个参数并返回<code>UserResponse</code>的Observable。</p>
<p>当我们有了<code>interface</code>，我们可以创建<code>RestAdapter</code>类，为了更清楚的组织我们的代码，我们创建一个<code>SeApiManager</code>函数提供一种更适当的方式来和StackExchange API交互。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeApiManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StackExchangeService mStackExchangeService;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeApiManager</span><span class="params">()</span> </span>&#123;</div><div class="line">        RestAdapter restAdapter = <span class="keyword">new</span> RestAdapter.Builder()</div><div class="line">            .setEndpoint(<span class="string">"https://api.stackexchange.com"</span>)</div><div class="line">            .setLogLevel(RestAdapter.LogLevel.BASIC)</div><div class="line">            .build();</div><div class="line">        mStackExchangeService = restAdapter.create(StackExchangeService.class);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> Observable&lt;List&lt;User&gt;&gt; getMostPopularSOusers(<span class="keyword">int</span> howmany) &#123;</div><div class="line">    <span class="keyword">return</span> mStackExchangeService</div><div class="line">    .getMostPopularSOusers(howmany)</div><div class="line">    .map(UsersResponse::getUsers)</div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .observeOn(AndroidSchedulers.mainThread());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为了简化例子，我们不再将这个类设计为它本应该设计为的单例。使用依赖注入解决方案，如Dagger2将会使代码质量更高。</p>
<p>创建<code>RestAdapter</code>类，我们为API客户端建立了几个重要的点。这个例子中，我们设置<code>endpoint</code>和<code>log level</code>。由于这个例子URL只是硬编码，使用外部资源来像这样存储数据很重要。避免在代码中硬编码字符串是一个好的实践。</p>
<p>Retrofit把<code>RestAdapter</code>类和我们的API接口绑定在一起后就创建结束。它返回给我们一个对象用来查询API。我们可以选择直接暴露这个对象，或者以某种方式封装依次来限制访问它。在这个例子中，我们封装它并只暴露<code>getMostPopularSOusers</code>方法。这个方法执行查询，让Retrofit解析JSON响应数据。获得用户列表，并返回给订阅者。正如你看到的，使用Retrofit、RxJava和Retrolambda，我们几乎没有模板代码：它非常紧凑并且可读性也高。</p>
<p>现在，我们已经有一个API管理者来暴露一个响应式的方法，它从远程API获取到数据并给I/O调度器，解析映射最后提供给我们的消费者一个简洁的用户列表。</p>
<h2 id="App架构"><a href="#App架构" class="headerlink" title="App架构"></a>App架构</h2><p>我们不使用任何MVC，MVP，或者MVVM模式。因为那不是这本书的目的，因此我们的<code>Activity</code>类将包含我们需要创建和展示用户列表的所有逻辑。</p>
<h2 id="创建Activity类"><a href="#创建Activity类" class="headerlink" title="创建Activity类"></a>创建Activity类</h2><p>我们将在<code>onCreate()</code>方法里创建<code>SwipeRefreshLayout</code>和<code>RecyclerView</code>；我们有一个<code>refreshList()</code>方法来处理用户列表的获取和展示，<code>showRefreshing()</code>方法来管理进度条和<code>RecyclerView</code>的显示。</p>
<p>我们的<code>refreshList()</code>函数看起来如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshList</span><span class="params">()</span> </span>&#123; </div><div class="line">    showRefresh(<span class="keyword">true</span>);</div><div class="line">    mSeApiManager.getMostPopularSOusers(<span class="number">10</span>)</div><div class="line">        .subscribe(users -&gt; &#123; </div><div class="line">            showRefresh(<span class="keyword">false</span>);</div><div class="line">            mAdapter.updateUsers(users);</div><div class="line">        &#125;, error -&gt; &#123; </div><div class="line">            App.L.error(error.toString());</div><div class="line">            showRefresh(<span class="keyword">false</span>);</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们显示了进度条，从StackExchange API 管理器观测用户列表。一旦获取到列表数据，我们开始展示它并更新<code>Adapter</code>的内容并让<code>RecyclerView</code>显示为可见。</p>
<h2 id="创建RecyclerView-Adapter"><a href="#创建RecyclerView-Adapter" class="headerlink" title="创建RecyclerView Adapter"></a>创建RecyclerView Adapter</h2><p>我们从REST API获取到数据后，我们需要把它绑定View上，并用一个适配器填充列表。我们的RecyclerView适配器是标准的。它继承于<code>RecyclerView.Adapter</code>并指定它自己的<code>ViewHolder</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">    <span class="meta">@InjectView</span>(R.id.name) TextView name;</div><div class="line">    <span class="meta">@InjectView</span>(R.id.city) TextView city;</div><div class="line">    <span class="meta">@InjectView</span>(R.id.reputation) TextView reputation;</div><div class="line">    <span class="meta">@InjectView</span>(R.id.user_image) ImageView user_image;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewHolder</span><span class="params">(View view)</span> </span>&#123; </div><div class="line">        <span class="keyword">super</span>(view);</div><div class="line">        ButterKnife.inject(<span class="keyword">this</span>, view); </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们一旦收到来自API管理器的数据，我们可以设置界面上所有的标签：<code>name</code>,<code>city</code>和<code>reputation</code>。</p>
<p>为了展示用户的头像，我们将使用Sergey Tarasevich (<a href="https://github.com/nostra13/Android-Universal-" target="_blank" rel="external">https://github.com/nostra13/Android-Universal-</a> ImageLoader)写的<code>Universal Image Loader</code>。UIL是非常有名的并且被测试出很好用的图片管理库。我们也可以使用Square公司的Picasso，Glide或者Facebook公司的Fresco。这只是根据你自己的爱好。重要的是无须重复造轮子：库能够方便开发者的生活并让他们更快速实现目标。</p>
<p>在我们的适配器中，我们可以这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(SoAdapter.ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    User user = mUsers.get(position);</div><div class="line">    holder.setUser(user); </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>ViewHolder</code>，我们可以这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(User user)</span> </span>&#123; </div><div class="line">    name.setText(user.getDisplayName());</div><div class="line">    city.setText(user.getLocation());</div><div class="line">    reputation.setText(String.valueOf(user.getReputation()));</div><div class="line">    </div><div class="line">    ImageLoader.getInstance().displayImage(user.getProfileImage(), user_image);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此时，我们可以允许代码获得一个用户列表，正如下图所示：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter8_1.png" width="240"></p>
<h3 id="检索天气预报"><a href="#检索天气预报" class="headerlink" title="检索天气预报"></a>检索天气预报</h3><p>我们加大难度，将当地城市的天气加入列表中。<strong>OpenWeatherMap</strong>是一个灵活的web service公共API，我们可以查询检索许多有用的预报信息。</p>
<p>和往常一样，我们将使用Retrofit映射到API然后通过RxJava来访问它。至于StackExchange API，我们将创建<code>interface</code>，<code>RestAdapter</code>和一个灵活的管理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OpenWeatherMapService</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"data2.5/weather"</span>)</div><div class="line">    <span class="function">Observable&lt;WeatherResponse&gt; <span class="title">getForecastByCity</span><span class="params">(@Query(<span class="string">"q"</span>)</span> String city)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法用城市名字作为参数提供当地的预报信息。我们像下面这样将接口和<code>RestAdapter</code>类绑定在一起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RestAdapter restAdapter = <span class="keyword">new</span> RestAdapter.Builder()</div><div class="line">        .setEndpoint(<span class="string">"http://api.openweathermap.org"</span>)</div><div class="line">        .setLogLevel(RestAdapter.LogLevel.BASIC)</div><div class="line">        .build();</div><div class="line">mOpenWeatherMapService = restAdapter.create(OpenWeatherMapService.class);</div></pre></td></tr></table></figure>
<p>像以前一样，我们只需设置API端口和log级别：我们只需要立马做的两件事情。</p>
<p><code>OpenWeatherMapApiManager</code>类将提供下面的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Observable&lt;WeatherResponse&gt; <span class="title">getForecastByCity</span><span class="params">(String city)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mOpenWeatherMapService.getForecastByCity(city)</div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .observeOn(AndroidSchedulers.mainThread());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在，我们有了用户列表，我们可以根据城市名来查询OpenWeatherMap来接收天气预报信息。下一步是修改我们的<code>ViewHolder</code>类来为每位用户检索和使用天气预报信息从而根据状态来展示天气图标。</p>
<p>我们使用这些工具方法先验证用户主页信息并获得一个合法的城市名字：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCityValid</span><span class="params">(String location)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> separatorPosition = getSeparatorPosition(location);</div><div class="line">    <span class="keyword">return</span> !<span class="string">""</span>.equals(location) &amp;&amp; separatorPosition &gt; -<span class="number">1</span>; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getSeparatorPosition</span><span class="params">(String location)</span> </span>&#123; </div><div class="line">    <span class="keyword">int</span> separatorPosition = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (location != <span class="keyword">null</span>) &#123;</div><div class="line">        separatorPosition = location.indexOf(<span class="string">","</span>); </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> separatorPosition; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getCity</span><span class="params">(String location, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (location != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> location.substring(<span class="number">0</span>, position); </div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>; </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>借助一个有效的城市名，我们可以用下面命令来获得我们所需要天气的所有数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">OpenWeatherMapApiManager.getInstance().getForecastByCity(city)</div></pre></td></tr></table></figure>
<p>用天气响应的结果，我们可以获得天气图标的URL：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">getWeatherIconUrl(weatherResponse);</div></pre></td></tr></table></figure>
<p>用图标URL，我们可以检索到图标本身：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;Bitmap&gt; <span class="title">loadBitmap</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.create(subscriber -&gt; &#123;</div><div class="line">        ImageLoader.getInstance().displayImage(url,city_image, <span class="keyword">new</span> ImageLoadingListener() &#123; </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadingStarted</span><span class="params">(String imageUri, View view)</span> </span>&#123;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadingFailed</span><span class="params">(String imageUri, View view, FailReason failReason)</span> </span>&#123;</div><div class="line">                subscriber.onError(failReason.getCause()); </div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadingComplete</span><span class="params">(String imageUri, View view, Bitmap loadedImage)</span> </span>&#123;</div><div class="line">                subscriber.onNext(loadedImage);</div><div class="line">                subscriber.onCompleted(); </div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadingCancelled</span><span class="params">(String imageUri, View view)</span> </span>&#123;</div><div class="line">                subscriber.onError(<span class="keyword">new</span> Throwable(<span class="string">"Image loading cancelled"</span>));</div><div class="line">            &#125;</div><div class="line">         &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个<code>loadBitmap()</code>返回的Observable可以链接前面一个，并且最后我们可以为这个任务返回一个单独的Observable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (isCityValid(location)) &#123;</div><div class="line">    String city = getCity(location, separatorPosition);</div><div class="line">    OpenWeatherMapApiManager.getInstance().getForecastByCity(city)</div><div class="line">        .filter(response -&gt; response != <span class="keyword">null</span>)</div><div class="line">        .filter(response -&gt; response.getWeather().size() &gt; <span class="number">0</span>)</div><div class="line">        .flatMap(response -&gt; &#123;</div><div class="line">            String url = getWeatherIconUrl(response);</div><div class="line">            <span class="keyword">return</span> loadBitmap(url);</div><div class="line">        &#125;)</div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(<span class="keyword">new</span> Observer&lt;Bitmap&gt;() &#123;</div><div class="line">    </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            App.L.error(e.toString()); </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Bitmap icon)</span> </span>&#123;</div><div class="line">            city_image.setImageBitmap(icon); </div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行代码，我们可以在下面列表中为每个用户获得新的天气图标：</p>
<p><img src="https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master/images/chapter8_2.png" width="240"></p>
<h3 id="打开网站"><a href="#打开网站" class="headerlink" title="打开网站"></a>打开网站</h3><p>使用用户主页包含的信息，我们将会创建一个<code>onClick</code>监听器来导航到用户web页面，如果有，或者是Stack Overflow个人主页。</p>
<p>为了实现它，我们简单实现<code>Activity</code>类的接口，用来在适配器触发Android的<code>onClick</code>事件。</p>
<p>我们的<code>Adapter ViewHolder</code>指定这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OpenProfileListener</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(String url)</span></span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Activity</code>实现它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[https:<span class="comment">//github.com/yuxingxin/RxJava-Essentials-CN/raw/master.] implements SoAdapter.ViewHolder.OpenProfileListener &#123; [https://github.com/yuxingxin/RxJava-Essentials-CN/raw/master.]</span></div><div class="line">    mAdapter.setOpenProfileListener(<span class="keyword">this</span>); </div><div class="line">[https:<span class="comment">//github.com/yuxingxin/RxJava-Essentials-CN/raw/master.]</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">    Intent i = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW);</div><div class="line">    i.setData(Uri.parse(url)); </div><div class="line">    startActivity(i);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Activity</code>收到URL并用外部Android浏览器打开它。我们的<code>ViewHolder</code>负责在用户列表的每个卡片上创建<code>OnClickListener</code>并检查我们是打开Stack Overflow用户主页还是外部个人站：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mView.setOnClickListener(view -&gt; &#123; </div><div class="line">    <span class="keyword">if</span> (mProfileListener != <span class="keyword">null</span>) &#123;</div><div class="line">        String url = user.getWebsiteUrl();</div><div class="line">        <span class="keyword">if</span> (url != <span class="keyword">null</span> &amp;&amp; !url.equals(<span class="string">""</span>) &amp;&amp; !url.contains(<span class="string">"search"</span>)) &#123;</div><div class="line">            mProfileListener.open(url); </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mProfileListener.open(user.getLink()); </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">)&#125;；</div></pre></td></tr></table></figure>
<p>一旦我们点击了，我们将直接重定向到预期的网站。在Android上，我们可以用RxAndroid的一种特殊形式（ViewObservable）以更加响应式的方式实现同样的结果。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ViewObservable.clicks(mView)</div><div class="line">    .subscribe(onClickEvent -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (mProfileListener != <span class="keyword">null</span>) &#123;</div><div class="line">        String url = user.getWebsiteUrl();</div><div class="line">        <span class="keyword">if</span> (url != <span class="keyword">null</span> &amp;&amp; !url.equals(<span class="string">""</span>) &amp;&amp; !url.contains(<span class="string">"search"</span>)) &#123; </div><div class="line">            mProfileListener.open(url);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mProfileListener.open(user.getLink());</div><div class="line">        &#125; </div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>上面两块代码片段是等价的，你可以选择你最喜欢的那一种方式。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们的旅程结束了。你已经准备好将你的Java应用带到一个新的代码质量水平。你可以享受一个新的编码模式并用更流畅的思维方式接触你的日常编码生活。RxJava提供这样一种机会来以面向时间的方式考虑数据：所有事情都是持续可变的，数据在更新，事件在触发，然后你可以创建基于这些事件响应的，灵活的，运行流畅的App。</p>
<p>刚开始切换到RxJava看起来难并且耗时，但是我们经历了如何用响应式的方式有效地处理日常问题。现在你可以把你的旧代码迁移到RxJava上:给这些同步<code>getters</code>一种新的响应式生活。</p>
<p>RxJava是一个正在不断发展和扩大的世界。还有许多方法我们还没有去探索。有些方法甚至还没有，因为RxJava，你可以创建你自己的操作符并把他们推得更远。</p>
<p>Android是一个好玩的地方，但是它也有局限性。作为一个Android开发者，你可以用RxJava和RxAndroid克服它们中许多部分。我们用AndroidScheduler只简单提了下RxAndroid,除了在最后一章，你了解了<code>ViewObservable</code>。RxAndroid给了你许多：例如，<code>WidgetObservable</code>，<code>LifecycleObservable</code>。现在要更多的推动它取决于你了。</p>
<p>记得可观测序列就像一条河：它们是流动的。你可以“过滤”一条河，你可以“转换”一条河，你可以将两条河合并成一个，然后它仍旧时流动的。最后，它将成为你想要的那条河。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/chap8/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/chap8/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/简化Android的UI开发/" title="简化Android的UI开发" itemprop="url">简化Android的UI开发</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://zserge.com/blog/android-mvx.html" target="_blank" rel="external">android ui development made easy</a></li>
</ul>
<p>如果你觉得这篇文章太长，而且还没有往下阅读的话，我可以给你简要的介绍文章要讲的内容：我使用纯 Java 通过数据绑定的方式提供了一种</p>
<p>Android UI 开发的代码往往是支离破碎的，写出来的代码通常都是大量的模板化代码，而且没有结构可言。下面是一些问题（纯属个人见解）：</p>
<ul>
<li><p>Android UI 开发很少符合 MVC 模式（或者是 M-V-其他任何东西）</p>
</li>
<li><p>XML文件通常包含了很多重复的代码，在代码复用方面比较糟糕</p>
</li>
<li><p>XMLS 非常脆弱，这使得你在写 XML 文件时，即使输入了 TextVeiw ，在编译过程中编译器也不会警告你，但在 App 运行时又会抛出 InflateException 异常</p>
</li>
<li><p>缺少对 styles 的支持，缺少对变量的支持，不支持宏和计算结果（例如 10dp + 2px)</p>
</li>
<li><p>没有数据绑定，这使得你必须自己把所有的 findViewById 和 setOn…Listener 写好</p>
</li>
<li><p>你可以通过 Java 实现你的布局，但是写出来的代码有如天书</p>
</li>
</ul>
<h2 id="使用-mithril-js-建立用户接口"><a href="#使用-mithril-js-建立用户接口" class="headerlink" title="使用 mithril.js 建立用户接口"></a>使用 mithril.js 建立用户接口</h2><p>在 Web 开发中，开发者们很快就意识到在没有 MVx 的情况下开发复杂的应用会很吃力，这使得他们意识到 jQuery 中存在的问题，并开发了 Backbone，Knockout，Angular，Ember…等等，来提高他们的开发效率</p>
<p>但在 Android 中，我们还在通过那一点点函数毫无章法可言地设置 View 的属性，就像在 jQuery 里一样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'.myview'</span>).text(<span class="string">'Hello'</span>);</div><div class="line">$(<span class="string">'.myview'</span>).on(<span class="string">'click'</span>, function() &#123;</div><div class="line"></div><div class="line">&#125;);</div><div class="line"></div><div class="line">myView.setText(<span class="string">"Hello"</span>);</div><div class="line">myView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123; ...&#125;);</div></pre></td></tr></table></figure>
<p>我们在一个目录下定义了我们的 Layout ，又在另一个目录中使用它们，然后在 UI 开发的代码里改变<br>，这样并不好。</p>
<p>React.js 对 Web 开发有一点点影响：他们以树状关系的自定义对象创建了一个虚拟的 DOM 概念，并以此展示实际的 HTML 布局。虚拟树创建和切换的时间都很短，所以当实际的 DOM 需要被渲染，两棵虚拟树（前一棵和新的那棵）将进行对比，只有不匹配的部分才会被渲染。</p>
<p>Mithril.js 是一个精悍、短小的框架，使用它能使 React.js 的实现更整洁。在 Mithril 中，除了纯 JavaScript，你几乎能摆脱一切，同时，它还能让你在写布局的时候感受到图灵完备的语言所具备的力量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> m(<span class="string">'div'</span>,</div><div class="line">         m(<span class="string">'p'</span>, someText),</div><div class="line">         m(<span class="string">'ul'</span>,</div><div class="line">           items.map((item) =&gt; m(<span class="string">'li'</span>, item))),</div><div class="line">         m(<span class="string">'button'</span>, &#123;onclick: myClickHandler&#125;));</div></pre></td></tr></table></figure>
<p>因此，你能用循环生成许多 View，你能用判断语句改变布局中的某个部分，最后你能绑定数据和设置事件监听器。</p>
<p>那这个方法能在 Android 中被使用吗？</p>
<h2 id="虚拟布局"><a href="#虚拟布局" class="headerlink" title="虚拟布局"></a>虚拟布局</h2><p>虚拟布局（使用类似 Web 中虚拟 DOM 的概念）是树状的自定义Java对象集合，被用于展示实际的 Android 布局。虽然 App 的数据改变多少次，树就会被构建多少次，但布局改变的内容应该仅仅是前后不一致的部分（当前的布局和改变前布局）。</p>
<p>我们的框架只导入一个静态类，所以所有类中的静态方法都不需要类名前缀就能被使用（例如我们只需要使用 v()，而不是 Render.v()），这是语言特性带来的好处。下面是我们如何创建布局的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">v(LinearLayout.class,</div><div class="line">    orientation(LinearLayout.VERTICAL),</div><div class="line">    v(TextView.class,</div><div class="line">        text(someText)),</div><div class="line">    v(Button.class,</div><div class="line">        text(<span class="string">"Click me"</span>),</div><div class="line">        onClick(someClickHandler)));</div></pre></td></tr></table></figure>
<p>第一个 v() 方法返回了一个虚拟布局，每一次调用后它会返回当前应用状态的实际展示（不是实际的 View！）</p>
<p>当一些文字变量被改变 - 虚拟树会获得一个被用于下次渲染的发生了改变的结点值，然后调用 setText()改变相应的 TextView 实例。但是其余的布局不会发生任何变化。</p>
<p>一棵虚拟布局树在理想情况下应该只是一个类，我们就把它叫作结点吧。但是结点主要有两种类型：View 结点（TextView.class等等）和属性设置结点，例如text（someText)</p>
<p>那这就意味着结点应该任意包含一个 View 类和一个方法去改变 View 的属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AttributeSetter</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(View v)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</div><div class="line">    List&lt;Node&gt; attrs = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</div><div class="line">    Class&lt;? extends View&gt; viewClass; <span class="comment">// for view nodes</span></div><div class="line">    AttributeSetter setter;          <span class="comment">// for attribute setter nodes</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(Class&lt;? extends View&gt; c)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.viewClass = c;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(AttributeSetter setter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setter = setter;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们需要定义类在产生虚拟布局的时候实际能干的事情了，那就让我们来调用可渲染类吧。一个可渲染类可以是一个 Activity，或者一个自定义的 ViewGroup，或者 Fragment 也凑合。每一个可渲染类都应该有一个用于返回虚拟布局的方法，此外，如果这个方法指定了它将要作用于实际布局中的哪个 View 会更好。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Renderable</span> </span>&#123;</div><div class="line">    <span class="function">Node <span class="title">view</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">ViewGroup <span class="title">getRootView</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于 v() 方法的第一个参数是 View 子类的泛型，所以你不用担心类型安全问题。剩下的参数都是结点类型，所以我们只需要把它们添加到 list 中，无视掉空结点的话效果会更好一些。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Node <span class="title">v</span><span class="params">(<span class="keyword">final</span> Class&lt;? extends View&gt; cls, <span class="keyword">final</span> Node ...nodes)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node(cls) ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here’s an example of the text() attribute setter (the real code is a bit different, but it could have been implemented like this):</p>
<p>下面是一个 text() 属性的设置方法（实际代码会有点不一样，但是也能像下面这样实现）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Node <span class="title">text</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node(<span class="keyword">new</span> AttributeSetter() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            ((TextView) v).setText(s);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其他类似的工具方法也能用于改变线性布局的方向，View 的大小、页边距、间距，总之所有 View 的参数都能被改变。</p>
<h2 id="那么，我们要怎么去渲染呢？"><a href="#那么，我们要怎么去渲染呢？" class="headerlink" title="那么，我们要怎么去渲染呢？"></a>那么，我们要怎么去渲染呢？</h2><p>现在我们需要一个“渲染者”。这是一个能够根据类名创建 View ，使用 AttributeSetters修改对应的参数并且递归地添加子 View的方法。（同样的，下面的代码也是被简化的，实际的代码会有些不一样，主要差别在于当结点没有被改变的时候，我们应该如何避免视图的渲染）<br>​<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> View <span class="title">inflateNode</span><span class="params">(Context c, Node node, ViewGroup parent)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (node.viewClass == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Root is not a view!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Exception handling skipped here to make the code look shorter</span></div><div class="line">    View v = (View) node.viewClass.getConstructor(Context.class).newInstance(c);</div><div class="line">    parent.addView(v);</div><div class="line">    <span class="keyword">for</span> (Node subnode: node.attrs) &#123;</div><div class="line">        <span class="keyword">if</span> (subnode.setter != <span class="keyword">null</span>) &#123;</div><div class="line">            subnode.setter.set(v);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            View subview = inflateNode(c, subnode, (ViewGroup) v);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在我们真的可以摆脱 XMLS，并以一种简洁的方式通过 Java 进行布局了。</p>
<p>布局结点不应该直接地被使用，而应该是通过 render(Renderer r) 和 render()被使用。前者用于重渲染某一个 View，后者用于重渲染所有被展示的 View。Renderer 通过一个弱哈希表存储，使得在 View 被移除或者 Activity 被销毁的同时 - 他们的渲染者也不会再被使用。</p>
<h2 id="什么时候去渲染呢？"><a href="#什么时候去渲染呢？" class="headerlink" title="什么时候去渲染呢？"></a>什么时候去渲染呢？</h2><p>这个框架的核心在于 自动进行重渲染，使得 UI 总能展示当前的虚拟布局状态。这就意味着 render() 应该在某个特定的节点被调用。</p>
<p>我参考 Mithril 的方法，把每一个 On…Listener 和 调用 render 的方法捆绑在每一次 UI 的交互中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Node <span class="title">onClick</span><span class="params">(<span class="keyword">final</span> View.OnClickListener listener)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node(<span class="keyword">new</span> AttributeSetter() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            v.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                    listener.onClick(v);</div><div class="line">                    <span class="comment">// After the click was processed - some data may have been changed</span></div><div class="line">                    <span class="comment">// so we try to re-render the UI</span></div><div class="line">                    render();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我觉得这样做是有道理的，因为大多数 Android 应用的数据都是在发生用户交互的时候被改变的。如果你的数据是因为其他因素被改变的 - 那就只能手动通过 render()渲染了。</p>
<h2 id="总的来说"><a href="#总的来说" class="headerlink" title="总的来说"></a>总的来说</h2><p>这个方法虽然简单，却非常有用：</p>
<ul>
<li><p>你能用类似 XML 的方式定义你的布局结构（通过嵌套调用 v() 方法）</p>
</li>
<li><p>你能用一种清晰易懂的方式绑定数据和监听器</p>
</li>
<li><p>布局都是类型安全的，并且你的编译器会自动完成相应的工作</p>
</li>
<li><p>没有运行时产生的开销，没有使用反射机制，没有自动生成代码</p>
</li>
<li><p>你能在任何地方使用 Java（变量，语句，宏）生成布局</p>
</li>
<li><p>你能用自定义 View 和自定义的属性设置方法</p>
</li>
<li><p>因为你的所有 UI 数据都被保存在属性中，因此你能轻易的保存它们</p>
</li>
<li><p>使用纯 Java 实现这些逻辑需要的代码还不到 250 行！</p>
</li>
</ul>
<p>以上证明了这个方法是可行的。现在我在想，如果有人想要用这个方法开发一个功能齐全的库呢？</p>
<p>设计一个好的“区分”算法会是其中的关键。基本地，它应该能判断一个结点是否被添加/移除/修改，而文件就在于属性节点。简单的数据类型我们只要调用 equals() 去比较两个值就可以了，但是监听器呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">v(SomeView.java,</div><div class="line">    onClick(v =&gt; ...));</div></pre></td></tr></table></figure>
<p>这样做的话每一次虚拟树被创建，都会创建一个对应的监听器对象。那怎么去比较它们？还是永远都不更新监听器，只更新发生了改变的监听器类？或者使用某种事件分发机制分发事件，而不是使用监听器？</p>
<p>另一件需要被注意的是：我不想自己把所有属性设置方法写好。这里有一个更好的方法，也就是 Kotlin 他们在 koan 库中做的那样。</p>
<p>我现在在研究怎么从 android.jar 的类中自动生成设置器，以使得这个项目更有用。</p>
<p>不管怎样，现在的代码我都放在 <a href="https://github.com/zserge/anvil" target="_blank" rel="external">Github</a> 上了，有 MIT 的许可。欢迎大家来评论和 PR！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/简化Android的UI开发/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/简化Android的UI开发/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/Android 6.0中Intent的解析/" title="Android 6.0中Intent的解析" itemprop="url">Android 6.0中Intent的解析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/google-developer-experts/intent-resolving-in-android-m-c17d39d27048#.n23z2g14e" target="_blank" rel="external">Intent Resolving in Android M</a></li>
</ul>
<p>注意了！在Android 6.0中，“隐式Intent”的解析不能像之前版本那样正常工作了。这很有可能导致你的app不能正常使用。</p>
<p>现在让我解释一下这个意料之中的问题以及为什么它不能正常使用：<br>最近，我正在开发一个小的开源项目，叫做“Open Link With”。希望不久后它能够在应用市场上架。</p>
<p>我的这个app能够让你在其他app之间随意切换。当你给我分享一个链接的时候，我基本上可以根据这个链接查询出所有可以处理这个链接的Activity。然后我会模拟一个系统对话框让你切换app。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*rW8I8aCpJ2q8fnfKH_51_g.gif" alt="从已经打开的youtube的web页面切换到youtube应用"></p>
<p>我一直都是使用下面的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">List&lt;ResolveInfo&gt; infos = packageManager</div><div class="line">        .queryIntentActivities(intent, MATCH_DEFAULT_ONLY);</div></pre></td></tr></table></figure>
<p>这段代码几乎所有Android开发者都比较熟悉，并且我也相信大部分app都有用到这段代码。</p>
<p>我的手机里有两个浏览器。“一个URL是Google+ 的Intent”期望得到一个具有3个ResolveInfo对象的列表（Google+应用以及两个浏览器）。</p>
<p>好吧，并不是这样！</p>
<p>欢迎来到Android 6.0！</p>
<p>Android 6.0引进了应用关联。系统主要通过你的web页面来认证，并且自动使用你的app来打开这些URL，而不会向你做任何请求。或者你可以到系统设置，选择“应用程序”，然后点击一个应用，再点击“默认打开方式”，然后设置“用这个应用打开”，就可以每次都使用这个应用打开。</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*MVZbYKhwu-7qnyGAFWuNsw.png" alt="Android 6.0的应用默认设置页面"></p>
<p>在这种情况下，queryIntentActivities方法只会给开发者返回一个只有一个Activity的列表（此例子返回的是Google+）。</p>
<p>虽然这是在意料之中的，但是应该在文档中注明，因为它与公共API相矛盾了。</p>
<p>我研究了一下，发现了一个MATCH_ALL标志，文档表示，它将禁用所有的系统级过滤器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Querying flag: if set and if the platform is doing any filtering of the results, then</div><div class="line"> * the filtering will not happen. This is a synonym for saying that all results should</div><div class="line"> * be returned.</div><div class="line"> */</div><div class="line">public static final int MATCH_ALL = 0x00020000;</div></pre></td></tr></table></figure>
<p>这对我来说没什么用。我打开源码（至少我有源码）并开始研究这个方法。</p>
<p>它似乎优先考虑验证应用程序的域，不仅在它的内部系统，在公共API中也是如此。</p>
<p>如果有一个验证应用程序的域，它不会返回任何其他东西。MATCH_ALL标志会移除一些系统过滤器，但是仅仅是在没有验证程序的情况下。</p>
<p>对于这个问题，我找不到任何可变通的措施。它只是排除浏览器应用，即使他们的IntentFilters匹配。</p>
<p>之所以没有可变通的措施，是因为他是一个内部组件（我们无法访问），Android SDK通过IPC使用AIDL与它进行通信。</p>
<p>大部分开发者使用这个方法来判断是否至少有一个Activity来处理隐式的Intent。在大多数情况下，列表中第一项就是你想要的。</p>
<p>在花了几个小时搞明白到底发生了什么之后，我尝试寻找一个我认为每个人都应该知道的解决方案。</p>
<p>在Android 6.0中，改动的地方很多。实际上谷歌提供了一些改变清单，在清单中你能看到到底有哪些改变。我认为还有很多类似上面的一些没有在清单中列出的改变，而这些改动很有可能导致你的应用无法正常运行。</p>
<p>所以如果你使用PackageManager的方法，你一定得小心，并且认真检查。</p>
<p>感谢此文的校对者：<a href="https://twitter.com/yagmurdalman" target="_blank" rel="external">Yağmur Dalman</a>、<a href="https://medium.com/u/9706138c9bfb" target="_blank" rel="external"> Sebastiano Poggi</a>、<a href="https://medium.com/u/73761c65c602" target="_blank" rel="external">Salim KAYABAŞI</a>、<a href="https://medium.com/u/24a0490cd588" target="_blank" rel="external">Hasan Keklik</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/Android 6.0中Intent的解析/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/Android 6.0中Intent的解析/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/一种在android中实现MVP模式的新思路/" title="一种在android中实现MVP模式的新思路" itemprop="url">一种在android中实现MVP模式的新思路</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://blog.cainwong.com/android-mvp-an-alternate-approach/" target="_blank" rel="external">android-mvp-an-alternate-approach</a></li>
<li>译者 : <a href="https://github.com/FTExplore" target="_blank" rel="external">FTExplore</a></li>
<li>校对 : <a href="https://github.com/sundroid" target="_blank" rel="external">sundroid</a></li>
</ul>
<p>今天我想分享我自己在Android上实现MVP模式的方法。如果你对MVP模式还不熟悉或者你不清楚为什么要在Android应用中使用MVP模式，我建议你先阅读以下<a href="http://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93presenter" target="_blank" rel="external">这篇维基百科的文章</a>和<a href="http://antonioleiva.com/mvp-android/" target="_blank" rel="external">这篇博客</a>。</p>
<h2 id="使用Activity和Fragment作为视图层-View-真的合适么"><a href="#使用Activity和Fragment作为视图层-View-真的合适么" class="headerlink" title="使用Activity和Fragment作为视图层(View)真的合适么?"></a>使用Activity和Fragment作为视图层(View)真的合适么?</h2><p>目前很多使用了MVP模式的android 项目,基本上都是将activity和fragment作为视图层来进行处理的.而presenters通常是通过继承自被视图层实例化或者注入的对象来得到的. 诚然,我同意说,这种方式可以节省掉很多让人厌烦的”import android.<em>.</em>“语句, 并且将presenters从activity的生命周期中分割出来以后, 项目后续的维护会变得简便很多.这种思路是正确的， 但是,从另一个角度来说, activity 有一个很复杂的生命周期(fragment的生命周期可能会更复杂), 而这些生命周期很有可能对你项目的业务逻辑有非常重大的影响. Activity 可以获取上下文环境和多种android系统服务. Activity中发送Intent，启动Service和执行FragmentTransisitons等。而这些特性在我看来绝不应该是视图层应该涉及的领域(视图的功能就是现实数据和从用户那里获取输入数据，在理想的情况下，视图应该避免业务逻辑). </p>
<p>基于上述的原因，我对目前的主流做法并不赞同，所以我在尝试使用Activity和Fragment作为Presenters。</p>
<h2 id="使用Activity和Fragment作为presenters的步骤"><a href="#使用Activity和Fragment作为presenters的步骤" class="headerlink" title="使用Activity和Fragment作为presenters的步骤"></a>使用Activity和Fragment作为presenters的步骤</h2><h3 id="1-去除所有的view"><a href="#1-去除所有的view" class="headerlink" title="1. 去除所有的view"></a>1. 去除所有的view</h3><p>将Activity和Fragment作为presenter最大的困难就是如何将关于UI的逻辑抽取出来.我的解决方案是: 让需要作为presenter的activity 或者 fragment来继承一个抽象的类(或者叫”基类”), 这样关于View 各种组件的初始化以及逻辑,都可以在继承了抽象类的方法中进行操作，而当继承了该抽象类的class需要对某些组件进行操作的时候，只需要调用继承自抽象类的方法，就可以了。      </p>
<p>那么抽象类怎么获取到的view组件呢？在抽象类里面会有一个实例化的接口，这个接口里面的init()方法就会对view进行实例化，这个接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Vu</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(LayoutInflater inflater, ViewGroup container)</span></span>;</div><div class="line">	<span class="function">View <span class="title">getView</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正如你所见，Vu定义了一个通用的初始化例程，我可以通过它来实现一个容器视图，它也有一个方法来获得一个View的实例，每一个presenter将会和它自己的Vu关联，这个presenter将会继承这个接口（直接或者间接的去继承一个来自Vu的接口）</p>
<h3 id="2-创建一个presenter基类-Activity"><a href="#2-创建一个presenter基类-Activity" class="headerlink" title="2. 创建一个presenter基类 (Activity)"></a>2. 创建一个presenter基类 (Activity)</h3><p>有了Vu接口，我们可以通过构建一系列的class来操纵很多不同的view组件，这些class 使用Vu接口来初始化View组件，并通过继承的方式给子类以操纵view组件的方法，以此来达到将ui 逻辑剥离出activity的目的。在下面的代码中，你可以看到，我覆写了activity的onCreate 、 onCreateView、onDestroy 、 onDestroyView，通过对这些方法的覆写，就可以对Vu的实例化和销毁进行精确的控制（vu.init()就是实例化一个view组件）。onBindVu() 和onDestoryVu()是控制view生命周期的两个方法。通过对actiivty中相关方法的覆写达到控制组件的生命周期的目的（具体看下面的代码，你就明白了）， 这样做的好处就是无论是activity 还是 fragment， 其用与控制view组件创建和销毁的语句是一样的（尽量避免定义多余的函数）。这样的话，二者之间的切换也会减少一定的阻力（也许你今天的需求是用fragment实现的，但是第二天发现使用fragment会有一个惊天bug，译者本人就遇到过）。     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePresenterActivity</span>&lt;<span class="title">V</span> <span class="keyword">extends</span> <span class="title">Vu</span>&gt; <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> V vu;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            vu = getVuClass().newInstance();</div><div class="line">            vu.init(getLayoutInflater(), <span class="keyword">null</span>);</div><div class="line">            setContentView(vu.getView());</div><div class="line">            onBindVu();</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        onDestroyVu();</div><div class="line">        vu = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Class&lt;V&gt; <span class="title">getVuClass</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBindVu</span><span class="params">()</span></span>&#123;&#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroyVu</span><span class="params">()</span> </span>&#123;&#125;;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-创建一个基本的presenter-Fragment"><a href="#3-创建一个基本的presenter-Fragment" class="headerlink" title="3. 创建一个基本的presenter(Fragment)"></a>3. 创建一个基本的presenter(Fragment)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePresenterFragment</span>&lt;<span class="title">V</span> <span class="keyword">extends</span> <span class="title">Vu</span>&gt; <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> V vu;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        View view = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            vu = getVuClass().newInstance();</div><div class="line">            vu.init(inflater, container);</div><div class="line">            onBindVu();</div><div class="line">            view = vu.getView();</div><div class="line">        &#125; <span class="keyword">catch</span> (java.lang.InstantiationException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onDestroyView</span><span class="params">()</span> </span>&#123;</div><div class="line">        onDestroyVu();</div><div class="line">        vu = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">super</span>.onDestroyView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroyVu</span><span class="params">()</span> </span>&#123;&#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBindVu</span><span class="params">()</span></span>&#123;&#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Class&lt;V&gt; <span class="title">getVuClass</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-一个简单的例子"><a href="#4-一个简单的例子" class="headerlink" title="4. 一个简单的例子"></a>4. 一个简单的例子</h3><p>如前文所述，我们已经确定了一个框架，现在就来写一个简单的例子来进一步的说明. 为了避免篇幅过长，我就写一个“hello world”的例子。首先要有一个实现Vu接口的类：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloVu</span> <span class="keyword">implements</span> <span class="title">Vu</span> </span>&#123;</div><div class="line"></div><div class="line">View view;</div><div class="line">TextView helloView;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(LayoutInflater inflater, ViewGroup container)</span> </span>&#123;</div><div class="line">    view = inflater.inflate(R.layout.hello, container, <span class="keyword">false</span>);</div><div class="line">    helloView = (TextView) view.findViewById(R.id.hello);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> view;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHelloMessage</span><span class="params">(String msg)</span></span>&#123;</div><div class="line">    helloView.setText(msg);</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下一步，创建一个presenter来操作这个TextView<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class HelloActivity extends BasePresenterActivity &#123;</div><div class="line">@Override</div><div class="line">protected void onBindVu() &#123;</div><div class="line">    vu.setHelloMessage(&quot;Hello World!&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">protected Class&lt;HelloVu&gt; getVuClass() &#123;</div><div class="line">    return HelloVu.class;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>OK,这样就大功告成了！！是不是很简便！</p>
<h3 id="等等…耦合警告"><a href="#等等…耦合警告" class="headerlink" title="等等…耦合警告!"></a>等等…耦合警告!</h3><p>你可能注意到我的HelloVu类直接实现了Vu接口，我的Presenter的getVuClass方法直接引用了实现类。传统的MVP模式中，Presenter是要通过接口与他们的View解耦合的。因此，你也可以这么做。避免直接实现Vu接口，我们可以创建一个扩展了Vu的IHelloView接口，然后使用这个接口作为Presenter的泛型类型。这样Presenter看起来应该是如下这样的 : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloActivity</span> <span class="keyword">extends</span> <span class="title">BasePresenterActivity</span>&lt;<span class="title">IHelloVu</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBindVu</span><span class="params">()</span> </span>&#123;</div><div class="line">        vu.setHelloMessage(<span class="string">"Hello World!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Class&lt;HelloVuImpl&gt; <span class="title">getVuClass</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> HelloVuImpl.class;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在我使用强大的模拟工具过程中，我个人并没有看到在一个接口下面实现Vu所带来的好处。但是对于我来说一个好的方面是，有没有Vu接口它都能够工作，唯一的需求就是最终你会实现Vu。</p>
<h2 id="5-如何进行测试"><a href="#5-如何进行测试" class="headerlink" title="5. 如何进行测试"></a>5. 如何进行测试</h2><p>通过以上几步，我们可以发现，去除了UI逻辑之后，Activity变得非常简洁。并且，相关的测试<br>也变的非常异常的简单。请看如下的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloActivityTest</span> </span>&#123;</div><div class="line">    HelloActivity activity;</div><div class="line">    HelloVu vu;</div><div class="line"></div><div class="line">    <span class="meta">@Before</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        activity = <span class="keyword">new</span> HelloActivity();</div><div class="line">        vu = Mockito.mock(HelloVu.class);</div><div class="line">        activity.vu = vu;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOnBindVu</span><span class="params">()</span></span>&#123;</div><div class="line">        activity.onBindVu();</div><div class="line">        verify(vu).setHelloMessage(<span class="string">"Hello World!"</span>);</div><div class="line">    &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>以上代码是一段标准的jnuit单元测试的代码，不需要在android设备中部署运行，只需要在编译环境中即可测试。大幅度的提高了测试效率。但是，在测试某些方法的时候，你必须要使用android设备，例如当你想测试activity生命周期中的resume()方法。在缺乏设备环境的时候，super.resume()会报错。为了解决这个问题，可以借鉴一些工具，例如Robolectric、还有android gradle 1.1 插件中内置的testOptions { unitTests.returnDefaultValues = true }。此外，你仍然可以将这些生命周期也抽离出来。例如如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onResume();</div><div class="line">    afterResume();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterResume</span><span class="params">()</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>现在，你可以在没有android设备的情况下，快速的测试了！   </p>
<h2 id="意外收获：使用adapter作为presenter"><a href="#意外收获：使用adapter作为presenter" class="headerlink" title="意外收获：使用adapter作为presenter"></a>意外收获：使用adapter作为presenter</h2><p>将Activity作为presente已经足够狡猾了吧？使用adapter作为presenter，你想过没有？<br>好吧，请看如下的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePresenterAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</div><div class="line"><span class="keyword">protected</span> V vu;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(convertView == <span class="keyword">null</span>) &#123;</div><div class="line">        LayoutInflater inflater = (LayoutInflater) parent.getContext().getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            vu = (V) getVuClass().newInstance();</div><div class="line">            vu.init(inflater, parent);</div><div class="line">            convertView = vu.getView();</div><div class="line">            convertView.setTag(vu);</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        vu = (V) convertView.getTag();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(convertView!=<span class="keyword">null</span>) &#123;</div><div class="line">        onBindListItemVu(position);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> convertView;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onBindListItemVu</span><span class="params">(<span class="keyword">int</span> position)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Class&lt;V&gt; <span class="title">getVuClass</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如上代码，使用adapter作为presenter其实和activity或者fragement几乎是一样的，只有一点明显的区别就是，我把onBingVu替换成了onBindListItemVu（接受int参数）,其实我是借鉴了<a href="http://developer.android.com/training/improving-layouts/smooth-scrolling.html" target="_blank" rel="external">ViewHolder模式</a>。</p>
<h2 id="总结和一个demo"><a href="#总结和一个demo" class="headerlink" title="总结和一个demo"></a>总结和一个demo</h2><p>我在这篇文章里介绍了我自己的一个实现MVP的方法。我非常期待其他android开发者对我的这套方法的反馈。我切实的想知道我的方法是否可行？我已经把这套思路用在一个框架的开发上，并且即将公布，与此同时，我在github上面有一个demo项目，感兴趣的人可以去看一下<a href="https://github.com/wongcain/MVP-Simple-Demo" target="_blank" rel="external">https://github.com/wongcain/MVP-Simple-Demo</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/一种在android中实现MVP模式的新思路/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/一种在android中实现MVP模式的新思路/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/优化android-studio编译效率的方法/" title="优化android studio编译效率的方法" itemprop="url">优化android studio编译效率的方法</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/@erikhellman/boosting-the-performance-for-gradle-in-your-android-projects-6d5f9e4580b6" target="_blank" rel="external">Boosting the performance for Gradle in your Android projects</a></li>
<li>原文作者 : <a href="https://medium.com/@erikhellman" target="_blank" rel="external">Erik Hellman</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/FTExplore" target="_blank" rel="external">FTExplore</a> </li>
</ul>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>如果你之前用eclipse开发过Android app的化,转到android studio的第一反应也许就是:”编译速度有点慢”. 表现的最明显的一点就是,当我使用eclipse开发的时候,选中了auto building.这个时候<br>我更改了几个字符,eclipse会速度非常快的编译出一个新的apk. 而android studio使用gradle编译,每次编译,即便是更改的代码量很少,也会按照预先设置的task的顺序,依次走完编译的各项流程.所以<br>这点就让人很痛苦. 然而问题总还是要被解决的,作者曾经亲眼看到过使用android studio仅仅用了2.5秒就编译完毕(在代码更改很少的情况下). 现在把如何优化gradle编译速度的方法记录在此,希望可以<br>帮助到广大的同行们.</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>gradle现在最新的版本是2.4, 相比较之前的版本, 在编译效率上面有了一个非常大的提高,为了确保你的android项目使用的是最新版的gradle版本,有两种方法可以使用,下面依次进行介绍</p>
<h3 id="1、在build-gradle中进行设置"><a href="#1、在build-gradle中进行设置" class="headerlink" title="1、在build.gradle中进行设置"></a>1、在build.gradle中进行设置</h3><p>在你的项目gradle文件内(不是app里面的gradle文件), 添加一个task, 代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">task <span class="title">wrapper</span><span class="params">(type: Wrapper)</span> </span>&#123;</div><div class="line">    gradleVersion = <span class="string">'2.4'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后打开terminal, 输入./gradlew wrapper, 然后gradle就会自动去下载2.4版本,这也是官方推荐的手动设置gradle的方法(<a href="http://gradle.org/docs/current/userguide/gradle_wrapper.html" target="_blank" rel="external">http://gradle.org/docs/current/userguide/gradle_wrapper.html</a>)</p>
<h3 id="2、使用android-studio对gradle版本进行设置"><a href="#2、使用android-studio对gradle版本进行设置" class="headerlink" title="2、使用android studio对gradle版本进行设置"></a>2、使用android studio对gradle版本进行设置</h3><p>这种方法需要你去手动去gradle官网下载一个zip包,解压缩后,打开android studio 设置界面的Project Structure. 然后手动添加你解压缩后的gradle的磁盘路径即可,可以参考如下的图片</p>
<p><img src="http://img.blog.csdn.net/20150604104904903" alt="image"></p>
<p>有一点需要注意的是,这种设置方法仅适用于在你的项目中使用gradle wrapper进行编译打包的操作(就是android studio默认需要的东东).如果你想使用gradle做其他的事情,请出门左转,去gradle官网(<a href="http://gradle.org" target="_blank" rel="external">http://gradle.org</a>)</p>
<h2 id="守护进程-并行编译"><a href="#守护进程-并行编译" class="headerlink" title="守护进程,并行编译"></a>守护进程,并行编译</h2><p>通过以上步骤,我们设置好了android studio使用最新的gradle版本,下一步就是正式开启优化之路了. 我们需要将gradle作为守护进程一直在后台运行,这样当我们需要编译的时候,gradle就会立即跑过来然后<br>吭哧吭哧的开始干活.除了设置gradle一直开启之外,当你的工作空间存在多个project的时候,还需要设置gradle对这些projects并行编译,而不是单线的依次进行编译操作.</p>
<p>说了那么多, 那么怎么设置守护进程和并行编译呢?其实非常简单,gradle本身已经有了相关的配置选项,在你电脑的GRADLE_HOME这个环境变量所指的那个文件夹内,有一个<code>.gradle/gradle.properties</code>文件.<br>在这个文件里,放入下面两句话就OK了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">org.gradle.daemon=true</div><div class="line">org.gradle.parallel=true</div></pre></td></tr></table></figure>
<p>有一个地方需要注意的是,android studio 本身在编译的时候,已经是使用守护进程中的gradle了,那么这里加上了org.gradle.daemon=true就是保证了你在使用命令行编译apk的时候也是使用的守护进程.</p>
<p>你也可以将上述的配置文件放到你project中的根目录下,以绝对确保在任何情况下,这个project都会使用守护进程进行编译.不过有些特殊的情况下也许你应该注意守护进程的使用,具体的细节参考<a href="http://gradle.org/docs/current/userguide/gradle_daemon.html#when_should_i_not_use_the_gradle_daemon" target="_blank" rel="external">http://gradle.org/docs/current/userguide/gradle_daemon.html#when_should_i_not_use_the_gradle_daemon</a></p>
<p>在使用并行编译的时候必须要注意的就是,你的各个project之间不要有依赖关系,否则的话,很可能因为你的Project A 依赖Project B, 而Project B还没有编译出来的时候,gradle就开始编译Project A 了.最终<br>导致编译失败.具体可以参考<a href="http://gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects。" target="_blank" rel="external">http://gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects。</a></p>
<p>还有一些额外的gradle设置也许会引起你的兴趣,例如你想增加堆内存的空间,或者指定使用哪个jvm虚拟机等等(代码如下)  </p>
<p>org.gradle.jvmargs=-Xmx768m<br>org.gradle.java.home=/path/to/jvm</p>
<p>如果你想详细的了解gradle的配置,请猛戳<a href="http://gradle.org/docs/current/userguide/userguide_single.html#sec:gradle_configuration_properties" target="_blank" rel="external">http://gradle.org/docs/current/userguide/userguide_single.html#sec:gradle_configuration_properties</a></p>
<h2 id="一个实验性的功能"><a href="#一个实验性的功能" class="headerlink" title="一个实验性的功能"></a>一个实验性的功能</h2><p>最后一个要介绍的是incremental dexing, 这个功能目前还在试验阶段,android studio默认是关闭的, 作者个人是非常推荐的,程序员就是爱折腾啊.</p>
<p>开启incremental dexing也是非常简单的,就是在app级别的buid.gradle文件中加入下面的代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dexOptions &#123;</div><div class="line">        incremental true</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>感性您的阅读,希望这边文章可以对您有所帮助. 如果您有好的建议或者意见请联系我</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/优化android-studio编译效率的方法/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/优化android-studio编译效率的方法/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/上传拍下的照片、视频到服务器/" title="上传拍下的照片、视频到服务器" itemprop="url">上传拍下的照片、视频到服务器</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.androidhive.info/2014/12/android-uploading-camera-image-video-to-server-with-progress-bar/" target="_blank" rel="external">Android Uploading Camera Image, Video to Server with Progress Bar</a></li>
</ul>
<p>我在上一篇教程中给大家讲解了怎么通过进度条下载文件，今天，我将在这篇文章中给大家讲解如果在弹出进度条的同时上传一个文件到服务器。通过阅读这篇文章，并学习其中的知识，你能做出一个类似 Instagram 的App，在你做出的 App 里，你能够像在 Instagram 里那样用摄像头拍照/视频，然后把它们上传到服务器。在服务器端，我使用 PHP 读取上传的文件，并把文件移动到一个特殊的位置。</p>
<p>这篇文章最精华的部分在于：即使是上传大文件，它也能很好地运行，而不是产生许多内存不足的错误。我能有这样的自信，是因为我进行了许多的测试。在测试过程中，即便我上传了一个 50MB 的文件，这个功能仍然运行得很完美，不会出现错误。</p>
<p><a href="http://download.androidhive.info/" target="_blank" rel="external">源码下载</a></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>由于这篇文章需要上传摄像头拍下来的照片/视频，因此你需要先了解有关 Android 摄像头模块的知识。所以我建议你最好先去阅读我之前的一篇有关 Android 是如何操作摄像头的讲解文章，通过阅读这篇文章你能大概了解怎么在你的 Android App 中使用摄像头。</p>
<h2 id="创建-Android-工程"><a href="#创建-Android-工程" class="headerlink" title="创建 Android 工程"></a>创建 Android 工程</h2><p>1、 在 Eclipse 中创建一个新的 Android 工程，具体流程如下：New ⇒ Android Application Project，然后在里面填好一些必要的信息。</p>
<p>2、 打开 res 文件夹中的 strings.xml,然后把下面的内容添加进去：</p>
<p><strong>strings.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line"> </div><div class="line">	 <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"app_name"</span>&gt;</span>Camera File Upload<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">	 <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"btnTakePicture"</span>&gt;</span>Capture Image<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">	 <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"btnRecordVideo"</span>&gt;</span>Record Video<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">	 <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"or"</span>&gt;</span>(or)<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">	 <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"btnUploadToServer"</span>&gt;</span>Upload to Server<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure>
<p>3、 向 res 文件夹添加 colors.xml，并把下面的内容添加进去：</p>
<p><strong>colors.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line"> </div><div class="line">	<span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"view_background"</span>&gt;</span>#e8ecfa<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"btn_bg"</span>&gt;</span>#277bec<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white"</span>&gt;</span>#ffffff<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"txt_font"</span>&gt;</span>#4e5572<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"action_bar"</span>&gt;</span>#1f2649<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure>
<p>4、 在 src 目录下创建一个叫做 Config 的类。这个类用于保存文件上传所送到的 URL 地址，还有在移动设备中存储图片/视频的目录名称。你可能需要在测试 App 时使用你自己的 URL 地址进行上传操作。</p>
<p>5、 创建一个叫做 AndroidMultiPartEntity 的类，并把下面的代码复制进去。这个类是一个自定义的 MultipartEntity 类，主要用于提供这个工程中需要用到的关键功能，例如进度条的进度增量。</p>
<p><strong>AndroidMultiPartEntity.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">package</span> info.androidhive.camerafileupload;</div><div class="line">    </div><div class="line">   <span class="keyword">import</span> java.io.FilterOutputStream;</div><div class="line">   <span class="keyword">import</span> java.io.IOException;</div><div class="line">   <span class="keyword">import</span> java.io.OutputStream;</div><div class="line">   <span class="keyword">import</span> java.nio.charset.Charset;</div><div class="line">    </div><div class="line">   <span class="keyword">import</span> org.apache.http.entity.mime.HttpMultipartMode;</div><div class="line">   <span class="keyword">import</span> org.apache.http.entity.mime.MultipartEntity;</div><div class="line">    </div><div class="line">   <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AndroidMultiPartEntity</span> <span class="keyword">extends</span> <span class="title">MultipartEntity</span></span></div><div class="line">    </div><div class="line">   &#123;</div><div class="line">    </div><div class="line">   	<span class="keyword">private</span> <span class="keyword">final</span> ProgressListener listener;</div><div class="line">    </div><div class="line">   	<span class="function"><span class="keyword">public</span> <span class="title">AndroidMultiPartEntity</span><span class="params">(<span class="keyword">final</span> ProgressListener listener)</span> </span>&#123;</div><div class="line">   		<span class="keyword">super</span>();</div><div class="line">   		<span class="keyword">this</span>.listener = listener;</div><div class="line">   	&#125;</div><div class="line">    </div><div class="line">   	<span class="function"><span class="keyword">public</span> <span class="title">AndroidMultiPartEntity</span><span class="params">(<span class="keyword">final</span> HttpMultipartMode mode,</span></span></div><div class="line">   		<span class="keyword">final</span> ProgressListener listener) &#123;</div><div class="line">   		<span class="keyword">super</span>(mode);</div><div class="line">   		<span class="keyword">this</span>.listener = listener;</div><div class="line">   	&#125;</div><div class="line">    </div><div class="line">   	<span class="function"><span class="keyword">public</span> <span class="title">AndroidMultiPartEntity</span><span class="params">(HttpMultipartMode mode, <span class="keyword">final</span> String boundary,</span></span></div><div class="line">   		<span class="keyword">final</span> Charset charset, <span class="keyword">final</span> ProgressListener listener) &#123;</div><div class="line">   		<span class="keyword">super</span>(mode, boundary, charset);</div><div class="line">   		<span class="keyword">this</span>.listener = listener;</div><div class="line">   	&#125;</div><div class="line">    </div><div class="line">   	<span class="meta">@Override</span></div><div class="line">   	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(<span class="keyword">final</span> OutputStream outstream)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   		<span class="keyword">super</span>.writeTo(<span class="keyword">new</span> CountingOutputStream(outstream, <span class="keyword">this</span>.listener));</div><div class="line">   	&#125;</div><div class="line">    </div><div class="line">   	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProgressListener</span> </span>&#123;</div><div class="line">   		<span class="function"><span class="keyword">void</span> <span class="title">transferred</span><span class="params">(<span class="keyword">long</span> num)</span></span>;</div><div class="line">   	&#125;</div><div class="line">    </div><div class="line">   	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CountingOutputStream</span> <span class="keyword">extends</span> <span class="title">FilterOutputStream</span> </span>&#123;</div><div class="line">    </div><div class="line">   		<span class="keyword">private</span> <span class="keyword">final</span> ProgressListener listener;</div><div class="line">   		<span class="keyword">private</span> <span class="keyword">long</span> transferred;</div><div class="line">    </div><div class="line">   		<span class="function"><span class="keyword">public</span> <span class="title">CountingOutputStream</span><span class="params">(<span class="keyword">final</span> OutputStream out,</span></span></div><div class="line">   			<span class="keyword">final</span> ProgressListener listener) &#123;</div><div class="line">   				<span class="keyword">super</span>(out);</div><div class="line">   				<span class="keyword">this</span>.listener = listener;</div><div class="line">   				<span class="keyword">this</span>.transferred = <span class="number">0</span>;</div><div class="line">   		&#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    	out.write(b, off, len);</div><div class="line">    	<span class="keyword">this</span>.transferred += len;</div><div class="line">    	<span class="keyword">this</span>.listener.transferred(<span class="keyword">this</span>.transferred);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    	out.write(b);</div><div class="line">    	<span class="keyword">this</span>.transferred++;</div><div class="line">    	<span class="keyword">this</span>.listener.transferred(<span class="keyword">this</span>.transferred);</div><div class="line">    &#125;</div><div class="line">  	  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们需要通过在 App 中添加一个简单的页面来添加摄像头功能，在这里我们将使用两个 Button 来调用我们的摄像头为我们的 App 拍照/视频。</p>
<p>6、 在你的 AndroidManifest.xml 中添加相应的权限。你会注意到 UploadActivity 也需要被添加到 AndroidManifest.xml 文件中，我们会在后面提到这个。</p>
<p><strong>INTERNET</strong> – 联网权限</p>
<p><strong>WRITE_EXTERNAL_STORAGE</strong> – 存储照片/视频到本地的权限</p>
<p><strong>RECORD_AUDIO</strong> – 拍摄权限</p>
<p><strong>AndroidManifest.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"> <span class="attr">package</span>=<span class="string">"info.androidhive.camerafileupload"</span></div><div class="line"> <span class="attr">android:versionCode</span>=<span class="string">"1"</span></div><div class="line"> <span class="attr">android:versionName</span>=<span class="string">"1.0"</span> &gt;</div><div class="line">	 </div><div class="line"> <span class="tag">&lt;<span class="name">uses-sdk</span></span></div><div class="line">     <span class="attr">android:minSdkVersion</span>=<span class="string">"11"</span></div><div class="line">     <span class="attr">android:targetSdkVersion</span>=<span class="string">"21"</span> /&gt;</div><div class="line">	 </div><div class="line"> <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.RECORD_AUDIO"</span> /&gt;</span></div><div class="line">	 </div><div class="line"> <span class="tag">&lt;<span class="name">application</span></span></div><div class="line">     <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></div><div class="line">     <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_launcher"</span></div><div class="line">     <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></div><div class="line">     <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span> &gt;</div><div class="line">     <span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">         <span class="attr">android:name</span>=<span class="string">"info.androidhive.camerafileupload.MainActivity"</span></div><div class="line">         <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></div><div class="line">         <span class="attr">android:screenOrientation</span>=<span class="string">"portrait"</span> &gt;</div><div class="line">         <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></div><div class="line">	 </div><div class="line">             <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">         <span class="attr">android:name</span>=<span class="string">"info.androidhive.camerafileupload.UploadActivity"</span></div><div class="line">         <span class="attr">android:screenOrientation</span>=<span class="string">"portrait"</span> &gt;</div><div class="line">     <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">application</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div></pre></td></tr></table></figure>
<p>7、打开你 MainActivity 的布局文件（activity_main.xml)，并添加下面的代码，这样做能让你的布局拥有两个 Button。</p>
<p><strong>activity_main.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"@color/view_background"</span></div><div class="line">    <span class="attr">android:baselineAligned</span>=<span class="string">"false"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> &gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> &gt;</div><div class="line"> </div><div class="line">        <span class="comment">&lt;!-- Capture picture button --&gt;</span></div><div class="line"> </div><div class="line">        <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/btnCapturePicture"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginBottom</span>=<span class="string">"20dp"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@color/btn_bg"</span></div><div class="line">            <span class="attr">android:paddingLeft</span>=<span class="string">"20dp"</span></div><div class="line">            <span class="attr">android:paddingRight</span>=<span class="string">"20dp"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@string/btnTakePicture"</span></div><div class="line">            <span class="attr">android:textColor</span>=<span class="string">"@color/white"</span> /&gt;</div><div class="line"> </div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginBottom</span>=<span class="string">"20dp"</span></div><div class="line">            <span class="attr">android:gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@string/or"</span></div><div class="line">            <span class="attr">android:textColor</span>=<span class="string">"@color/txt_font"</span> /&gt;</div><div class="line"> </div><div class="line">        <span class="comment">&lt;!-- Record video button --&gt;</span></div><div class="line"> </div><div class="line">        <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/btnRecordVideo"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@color/btn_bg"</span></div><div class="line">            <span class="attr">android:paddingLeft</span>=<span class="string">"20dp"</span></div><div class="line">            <span class="attr">android:paddingRight</span>=<span class="string">"20dp"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@string/btnRecordVideo"</span></div><div class="line">            <span class="attr">android:textColor</span>=<span class="string">"@color/white"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>8、在你的 MainActivity 中添加使用摄像头的相关代码，这些代码和这个系列的教程中使用的代码是一样的。简单来说，这个 Activity 主要会完成下面的工作：</p>
<ul>
<li><p>这个 App 在安装并打开后，能够通过点击 Button 拍照/视频。</p>
</li>
<li><p>只要照片/视频被拍下来，就会保存在移动设备的 SD 卡上</p>
</li>
<li><p>最后， 通过传递 SD 卡中储存媒体文件的对应路径，UploadActivity 会被打开，然后执行上传的流程。</p>
</li>
</ul>
<p><strong>MainActivity.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> info.androidhive.camerafileupload;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.Locale;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.content.pm.PackageManager;</div><div class="line"><span class="keyword">import</span> android.graphics.Color;</div><div class="line"><span class="keyword">import</span> android.graphics.drawable.ColorDrawable;</div><div class="line"><span class="keyword">import</span> android.net.Uri;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.os.Environment;</div><div class="line"><span class="keyword">import</span> android.provider.MediaStore;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.Button;</div><div class="line"><span class="keyword">import</span> android.widget.Toast;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">     </div><div class="line">    <span class="comment">// LogCat tag</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = MainActivity.class.getSimpleName();</div><div class="line">     </div><div class="line">  </div><div class="line">    <span class="comment">// Camera activity request codes</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAMERA_CAPTURE_IMAGE_REQUEST_CODE = <span class="number">100</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAMERA_CAPTURE_VIDEO_REQUEST_CODE = <span class="number">200</span>;</div><div class="line">     </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_TYPE_IMAGE = <span class="number">1</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_TYPE_VIDEO = <span class="number">2</span>;</div><div class="line">  </div><div class="line">    <span class="keyword">private</span> Uri fileUri; <span class="comment">// file url to store image/video</span></div><div class="line">     </div><div class="line">    <span class="keyword">private</span> Button btnCapturePicture, btnRecordVideo;</div><div class="line">  </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">         </div><div class="line">        <span class="comment">// Changing action bar background color</span></div><div class="line">        <span class="comment">// These two lines are not needed</span></div><div class="line">        getActionBar().setBackgroundDrawable(<span class="keyword">new</span> ColorDrawable(Color.parseColor(getResources().getString(R.color.action_bar))));</div><div class="line">  </div><div class="line">        btnCapturePicture = (Button) findViewById(R.id.btnCapturePicture);</div><div class="line">        btnRecordVideo = (Button) findViewById(R.id.btnRecordVideo);</div><div class="line">  </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Capture image button click event</div><div class="line">         */</div><div class="line">        btnCapturePicture.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">  </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="comment">// capture picture</span></div><div class="line">                captureImage();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">  </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Record video button click event</div><div class="line">         */</div><div class="line">        btnRecordVideo.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">  </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="comment">// record video</span></div><div class="line">                recordVideo();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">  </div><div class="line">        <span class="comment">// Checking camera availability</span></div><div class="line">        <span class="keyword">if</span> (!isDeviceSupportCamera()) &#123;</div><div class="line">            Toast.makeText(getApplicationContext(),</div><div class="line">                    <span class="string">"Sorry! Your device doesn't support camera"</span>,</div><div class="line">                    Toast.LENGTH_LONG).show();</div><div class="line">            <span class="comment">// will close the app if the device does't have camera</span></div><div class="line">            finish();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Checking device has camera hardware or not</div><div class="line">     * */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDeviceSupportCamera</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (getApplicationContext().getPackageManager().hasSystemFeature(</div><div class="line">                PackageManager.FEATURE_CAMERA)) &#123;</div><div class="line">            <span class="comment">// this device has a camera</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// no camera on this device</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Launching camera app to capture image</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">captureImage</span><span class="params">()</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(MediaStore.ACTION_IMAGE_CAPTURE);</div><div class="line">  </div><div class="line">        fileUri = getOutputMediaFileUri(MEDIA_TYPE_IMAGE);</div><div class="line">  </div><div class="line">        intent.putExtra(MediaStore.EXTRA_OUTPUT, fileUri);</div><div class="line">  </div><div class="line">        <span class="comment">// start the image capture Intent</span></div><div class="line">        startActivityForResult(intent, CAMERA_CAPTURE_IMAGE_REQUEST_CODE);</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Launching camera app to record video</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recordVideo</span><span class="params">()</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(MediaStore.ACTION_VIDEO_CAPTURE);</div><div class="line">  </div><div class="line">        fileUri = getOutputMediaFileUri(MEDIA_TYPE_VIDEO);</div><div class="line">  </div><div class="line">        <span class="comment">// set video quality</span></div><div class="line">        intent.putExtra(MediaStore.EXTRA_VIDEO_QUALITY, <span class="number">1</span>);</div><div class="line">  </div><div class="line">        intent.putExtra(MediaStore.EXTRA_OUTPUT, fileUri); <span class="comment">// set the image file</span></div><div class="line">                                                            <span class="comment">// name</span></div><div class="line">  </div><div class="line">        <span class="comment">// start the video capture Intent</span></div><div class="line">        startActivityForResult(intent, CAMERA_CAPTURE_VIDEO_REQUEST_CODE);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Here we store the file url as it will be null after returning from camera</div><div class="line">     * app</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onSaveInstanceState(outState);</div><div class="line">  </div><div class="line">        <span class="comment">// save file url in bundle as it will be null on screen orientation</span></div><div class="line">        <span class="comment">// changes</span></div><div class="line">        outState.putParcelable(<span class="string">"file_uri"</span>, fileUri);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRestoreInstanceState(savedInstanceState);</div><div class="line">  </div><div class="line">        <span class="comment">// get the file url</span></div><div class="line">        fileUri = savedInstanceState.getParcelable(<span class="string">"file_uri"</span>);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">     </div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Receiving activity result method will be called after closing the camera</div><div class="line">     * */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</div><div class="line">        <span class="comment">// if the result is capturing Image</span></div><div class="line">        <span class="keyword">if</span> (requestCode == CAMERA_CAPTURE_IMAGE_REQUEST_CODE) &#123;</div><div class="line">            <span class="keyword">if</span> (resultCode == RESULT_OK) &#123;</div><div class="line">                 </div><div class="line">                <span class="comment">// successfully captured the image</span></div><div class="line">                <span class="comment">// launching upload activity</span></div><div class="line">                launchUploadActivity(<span class="keyword">true</span>);</div><div class="line">                 </div><div class="line">                 </div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultCode == RESULT_CANCELED) &#123;</div><div class="line">                 </div><div class="line">                <span class="comment">// user cancelled Image capture</span></div><div class="line">                Toast.makeText(getApplicationContext(),</div><div class="line">                        <span class="string">"User cancelled image capture"</span>, Toast.LENGTH_SHORT)</div><div class="line">                        .show();</div><div class="line">             </div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// failed to capture image</span></div><div class="line">                Toast.makeText(getApplicationContext(),</div><div class="line">                        <span class="string">"Sorry! Failed to capture image"</span>, Toast.LENGTH_SHORT)</div><div class="line">                        .show();</div><div class="line">            &#125;</div><div class="line">         </div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestCode == CAMERA_CAPTURE_VIDEO_REQUEST_CODE) &#123;</div><div class="line">            <span class="keyword">if</span> (resultCode == RESULT_OK) &#123;</div><div class="line">                 </div><div class="line">                <span class="comment">// video successfully recorded</span></div><div class="line">                <span class="comment">// launching upload activity</span></div><div class="line">                launchUploadActivity(<span class="keyword">false</span>);</div><div class="line">             </div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultCode == RESULT_CANCELED) &#123;</div><div class="line">                 </div><div class="line">                <span class="comment">// user cancelled recording</span></div><div class="line">                Toast.makeText(getApplicationContext(),</div><div class="line">                        <span class="string">"User cancelled video recording"</span>, Toast.LENGTH_SHORT)</div><div class="line">                        .show();</div><div class="line">             </div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// failed to record video</span></div><div class="line">                Toast.makeText(getApplicationContext(),</div><div class="line">                        <span class="string">"Sorry! Failed to record video"</span>, Toast.LENGTH_SHORT)</div><div class="line">                        .show();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">launchUploadActivity</span><span class="params">(<span class="keyword">boolean</span> isImage)</span></span>&#123;</div><div class="line">        Intent i = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, UploadActivity.class);</div><div class="line">        i.putExtra(<span class="string">"filePath"</span>, fileUri.getPath());</div><div class="line">        i.putExtra(<span class="string">"isImage"</span>, isImage);</div><div class="line">        startActivity(i);</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ------------ Helper Methods ---------------------- </div><div class="line">     * */</div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creating file uri to store image/video</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">getOutputMediaFileUri</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Uri.fromFile(getOutputMediaFile(type));</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * returning image / video</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> File <span class="title">getOutputMediaFile</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">  </div><div class="line">        <span class="comment">// External sdcard location</span></div><div class="line">        File mediaStorageDir = <span class="keyword">new</span> File(</div><div class="line">                Environment</div><div class="line">                        .getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES),</div><div class="line">                Config.IMAGE_DIRECTORY_NAME);</div><div class="line">  </div><div class="line">        <span class="comment">// Create the storage directory if it does not exist</span></div><div class="line">        <span class="keyword">if</span> (!mediaStorageDir.exists()) &#123;</div><div class="line">            <span class="keyword">if</span> (!mediaStorageDir.mkdirs()) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"Oops! Failed create "</span></div><div class="line">                        + Config.IMAGE_DIRECTORY_NAME + <span class="string">" directory"</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">  </div><div class="line">        <span class="comment">// Create a media file name</span></div><div class="line">        String timeStamp = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd_HHmmss"</span>,</div><div class="line">                Locale.getDefault()).format(<span class="keyword">new</span> Date());</div><div class="line">        File mediaFile;</div><div class="line">        <span class="keyword">if</span> (type == MEDIA_TYPE_IMAGE) &#123;</div><div class="line">            mediaFile = <span class="keyword">new</span> File(mediaStorageDir.getPath() + File.separator</div><div class="line">                    + <span class="string">"IMG_"</span> + timeStamp + <span class="string">".jpg"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == MEDIA_TYPE_VIDEO) &#123;</div><div class="line">            mediaFile = <span class="keyword">new</span> File(mediaStorageDir.getPath() + File.separator</div><div class="line">                    + <span class="string">"VID_"</span> + timeStamp + <span class="string">".mp4"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">  </div><div class="line">        <span class="keyword">return</span> mediaFile;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你现在运行你的 App，你会看到类似下面这样的输出结果。</p>
<p><img src="http://cdn4.androidhive.info/wp-content/uploads/2014/12/android-file-upload-camera-screen.jpg?6141f6" alt=""></p>
<p><img src="http://cdn2.androidhive.info/wp-content/uploads/2014/12/android-file-upload-camera-taking-camera-picture.jpg?6141f6" alt=""></p>
<p>只要你能够打开摄像头并拍着照片/视频，我们就能继续今天的学习，也就是接下来要讲的——创建实现上传功能的 Activity。</p>
<p>9、在 res 文件夹中创建一个 activity_upload.xml 文件，这个布局提供了 ImageView、VideoView 用以预览拍下来的照片/视频，此外，还有一个 ProgressBar 被用于展现上传进度。</p>
<p><strong>activity_upload.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"@color/view_background"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">    <span class="attr">android:padding</span>=<span class="string">"10dp"</span> &gt;</div><div class="line"> </div><div class="line">     </div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- To display picture taken --&gt;</span></div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/imgPreview"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"200dp"</span></div><div class="line">        <span class="attr">android:visibility</span>=<span class="string">"gone"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"15dp"</span>/&gt;</div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- Videoview to preview recorded video --&gt;</span></div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">VideoView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/videoPreview"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"400dp"</span></div><div class="line">        <span class="attr">android:visibility</span>=<span class="string">"gone"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"15dp"</span>/&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/txtPercentage"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"15dp"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"15dp"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"@color/txt_font"</span></div><div class="line">        <span class="attr">android:textSize</span>=<span class="string">"30dp"</span> /&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">ProgressBar</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/progressBar"</span></div><div class="line">        <span class="attr">style</span>=<span class="string">"?android:attr/progressBarStyleHorizontal"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"20dp"</span></div><div class="line">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"35dp"</span></div><div class="line">        <span class="attr">android:visibility</span>=<span class="string">"gone"</span>/&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btnUpload"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@color/btn_bg"</span></div><div class="line">        <span class="attr">android:paddingLeft</span>=<span class="string">"20dp"</span></div><div class="line">        <span class="attr">android:paddingRight</span>=<span class="string">"20dp"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@string/btnUploadToServer"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"@color/white"</span></div><div class="line">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"20dp"</span>/&gt;</div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>10、创建一个叫做 UploadActivity 的类，并把下面的代码复制进去。在这个类里，我们主要完成下面两项工作：</p>
<ul>
<li><p>接收 MainActivity 传过来的媒体文件路径，并把媒体文件显示在我们的视图中供以预览。</p>
</li>
<li><p>通过 UploadFileToServer()方法我们异步处理了上传文件到服务器和更新进度条进度两项工作。</p>
</li>
</ul>
<p><strong>UploadActivity.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> info.androidhive.camerafileupload;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> info.androidhive.camerafileupload.AndroidMultiPartEntity.ProgressListener;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</div><div class="line"><span class="keyword">import</span> org.apache.http.HttpResponse;</div><div class="line"><span class="keyword">import</span> org.apache.http.client.ClientProtocolException;</div><div class="line"><span class="keyword">import</span> org.apache.http.client.HttpClient;</div><div class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</div><div class="line"><span class="keyword">import</span> org.apache.http.entity.mime.content.FileBody;</div><div class="line"><span class="keyword">import</span> org.apache.http.entity.mime.content.StringBody;</div><div class="line"><span class="keyword">import</span> org.apache.http.impl.client.DefaultHttpClient;</div><div class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.app.AlertDialog;</div><div class="line"><span class="keyword">import</span> android.content.DialogInterface;</div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.graphics.Bitmap;</div><div class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</div><div class="line"><span class="keyword">import</span> android.graphics.Color;</div><div class="line"><span class="keyword">import</span> android.graphics.drawable.ColorDrawable;</div><div class="line"><span class="keyword">import</span> android.os.AsyncTask;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.Button;</div><div class="line"><span class="keyword">import</span> android.widget.ImageView;</div><div class="line"><span class="keyword">import</span> android.widget.ProgressBar;</div><div class="line"><span class="keyword">import</span> android.widget.TextView;</div><div class="line"><span class="keyword">import</span> android.widget.Toast;</div><div class="line"><span class="keyword">import</span> android.widget.VideoView;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="comment">// LogCat tag</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = MainActivity.class.getSimpleName();</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> ProgressBar progressBar;</div><div class="line">    <span class="keyword">private</span> String filePath = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> TextView txtPercentage;</div><div class="line">    <span class="keyword">private</span> ImageView imgPreview;</div><div class="line">    <span class="keyword">private</span> VideoView vidPreview;</div><div class="line">    <span class="keyword">private</span> Button btnUpload;</div><div class="line">    <span class="keyword">long</span> totalSize = <span class="number">0</span>;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_upload);</div><div class="line">        txtPercentage = (TextView) findViewById(R.id.txtPercentage);</div><div class="line">        btnUpload = (Button) findViewById(R.id.btnUpload);</div><div class="line">        progressBar = (ProgressBar) findViewById(R.id.progressBar);</div><div class="line">        imgPreview = (ImageView) findViewById(R.id.imgPreview);</div><div class="line">        vidPreview = (VideoView) findViewById(R.id.videoPreview);</div><div class="line"> </div><div class="line">        <span class="comment">// Changing action bar background color</span></div><div class="line">        getActionBar().setBackgroundDrawable(</div><div class="line">                <span class="keyword">new</span> ColorDrawable(Color.parseColor(getResources().getString(</div><div class="line">                        R.color.action_bar))));</div><div class="line"> </div><div class="line">        <span class="comment">// Receiving the data from previous activity</span></div><div class="line">        Intent i = getIntent();</div><div class="line"> </div><div class="line">        <span class="comment">// image or video path that is captured in previous activity</span></div><div class="line">        filePath = i.getStringExtra(<span class="string">"filePath"</span>);</div><div class="line"> </div><div class="line">        <span class="comment">// boolean flag to identify the media type, image or video</span></div><div class="line">        <span class="keyword">boolean</span> isImage = i.getBooleanExtra(<span class="string">"isImage"</span>, <span class="keyword">true</span>);</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (filePath != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Displaying the image or video on the screen</span></div><div class="line">            previewMedia(isImage);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Toast.makeText(getApplicationContext(),</div><div class="line">                    <span class="string">"Sorry, file path is missing!"</span>, Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        btnUpload.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line"> </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="comment">// uploading the file to server</span></div><div class="line">                <span class="keyword">new</span> UploadFileToServer().execute();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Displaying captured image/video on the screen</div><div class="line">     * */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">previewMedia</span><span class="params">(<span class="keyword">boolean</span> isImage)</span> </span>&#123;</div><div class="line">        <span class="comment">// Checking whether captured media is image or video</span></div><div class="line">        <span class="keyword">if</span> (isImage) &#123;</div><div class="line">            imgPreview.setVisibility(View.VISIBLE);</div><div class="line">            vidPreview.setVisibility(View.GONE);</div><div class="line">            <span class="comment">// bimatp factory</span></div><div class="line">            BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</div><div class="line"> </div><div class="line">            <span class="comment">// down sizing image as it throws OutOfMemory Exception for larger</span></div><div class="line">            <span class="comment">// images</span></div><div class="line">            options.inSampleSize = <span class="number">8</span>;</div><div class="line"> </div><div class="line">            <span class="keyword">final</span> Bitmap bitmap = BitmapFactory.decodeFile(filePath, options);</div><div class="line"> </div><div class="line">            imgPreview.setImageBitmap(bitmap);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            imgPreview.setVisibility(View.GONE);</div><div class="line">            vidPreview.setVisibility(View.VISIBLE);</div><div class="line">            vidPreview.setVideoPath(filePath);</div><div class="line">            <span class="comment">// start playing</span></div><div class="line">            vidPreview.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Uploading the file to server</div><div class="line">     * */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadFileToServer</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Void</span>, <span class="title">Integer</span>, <span class="title">String</span>&gt; </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// setting progress bar to zero</span></div><div class="line">            progressBar.setProgress(<span class="number">0</span>);</div><div class="line">            <span class="keyword">super</span>.onPreExecute();</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onProgressUpdate</span><span class="params">(Integer... progress)</span> </span>&#123;</div><div class="line">            <span class="comment">// Making progress bar visible</span></div><div class="line">            progressBar.setVisibility(View.VISIBLE);</div><div class="line"> </div><div class="line">            <span class="comment">// updating progress bar value</span></div><div class="line">            progressBar.setProgress(progress[<span class="number">0</span>]);</div><div class="line"> </div><div class="line">            <span class="comment">// updating percentage value</span></div><div class="line">            txtPercentage.setText(String.valueOf(progress[<span class="number">0</span>]) + <span class="string">"%"</span>);</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> uploadFile();</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">uploadFile</span><span class="params">()</span> </span>&#123;</div><div class="line">            String responseString = <span class="keyword">null</span>;</div><div class="line"> </div><div class="line">            HttpClient httpclient = <span class="keyword">new</span> DefaultHttpClient();</div><div class="line">            HttpPost httppost = <span class="keyword">new</span> HttpPost(Config.FILE_UPLOAD_URL);</div><div class="line"> </div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                AndroidMultiPartEntity entity = <span class="keyword">new</span> AndroidMultiPartEntity(</div><div class="line">                        <span class="keyword">new</span> ProgressListener() &#123;</div><div class="line"> </div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transferred</span><span class="params">(<span class="keyword">long</span> num)</span> </span>&#123;</div><div class="line">                                publishProgress((<span class="keyword">int</span>) ((num / (<span class="keyword">float</span>) totalSize) * <span class="number">100</span>));</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line"> </div><div class="line">                File sourceFile = <span class="keyword">new</span> File(filePath);</div><div class="line"> </div><div class="line">                <span class="comment">// Adding file data to http body</span></div><div class="line">                entity.addPart(<span class="string">"image"</span>, <span class="keyword">new</span> FileBody(sourceFile));</div><div class="line"> </div><div class="line">                <span class="comment">// Extra parameters if you want to pass to server</span></div><div class="line">                entity.addPart(<span class="string">"website"</span>,</div><div class="line">                        <span class="keyword">new</span> StringBody(<span class="string">"www.androidhive.info"</span>));</div><div class="line">                entity.addPart(<span class="string">"email"</span>, <span class="keyword">new</span> StringBody(<span class="string">"abc@gmail.com"</span>));</div><div class="line"> </div><div class="line">                totalSize = entity.getContentLength();</div><div class="line">                httppost.setEntity(entity);</div><div class="line"> </div><div class="line">                <span class="comment">// Making server call</span></div><div class="line">                HttpResponse response = httpclient.execute(httppost);</div><div class="line">                HttpEntity r_entity = response.getEntity();</div><div class="line"> </div><div class="line">                <span class="keyword">int</span> statusCode = response.getStatusLine().getStatusCode();</div><div class="line">                <span class="keyword">if</span> (statusCode == <span class="number">200</span>) &#123;</div><div class="line">                    <span class="comment">// Server response</span></div><div class="line">                    responseString = EntityUtils.toString(r_entity);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    responseString = <span class="string">"Error occurred! Http Status Code: "</span></div><div class="line">                            + statusCode;</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">            &#125; <span class="keyword">catch</span> (ClientProtocolException e) &#123;</div><div class="line">                responseString = e.toString();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                responseString = e.toString();</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="keyword">return</span> responseString;</div><div class="line"> </div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String result)</span> </span>&#123;</div><div class="line">            Log.e(TAG, <span class="string">"Response from server: "</span> + result);</div><div class="line"> </div><div class="line">            <span class="comment">// showing the server response in an alert dialog</span></div><div class="line">            showAlert(result);</div><div class="line"> </div><div class="line">            <span class="keyword">super</span>.onPostExecute(result);</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Method to show alert dialog</div><div class="line">     * */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showAlert</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>);</div><div class="line">        builder.setMessage(message).setTitle(<span class="string">"Response from Servers"</span>)</div><div class="line">                .setCancelable(<span class="keyword">false</span>)</div><div class="line">                .setPositiveButton(<span class="string">"OK"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">                        <span class="comment">// do nothing</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">        AlertDialog alert = builder.create();</div><div class="line">        alert.show();</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里，我们已经把 Android 项目构建好了，现在让我们来快速地创建一个 PHP工程以用于接收我们 App 发送过来的文件，就能看到这个项目的实际想过啦。但在那之前，我们可能需要为 WAMP Server做一点点简单的配置。</p>
<h2 id="2-安装与配置-WAMP-Server"><a href="#2-安装与配置-WAMP-Server" class="headerlink" title="2.安装与配置 WAMP Server"></a>2.安装与配置 WAMP Server</h2><p>1、下载并安装 WAMP，在 Windows 系统中，WAMP 将会被安装在 C:\wamp location。</p>
<p>2、打开 php,ini 文件，并修改下列值。在 WAMP Server 中，上传文件的最大值默认为 2MB，通过修改下列值，我们能够让上传文件的最大值达到 50MB。</p>
<p><img src="http://cdn3.androidhive.info/wp-content/uploads/2014/12/wamp-server-editing-php.ini-file1.png?6141f6" alt=""></p>
<blockquote>
<p>upload_max_filesize = 50M<br>post_max_size = 50M<br>max_input_time = 300<br>max_execution_time = 300</p>
</blockquote>
<p>3、配置完成后重启 WAMP Server 即可。</p>
<h2 id="3-创建一个-PHP-项目"><a href="#3-创建一个-PHP-项目" class="headerlink" title="3.创建一个 PHP 项目"></a>3.创建一个 PHP 项目</h2><p>1、到 C:\wamp\www 目录中创建一个名为 AndroidFileUpload 的文件夹，这将会是我们 PHP 项目的根目录</p>
<p>2、进入这个文件夹中创建一个叫作 uploads 的文件夹，用以储存所有上传到服务器的文件</p>
<p>3、创建一个叫做 fileUpload.php 的文件，并把下面的内容复制进去。这些 PHP 代码的作用是：接收我们 Android App 上传的文件，并把它们储存在 uploads 文件夹中。一旦上传完成，服务器就会返回一个 JSON。</p>
<p><strong>fileUpload.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"> </div><div class="line"><span class="comment">// Path to move uploaded files</span></div><div class="line">$target_path = <span class="string">"uploads/"</span>;</div><div class="line"> </div><div class="line"><span class="comment">// array for final json respone</span></div><div class="line">$response = <span class="keyword">array</span>();</div><div class="line"> </div><div class="line"><span class="comment">// getting server ip address</span></div><div class="line">$server_ip = gethostbyname(gethostname());</div><div class="line"> </div><div class="line"><span class="comment">// final file url that is being uploaded</span></div><div class="line">$file_upload_url = <span class="string">'http://'</span> . $server_ip . <span class="string">'/'</span> . <span class="string">'AndroidFileUpload'</span> . <span class="string">'/'</span> . $target_path;</div><div class="line"> </div><div class="line"> </div><div class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_FILES[<span class="string">'image'</span>][<span class="string">'name'</span>])) &#123;</div><div class="line">    $target_path = $target_path . basename($_FILES[<span class="string">'image'</span>][<span class="string">'name'</span>]);</div><div class="line"> </div><div class="line">    <span class="comment">// reading other post parameters</span></div><div class="line">    $email = <span class="keyword">isset</span>($_POST[<span class="string">'email'</span>]) ? $_POST[<span class="string">'email'</span>] : <span class="string">''</span>;</div><div class="line">    $website = <span class="keyword">isset</span>($_POST[<span class="string">'website'</span>]) ? $_POST[<span class="string">'website'</span>] : <span class="string">''</span>;</div><div class="line"> </div><div class="line">    $response[<span class="string">'file_name'</span>] = basename($_FILES[<span class="string">'image'</span>][<span class="string">'name'</span>]);</div><div class="line">    $response[<span class="string">'email'</span>] = $email;</div><div class="line">    $response[<span class="string">'website'</span>] = $website;</div><div class="line"> </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// Throws exception incase file is not being moved</span></div><div class="line">        <span class="keyword">if</span> (!move_uploaded_file($_FILES[<span class="string">'image'</span>][<span class="string">'tmp_name'</span>], $target_path)) &#123;</div><div class="line">            <span class="comment">// make error flag true</span></div><div class="line">            $response[<span class="string">'error'</span>] = <span class="keyword">true</span>;</div><div class="line">            $response[<span class="string">'message'</span>] = <span class="string">'Could not move the file!'</span>;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="comment">// File successfully uploaded</span></div><div class="line">        $response[<span class="string">'message'</span>] = <span class="string">'File uploaded successfully!'</span>;</div><div class="line">        $response[<span class="string">'error'</span>] = <span class="keyword">false</span>;</div><div class="line">        $response[<span class="string">'file_path'</span>] = $file_upload_url . basename($_FILES[<span class="string">'image'</span>][<span class="string">'name'</span>]);</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">        <span class="comment">// Exception occurred. Make error flag true</span></div><div class="line">        $response[<span class="string">'error'</span>] = <span class="keyword">true</span>;</div><div class="line">        $response[<span class="string">'message'</span>] = $e-&gt;getMessage();</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// File parameter is missing</span></div><div class="line">    $response[<span class="string">'error'</span>] = <span class="keyword">true</span>;</div><div class="line">    $response[<span class="string">'message'</span>] = <span class="string">'Not received any file!F'</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">// Echo final json response to client</span></div><div class="line"><span class="keyword">echo</span> json_encode($response);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>Below is the sample JSON response if the file is uploaded successfully. You can use error value to verify the upload on android side.</p>
<p>如果文件成功被上传，就会得到类似下面这个简单的 JSON 返回值范例。你可以使用错误代码来确认 Android 端的上传结果。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"file_name"</span>: <span class="string">"DSC_0021.JPG"</span>,</div><div class="line">    <span class="string">"email"</span>: <span class="string">"admin@androidhive.info"</span>,</div><div class="line">    <span class="string">"website"</span>: <span class="string">"www.androidhive.info"</span>,</div><div class="line">    <span class="string">"message"</span>: <span class="string">"File uploaded successfully!"</span>,</div><div class="line">    <span class="string">"error"</span>: <span class="keyword">false</span>,</div><div class="line">    <span class="string">"file_path"</span>: <span class="string">"http://192.168.0.104/AndroidFileUpload/uploads/DSC_0021.JPG"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-测试上传文件功能（本地）"><a href="#4-测试上传文件功能（本地）" class="headerlink" title="4.测试上传文件功能（本地）"></a>4.测试上传文件功能（本地）</h2><p>你可以通过完成下面的步骤在本地测试 App 的功能</p>
<ol>
<li><p>运行必要的设备（这里指的是运行 WAMP server 和 Android 手机），并将它们连在同一个 WIFI 网络中</p>
</li>
<li><p>开启 WAMP server</p>
</li>
<li><p>在电脑上运行 PHP 工程，并获取本机的 IP 地址。你可以通过在控制台中输入 ipconfig 命令获得你的 IP 地址。（在 Mac Os 系统中，你需要使用 ifconfig 获得 IP 地址）</p>
</li>
<li><p>把 Config 类中的 IP 地址换成你的 IP 地址（创建 Android 项目的第四步）</p>
</li>
<li><p>把我们的 Android App 安装到手机上，并运行它</p>
</li>
</ol>
<p><img src="http://cdn2.androidhive.info/wp-content/uploads/2014/12/android-uploading-camera-picture-to-server.jpg?6141f6" alt=""></p>
<p><img src="http://cdn2.androidhive.info/wp-content/uploads/2014/12/android-uploading-camera-picture-to-server1.jpg?6141f6" alt=""></p>
<p><img src="http://cdn2.androidhive.info/wp-content/uploads/2014/12/android-uploading-camera-picture-to-server2.jpg?6141f6" alt=""></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ol>
<li><p><a href="http://stackoverflow.com/questions/22874735/upload-large-file-with-progress-bar-and-without-outofmemory-error-in-android" target="_blank" rel="external">Stackoverflow</a> 上有一个相关的使用进度条上传文件的问题</p>
</li>
<li><p>我在 App 中使用的<a href="https://www.iconfinder.com/icons/66782/file_upload_icon#size=128" target="_blank" rel="external">图标</a></p>
</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/上传拍下的照片、视频到服务器/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/上传拍下的照片、视频到服务器/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/你可能漏掉的知识点-onResumeFragments/" title="你可能漏掉的知识点onResumeFragments" itemprop="url">你可能漏掉的知识点onResumeFragments</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.randomlytyping.com/blog/2015/6/5/things-you-may-not-know-about-onresumefragments" target="_blank" rel="external">THINGS YOU MAY NOT KNOW: ONRESUMEFRAGMENTS</a></li>
</ul>
<p>长话短说：如果你在使用FragmentActivity的任何子类（比如最新的AppCompatActivity），并且你正在考虑要在onResume方法中做fragment transaction操作，那么请在onResumeFragment里做这件事情。</p>
<p>如果你想知道详情或者一些注意事项，继续阅读。如果不想，没关系，下篇文章见。</p>
<p>还在看？那么 ok。</p>
<p>onResume和onResumeFragments的区别是什么呢？下面是<a href="http://developer.android.com/reference/android/support/v4/app/FragmentActivity.html#onResume(" target="_blank" rel="external">官方文档</a>) 对FragmentActivity.onResume的解释：</p>
<blockquote>
<p>将onResume() 分发给fragment。注意，为了更好的和旧版本兼容，这个方法调用的时候，依附于这个activity的fragment并没有到resumed状态。着意味着在某些情况下，前面的状态可能被保存了，此时不允许fragment transaction再修改状态。从根本上说，你不能确保activity中的fragment在调用Activity的OnResume函数后是否是onresumed状态，因此你应该避免在执行fragment transactions直到调用了onResumeFragments函数。</p>
</blockquote>
<p>总的来说就是，你无法确定activity当前的fragment在activity onResume的时候也跟着resumed了，因此要避免在onResumeFragments之前进行fragment transaction，因为到onResumeFragments的时候，状态已经恢复并且它们的确是resumed了的。</p>
<p>这样做可以避免发生IllegalStateException异常，在一个fragment的状态已经保存的情况下（通过onSaveInstanceState），再试图进行fragment transaction操作就会抛出这个异常。<br>如果fragment的activity销毁并重建，前面保存的变量将丢失。要想更深的理解这个问题，可以阅读Alex Lockwood的 <a href="http://www.androiddesignpatterns.com/2013/08/fragment-transaction-commit-state-loss.html" target="_blank" rel="external">“Fragment Transactions 与 Activity状态的丢失”</a>  一文。</p>
<p>其实我是在知道fragments和 fragment transaction了很久之后才知道onResumeFragments这个东西的。activity的绝大部分生命周期中都不涉及到它，因为它只存在于兼容包里面的FragmentActivity，而SDK里面的Activity则没有。不过onResumeFragments仍然值得去了解。</p>
<p>说了这么多，我这几天只能给一点很粗贱的建议：尽可能的避免在生命周期事件中尤其是onResume或者onResumeFragments中进行fragment transaction，如果你正在考虑这样做，很可能你的UI和事务逻辑都需要反思一遍了。</p>
<p>不过那时以后要说的事了。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/你可能漏掉的知识点-onResumeFragments/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/你可能漏掉的知识点-onResumeFragments/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/使用Android-Studio进行单元测试/" title="使用Android Studio进行单元测试" itemprop="url">使用Android Studio进行单元测试</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://rexstjohn.com/unit-testing-with-android-studio/" target="_blank" rel="external">Unit Testing With Android Studio</a></li>
</ul>
<p>#在Android Studio中可以进行单元测试</p>
<p>很多教程都指导你应该在“build.gradlew”中添加几行代码来开启“instrument tests” 功能，而且还需要添加 Android 测试库的项目依赖。</p>
<p>其实你并不需要按照这种错误的方式去做，因为这是完全没有必要的。</p>
<p>Android Studio本身就支持Android单元测试，你只需要在你的项目中简单配置一下就可以了。</p>
<p>注意：还有好几种流行的Android单元测试框架，比如<a href="http://robolectric.org/" target="_blank" rel="external">Robolectric</a>，这些框架涉及到的配置和设置比我在这里提到的更多，我希望在未来可以以这个主题写一些指导教程。</p>
<p>#创建你的单元测试文件夹</p>
<p>我喜欢把单元测试放在我的主项目里面，比如“com.mypath.tests.” ，你可以把测试目录放到你想放的任何地方。在开始之前，像下面这样，先创建你的”test”文件夹。(译者注：这一步不是必须的，你也可以把单元测试类创建在与Android Studio默认的ApplicationTest类相同的路径下面)</p>
<p><img src="http://i2.tietuku.com/8ea1f7ff89634a0f.png" alt=""></p>
<p>接下来，创建一个叫做 “ExampleTest”的类，要继承自InstrumentationTestCase</p>
<p><img src="http://i2.tietuku.com/164d47e438f78f37.png" alt=""></p>
<p>然后可以添加一段简单的测试代码，我们知道这段代码肯定会运行失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class ExampleTest extends InstrumentationTestCase &#123;</div><div class="line">    public void test() throws Exception &#123;</div><div class="line">        final int expected = 1;</div><div class="line">        final int reality = 5;</div><div class="line">        assertEquals(expected, reality);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意：所有的测试方法必须以”test”开头，否则Android Studio不能找到要进行单元测试的方法，你将会得到各种各样的错误，并且无法正常执行。</p>
<p>#为你的项目配置单元测试</p>
<p>现在我们已经有了一个必然会运行失败的测试用例，我们必须把它run起来。</p>
<p>首先点击”Run-&gt; Edit Configurations”</p>
<p><img src="http://i2.tietuku.com/e91b3515dff21267.png" alt=""></p>
<p>然后点击“+”，从左上角选择添加一个 Android Tests，然后你可以将这个测试配置重新命名为”test”或与之相关的名字</p>
<p><img src="http://i2.tietuku.com/6f5c952065151e07.png" alt=""></p>
<p>然后就会创建如下的测试项目配置</p>
<p><img src="http://i2.tietuku.com/2183cac60bbed220.png" alt=""></p>
<p>从下拉菜单中选择你当前的module</p>
<p><img src="http://i2.tietuku.com/854bbdd0299ddb1c.png" alt=""></p>
<p>接下来，选择”All in Package”选项，然后把你的刚才创建的测试文件夹选中。你也可以选择“All in Module”选项，这样Android Studio会自动的找到你整个Module中的所有测试单元，你也可以通过更具体的类或者是方法选项，进一步缩小测试范围。</p>
<p>做完这一切之后，看起来应该像下面这样</p>
<p><img src="http://i2.tietuku.com/15039870f925e4e9.png" alt=""></p>
<p>我也喜欢选中下面的“Show chooser dialog”,这样当每次运行的时候，我可以指定如何去运行</p>
<p><img src="http://i2.tietuku.com/66d3e1d4a120df74.png" alt=""></p>
<p>现在点击”Apply”然后关闭，你现在应该可以看到你的测试案例已经作为一个可以运行的项目配置在Android Studio上面的工具栏上了</p>
<p><img src="http://i2.tietuku.com/6acd89afcb22309d.png" alt=""></p>
<p>#运行我们的单元测试</p>
<p>我使用Genymotion来完成所有的事情，所以开启你的Genymotion然后运行test</p>
<p>在assertion这一行添加一个断点，然后点击 “run debug mode”，目的是为了证明Android Studio确实执行了我们的单元测试。</p>
<p><img src="http://i2.tietuku.com/e91aefd47fe27e05.png" alt=""></p>
<p>当你开始你的测试工程之后，你会看到一个叫做“Running Tests…”的显示窗口</p>
<p><img src="http://i2.tietuku.com/2202b414f006234a.png" alt=""></p>
<p>当你的测试没有通过，点击“Logcat”然后查看综合的输出结果，看下我们测试失败的原因</p>
<p><img src="http://i2.tietuku.com/82cf59170999b096.png" alt=""></p>
<p>通过控制台，可以看到打印出的错误原因：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">“junit.framework.AssertionFailedError: expected:&lt;1&gt; but was:&lt;5&gt;”</div></pre></td></tr></table></figure>
<p>恭喜你，你已经成功测试出错误啦~</p>
<p>下面的这些资料在完成本文时，给了很大的帮助</p>
<ul>
<li><a href="http://mobilengineering.blogspot.com/2012/05/tdd-testing-asynctasks-on-android.html" target="_blank" rel="external">http://mobilengineering.blogspot.com/2012/05/tdd-testing-asynctasks-on-android.html</a></li>
<li><a href="http://www.vogella.com/tutorials/AndroidTesting/article.html" target="_blank" rel="external">http://www.vogella.com/tutorials/AndroidTesting/article.html</a></li>
<li><a href="http://nikolaj.hesselholtskov.dk/2013/10/how-to-add-unit-tests-to-android-studio.html" target="_blank" rel="external">http://nikolaj.hesselholtskov.dk/2013/10/how-to-add-unit-tests-to-android-studio.html</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/使用Android-Studio进行单元测试/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/使用Android-Studio进行单元测试/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/使用Mockito对异步方法进行单元测试/" title="使用Mockito对异步方法进行单元测试" itemprop="url">使用Mockito对异步方法进行单元测试</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://fernandocejas.com/2014/04/08/unit-testing-asynchronous-methods-with-mockito/" target="_blank" rel="external">Unit testing asynchronous methods with Mockito</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn。未经允许，不得转载!</a></li>
<li>译者 : <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a> </li>
</ul>
<p>之前我拍着胸脯承诺要维护的我博客，因此才有了这篇文章。但是请忘记我的那些承诺，我今天要写的是关于<a href="https://code.google.com/p/mockito/" target="_blank" rel="external">Mockito</a>,这是一个当你写单元测试时经常会用到的对象Mock框架。</p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a><strong>介绍</strong></h3><p>这篇文章假设你已经知道了什么是<a href="http://en.wikipedia.org/wiki/Unit_testing" target="_blank" rel="external">单元测试</a>以及为什么你要写单元测试。另外，我强烈建议你阅读<a href="http://martinfowler.com/articles/mocksArentStubs.html" target="_blank" rel="external">Martin<br>Fowler的这篇文章</a>。</p>
<h3 id="常见的场景"><a href="#常见的场景" class="headerlink" title="常见的场景"></a><strong>常见的场景</strong></h3><p>有些时候我们需要测试有回调的函数,这意味着它们是异步执行的。这些方法测试起来并不那么容易，使用<code>Thread.sleep(milliseconds)</code>来等待它们执行完成只能说是一种蹩脚的实现，并且会让你的测试具有不确定性。那么我们如何来对异步函数进行测试呢？<a href="https://code.google.com/p/mockito/" target="_blank" rel="external">Mockito</a>拯救了我们！</p>
<h3 id="翠花，上一个示例"><a href="#翠花，上一个示例" class="headerlink" title="翠花，上一个示例"></a>翠花，上一个示例</h3><p>假设我们有一个实现了<code>DummyCallback</code>接口的<code>DummyCaller</code>类，在<code>DummyCaller</code>中有一个<code>doSomethingAsynchronously()</code>函数，该函数会调用<code>DummyCollaborator</code>类的<code>doSomethingAsynchronously(DummyCallback callback)</code>函数，在调用该函数时将这个callback参数设置为该<code>DummyCaller</code>对象。当<code>doSomethingAsynchronously(DummyCallback callback)</code>的任务在后台线程中执行完成之后就会回调这个callback。</p>
<p> 还是直接看代码会更容易理解 : </p>
<p> DummyCallback接口 : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DummyCallback</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;String&gt; result)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFail</span><span class="params">(<span class="keyword">int</span> code)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DummyCaller类 : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DummyCaller</span> <span class="keyword">implements</span> <span class="title">DummyCallback</span> </span>&#123;</div><div class="line"> 	<span class="comment">// 执行异步操作的代理类</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> DummyCollaborator dummyCollaborator;</div><div class="line"> 	<span class="comment">// 执行结果</span></div><div class="line">	<span class="keyword">private</span> List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"> </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DummyCaller</span><span class="params">(DummyCollaborator dummyCollaborator)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.dummyCollaborator = dummyCollaborator;</div><div class="line">	&#125;</div><div class="line"> </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomethingAsynchronously</span><span class="params">()</span> </span>&#123;</div><div class="line">		dummyCollaborator.doSomethingAsynchronously(<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line"> </div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getResult</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.result;</div><div class="line">	&#125;</div><div class="line"> </div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;String&gt; result)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.result = result;</div><div class="line">		System.out.println(<span class="string">"On success"</span>);</div><div class="line">	&#125;</div><div class="line"> </div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFail</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"On Fail"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>真正的异步执行操作的DummyCollaborator类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DummyCollaborator</span> </span>&#123;</div><div class="line"> </div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> ERROR_CODE = <span class="number">1</span>;</div><div class="line"> </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DummyCollaborator</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// empty</span></div><div class="line">	&#125;</div><div class="line"> </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomethingAsynchronously</span> <span class="params">(<span class="keyword">final</span> DummyCallback callback)</span> </span>&#123;</div><div class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					Thread.sleep(<span class="number">5000</span>);</div><div class="line">					callback.onSuccess(Collections.EMPTY_LIST);</div><div class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					callback.onFail(ERROR_CODE);</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="创建我们的测试类"><a href="#创建我们的测试类" class="headerlink" title="创建我们的测试类"></a>创建我们的测试类</h3><p>我们有2种不同的选择来测试我们的异步函数，但是首先我们先创建一个DummyCollaboratorCallerTest测试类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DummyCollaboratorCallerTest</span> </span>&#123;</div><div class="line"> </div><div class="line">	<span class="comment">// 要测试的类型</span></div><div class="line">	<span class="keyword">private</span> DummyCaller dummyCaller;</div><div class="line"> </div><div class="line">	<span class="meta">@Mock</span></div><div class="line">	<span class="keyword">private</span> DummyCollaborator mockDummyCollaborator;</div><div class="line"> </div><div class="line">	<span class="meta">@Captor</span></div><div class="line">	<span class="keyword">private</span> ArgumentCaptor&lt;DummyCallback&gt; dummyCallbackArgumentCaptor;</div><div class="line"> </div><div class="line">	<span class="meta">@Before</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</div><div class="line">		MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">		dummyCaller = <span class="keyword">new</span> DummyCaller(mockDummyCollaborator);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在setup函数中我们使用MockitoAnotations来初始化 Mock和ArgumentCaptor,我们暂时还不需要关心它们。</p>
<p>在这里我们需要关心的是在测试执行之前初始化了Mock对象和被测试的类，这些初始化代码都在setup中。记住，所有要测试的函数都要被测试两次。</p>
<p>让我们来看看下面的两种测试方案。</p>
<h3 id="为我们的回调设置一个Anwser"><a href="#为我们的回调设置一个Anwser" class="headerlink" title="为我们的回调设置一个Anwser"></a>为我们的回调设置一个Anwser</h3><p>这是我们使用<code>doAnswer()</code>来为一个函数进行打桩以测试异步函数的测试用例。这意味着我们需要理解返回一个回调（同步的），当被测试的方法被调用时我们生成了一个通用的anwser,这个回调会被执行。</p>
<p>最后，我们调用了doSomethingAsynchronously函数，并且验证了状态和交互结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDoSomethingAsynchronouslyUsingDoAnswer</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> List&lt;String&gt; results = Arrays.asList(<span class="string">"One"</span>, <span class="string">"Two"</span>, <span class="string">"Three"</span>);</div><div class="line">	<span class="comment">// 为callback执行一个同步anwser</span></div><div class="line">	doAnswer(<span class="keyword">new</span> Answer() &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> Object <span class="title">answer</span><span class="params">(InvocationOnMock invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">			((DummyCallback)invocation.getArguments()[<span class="number">0</span>]).onSuccess(results);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;).when(mockDummyCollaborator).doSomethingAsynchronously(</div><div class="line">			any(DummyCallback.class));</div><div class="line"></div><div class="line">	<span class="comment">// 调用被测试的函数</span></div><div class="line">	dummyCaller.doSomethingAsynchronously();</div><div class="line"></div><div class="line">	<span class="comment">// 验证状态与结果</span></div><div class="line">	verify(mockDummyCollaborator, times(<span class="number">1</span>)).doSomethingAsynchronously(</div><div class="line">			any(DummyCallback.class));</div><div class="line">	assertThat(dummyCaller.getResult(), is(equalTo(results)));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>[译者注 : 在doAnswer函数中当调用mockDummyCollaborator对象的doSomethingAsynchronously (final DummyCallback callback)函数时会触发Answer匿名内部类的answer(InvocationOnMock invocation)函数]</code>。</p>
<h3 id="使用ArgumentCaptor"><a href="#使用ArgumentCaptor" class="headerlink" title="使用ArgumentCaptor"></a>使用ArgumentCaptor</h3><p>第二种实现是使用ArgumentCaptor。在这里我们的callback是异步的: 我们通过ArgumentCaptor捕获传递到DummyCollaborator对象的DummyCallback回调。</p>
<p>最终，我们可以在测试函数级别进行所有验证，当我们想验证状态和交互结果时可以调用<code>onSuccess()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDoSomethingAsynchronouslyUsingArgumentCaptor</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 调用要被测试发函数</span></div><div class="line">	dummyCaller.doSomethingAsynchronously();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> List&lt;String&gt; results = Arrays.asList(<span class="string">"One"</span>, <span class="string">"Two"</span>, <span class="string">"Three"</span>);</div><div class="line"></div><div class="line">	<span class="comment">// Let's call the callback. ArgumentCaptor.capture() works like a matcher.</span></div><div class="line">	verify(mockDummyCollaborator, times(<span class="number">1</span>)).doSomethingAsynchronously(</div><div class="line">			dummyCallbackArgumentCaptor.capture());</div><div class="line"></div><div class="line">	<span class="comment">// 在执行回调之前验证结果</span></div><div class="line">	assertThat(dummyCaller.getResult().isEmpty(), is(<span class="keyword">true</span>));</div><div class="line"></div><div class="line">	<span class="comment">// 调用回调的onSuccess函数</span></div><div class="line">	dummyCallbackArgumentCaptor.getValue().onSuccess(results);</div><div class="line"></div><div class="line">	<span class="comment">// 再次验证结果</span></div><div class="line">	assertThat(dummyCaller.getResult(), is(equalTo(results)));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a><strong>结论</strong></h3><p>两种实现的主要的不同点是当使用<a href="http://mockito.googlecode.com/svn/branches/1.6/javadoc/org/mockito/Mockito.html" target="_blank" rel="external">DoAnswer()</a>方案时我们创建了一个匿名内部类,并且将它的元素从<code>invocation.getArguments()[n]</code>转换到我们需要的类型，但是万一我们修改了我们的参数类型，那么这个测试就会’fail fast’。另一方面，当我们使用<a href="http://docs.mockito.googlecode.com/hg/org/mockito/ArgumentCaptor.html" target="_blank" rel="external">ArgumentCaptor</a>时我们可能能够更精细的控制测试用例，因为我们能在测试用例中手动调用回调对象。</p>
<p>面对这两种方案，有时候我们不知道作何选择，但是不用担心，因为这是一个常见的问题。以我们的经验来看，同时使用这两种方案来测试异步函数会是一个更可靠的途径。</p>
<p>我希望这篇文章对你有用，另外，请记住，欢迎给这篇文章的反馈，或许还有更好的实现。当然，如果你有任何的疑问也可以联系我。</p>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h3><p><a href="https://github.com/android10/Inside_Android_Testing" target="_blank" rel="external">代码这里</a>。这些代码都是关于Java和Android的，因为我们在几个月前做了一场相关的演讲。</p>
<h3 id="深入拓展"><a href="#深入拓展" class="headerlink" title="深入拓展"></a>深入拓展</h3><p>我强烈建议你阅读<a href="http://mockito.googlecode.com/svn/branches/1.6/javadoc/org/mockito/Mockito.html" target="_blank" rel="external">Mockito文档</a>以对这个框架有更深入的了解，这份文档非常清晰，并且有非常棒的示例！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/使用Mockito对异步方法进行单元测试/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/使用Mockito对异步方法进行单元测试/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/创建-RecyclerView-LayoutManager-Part-1/" title="创建一个 RecyclerView LayoutManager – Part 1" itemprop="url">创建一个 RecyclerView LayoutManager – Part 1</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://wiresareobsolete.com/2014/09/building-a-recyclerview-layoutmanager-part-1/" target="_blank" rel="external">Building a RecyclerView LayoutManager – Part 1</a></li>
<li>原文作者 : <a href="http://wiresareobsolete.com/" target="_blank" rel="external">Dave Smith</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/tiiime" target="_blank" rel="external">tiiime</a> </li>
<li>校对者: <a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a> </li>
<li>状态 :   完成 </li>
</ul>
<h1 id="Building-a-RecyclerView-LayoutManager-–-Part-1"><a href="#Building-a-RecyclerView-LayoutManager-–-Part-1" class="headerlink" title="Building a RecyclerView LayoutManager – Part 1"></a>Building a RecyclerView LayoutManager – Part 1</h1><blockquote>
<p>本文是这个系列中的 Part 1，这里是 <a href="../issue-13/创建-RecyclerView-LayoutManager-Part-2.md">Part 2</a> 和 <a href="../issue-13/创建-RecyclerView-LayoutManager-Part-3.md">Part 3</a> 的链接。</p>
</blockquote>
<p>现如今，如果你是 Android 开发者，你肯定听说过 RecyclerView 这个控件；<br>它是一个即将加入 support library 之中的新组件，<br>通过方便的视图复用轻松实现自定义高效的视图集。<br>已经有很多优秀的文章介绍了 RecyclerView 基础，讲解如何使用<br>RecyclerView 提供的内建部分，包括 item animations。所以，<br>我们就不再重复前人的工作了，下面是一些帮你入门的资料：</p>
<ul>
<li><a href="http://www.grokkingandroid.com/first-glance-androids-recyclerview/" target="_blank" rel="external">A First Glance at Android’s RecyclerView</a></li>
<li><a href="http://lucasr.org/2014/07/31/the-new-twowayview/" target="_blank" rel="external">The new TwoWayView</a></li>
<li><a href="https://github.com/gabrielemariotti/RecyclerViewItemAnimators" target="_blank" rel="external">RecyclerViewItemAnimators</a></li>
</ul>
<p>我们的这个系列文章会关注 RecyclerView 底层细节，涉及到创建你自己的<br>LayoutManager，做些比单一的 垂直/水平 滚动列表稍稍复杂的东西。</p>
<blockquote>
<p>在我们开始前，你需要知道  LayoutManager API  之所以能够让我们实现<br>强大复杂的布局是因为它只替你做了很少的工作；这就意味着<br>你不得不自己完成数量可观的代码。如果要在一个项目中使用自定义视图，<br>不要陷入过度优化或过度泛化代码之中。你只需要关心<br>在你的用例中需要实现的特性就可以了。</p>
</blockquote>
<h1 id="RecyclerView-Playground"><a href="#RecyclerView-Playground" class="headerlink" title="RecyclerView Playground"></a>RecyclerView Playground</h1><p>这个系列中所有的代码段都取自 <a href="https://github.com/devunwired/recyclerview-playground" target="_blank" rel="external">RecyclerView Playground sample</a> 这个项目，<br>示例应用里包含了各个方面使用 RecyclerView 的实例，从创建简单的 list<br>到自定义 LayoutManagers。</p>
<p>本文的代码来自 <code>FixedGridLayoutManager</code> ，一个可以垂直和水平<br>滚动的二维的网格布局。</p>
<blockquote>
<p>support library 里也有一个自定义的 LayoutManager；本质上<br>是一个自定义 vertical linear list  的实现：<br>[SDK_PATH]/extras/android/compatibility/samples/Support7Demos/src/com/example/android/supportv7/widget/RecyclerViewActivity.java</p>
<p>同时，Android L 和 新的 support libraries 可能还没加入 AOSP<br>之中，不过 RecyclerView 提供了 <strong>JAR</strong> 资源，可以在这里找到：<br>[SDK_PATH]/extras/android/m2repository/com/android/support/recyclerview-v7/21.0.0-rc1/recyclerview-v7-21.0.0-rc1-sources.jar</p>
</blockquote>
<h1 id="The-Recycler"><a href="#The-Recycler" class="headerlink" title="The Recycler"></a>The Recycler</h1><p>首先，了解下 API 的结构。当你需要从一个可能再生的前子视图中<br>回收旧的 view 或者 获取新的 view 时，<br>你的 LayoutManager 可以访问一个 <code>Recycler</code> 实例。</p>
<p>Recycler 也免掉了直接访问 view 当前适配器方法的麻烦。当你的<br>LayoutManager 需要一个新的子视图时，只要调用 <code>getViewForPosition()</code><br>这个方法，Recycler 会决定到底是从头创建一个新的视图<br>还是重用一个已存在的废弃视图。<br>你的 LayoutManager 需要及时将不再显示的视图传递给 Recycler，<br>避免 Recycler 创建不必要的 view 对象。</p>
<h2 id="Detach-vs-Remove"><a href="#Detach-vs-Remove" class="headerlink" title="Detach vs. Remove"></a>Detach vs. Remove</h2><p>布局更新时有两个方法处理已存在的子视图：detach 和<br>remove (分离和移除)。Detach 是一个轻量的记录 view 操作。<br>被 detach 的视图在你的代码返回前能够重新连接。可以通过 Recycler<br>在不 重新绑定/重新构建 子视图的情况下修改已连接子视图的索引。</p>
<p>Remove 意味着这个 view 已经不需要了。任何被永久移除的 view 都应该<br>放到 Recycler 中，方便以后重用，不过 API 并没有强制要求。<br>被 remove 的视图是否被回收取决于你。</p>
<h2 id="Scrap-vs-Recycle"><a href="#Scrap-vs-Recycle" class="headerlink" title="Scrap vs. Recycle"></a>Scrap vs. Recycle</h2><p>Recycler 有两级视图缓存系统： scrap heap 和 recycle pool (垃圾堆和回收池)，<br>Scrap heap 是一个轻量的集合，视图可以不经过适配器直接返回给<br>LayoutManager 。通常被 detach<br>但会在同一布局重新使用的视图会临时储存在这里。Recycle pool 存放的<br>是那些假定并没有得到正确数据(相应位置的数据)的视图，<br>因此它们都要经过适配器重新绑定后才能返回给 LayoutManager。</p>
<p>当要给 LayoutManager 提供一个新 view 时，Recycler 首先会<br>检查 scrap heap 有没有对应的 position/id；如果有对应的内容，<br>就直接返回数据不需要通过适配器重新绑定。如果没有的话，<br>Recycler 就会从 recycle pool 里弄一个合适的视图出来，<br>然后用 adapter 给它绑定必要的数据<br>(就是调用 <code>RecyclerView.Adapter.bindViewHolder()</code>) 再返回。<br>如果 recycle pool 中也不存在有效 view ，就会在绑定数据前<br>创建新的 view (就是 <code>RecyclerView.Adapter.createViewHolder()</code>)，<br>最后返回数据。</p>
<h2 id="经验法则"><a href="#经验法则" class="headerlink" title="经验法则"></a>经验法则</h2><p>只要你原意，LayoutManager 的 API 允许你独立完成所有这些任务，<br>所以可能的组合有点多。通常来说，<br>如果你想要临时整理并且希望稍后在同一布局中重新使用某个 view 的话，<br> 可以对它调用 <code>detachAndScrapView()</code> 。如果基于当前布局<br> 你不再需要某个 view 的话，对其调用 <code>removeAndRecycleView()</code>。</p>
<h1 id="Building-The-Core"><a href="#Building-The-Core" class="headerlink" title="Building The Core"></a>Building The Core</h1><p>LayoutManager 需要实时添加，测量和布局所有它需要的子视图。<br>当用户滚动屏幕时，布局管理器将来决定什么时候添加新的子视图，<br>什么时候可以 detach/scrap (分离/废弃)视图。</p>
<p>你需要实现下面这些方法创建一个可行的 LayoutManager 最小系统。</p>
<h4 id="generateDefaultLayoutParams"><a href="#generateDefaultLayoutParams" class="headerlink" title="generateDefaultLayoutParams()"></a>generateDefaultLayoutParams()</h4><p>事实上你只要重写这个方法你的 LayoutManager 就能编译通过了。<br>实现也很简单，返回一个你想要默认应用给所有从<br>Recycler 中获得的子视图做参数的 <code>RecyclerView.LayoutParams</code> 实例。<br>这些参数会在对应的 <code>getViewForPosition()</code> 返回前赋值给相应的子视图。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> RecyclerView.<span class="function">LayoutParams <span class="title">generateDefaultLayoutParams</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RecyclerView.LayoutParams(</div><div class="line">        RecyclerView.LayoutParams.WRAP_CONTENT,</div><div class="line">        RecyclerView.LayoutParams.WRAP_CONTENT);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="onLayoutChildren"><a href="#onLayoutChildren" class="headerlink" title="onLayoutChildren()"></a>onLayoutChildren()</h4><p><code>onLayoutChildren()</code> 是 LayoutManager 的主入口。<br>它会在 view 需要初始化布局时调用，<br>当适配器的数据改变时(或者整个适配器被换掉时)会再次调用。<br><strong>注意！这个方法不是在每次你对布局作出改变时调用的。</strong><br>它是 初始化布局 或者 在数据改变时重置子视图布局的好位置。</p>
<p>在接下来的部分，我们会分析在适配器更新时<br>是怎样使用它基于当前可见元素刷新布局的。<br>现在，我们将简单地解决这个问题当做子视图布局第一关。<br>下面是 <code>FixedGridLayoutManager</code> 示例的精简版：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> </span>&#123;</div><div class="line">    <span class="comment">//Scrap measure one child</span></div><div class="line">    View scrap = recycler.getViewForPosition(<span class="number">0</span>);</div><div class="line">    addView(scrap);</div><div class="line">    measureChildWithMargins(scrap, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * We make some assumptions in this code based on every child</div><div class="line">     * view being the same size (i.e. a uniform grid). This allows</div><div class="line">     * us to compute the following values up front because they</div><div class="line">     * won't change.</div><div class="line">     */</div><div class="line">    mDecoratedChildWidth = getDecoratedMeasuredWidth(scrap);</div><div class="line">    mDecoratedChildHeight = getDecoratedMeasuredHeight(scrap);</div><div class="line">    detachAndScrapView(scrap, recycler);</div><div class="line">    </div><div class="line">    updateWindowSizing();</div><div class="line">    <span class="keyword">int</span> childLeft;</div><div class="line">    <span class="keyword">int</span> childTop;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Reset the visible and scroll positions</div><div class="line">     */</div><div class="line">    mFirstVisiblePosition = <span class="number">0</span>;</div><div class="line">    childLeft = childTop = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//Clear all attached views into the recycle bin</span></div><div class="line">    detachAndScrapAttachedViews(recycler);</div><div class="line">    <span class="comment">//Fill the grid for the initial layout of views</span></div><div class="line">    fillGrid(DIRECTION_NONE, childLeft, childTop, recycler);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们会对子视图做一些记录和安排<br>(为了简便，假设来自适配器的所有子视图都是一样大的)，<br>确保所有已存在的视图在 scrap heap 之中。我将<br>大部分工作抽象到 <code>fillGrid()</code> 这个辅助方法中以便重用。<br>我们很快就会看到这个方法在更新可见视图和滚动屏幕中被大量调用。</p>
<blockquote>
<p>就像是自定义实现一个 ViewGroup，你负责触发测量和布局每一个<br>从 Recycler 获取到的子视图。API 没有直接完成这项工作 。</p>
</blockquote>
<p>通常来说，在这类方法之中你需要完成的主要步骤如下：</p>
<ol>
<li>在滚动事件结束后检查所有附加视图当前的偏移位置。</li>
<li>判断是否需要添加新视图填充由滚动屏幕产生的空白部分。并从<br>Recycler 中获取视图。</li>
<li>判断当前视图是否不再显示。移除它们并放置到 Recycler 中。</li>
<li>判断剩余视图是否需要整理。发生上述变化后可能<br>需要你修改视图的子索引来更好地和它们的适配器位置校准。</li>
</ol>
<p>注意我们放进 <code>FixedGridLayoutManager.fillGrid()</code> 里填充 RecyclerView 的主要步骤。<br>当到达最大行数时，这个 manager 将位置从右到左排序，封装。</p>
<ol>
<li><p>清点目前我们所有的视图。将他们 Detach 以便稍后重新连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">SparseArray&lt;View&gt; viewCache = <span class="keyword">new</span> SparseArray&lt;View&gt;(getChildCount());</div><div class="line"><span class="comment">//...</span></div><div class="line"><span class="keyword">if</span> (getChildCount() != <span class="number">0</span>) &#123;</div><div class="line">	<span class="comment">//...</span></div><div class="line">	<span class="comment">//Cache all views by their existing position, before updating counts</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; getChildCount(); i++) &#123;</div><div class="line">		<span class="keyword">int</span> position = positionOfIndex(i);</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		viewCache.put(position, child);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//Temporarily detach all views.</span></div><div class="line">	<span class="comment">// Views we still need will be added back at the proper index.</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; viewCache.size(); i++) &#123;</div><div class="line">		detachView(viewCache.valueAt(i));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>测量/布局每一个当前可见的子视图。重新连接已有的视图很简单；<br>新的视图是从 Recycler 之中获取的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getVisibleChildCount(); i++) &#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="comment">//Layout this position</span></div><div class="line">    View view = viewCache.get(nextPosition);</div><div class="line">    <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">/*</span></div><div class="line">* The Recycler will give us either a newly constructed view,</div><div class="line">         * or a recycled view it has on-hand. In either case, the</div><div class="line">         * view will already be fully bound to the data by the</div><div class="line">         * adapter for us.</div><div class="line">         */</div><div class="line">        view = recycler.getViewForPosition(nextPosition);</div><div class="line">        addView(view);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * It is prudent to measure/layout each new view we</div><div class="line">         * receive from the Recycler. We don't have to do</div><div class="line">         * this for views we are just re-arranging.</div><div class="line">         */</div><div class="line">        measureChildWithMargins(view, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        layoutDecorated(view, leftOffset, topOffset,</div><div class="line">                leftOffset + mDecoratedChildWidth,</div><div class="line">                topOffset + mDecoratedChildHeight);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//Re-attach the cached view at its new index</span></div><div class="line">        attachView(view);</div><div class="line">        viewCache.remove(nextPosition);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>最终，所有在第一步中 detach 并且没有被重新连接的视图都不可见。<br>将它们移入 Recycler 中，以备后用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; viewCache.size(); i++) &#123;</div><div class="line">    recycler.recycleView(viewCache.valueAt(i));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>说明一下，先将所有视图 detach 之后再将需要的视图重新连接是为了<br>保持每一个视图子索引的顺序 (就是  <code>getChildAt()</code> 的索引)。我们希望<br>可见视图从左上到右下的索引从 <code>0</code> 开始，到 <code>getChildCount()-1</code> 结束。<br>当我们上下滑动视图，新的子视图被添加，它的索引顺序会变得不可靠。<br>我们需要保留正确的索引来在任意点上定位每一个视图。在一个简单地<br>LayoutManager (比如 LinearLayoutManager)中，子视图可以轻松地插入<br>list 的两端， 记录层就没有存在的必要了。</p>
<h1 id="添加用户交互"><a href="#添加用户交互" class="headerlink" title="添加用户交互"></a>添加用户交互</h1><p>目前，我们已经有一个非常好的初始布局，但是它并不能动起来。<br>RecyclerView 的关键就在于当用户浏览一组数据时动态提供视图。<br>覆盖一些方法就能实现我们的目的。</p>
<h4 id="canScrollHorizontally-amp-canScrollVertically"><a href="#canScrollHorizontally-amp-canScrollVertically" class="headerlink" title="canScrollHorizontally() &amp; canScrollVertically()"></a>canScrollHorizontally() &amp; canScrollVertically()</h4><p>这些方法很简单，在你想要滚动方向对应的方法里返回 true ，<br>不想要滚动方向对应的方法里返回 false。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canScrollVertically</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//We do allow scrolling</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="scrollHorizontallyBy-amp-scrollVerticallyBy"><a href="#scrollHorizontallyBy-amp-scrollVerticallyBy" class="headerlink" title="scrollHorizontallyBy() &amp; scrollVerticallyBy()"></a>scrollHorizontallyBy() &amp; scrollVerticallyBy()</h4><p>在这里你应该实现 content 移动的逻辑。RecyclerView 已经处理了 scrolling<br>和 <a href="http://www.google.com/design/spec/patterns/gestures.html#gestures-touch-mechanics" target="_blank" rel="external">flinging</a> (注：Fling: Gross gesture, no on-screen target)<br>触摸操作，不需要处理 MotionEvents 或者 GestureDetectors 这些麻烦事。<br>你只需要完成下面这三个任务：</p>
<ol>
<li>将所有的子视图移动适当的位置 (对的，你得自己做这个)。</li>
<li>决定移动视图后 添加/移除 视图。</li>
<li>返回滚动的实际距离。框架会根据它判断你是否触碰到边界。</li>
</ol>
<p>在 FixedGridLayoutManager 里，这两个方法很像。这里是精简后的垂直滚动实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">scrollVerticallyBy</span><span class="params">(<span class="keyword">int</span> dy, RecyclerView.Recycler recycler,</span></span></div><div class="line">        RecyclerView.State state) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (getChildCount() == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Take top measurements from the top-left child</span></div><div class="line">    <span class="keyword">final</span> View topView = getChildAt(<span class="number">0</span>);</div><div class="line">    <span class="comment">//Take bottom measurements from the bottom-right child.</span></div><div class="line">    <span class="keyword">final</span> View bottomView = getChildAt(getChildCount()-<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">//Optimize the case where the entire data set is too small to scroll</span></div><div class="line">    <span class="keyword">int</span> viewSpan = getDecoratedBottom(bottomView) - getDecoratedTop(topView);</div><div class="line">    <span class="keyword">if</span> (viewSpan &lt;= getVerticalSpace()) &#123;</div><div class="line">        <span class="comment">//We cannot scroll in either direction</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> delta;</div><div class="line">    <span class="keyword">int</span> maxRowCount = getTotalRowCount();</div><div class="line">    <span class="keyword">boolean</span> topBoundReached = getFirstVisibleRow() == <span class="number">0</span>;</div><div class="line">    <span class="keyword">boolean</span> bottomBoundReached = getLastVisibleRow() &gt;= maxRowCount;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (dy &gt; <span class="number">0</span>) &#123; <span class="comment">// Contents are scrolling up</span></div><div class="line">        <span class="comment">//Check against bottom bound</span></div><div class="line">        <span class="keyword">if</span> (bottomBoundReached) &#123;</div><div class="line">            <span class="comment">//If we've reached the last row, enforce limits</span></div><div class="line">            <span class="keyword">int</span> bottomOffset;</div><div class="line">            <span class="keyword">if</span> (rowOfIndex(getChildCount() - <span class="number">1</span>) &gt;= (maxRowCount - <span class="number">1</span>)) &#123;</div><div class="line">                <span class="comment">//We are truly at the bottom, determine how far</span></div><div class="line">                bottomOffset = getVerticalSpace() - getDecoratedBottom(bottomView)</div><div class="line">                        + getPaddingBottom();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Extra space added to account for allowing bottom space in the grid.</div><div class="line">                 * This occurs when the overlap in the last row is not large enough to</div><div class="line">                 * ensure that at least one element in that row isn't fully recycled.</div><div class="line">                 */</div><div class="line">                bottomOffset = getVerticalSpace() - (getDecoratedBottom(bottomView)</div><div class="line">                        + mDecoratedChildHeight) + getPaddingBottom();</div><div class="line">            &#125;</div><div class="line">            delta = Math.max(-dy, bottomOffset);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//No limits while the last row isn't visible</span></div><div class="line">            delta = -dy;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// Contents are scrolling down</span></div><div class="line">        <span class="comment">//Check against top bound</span></div><div class="line">        <span class="keyword">if</span> (topBoundReached) &#123;</div><div class="line">            <span class="keyword">int</span> topOffset = -getDecoratedTop(topView) + getPaddingTop();</div><div class="line">            delta = Math.min(-dy, topOffset);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            delta = -dy;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    offsetChildrenVertical(delta);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (dy &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (getDecoratedBottom(topView) &lt; <span class="number">0</span> &amp;&amp; !bottomBoundReached) &#123;</div><div class="line">            fillGrid(DIRECTION_DOWN, recycler);</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!bottomBoundReached) &#123;</div><div class="line">            fillGrid(DIRECTION_NONE, recycler);</div><div class="line">         &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (getDecoratedTop(topView) &gt; <span class="number">0</span> &amp;&amp; !topBoundReached) &#123;</div><div class="line">            fillGrid(DIRECTION_UP, recycler);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!topBoundReached) &#123;</div><div class="line">            fillGrid(DIRECTION_NONE, recycler);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Return value determines if a boundary has been reached</div><div class="line">     * (for edge effects and flings). If returned value does not</div><div class="line">     * match original delta (passed in), RecyclerView will draw</div><div class="line">     * an edge effect.</div><div class="line">     */</div><div class="line">    <span class="keyword">return</span> -delta;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们获得了滚动距离(dx/dy)的增量来验证。方法的第一部分判断<br>按照所给的距离(标志给了滚动方向)滚动会不会超过边界。如果会，<br>我们需要计算出视图实际滚动的距离。</p>
<p>在这个方法里，我们需要自己手工移动这些视图。<br><code>offsetChildrenVertical()</code> 和 <code>offsetChildrenHorizontal()</code><br>这两个方法 可以帮助我们处理匀速移动。<br><strong>如果你不实现它，你的视图就不会滚动</strong>。<br>移动视图操作完成后，我们触发另一个填充操作，<br>根据滚动的距离替换视图。</p>
<p>最后，将实际位移距离应用给子视图。RecyclerView 根据这个值判断是否<br>绘制到达边界的效果。一般意义上，如果返回值不等于传入的值就意味着<br>需要绘制边缘的发光效果了。<br><strong>如果你返回了一个带有错误方向的值，框架的函数会把这个当做一个大的变化<br>你将不能获得正确的边缘发光特效。</strong></p>
<p>除了用来判断绘制边界特效外，返回值还被用来决定什么时候取消 flings。<br>返回错误的值会让你失去对 content  fling 的控制。框架会认为你已经提前<br>触碰到边缘并取消了 fling。</p>
<p>#热身结束~</p>
<p>目前，我们已经实现了基本的功能。它少了很多的细节部分，<br>不过滚动和适当的视图回收已经完成了。<br>关于自定义 LayoutManager 还有很多要说的东西。<br><a href="../issue-13/创建-RecyclerView-LayoutManager-Part-2.md">接下来</a>，我们会细致的介绍 decorations, data set changes<br>还有实现滚动到特定位置。</p>
<hr>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/创建-RecyclerView-LayoutManager-Part-1/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/创建-RecyclerView-LayoutManager-Part-1/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/创建-RecyclerView-LayoutManager-Redux/" title="创建-RecyclerView-LayoutManager-Redux" itemprop="url">创建-RecyclerView-LayoutManager-Redux</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://wiresareobsolete.com/2015/02/recyclerview-layoutmanager-redux/" target="_blank" rel="external">Building A RecyclerView LayoutManager – Redux</a></li>
<li>原文作者 : <a href="http://wiresareobsolete.com/" target="_blank" rel="external">Dave Smith</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a> </li>
<li>校对者: <a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a>  </li>
<li>状态 :  完成 </li>
</ul>
<p>这篇文章是RecyclerView系列文章的结尾篇。前三部分的链接在这里 :       </p>
<ul>
<li><a href="../issue-9/创建-RecyclerView-LayoutManager-Part-1.md">第一部分</a></li>
<li><a href="./创建-RecyclerView-LayoutManager-Part-2.md">第二部分</a></li>
<li><a href="./创建-RecyclerView-LayoutManager-Part-3.md">第三部分</a></li>
</ul>
<p>当我在写这个系列的最后一篇文章，也就是关于predictIve animation的讨论时，我突然想到几个很有意思的点，并且很有讨论价值。这个系列文章以调查RecyclerView是否能够以简单的方式满足竖向、横向滚动的布局需求以及开发者要定制一个LayoutManager的难度有多大开始。这篇文章中我选择了一个基本的网格布局作为自定义layoutManager的示例。</p>
<p>下面这幅图展示了运用这个自定义LayoutManager到RecyclerView的滚动效果。       </p>
<p><img src="http://i.embed.ly/1/display/resize?url=http%3A%2F%2Fwiresareobsolete.com%2Fwp-content%2Fuploads%2F2015%2F02%2FGridWindow.gif&amp;grow=true&amp;key=92b31102528511e1a2ec4040d3dc5c07&amp;height=400" alt=""></p>
<h2 id="打破常规设计"><a href="#打破常规设计" class="headerlink" title="打破常规设计"></a>打破常规设计</h2><p>无论你打算如何组织Adapter的位置（从左到右，上到下等等）,内容视图的视角都是显示部分不连贯数据集的区域。更确切地说，在第一个和最后一个可视位置之间的Adapter区域的数据项也会在可视区域view的外面。 </p>
<p>这是一个很重要的点，因为它与在单轴上滚动的布局大相径庭（从而导致与当前框架下提供的默认布局背道而驰）。这些标准小工具显示，数据集是在一个连接块范围内–从第一个到最后一个可视位置之间不间断。</p>
<p>RecyclerView LayoutManager API会假定有一个可见的数据集合，RecyclerView LayoutManager只会显示数据集合中某个范围内可见的数据项，然后产生一个像上述所展示的网格布局一样的布局效果，这稍微有那么点挑战。在predictive animation里没有什么比这部分更加明显了。为了便于扩展，我感觉在这里指出这些毛病是非常必要的。</p>
<h2 id="假设1-：-从不可见区域移除一个数据项不会影响当前可见的View"><a href="#假设1-：-从不可见区域移除一个数据项不会影响当前可见的View" class="headerlink" title="假设1 ： 从不可见区域移除一个数据项不会影响当前可见的View"></a>假设1 ： 从不可见区域移除一个数据项不会影响当前可见的View</h2><p>当你考虑到一个Adapter移除一个数据项时LinearLayoutManager或者GridLayoutManager会做何反应时，这两个LayoutManager实际上都处理得非常好。如果被移除的数据项是可见的，一个可用的区域将会空置出来，此时就需要一个周边的View进行填充。这意味着周边显示的View必须被布局到这个位置以填补缺口。然而，并没有一个示例表明当一个移除操作执行时会发送一个隐藏视图的操作，唯一被隐藏的视图是那些被显式移除的。如果被移除的View在可见区域之外，那么对于可见区域的布局不会产生影响。在这个情况之下，你不会看到任何动画，它可能做出的修改是数据项被移到其他位置。</p>
<p>从上述的情况看，这与文章开头我们提到的一样，LayoutManager显示的是一个不连续的数据项。然而，这一可视区域的不连续本质使得数据项在屏幕外从可视区域内移除！换种说法，它们的位置处于第一个和最后一个位置之间，但是目前数据项view并不在布局中。这导致的结果就是，屏幕外发生的数据项移除可以并且会影响我们在布局动画处理时view的生成和消失。</p>
<p>在有机会对view的生成进行布局时，预布局是RecyclerView动画的关键阶段。RecyclerView通过其初始位置值将view返回，据此我们可以将内容布局在其初始状态。但是，当view移除与可视区域不相交时。RecyclerView就会通过其最终位置值将view返回。这样一来，在没有附加记账的情况下处理view的生成就变得困难得多。不过话说回来，难是难，也还是可以做到。</p>
<p>在上一篇文章中我们看到的FixedGridLayoutManager，我们不仅要解析可视view，还要听从onItemsRemoved()的回调来找到移除点，并妥当处理所有生成的view案例。RecyclerView确保我们在需要时，该回调会在预布局之前出现（屏幕外案例），但相反情况下会在预布局之后出现。RecyclerView这么做是为了避免这些事件与你的布局产生冲突–其时间点对我们来说只是一个美丽的意外。</p>
<p>我们还需要追踪的一个事实就是，可视移除会以一种我们意料之中的方式偏移view的位置，而屏幕外移除则不会。这也是为什么移除会被冠以不同类型的原因。上一篇文章忽略的一点表明，在屏幕外进行移除时，我们会对view生成逻辑提供一个手动偏移。。。所以当移除可视时，位置之间会相互匹配。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fillGrid</span><span class="params">(<span class="keyword">int</span> direction, <span class="keyword">int</span> emptyLeft, <span class="keyword">int</span> emptyTop, RecyclerView.Recycler recycler,</span></span></div><div class="line">        <span class="keyword">boolean</span> preLayout, SparseIntArray removedPositions) &#123;</div><div class="line">    …</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getVisibleChildCount(); i++) &#123;</div><div class="line">        <span class="keyword">int</span> nextPosition = positionOfIndex(i);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * When a removal happens out of bounds, the pre-layout positions of items</div><div class="line">         * after the removal are shifted to their final positions ahead of schedule.</div><div class="line">         * We have to track off-screen removals and shift those positions back</div><div class="line">         * so we can properly lay out all current (and appearing) views in their</div><div class="line">         * initial locations.</div><div class="line">         */</div><div class="line">        <span class="keyword">int</span> offsetPositionDelta = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (preLayout) &#123;</div><div class="line">            <span class="keyword">int</span> offsetPosition = nextPosition;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> offset = <span class="number">0</span>; offset &lt; removedPositions.size(); offset++) &#123;</div><div class="line">                <span class="comment">//Look for off-screen removals that are less-than this</span></div><div class="line">                <span class="keyword">if</span> (removedPositions.valueAt(offset) == REMOVE_INVISIBLE</div><div class="line">                        &amp;&amp; removedPositions.keyAt(offset) &lt; nextPosition) &#123;</div><div class="line">                    <span class="comment">//Offset position to match</span></div><div class="line">                    offsetPosition--;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            offsetPositionDelta = nextPosition - offsetPosition;</div><div class="line">            nextPosition = offsetPosition;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (nextPosition &lt; <span class="number">0</span> || nextPosition &gt;= getItemCount()) &#123;</div><div class="line">            <span class="comment">//Item space beyond the data set, don't attempt to add a view</span></div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        …</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (i % mVisibleColumnCount == (mVisibleColumnCount - <span class="number">1</span>)) &#123;</div><div class="line">            leftOffset = startLeftOffset;</div><div class="line">            topOffset += mDecoratedChildHeight;</div><div class="line"></div><div class="line">            <span class="comment">//During pre-layout, on each column end, apply any additional appearing views</span></div><div class="line">            <span class="keyword">if</span> (preLayout) &#123;</div><div class="line">                layoutAppearingViews(recycler, view, nextPosition, removedPositions.size(), offsetPositionDelta);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            leftOffset += mDecoratedChildWidth;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    …</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>之后offsetPositionDelta值会作为我们在预布局中使用到的行/列位置的全局偏移被传递到layoutAppearingViews()。如果不是出于附加记账要求，这一偏移完全可以不必存在。</p>
<h2 id="假设-2：添加新的数据项只会导致同级view的消失，而不是生成。"><a href="#假设-2：添加新的数据项只会导致同级view的消失，而不是生成。" class="headerlink" title="假设#2：添加新的数据项只会导致同级view的消失，而不是生成。"></a>假设#2：添加新的数据项只会导致同级view的消失，而不是生成。</h2><p>添加了新的数据项之后，反面为真。如果在添加时数据项为可视，那么标准布局管理器会在屏幕外推开不可视的view以便腾出空间。之前没有出现过关于这种行为会同时触发一个或多个同级view滑向可视子类位置的案例。移除也是同样的道理，在可视区域外添加数据项并不会影响可视view，所以通常来说动画也不会起作用。</p>
<p>对于FixedGridLayoutManager或其他任何非连贯区域的布局，在可视区域内还是可视区域外进行添加并没有多大差别。两种情况中我们都需要管理可能出现的view生成和消失。而我们在移除中使用的方案在这里则不可行，因为onItemsAdded()总是在预布局之后被调用。。。这一次我们就没那么幸运地再一次能够碰到美丽的意外了。</p>
<p>缺少了那次回调，关于添加数据项，我们实际上在预布局时就没有多少可做的了。这样一来就变成了布局额外的view以备不时之需，而不布局一定量的额外view就会损害性能这两种情况之间的妥协。FixedGridLayoutManager在添加数据项时不支持预测view生成。</p>
<h2 id="一切才刚刚开始"><a href="#一切才刚刚开始" class="headerlink" title="一切才刚刚开始"></a>一切才刚刚开始</h2><p>RecyclerView APIs是一个新生事物，现有案例中还有非常多的地方需要改进的。同时，它也非常复杂，想要做对并不容易。表面上看起来RecyclerView要求大家付出的努力，背后可能大家要花10倍的精力才能实现。而且这些类型越到后面可能月蛋疼。希望正在尝试这种做法的各位同仁可以视本文为一个预警，不要盲目浪费时间，但同时我们也期待这这个框架的日渐成熟。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/创建-RecyclerView-LayoutManager-Redux/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/创建-RecyclerView-LayoutManager-Redux/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/创建-RecyclerView-LayoutManager-Part-2/" title="创建 RecyclerView LayoutManager – Part 2" itemprop="url">创建 RecyclerView LayoutManager – Part 2</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://wiresareobsolete.com/2014/09/recyclerview-layoutmanager-2/" target="_blank" rel="external">Building a RecyclerView LayoutManager – Part 2</a></li>
<li>原文作者 : <a href="http://wiresareobsolete.com/" target="_blank" rel="external">Dave Smith</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/tiiime" target="_blank" rel="external">tiiime</a> </li>
<li>校对者:<a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a> </li>
<li>状态 :   完成 </li>
</ul>
<h1 id="创建-a-RecyclerView-LayoutManager-–-Part-2"><a href="#创建-a-RecyclerView-LayoutManager-–-Part-2" class="headerlink" title="创建 a RecyclerView LayoutManager – Part 2"></a>创建 a RecyclerView LayoutManager – Part 2</h1><blockquote>
<p>本文是这个系列中的 Part 2，这里是 <a href="../issue-9/创建-RecyclerView-LayoutManager-Part-1.md">Part 1</a> 和 <a href="./创建-RecyclerView-LayoutManager-Part-3.md">Part 3</a> 的链接。</p>
</blockquote>
<p>上次我们讲了创建一个 RecyclerView LayoutManager 的核心步骤。接下来，<br>我们会介绍如何给普通基于适配器的 View 加入一些附加特性。</p>
<blockquote>
<p>友情提醒：示例中的代码在这里 <a href="https://github.com/devunwired/recyclerview-playground" target="_blank" rel="external">Github</a></p>
</blockquote>
<hr>
<p>#Item Decorations 支持</p>
<p>RecyclerView 有一个很好的特性 <code>RecyclerView.ItemDecoration</code>，它可以给<br>子视图添加自定义样式，还可以在不修改子视图布局参数的情况下插入<br>布局属性(margins)。后者就是 LayoutManager 必须提供的约束子视图布局方式。</p>
<hr>
<blockquote>
<p><a href="https://github.com/devunwired/recyclerview-playground" target="_blank" rel="external">RecyclerPlayground </a> 里有几个 decorator 用来介绍它们的实现方式。</p>
</blockquote>
<p>LayoutManager 中提供了一些辅助方法操作 decorations ，不需要我们自己实现：</p>
<ul>
<li>用<code>getDecoratedLeft()</code>代替<code>child.getLeft()</code>获取子视图的 left 边缘。</li>
<li>用<code>getDecoratedTop()</code>代替<code>getTop()</code>获取子视图的 top 边缘。</li>
<li>用<code>getDecoratedRight()</code>代替<code>getRight()</code>获取子视图的 right 边缘。</li>
<li>用<code>getDecoratedBottom()</code>代替<code>getBottom()</code>获取子视图的 bottom 边缘。</li>
<li>使用 <code>measureChild()</code> 或 <code>measureChildWithMargins()</code> 代替<code>child.measure()</code><br>测量来自 Recycler 的新视图。</li>
<li>使用<code>layoutDecorated()</code>代替 <code>child.layout()</code> 布局来自 Recycler 的新视图。</li>
<li>使用  <code>getDecoratedMeasuredWidth()</code>或 <code>getDecoratedMeasuredHeight()</code><br>代替 <code>child.getMeasuredWidth()</code>或<code>child.getMeasuredHeight()</code>获取<br>子视图的测量数据。</li>
</ul>
<p>只要你使用了正确的方法去获取视图的属性和测量数据，RecyclerView 会自己搞定细节部分的处理。</p>
<hr>
<p>#数据集改变</p>
<p>当使用 <code>notifyDataSetChanged()</code>触发 <code>RecyclerView.Adapter</code> 的更新操作时，<br>LayoutManager 负责更新布局中的视图。这时，<code>onLayoutChildren()</code>会被再次调用。<br>实现这个功能需要我们调整代码，判断出当前状态是生成一个新的视图 还是 adapter<br>更新期间的视图改变。下面是<code>FixedGridLayoutManager</code>中的填充方法的完整实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> </span>&#123;</div><div class="line">    <span class="comment">//We have nothing to show for an empty data set but clear any existing views</span></div><div class="line">    <span class="keyword">if</span> (getItemCount() == <span class="number">0</span>) &#123;</div><div class="line">        detachAndScrapAttachedViews(recycler);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//...on empty layout, update child size measurements</span></div><div class="line">    <span class="keyword">if</span> (getChildCount() == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//Scrap measure one child</span></div><div class="line">        View scrap = recycler.getViewForPosition(<span class="number">0</span>);</div><div class="line">        addView(scrap);</div><div class="line">        measureChildWithMargins(scrap, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * We make some assumptions in this code based on every child</div><div class="line">         * view being the same size (i.e. a uniform grid). This allows</div><div class="line">         * us to compute the following values up front because they</div><div class="line">         * won't change.</div><div class="line">         */</div><div class="line">        mDecoratedChildWidth = getDecoratedMeasuredWidth(scrap);</div><div class="line">        mDecoratedChildHeight = getDecoratedMeasuredHeight(scrap);</div><div class="line"></div><div class="line">        detachAndScrapView(scrap, recycler);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    updateWindowSizing();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> childLeft;</div><div class="line">    <span class="keyword">int</span> childTop;</div><div class="line">    <span class="keyword">if</span> (getChildCount() == <span class="number">0</span>) &#123; <span class="comment">//First or empty layout</span></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Reset the visible and scroll positions</div><div class="line">         */</div><div class="line">        mFirstVisiblePosition = <span class="number">0</span>;</div><div class="line">        childLeft = childTop = <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getVisibleChildCount() &gt; getItemCount()) &#123;</div><div class="line">        <span class="comment">//Data set is too small to scroll fully, just reset position</span></div><div class="line">        mFirstVisiblePosition = <span class="number">0</span>;</div><div class="line">        childLeft = childTop = <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//Adapter data set changes</span></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Keep the existing initial position, and save off</div><div class="line">         * the current scrolled offset.</div><div class="line">         */</div><div class="line">        <span class="keyword">final</span> View topChild = getChildAt(<span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (mForceClearOffsets) &#123;</div><div class="line">            childLeft = childTop = <span class="number">0</span>;</div><div class="line">            mForceClearOffsets = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            childLeft = getDecoratedLeft(topChild);</div><div class="line">            childTop = getDecoratedTop(topChild);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Adjust the visible position if out of bounds in the</div><div class="line">         * new layout. This occurs when the new item count in an adapter</div><div class="line">         * is much smaller than it was before, and you are scrolled to</div><div class="line">         * a location where no items would exist.</div><div class="line">         */</div><div class="line">        <span class="keyword">int</span> lastVisiblePosition = positionOfIndex(getVisibleChildCount() - <span class="number">1</span>);</div><div class="line">        <span class="keyword">if</span> (lastVisiblePosition &gt;= getItemCount()) &#123;</div><div class="line">            lastVisiblePosition = (getItemCount() - <span class="number">1</span>);</div><div class="line">            <span class="keyword">int</span> lastColumn = mVisibleColumnCount - <span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> lastRow = mVisibleRowCount - <span class="number">1</span>;</div><div class="line"></div><div class="line">            <span class="comment">//Adjust to align the last position in the bottom-right</span></div><div class="line">            mFirstVisiblePosition = Math.max(</div><div class="line">                    lastVisiblePosition - lastColumn - (lastRow * getTotalColumnCount()), <span class="number">0</span>);</div><div class="line"></div><div class="line">            childLeft = getHorizontalSpace() - (mDecoratedChildWidth * mVisibleColumnCount);</div><div class="line">            childTop = getVerticalSpace() - (mDecoratedChildHeight * mVisibleRowCount);</div><div class="line"></div><div class="line">            <span class="comment">//Correct cases where shifting to the bottom-right overscrolls the top-left</span></div><div class="line">            <span class="comment">// This happens on data sets too small to scroll in a direction.</span></div><div class="line">            <span class="keyword">if</span> (getFirstVisibleRow() == <span class="number">0</span>) &#123;</div><div class="line">                childTop = Math.min(childTop, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (getFirstVisibleColumn() == <span class="number">0</span>) &#123;</div><div class="line">                childLeft = Math.min(childLeft, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Clear all attached views into the recycle bin</span></div><div class="line">    detachAndScrapAttachedViews(recycler);</div><div class="line"></div><div class="line">    <span class="comment">//Fill the grid for the initial layout of views</span></div><div class="line">    fillGrid(DIRECTION_NONE, childLeft, childTop, recycler);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>我们根据有没有已经被 attach 的子视图来判断当前是一个新的布局还是一个更新操作。<br>如果是更新，我们根据第一个可见视图的 position（通过监测视图左上角是哪个子视图）<br>和当前 x/y 滑动的位移这些信息去执行新的 <code>fillGrid()</code>，同时保证左上角的 item 位置不变。</p>
<hr>
<p>下面是一些需要特殊处理得情况：</p>
<ul>
<li>当新的数据集很小，不足以滑动时，布局会将左上角重置为 position 是 0 的item。</li>
<li>如果新的数据集很小，保持当前位置会使滚动超出边界。<br>我们就应该调整第一个 item 的位置，以便和右下角对齐。</li>
</ul>
<hr>
<p>###onAdapterChanged()</p>
<p>这个方法提供了另一个重置布局的场所，设置新的 adapter 会触发这个事件<br>(在这，<code>setAdapter</code>会被再次调用)。<br>这个阶段你可以安全的返回一个与之前 adapter 完全不同的视图。所以，<br>示例中我们移除了所有当前视图(并没有回收它们)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAdapterChanged</span><span class="params">(RecyclerView.Adapter oldAdapter, RecyclerView.Adapter newAdapter)</span> </span>&#123;</div><div class="line">    <span class="comment">//Completely scrap the existing layout</span></div><div class="line">    removeAllViews();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>移除视图会触发一个新的布局过程，当  <code>onLayoutChildren()</code> 被再次调用时，<br>我们的代码会执行创建新视图的布局过程，因为现在没有 attched 的子视图。</p>
<hr>
<p>#Scroll to Position<br>另一个重要的特性就是给 LayoutManager 添加滚动到特定位置的功能。<br>可以带有有动画效果，也可以没有，下面是对应的两个回调方法。</p>
<p>###scrollToPosition()</p>
<p>当 layout 应该立即将所给位置设为第一个可见 item 时，调用 RecyclerView 的 <code>scrollToPosition()</code>。<br>在一个 vertical list 里，item 应该放在顶部；horizontal list 中，通常放在左边。在我们的<br>网格布局中，被选中的 item 应该放在视图的左上角。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollToPosition</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (position &gt;= getItemCount()) &#123;</div><div class="line">        Log.e(TAG, <span class="string">"Cannot scroll to "</span>+position+<span class="string">", item count is "</span>+getItemCount());</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Ignore current scroll offset, snap to top-left</span></div><div class="line">    mForceClearOffsets = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">//Set requested position as first visible</span></div><div class="line">    mFirstVisiblePosition = position;</div><div class="line">    <span class="comment">//Trigger a new view layout</span></div><div class="line">    requestLayout();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为有一个良好的 <code>onLayoutChildren()</code> 实现，这里就可以简单的更新目标位置并触发一个<br>新的 fill 操作。</p>
<hr>
<p>###smoothScrollToPosition()</p>
<p>在带有动画的情况下，我们需要使用一些稍微不同的方法。<br>在这方法里我们需要创建一个 <code>RecyclerView.SmoothScroller</code>实例，<br>然后在方法返回前请求<code>startSmoothScroll()</code>启动动画。</p>
<p><code>RecyclerView.SmoothScroller</code> 是提供 API 的抽象类，含有四个方法：</p>
<hr>
<ul>
<li><code>onStart()</code>：当滑动动画开始时被触发。</li>
<li><code>onStop()</code>：当滑动动画停止时被触发。</li>
<li><code>onSeekTargetStep()</code>：当 scroller 搜索目标 view 时被重复调用，这个方法负责读取提供的<br>dx/dy ，然后更新应该在这两个方向移动的距离。<ul>
<li>这个方法有一个<code>RecyclerView.SmoothScroller.Action</code>实例做参数。<br>通过向 action 的 <code>update()</code>方法传递新的 dx, dy, duration 和 <code>Interpolator</code> ，<br>告诉 view 在下一个阶段应该执行怎样的动画。</li>
<li><strong>NOTE：</strong> 如果动画耗时过长，框架会对你发出警告，<pre><code>应该调整动画的步骤，尽量和框架标准的动画耗时相同。
</code></pre></li>
<li><code>onTargetFound()</code>：只在目标视图被 attach 后调用一次。这是将目标视图要通过动画移动到准确位置最后的场所。</li>
<li>在内部，当 view 被 attach 时使用  LayoutManager  的 <code>findViewByPosition()</code> 方法<br>查找对象。如果你的 LayoutManager 可以有效匹配 view 和 position ，<br>可以覆写这个方法来优化性能。默认提供的实现是通过每次遍历所有子视图查找。</li>
</ul>
</li>
</ul>
<hr>
<p>你可以自己实现一个 scroller 达到你想要的效果。不过这里我们只使用系统提供的<br><code>LinearSmoothScroller</code> 就好了。只需实现一个方法<code>computeScrollVectorForPosition()</code>，<br>然后告诉 scroller 初始方向还有从当前位置滚动到目标位置的大概距离。</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">smoothScrollToPosition</span><span class="params">(RecyclerView recyclerView, RecyclerView.State state, <span class="keyword">final</span> <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (position &gt;= getItemCount()) &#123;</div><div class="line">        Log.e(TAG, <span class="string">"Cannot scroll to "</span>+position+<span class="string">", item count is "</span>+getItemCount());</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * LinearSmoothScroller's default behavior is to scroll the contents until</div><div class="line">     * the child is fully visible. It will snap to the top-left or bottom-right</div><div class="line">     * of the parent depending on whether the direction of travel was positive</div><div class="line">     * or negative.</div><div class="line">     */</div><div class="line">    LinearSmoothScroller scroller = <span class="keyword">new</span> LinearSmoothScroller(recyclerView.getContext()) &#123;</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * LinearSmoothScroller, at a minimum, just need to know the vector</div><div class="line">         * (x/y distance) to travel in order to get from the current positioning</div><div class="line">         * to the target.</div><div class="line">         */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> PointF <span class="title">computeScrollVectorForPosition</span><span class="params">(<span class="keyword">int</span> targetPosition)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> rowOffset = getGlobalRowOfPosition(targetPosition)</div><div class="line">                    - getGlobalRowOfPosition(mFirstVisiblePosition);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> columnOffset = getGlobalColumnOfPosition(targetPosition)</div><div class="line">                    - getGlobalColumnOfPosition(mFirstVisiblePosition);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PointF(columnOffset * mDecoratedChildWidth, rowOffset * mDecoratedChildHeight);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    scroller.setTargetPosition(position);</div><div class="line">    startSmoothScroll(scroller);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>在这个实现中，和现有 ListView 的行为相似，无论是 RecyclerView 的哪个方向滚动，<br>当视图完全可见时滚动就会停止。</p>
<hr>
<p>#接下来？</p>
<p>我们现在已经有些起色了！事实上还有很多可以实现的功能。在<a href="./创建-RecyclerView-LayoutManager-Part-3.md">下篇文章</a>中，我们会介绍<br>如何给你的 LayoutManager 提供数据集改变时的动画效果。</p>
<hr>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/创建-RecyclerView-LayoutManager-Part-2/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/创建-RecyclerView-LayoutManager-Part-2/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/创建-RecyclerView-LayoutManager-Part-3/" title="创建 RecyclerView LayoutManager – Part 3" itemprop="url">创建 RecyclerView LayoutManager – Part 3</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://wiresareobsolete.com/2015/02/recyclerview-layoutmanager-3/" target="_blank" rel="external">Building a RecyclerView LayoutManager – Part 3</a></li>
<li>原文作者 : <a href="http://wiresareobsolete.com/" target="_blank" rel="external">Dave Smith</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/tiiime" target="_blank" rel="external">tiiime</a> </li>
<li>校对者:<a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a> </li>
<li>状态 :   完成 </li>
</ul>
<h1 id="Building-a-RecyclerView-LayoutManager-–-Part-3"><a href="#Building-a-RecyclerView-LayoutManager-–-Part-3" class="headerlink" title="Building a RecyclerView LayoutManager – Part 3"></a>Building a RecyclerView LayoutManager – Part 3</h1><blockquote>
<p>本文是这个系列中的 Part 3，这里是 <a href="../issue-9/创建-RecyclerView-LayoutManager-Part-1.md">Part 1</a> 和 <a href="./创建-RecyclerView-LayoutManager-Part-2.md">Part 2</a> 的链接。</p>
</blockquote>
<p>在<a href="./创建-RecyclerView-LayoutManager-Part-2.md">之前的文章</a>里，我们讨论了怎样对数据集改变和定量滚动<br>提供正确的支持。接下来我们会介绍怎样给 LayoutManager 添加<br>合适的动画效果。</p>
<blockquote>
<p>友情提醒：示例中的代码在这里 <a href="https://github.com/devunwired/recyclerview-playground" target="_blank" rel="external">Github</a></p>
</blockquote>
<hr>
<p>#The Problem With Free</p>
<p>上次我们说到了 <code>notifyDataSetChanged()</code> ，但是使用这个方法<br>不会有数据改变的动画效果<a id="1" href="#b1">(1)</a>。<br>RecyclerView 提供了新的 API 让我们可以通知 adapter<br>做出带有动画效果的改变。它们是：</p>
<ul>
<li><code>notifyItemInserted()</code>  和 <code>notifyItemRangeInserted()</code>：<br>在给定位置/范围插入新item(s)。</li>
<li><code>notifyItemChanged()</code> 和 <code>notifyItemRangeChanged()</code>：<br>使给定 位置/范围 的 item(s) 无效，数据集并没有结构上的改变。</li>
<li><code>notifyItemRemoved()</code> 和 <code>notifyItemRangeRemoved()</code>：<br>移除给定 位置/范围 的 item(s)。</li>
<li><code>notifyItemMoved()</code>：<br>将数据集中的一个 item 重定位到一个新的位置。</li>
</ul>
<p>使用这些方法你的 LayoutManager 会得到一个很简单的默认 item 动画。<br>这些动画是根据当前每一个 view 在改变后是否还存在于 layout 之中生成的。<br>新的 view 渐入，被移除的 view 淡出，其他 view 移动到新的位置。<br>下面是我们 grid layout 示例的动画效果：</p>
<p><img src="http://i.embed.ly/1/display/resize?url=http%3A%2F%2Fwiresareobsolete.com%2Fwp-content%2Fuploads%2F2015%2F02%2FDefaultRecyclerAnimationsSmall.gif&amp;grow=true&amp;key=92b31102528511e1a2ec4040d3dc5c07" alt="img"></p>
<p>不过这里有个问题，一些没有被移除的 item 也淡出了。<br>这是因为它们在父控件 RecyclerView 的边界中不再可见。<br>我们想要这些 view 朝着用户期望的方向滑去，但是框架只知道<br>我们的代码在数据改变后没有显示出这些 item。此外，<br>新加入的 view 是淡入进来的，让他们从预定位置滑入界面会更好。</p>
<p>我们要给 LayoutManager 加点东西才能实现这些。</p>
<hr>
<p>#Predictive Item Animations</p>
<p>下面的图片展示了我们期望的移除 item 动画效果：<br><img src="http://i.embed.ly/1/display/resize?url=http%3A%2F%2Fwiresareobsolete.com%2Fwp-content%2Fuploads%2F2015%2F02%2FRecycleConceptSmall.gif&amp;grow=true&amp;key=92b31102528511e1a2ec4040d3dc5c07&amp;height=400" alt="img"><br>左侧一列 items 滑到右侧填补空白部分的动画很引人注意。<br>和这个差不多，你可以脑补出在这个位置添加一个 item 时的动画效果。</p>
<p>在第一篇文章里曾提到的，<code>onLayoutChildren()</code> 通常只会<br>在父控件 <code>RecyclerView</code> 初始化布局 或者 数据集的大小(比如 item 的数量)改变时调用一次。<br>Predictive Item Animations<br>这个特性允许我们给 view (基于数据改变产生)的过渡动画<br>提供更多有用的信息。想要使用这个特性，就要告诉<br>框架我们的 <code>LayoutManager</code> 提供了这个附加数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsPredictiveItemAnimations</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有了这个改动，<code>onLayoutChildren()</code>会在每次数据集改变后被调用两次，<br>一次是”预布局”(pre-layout)阶段，一次是真实布局(real layout)。</p>
<hr>
<p>#在  pre-layout 阶段该做些什么</p>
<p>在<code>onLayoutChildren()</code>的  pre-layout 阶段，<br>你应该运行你的布局逻辑设置动画的<strong>初始状态</strong>。<br>这需要你在动画执行前布局所有 当前可见的 view <strong>和</strong> 在动画后会可见的 view<br>(被称为 <strong>APPEARING</strong> view)。Appearing views 应该被布局在<br>屏幕之外，用户期望它进入的位置。框架会捕获他们的位置，<br>籍此创建更合适的动画效果。</p>
<blockquote>
<p>我们可以使用 <code>RecyclerView.State.isPreLayout()</code> 来检测当前处于哪一阶段</p>
</blockquote>
<p>在 <code>FixedGridLayoutManager</code> 示例中，我们根据数据集的改变<br>使用  pre-layout 决定哪些 view 被移除。被移除的 view<br>在 pre-layout 的 Recycler 中仍然会被返回，所以你不用担心<br>会出现空白位置。如果你想要判断视图是否会被移除，<br>可以使用<code>LayoutParams.isViewRemoved()</code> 这个方法 。<br>我们的示例统计了被移除 view 的数量，让我们<br>对有多少空间会被 appearing views  填充有一个大概的印象。</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> </span>&#123;</div><div class="line">    …</div><div class="line"></div><div class="line">    SparseIntArray removedCache = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * During pre-layout, we need to take note of any views that are</div><div class="line">     * being removed in order to handle predictive animations</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (state.isPreLayout()) &#123;</div><div class="line">        removedCache = <span class="keyword">new</span> SparseIntArray(getChildCount());</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; getChildCount(); i++) &#123;</div><div class="line">            <span class="keyword">final</span> View view = getChildAt(i);</div><div class="line">            LayoutParams lp = (LayoutParams) view.getLayoutParams();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (lp.isItemRemoved()) &#123;</div><div class="line">                <span class="comment">//Track these view removals as visible</span></div><div class="line">                removedCache.put(lp.getViewPosition(), REMOVE_VISIBLE);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        …</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    …</div><div class="line"></div><div class="line">    <span class="comment">//Fill the grid for the initial layout of views</span></div><div class="line">    fillGrid(DIRECTION_NONE, childLeft, childTop, recycler, state.isPreLayout(), removedCache);</div><div class="line"></div><div class="line">    …</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Tip：在 pre-layout 期间，RecyclerView 会尝试用 view<br>在 adapter 中的位置匹配它们的”原位置”(数据改变前的位置)。<br>如果你想通过 position 请求一个 view，并且希望这个位置<br>是这个视图初始化时的位置。就不要在 pre-layout 和<br>real-layout 期间改变它们。</p>
</blockquote>
<p>示例代码中最后的变动是对<code>fillGrid()</code>进行修改，在这里给 N<br>个 appearing views  布局，N 是被移除的可见视图个数。<br>这些 view 永远是从右侧进入的，所以他们被安排在最后一列<br>可见 view 的后面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fillGrid</span><span class="params">(<span class="keyword">int</span> direction, <span class="keyword">int</span> emptyLeft, <span class="keyword">int</span> emptyTop, RecyclerView.Recycler recycler,</span></span></div><div class="line">        <span class="keyword">boolean</span> preLayout, SparseIntArray removedPositions) &#123;</div><div class="line">    …</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getVisibleChildCount(); i++) &#123;</div><div class="line">        <span class="keyword">int</span> nextPosition = positionOfIndex(i);</div><div class="line"></div><div class="line">        …</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (i % mVisibleColumnCount == (mVisibleColumnCount - <span class="number">1</span>)) &#123;</div><div class="line">            leftOffset = startLeftOffset;</div><div class="line">            topOffset += mDecoratedChildHeight;</div><div class="line"></div><div class="line">            <span class="comment">//During pre-layout, on each column end, apply any additional appearing views</span></div><div class="line">            <span class="keyword">if</span> (preLayout) &#123;</div><div class="line">                layoutAppearingViews(recycler, view, nextPosition, removedPositions.size(), …);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            leftOffset += mDecoratedChildWidth;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    …</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">layoutAppearingViews</span><span class="params">(RecyclerView.Recycler recycler, View referenceView,</span></span></div><div class="line">        <span class="keyword">int</span> referencePosition, <span class="keyword">int</span> extraCount, <span class="keyword">int</span> offset) &#123;</div><div class="line">    <span class="comment">//Nothing to do...</span></div><div class="line">    <span class="keyword">if</span> (extraCount &lt; <span class="number">1</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> extra = <span class="number">1</span>; extra &lt;= extraCount; extra++) &#123;</div><div class="line">        <span class="comment">//Grab the next position after the reference</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> extraPosition = referencePosition + extra;</div><div class="line">        <span class="keyword">if</span> (extraPosition &lt; <span class="number">0</span> || extraPosition &gt;= getItemCount()) &#123;</div><div class="line">            <span class="comment">//Can't do anything with this</span></div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Obtain additional position views that we expect to appear</div><div class="line">         * as part of the animation.</div><div class="line">         */</div><div class="line">        View appearing = recycler.getViewForPosition(extraPosition);</div><div class="line">        addView(appearing);</div><div class="line"></div><div class="line">        <span class="comment">//Find layout delta from reference position</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newRow = getGlobalRowOfPosition(extraPosition + offset);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> rowDelta = newRow - getGlobalRowOfPosition(referencePosition + offset);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newCol = getGlobalColumnOfPosition(extraPosition + offset);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> colDelta = newCol - getGlobalColumnOfPosition(referencePosition + offset);</div><div class="line"></div><div class="line">        layoutTempChildView(appearing, rowDelta, colDelta, referenceView);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>layoutAppearingViews()</code>这个方法里，每一个 appearing view<br>被布局到它的”全局”位置(就是它在这个网格中占据的行/列)。<br>虽然位置在屏幕之外，但是为框架创建滑入 view 动画的起始点提供了<br>必要的数据。</p>
<hr>
<p>#Changes for the “Real” Layout</p>
<p><a href="../issue-9/创建-RecyclerView-LayoutManager-Part-1.md">part1</a>中我们已经讨论过布局期间的基本工作，<br>然而要想为我们的动画提供支持还要做一些修改。<br>其中之一就是判断有没有 disappearing views。在我们的示例中<br>是通过运行一个普通的布局过程，然后检查 Recycler<br>的 scrap heap 之中有没有剩下的 view。</p>
<blockquote>
<p>注意：我们之所以能以这种方式使用 scrap heap 是因为<br>在每一次布局过程开始前，布局逻辑总是调用了<br><code>detachAndScrapAttachedViews()</code>这个方法。<br>前面说过，这是布局中你需要遵循的最佳实践。</p>
</blockquote>
<hr>
<p>Views still in scrap that aren’t considered removed are<br>disappearing views. We need to lay these views out in<br>their off-screen positions so the animation system<br>can slide them out of view (instead of just fading them out).</p>
<p>仍在 scrap 中没有被移除的视图就是 disappearing views。<br>我们需要把它们放置到屏幕之外的位置，以便动画系统<br>将它们滑出视图(用来取代淡出动画)。</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> </span>&#123;</div><div class="line">    …</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!state.isPreLayout() &amp;&amp; !recycler.getScrapList().isEmpty()) &#123;</div><div class="line">        <span class="keyword">final</span> List&lt;RecyclerView.ViewHolder&gt; scrapList = recycler.getScrapList();</div><div class="line">        <span class="keyword">final</span> HashSet&lt;View&gt; disappearingViews = <span class="keyword">new</span> HashSet&lt;View&gt;(scrapList.size());</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (RecyclerView.ViewHolder holder : scrapList) &#123;</div><div class="line">            <span class="keyword">final</span> View child = holder.itemView;</div><div class="line">            <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">            <span class="keyword">if</span> (!lp.isItemRemoved()) &#123;</div><div class="line">                disappearingViews.add(child);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (View child : disappearingViews) &#123;</div><div class="line">            layoutDisappearingView(child);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">layoutDisappearingView</span><span class="params">(View disappearingChild)</span> </span>&#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * LayoutManager has a special method for attaching views that</div><div class="line">     * will only be around long enough to animate.</div><div class="line">     */</div><div class="line">    addDisappearingView(disappearingChild);</div><div class="line"></div><div class="line">    <span class="comment">//Adjust each disappearing view to its proper place</span></div><div class="line">    <span class="keyword">final</span> LayoutParams lp = (LayoutParams) disappearingChild.getLayoutParams();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newRow = getGlobalRowOfPosition(lp.getViewPosition());</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> rowDelta = newRow - lp.row;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newCol = getGlobalColumnOfPosition(lp.getViewPosition());</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> colDelta = newCol - lp.column;</div><div class="line"></div><div class="line">    layoutTempChildView(disappearingChild, rowDelta, colDelta, disappearingChild);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>小心：布局视图(然后将它们加入container)把它们从 scrap 列表中移除。<br>在开始变化前，小心处理你需要从 scrap 中获取的视图，否则你可能会<br>在这个集合上出现并发修改的问题结束运行。</p>
</blockquote>
<p>和之前处理 appearing views  的代码差不多，<code>layoutDisappearingView()</code><br>将所有剩余 view 放在与之对应的”全局”位置作为最终布局位置。<br>给框架提供必要信息创建出适当方向的滑出动画。</p>
<p>下面的图片可以帮你理解<code>FixedGridLayoutManager</code>之中的过程：</p>
<ul>
<li>黑框是 <code>RecyclerView</code> 的可视边界。</li>
<li>Red View：数据集中被移除的 item。</li>
<li>Green View (Appearing View)：开始时没有，在 pre-layout 过程中被布局到屏幕外的item。</li>
<li>Purple Views (Disappearing views)：pre-layout 时期放置在他们的原始位置 ，<br>real-layout 时期被布局到屏幕之外的位置。</li>
</ul>
<p><img src="http://i.embed.ly/1/display/resize?url=http%3A%2F%2Fwiresareobsolete.com%2Fwp-content%2Fuploads%2F2015%2F02%2FRecycleRemove.gif&amp;grow=true&amp;key=92b31102528511e1a2ec4040d3dc5c07&amp;height=400" alt="img"></p>
<hr>
<p>#响应屏幕外的变动<br>你或许注意到在上一节中我们可以判断可视 views 的移除操作。<br>如果变化出现在可视边界之外会怎样？这取决于你的布局结构，<br>像这样的变化可能需要你调整布局来达到更好的动画效果。</p>
<p>Adapter 会将这个变化 post 给你的 LayoutManager。你可以覆写<br><code>onItemsRemoved()</code>, <code>onItemsMoved()</code>, <code>onItemsAdded()</code> 或者<br><code>onItemsChanged()</code> 响应 item 的这些事件，无论 item<br>在当前布局中是否可见。</p>
<p>如果被移除的范围在可视边界之外， 调用 pre-layout 之前会调用<br><code>onItemRemoved()</code>。我们可以利用它收集和这个变化有关的数据，为<br>这个事件可能触发的  appearing view 改变提供更好的支持。</p>
<p>示例中，我们像之前一样收集被移除的 view，但是将它们标记成不同的类型。</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemsRemoved</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> positionStart, <span class="keyword">int</span> itemCount)</span> </span>&#123;</div><div class="line">    mFirstChangedPosition = positionStart;</div><div class="line">    mChangedPositionCount = itemCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> </span>&#123;</div><div class="line">    …</div><div class="line"></div><div class="line">    SparseIntArray removedCache = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * During pre-layout, we need to take note of any views that are</div><div class="line">     * being removed in order to handle predictive animations</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (state.isPreLayout()) &#123;</div><div class="line">        …</div><div class="line"></div><div class="line">        <span class="comment">//Track view removals that happened out of bounds (i.e. off-screen)</span></div><div class="line">        <span class="keyword">if</span> (removedCache.size() == <span class="number">0</span> &amp;&amp; mChangedPositionCount &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = mFirstChangedPosition; i &lt; (mFirstChangedPosition + mChangedPositionCount); i++) &#123;</div><div class="line">                removedCache.put(i, REMOVE_INVISIBLE);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    …</div><div class="line"></div><div class="line">    <span class="comment">//Fill the grid for the initial layout of views</span></div><div class="line">    fillGrid(DIRECTION_NONE, childLeft, childTop, recycler, state.isPreLayout(), removedCache);</div><div class="line"></div><div class="line">    …</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>TIP：如果被移除的 item 是可见的，这个方法在 pre-layout<br>之后还会被调用。这也就是为什么<br>当被移除的可见 views 出现时我们仍要从它们获取数据。</p>
</blockquote>
<p>所有步骤就位，现在我们可以启动这个应用啦。可以看到左边消失的items<br>移到对应行的后面。右边新出现的 items 滑动进入现有的界面。<br>现在，新的动画中只有被移除的 item 是淡出的了。</p>
<p><img src="http://i.embed.ly/1/display/resize?url=http%3A%2F%2Fwiresareobsolete.com%2Fwp-content%2Fuploads%2F2015%2F02%2FPredictiveRecyclerAnimationsSmall.gif&amp;grow=true&amp;key=92b31102528511e1a2ec4040d3dc5c07" alt="img"></p>
<hr>
<p>#未完待续…</p>
<p>我说过…这应该是这系列中的最后一篇。不过，在编写 <code>FixedGridLayoutManager</code><br>动画效果的过程中又出现了些有趣的问题，并不是所有自定义的实现。<br>所以在下一篇文章里(这次真的是最后一篇了)，我会解决这些问题。</p>
<p>特别感谢 <a href="https://plus.google.com/111851968937104436377/posts" target="_blank" rel="external">Yiğit Boyar</a>提供技术支持，帮助完成这篇文章。</p>
<hr>
<ol>
<li>如果你的 adapter 使用了固定的 IDs ，可以提供足够的数据推测哪些 view 被 移除/添加/等等<br>框架就会尝试 给它添加动画    <a id="b1" href="#1">↩</a></li>
</ol>
<hr>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/创建-RecyclerView-LayoutManager-Part-3/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/创建-RecyclerView-LayoutManager-Part-3/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/在Android Lollipop中使用Palette抽取Bitmap颜色/" title="在Android Lollipop中使用Palette抽取Bitmap颜色" itemprop="url">在Android Lollipop中使用Palette抽取Bitmap颜色</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://www.bignerdranch.com/blog/extracting-colors-to-a-palette-with-android-lollipop/" target="_blank" rel="external">Extracting Colors to a Palette with Android Lollipop</a></li>
</ul>
<p>一些Support库随着Android Lollipop的发布而诞生了，其中就有Palette。这个库可以让你很轻松地从一幅图中抽取特征颜色，这在你希望界面的颜色风格适应指定图片时非常有用，它还会提供与指定颜色相搭配的字体颜色。</p>
<p>Palette有一个用法我特别喜欢：它可以定制图像波纹的颜色。这是其实一个微不足道的效果，但是我认为相比于纯灰色波纹来说是一个很大的提升。你需要在工程下的<code>build.gradle</code>里添加依赖才可以使用Palette，像如下代码所示：</p>
<pre><code>dependencies {
  compile &apos;com.android.support:palette-v7:21.0.0&apos;
}
</code></pre><p>生成一幅图像的Palette有两种方法：</p>
<ul>
<li><code>generate(Bitmap)</code> 生成含有16种颜色种类的Palette；</li>
<li><code>generate(Bitmap, int)</code> 生成含有指定数量颜色种类的Palette，数量越多需要的时间越久。</li>
</ul>
<p>这两个方法是同步方法，由于他们很可能会比较耗时（在分析大图片或者所需颜色较多时），所以它们不应该在主线程中执行。你应该先在别的线程中使用这两个函数进行解析，解析成功之后再使用。</p>
<p>不过有时候你不会在加载图片的线程（非主线程）中使用解析出的颜色，所以Palette提供了异步方法，他们与之前的函数的区别就是需要传入<code>PaletteAsyncListener</code>，提供在图片解析完成后的回调函数：</p>
<ul>
<li><code>generateAsync(Bitmap, PaletteAsyncListener)</code></li>
<li><code>generateAsync(Bitmap, int, PaletteAsyncListener)</code></li>
</ul>
<p><code>PaletteAsyncListener</code>的实现是非常简单的（参考下面这几行代码），它只要重写<code>onGenerated</code>就好了。如此一来你就可以在任何需要的时候使用这两个函数创建Palette。</p>
<pre><code>Palette.PaletteAsyncListener listener = new Palette.PaletteAsyncListener() {
  public void onGenerated(Palette palette) {
    // 使用Palette对象，获取解析出的颜色
  }
}
</code></pre><p>Palette默认会解析出图像的16种特征颜色种类，但是这六种颜色是你最经常用到的：</p>
<ul>
<li>vibrant(鲜艳色)</li>
<li>dark vibrant(鲜艳色中的暗色)</li>
<li>light vibrant(鲜艳色中的亮色)</li>
<li>muted(柔和色)</li>
<li>dark muted(柔和色中的暗色)</li>
<li>light muted(柔和色中的亮色)</li>
</ul>
<p>这是一个Palette解析六个主颜色种类的例子：</p>
<p><img src="http://img.blog.csdn.net/20150827183303088" alt="Six Color"></p>
<p>你获取Palette对象之后，可以通过以下这些内置getter函数直接获取这六个颜色。你需要传入默认颜色防止Palette无法解析到指定颜色种类，返回的类型是24位RGB颜色数值。</p>
<pre><code>Palette palette = Palette.generate(myBitmap);
int vibrant = palette.getVibrantColor(0x000000);
int vibrantLight = palette.getLightVibrantColor(0x000000);
int vibrantDark = palette.getDarkVibrantColor(0x000000);
int muted = palette.getMutedColor(0x000000);
int mutedLight = palette.getLightMutedColor(0x000000);
int mutedDark = palette.getDarkMutedColor(0x000000);
</code></pre><p>###Swatch</p>
<p>Palette解析出的颜色都来自于对应的<code>Swatch</code>，在<code>Swatch</code>里面含有很多关于对应颜色的有用信息。你可以从<code>Swatch</code>中获取RGB颜色值、HSL颜色向量、对应颜色在图像中所占的比例、与对应颜色搭配的标题字体颜色和正文字体颜色（这两个颜色和对应颜色的对比值是处理好的，你不必再去操心）。如下面这段代码所示：</p>
<pre><code>Palette palette  = Palette.generate(myBitmap);
Palette.Swatch swatch = palette.getVibrantSwatch();
//rgb颜色值
int rgbColor = swatch.getRgb();
//hsl颜色向量
float[] hslValues = swatch.getHsl();
//该颜色在图像中所占的像素数
int pixelCount = swatch.getPopulation();
//对应的标题字体颜色
int titleTextColor = swatch.getTitleTextColor();
//对应的正文字体颜色
int bodyTextColor = swatch.getBodyTextColor();
</code></pre><p>获取六个主颜色的<code>Swatch</code>要使用与之前直接获取颜色不同的getter函数，如下面这部分代码所示。它们不需要提供默认值，如果Palette没有解析到对应<code>Swatch</code>，它会直接返回null。</p>
<pre><code>Palette palette = Palette.generate(myBitmap);
Palette.Swatch vibrantSwatch = palette.getVibrantSwatch();
Palette.Swatch vibrantLightSwatch = palette.getLightVibrantSwatch();
Palette.Swatch vibrantDarkSwatch = palette.getDarkVibrantSwatch();
Palette.Swatch mutedSwatch = palette.getMutedSwatch();
Palette.Swatch mutedLightSwatch = palette.getLightMutedSwatch();
Palette.Swatch mutedDarkSwatch = palette.getDarkMutedSwatch();
</code></pre><p>Palette只为六种主颜色种类<code>Swatch</code>提供了getter，如果你要使用其他颜色种类的<code>Swatch</code>（一共有16种颜色种类），你需要手动获取它。调用<code>getSwatchs()</code>会返回一个列表，里面有所有获取到的<code>Swatch</code>。</p>
<p>这里是一个Palette获取所有<code>Swatch</code>的例子，里面展示了它们分别在图像中所占的比例：</p>
<p><img src="http://img.blog.csdn.net/20150827183359416" alt="all color"></p>
<p>Palette的异步方法使得它非常容易去使用，而且我也看到了它用在很多地方。它真是一个非常棒的工具，能够收集一幅图中所有的颜色，并将它们总结到几个不同种类的颜色中。我建议你阅读<a href="https://android.googlesource.com/platform/frameworks/support/+/master/v7/palette/src/android/support/v7/graphics" target="_blank" rel="external">源码</a>来更多地学习它！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/在Android Lollipop中使用Palette抽取Bitmap颜色/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/在Android Lollipop中使用Palette抽取Bitmap颜色/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/深入理解Shared-Element-Transition/" title="深入理解 Shared Element Transition" itemprop="url">深入理解 Shared Element Transition</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>这篇文章会深度分析共享元素 transitions 和它在 Activity &amp; Fragment Transitions API 中的作用。这篇文章是下面这个系列中的第三篇</p>
<ul>
<li>Part 1 <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">在 Activity 和 Fragment 中使用 Transition </a></li>
<li>Part 2 <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-content-transitions-in-depth-part2.html" target="_blank" rel="external">深入理解 Content Transition</a></li>
<li>Part 3a <a href="http://www.androiddesignpatterns.com/2015/01/activity-fragment-shared-element-transitions-in-depth-part3a.html" target="_blank" rel="external">深入理解共享元素 Transition</a></li>
<li>Part 3b <a href="http://www.androiddesignpatterns.com/2015/03/activity-postponed-shared-element-transitions-part3b.html" target="_blank" rel="external">延迟共享元素的 Transition</a></li>
<li>Part 3c 共享元素回调实践 (coming soon!)</li>
<li>Part 4  Activity &amp; Fragment 过渡动画示例(coming soon!)</li>
</ul>
<p>Part 3 会分成三个部分: part3a 介绍 共享元素 transitions 的底层操作，part3b 和 part3c<br>主要关注 API 的具体实现细节，例如推迟某些 共享元素 transition 的重要性和如何实现<br>SharedElementCallbacks。</p>
<p>我们首先会总结下在 <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">part 1</a> 中提到的关于 共享元素 transition 的知识点，然后说一说在 Android Lollipop 中是怎样使用它来构建合适的过渡动画。</p>
<p>##什么是 共享元素 Transition ?</p>
<p>共享元素 transition 决定了 共享元素 视图(也叫做主角视图)在<br>Activity/Fragment 场景过渡时的动画效果。共享元素 的动画<br>在被调用 Activity/Fragment  的 <strong>进入/返回</strong>  共享元素 transition<br><a id="1" href="#b1">(1)</a> 中执行，<br>可以通过下面的<a href="http://developer.android.com/reference/android/view/Window.html" target="_blank" rel="external">Window</a>/<a href="http://developer.android.com/reference/android/app/Fragment.html" target="_blank" rel="external">Fragment</a> 方法设置：</p>
<ul>
<li><strong>setSharedElementEnterTransition()</strong> -  <strong>B</strong> 的 <strong>进入</strong> 共享元素 transition ，执行将<br>共享元素视图 从 <strong>A</strong> 中的起始位置移动到它在 <strong>B</strong> 中的最终位置的动画。</li>
<li><strong>setSharedElementReturnTransition()</strong>  - <strong>B</strong> 的 <strong>返回</strong> 共享元素 transition ，执行将<br>共享元素视图 从 <strong>B</strong> 中起始位置移动到它在 <strong>A</strong> 中的最终位置的动画。</li>
</ul>
<p><a href="http://www.androiddesignpatterns.com/assets/videos/posts/2015/01/12/music-opt.mp4" target="_blank" rel="external"><strong>Video 3.1</strong></a> 展示了在 Google Play Music 中是怎样使用共享元素 transition<br>的。这个 transition 包含两个元素：一个 <strong>ImageView</strong>和它的父视图 <strong>CardView</strong>。<br>Transition 期间，<strong>CardView</strong> 会扩展到全屏或收缩回原状，<br><strong>ImageView</strong> 能在这两个 Activity 里无缝的衔接。</p>
<p>在 <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">part1 </a> 里只是简单的介绍了下这个话题，这篇文章将会对 共享元素 transition<br>做更深度的分析。例如 共享元素 Transition 在底层是如何实现的？都有哪些类型的 Transition 对象可以使用? Transition 期间 共享元素视图 是在哪里怎样绘制的？接下来的几章里<br>我们会逐个解答这些问题。</p>
<p>##深入共享元素 Transitions 底层</p>
<p>之前的文章已经介绍过 Transition 的两个主要任务分别是获取目标视图的 开始&amp;结束 状态和创建这两个状态间视图的过渡动画(Animator)。共享元素 Transition 也一样：<br>在创建动画前需要捕获每一个<br>共享元素视图的起始和结束状态(就是共享元素在 <strong>调用/被调用</strong> Activity/Fragment<br>里的位置，大小和外观)。有了这些信息 共享元素 Transition 就可以确定每一个 共享元素<br>视图应该执行的动画。</p>
<p>和 <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-content-transitions-in-depth-part2.html" target="_blank" rel="external">Content Transitions 的底层</a>相似，框架通过在运行时明确的<br>更改每个 共享元素视图 的属性将这个状态信息提供给 共享元素 Transition 。<br>更准确地说 Activity <strong>A</strong> 启动 Activity <strong>B</strong> 时将会出现以下事件：<a id="2" href="#b2">(2)</a></p>
<hr>
<ol>
<li>Activity <strong>A</strong> 调用 <strong>startActivity()</strong> 构造，测量，布局了一个<br>最初背景色为透明的半透明窗口 Activity <strong>B</strong> 。</li>
<li>框架将 <strong>B</strong> 中每一个共享元素视图复位到对应的原来在 <strong>A</strong> 中时的位置，接着 <strong>B</strong> 的进入 transition 捕获 <strong>B</strong> 中所有共享元素视图的起始状态。</li>
<li>框架将 <strong>B</strong> 中每一个共享元素视图复位到对应的在 <strong>B</strong> 的最终位置，接着 <strong>B</strong> 的进入 transition 捕获 B 中所有共享元素视图的结束状态。</li>
<li><strong>B</strong> 的进入 transition 比较所有共享元素视图的起始和结束状态，根据它们的不同<br>创建一个 <strong>Animator</strong>。</li>
<li>框架命令 <strong>A</strong> 隐藏共享元素视图，并运行返回的 <strong>Animator</strong>。<strong>B</strong> 中的<br>共享元素视图到位之后，<strong>B</strong> 的窗口背景在 <strong>A </strong>上逐渐显示，直到 <strong>B</strong><br>完全的显示出来，transition 运行完毕。</li>
</ol>
<hr>
<p>Content transitions 是根据每个过渡视图的可见性变化来调节的，<strong>共享元素 transition<br>是根据每个共享元素视图的位置，大小和外观的变化来调节的</strong>。从 API 21 开始，框架提供了<br>几个自定义共享元素场景切换动画的 <strong>Transition</strong> 实现。</p>
<ul>
<li><a href="https://developer.android.com/reference/android/transition/ChangeBounds.html" target="_blank" rel="external">ChangeBounds</a> - 捕获共享元素布局边界根据不同构造动画。<br><strong>ChangeBounds</strong> 在共享元素 Transition 中经常使用，大多数共享元素在两个<br>Activity/Fragment 间会有大小 或/和 位置不同。 </li>
<li><a href="https://developer.android.com/reference/android/transition/ChangeTransform.html" target="_blank" rel="external">ChangeTransform</a>  - 捕获共享元素缩放和角度，<br>根据不同构建动画<a id="3" href="#b3">(3)</a>。</li>
<li><a href="https://developer.android.com/reference/android/transition/ChangeClipBounds.html" target="_blank" rel="external">ChangeClipBounds</a> - 捕获共享元素的 <a href="https://developer.android.com/reference/android/view/View.html#getClipBounds()" target="_blank" rel="external">clip bounds</a><br>(剪辑边界) ，根据不同构建动画。</li>
<li><a href="https://developer.android.com/reference/android/transition/ChangeImageTransform.html" target="_blank" rel="external">ChangeImageTransform</a> - 捕获共享元素 ImageView 的<br>变换矩阵( transform matrices) ，根据不同构建动画。结合 <strong>ChangeBounds</strong>，<br>可以让 ImageView<br> 无缝的改变大小，形状和 <a href="https://developer.android.com/reference/android/widget/ImageView.ScaleType.html" target="_blank" rel="external"> ImageView.ScaleType </a>。 </li>
<li><a href="https://github.com/android/platform_frameworks_base/blob/lollipop-release/core/res/res/transition/move.xml" target="_blank" rel="external">@android:transition/move</a> - 一个 <strong>TransitionSet</strong> ，同时执行上面四种<br>transition 。在 <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">part 1</a> 里提到过，如果没有明确的声明 进入/返回 共享元素<br>transition ，框架会默认运行这个 transition。</li>
</ul>
<hr>
<p>在上面的例子中，我们还可以发现 <strong>共享元素视图实例并没有在 Activities/Fragments 间<br>“共享”</strong>。事实上，进入/返回 共享元素 transitions期间，用户看到的绝大多数东西都是在<br><strong>B</strong> 的 content view 中绘制的。框架并没有从 <strong>A</strong> 向 <strong>B</strong><br>传递 共享元素视图实例，<br>而是采用了不同的方法实现相同的视觉效果。当 <strong>A</strong> 启动 <strong>B</strong> ，框架收集 <strong>A</strong><br>中共享元素的所有相关信息，并传递给 <strong>B</strong>。接下来 <strong>B</strong> 使用这些信息初始化<br>共享元素视图的起始状态(它们在 <strong>A</strong> 中时对应的大小，位置和外观)。Transition<br>开始时，B 中除了共享元素视图外的所有东西都被初始化为对用户不可见。Tansition<br>的执行过程中，框架将 B 的 Activity 窗口逐渐显示，直到 B<br>中共享元素结束动画窗口变为不透明。</p>
<hr>
<p>##使用共享元素 Overlay <a id="4" href="#b4">(4)</a><br>最后，如果想要完全理解共享元素 transition 的运作，我们必须先说说共享元素 overlay。<br>可能不是很明显，<strong>共享元素默认是在整个窗口视图层的顶层  <a href="https://developer.android.com/reference/android/view/ViewOverlay.html" target="_blank" rel="external">ViewOverlay</a><br>上绘制</strong>。简单介绍下 ，<br><strong>ViewOverlay</strong> 这个类是在 API 18 中为了方便在视图层顶层<br>绘制引入的。添加到视图 <strong>ViewOverlay</strong> 之中的Drawable<br>和 view (甚至是一个 <strong>ViewGroup</strong> 的子类) ，<br>将会被绘制在视图的最上层。这就解释了框架为什么<br>默认选择在窗口视图层的  <strong>ViewOverlay</strong> 中绘制共享元素。<br>共享元素视图应该是贯穿整个 transition 的焦点；<br>如果 transitioning views 意外的绘制在共享元素之上就会<br>破坏这个效果<a id="5" href="#b5">(5)</a>。</p>
<hr>
<p>虽然共享元素默认绘制在共享元素的 ViewOverlay 之中，但是<br>框架也提供了关闭 overlay 的方法，只要调用<br><a href="https://developer.android.com/reference/android/view/Window.html#setSharedElementsUseOverlay(boolean)" target="_blank" rel="external">Window#setSharedElementsUseOverlay(false) </a><br>就可以了。如果你关闭了 overlay<br>，要留意这样做可能会引起的副作用。例如，<a href="http://www.androiddesignpatterns.com/assets/videos/posts/2015/01/12/overlay-opt.mp4" target="_blank" rel="external">Video 3.2</a><br> 执行了一个简单的共享元素 transition 两次，<br>一次开启和一次关闭 共享元素 overlay 。第一次达到了预期想要的结果，<br>第二次关闭 overlay 后运行的效果不理想。Transition view 从底部向上移入<br>调用 Activity 的 content view 时挡住了部分 共享元素 <strong>ImageView</strong> 。虽然<br>可以改变在 View 上绘制视图的顺序或者通过在共享元素 parent 里调用<br> <strong>setClipChildren(false)</strong> 这些旁门左道来修复问题，但是与可能带来的维护问题<br> 相比真是得不偿失。总之，除非你感觉必须要关掉共享元素 overlay 才能达到你想要的效果，<br> 其他情况尽量不要关闭它，这样会保持代码简洁，并且共享元素 transition 效果更引人注目。</p>
<p>##结语</p>
<p>综上所诉，这篇文章讲了三个重点:</p>
<ol>
<li>共享元素 transition 确定 共享元素视图(主角视图) 从一个 Activity/Fragment 移动到<br>另一个其间场景过渡的动画。</li>
<li>共享元素 transition 是根据每一个 共享元素视图 的位置，大小，和外观的变化调节的。</li>
<li>共享元素默认是绘制在窗口视图的顶层 <strong>ViewOverlay</strong> 上面的。</li>
</ol>
<p>希望这篇文章对你有所帮助 ～</p>
<hr>
<p>1 Note that the Activity Transition API gives you the ability to also specify exit and reenter shared element transitions using the setSharedElementExitTransition() and setSharedElementReenterTransition() methods, although doing so is usually not necessary. For an example illustrating one possible use case, check out this blog post. For an explanation why exit and reenter shared element transitions are not available for Fragment Transitions, see George Mount’s answer and comments in this StackOverflow post. ↩</p>
<p>2 A similar sequence of events occurs during the exit/return/reenter transitions for both Activities and Fragments. ↩</p>
<p>3 One other subtle feature of ChangeTransform is that it can detect and handle changes made to a shared element view’s parent during a transition. This comes in handy when, for example, the shared element’s parent has an opaque background and is by default selected to be a transitioning view during the scene change. In this case, the ChangeTransform will detect that the shared element’s ｀parent is being actively modified by the content transition, pull out the shared element from its parent, and animate the shared element separately. See George Mount’s StackOverflow answer for more information. ↩</p>
<p>4 Note that this section only pertains to Activity Transitions. Unlike Activity Transitions, shared elements are not drawn in a ViewOverlay by default during Fragment Transitions. That said, you can achieve a similar effect by applying a ChangeTransform transition, which will have the shared element drawn on top of the hierarchy in a ViewOverlay if it detects that its parent has changed. See this StackOverflow post for more information. ↩</p>
<p>5 Note that one negative side-effect of having shared elements drawn on top of the entire view hierarchy is that this means it will become possible for shared elements to draw on top of the System UI (such as the status bar, navigation bar, and action bar). For more information on how you can prevent this from happening, see this Google+ post. ↩</p>
<ol>
<li><p>Activity Transition API 也提供了<br><strong>setSharedElementExitTransition()</strong> 和 <strong>setSharedElementReenterTransition()</strong><br>这两个方法来设置 退出/重入 共享元素过渡，虽然通常来说是不必要的。<br><a href="https://halfthought.wordpress.com/2014/12/08/what-are-all-these-dang-transitions/" target="_blank" rel="external">这篇文章</a>介绍了一个可能会遇到的用例。在这个 <a href="http://stackoverflow.com/questions/27346020/understanding-exit-reenter-shared-element-transitions" target="_blank" rel="external">stackoverflow</a><br>提问中 George Mount 的回答解释了为什么 退出/重入 共享元素 transition 在<br>Fragment Transitions 中不可用。 <a id="b1" href="#1">↩</a></p>
</li>
<li><p>Activities 和 Fragments 的 退出/返回/重入 transition 过程中出现事件序列相似  <a id="b2" href="#2">↩</a></p>
</li>
<li><strong>ChangeTransform</strong> 还有一个超赞的特性，它可以检测并处理共享元素父视图过渡期间<br>   的改变。当共享元素父视图有一个不透明背景，在场景变换过程中默认被选为<br>   transitioning view 时，<strong>ChangeTransform</strong> 就有了用武之地。如果它检测出<br>   共享元素父视图已被 content transition 更改，就会将共享元素提取出来，单独执行<br>   共享元素的动画。<a href="http://stackoverflow.com/questions/26899779/enter-transition-on-a-fragment-with-a-shared-element-targets-the-shared-element" target="_blank" rel="external">StackOverflow answer</a> 这里有 George Mount<br>   的详细说明。<br>   <a id="b3" href="#3">↩</a></li>
<li>注意，这部分只与 Activity Transition 有关。和Activity Transition 不同，Fragment Transition<br>   期间共享元素默认不在 <strong>ViewOverlay</strong> 中绘制。尽管如此，你仍可以使用 ChangeTransform<br>   transition 来达到相似的效果，如果它检测到父视图改变了，就会把共享元素绘制在<br>   <strong>ViewOverlay</strong> 的顶层。<a href="http://stackoverflow.com/questions/27892033/is-there-a-setsharedelementsuseoverlay-method-for-fragment-transitions" target="_blank" rel="external">StackOverflow</a> 这里有更多信息。<pre><code>&lt;a id=&quot;b4&quot; href=&quot;#4&quot;&gt;↩&lt;/a&gt;
</code></pre></li>
<li>注意，将共享元素绘制在整个图层最顶层也有一些负面效果。有可能<br>   会将共享元素绘制在 System UI 之上(比如 status bar, navigation bar还有 action bar)。<br>   解决方法看这里 <a href="https://plus.google.com/+AlexLockwood/posts/RPtwZ5nNebb" target="_blank" rel="external">Google+ post</a>。<br>   <a id="b5" href="#5">↩</a></li>
</ol>
<hr>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/深入理解Shared-Element-Transition/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/深入理解Shared-Element-Transition/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/2/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="kevin1202" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/git/" title="git">git<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/mac/" title="mac">mac<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/git/" title="git">git<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mac/" title="Mac">Mac<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Library/" title="Library">Library<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Spannable/" title="Spannable">Spannable<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/TimerTask/" title="TimerTask">TimerTask<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Timer/" title="Timer">Timer<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/size/" title="size">size<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Travis-CI/" title="Travis-CI">Travis-CI<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 每天进步一点，就是要付诸行动。光有进步一点的想法，而不付诸行动，那么这种想  <br/>
			法只是空想，是永远也不会有进步的。”路行之而成”，路是人走出来的；进步也是人 </p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/5052645262" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/kevin1202" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:yangkai1202@126.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Kevin">Kevin</a>
		
		
		</p>
		<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','DBjSFU5kGEcv8E-m-m_m','2.0.0');
</script>
</div></footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?575e1640d293c4bdc82c5d203e895c4f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
