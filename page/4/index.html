
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Kevin博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Kevin">
    

    
    <meta name="description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">
<meta property="og:type" content="website">
<meta property="og:title" content="Kevin博客">
<meta property="og:url" content="https://kevin1202.github.io/page/4/index.html">
<meta property="og:site_name" content="Kevin博客">
<meta property="og:description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kevin博客">
<meta name="twitter:description" content="欢迎大家来到我的博客，希望可以帮到你们，很高兴认识你们。我的github地址：https:github.com/kevin1202">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Kevin博客" title="Kevin博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Kevin博客">Kevin博客</a></h1>
				<h2 class="blog-motto">梦想还是要有的，万一实现了呢？</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" maxlength="20" placeholder="Search" />
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/在Android Lollipop中使用Palette抽取Bitmap颜色/" title="在Android Lollipop中使用Palette抽取Bitmap颜色" itemprop="url">在Android Lollipop中使用Palette抽取Bitmap颜色</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://www.bignerdranch.com/blog/extracting-colors-to-a-palette-with-android-lollipop/" target="_blank" rel="external">Extracting Colors to a Palette with Android Lollipop</a></li>
</ul>
<p>一些Support库随着Android Lollipop的发布而诞生了，其中就有Palette。这个库可以让你很轻松地从一幅图中抽取特征颜色，这在你希望界面的颜色风格适应指定图片时非常有用，它还会提供与指定颜色相搭配的字体颜色。</p>
<p>Palette有一个用法我特别喜欢：它可以定制图像波纹的颜色。这是其实一个微不足道的效果，但是我认为相比于纯灰色波纹来说是一个很大的提升。你需要在工程下的<code>build.gradle</code>里添加依赖才可以使用Palette，像如下代码所示：</p>
<pre><code>dependencies {
  compile &apos;com.android.support:palette-v7:21.0.0&apos;
}
</code></pre><p>生成一幅图像的Palette有两种方法：</p>
<ul>
<li><code>generate(Bitmap)</code> 生成含有16种颜色种类的Palette；</li>
<li><code>generate(Bitmap, int)</code> 生成含有指定数量颜色种类的Palette，数量越多需要的时间越久。</li>
</ul>
<p>这两个方法是同步方法，由于他们很可能会比较耗时（在分析大图片或者所需颜色较多时），所以它们不应该在主线程中执行。你应该先在别的线程中使用这两个函数进行解析，解析成功之后再使用。</p>
<p>不过有时候你不会在加载图片的线程（非主线程）中使用解析出的颜色，所以Palette提供了异步方法，他们与之前的函数的区别就是需要传入<code>PaletteAsyncListener</code>，提供在图片解析完成后的回调函数：</p>
<ul>
<li><code>generateAsync(Bitmap, PaletteAsyncListener)</code></li>
<li><code>generateAsync(Bitmap, int, PaletteAsyncListener)</code></li>
</ul>
<p><code>PaletteAsyncListener</code>的实现是非常简单的（参考下面这几行代码），它只要重写<code>onGenerated</code>就好了。如此一来你就可以在任何需要的时候使用这两个函数创建Palette。</p>
<pre><code>Palette.PaletteAsyncListener listener = new Palette.PaletteAsyncListener() {
  public void onGenerated(Palette palette) {
    // 使用Palette对象，获取解析出的颜色
  }
}
</code></pre><p>Palette默认会解析出图像的16种特征颜色种类，但是这六种颜色是你最经常用到的：</p>
<ul>
<li>vibrant(鲜艳色)</li>
<li>dark vibrant(鲜艳色中的暗色)</li>
<li>light vibrant(鲜艳色中的亮色)</li>
<li>muted(柔和色)</li>
<li>dark muted(柔和色中的暗色)</li>
<li>light muted(柔和色中的亮色)</li>
</ul>
<p>这是一个Palette解析六个主颜色种类的例子：</p>
<p><img src="http://img.blog.csdn.net/20150827183303088" alt="Six Color"></p>
<p>你获取Palette对象之后，可以通过以下这些内置getter函数直接获取这六个颜色。你需要传入默认颜色防止Palette无法解析到指定颜色种类，返回的类型是24位RGB颜色数值。</p>
<pre><code>Palette palette = Palette.generate(myBitmap);
int vibrant = palette.getVibrantColor(0x000000);
int vibrantLight = palette.getLightVibrantColor(0x000000);
int vibrantDark = palette.getDarkVibrantColor(0x000000);
int muted = palette.getMutedColor(0x000000);
int mutedLight = palette.getLightMutedColor(0x000000);
int mutedDark = palette.getDarkMutedColor(0x000000);
</code></pre><p>###Swatch</p>
<p>Palette解析出的颜色都来自于对应的<code>Swatch</code>，在<code>Swatch</code>里面含有很多关于对应颜色的有用信息。你可以从<code>Swatch</code>中获取RGB颜色值、HSL颜色向量、对应颜色在图像中所占的比例、与对应颜色搭配的标题字体颜色和正文字体颜色（这两个颜色和对应颜色的对比值是处理好的，你不必再去操心）。如下面这段代码所示：</p>
<pre><code>Palette palette  = Palette.generate(myBitmap);
Palette.Swatch swatch = palette.getVibrantSwatch();
//rgb颜色值
int rgbColor = swatch.getRgb();
//hsl颜色向量
float[] hslValues = swatch.getHsl();
//该颜色在图像中所占的像素数
int pixelCount = swatch.getPopulation();
//对应的标题字体颜色
int titleTextColor = swatch.getTitleTextColor();
//对应的正文字体颜色
int bodyTextColor = swatch.getBodyTextColor();
</code></pre><p>获取六个主颜色的<code>Swatch</code>要使用与之前直接获取颜色不同的getter函数，如下面这部分代码所示。它们不需要提供默认值，如果Palette没有解析到对应<code>Swatch</code>，它会直接返回null。</p>
<pre><code>Palette palette = Palette.generate(myBitmap);
Palette.Swatch vibrantSwatch = palette.getVibrantSwatch();
Palette.Swatch vibrantLightSwatch = palette.getLightVibrantSwatch();
Palette.Swatch vibrantDarkSwatch = palette.getDarkVibrantSwatch();
Palette.Swatch mutedSwatch = palette.getMutedSwatch();
Palette.Swatch mutedLightSwatch = palette.getLightMutedSwatch();
Palette.Swatch mutedDarkSwatch = palette.getDarkMutedSwatch();
</code></pre><p>Palette只为六种主颜色种类<code>Swatch</code>提供了getter，如果你要使用其他颜色种类的<code>Swatch</code>（一共有16种颜色种类），你需要手动获取它。调用<code>getSwatchs()</code>会返回一个列表，里面有所有获取到的<code>Swatch</code>。</p>
<p>这里是一个Palette获取所有<code>Swatch</code>的例子，里面展示了它们分别在图像中所占的比例：</p>
<p><img src="http://img.blog.csdn.net/20150827183359416" alt="all color"></p>
<p>Palette的异步方法使得它非常容易去使用，而且我也看到了它用在很多地方。它真是一个非常棒的工具，能够收集一幅图中所有的颜色，并将它们总结到几个不同种类的颜色中。我建议你阅读<a href="https://android.googlesource.com/platform/frameworks/support/+/master/v7/palette/src/android/support/v7/graphics" target="_blank" rel="external">源码</a>来更多地学习它！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/在Android Lollipop中使用Palette抽取Bitmap颜色/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/在Android Lollipop中使用Palette抽取Bitmap颜色/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/在Android M中权限被拒绝时该如何处理/" title="在Android M中权限被拒绝时该如何处理" itemprop="url">在Android M中权限被拒绝时该如何处理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://plus.google.com/+AndroidDevelopers/posts/8aaudh5n1zM" target="_blank" rel="external">How to deal with permission denial on Android M</a></li>
</ul>
<p>Android M Preview 2 的SDK中引入了一个方法来处理运行时权限：<code>Activity.shouldShowRequestPermissionRationale()</code>。</p>
<p>这个函数的作用是告知App在调用需要权限的功能前是否要显示相应理由。</p>
<p>当App刚安装的时候，这个方法会返回false，这时候它可以直接调用任何需要权限的功能而不需要解释，此时会正常弹出权限对话框。如果用户之前拒绝过App使用权限，这个方法就会返回true。这时候你应该在调用相应权限功能前显示出理由，不过需要注意，仅仅当此权限没有显示需要它的原因时你才需要自己解释。</p>
<p>当App被永远拒绝获取某权限时（比如你点击了“不再提示”），<code>shouldShowRequestPermissionRationale()</code>就会返回false，这时候你也不必要提供任何解释了。</p>
<p>不过需要注意：<strong>由于一个bug，在Android M Preview 2的SDK中<code>Fragment.shouldShowRequestPermissionRationale()</code>会一直返回false。</strong>这在未来的版本中会修复。你可以在Fragment中使用<code>getActivity().shouldShowRequestPermissionRationale()</code>来绕过这个问题。</p>
<p>你可以在<a href="https://goo.gl/9xpwqN" target="_blank" rel="external">Github Demo</a>中查看我们处理运行时权限的示例。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/在Android M中权限被拒绝时该如何处理/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/在Android M中权限被拒绝时该如何处理/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/在你开发应用前应知道的六件事情/" title="开发第一个应用之前你需要知道的六件事" itemprop="url">开发第一个应用之前你需要知道的六件事</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.philosophicalhacker.com/2015/07/09/6-things-i-wish-i-knew-before-i-wrote-my-first-android-app/" target="_blank" rel="external">6 THINGS I WISH I KNEW BEFORE I WROTE MY FIRST ANDROID APP</a></li>
</ul>
<p>我的第一个应用非常糟糕。事实上，它非常的糟糕以致于我从应用市场上删除它，同时我甚至不在我的简历上罗列出它。如果我在开发之前知道一些Android开发的事情它就不会糟糕到这步田地。</p>
<p>这列罗列的事情在你开发第一个Android应用的时候需要牢记在大脑中。这些我接下来将展示的实际错误来自于我的第一个应用程序代码中。把这些错误经验牢记心头能够帮助你开发一个你可以引以为豪的应用。</p>
<p>当然，正如codestandards所说：“如果你所做的工作和你作为学生开发的Android应用类似，你很有可能会讨厌你的应用”。</p>
<p> <em>如果一年前你写的代码对于你来说感觉还不错，你很大程度上没有进行足够的学习。</em></p>
<p><em>-Code Standards  2015.5.21</em></p>
<p>如果你是一位经验丰富的Java开发者，第1、2、5条很有可能对你没有吸引力。另一方面，即使你从来没有犯过这些例子中的错误，第3、4条也可能向你展示一些很酷的事物，你可以利用一款也许你不知道的软件Android Studio去实现这些事物。</p>
<p>###1.不要持有Context的静态引用</p>
<pre><code>public class MainActivity extends LocationManagingActivity implements ActionBar.OnNavigationListener,
    GooglePlayServicesClient.ConnectionCallbacks,
    GooglePlayServicesClient.OnConnectionFailedListener {
    //...
    private static MeTrackerStore mMeTrackerStore; 
        //...
        @Override
       protected void onCreate(Bundle savedInstanceState) {
        //...
           mMeTrackerStore = new MeTrackerStore(this);
    }
}
</code></pre><p>这对于每个人来说看似是一个不可能犯的错误。它不是，我犯了这个错误。我也看到过别人犯这个错误，同时我也采访过那些不能很快指出为什么这是放在第一位的错误的人。不要这样做，它是会变的。</p>
<p>如果MeTrackerStore 通过它的构造函数保持一个指向Activity的引用，这个Activity将不会被垃圾回收(GC)。（除非静态变量被从新分配到不同的Activity）。这是因为mMeTrackerStore 是静态变量，而静态变量的内存是不会被回收，直到应用程序退出才回收。如果你正在试图做这样的事情，你的代码很有可能有严重的错误。寻找帮助吧，可能看看谷歌的Udacity 课程“<a href="https://www.udacity.com/course/android-development-for-beginners--ud837" target="_blank" rel="external">Android Development for Beginners</a>”能够帮助你。</p>
<p>注：从技术上说，你可以对一个Application Context进行静态变量引用而不引起内存泄露，<a href="http://www.philosophicalhacker.com/2015/07/14/why-static-references-to-application-contexts-are-probably-not-the-best-idea/" target="_blank" rel="external">但我不建议你这样做</a>。</p>
<p>###2.注意那些你无法控制生命周期的对象的隐式引用</p>
<pre><code>public class DefineGeofenceFragment extends Fragment {
    public class GetLatAndLongAndUpdateMapCameraAsyncTask extends     AsyncTask&lt;String, Void, LatLng&gt; {

            @Override
        protected LatLng doInBackground(String... params) {
                //...
             try {
                //Here we make the http request for the place search suggestions
                httpResponse = httpClient.execute(httpPost);
                HttpEntity entity = httpResponse.getEntity();
                inputStream = entity.getContent();
                //..
            }
        }
    }
}
</code></pre><p>这段代码有很多问题，我将只会把重点问题放在“隐式引用”那些问题上。在Java中，（非静态）内部类有个对外部类实例有个隐式引用。</p>
<p>在这个例子中，任何GetLatAndLongAndUpdateCameraAsyncTask都有一个外部类DefineGeofenceFragment的引用。对于匿名类是同样的，它们也有一个对包含它们的类的实例的一个隐式引用。</p>
<p>GetLatAndLongAndUpdateCameraAsyncTask对生命周期我们无法控制的Fragment对象有一个隐式引用。Android SDK负责创建和销毁Fragment，如果GetLatAndLongAndUpdateCameraAsyncTask 因为正在运行而不能被垃圾回收，那么DefineGeofenceFragment 也将因为具有隐式引用而保留不能被垃圾回收。</p>
<p>这里有一个很棒的谷歌视频，<a href="https://www.youtube.com/watch?v=_CruQY55HOk" target="_blank" rel="external">解释它为什么会发生这种事情</a>。</p>
<p>###3.使用Android Studio进行工作</p>
<p>这段代码是我使用“Generate Getter”在Android Studio中进行生成的。这些getter保持了’m’前缀的实例变量，同样通过它也能为一个方法产生相同的效果，这已经不是空想。</p>
<p>（如果你想知道为什么’m’是实例变量的名称的第一个字母,’m’往往是实例变量的公认约定。它代表了’member’(成员)的意思）。</p>
<p>不管你是否认为实例变量的前缀’m’是一个好注意，在这有一个知识，Android Studio能够帮助你编写任何你想要实现的公认约定。例如，在你为实例变量生成getters、setters和connstructor参数时，你可以使用Android Studio代码风格对话框的设置使Android Studio在你的实例变量前自动添加’m’和移除’m’。</p>
<p><img src="http://i1.wp.com/www.philosophicalhacker.com/wp-content/uploads/2015/07/Screen-Shot-2015-07-09-at-4.16.13-PM.png" alt="AndroidStudio"></p>
<p>Android Studio能够做的远不止于此。学习Android Studio从学习快捷键和模版是不错的开始。</p>
<p>###4.一个函数只做一件事</p>
<p>在我写的众多类中的一个类存在一个方法我写了有100多行。这类的方法是非常难以读懂、修改和重用。努力让一个方法只做一件事情。显然，这意味着你应该对超过20行的方法持有怀疑态度。这里，你可以使用Android Studio来帮助你发现有问题的方法：</p>
<p><img src="http://i2.wp.com/www.philosophicalhacker.com/wp-content/uploads/2015/07/Screen-Shot-2015-07-09-at-4.25.00-PM.png" alt="Method"></p>
<p>###5.向聪明和有经验的人学习</p>
<p>这可能听起来微不足道，但是这是我开发我的第一个应用时候犯下的错误。</p>
<p>当你开发一个应用的时候，你会犯别人已经犯过的错误。向别人学习，你可以避免犯别人犯过的错误来节约你的时间。我在我的第一个应用中浪费了大量的时间犯错，这些错误如果我花点时间向有经验的软件开发工程师学习就可以避免。</p>
<p>阅读<a href="http://www.amazon.com/The-Pragmatic-Programmer-Journeyman-Master/dp/020161622X" target="_blank" rel="external">Pragmatic Programmer</a>，然后阅读<a href="http://www.amazon.com/Effective-Java-Edition-Joshua-Bloch/dp/0321356683" target="_blank" rel="external">Effective Java</a>。这两本书会帮助你避免开发新手常犯的错误。在你学习了这两本书后，不停地寻找聪明的人并向他们学习。</p>
<p>###6.使用类库</p>
<p>当你开发应用的时候，你可能会遇到一些聪明人和有经验人已经解决过的问题。而且，许多这些问题的解决方案是可以作为开源库的，充分利用它们。</p>
<p>在我的第一个应用中，我写了一些类库已经提供的功能代码。其中一些是java标准库，还有一些是第三方类库，如Retrofit和Picasso。如果你不确定你使用什么样的类库，你可以做下面3件事情：</p>
<ol>
<li><p>听<a href="http://fragmentedpodcast.com/episodes/9/" target="_blank" rel="external">Google IO Fragmented</a>广播。在这期间，询问这些开发者什么第三方类库类库对Android很重要。</p>
</li>
<li><p>订阅<a href="http://androidweekly.net/" target="_blank" rel="external">Android周刊</a>。这里包含了一部分最新的类库，时刻注意哪些对自己有用。</p>
</li>
<li><p>寻找那些能够解决与你在开发应用中遇到问题类似的开源应用。你可能发现某个应用使用的第三方类库就是你想要的，或者你会发现一个你所不知道的java类库。</p>
</li>
</ol>
<p>###总结</p>
<p>开发优秀的Android应用是非常困难的。不要犯曾经犯下的错误来难为自己。如果你发现我写的代码中的错误请在评论中告诉我。（误导性评论比没有评论更糟糕）。如果你认为这篇文章对于新手开发者有用，请分享它。解决他们的一些令人头疼的难题。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/在你开发应用前应知道的六件事情/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/在你开发应用前应知道的六件事情/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/在滚动列表中播放视频/" title="在滚动列表中播放视频" itemprop="url">在滚动列表中播放视频</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/@v.danylo/implementing-video-playback-in-a-scrolled-list-listview-recyclerview-d04bc2148429#.giv0pte0s" target="_blank" rel="external">Implementing video playback in a scrolled list (ListView &amp; RecyclerView)</a></li>
</ul>
<p>本篇博文将会介绍如何实现在列表中播放视频，具体效果参见：Facebook，Instagram 或 Magiston：</p>
<p>###Facebook:</p>
<p><img src="http://img.my.csdn.net/uploads/201601/30/1454131534_4403.gif" alt=""></p>
<p>###Magisto:</p>
<p><img src="http://img.my.csdn.net/uploads/201601/30/1454131707_8101.gif" alt=""></p>
<p>###Instagram:</p>
<p><img src="http://img.my.csdn.net/uploads/201601/30/1454131742_4068.gif" alt=""></p>
<p>博文内容基于此Github 项目：<a href="https://github.com/danylovolokh/VideoPlayerManager" target="_blank" rel="external">VideoPlayerManager</a>.</p>
<p>博文中涉及的所有代码和范例都在该项目中，所以本篇博文不会详细讲解每一个细节。如果有人真的想知道实现的机制，最好是下载源码，结合 IDE 边看源码边阅读本文。不过就算你不结合源码，光看我在这里说的内容，也能理解的七七八八了。</p>
<p>##两个问题</p>
<p>为了实现这个功能，我们需要解决以下两个问题：</p>
<ol>
<li><p>管理视频播放。在 Android 框架层中我们可以利用 MediaPlayer 和 SurfaceView 来播放视频，但这种实现方式有许多缺点。我们不能在列表中使用一般的 VideoView，因为 VideoView 是 SurfaceView 的子类，而 SurfaceView 不具有 UI 异步缓存。而这会导致我们无法在滚动时记录视频到底播放到哪个时间点。TextureView 具有 UI 异步缓存，但在 Android SDK 15 没有 VideoView 的实现方式是借助 TextureView 来完成的。因此，我们需要一个 TextureView 的子类与 MediaPlayer 协作完成视频播放的功能。当然了，MediaPlayer 中的所有方法（准备，开始，停止等等……）几乎都是调用与硬件交互的内核层代码。而硬件往往意味着复杂，如果我们需要完成的任何工作的耗时超过 16ms（一般都会），就会看到滞后的视频列表。这也是为什么需要在后台线程中调用它们的原因。</p>
</li>
<li><p>我们还需要知道滚动列表中的哪一个 View 要被激活（播放视频），所以我们还需要追踪用户的滚动行为并定义可见域最大的 View。</p>
</li>
</ol>
<p>##管理视频播放</p>
<p>我们希望提供以下功能：</p>
<p>假设某个视频正在播放，此时用户滚动了列表使得列表中某个子项目的可见域大于正在播放视频的子项目的可见域，这样我们就需要停止正在播放的视频，并开始播放新的视频（可见域更大的子项目对应的视频）。</p>
<p><img src="http://img.my.csdn.net/uploads/201601/30/1454131709_2495.gif" alt=""></p>
<p>##VideoPlayerView</p>
<p>我们要做的第一件事就是以 TextureView 为父类实现 VideoView。而且我们在滚动列表中不能使用系统的 VideoView，因为用户在视频播放的过程中滚动列表的话，视频渲染就会乱掉。</p>
<p>我把这部分工作分为几个部分：</p>
<ol>
<li>创建继承于 TextureView 的 ScalableTextureView，它能够调整 SurfaceTexture（正在播放视频的表面结构中）而且提供了一些类似于 ImageView 缩放类型的选项。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ScaleType &#123;</div><div class="line">    CENTER_CROP, TOP, BOTTOM, FILL</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建 ScalableTextureView 的子类 VideoPlayerView，它包含所有与 MediaPlayer 相关的功能。即，这是一个封装了 MediaPlayer 并提供与 VideoView 几近一致的 API 的自定义 View。VideoPlayerView 具有所有直接调用 MediaPlayer 的方法：setDataSource，prepare, start, stop, pause, reset, release。</li>
</ol>
<p>##ViedioPlayer 管理器及消息控制机制</p>
<p>视频播放管理器与负责异步调用 MediaPlayer 方法的 MessageHandlerThread 协作。因为我们需要调用的方法，如：prepare(), start() 等等……与硬件直接相关，所以我们需要在一个独立的线程中完成这些调用。此外，当我们在 UI 线程中调用 MediaPlayer.reset() MediaPlayer 会发生一些奇怪的问题，使得该方法阻塞了将近 4 分钟！这也是我们不必须调用异步的 MediaPlayer.prepareAsync() 方法的原因，因为我们完全可以在另一个线程中调用 MediaPlayer.prepare() 方法，免得让这些奇怪的问题折腾自己。因此，我们将在一个独立的线程中异步完成所有任务。</p>
<p>在开始新的视频播放任务的事件流中，下面是一些与 MediaPlayer 相关的步骤：</p>
<ol>
<li><p>停止前一个播放任务，通过调用 MediaPlayer.stop() 方法完成。</p>
</li>
<li><p>通过调用 MediaPlayer.reset 方法重置 MediaPlayer。之所以需要这样做是因为：在滚动列表中，View 可能会被重用，而我们想要释放所有的资源。</p>
</li>
<li><p>通过调用 MediaPlayer.release() 方法释放 MediaPlayer 占用的资源。</p>
</li>
<li><p>清除 MediaPlayer 的实例，当 View 执行新的播放任务时，创建新的 MediaPlayer 实例。</p>
</li>
<li><p>为新的可见域最大的 View 创建 MediaPlayer 实例。</p>
</li>
<li><p>调用 MediaPlayer.setDataSource(String url) 为新的 MediaPlayer 设置数据源。</p>
</li>
<li><p>调用 MediaPlayer.prepare() 方法而不是 MediaPlayer.prepareAsync()。</p>
</li>
<li><p>调用 MediaPlayer.start()。</p>
</li>
<li><p>等待播放开始。</p>
</li>
</ol>
<p>以上所有行为都被包裹到 Message 中，交给一个独立的线程完成，例如这是一个 Stop 命令的 Message，它将调用 VideoPlayerView.stop()，实际上他调用的是 MediaPlayer.stop()。我们需要自定义 Message，因为我们可能需要设置当前状态，例如现在是正在停止，还是已经停止，或者是其他的状态……这有助于我们了解当前处理的 Message 是什么命令，如果我们需要用这个命令的话我们可以做什么，例如，开始一个新的播放任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This PlayerMessage calls &#123;<span class="doctag">@link</span> MediaPlayer#stop()&#125; on the instance that is used inside &#123;<span class="doctag">@link</span> VideoPlayerView&#125;</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stop</span> <span class="keyword">extends</span> <span class="title">PlayerMessage</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stop</span><span class="params">(VideoPlayerView videoView, VideoPlayerManagerCallback callback)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(videoView, callback);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">performAction</span><span class="params">(VideoPlayerView currentPlayer)</span> </span>&#123;</div><div class="line">        currentPlayer.stop();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> PlayerMessageState <span class="title">stateBefore</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PlayerMessageState.STOPPING;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> PlayerMessageState <span class="title">stateAfter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PlayerMessageState.STOPPED;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们需要开始一个新的播放任务，我们只需要调用 VideoPlayerManager 的一个方法，它就会添加下列 Message 到 MessagesHandlerThread 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// pause the queue processing and check current state</span></div><div class="line"><span class="comment">// if current state is "started" then stop old playback</span></div><div class="line">mPlayerHandler.addMessage(<span class="keyword">new</span> Stop(mCurrentPlayer, <span class="keyword">this</span>));</div><div class="line">mPlayerHandler.addMessage(<span class="keyword">new</span> Reset(mCurrentPlayer, <span class="keyword">this</span>));</div><div class="line">mPlayerHandler.addMessage(<span class="keyword">new</span> Release(mCurrentPlayer, <span class="keyword">this</span>));</div><div class="line">mPlayerHandler.addMessage(<span class="keyword">new</span> ClearPlayerInstance(mCurrentPlayer, <span class="keyword">this</span>));</div><div class="line"><span class="comment">// set new video player view</span></div><div class="line">mPlayerHandler.addMessage(<span class="keyword">new</span> SetNewViewForPlayback(newVideoPlayerView, <span class="keyword">this</span>));</div><div class="line"><span class="comment">// start new playback</span></div><div class="line">mPlayerHandler.addMessages(Arrays.asList(</div><div class="line">        <span class="keyword">new</span> CreateNewPlayerInstance(videoPlayerView, <span class="keyword">this</span>),</div><div class="line">        <span class="keyword">new</span> SetAssetsDataSourceMessage(videoPlayerView, assetFileDescriptor, <span class="keyword">this</span>), <span class="comment">// I use local file for demo</span></div><div class="line">        <span class="keyword">new</span> Prepare(videoPlayerView, <span class="keyword">this</span>),</div><div class="line">        <span class="keyword">new</span> Start(videoPlayerView, <span class="keyword">this</span>)</div><div class="line">));</div><div class="line"><span class="comment">// resume queue processing</span></div></pre></td></tr></table></figure>
<p>这些 Message 都是异步处理的，因此我们能在任意时刻停止消息队列对消息的处理，并投递新的消息，例如：</p>
<p>当前一个影片处于准备状态（已经调用了 MediaPlayer.prepare() 方法，而且 MediaPlayer.start() 方法正在消息队列中等待被执行），此时用户滚动了列表，所以我们需要在一个新的 View 上开始新的播放任务。在这种情况下我们会：</p>
<ol>
<li><p>停止正在执行的消息队列</p>
</li>
<li><p>移除所有等待执行的消息</p>
</li>
<li><p>投递 “Stop”, “Reset”, “Release”, “Clear Player instance” 这些消息给消息队列，它们将会在 Prepare 消息回调方法执行完成后立刻被执行。</p>
</li>
<li><p>投递 “Create new Media Player instance”, “Set Current Media Player”（将 MediaPlayer 对象绑定到当前需要播放视频的消息上），“Set data source”, “Prepare”, “Start”等消息。这样就会在新的 View 上播放相应的视频。</p>
</li>
</ol>
<p>这样我们就能依照我们设想的那样执行播放任务：停止前一个播放任务，并开始新的播放任务。</p>
<p>下面是相关的依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.github.danylovolokh:video-player-manager:0.2.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##区分列表中可见域最大的 View——列表可见域判断工具</p>
<p>第一个问题是控制视频的播放，第二个问题则是判断哪一个 View 可见域最大，并切换该 View 对应的视频为新的播放视频。下面是调用 ListItemsVisibilityCalculator 的实体，它的具体实现 SingleListViewItemActiveCalculator 会完成对应的工作。</p>
<p>在 Adapter 中被使用的 Model 类必须实现 ListItem 接口，以计算 List 中子项目的可见域：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A general interface for list items.</div><div class="line"> * This interface is used by &#123;<span class="doctag">@link</span> ListItemsVisibilityCalculator&#125;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> danylo.volokh</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ListItem</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * When this method is called, the implementation should provide a</div><div class="line">     * visibility percents in range 0 - 100 %</div><div class="line">     * <span class="doctag">@param</span> view the view which visibility percent should be</div><div class="line">     * calculated.</div><div class="line">     * Note: visibility doesn't have to depend on the visibility of a</div><div class="line">     * full view. </div><div class="line">     * It might be calculated by calculating the visibility of any</div><div class="line">     * inner View</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> percents of visibility</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getVisibilityPercents</span><span class="params">(View view)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * When view visibility become bigger than "current active" view</div><div class="line">     * visibility then the new view becomes active.</div><div class="line">     * This method is called</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setActive</span><span class="params">(View newActiveView, <span class="keyword">int</span> newActiveViewPosition)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * There might be a case when not only new view becomes active,</div><div class="line">     * but also when no view is active.</div><div class="line">     * When view should stop being active this method is called</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deactivate</span><span class="params">(View currentView, <span class="keyword">int</span> position)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ListItemsVisibilityCalculator 将追踪滚动方向，并在运行时计算子项目的可见域。子项目的可见域依赖于列表中的任意一个咨询项目，即取决于你实现 getVisibilityPercents() 方法的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This method calculates visibility percentage of currentView.</div><div class="line"> * This method works correctly when currentView is smaller then it's enclosure.</div><div class="line"> * <span class="doctag">@param</span> currentView - view which visibility should be calculated</div><div class="line"> * <span class="doctag">@return</span> currentView visibility percents</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVisibilityPercents</span><span class="params">(View currentView)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> percents = <span class="number">100</span>;</div><div class="line"></div><div class="line">    currentView.getLocalVisibleRect(mCurrentViewRect);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> height = currentView.getHeight();</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(viewIsPartiallyHiddenTop())&#123;</div><div class="line">        <span class="comment">// view is partially hidden behind the top edge</span></div><div class="line">    percents = (height - mCurrentViewRect.top) * <span class="number">100</span> / height;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(viewIsPartiallyHiddenBottom(height))&#123;</div><div class="line">        percents = mCurrentViewRect.bottom * <span class="number">100</span> / height;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> percents;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因此，每一个 View 都需要知道计算其可见域的细节。当发生滚动时，SingleListViewItemActiveCalculator 会要求每一个 View 计算其可见域大小，这也意味其开销之重。</p>
<p>当任意一个子项目的可见域大小超过了当前播放视频项目的可见域大小，就会调用 setActive 方法切换播放任务。</p>
<p>下面是与 Adapter 功能类似的的 ItemsPositionGetter 的抽象逻辑，它将建立 ListItemsVisibilityCalculator 与 ListView/RecyclerView 交互的桥梁。这样的话 ListItemsVisibilityCalculator 不需要了解它需要操作的 View 到底是 ListView 还是 RecyclerView。只需要完成它自己的工作，但仍需要一些由 ItemsPositionGetter 提供的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This class is an API for &#123;<span class="doctag">@link</span> ListItemsVisibilityCalculator&#125;</div><div class="line"> * Using this class is can access all the data from RecyclerView / </div><div class="line"> * ListView</div><div class="line"> *</div><div class="line"> * There is two different implementations for ListView and for </div><div class="line"> * RecyclerView.</div><div class="line"> * RecyclerView introduced LayoutManager that's why some of data moved</div><div class="line"> * there</div><div class="line"> *</div><div class="line"> * Created by danylo.volokh on 9/20/2015.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemsPositionGetter</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="function">View <span class="title">getChildAt</span><span class="params">(<span class="keyword">int</span> position)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">indexOfChild</span><span class="params">(View view)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getChildCount</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getLastVisiblePosition</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getFirstVisiblePosition</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样的实现无疑会让 Model 类混入一些业务逻辑，违反了设计模式的部分原则。但通过一些简单的修改就能将它们解耦。不过现在这样它用起来也没多大的问题。</p>
<p>下面是预览图和依赖：</p>
<p><img src="http://img.my.csdn.net/uploads/201601/30/1454131709_9926.gif" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.github.danylovolokh:list-visibility-utils:0.2.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##组合使用上面完成的工作</p>
<p>现在我们需要将上面的工具库结合起来使用以完成我们的功能，下面是使用 RecyclerView 实现的代码：</p>
<ol>
<li>初始化 ListItemsVisibilityCalculator，并传递列表的引用</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Only the one (most visible) view should be active (and playing).</div><div class="line"> * To calculate visibility of views we use &#123;<span class="doctag">@link</span> SingleListViewItemActiveCalculator&#125;</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ListItemsVisibilityCalculator mVideoVisibilityCalculator = <span class="keyword">new</span> SingleListViewItemActiveCalculator(</div><div class="line"><span class="keyword">new</span> DefaultSingleItemCalculatorCallback(), mList);</div></pre></td></tr></table></figure>
<p>当被激活（播放视频）的 View 发生改变，DefaultSingleItemCalculatorCallback 只调用 ListItem.setActive 方法，但你可以重载该方法并按照你的需求实现相应逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Methods of this callback will be called when new active item is found &#123;<span class="doctag">@link</span> Callback#activateNewCurrentItem(ListItem, View, int)&#125;</div><div class="line"> * or when there is no active item &#123;<span class="doctag">@link</span> Callback#deactivateCurrentItem(ListItem, View, int)&#125; - this might happen when user scrolls really fast</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">ListItem</span>&gt;</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activateNewCurrentItem</span><span class="params">(T item, View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deactivateCurrentItem</span><span class="params">(T item, View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>初始化 VideoPlayerManager</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Here we use &#123;<span class="doctag">@link</span> SingleVideoPlayerManager&#125;, which means that only one video playback is possible.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> VideoPlayerManager&lt;MetaData&gt; mVideoPlayerManager = <span class="keyword">new</span> SingleVideoPlayerManager(<span class="keyword">new</span> PlayerItemChangeListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPlayerItemChanged</span><span class="params">(MetaData metaData)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ol>
<li>为 RecyclerView 设置滚动监听，并传递滚动事件给列表可见工具库处理。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrollStateChanged</span><span class="params">(RecyclerView view, <span class="keyword">int</span> scrollState)</span> </span>&#123;</div><div class="line"> mScrollState = scrollState;</div><div class="line"> <span class="keyword">if</span>(scrollState == RecyclerView.SCROLL_STATE_IDLE &amp;&amp; mList.isEmpty())&#123;</div><div class="line"></div><div class="line"> mVideoVisibilityCalculator.onScrollStateIdle(</div><div class="line">          mItemsPositionGetter,</div><div class="line">          mLayoutManager.findFirstVisibleItemPosition(),</div><div class="line">          mLayoutManager.findLastVisibleItemPosition());</div><div class="line"> &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line"> <span class="keyword">if</span>(!mList.isEmpty())&#123;</div><div class="line">   mVideoVisibilityCalculator.onScroll(</div><div class="line">         mItemsPositionGetter,</div><div class="line">         mLayoutManager.findFirstVisibleItemPosition(),</div><div class="line">         mLayoutManager.findLastVisibleItemPosition() -</div><div class="line">         mLayoutManager.findFirstVisibleItemPosition() + <span class="number">1</span>,</div><div class="line">         mScrollState);</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ol>
<li>创建 ItemsPositionGetter</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ItemsPositionGetter mItemsPositionGetter = </div><div class="line"><span class="keyword">new</span> RecyclerViewItemPositionGetter(mLayoutManager, mRecyclerView);</div></pre></td></tr></table></figure>
<ol>
<li>在 onResume() 中调用方法以开始计算子项目的可见域，在我们显示出列表时选出可见域最大的子项目</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onResume();</div><div class="line">    <span class="keyword">if</span>(!mList.isEmpty())&#123;</div><div class="line">        <span class="comment">// need to call this method from list view handler in order to have filled list</span></div><div class="line"></div><div class="line">        mRecyclerView.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">                mVideoVisibilityCalculator.onScrollStateIdle(</div><div class="line">                        mItemsPositionGetter,</div><div class="line">                        mLayoutManager.findFirstVisibleItemPosition(),</div><div class="line">                        mLayoutManager.findLastVisibleItemPosition());</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后就完成了，在滚动列表中播放许多视频：</p>
<p><img src="http://img.my.csdn.net/uploads/201601/30/1454131535_2903.gif" alt=""></p>
<p>这个项目关键部分的讲解基本上已经完成了，下面是具体的代码和范例：</p>
<p><a href="https://github.com/danylovolokh/VideoPlayerManager" target="_blank" rel="external">https://github.com/danylovolokh/VideoPlayerManager</a></p>
<p>感谢阅读 ;)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/在滚动列表中播放视频/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/在滚动列表中播放视频/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/用RxJava替代EventBus/" title="用RxJava替代EventBus" itemprop="url">用RxJava替代EventBus</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/mobiwise-blog/use-rxjava-instead-of-event-bus-libraries-aa78b5023097#.k0ecseaz7" target="_blank" rel="external">use Rxjava instead of Event Bus libraries</a></li>
</ul>
<p>在Android社区，每个人都在讨论RxJava，以及为什么我们应该在Android项目中使用RxJava。当我们开始在Android项目中实现RxJava后，我们注意到，我们的项目不需要引入Otto（或任何其他事件总线库）。通过这篇博客，我将展示我们是如何在项目中用RxJava替代Otto的。</p>
<h1 id="我们项目中的MVP模式是怎么实现的"><a href="#我们项目中的MVP模式是怎么实现的" class="headerlink" title="我们项目中的MVP模式是怎么实现的"></a>我们项目中的MVP模式是怎么实现的</h1><p>开始开发我们的无线流媒体应用Radyoland的时候，我们决定使用MVP模式来设计我们的代码底层，项目架构等。我们已经分成了几层（domain，model，app等）</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*TuU0ZvYeLsaypR8PIeNeyw.png" alt=""></p>
<p>在model层，我们有基于RESTful的类和接口。在domain层，我们试图实现应用程序的业务逻辑，所以我们写了一些用例类。</p>
<h1 id="为什么我们当初使用event-bus？"><a href="#为什么我们当初使用event-bus？" class="headerlink" title="为什么我们当初使用event bus？"></a>为什么我们当初使用event bus？</h1><p>如果你的Android应用超过一层，这就意味着你需要在这些层之间传输数据。就我们而言，我们认为，如果我们为数据总线和UI总线定义一个BusUtil类，我们就可以轻松地在这些层（model，domain，presentation）之间传输数据。</p>
<p>你可以“订阅” ，并从总线发布的特定事件“取消订阅” 。这种方法背后的逻辑是这样运作的。</p>
<p>在我们的UsecaseController，PresenterImp类中，我们发出一个事件，请求REST实现类中描述的数据并且订阅此事件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void getRadioList() &#123;</div><div class="line">    Call&lt;RadioWrapper&gt; radioWrapperCall = restInterface.getRadioList();</div><div class="line">    radioWrapperCall.enqueue(new Callback&lt;RadioWrapper&gt;() &#123;</div><div class="line">        @Override</div><div class="line">        public void onResponse(Response&lt;RadioWrapper&gt; response, Retrofit retrofit) &#123;</div><div class="line">            dataBus.post(response.body());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onFailure(Throwable t) &#123;</div><div class="line">            Timber.e(t.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当我们调用了带有回调参数的异步数据请求方法，我们用总线发布结果数据，并订阅该事件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@Subscribe</div><div class="line">@Override</div><div class="line">public void onRadioListLoaded(RadioWrapper radioWrapper) &#123;</div><div class="line">    new SaveDatabase(radioWrapper, databaseSource).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</div><div class="line">    uiBus.post(radioWrapper);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后发布数据以更新UI 。activity或fragment应该在onResume()中订阅事件并在onPause()中解除订阅 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@Subscribe</div><div class="line">@Override</div><div class="line">public void onRadioListLoaded(RadioWrapper radioWrapper) &#123;</div><div class="line">    radioListView.onListLoaded(radioWrapper);</div><div class="line">    radioListView.dismissLoading();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种实现方法效果还不错。但由于我们是优秀的Android程序猿，总是追求更好的解决方案。我们找到了一个方案，可以摆脱所有的回调和订阅方法。我们决定在代码中使用RxJava和RxAndroid。</p>
<h1 id="let-me-tell-you-how-we-implemented-Rxjava"><a href="#let-me-tell-you-how-we-implemented-Rxjava" class="headerlink" title="let me tell you how we implemented Rxjava"></a>let me tell you how we implemented Rxjava</h1><p>我们是怎么实现Rxjava的</p>
<p>首先，我们需要改变所有RestInterface的返回类型 。</p>
<p>在没有RxJava的情况下 ;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@GET(&quot;&quot;)</div><div class="line">Call&lt;RadioWrapper&gt; getRadioList();</div></pre></td></tr></table></figure>
<p>有了Rxjava</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@GET(&quot;&quot;)</div><div class="line">Observable&lt;RadioWrapper&gt; getRadioList();</div></pre></td></tr></table></figure>
<p>在REST实现类中，我们有API调用方法。我分享了其中的一个。使用RxJava启动后，我们需要改变这种方法的实现。我们把方法的返回类型改成Observable。经过了必要的改变后，方法看起来像这样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@RxLogObservable</div><div class="line">@Override</div><div class="line">public Observable&lt;RadioWrapper&gt; getRadioList() &#123;</div><div class="line">    return restInterface.getRadioList();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们完成了REST实现类。在此之后，我们需要改变用例的实现类和方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public Observable&lt;RadioWrapper&gt; getRadioList() &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Get radiolist observable from Cache</div><div class="line">     */</div><div class="line">    Observable&lt;RadioWrapper&gt; radioListDB =  databaseSource.getRadioList()</div><div class="line">            .filter(radioWrapper -&gt; radioWrapper.radioList.size() &gt; 0)</div><div class="line">            .subscribeOn(Schedulers.computation());</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Load radiolist from api layer and save it to DB.</div><div class="line">     */</div><div class="line">    Observable&lt;RadioWrapper&gt; radioListApi = apiSource.getRadioList()</div><div class="line">            .doOnNext(radioWrapper -&gt; &#123;</div><div class="line">                Observable.create(subscriber -&gt; &#123;</div><div class="line">                    databaseSource.save(radioWrapper);</div><div class="line">                    subscriber.onCompleted();</div><div class="line">                &#125;).subscribeOn(Schedulers.computation()).subscribe();</div><div class="line">            &#125;)</div><div class="line">            .subscribeOn(Schedulers.io());</div><div class="line"></div><div class="line">    /**</div><div class="line">     * concat db and api observables</div><div class="line">     */</div><div class="line">    return Observable</div><div class="line">            .concat(radioListDB, radioListApi)</div><div class="line">            .observeOn(AndroidSchedulers.mainThread());</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，我们的方法getRadioList返回一个Observable stream到我们的UI。正如你所看到的，我们根本不<br>需要通过事件总线发送数据。你还可以过滤，合并，缓存，或根据你的需要操作这个数据流。</p>
<h1 id="我们学到了什么"><a href="#我们学到了什么" class="headerlink" title="我们学到了什么"></a>我们学到了什么</h1><p>虽然RxJava也不是那么好用，但是通过使用RxJava替换Otto，我们已经从代码中删除了许多冗余的回调代码块。在我看来，对于任何REST API的异步数据请求，RxJava都是最佳选择。<br>如果你有更好的解决方法，请随意在这里评论或分享例子。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/用RxJava替代EventBus/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/用RxJava替代EventBus/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/如何修复编译时的MultiDex崩溃/" title="如何修复编译时的MultiDex崩溃" itemprop="url">如何修复编译时的MultiDex崩溃</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/sebs-top-tips/psa-fix-multidex-build-crashes-ae2b81bcf711" target="_blank" rel="external">PSA: fix MultiDex build crashes</a></li>
<li>原文作者 : <a href="https://medium.com/@seebrock3r" target="_blank" rel="external">Sebastiano Poggi</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/zijianwang90" target="_blank" rel="external">zijianwang90</a> </li>
</ul>
<p>[“太长不想看了”在文章末尾]</p>
<p>是否有那么一天，你曾经在编译你的项目时候因为以下这样的错误而失败了：</p>
<blockquote>
<p>trouble writing output:<br>Too many field references: 131000; max is 65536.<br>You may try using –multi-dex option.</p>
</blockquote>
<p>为啥？也许是最新的Play服务更新造成的，又或许是你应用中的某某统计SDK造成的。但是有一点是可以肯定的：你的应用成为了拥有超过六万五千个方法或变量的应用之一。</p>
<p>若在一年之前，这也许是个大问题。当时有一些办法可以避免这个问题，包括一些拆分dex文件的方法，但这些方法往往并不完全奏效。</p>
<p>#MultiDex?<br>幸运的是，自从谷歌引入了<strong>MultiDex</strong>机制，上述情况就非常容易解决了。在你的build.gradle中做如下配置即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">  // ...</div><div class="line">  defaultConfig &#123;</div><div class="line">    // ...</div><div class="line">    multiDexEnabled true</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>##缺点<br><strong>Multidex也有一些缺点</strong>。首先，<strong>编译时间增加</strong>。其次，在Delvik虚拟机下（非ART），由于classloader需要读取多个dex文件，所以<strong>应用的启动时间会大幅增加</strong>。</p>
<p>但更严重的是，他有时候会造成你的<strong>编译崩溃</strong>。是的，编译崩溃，不是应用崩溃。</p>
<blockquote>
<p>UNEXPECTED TOP-LEVEL ERROR:<br>java.lang.OutOfMemoryError: GC overhead limit exceeded<br>  at com.android.dx.cf.code.ExecutionStack.copy(ExecutionStack.java:66)<br>  at com.android.dx.cf.code.Frame.makeExceptionHandlerStartFrame(Frame.java:397)<br>  at com.android.dx.cf.code.Ropper.processBlock(Ropper.java:916)<br>  at com.android.dx.cf.code.Ropper.doit(Ropper.java:742)<br>  at com.android.dx.cf.code.Ropper.convert(Ropper.java:349)<br>  at com.android.dx.dex.cf.CfTranslator.processMethods(CfTranslator.java:280)<br>  at com.android.dx.dex.cf.CfTranslator.translate0(CfTranslator.java:137)<br>  at com.android.dx.dex.cf.CfTranslator.translate(CfTranslator.java:93)<br>  at com.android.dx.command.dexer.Main.processClass(Main.java:729)<br>  at com.android.dx.command.dexer.Main.processFileBytes(Main.java:673)<br>  at com.android.dx.command.dexer.Main.access\$300(Main.java:83)<br>  at com.android.dx.command.dexer.Main$1.processFileBytes(Main.java:602)<br>  at com.android.dx.cf.direct.ClassPathOpener.processArchive(ClassPathOpener.java:284)<br>  at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:166)<br>  at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)<br>  at com.android.dx.command.dexer.Main.processOne(Main.java:632)<br>  at com.android.dx.command.dexer.Main.processAllFiles(Main.java:505)<br>  at com.android.dx.command.dexer.Main.runMultiDex(Main.java:334)<br>  at com.android.dx.command.dexer.Main.run(Main.java:244)<br>  at com.android.dx.command.dexer.Main.main(Main.java:215)<br>  at com.android.dx.command.Main.main(Main.java:106)</p>
</blockquote>
<p>以上这些错误大致意思就是我们在生成Dex阶段内存不足了。</p>
<p>#解决办法（太长不想看了）<br>感谢那谁给我意见（不好意思忘了是谁了，时间有点久了），在绞尽脑汁了一段时间之后，我找到了一个非常简单的解决办法。</p>
<p>那就是在你相应module的build.gradle文件中做出如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">  // ...</div><div class="line">  dexOptions &#123;</div><div class="line">    javaMaxHeapSize “2048M”</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>搞定！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/如何修复编译时的MultiDex崩溃/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/如何修复编译时的MultiDex崩溃/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/深入理解ContentTransition(part2)/" title="深入理解Content Transition  (part 2)" itemprop="url">深入理解Content Transition  (part 2)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 :  <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-content-transitions-in-depth-part2.html" target="_blank" rel="external">Content Transitions In-Depth (part 2)</a></li>
</ul>
<ul>
<li>译者 : <a href="https://github.com/tiiime" target="_blank" rel="external">tiiime</a></li>
<li>校对者: <a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a></li>
<li>状态 :  完成</li>
</ul>
<p>#深入理解Content Transition</p>
<p>这篇文章会深度分析 Content Transitions 和它在 Activity &amp; Fragment Transitions API 中的作用。这篇文章是下面这个系列中的第二篇：</p>
<ul>
<li>Part 1: <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">在 Activity 和 Fragment 中使用 Transition </a></li>
<li>Part 2: <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-content-transitions-in-depth-part2.html" target="_blank" rel="external">深入理解 Content Transition</a></li>
<li>Part 3a: <a href="http://www.androiddesignpatterns.com/2015/01/activity-fragment-shared-element-transitions-in-depth-part3a.html" target="_blank" rel="external">深入理解共享元素 Transition</a></li>
<li>Part 3b:  <a href="http://www.androiddesignpatterns.com/2015/03/activity-postponed-shared-element-transitions-part3b.html" target="_blank" rel="external">延迟共享元素的 Transition</a></li>
<li>Part 3c: 共享元素回调实践 (coming soon!)</li>
<li>Part 4:  Activity &amp; Fragment 过渡动画示例(coming soon!)</li>
</ul>
<p>我们先来总结下在 <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">part 1</a> 中提到的关于 Content Transitions 的知识点，然后<br>说一说在 Android Lollipop 中是怎样使用它来构建合适的过渡动画。</p>
<hr>
<p>##Content Transition 是什么？</p>
<p>Content transition 决定了非共享元素 View (也称为 transitioning view) 在<br>Activity &amp; Fragment 过渡期间是如何进入或退出场景的。出于 Google 新的设计语言<br><a href="http://www.google.com/design/spec/animation/meaningful-transitions.html" target="_blank" rel="external">Material Design</a> , content transitions 允许我们协调 Activity/Fragment 中每一个<br> view 的进入和退出 transition，轻松搞定流畅的屏幕切换动作。<br>开始使用 Android Lollipop，调用下面这些<a href="http://developer.android.com/reference/android/view/Window.html" target="_blank" rel="external"> Window </a> 和<br><a href="http://developer.android.com/reference/android/app/Fragment.html" target="_blank" rel="external"> Fragment </a> 方法可以通过程序设置 content transitions :</p>
<ul>
<li><p><strong>setExitTransition()</strong> - 当 A <strong>启动</strong> B 时， <strong>A</strong> 中 views <strong>离开</strong>场景的退出过渡动画</p>
</li>
<li><p><strong>setEnterTransition()</strong> - 当 A <strong>启动</strong> B 时， <strong>B</strong> 中 views <strong>进入</strong>场景的进入过渡动画</p>
</li>
<li><p><strong>setReturnTransition()</strong> - 当 B <strong>返回</strong> A 时， <strong>B</strong> 中 views <strong>离开</strong>场景的返回过渡动画</p>
</li>
<li><p><strong>setReenterTransition()</strong> - 当 B <strong>返回</strong> A 时， <strong>A</strong> 中 views <strong>进入</strong>场景的重入过渡动画</p>
</li>
</ul>
<p>(注:A 和 B 是Activity 见 <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">part 1</a>)。</p>
<p><a href="http://www.androiddesignpatterns.com/assets/videos/posts/2014/12/15/games-opt.mp4" target="_blank" rel="external"><strong>Video 2.1</strong></a> - Content transitions in the Google Play Games app (as of v2.2). Click to play.</p>
<hr>
<p><a href="http://www.androiddesignpatterns.com/assets/videos/posts/2014/12/15/games-opt.mp4" target="_blank" rel="external"><strong>Video 2.1</strong></a>作为示例阐明了在 Google Play Games app 中是如何使<br>用 content transitions 实现流畅的 activitiy 切换动画。当第二个 activity 启动，<br>它的<strong>进入</strong> content transition 轻轻地从屏幕底部边缘将头像推入场景。按下返回按钮后，<br>第二个 activity 的<strong>返回</strong> content transition 将图层分成上下两块，分别推出屏幕。</p>
<hr>
<p>目前为止我们对 content transitions 的分析仅仅停留在表面，一些重要的问题仍然没有涉及。<br>例如 Content Transition 在底层是如何实现的？都有哪些类型的 <strong>Transition</strong> 对象可以使用?框架是如何确定哪些 view<br>是 transitioning view? 在 content transitions 中一个 <strong>ViewGroup</strong> 和它的子视图能不能当成一个整体<br>执行动画?下面我们就来一个一个解答这些问题。</p>
<hr>
<p>##Content Transitions 底层深入</p>
<p>上篇文章我们说过 Transition 的两个主要职责分别是获取目标视图的开始结束状态和创建这两个状态间的过渡动画。同样，框架必须先改变每个 transitioning view 的可见性并将状态信息交给 content<br>transition ，它才能创建过渡动画。更准确的说，当 Activity <strong>A</strong> 启动 Activity <strong>B</strong> 将会出现以下事件：<a id="1" href="#b1">(1)</a></p>
<ol>
<li><p>Activity <strong>A</strong> 调用 <strong>startActivity()</strong></p>
<ul>
<li>框架首先会遍历 <strong>A</strong> 的 view 层次结构，确定当 <strong>A</strong> 的退出 transition 运行后有哪些<br>transitioning views 会退出场景。</li>
<li><strong>A</strong> 的退出 transition 捕获 A 中 transitioning views 的起始状态。</li>
<li>框架将 <strong>A</strong> 中所有 transitioning views 设置为<strong>不可见</strong>。</li>
<li>在下一个画面中，<strong>A</strong> 的退出 transition 捕获 <strong>A</strong> 中所有 transitioning views 的结束状态。</li>
<li><strong>A</strong> 的退出 transition 比较每一个 transitioning view 开始和结束状态的不同，<br> 并基于这些信息创建一个 <strong>Animator</strong>，最后运行 <strong>Animator</strong> 将所有 transitioning views<br> 移出场景。</li>
</ul>
</li>
<li><p>Activity <strong>B</strong> 被启动</p>
<ul>
<li>框架遍历 <strong>B</strong> 的 view 层次结构， 确定当 B 的进入 transition 运行后有哪些<br> transitioning views 会进入场景。</li>
<li><strong>B</strong> 的进入 transition 捕获 B 中 transitioning views 的起始状态。</li>
<li>框架将 <strong>B</strong> 中所有  transitioning views  设置为<strong>可见</strong></li>
<li>在下一个画面中，<strong>B</strong> 的进入 transition 捕获 <strong>B</strong> 中所有 transitioning views 的结束状态。</li>
<li><strong>B</strong> 的进入 transition 比较每一个 transitioning view 开始和结束状态的不同，<br>并基于这些信息创建一个 <strong>Animator</strong>，最后运行 <strong>Animator</strong> 将所有 transitioning views<br>移入场景。</li>
</ul>
</li>
</ol>
<hr>
<p>框架通过在<strong>可见</strong>和<strong>不可见</strong>之间切换每个 transitioning view 的可见性来保证<br>content transition 能够获得用来构建目标动画所需要的状态信息。<br>显然所有的 content <strong>Transition</strong> 对象至少要能够获取和记录每个 transitioning view<br>起始和结束状态的可见性。还好 <a href="https://developer.android.com/reference/android/transition/Visibility.html" target="_blank" rel="external">Visibility</a> 这个抽象类已经提供了这个功能 :<br>需要创建并返回 (让 view 进入/退出场景的) <strong>Animator</strong> 的 <strong>Visibility</strong><br>子类只需要实现 <a href="https://developer.android.com/reference/android/transition/Visibility.html#onAppear(android.view.ViewGroup,%20android.transition.TransitionValues,%20int,%20android.transition.TransitionValues,%20int)" target="_blank" rel="external"><strong>onAppear()</strong></a>  和 <a href="https://developer.android.com/reference/android/transition/Visibility.html#onDisappear(android.view.ViewGroup,%20android.transition.TransitionValues,%20int,%20android.transition.TransitionValues,%20int)" target="_blank" rel="external"><strong>onDisappear()</strong></a> 这两个工厂方法。<br>从 API 21 开始，有三个已经写好的 <strong>Visibility</strong> 实现( <a href="https://developer.android.com/reference/android/transition/Fade.html" target="_blank" rel="external"><strong>Fade</strong></a>, <a href="https://developer.android.com/reference/android/transition/Slide.html" target="_blank" rel="external"><strong>Slide</strong></a> 和 <a href="https://developer.android.com/reference/android/transition/Explode.html" target="_blank" rel="external"><strong>Explode</strong></a>)，可以使用它们来构建  Activity 和 Fragment 的 content transitions。<br>有必要的话也可以自己实现 Visibility 类达到想实现的效果。后边的文章会有具体介绍。</p>
<hr>
<p>##Transitioning Views 和 Transition Groups<br>直到现在，我们已经假设 content transitions 操作一组叫做 transitioning views 的非共享 view 。<br>在这节中，我们将探讨 Transition 框架如何确定哪些 View 是非共享 View，以及如何使用 transition group 深度定制框架</p>
<p>Transition 开始前，框架会在 Activity 窗口(或 Fragment) 的视图层上执行一个递归的搜索，用来<br>构建 transitioning views 的集合。这个搜索通过对图层的根视图递归调用重写的<strong>ViewGroup#captureTransitioningViews</strong> 方法启动，部分<a href="https://github.com/android/platform_frameworks_base/blob/lollipop-release/core/java/android/view/ViewGroup.java#L6243-L6258" target="_blank" rel="external">源码</a>如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">captureTransitioningViews</span><span class="params">(List&lt;View&gt; transitioningViews)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (getVisibility() != View.VISIBLE) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isTransitionGroup()) &#123;</div><div class="line">        transitioningViews.add(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">int</span> count = getChildCount();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            View child = getChildAt(i);</div><div class="line">            child.captureTransitioningViews(transitioningViews);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><a href="http://www.androiddesignpatterns.com/assets/videos/posts/2014/12/15/webview-opt.mp4" target="_blank" rel="external"><strong>Video 2.2</strong></a> - A simple Radiohead app that illustrates a potential bug involving transition groups and WebViews. Click to play.</p>
<hr>
<p>这个递归调用很简单: 框架遍历树的每一层，直到找到一个<strong>可见的</strong><a href="https://github.com/android/platform_frameworks_base/blob/lollipop-release/core/java/android/view/View.java#L19351-L19362" target="_blank" rel="external"> leaf view </a> (子视图)或者一个 transition group。Transition groups 本质上允许我们在 Activity/Fragment 的 transition<br>期间将全部 <strong>ViewGroups</strong> 当作一个整体执行过渡动画。如果一个 <strong>ViewGroup</strong> 的<br><a href="https://developer.android.com/reference/android/view/ViewGroup.html#isTransitionGroup()" target="_blank" rel="external"><code>isTransitionGroup ()</code></a> <a id="2" href="#b2">(2)</a>方法返回值为 <strong>true</strong>，它和它的子视图会被当作一<br>个整体来执行过渡动画。否则，这个递归搜索会继续执行下去， 这个 ViewGroup 的子视图在动画期间<br>会执行自己的独立的过渡动画。搜索最终会返回一个全部由 content transition<br> 执行动画的 transitioning views 集合 。<a id="3" href="#b3">(3)</a></p>
<hr>
<p>上面的 <a href="http://www.androiddesignpatterns.com/assets/videos/posts/2014/12/15/games-opt.mp4" target="_blank" rel="external"><strong>Video 2.1</strong></a> 展示了 transition groups  的效果。在 enter transition ，<br>用户头像是作为一个单独的 View 进入屏幕，return transition 时却是和包含它的 parent<br><strong>ViewGroup</strong> 一起消失。在  Google Play Games 里可能用了一个 transition group<br>来实现在返回前一个 activity 时，让当前场景拦腰斩断的效果。</p>
<hr>
<p>有时 transition groups 还被用来修复 Activity/Fragment transitions 中诡异的 bugs。<br>例如，Video 2.2中: <strong>调用 Activity</strong> 显示了一个电台司令专辑图的网格布局，<br><strong>被调用 Activity</strong> 展示了一个背景标题图，一个共享元素专辑封面图还有一个 <strong>WebView</strong>。<br>这个 App 使用了一个和 Google Play Games app 类似的 return transition，将背景图和底部的<br><strong>WebView</strong> 分别推出屏幕。然而这里有个小故障导致 <strong>WebView</strong> 不能流畅的退出屏幕。</p>
<p>好吧，错误在哪呢？原来 <strong>WebView</strong> 是一个 <strong>ViewGroup</strong>，因此在默认情况下 WebView 不会被当作 transitioning view<br>的。当 return transition 被执行时，<strong>WebView</strong> 会被完全忽略，直到过渡动画结束才会被移除屏幕。<br>找到问题就好解决了，只要在 return transition 开始前调用 <code>webView.setTransitionGroup(true)</code><br>就能修复这个bug。</p>
<hr>
<p>##结语</p>
<p>总之，这篇文章讲了三个重点:</p>
<ul>
<li>Content transition 决定了 Activity/Fragment 中非共享元素视图(被称为 transitioning views)<br>在 Activity/Fragment transition 期间如何进入或退出场景。</li>
<li>Content transitions 被触发是因为它的 transitioning views 可见性改变  ，并且应该总是继承<br> <strong>Visibility</strong> 这个抽象类。</li>
<li>Transition groups 可以让我们在 content transition 期间将 <strong>ViewGroups</strong><br> 当作一个整体执行过渡动画。</li>
</ul>
<p>希望这篇文章能够帮到你，欢迎留下评论～</p>
<hr>
<ol>
<li>Activities 和 Fragments 在  return/reenter transitions 期间出现的一系列事件相似。<br><a id="b1" href="#1">↩</a></li>
<li>如果 ViewGroup 有一个非空的  background drawable 或者非空的默认 transition name 那么<br><code>isTransitionGroup()</code> 将返回 <strong>true</strong> (所述方法<a href="https://developer.android.com/reference/android/view/ViewGroup.html#isTransitionGroup()" target="_blank" rel="external">文档</a>)<br><a id="b2" href="#2">↩</a></li>
<li>当 transition 运行时，任何在 content <strong>Transition</strong> 对象中被明确地 <a href="https://developer.android.com/reference/android/transition/Transition.html#addTarget(android.view.View)" target="_blank" rel="external"> added </a>或<br><a href="https://developer.android.com/reference/android/transition/Transition.html#excludeTarget(android.view.View,%20boolean)" target="_blank" rel="external"> excluded </a> 的 view 也会被考虑。<a id="b3" href="#3">↩</a></li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/深入理解ContentTransition(part2)/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/深入理解ContentTransition(part2)/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/如何在本地搭建一个Android应用crashing跟踪系统－ACRA/" title="如何在本地搭建一个Android应用crashing跟踪系统－ACRA" itemprop="url">如何在本地搭建一个Android应用crashing跟踪系统－ACRA</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://inthecheesefactory.com/blog/how-to-install-and-use-acra-android/en" target="_blank" rel="external">How to setup ACRA, an Android Application Crash Tracking system, on your own host</a></li>
</ul>
<p>在开发一款移动app时的一个事实是会有很多约束，比如硬件（CPU、RAM、Battery 等等）。如果你的代码设计不是很好，你会遇到一个非常让人头疼的问题：“Crash”,研究表明：</p>
<p>&gt;</p>
<blockquote>
<p>*应用崩溃时绝大多数应用使用者抱怨的问题。</p>
</blockquote>
<p>此外</p>
<p>&gt;</p>
<ul>
<li>如果应用程序联系崩溃三次，大约一半的用户将会卸载这款应用。</li>
</ul>
<p>崩溃跟踪系统，帮助开发者能够直接的葱用户的设备收集每一个崩溃原因，是不是发现这个功能很特殊。目前最受欢迎的崩溃跟踪系统是 <a href="http://fabric.io/" target="_blank" rel="external">Crashlytics</a>和<a href="http://blog.parse.com/2014/12/09/introducing-parse-crash-reporting-2/" target="_blank" rel="external">Parse Crash Reporting</a>，这两个系统都是完全免费的。开发者可以免费的集成他们在自己的应用中。不论什么时候app崩溃了，整个bug信息将会发送到后台，允许开发人员用最简单的方式去解决这些bug。通过这个方法，你可以在短时间内迭代一款不会影响正常使用的应用。</p>
<p>然而，提供崩溃信息收集的厂商收集这些崩溃信息同时也收集了用户信息，这可能让引起大公司担心用户隐私。</p>
<p>所以，这儿有没有崩溃信息跟踪系统可以让我们搭建在自己的服务器上？那么就不存在泄漏用户隐私的担忧了。当然有了，并且这个系统提供了非常简单的搭建方法。在这里我们来介绍下<a href="https://www.acra.gov.sg/home/" target="_blank" rel="external">Application Crash Reporting on Android (ACRA)</a>,一个库允许Android应用自动地发送崩溃信息到自己的服务器。</p>
<p>下面将会介绍如何去搭建。</p>
<h2 id="搭建一个服务器"><a href="#搭建一个服务器" class="headerlink" title="搭建一个服务器"></a>搭建一个服务器</h2><p>服务器端是一个先决条件，让我们先从搭建服务器端开始。</p>
<p>由于ACRA设计的很好并且很受欢迎。它允许开发者开发自己的服务器系统，并且现在我们可以看到很多这样的系统。即便如此我觉得最好的是Acralyzer，这个也是由ACRA团队研发。Acralyzer工作在Apache CouchDB，所以<br>这里没有必要安装除了CouchDB以外的软件。</p>
<p>Acralyzer是一个功能相当齐全的后端崩溃跟踪系统。来自不同原因的相同堆栈轨迹将会被分组成一个单一的问题。如果你解决了所有问题，你可以非常便捷的关闭Acralyzer服务，并且这种关闭服务的操作时实时的，我发现系统唯一的缺点是它的ui让人感到不舒服，但是谁会在乎这个？它是为开发者开发的。</p>
<p>安装起来也很简单，下面将介绍如何在Ubuntu安装Acralyzer。</p>
<p>打开命令窗口，开始安装couchdb<br>&gt;</p>
<blockquote>
<p>*apt-get install couchdb</p>
</blockquote>
<p>Test the installation with this command:</p>
<p>测试是否安装成功。<br>&gt;</p>
<blockquote>
<p>*curl <a href="http://127.0.0.1:5984" target="_blank" rel="external">http://127.0.0.1:5984</a></p>
</blockquote>
<p>如果正确安装，会显示如下：<br>&gt;</p>
<blockquote>
<p>*{“couchdb”:”Welcome”,”version”:”1.2.0”}</p>
</blockquote>
<p>编辑etc/couchdb/local.ini允许我们通过外部IP(默认的访问会通过127.0.0.1)去访问CouchDB。仅仅改变两行实现这个功能：<br>&gt;</p>
<blockquote>
<p><em>;port = 5984
</em>;bind_address = 127.0.0.1</p>
</blockquote>
<p>改变为<br>&gt;</p>
<blockquote>
<p><em>port = 5984
</em>bind_address = 0.0.0.0</p>
</blockquote>
<p>在同一个文件夹下，你需要添加username/password作为管理员账户。找到这一行（应该会在文件末尾）<br>&gt;</p>
<blockquote>
<p>*[admins]</p>
</blockquote>
<p>下一行添加username/password 形式为username = password，比如：<br>&gt;</p>
<blockquote>
<p>*[nuuneoi = 12345]</p>
</blockquote>
<p>请不要对在这里书写明文密码感到担心，一旦CouchDB重启后，你的密码将会自动地散列，并且将会是不可读的，</p>
<p>保存你刚刚编辑的文件同时通过命令行重启hashed：<br>&gt;</p>
<blockquote>
<p>*curl -X POST <a href="http://localhost:5984/_restart" target="_blank" rel="external">http://localhost:5984/_restart</a> -H”Content-Type: application/json”</p>
</blockquote>
<p>从现在起，你将可以通过浏览器访问CouchDB。这个web服务我们称之为Futon，一个CouchDB UI管理后台。在你的浏览器中打开这个地址。</p>
<p>&gt;</p>
<blockquote>
<p>*http://<your_server_ip>:5984/_utils</your_server_ip></p>
</blockquote>
<p>让我们开始吧，Futon。<br><img src="http://inthecheesefactory.com/uploads/source/acra/futon.png" alt=""></p>
<p>首先，通过你之前设置的管理员账号登陆这个系统。</p>
<p>现在我们开始安装一个acro-storage (Acralyzer’s Storage Endpoing).在左边的菜单，点击Replicator，然后填写远程存储改为本地存储的表单。<br>&gt;</p>
<blockquote>
<p>*from Remote Database: <a href="http://get.acralyzer.com/distrib-acra-storage" target="_blank" rel="external">http://get.acralyzer.com/distrib-acra-storage</a> to Local Database: acra-myapp</p>
</blockquote>
<p>点击Replicate然后等待，知道这个过程结束。</p>
<p>下一步安装Acralyzer通过同样的方法，但是参数是不同的。<br>&gt;</p>
<blockquote>
<p>*from Remote Database: <a href="http://get.acralyzer.com/distrib-acralyzer" target="_blank" rel="external">http://get.acralyzer.com/distrib-acralyzer</a> to Local Database: acralyzer</p>
</blockquote>
<p>点击Replicate安装。</p>
<p>如果你操作正确，系统将会有两个数据库，acra-myapp 和 acralyzer。</p>
<p><img src="http://inthecheesefactory.com/uploads/source/acra/acra3.png" alt=""></p>
<p>我门就快大功告成了，下一步，我们需要为这个客户端创建一个用户，打开浏览器，然后打开这个网址：<br>&gt;</p>
<blockquote>
<p>*http://<your_server_ip>:5984/acralyzer/_design/acralyzer/index.html<br><img src="http://inthecheesefactory.com/uploads/source/acra/admincreateuser.png" alt=""></your_server_ip></p>
</blockquote>
<p>填写你想要的Username/Password，然后点击Create User，这些信息将会出现。<br><img src="http://inthecheesefactory.com/uploads/source/acra/users2.png" alt=""></p>
<p>复制这些信息，然后粘贴到你的文本编辑器，我们可能会用这个在客户端设置。</p>
<p>最后一件事是限制访问权限来保护在acra-myapp里面的数据，进入acra-myapp然后点击Securities，填写用户角色分配；<br>&gt;</p>
<blockquote>
<p>*[“reader”]<br><img src="http://inthecheesefactory.com/uploads/source/acra/reader.png" alt=""></p>
</blockquote>
<p>完工！<br>在这些结束后，你可以通过同一个网址访问这个控制台，去Admin选项卡，并选择Users。</p>
<p>&gt;</p>
<blockquote>
<p>*[http://<your_server_ip>:5984/acralyzer/_design/acralyzer/index.html</your_server_ip></p>
</blockquote>
<p>请注意acro-myapp只能够为一款应用服务。以防你想为另外一款应用创建一个后台，请通过同样的过程复制另外一个acro-storage，但是改变本地数据库名为acra-<your_app_name>。请注意，有必要去通过acra- 去开启服务，或者它不能够在仪表盘中罗列为选择项供我们去选择。</your_app_name></p>
<p>如果在系统中有不止一款应用，在Acralyzer的仪表盘中将会有一个下拉列表，让我们去选择看哪一个的问题。你可以试一试。</p>
<p>在客户端设置ACRA。</p>
<p>在客户端中设置ACRA很简单，首先，在你的 build.gradle里添加ACRA的依赖配置信息。<br>&gt;</p>
<blockquote>
<p>*compile ‘ch.acra:acra:4.6.1’</p>
</blockquote>
<p>同步你的gradle文件，然后创建一个自定义Application类，但是不要忘记在AndroidManifest.xml中定义这个Application类。（我假设每一个Android开发者不会忘记这么做）。</p>
<p>在你创建的自定义的Application类中添加 @ReportCrashes注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.app.Application;</div><div class="line"><span class="keyword">import</span> org.acra.ACRA;</div><div class="line"><span class="keyword">import</span> org.acra.annotation.ReportsCrashes;</div><div class="line"><span class="keyword">import</span> org.acra.sender.HttpSender;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by nuuneoi on 2/19/2015.</div><div class="line"> */</div><div class="line"> </div><div class="line"><span class="meta">@ReportsCrashes</span>(</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line"> </div><div class="line">        ACRA.init(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们复制服务器端生成的信息，并且像下面那样粘贴到@ReportsCrashes中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">	<span class="meta">@ReportsCrashes</span>(</div><div class="line">    httpMethod = HttpSender.Method.PUT,</div><div class="line">    reportType = HttpSender.Type.JSON,</div><div class="line">    formUri = <span class="string">"http://YOUR_SERVER_IP:5984/acra-myapp/_design/acra-storage/_update/report"</span>,</div><div class="line">    formUriBasicAuthLogin = <span class="string">"tester"</span>,</div><div class="line">    formUriBasicAuthPassword = <span class="string">"12345"</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>最后一步，不要忘记添加在AndroidManifest.xml网络访问权限，否则ACRA可能无法发送这些日志信息到你的服务器上。<br>&gt;</p>
<blockquote>
<p>*<uses-permission android:name="android.permission.INTERNET"></uses-permission></p>
</blockquote>
<p>恭喜，现在所有的配置都已经完成，ACRA可以正常的工作，帮助你收集崩溃日志信息，从而你可以快速解决应用出现的问题。</p>
<p>##测试##</p>
<p>现在我们通过在Activity中强制一些崩溃来做一些测试，例子如下： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">extView tvHello;</div><div class="line"> </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_main);</div><div class="line"> </div><div class="line">    tvHello.setText(<span class="string">"Test Crash"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行你的应用，然后改变崩溃的原因，再运行一次。查看你的仪表盘，你将会看到这些发送到后台的bug。</p>
<p><img src="http://inthecheesefactory.com/uploads/source/acra/acra.png" alt=""></p>
<p>每一个bug来自不同用户不同时间，并且这些报告被分组了。<br><img src="http://inthecheesefactory.com/uploads/source/acra/reportslist.png" alt=""></p>
<p>仔细看看这些报告信息，你将会发现他们都是完整的崩溃信息。<br><img src="http://inthecheesefactory.com/uploads/source/acra/stacktrace.png" alt=""></p>
<p>并且非常多的信息，足足有7页。</p>
<p>如果你修复这些bug后，你可以关闭这个问题，通过简单的点击在页面中高亮显示的”bug”图标，<br><img src="http://inthecheesefactory.com/uploads/source/acra/closeissue.png" alt=""></p>
<p>希望这篇文章对你们有用，特别是对于一些需要应用崩溃信息收集但是却担心隐私信息的大公司可以来使用这个系统。</p>
<p>事实上ACRA还有许多其他特性，比如：当一个月崩溃时显示Toast 或者 popup 来报告这些信息。你可以在ACRA网站上发现这些选项。</p>
<p>Acralytics也一样，这里有许多其他特性可以使用，比如，你可以设置一个服务器来发送邮件给我们。</p>
<p>下一篇博客再见。</p>
<p>​    </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/如何在本地搭建一个Android应用crashing跟踪系统－ACRA/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/如何在本地搭建一个Android应用crashing跟踪系统－ACRA/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/如何提高你的代码质量/" title="如何提高你的代码质量" itemprop="url">如何提高你的代码质量</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://vincentbrison.com/2014/07/19/how-to-improve-quality-and-syntax-of-your-android-code/" target="_blank" rel="external">How to improve quality and syntax of your Android code</a></li>
<li>原文作者 : <a href="http://vincentbrison.com/" target="_blank" rel="external">VINCENT BRISON</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/dengshiwei" target="_blank" rel="external">dengshiwei</a> </li>
<li>校对者: <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a> </li>
<li>状态 :  完成 </li>
</ul>
<p>在这篇文章中，我将通过不同的自动化工具如CheckStyle，FindBugs，PMD以及Android Lint来介绍(如何)提高你的安卓代码质量。通过自动化的方式检查你的代码非常有用，尤其当你在一个团队中工作，为了在你的代码中保持严格的语法格式以及避免很多坏习惯和错误。我将仔细地介绍如何在你空闲的时候直接运用这些工具通过Gradle构建脚本以及如何配置它们。</p>
<pre><code>        目录
0.1 Fork示例
0.2 Gradle任务
0.3 示例项目的层次结构
1 Checkstyle
1.1 简介
1.2 Gradle的形式
1.3 Checkstyle的使用技巧
2 Findbugs
2.1 简介
2.2 Gradle的形式
2.3 Findbugs的使用技巧
3 PMD
3.1 简介
3.2 Gradle的形式
3.3 PMD的使用技巧
4 Android Lint
4.1 简介
4.2 Gradle的形式
4.3 Android Lint的使用技巧
5 实例演示
6 总结
</code></pre><p>###Fork该示例<br>我强烈建议你拷贝下<a href="https://github.com/vincentbrison/vb-android-app-quality.git" target="_blank" rel="external">这个项目工程</a>，尽管我将介绍的案例都是来自它。与此同时，你将能够测试下自己对这些工具的了解情况。</p>
<p>###关于Gradle任务<br>Gradle任务的概念(在Gradle中的含义)是理解该篇文章(以及如何以一种通用的方式写Gradle脚本)的基础。我强烈建议你去看下这两篇关于Gradle任务的文档（<a href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html" target="_blank" rel="external">这篇</a>和<a href="https://docs.gradle.org/current/userguide/more_about_tasks.html" target="_blank" rel="external">这篇</a>）。这个文档包含了大量的例子，因此它非常容易开始学习。现在，我假定你拷贝了我的Repo，你导入这个工程到你的Android Studio，并且你熟悉Gradle任务。如果不是，别担心，我将尽我最大的努力让我的讲解更有意义。</p>
<p>###关于示例项目的层次结构</p>
<p>你可以将gradle脚本文件分割成很多文件，我现在已经有3个gradle文件：</p>
<ul>
<li><a href="https://github.com/vincentbrison/vb-android-app-quality/blob/master/build.gradle" target="_blank" rel="external">根文件夹中的文件</a>，这些文件或多或少都是关于这个项目的配置的(用的哪个Maven Repos，用的哪个版本的Gradle)。</li>
<li><a href="https://github.com/vincentbrison/vb-android-app-quality/blob/master/app/build.gradle" target="_blank" rel="external">App子文件夹中的文件</a>,这些文件是典型的用于创建安卓应用的gradle文件。</li>
<li><a href="https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality.gradle" target="_blank" rel="external">config子文件夹中的文件</a>，这里的文件才是我们关系的重点，因为我用这里的文件保存和配置项目中的所有工具。</li>
</ul>
<p>##Checkstyle</p>
<p><a href="http://checkstyle.sourceforge.net/" target="_blank" rel="external"><img src="http://checkstyle.sourceforge.net/images/logo.png" alt="Checkstyle"></a></p>
<p>###简介</p>
<p>“Checkstyle是一个开发工具用来帮助程序员编写符合代码规范的Java代码。它能自动检查Java代码为空闲的人进行这项无聊(但重要)的任务。”</p>
<p>正如Checkstyle的开发者所言，这个工具能够帮助你在项目中定义和维持一个非常精确和灵活的代码规范形式。当你启动CheckStyle，它会根据所提供的配置文件分析你的Java代码并告诉你发现的所有错误。</p>
<p>###Gradle的形式</p>
<p>下面的代码向你展示了在你的项目中使用Checkstyle的最基本的配置(如Gradle任务):</p>
<pre><code>task checkstyle(type: Checkstyle) {
configFile file(&quot;${project.rootDir}/config/quality/checkstyle/checkstyle.xml&quot;) // Where my checkstyle config is...
configProperties.checkstyleSuppressionsPath = file(&quot;${project.rootDir}/config/quality/checkstyle/suppressions.xml&quot;).absolutePath // Where is my suppressions file for checkstyle is...
source &apos;src&apos;
include &apos;**/*.java&apos;
exclude &apos;**/gen/**&apos;
classpath = files()
}
</code></pre><p>所以，基本上这个任务会根据checkstyle.xml和suppressions.xml分析你的代码。通过Android Studio执行它仅仅需要从工具面的CheckStyle来启动它。</p>
<p><img src="http://vincentbrison.com/wp-content/uploads/2014/07/checkstyle.jpg" alt="gradle panel"><br>     How to execute your gradle task checkstyle</p>
<p>启动CheckStyle之后，你讲收到一个报告用于展示在你项目中发现的每个错误。这是非常直接的方式。</p>
<p>如果你想在checkstyle上做更多的配置，可以参考<a href="https://docs.gradle.org/current/dsl/org.gradle.api.plugins.quality.Checkstyle.html" target="_blank" rel="external">这篇文档</a>。</p>
<p>###Checkstyle的使用技巧<br>Checkstyle会发现大量的问题，特别是在你运用了大量的规则配置，如同你设置了一个非常精确的语法。尽管我通过Gradle使用checkstyle，例如在我进行推送之前，我仍然推荐你为IntellJ/Android Studio使用checkstyle插件(你可以通过Android Studio的工作面板文件/设置/插件直接安装插件)。这种方式下，你可以根据那些为Gradle配置的相同文件在你的工程中使用checkstyle，但是远不止这些，你可以直接在Android Studio中获取带有超链接结果，这些结果通过超链接在你的代码中对应，这是非常有用的(Gradle的这种方式仍然很重要的，因为你可以使用它自动构建系统，如Jenkins)。</p>
<p>##Findbugs<br><a href="http://findbugs.sourceforge.net/" target="_blank" rel="external"><img src="http://findbugs.sourceforge.net/umdFindbugs.png" alt="Findbugs"></a></p>
<p>###简介</p>
<p>Findbugs是否需要一个简介呢？我想它的名称已经让人顾名思义了。“FindBugs使用静态分析方法为出现bug模式检查Java字节码”。FindBugs基本上只需要一个程序来做分析的字节码，所以这是非常容易使用。它能检测到常见的错误，如错误的布尔运算符。FindBugs也能够检测到由于误解语言特点的错误，如Java参数调整（这不是真的有可能因为它的参数是传值）。</p>
<p>###Gradle的形式<br>下面的代码向你展示了在你的项目中使用Findbugs的最基本的配置(以Gradle任务为例):</p>
<pre><code>task findbugs(type: FindBugs) {
ignoreFailures = false
effort = &quot;max&quot;
reportLevel = &quot;high&quot;
excludeFilter = new File(&quot;${project.rootDir}/config/quality/findbugs/findbugs-filter.xml&quot;)
classes = files(&quot;${project.rootDir}/app/build/classes&quot;)

source &apos;src&apos;
include &apos;**/*.java&apos;
exclude &apos;**/gen/**&apos;

reports {
xml.enabled = false
html.enabled = true
xml {
destination &quot;$project.buildDir/reports/findbugs/findbugs.xml&quot;
}
html {
destination &quot;$project.buildDir/reports/findbugs/findbugs.html&quot;
}
}

classpath = files()
}
</code></pre><p>它是如此的像一个Checkstyle任务。尽管Findbugs支持HTML和XML两种报告形式，我选择HTML形式，因为这种形式更具有可读性。而且，你只需要把报告的位置设置为书签就可以快速访问它的位置。这个任务也会失败如果发现Findbgus错误失败(同样生成报告)。执行FindBugs任务，就像执行CheckStyle任务（除了任务的名称是“FindBugs”）。</p>
<p>###Findbugs的使用技巧</p>
<p>由于Android项目是从Java项目略有不同，我强烈推荐使用FindBugs过滤器(规则配置)。你可以在这一个例子（例如项目之一）。它基本上忽略了R文件和你的Manifest文件。顺便说一句，由于(使用)FindBugs分析你的代码，你至少需要编译一次你的代码才能够测试它。</p>
<p>##PMD</p>
<p><a href="http://pmd.sourceforge.net/" target="_blank" rel="external"><img src="http://pmd.sourceforge.net/pmd_logo.png" alt="PMD"></a></p>
<p>###简介</p>
<p>这个工具有个有趣的事实：PMD不存在一个准确的名称。(所以)在官网上你可以发现很有有趣的名称，例如:</p>
<ul>
<li>Pretty Much Done</li>
<li>Project Meets Deadline</li>
</ul>
<p>事实上，PMD是一个工作有点类似Findbugs的强大工具，但是(PMD)直接检查源代码而不是检查字节码(顺便说句，PMD适用很多语言)。(PMD和Findbugs)的核心目标是相同的，通过静态分析方法找出哪些模式引起的bug。因此为什么同时使用Findbugs和PMD呢？好吧！尽管Findbugs和PMD拥有相同的目标，(但是)他们的检查方法是不同的。所以PMD有时检查出的bug但是Findbugs却检查不出来，反之亦然。</p>
<p>###Gradle的形式<br>下面的代码向你展示了在你的项目中使用PMD的最基本的配置(以Gradle任务为例):</p>
<pre><code>task pmd(type: Pmd) {
ruleSetFiles = files(&quot;${project.rootDir}/config/quality/pmd/pmd-ruleset.xml&quot;)
ignoreFailures = false
ruleSets = []

source &apos;src&apos;
include &apos;**/*.java&apos;
exclude &apos;**/gen/**&apos;

reports {
xml.enabled = false
html.enabled = true
xml {
destination &quot;$project.buildDir/reports/pmd/pmd.xml&quot;
}
html {
destination &quot;$project.buildDir/reports/pmd/pmd.html&quot;
}
}
}
</code></pre><p>就PMD来说，它几乎与Findbugs相同。PMD支持HTML和XML两种报告形式，所以我再次选择HTML形式。我强烈建议你使用自己的通用配置集文件，正如同我在这个例子(<a href="https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality/pmd/pmd-ruleset.xml" target="_blank" rel="external">check this file</a>)中一样。所以，你当然应该去看下这些<a href="http://pmd.sourceforge.net/pmd-5.1.1/howtomakearuleset.html" target="_blank" rel="external">通用配置集文件</a>。我建议你，因为PMD可比FindBugs更有争议的很多，例如：如果你不声明”if statement”或”if statement”为空，它基本上会给你警告信息。如果这些规则是正确的，或这对于您的项目(来说是正确的)，我真的认可你和你队友的工作。我不希望程序因为”if statement”崩溃，我认为这样程序的可读性很差。执行PMD任务，就像是(执行)CheckStyle任务（除了任务的名称是“PMD”）。</p>
<p>###PMD的使用技巧</p>
<p>我建议你不要使用默认的规则配置集，你需要添加这行代码(已经加上)：</p>
<pre><code>ruleSets = []
</code></pre><p>否则，因为默认值是这些基本的规则配置集，基本的规则配置集会和你定义的规则集一起执行。所以，如果你的自定义规则集不在那些基本配置集中，他们仍然会执行。</p>
<p>##Android Lint</p>
<p>###简介</p>
<p>“Android lint工具是一个静态代码分析工具，它能检查安卓项目源文件的潜在缺陷和优化改进的正确性，安全性，性能，可用性，可访问性和国际化。”</p>
<p>正如官方网站所说，Android Lint是另一种静态分析工具，专门为Android服务。它是非常强大的，能给你大量的建议以提高你的代码质量。</p>
<p>###Gradle的形式</p>
<pre><code>android {
lintOptions {
abortOnError true

lintConfig file(&quot;${project.rootDir}/config/quality/lint/lint.xml&quot;)

// if true, generate an HTML report (with issue explanations, sourcecode, etc)
htmlReport true
// optional path to report (default will be lint-results.html in the builddir)
htmlOutput file(&quot;$project.buildDir/reports/lint/lint.html&quot;)
}
</code></pre><p>我建议你使用一个单独的文件来定义哪些配置需要使用和不使用。<a href="http://tools.android.com/tips/lint-checks" target="_blank" rel="external">这个网站</a>根据最新的ADT版本定义了全部的配置。我的演示项目中的lint文件包含所有这些规则（ADT 21），包含等级为”ignore”的”severity”:</p>
<ul>
<li><p>IconDensities：这个规则配置确保你定义每个图像资源中的(分辨率)密度（除了ldpi）。</p>
</li>
<li><p>IconDipSize:这个规则配置确保你为每个dip定义合适的资源(换句话来说，如果你没有为每个density设置相同的图片资源，则不需要重新设置图片大小)。</p>
</li>
</ul>
<p>所以你可以重用这个lint文件并激活你想要的所有规则。执行Android Lint任务，就像执行CheckStyle任务（除了任务的名称是”lint”）。</p>
<p>###Android Lint的使用技巧</p>
<p>对于Android Lint没有什么特别的技巧，只需要牢记Android Lint会测试所有配置规则，除了那些等级为“ignore”的“severity”的配置。因此如果发布了新版本ADT下的新配置规则，他们将被检查，而不是忽视。</p>
<p>##实例演示</p>
<p>现在，你有所有的方法为您的项目使用这四个工具。显然，如果我们能同时使用这四个工具会更好。你可以添加你的gradle任务之间的依赖，比如当你执行一个任务，其他任务则是第一个完成后执行。通常在Gradle中，通过让工具具有“check”任务来达到工具之间的相互关系：</p>
<pre><code>check.dependsOn &apos;checkstyle&apos;, &apos;findbugs&apos;, &apos;pmd&apos;, &apos;lint&apos;
</code></pre><p>现在，当执行“check” 任务的时候，Checkstyle, Findbugs, PMD, and Android Lint将会同时执行。在你执行/ commiting / pushing / ask merge request 之前进行质量检查是一个很棒的方式。</p>
<p>你可以在<a href="https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality.gradle" target="_blank" rel="external">这个Gradle文件</a>中找到所有任务的一个完整例子。你可以把所有的质量配置文件和Gradle文件从你看到的演示实例中分开，这些演示的实例把一起都放在“config/quality” 文件夹下。</p>
<p>#总结<br>在这篇文章中，利用Gradle对Android使用代码质量检查工具是非常容易。比使用质量工具局部检查您的项目在您自己的计算机上，这些工具可以用于自动构建如Jenkins/Hudson这样的平台，让你自动进行质量检查，同时自动建立过程。执行所有我从CLI展现的测试，如同在Jenkins/Hudson上执行，简单地执行：</p>
<pre><code>gradle check
</code></pre><p>请随时对这篇文章发表评论，或者问任何有关Android的问题。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/如何提高你的代码质量/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/如何提高你的代码质量/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/延迟共享元素的过渡动画/" title="延迟共享元素的过渡动画 (part 3b)" itemprop="url">延迟共享元素的过渡动画 (part 3b)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.androiddesignpatterns.com/2015/03/activity-postponed-shared-element-transitions-part3b.html" target="_blank" rel="external">Postponed Shared Element Transitions (part 3b)</a></li>
</ul>
<p>通过讨论 Lollipop Transition API 的一个重要的特性：延迟共享元素的过渡动画，这篇博文将继续我们关于共享元素 Transition 的深度解析。这也是我关于 Transition 这个专栏的第四篇文章。</p>
<ul>
<li>Part 1: <a href="https://github.com/bboyfeiyu/android-tech-frontier/tree/master/others/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAAndroid%20%E6%96%B0%E7%89%B9%E6%80%A7-Transition-Part-1" target="_blank" rel="external">在 Activity 和 Fragment 中使用 Transition </a></li>
<li>Part 2: <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-content-transitions-in-depth-part2.html" target="_blank" rel="external">深入理解 Transition</a></li>
<li>Part 3a: <a href="http://www.androiddesignpatterns.com/2015/01/activity-fragment-shared-element-transitions-in-depth-part3a.html" target="_blank" rel="external">深入理解共享元素的 Transition</a></li>
<li>Part 3b:  <a href="http://www.androiddesignpatterns.com/2015/03/activity-postponed-shared-element-transitions-part3b.html" target="_blank" rel="external">延迟共享元素的 Transition</a></li>
<li>Part 3c: 共享元素回调实践 (coming soon!)</li>
<li>Part 4:  Activity &amp; Fragment 过渡动画示例(coming soon!)</li>
</ul>
<p>我们通过一个常见的问题来解释为什么需要推迟某些共享元素的过渡动画。</p>
<p>##理解问题</p>
<p>通常问题的根源是框架在 Activity 生命周期非常早的时候启动共享元素 Transition 。回想我们的第一篇文章，Transitions 必须捕获目标 View 的起始和结束状态来构建合适的动画。因此，如果框架在共享元素获得它在调用它的 Activity 中所给定的大小和位置前启动共享元素的过渡动画，这个 Transition 将不能正确捕获到共享元素的结束状态值,生成动画也会失败(一个过渡失败的例子<a href="http://www.androiddesignpatterns.com/assets/videos/posts/2015/03/09/postpone-bug-opt.mp4" target="_blank" rel="external">Video 3.3</a>).</p>
<p>Transition 开始前，能否计算出正确的共享元素的结束值主要依靠两个因素:</p>
<p>(1) 调用共享元素的 Activity 的布局复杂度以及布局层次结构的深度<br>(2)调用共享元素Activity载入数据消耗的时间</p>
<p>布局越复杂，在屏幕上确定共享元素的大小位置耗时越长。同样，如果调用共享元素的 Activity 依赖一个异步的数据载入，框架仍有可能会在数据载入完成前自动开始共享元素 Transition。下面列出的是你可能遇到的常见问题:</p>
<ul>
<li><p><strong>存在于 Activity 托管的 Fragment 中的共享元素</strong>。<a href="https://developer.android.com/reference/android/app/FragmentTransaction.html#commit()" target="_blank" rel="external">FragmentTransactions 在 commit 后并不会被立即执行</a>，它们会被安排到主线程中等待执行。因此，如果共享元素存在的 Fragment 的视图层和FragmentTransaction没有被及时执行，框架有可能在共享元素被正确测量大小和布局到屏幕前启动共享元素 Transition。<a id="b1" href="#1">(1)</a></p>
</li>
<li><p><strong>共享元素是一个高分辨率的图片</strong>。给 <strong>ImageView</strong> 设置一个超过其初始化边界的高分辨率图片，最终可能会导致在这个视图层里出现<a href="https://github.com/android/platform_frameworks_base/blob/lollipop-release/core/java/android/widget/ImageView.java#L453-L455" target="_blank" rel="external">额外的布局传递</a>，由此增加在共享元素准备好前就启动 Transition 的几率。流行的异步图片处理库比如 <a href="https://android.googlesource.com/platform/frameworks/volley" target="_blank" rel="external"><code>Volley</code></a> 和 <a href="http://square.github.io/picasso/" target="_blank" rel="external"><code>Picasso</code></a> ，也不能可靠的解决这个问题：框架不能预先了解图片是要被下载，缩放还是在后台线程中从磁盘读取，也不管图片是否处理完毕就启动共享元素 Transition。</p>
</li>
<li><p><strong>共享元素依赖于异步的数据加载</strong>如果共享元素所需的数据是通过<strong>AsyncTask</strong>，<strong>AsyncQueryHandler</strong>,<strong>Loader</strong>或者其他类似的东西加载，在它们获得在调用它们的 Activity 的最终数据（大小、位置）前，框架就有可能在主线程中启动 Transition。</p>
</li>
</ul>
<p>现在你可能会想：如果有办法能让暂时延迟 Transition 的使用，直到我们确定了共享元素的确切大小和位置才使用它就好了。幸好 Activity Transitions API<a id="b2" href="#2">(2)</a> 为我们提供了解决方案。</p>
<p>在 Activity 的<code>onCreate()</code>中调用<a href="https://developer.android.com/reference/android/app/Activity.html#postponeEnterTransition()" target="_blank" rel="external"><code>postponeEnterTransition()</code></a> 方法来暂时阻止启动共享元素 Transition。之后，你需要在共享元素准备好后调用 <a href="https://developer.android.com/reference/android/app/Activity.html#startPostponedEnterTransition()" target="_blank" rel="external"><code>startPostponedEnterTransition</code></a> 来恢复过渡效果。常见的模式是在一个<a href="http://developer.android.com/reference/android/view/ViewTreeObserver.OnPreDrawListener.html" target="_blank" rel="external"><code>OnPreDrawListener</code></a>中启动延时 Transition，它会在共享元素测量和布局完毕后被调用<a id="b3" href="#3">(3)</a>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">    <span class="comment">// Postpone the shared element enter transition.</span></div><div class="line">    postponeEnterTransition();</div><div class="line"></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Call the "scheduleStartPostponedTransition()" method</span></div><div class="line">    <span class="comment">// below when you know for certain that the shared element is</span></div><div class="line">    <span class="comment">// ready for the transition to begin.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Schedules the shared element transition to be started immediately</div><div class="line"> * after the shared element has been measured and laid out within the</div><div class="line"> * activity's view hierarchy. Some common places where it might make</div><div class="line"> * sense to call this method are:</div><div class="line"> *</div><div class="line"> * (1) Inside a Fragment's onCreateView() method (if the shared element</div><div class="line"> *     lives inside a Fragment hosted by the called Activity).</div><div class="line"> *</div><div class="line"> * (2) Inside a Picasso Callback object (if you need to wait for Picasso to</div><div class="line"> *     asynchronously load/scale a bitmap before the transition can begin).</div><div class="line"> *</div><div class="line"> * (3) Inside a LoaderCallback's onLoadFinished() method (if the shared</div><div class="line"> *     element depends on data queried by a Loader).</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleStartPostponedTransition</span><span class="params">(<span class="keyword">final</span> View sharedElement)</span> </span>&#123;</div><div class="line">    sharedElement.getViewTreeObserver().addOnPreDrawListener(</div><div class="line">        <span class="keyword">new</span> ViewTreeObserver.OnPreDrawListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">                sharedElement.getViewTreeObserver().removeOnPreDrawListener(<span class="keyword">this</span>);</div><div class="line">                startPostponedEnterTransition();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>忽略方法名，这里还有第二种方法可以延迟共享元素的返回 Transition，在调用Activity的<a href="https://developer.android.com/reference/android/app/Activity.html#onActivityReenter(int,%20android.content.Intent)" target="_blank" rel="external"><code>onActivityReenter()</code></a> 方法中延缓返回 Transition<a id="b4" href="#4">(4)</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Don't forget to call setResult(Activity.RESULT_OK) in the returning</div><div class="line"> * activity or else this method won't be called!</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityReenter</span><span class="params">(<span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onActivityReenter(resultCode, data);</div><div class="line"></div><div class="line">    <span class="comment">// Postpone the shared element return transition.</span></div><div class="line">    postponeEnterTransition();</div><div class="line"></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Call the "scheduleStartPostponedTransition()" method</span></div><div class="line">    <span class="comment">// above when you know for certain that the shared element is</span></div><div class="line">    <span class="comment">// ready for the transition to begin.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>尽管添加延时可以让共享元素 Transition 更加流畅准确，但是你也要知道在应用中引入共享元素 Transition 的延迟可能会产生一些负面影响：</p>
<ul>
<li><strong>调用<code>postponeEnterTransition</code>后不要忘记调用<code>startPostponedEnterTransition</code></strong>。<br>忘记调用<code>startPostponedEnterTransition</code>会让你的应用处于死锁状态，用户无法进入下个Activity。</li>
</ul>
<ul>
<li><strong>不要将共享元素 Transition 延迟设置到1s以上</strong>。延迟时间过长会在应用中产生不必要的卡顿，影响用户体验。</li>
</ul>
<p>感谢阅读！希望这篇文章对你有所帮助。</p>
<p><a id="1" href="#b1"><strong>1</strong></a>: 当然，许多应用通过调用 <a href="https://developer.android.com/reference/android/app/FragmentManager.html#executePendingTransactions(" target="_blank" rel="external"><code>FragmentManager#executePendingTransactions()</code></a>) 来避开这个问题，这样会强制立即执行FragmentTransactions而不是异步。</p>
<p><a id="2" href="#b2"><strong>2</strong></a>: 注意!<code>postponeEnterTransition()</code>和<code>startPostponedEnterTransition()</code>只对 Activity Transition起作用，对Fragment无效。详细信息可以在这里找到 <a href="http://stackoverflow.com/questions/26977303/how-to-postpone-a-fragments-enter-transition-in-android-lollipop" target="_blank" rel="external">StackOverflow</a> &amp; <a href="https://plus.google.com/+AlexLockwood/posts/3DxHT42rmmY" target="_blank" rel="external">Google+</a></p>
<p><a id="3" href="#b3"><strong>3</strong></a>: 小贴士:你可以先调用 <a href="http://developer.android.com/reference/android/view/View.html#isLayoutRequested(" target="_blank" rel="external"><code>View#isLayoutRequested()</code></a>) 来确认是否需要调用 <a href="http://developer.android.com/reference/android/view/ViewTreeObserver.OnPreDrawListener.html" target="_blank" rel="external"><code>OnPreDrawListener</code></a>，有必要的话 <a href="http://developer.android.com/reference/android/view/View.html#isLaidOut(" target="_blank" rel="external"><code>View#isLaidOut()</code></a>) 在一些情况下也能派上用场</p>
<p><a id="4" href="#b4"><strong>4</strong></a>: 在开发者选项中启用不保留 Activity 选项可以方便调试共享元素返回/重新进入时对应过渡动画的行为，这也可以帮助测试在返回的过渡效果开始之前可能发生最糟糕的情况( Activity 需要重新构造布局加载数据…)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/延迟共享元素的过渡动画/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/延迟共享元素的过渡动画/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/实现Instagram的Material Design概念设计/" title="实现Instagram的Material Design概念设计" itemprop="url">实现Instagram的Material Design概念设计</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接:<a href="http://frogermcs.github.io/Instagram-with-Material-Design-concept-is-getting-real/" target="_blank" rel="external">Instagram with Material Design concept is getting real </a></li>
</ul>
<p>几个月前（这篇文章的日期是2014 年11月10日），google发布了app和web应用的Material Design设计准则之后，设计师Emmanuel Pacamalan在youtube上发布了一则概念视频，演示了Instagram如果做成Material风格会是什么样子：</p>
<p>视频地址在这里 <a href="http://v.youku.com/v_show/id_XODg2NDQ1NDQ4.html" target="_blank" rel="external">http://v.youku.com/v_show/id_XODg2NDQ1NDQ4.html</a> ps:markdown不支持播放优酷视频</p>
<p>这 仅仅是停留在图像上的设计，是美好的愿景，估计很多人都会问，能否使用相对简单的办法将它实现出来呢？答案是：yes，不仅仅能实现，而且无须要求在 Lillipop版本，实际上几年前4.0发布之后我们就可以实现这些效果了。ps 读到这里我们应该反思这几年开发者是不是都吃屎去了。</p>
<p>鉴于这个原因，我决定开始撰写一个新的课题-如何将<a href="https://www.youtube.com/watch?v=ojwdmgmdR_Q" target="_blank" rel="external">INSTAGRAM with Material Design</a> 视频中的效果转变成现实。当然，我们并不是真的要做一个Instagram应用，只是将界面做出来而已，并且尽量减少一些不必要的细节。</p>
<p>##开始</p>
<p>本文将要实现的是视频中前7秒钟的效果。我觉得对于第一次尝试来说已经足够了。我想要提醒诸位的是，里面的实现方法不仅仅是能实现，也是我个人最喜欢的实现方式。还有，我不是一个美工，因此项目中的所有图片是直接从网上公开的渠道获取的。（主要是从   <a href="http://www.google.com/design/spec/resources/sticker-sheets-icons.html" target="_blank" rel="external">resources page</a> ）。</p>
<p>好了，下面是最终效果的两组截图和视频（很短的视频，就是那7秒钟的效果，可以在上面的视频中看到，这里因为没法直接引用youtube的视频就略了）（分别从Android 4 和5上获得的）：</p>
<p><img src="http://jcodecraeer.com/uploads/20150204/1423058817102389.png" alt=""></p>
<p><img src="http://jcodecraeer.com/uploads/20150204/1423059082492283.png" alt=""></p>
<p>##准备<br>在我们的项目中，将使用一些热门的android开发工具和库。并不是所有这些东西本篇文章都会用到，我只是将它们准备好以备不时之需。<br>初始化项目</p>
<p>首先我们需要创建一个新的android项目。我使用的是Android Studio和gradle的build方式。最低版本的sdk是15（即Android 4.0.4）。然后我们将添加一些依赖。没什么好讲的，下面是build.gradle以及app/build.gradle文件的代码：</p>
<p>build.gradle<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">buildscript</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">dependencies</span> &#123;</div><div class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:0.14.0'</span></div><div class="line">        <span class="keyword">classpath</span> <span class="string">'com.jakewharton.hugo:hugo-plugin:1.1.+'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="keyword">allprojects</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>app/build.gradle<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.application'</span></div><div class="line">apply plugin: <span class="string">'hugo'</span></div><div class="line">  </div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">21</span></div><div class="line">    buildToolsVersion <span class="string">"21.1"</span></div><div class="line">      </div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"io.github.froger.instamaterial"</span></div><div class="line">        minSdkVersion <span class="number">15</span></div><div class="line">        targetSdkVersion <span class="number">21</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">      </div><div class="line">    <span class="keyword">compile</span> <span class="string">"com.android.support:appcompat-v7:21.0.0"</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:support-v13:21.+'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:support-v4:21.+'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:palette-v7:+'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:recyclerview-v7:+'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:cardview-v7:21.0.+'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.jakewharton:butterknife:5.1.2'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.jakewharton.timber:timber:2.5.0'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.facebook.rebound:rebound:0.3.6'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>简而言之，我们有如下工具：</p>
<p>一些兼容包（CardView, RecyclerView, Palette, AppCompat）-我喜欢使用最新的控件。当然你完全可以使用ListView Actionbar甚至View/FrameView来替代，但是为什么要这么折腾？😉</p>
<p><a href="http://jakewharton.github.io/butterknife/" target="_blank" rel="external">ButterKnife</a> - view注入工具简化我们的代码。（比方说不再需要写findViewById()来引用view，以及一些更强大的功能）。</p>
<p><a href="http://facebook.github.io/rebound/" target="_blank" rel="external">Rebound</a>  - 我们目前还没有用到，但是我以后肯定会用它。这个facebook开发的动画库可以让你的动画效果看起来更自然。</p>
<p><a href="https://github.com/JakeWharton/timber" target="_blank" rel="external">Timber</a>  和 <a href="https://github.com/JakeWharton/hugo" target="_blank" rel="external">Hugo</a>   - 对这个项目而言并不是必须，我仅仅是用他们打印log。</p>
<p>##图片资源</p>
<p>本项目中将使用到一些Material Design的图标资源。App 图标来自于 <a href="https://www.youtube.com/watch?v=ojwdmgmdR_Q" target="_blank" rel="external">NSTAGRAM with Material Design</a> 视频，<a href="https://github.com/frogermcs/frogermcs.github.io/raw/master/files/2/resources.zip" target="_blank" rel="external">这里</a>  是项目的全套资源。</p>
<p>##样式</p>
<p>我们从定义app的默认样式开始。同时为Android 4和5定义Material Desing样式的最简单的方式是直接继承Theme.AppCompat.NoActionBar 或者 Theme.AppCompat.Light.NoActionBar主题。为什么是NoActionBar？因为新的sdk中为我们提供了实现Actionbar功能的新模式。本例中我们将使用Toolbar控件，基于这个原因-Toolbar是ActionBar更好更灵活的解决方案。我们不会深入讲解这个问题，但你可以去阅读android开发者博客<a href="http://android-developers.blogspot.com/2014/10/appcompat-v21-material-design-for-pre.html" target="_blank" rel="external">AppCompat v21</a>  。</p>
<p>根据概念视频中的效果，我们在AppTheme中定义了三个基本颜色（基色调）：</p>
<p>styles.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!-- styles.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTheme"</span> <span class="attr">parent</span>=<span class="string">"Theme.AppCompat.Light.NoActionBar"</span>&gt;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimary"</span>&gt;</span>@color/style_color_primary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimaryDark"</span>&gt;</span>@color/style_color_primary_dark<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorAccent"</span>&gt;</span>@color/style_color_accent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>colors1.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!--colors.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"style_color_primary"</span>&gt;</span>#2d5d82<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"style_color_primary_dark"</span>&gt;</span>#21425d<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"style_color_accent"</span>&gt;</span>#01bcd5<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>关于这三个颜色的意义，你可以在这里找到Material <a href="http://developer.android.com/training/material/theme.html#ColorPalette" target="_blank" rel="external">Theme Color Palette documentation</a> 。 </p>
<p>##布局<br>项目目前主要使用了3个主要的布局元素</p>
<pre><code>*Toolbar* - 包含导航图标和applogo的顶部bar

*TRecyclerView*T - 用于显示feed

*TFloating Action Button* - 一个实现了Material Design中[action button pattern](http://www.google.com/design/spec/components/buttons.html#buttons-flat-raised-buttons)的ImageButton。
</code></pre><p>在开始实现布局之前，我们先在res/values/dimens.xml文件中定义一些默认值：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!--dimens.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">"btn_fab_size"</span>&gt;</span>56dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">"btn_fab_margins"</span>&gt;</span>16dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">"default_elevation"</span>&gt;</span>8dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这些值的大小是基于Material Design设计准则中的介绍。</p>
<p>现在我们来实现MainActivity中的layout：</p>
<p>activity_main.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/root"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</div><div class="line">  </div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.Toolbar</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"?attr/actionBarSize"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span>&gt;</div><div class="line">      </div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/ivLogo"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></div><div class="line">            <span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">            <span class="attr">android:src</span>=<span class="string">"@drawable/img_toolbar_logo"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.v7.widget.Toolbar</span>&gt;</span></div><div class="line">      </div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/rvFeed"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_below</span>=<span class="string">"@id/toolbar"</span></div><div class="line">        <span class="attr">android:scrollbars</span>=<span class="string">"none"</span> /&gt;</div><div class="line">      </div><div class="line">    <span class="tag">&lt;<span class="name">ImageButton</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btnCreate"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"@dimen/btn_fab_size"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"@dimen/btn_fab_size"</span></div><div class="line">        <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_alignParentRight</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"@dimen/btn_fab_margins"</span></div><div class="line">        <span class="attr">android:layout_marginRight</span>=<span class="string">"@dimen/btn_fab_margins"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@drawable/btn_fab_default"</span></div><div class="line">        <span class="attr">android:elevation</span>=<span class="string">"@dimen/default_elevation"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@drawable/ic_instagram_white"</span></div><div class="line">        <span class="attr">android:textSize</span>=<span class="string">"28sp"</span> /&gt;</div><div class="line">  </div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>以上代码的解释:</p>
<pre><code>关于Toolbar最重要的特征是他现在是activity layout的一部分，而且继承自ViewGroup，因此我们可以在里面放一些UI元素（它们将利用剩余空间）。本例中，它被用来放置logo图片。同时，因为Toolbar是比Actionbar更灵活的控件，我们可以自定义更多的东西，比如设置背景颜色为colorPrimary（否则Toolbar将是透明的）。

RecyclerView虽然在xml中用起来非常简单，但是如果java代码中没有设置正确，app是不能启动的，会报java.lang.NullPointerException。


Elevation（ImageButton中）属性不兼容api21以前的版本。所以如果我们想做到Floating Action Button的效果需要在Lollipop和Lollipop之前的设备上使用不同的background。
</code></pre><p><em>Floating Action Button</em></p>
<p>为了简化FAB的使用，我们将用对Lollipop以及Lollipop之前的设备使用不同的样式：</p>
<p><em>FAB for Android v21:</em></p>
<p><img src="http://jcodecraeer.com/uploads/20150204/1423059083822681.png" alt=""></p>
<p><em>FAB for Android pre-21:</em></p>
<p><img src="http://jcodecraeer.com/uploads/20150204/1423059084110006.png" alt=""></p>
<p>我们需要创建两个不同的xml文件来设置button的background：/res/drawable-v21/btn_fab_default.xml（Lollipop设备） ，/res/drawable/btn_fab_default.xml（Lollipop之前的设备）：</p>
<p>btn_fab_default2.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!--drawable-v21/btn_fab_default.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:color</span>=<span class="string">"@color/fab_color_shadow"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shape</span> <span class="attr">android:shape</span>=<span class="string">"oval"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"@color/style_color_accent"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ripple</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>btn_fab_default1.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!--drawable/btn_fab_default.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_pressed</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">layer-list</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:bottom</span>=<span class="string">"0dp"</span> <span class="attr">android:left</span>=<span class="string">"2dp"</span> <span class="attr">android:right</span>=<span class="string">"2dp"</span> <span class="attr">android:top</span>=<span class="string">"2dp"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">shape</span> <span class="attr">android:shape</span>=<span class="string">"oval"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"@color/fab_color_shadow"</span> /&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">              </div><div class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:bottom</span>=<span class="string">"2dp"</span> <span class="attr">android:left</span>=<span class="string">"2dp"</span> <span class="attr">android:right</span>=<span class="string">"2dp"</span> <span class="attr">android:top</span>=<span class="string">"2dp"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">shape</span> <span class="attr">android:shape</span>=<span class="string">"oval"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"@color/style_color_accent"</span> /&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">layer-list</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_pressed</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">shape</span> <span class="attr">android:bottom</span>=<span class="string">"2dp"</span> <span class="attr">android:left</span>=<span class="string">"2dp"</span> <span class="attr">android:right</span>=<span class="string">"2dp"</span> <span class="attr">android:shape</span>=<span class="string">"oval"</span> <span class="attr">android:top</span>=<span class="string">"2dp"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"@color/fab_color_pressed"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>上面的代码涉及到两个颜色的定义,在res/values/colors.xml中添加：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"btn_default_light_normal"</span>&gt;</span>#00000000<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"btn_default_light_pressed"</span>&gt;</span>#40ffffff<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>可以看到在 21之前的设备商制造阴影比较复杂。不幸的是在xml中达到真实的阴影效果没有渐变方法。其他的办法是使用图片的方式，或者通过java代码实现（参见<a href="http://stackoverflow.com/questions/24480425/android-l-fab-button-shadow" target="_blank" rel="external">creating fab shadow</a>）。</p>
<p>##Toolbar</p>
<p>现在我们来完成Toolbar。我们已经有了background和应用的logo，现在还剩下navigation以及menu菜单图标了。关于navigation，非常不幸的是，在xml中app:navigationIcon=””是不起作用的，而android:navigationIcon=””又只能在Lollipop上有用，所以只能使用代码的方式了：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">toolbar.setNavigationIcon(R.drawable.ic_menu_white);</div></pre></td></tr></table></figure></p>
<p>注：app:navigationIcon=””的意思是使用兼容包appcompat的属性，而android:navigationIcon=””是标准的sdk属性。</p>
<p>至于menu图标我们使用标准的定义方式就好了：</p>
<p>在res/menu/menu_main.xml中<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--menu_main.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">menu</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">item</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/action_inbox"</span></div><div class="line">            <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_inbox_white"</span></div><div class="line">            <span class="attr">android:title</span>=<span class="string">"Inbox"</span></div><div class="line">            <span class="attr">app:showAsAction</span>=<span class="string">"always"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在activity中inflated这个menu：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">    getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>本应运行的很好，但是正如我在twitter上提到的，Toolbar onClick  selectors有不协调的情况：</p>
<p>为了解决这个问题，需要做更多的工作，首先为menu item创建一个自定义的view</p>
<p>res/layout/menu_item_view.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!--menu_item_view.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ImageButton</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"?attr/actionBarSize"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"?attr/actionBarSize"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"@drawable/btn_default_light"</span></div><div class="line">    <span class="attr">android:src</span>=<span class="string">"@drawable/ic_inbox_white"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>然后为Lollipop和Lollipop之前的设备分别创建onClick的selector，在Lollipop上有ripple效果：<br>btn_default_light2.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!--drawable-v21/btn_default_light.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:color</span>=<span class="string">"@color/btn_default_light_pressed"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>btn_default_light1.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!--drawable/btn_default_light.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">"@color/btn_default_light_normal"</span> <span class="attr">android:state_focused</span>=<span class="string">"false"</span> <span class="attr">android:state_pressed</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">"@color/btn_default_light_pressed"</span> <span class="attr">android:state_pressed</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">"@color/btn_default_light_pressed"</span> <span class="attr">android:state_focused</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>现在，工程中的所有的color应该是这样子了：</p>
<p>colors.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="comment">&lt;!--colors.xml--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"style_color_primary"</span>&gt;</span>#2d5d82<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"style_color_primary_dark"</span>&gt;</span>#21425d<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"style_color_accent"</span>&gt;</span>#01bcd5<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"fab_color_pressed"</span>&gt;</span>#007787<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"fab_color_shadow"</span>&gt;</span>#44000000<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"btn_default_light_normal"</span>&gt;</span>#00000000<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"btn_default_light_pressed"</span>&gt;</span>#40ffffff<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p> 最后我们应该将custom view放到menu item中，在onCreateOptionsMenu()中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">    getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">    inboxMenuItem = menu.findItem(R.id.action_inbox);</div><div class="line">    inboxMenuItem.setActionView(R.layout.menu_item_view);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上就是toolbar的所有东西。并且onClick的按下效果也达到了预期的效果：</p>
<p><img src="http://jcodecraeer.com/uploads/20150204/1423059085109860.png" alt=""></p>
<p>#Feed<br>最后需要实现的是feed，基于RecyclerView实现。我们需要设置两个东西：layout manager和adapter，因为这里其实就是想实现ListView的效果，所以直接用LinearLayoutManager就行了，而adapter我们首先从item的布局开始(res/layout/item_feed.xml)：</p>
<p>item_feed.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span><span class="comment">&lt;!-- item_feed.xml --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:card_view</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/card_view"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></div><div class="line">    <span class="attr">android:layout_margin</span>=<span class="string">"8dp"</span></div><div class="line">    <span class="attr">card_view:cardCornerRadius</span>=<span class="string">"4dp"</span>&gt;</div><div class="line">  </div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line">      </div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:src</span>=<span class="string">"@drawable/ic_feed_top"</span> /&gt;</div><div class="line">          </div><div class="line">        <span class="tag">&lt;<span class="name">io.github.froger.instamaterial.SquaredImageView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/ivFeedCenter"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</div><div class="line">          </div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/ivFeedBottom"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</div><div class="line">      </div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></div></pre></td></tr></table></figure>
<p>FeedAdapter也非常简单：</p>
<p>FeedAdapter.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeedAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">RecyclerView</span>.<span class="title">ViewHolder</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ANIMATED_ITEMS_COUNT = <span class="number">2</span>;</div><div class="line">      </div><div class="line">    <span class="keyword">private</span> Context context;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> lastAnimatedPosition = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemsCount = <span class="number">0</span>;</div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FeedAdapter</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.context = context;</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> View view = LayoutInflater.from(context).inflate(R.layout.item_feed, parent, <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CellFeedViewHolder(view);</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runEnterAnimation</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (position &gt;= ANIMATED_ITEMS_COUNT - <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">          </div><div class="line">        <span class="keyword">if</span> (position &gt; lastAnimatedPosition) &#123;</div><div class="line">            lastAnimatedPosition = position;</div><div class="line">            view.setTranslationY(Utils.getScreenHeight(context));</div><div class="line">            view.animate()</div><div class="line">            .translationY(<span class="number">0</span>)</div><div class="line">            .setInterpolator(<span class="keyword">new</span> DecelerateInterpolator(<span class="number">3</span>.f))</div><div class="line">            .setDuration(<span class="number">700</span>)</div><div class="line">            .start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(RecyclerView.ViewHolder viewHolder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        runEnterAnimation(viewHolder.itemView, position);</div><div class="line">        CellFeedViewHolder holder = (CellFeedViewHolder) viewHolder;</div><div class="line">        <span class="keyword">if</span> (position % <span class="number">2</span> == <span class="number">0</span>) &#123;</div><div class="line">            holder.ivFeedCenter.setImageResource(R.drawable.img_feed_center_1);</div><div class="line">            holder.ivFeedBottom.setImageResource(R.drawable.img_feed_bottom_1);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            holder.ivFeedCenter.setImageResource(R.drawable.img_feed_center_2);</div><div class="line">            holder.ivFeedBottom.setImageResource(R.drawable.img_feed_bottom_2);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> itemsCount;</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CellFeedViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        <span class="meta">@InjectView</span>(R.id.ivFeedCenter)</div><div class="line">        SquaredImageView ivFeedCenter;</div><div class="line">        <span class="meta">@InjectView</span>(R.id.ivFeedBottom)</div><div class="line">        ImageView ivFeedBottom;</div><div class="line">          </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CellFeedViewHolder</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(view);</div><div class="line">            ButterKnife.inject(<span class="keyword">this</span>, view);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateItems</span><span class="params">()</span> </span>&#123;</div><div class="line">        itemsCount = <span class="number">10</span>;</div><div class="line">        notifyDataSetChanged();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>没什么特别之处需要说明。</p>
<p>通过以下方法将他们放在一起：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupFeed</span><span class="params">()</span> </span>&#123;</div><div class="line">    LinearLayoutManager linearLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">    rvFeed.setLayoutManager(linearLayoutManager);</div><div class="line">    feedAdapter = <span class="keyword">new</span> FeedAdapter(<span class="keyword">this</span>);</div><div class="line">    rvFeed.setAdapter(feedAdapter);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面是整个MainActivity class的源码：<br>//MainActivity.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">ActionBarActivity</span> </span>&#123;</div><div class="line">    <span class="meta">@InjectView</span>(R.id.toolbar)</div><div class="line">    Toolbar toolbar;</div><div class="line">    <span class="meta">@InjectView</span>(R.id.rvFeed)</div><div class="line">    RecyclerView rvFeed;</div><div class="line">      </div><div class="line">    <span class="keyword">private</span> MenuItem inboxMenuItem;</div><div class="line">    <span class="keyword">private</span> FeedAdapter feedAdapter;</div><div class="line">      </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        ButterKnife.inject(<span class="keyword">this</span>);</div><div class="line">          </div><div class="line">        setupToolbar();</div><div class="line">        setupFeed();</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupToolbar</span><span class="params">()</span> </span>&#123;</div><div class="line">        setSupportActionBar(toolbar);</div><div class="line">        toolbar.setNavigationIcon(R.drawable.ic_menu_white);</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupFeed</span><span class="params">()</span> </span>&#123;</div><div class="line">        LinearLayoutManager linearLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">        rvFeed.setLayoutManager(linearLayoutManager);</div><div class="line">        feedAdapter = <span class="keyword">new</span> FeedAdapter(<span class="keyword">this</span>);</div><div class="line">        rvFeed.setAdapter(feedAdapter);</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">        getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">        inboxMenuItem = menu.findItem(R.id.action_inbox);</div><div class="line">        inboxMenuItem.setActionView(R.layout.menu_item_view);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<p>Android Lollipop</p>
<p><img src="http://jcodecraeer.com/uploads/20150204/1423059086107717.png" alt=""></p>
<p>Android pre-21</p>
<p><img src="http://jcodecraeer.com/uploads/20150204/1423059082492283.png" alt=""></p>
<p>##动画</p>
<p>最后一件也是最重要的事情就是进入时的动画效果，再浏览一遍概念视频，可以发现在main Activity启动的时候有如下动画，分成两步：</p>
<p>显示Toolbar以及其里面的元素</p>
<p>在Toolbar动画完成之后显示feed和floating action button。</p>
<p>Toolbar中元素的动画表现为在较短的时间内一个接一个的进入。实现这个效果的主要问题在于navigation icon的动画，navigation icon是唯一一个不能使用动画的，其他的都好办。<br><em>Toolbar animation</em></p>
<p>首先我们只是需要在activity启动的时候才播放动画（在旋转屏幕的时候不播放），还要知道menu的动画过程是不能在onCreate()中去实现的（我们在onCreateOptionsMenu()中实现），创建一个布尔类型的变量pendingIntroAnimation ，在onCreate()方法中初始化：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...</span></div><div class="line"><span class="keyword">if</span> (savedInstanceState == <span class="keyword">null</span>) &#123;</div><div class="line">    pendingIntroAnimation = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>onCreateOptionsMenu():<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">    getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">    inboxMenuItem = menu.findItem(R.id.action_inbox);</div><div class="line">    inboxMenuItem.setActionView(R.layout.menu_item_view);</div><div class="line">    <span class="keyword">if</span> (pendingIntroAnimation) &#123;</div><div class="line">        pendingIntroAnimation = <span class="keyword">false</span>;</div><div class="line">        startIntroAnimation();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样startIntroAnimation()将只被调用一次。</p>
<p>现在该来准备Toolbar中元素的动画了，也非常简单</p>
<p>ToolbarAnimation<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ANIM_DURATION_TOOLBAR = <span class="number">300</span>;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startIntroAnimation</span><span class="params">()</span> </span>&#123;</div><div class="line">    btnCreate.setTranslationY(<span class="number">2</span> * getResources().getDimensionPixelOffset(R.dimen.btn_fab_size));</div><div class="line">    <span class="keyword">int</span> actionbarSize = Utils.dpToPx(<span class="number">56</span>);</div><div class="line">    toolbar.setTranslationY(-actionbarSize);</div><div class="line">    ivLogo.setTranslationY(-actionbarSize);</div><div class="line">    inboxMenuItem.getActionView().setTranslationY(-actionbarSize);</div><div class="line">      </div><div class="line">    toolbar.animate()</div><div class="line">        .translationY(<span class="number">0</span>)</div><div class="line">        .setDuration(ANIM_DURATION_TOOLBAR)</div><div class="line">        .setStartDelay(<span class="number">300</span>);</div><div class="line">    ivLogo.animate()</div><div class="line">        .translationY(<span class="number">0</span>)</div><div class="line">        .setDuration(ANIM_DURATION_TOOLBAR)</div><div class="line">        .setStartDelay(<span class="number">400</span>);</div><div class="line">    inboxMenuItem.getActionView().animate()</div><div class="line">        .translationY(<span class="number">0</span>)</div><div class="line">        .setDuration(ANIM_DURATION_TOOLBAR)</div><div class="line">        .setStartDelay(<span class="number">500</span>)</div><div class="line">        .setListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">            startContentAnimation();</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .start();</div><div class="line">&#125;</div><div class="line"><span class="comment">//...</span></div></pre></td></tr></table></figure></p>
<p>在上面的代码中：</p>
<pre><code>首先我们将所有的元素都通过移动到屏幕之外隐藏起来（这一步我们将FAB也隐藏了）。

让Toolbar元素一个接一个的开始动画

当动画完成，调用了startContentAnimation()开始content的动画（FAB和feed卡片的动画）
</code></pre><p> 简单，是吧？<br><em>Content 动画</em></p>
<p>在这一步中我们将让FAB和feed卡片动起来。FAB的动画很简单，跟上面的方法类似，但是feed卡片稍微复杂些。</p>
<p>startContentAnimation方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...</span></div><div class="line"><span class="comment">//FAB animation</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ANIM_DURATION_FAB = <span class="number">400</span>;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startContentAnimation</span><span class="params">()</span> </span>&#123;</div><div class="line">    btnCreate.animate()</div><div class="line">        .translationY(<span class="number">0</span>)</div><div class="line">        .setInterpolator(<span class="keyword">new</span> OvershootInterpolator(<span class="number">1</span>.f))</div><div class="line">        .setStartDelay(<span class="number">300</span>)</div><div class="line">        .setDuration(ANIM_DURATION_FAB)</div><div class="line">        .start();</div><div class="line">    feedAdapter.updateItems();</div><div class="line">&#125;</div><div class="line"><span class="comment">//...</span></div></pre></td></tr></table></figure></p>
<p>FeedAdapter的代码在上面已经贴出来了。结合着就知道动画是如何实现的了。</p>
<p>本篇文章就结束了，避免遗漏，这里是这篇文章是提交的代码 <a href="https://github.com/frogermcs/InstaMaterial/commit/4e838861c5f858711b1072777cae2325ce12ee21" target="_blank" rel="external">commit for our project with implemented animations</a> .</p>
<p>##源代码</p>
<p>完整的代码在<a href="https://github.com/frogermcs/InstaMaterial" target="_blank" rel="external">Github repository</a>.</p>
<p>作者: Miroslaw Stanek</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/实现Instagram的Material Design概念设计/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/实现Instagram的Material Design概念设计/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/检测和解决Android应用的性能问题/" title="检测和解决Android应用的性能问题" itemprop="url">检测和解决Android应用的性能问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://code.tutsplus.com/tutorials/detect-and-resolve-performance-problems-on-android--cms-24058" target="_blank" rel="external">Detect and Resolve Performance Problems on Android</a></li>
<li>译文出自 : <a href="http://www.devtf.cn" target="_blank" rel="external">开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a> </li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>无论你的应用多么有创新性、有用，如果它卡得要命，或者非常消耗内存，那么没人将会愿意使用它。</p>
<p>因此，性能变得尤为重要。当你忙碌于构建精美的用户界面或者完成新的特性时，你可能容易忘却掉一些性能相关的事情。</p>
<p>这也是为什么有Google Play的应用审核机制的原因之一。</p>
<p>这篇文章中，你会看到每个Android工程师需要了解的一些性能问题。你将会学会使用Android SDK提供的、已安装在你的设备中的工具来测试这些问题是否发生在你自己的应用中。</p>
<p>如果在你的应用中发现了一个性能问题，你肯定会想修复它。我们还会看一看如何使用Android SDK 工具来获取更多关于那些没有覆盖到的性能问题的相关信息。一旦你有了这些信息，你将会对如何提升应用性能有一个更深刻的理解，并且能够构建出让用户喜爱的App。</p>
<h2 id="过度绘制"><a href="#过度绘制" class="headerlink" title="过度绘制"></a>过度绘制</h2><h3 id="步骤1-问题描述"><a href="#步骤1-问题描述" class="headerlink" title="步骤1 : 问题描述"></a>步骤1 : 问题描述</h3><p>你应用的用户界面是连接用户的纽带，但是创建漂亮的界面只是挑战的其中一面，你还需要确保用户界面流畅的运行。</p>
<p>一个常见的问题就是用户界面卡顿，出现这种情况的原因可能是<strong>overdraw</strong>。Overdraw是屏幕上的某个像素在同一帧的时间内被绘制了多次。</p>
<p>例如，想象一下一个有蓝色的背景文本，Android不仅会绘制对用户可见的蓝色区域，而是会绘制整个蓝色的背景以及上面的文本。这意味着一些像素会被两次绘制，这就是过度绘制。</p>
<p>一些如上述例子所说的过度绘制示例是不可避免的。然而，过多的多度绘制会引发明显的性能问题，因此你必须将过度绘制的可能性降到最小。</p>
<p>检测应用中的过度绘制相对来说比较简单。大量的过度绘制会引出其他用户界面相关问题，例如视图层级过于复杂等。基于这些原因，当你测试你的App的性能问题时，从过度绘制开始是一个明智的选择。</p>
<h3 id="步骤2-检测过度绘制"><a href="#步骤2-检测过度绘制" class="headerlink" title="步骤2 : 检测过度绘制"></a>步骤2 : 检测过度绘制</h3><p>好消息是你的Android设备上已经内置了检测过度绘制的工具。</p>
<p>因此你需要做的第一步就是安装你要测试的App到你的设备中。然后打开设置页面，选择开发选项（Developer Options）-&gt;调试GPU 过度绘制（Debug GPU Overdraw），然后选择“显示过度绘制区域（Show overdraw area）”。如下图所示。</p>
<p><img src="http://img.blog.csdn.net/20150722114732363" alt="On your device select Settings Developer Options Debug GPU Overdraw
Show overdraw
area"></p>
<p>这个工具使用色块来代表不同数量的过度绘制。剩下的事情就是启动你要测试的应用，然后观察它的过度绘制情况。</p>
<p><img src="http://img.blog.csdn.net/20150722114815803" alt="Launch your app and check the amount of
overdraw"><br>​    </p>
<ul>
<li><strong>没颜色 :</strong> 没有过度绘制，也就是说一个像素只被绘制了一次。</li>
<li><strong>蓝色 :</strong> 过度绘制了一次，也就是一个像素点被绘制了两次。</li>
<li><strong>绿色 :</strong> 过度绘制了2次. 也就是一个像素点被绘制了三次，通常，你需要集中精力优化过度绘制次数大于等于2次的情况。</li>
<li><strong>浅红色 :</strong> 过度绘制3次。这取决于你的应用，小范围的3次过度绘制可能是不可避免的，但是如果你看到了中等或者大量的红色区域那么你就需要查找出现这个问题的原因了。</li>
<li><strong>深红色 :</strong> 过度绘制4次，像素点被绘制了5次，甚至更多次。出现这种问题你绝逼要找到原因，并且解决它。</li>
</ul>
<p><img src="http://img.blog.csdn.net/20150722125805062" alt=""></p>
<h3 id="步骤3-：-最小化过度绘制"><a href="#步骤3-：-最小化过度绘制" class="headerlink" title="步骤3 ： 最小化过度绘制"></a>步骤3 ： 最小化过度绘制</h3><p>一旦你发现了某个区域有严重的过度绘制，最简单的方法就是打开你应用的xml文件找到过度重叠的区域，特别是那些不可见的drawable对象和被绘制在其他控件上的背景，以此来降低这些地方的过度绘制。</p>
<p>你也应该查找那些背景属性设置为白色，并且它的父视图背景也设置为白色的区域。所有这些都会引起严重的过度绘制。</p>
<p>Android系统能自动的降低一些简单的过度绘制，但是这些对于复杂的自定义View并没有什么价值，因为Android不会知道你如何绘制你的内容。</p>
<p>如果你在App中使用了复杂的自定义View，你可以为使用<code>clipRect</code>函数为你的视图定义可绘制区域的边界。更新相关信息可以参考<a href="http://developer.android.com/reference/android/graphics/Canvas.html" target="_blank" rel="external">official Android<br>documentation</a>.</p>
<h2 id="2-Android-图形渲染"><a href="#2-Android-图形渲染" class="headerlink" title="2. Android 图形渲染"></a>2. Android 图形渲染</h2><hr>
<h3 id="步骤1-问题描述-1"><a href="#步骤1-问题描述-1" class="headerlink" title="步骤1 : 问题描述"></a>步骤1 : 问题描述</h3><p>另一个常见的性能问题就是应用的视图层级。为了渲染每个视图，Android都会经历这三个阶段 : </p>
<ol>
<li>测量</li>
<li>布局</li>
<li>绘制</li>
</ol>
<p>花在这三个阶段的时间与View层级中的View的数量成正比，这就意味着降低App渲染时间的最简单的方法就是识别和移除那些并没有什么卵用的UI元素。</p>
<p>即使在你的视图层级上的所有View都是必须的，不同的布局方式也可能对测量过程产生重要的影响。通常来说，你的视图层级越深，花在测量视图的时间就越长。</p>
<p>在视图渲染期间，每个View都要向它的父View提供它自己的尺寸。如果父view发现了任意一个尺寸问题，那么它会强制要求所有的子视图重新测量。</p>
<p>即使没有错误发生，重新测量也可能出现。例如，为了正确的进行布局RelativeLayout通常会对它们的子视图进行两次测量。子视图使用了<code>layout_weight</code>属性的LinearLayout也会对它的子视图进行两次测量。</p>
<p>这些都取决于你的布局方式，测量和重新测量的代价非常昂贵，它会严重影响你的渲染速度。</p>
<p>确保你的用户界面渲染流畅的关键就是移除任何非必须的View以及减少你的View层级。</p>
<p><strong>Hierarchy Viewer</strong>是一个能够将你完整的View层级可视化的工具，这个工具能够帮助你发现冗余的View以及嵌套的布局。</p>
<h3 id="步骤2：使用-Hierarchy-Viewer"><a href="#步骤2：使用-Hierarchy-Viewer" class="headerlink" title="步骤2：使用 Hierarchy Viewer"></a>步骤2：使用 Hierarchy Viewer</h3><p>在我们进一步了解<strong>Hierarchy Viewer</strong>之前，你需要知道它的一些规则。首先<strong>Hierarchy Viewer</strong>只能与正在运行的App进行交互，而不是你的源代码。这就是说你需要将App安装到你的设备或者模拟器上。</p>
<p>还有一个最重要的问题，就是默认情况下<strong>Hierarchy Viewer</strong>只能与运行开发版Android系统的设备进行交互（译者注: 一般来说，使用模拟器即可）。如果你没有开发设备，那你需要添加<a href="https://github.com/romainguy/ViewServer" target="_blank" rel="external"><code>ViewServer</code><br>class</a>到你的应用中。</p>
<p>了解这些之后就让我们打开Android Studio，并且选择”tools” -&gt; “Android” -&gt; “Android Device Monitor”，如图所示。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-open-Android-Device-Monitor.jpg" alt="Select Tools Android Android Device
Monitor"></p>
<p>然后点击<strong>Hierarchy View</strong>按钮，如下图所示。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-select-Hierarchy-viewer.jpg" alt="Select the Hierarchy View button from the
toolbar"></p>
<p>屏幕左边的<strong>Windows</strong>标签下列出了所有Android设备和模拟器。选择你的设备后，你会看到你设备上运行的所有进程。选中你要检测的进程，然后你会看到三个自动更新的视图层级区域。</p>
<p>这三个窗口提供了视图层级的三个不同可视化展示。</p>
<ul>
<li><strong>Tree View:</strong> <em>**</em> 视图层级窗口，每个节点代表了一个View;</li>
<li><strong>Tree Overview:</strong> 整个视图层级的缩略布局;</li>
<li><strong>Layout View:</strong> 当前视图层级的轮廓.</li>
</ul>
<p>Hierarchy View中有三个窗口。如果你在一个窗口中选择了一个View，那么它会在另外两个中高亮显示。你能同时使用这三个窗口查找View层级中的冗余视图。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-tree%20overview.jpg" alt="Select a view in one window and itll appear highlighted in the other
two"></p>
<p>如果你不确定一个View是否是UI界面中的必须元素，最简单的方法就是到Tree View窗口点击这个节点。你将会看到该View是如何显示在屏幕的预览，此时你就可以确切地知道该View是否是必须的。</p>
<p>但是即使一个View对最终的渲染效果有贡献也并不意味着它不会引起严重的性能问题。你已经看到了如何通过Hierarchy Viewer来找到明显的嵌套布局，但是如果这引起的性能问题并不那么明显呢？或者还有其他的原因使得该视图渲染得非常慢？</p>
<p>好消息就是你还可以通过Hierarchy Viewer来剖析每个View在不同的渲染阶段的耗时。当性能问题的原因不那么明显时，这是你发现问题的另一途径。</p>
<p>下个章节我将为你展示如何通过Hierarchy Viewer来剖析每个View的渲染时间来找到潜伏在问题表面的性能问题。</p>
<h3 id="步骤3-节点的性能分析"><a href="#步骤3-节点的性能分析" class="headerlink" title="步骤3 : 节点的性能分析"></a>步骤3 : 节点的性能分析</h3><p>定位你的用户界面瓶颈的最简单方法就是收集每个View分别完成测量、布局、绘制的时间。</p>
<p>你不仅可以通过Hierarchy Viewer收集这些信息，Hierarchy Viewer还可以通俗易懂地向你展示这些数据，因此你可以通过这种形式来找到性能问题。</p>
<p>Hierarchy Viewer默认并不会显示渲染时间。你需要到Tree View窗口添加这个信息，然后选择你想要测试的根节点。下一步，在Hierarchy Viewer上点击由绿、红、紫的三个圆形色块组成的按钮，如图所示。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-venn-diagram.jpg" alt=""></p>
<p>三个圆点色块就会显示在每个节点上，从左到右，这些圆点分别代表 :</p>
<ul>
<li>用于测量的时间</li>
<li>用于布局的时间</li>
<li>用于绘制的时间</li>
</ul>
<p>每个圆点都有颜色 : </p>
<ul>
<li><strong>绿色</strong> 代表该View的渲染速度至少要快于一半以上的其他参与测试的节点。例如，一个在布局位置上的绿色的圆点代表它的布局速度要快于50%以上的其他节点；</li>
<li><strong>黄色</strong> 代表该View慢于50%以上的其他节点;</li>
<li><strong>红色</strong> 代表该View的渲染速度比其他所有参与测试的节点都慢。</li>
</ul>
<p><img src="http://img.blog.csdn.net/20150723140449454" alt=""></p>
<p>当收集了这些数据之后，你不仅知道哪些View需要优化，你还会确切地知道是在渲染的哪个阶段导致的问题。</p>
<p>哪些黄色、红色的地方就是你需要开始优化的地方，这些性能指标与该视图层级下的其他剖析节点也有关系。换句话说，你肯定会有一些视图渲染得比其他的慢。</p>
<p>在开始改良你的View相关的代码之前，摸着你的良心问一句该View渲染得比其他视图慢是否有一个合理的原因，如果答案是否定的，那么就开始你的View优化之旅吧。</p>
<h2 id="3-Memory-Leaks-内存泄漏"><a href="#3-Memory-Leaks-内存泄漏" class="headerlink" title="3. Memory Leaks 内存泄漏"></a>3. Memory Leaks 内存泄漏</h2><h3 id="步骤1：问题描述"><a href="#步骤1：问题描述" class="headerlink" title="步骤1：问题描述"></a>步骤1：问题描述</h3><p>Android是一个自动管理内存的开发环境，不要让这个句话蒙蔽了，因为内存泄漏依旧是可能发生的。这是因为垃圾回收器只会移除那些不可达的对象。如果它不是一个不可达的对象，那么该对象就不会被释放掉。</p>
<p>这些不可达的对象阴魂不散，聚集在你的堆内存中，占用App的内存控件。如果你继续泄漏对象，那么可用的内存空间将会越来越小，GC操作就会频繁触发。</p>
<p>有两个原因表明这是一个坏消息。首先，GC操作通常不会明显地影响你的App性能，但是当内存控件较小时大量的GC操作会使你的App变慢，此时UI就不会那么流畅了。第二问题是移动设备的内存空间相对来说较小，因此内存泄漏会快速地升级为内存溢出，导致应用Crash。</p>
<p>内存泄漏难以被检测出。可能只有当用户开始抱怨你的应用时你才能发觉内存泄漏问题。幸运地是，Android SDK提供了一些有用的工具来让你找到这些问题。（译者注 : Square的开源库<a href="https://github.com/square/leakcanary" target="_blank" rel="external">LeakCanary</a>是查找内存泄漏的优秀工具,强烈建议大家使用）。</p>
<h3 id="步骤2-内存监视器-（Memory-Monitor）"><a href="#步骤2-内存监视器-（Memory-Monitor）" class="headerlink" title="步骤2 : 内存监视器 （Memory Monitor）"></a>步骤2 : 内存监视器 （Memory Monitor）</h3><p><strong>Memory Monitor</strong>是一个能够实时获取应用内存使用情况的工具。需要注意的是这个工具只能作用于正在运行的应用，因此确保你的要测试的应用已经安装到你的设备中，并且你的设备已经连接到你的电脑上。</p>
<p><strong>Memory Monitor</strong>已经内置在Android Studio中，因此你可以点击Android Studio的底部的”Memory”这个tab来切换到内存监视页面。当你切换到该页面的时候，Memory Monitor就开始记录你的内存使用情况了。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-memory-monitor.jpg" alt="Memory Monitor is built into Android Studio you can access it by
clicking the Memory
tab"></p>
<p>如果Memory Monitor没有开始记录，那么确保你的设备是已经被选中的状态。</p>
<p>如果Memory Monitor提示<strong>No debuggable applications</strong>，那么你可以打开Android Studio的”Tools”菜单，选择”Android”，然后确保选中了<strong>Enable adb integration</strong>。这个功能还不是很稳定，所以有时候你需要手动切换它的状态。你也可以断开设备与电脑的连接，然后再重连，这样可能就OK了。</p>
<p>一旦Memory Monitor检测到正在运行的应用，它就会显示这个应用的内存使用情况。已使用的内存会被表示为深蓝色，未分配的内存则会变为浅蓝色。</p>
<p>花一些时间与你的设备交互，并且关注你的内存使用情况。最终已分配的内存会增长，直到没有内存可用。此时，系统就会释放触发GC释放内存，当你看到已分配的内存明显的下降时就代表GC操作被触发了。</p>
<p>GC通常情况下会将无用的内存释放掉，但是当你看到App在短时间内快速增长或者GC变得非常频繁，此时你就需要倍加小心了，这就是发生内存泄漏的信号！</p>
<p>如果你通过Memory Monitor来追踪一个可疑的内存泄漏问题，你可能会看到Android系统会为你的App增大可用内存，TODO : 。</p>
<p>最终，你可能会看到你的App消耗了非常多的内存以至于系统无法再给你的应用更多的可用内存。如果你看到这种场景，那么说明你在内存使用上犯了很严重的错误。</p>
<h3 id="步骤3-Android-Device-Monitor"><a href="#步骤3-Android-Device-Monitor" class="headerlink" title="步骤3 : Android Device Monitor"></a>步骤3 : Android Device Monitor</h3><p>另一个能够帮助你收集更新关于内存泄漏信息和其他内存相关问题的工具是Android Device Monitor的DDMMS工具下的<strong>Heap</strong>。</p>
<p><strong>Heap</strong>工具能够通过显示系统为你分配了多少内存来帮助你诊断内存泄漏问题。正如上面提到的，如果已分配的内存不断地增长，那么这是发生内存泄漏的明显信号。</p>
<p>但是这个工具还提供了许多关于你的应用堆内存使用情况的数据，包含你的App内分配的各种对象、分配的对象数量以及这些对象占用了多少空间。这些额外的信息对于你追踪内存泄漏极为有用。</p>
<p>你可以在Android Device Monitor工具中选择DDMS，在Devices中选择你要检测的App。然后选择Heap标签，如图所示。然后花一些时间与你的App进行交互以收集内存信息。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/369/posts/24058/image/optimise-Android-performance-heap-tab.jpg" alt="Launch Android Debug Monitor select DDMS and then click the Heap
tab"></p>
<p>heap输出信息会在GC事件之后，因为你可以手动点击<strong>Cause GC</strong>来触发GC，使得Heap内存数据尽快地显示出来。</p>
<p>一旦GC事件被触发了，heap标签下就会更新App的堆内存使用信息，这些信息会在每次GC时更新。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><hr>
<p>在这篇文章中，我们学习了一些开发中最常见的性能问题，过度绘制、内存泄漏、缓慢的UI渲染。</p>
<p>相信你已经掌握了如何使用工具来检查这些问题，以及如何获取更新的信息来判断你的应用中是否出现了这些性能问题。你有越多的信息，就越容易追踪到问题的原因并且修复它。</p>
<p>Android SDK有很多工具可以供你诊断和定位性能问题。如果你想学习更多这方面的知识，你可以访问u这两篇官方文档 <a href="http://developer.android.com/tools/debugging/debugging-tracing.html" target="_blank" rel="external">Traceview and dmtracedump</a>和 <a href="http://developer.android.com/tools/debugging/ddms.html#alloc" target="_blank" rel="external">Allocation Tracker</a>.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/检测和解决Android应用的性能问题/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/检测和解决Android应用的性能问题/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/开始使用 Transitions（过渡动画） (part 1)/" title="开始使用 Transitions（过渡动画） (part 1)" itemprop="url">开始使用 Transitions（过渡动画） (part 1)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">Getting Started with Activity &amp; Fragment Transitions (part 1)</a></li>
</ul>
<ul>
<li>作者 : <a href="https://plus.google.com/+AlexLockwood" target="_blank" rel="external">Alex Lockwood</a></li>
<li>译者 : <a href="https://github.com/tiiime" target="_blank" rel="external">tiiime</a></li>
<li>校对者: <a href="https://github.com/chaossss" target="_blank" rel="external">chaossss</a>  </li>
<li>状态 :  校对完成</li>
</ul>
<p>##首先<br>这篇文章主要介绍 Android 5.0 新加入的 Transition (过渡动画) API，这是这个系列的第一篇文章。主要介绍下面几个话题:</p>
<ul>
<li>Part 1: <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">在 Activity 和 Fragment 中使用 Transition </a></li>
<li>Part 2: <a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-content-transitions-in-depth-part2.html" target="_blank" rel="external">深入理解 Transition</a></li>
<li>Part 3a: <a href="http://www.androiddesignpatterns.com/2015/01/activity-fragment-shared-element-transitions-in-depth-part3a.html" target="_blank" rel="external">深入理解共享元素的 Transition</a></li>
<li>Part 3b:  <a href="http://www.androiddesignpatterns.com/2015/03/activity-postponed-shared-element-transitions-part3b.html" target="_blank" rel="external">延迟共享元素的 Transition</a></li>
<li>Part 3c: 共享元素回调实践 (coming soon!)</li>
<li>Part 4:  Activity &amp; Fragment 过渡动画示例(coming soon!)</li>
</ul>
<p>今天这篇文章是 Transition 的概述，同时也象征着这个专栏的开始，希望大家喜欢啦。</p>
<p>#先说下什么是 Transition(过渡动画).<br>Lollipop 中 Activity 和 Fragment 的过渡动画是基于 Android 一个叫作 Transition 的新特性实现的。<br>初次引入这个特性是在 KitKat 中，Transition 框架提供了一个方便的 API 来构建应用中不同 UI 状态切换时的动画。<br>这个框架始终围绕两个关键概念:场景和过渡。<br><strong>场景</strong> 描述应用中 UI 的状态，<a href="https://developer.android.com/reference/android/transition/Transition.html" target="_blank" rel="external"><strong>过渡</strong></a> 确定两个场景转换之间的过渡动画。</p>
<p>当场景转换，Transition 的主要职责是：</p>
<ol>
<li>捕获每一个 View 的起始和结束状态</li>
<li>根据这些数据来创建从一个场景到另一个场景间的过渡动画。</li>
</ol>
<p>下面是一个简单示例，当用户点击，我们需要 Activity 的 View 视图产生消失和出现的效果。使用 Transition ，实现这个需求只要几行代码，代码如下：<a id="1" href="#b1">(1)</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ViewGroup mRootView;</div><div class="line">    <span class="keyword">private</span> View mRedBox, mGreenBox, mBlueBox, mBlackBox;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        mRootView = (ViewGroup) findViewById(R.id.layout_root_view);</div><div class="line">        mRootView.setOnClickListener(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        mRedBox = findViewById(R.id.red_box);</div><div class="line">        mGreenBox = findViewById(R.id.green_box);</div><div class="line">        mBlueBox = findViewById(R.id.blue_box);</div><div class="line">        mBlackBox = findViewById(R.id.black_box);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        TransitionManager.beginDelayedTransition(mRootView, <span class="keyword">new</span> Fade());</div><div class="line">        toggleVisibility(mRedBox, mGreenBox, mBlueBox, mBlackBox);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">toggleVisibility</span><span class="params">(View... views)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (View view : views) &#123;</div><div class="line">            <span class="keyword">boolean</span> isVisible = view.getVisibility() == View.VISIBLE;</div><div class="line">            view.setVisibility(isVisible ? View.INVISIBLE : View.VISIBLE);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了更好地理解底层中发生了什么，我们一步一步地分析下这段代码，首先假设屏幕上的所有的 View 都是<strong>可见</strong>的:</p>
<ol>
<li><p>首先，点击按钮后调用了 <a href="https://developer.android.com/reference/android/transition/TransitionManager.html#beginDelayedTransition(android.view.ViewGroup,%20android.transition.Transition)" target="_blank" rel="external">beginDelayedTransition()</a>，<br>将根场景和<a href="https://developer.android.com/reference/android/transition/Fade.html" target="_blank" rel="external">Fade</a> Transition对象（淡入/淡出过渡效果）作为参数传递出去。框架立即对场景中所有 View 调用 Transitions 的 <a href="https://developer.android.com/reference/android/transition/Transition.html#captureStartValues(android.transition.TransitionValues)" target="_blank" rel="external">captureStartValues()</a> 方法，同时， Transitions 将记录每个 View 的可见性。</p>
</li>
<li><p>调用结束后，开发者将场景中所有 View 设置为<strong>不可见</strong>的。</p>
</li>
<li><p>在下一个画面，框架对场景中所有 View(近期更新的) 调用 Transitions 的<a href="https://developer.android.com/reference/android/transition/Transition.html#captureEndValues(android.transition.TransitionValues)" target="_blank" rel="external">captureEndValues()</a><br>方法， Transitions 记录可见性。</p>
</li>
<li><p>框架调用 Transitions 的 <a href="https://developer.android.com/reference/android/transition/Transition.html#createAnimator(android.view.ViewGroup,%20android.transition.TransitionValues,%20android.transition.TransitionValues)" target="_blank" rel="external">createAnimator()</a> 方法。Transition 分析每一个 View 的起始/结束状态，注意到 View 的可见性发生了变化。之后 <strong>Fade</strong> 对象利用这些信息创建了一个<strong>AnimatorSet</strong> 对象，并将其返回到框架中，进而将每个 View 的 <strong>alpha</strong> 值渐变到 <strong>0f</strong>。</p>
</li>
<li><p>框架运行返回的<strong>动画</strong>,让所有 View 从屏幕中淡出。</p>
</li>
</ol>
<p>这个例子强调了 Transition 框架的两个优点：第一，<strong>Transition</strong> 将开发人员所需要的<strong>动画</strong>概念抽象，减少了 Activity 和 Fragment 内的代码复用，使得我们只要设置好 View 的 起始 和 结束 时的状态，就能通过 Transition 自动创建动画。第二，只要更换 <strong>Transition</strong> 对象就可以修改两个场景间的动画。</p>
<p><a href="http://www.androiddesignpatterns.com/assets/videos/posts/2014/12/04/trivial-opt.mp4" target="_blank" rel="external"> 示例 <strong>Video 1.1</strong></a>,只要少量代码就可以创建复杂的动画效果。<br>后续文章会介绍如何做到。</p>
<h1 id="Lollipop-中的-Activity-amp-Fragment-Transitions"><a href="#Lollipop-中的-Activity-amp-Fragment-Transitions" class="headerlink" title="Lollipop 中的 Activity &amp; Fragment Transitions"></a>Lollipop 中的 Activity &amp; Fragment Transitions</h1><p>在 Android 5.0 中， 切换 <strong>Activitys</strong> 或者 <strong>Fragments</strong> 时可以使用 <strong>Transitions</strong> 来构建精致的过场动画。虽然在之前的版本中已经引入 Activity 和 Fragment 的切换动画(通过 <a href="http://developer.android.com/reference/android/app/Activity.html#overridePendingTransition(int,%20int)" target="_blank" rel="external">Activity#overridePendingTransition()</a> 和 <a href="http://developer.android.com/reference/android/app/FragmentTransaction.html#setCustomAnimations(int,%20int,%20int,%20int)" target="_blank" rel="external">FragmentTransaction#setCustomAnimation()</a> 方法实现)，但是动画的对象只能是<strong>Activity/Fragment</strong>整体。而新的 API 将这个特性延伸，使我们可以为每个 View 单独设置动画，甚至可以在两个独立的 Activity/Fragment 容器内共享某些 View的动画。</p>
<p>接下来介绍些术语。注意，虽然下面是以 Activity 为例，但是在 Fragment 中这些术语也同样有效:</p>
<blockquote>
<p>假设 <strong>A</strong> 和 <strong>B</strong> 是两个 Activity，通过 <strong>A</strong> 来启动 <strong>B</strong>。<br><strong>A</strong> 叫做 “调用Activity”(调用 <code>startActivity()</code> 的那个)<br><strong>B</strong> 就是 “被调用Activity”</p>
</blockquote>
<p>Activity transition API 是围绕退出，进入，返回还有重入过渡动画效果构建的。根据之前的定义我们可以这样描述它们:</p>
<blockquote>
<p>Activity <strong>A</strong> 的 退出 Transition 确定 <strong>A</strong> 启动 <strong>B</strong> 时 <strong>A</strong> 中 View 的动画</p>
<p>Activity <strong>B</strong> 的 进入 Transition 确定 <strong>A</strong> 启动 <strong>B</strong> 时 <strong>B</strong> 中 View 的动画</p>
<p>Activity <strong>B</strong> 的 返回 Transition 确定 <strong>B</strong> 返回 <strong>A</strong> 时 <strong>B</strong> 中 View 的动画</p>
<p>Activity <strong>A</strong> 的 重入 Transition 确定 <strong>B</strong> 返回 <strong>A</strong> 时 <strong>A</strong> 中 View 的动画</p>
</blockquote>
<p>最后，Transition 框架提供了 <strong>Content(内容)</strong>和<strong>共享元素(Shared Element)</strong> 两种类型的Activity过渡动画，每个都可以让我们以独特的方式自定义 Activity 切换间的动画</p>
<blockquote>
<p><strong>Content(内容) Transition</strong> 确定了非共享元素如何 进入/退出 Activity 场景</p>
<p><strong>共享元素(Shared Element) Transition</strong> 确定了两个Activity 共享 View (也被叫做主角视图)的动画效果。</p>
</blockquote>
<p><a href="http://www.androiddesignpatterns.com/assets/videos/posts/2014/12/04/news-opt.mp4" target="_blank" rel="external">Video 1.2</a>这段视频很好的解释了 Content Transition 和 共享元素 Transition，我猜想它使用了下面的过渡动画。</p>
<ul>
<li><strong>A</strong>(调用Activity) 的<strong>退出</strong>和<strong>重新进入</strong> Content Transition 都是 <strong>null</strong>。因为用户退出和重新进入时 Activity A中的非共享视图没有动画效果。<a id="2" href="#b2">(2)</a></li>
</ul>
<ul>
<li><p><strong>B</strong>(被调用Activity) 的<strong>进入</strong> Content Transition 使用了一个自定义的 Slide Transition 将list item从底部移至屏幕中。</p>
</li>
<li><p>Activity <strong>B</strong> 的<strong>返回</strong> Content Transition是一个 <strong>TransitionSet</strong>，同时进行两个子 Transition:一个Slide (Gravity.TOP) Transition<br>针对Activity上半部分的View，一个Slide (Gravity.BOTTOM) Transition 针对Activity 下半部分View。当用户点击按钮返回Activity A，Activity呈现一种断成两半的感觉。</p>
</li>
<li><p>共享元素的进入和退出 Transition 都是 <strong>ChangeImageTransform</strong>，使ImageView过渡动画可以在两个Activity间无缝衔接。</p>
</li>
</ul>
<p>你可能也注意到了在共享元素 Transition 下还有一个圆形的过渡动画(circular reveal)，我们会在将来的章节中介绍它是如何实现的。现在，我们来继续了解 Activity 和 Fragment transition APIs</p>
<p>#介绍Activity Transition API</p>
<p>使用 Lollipop 的 APIs 创建一个 Activity 过渡动画 非常简单，下面的总结是实现一个过渡动画的必要步骤。在接下来的文章中我们还会介绍很多提升水平的用例，不过现在先让我们来入个门:</p>
<ul>
<li><p>在你的A(调用Activity)和B(被调用Activity)的 <code>.java</code> 文件或者<br><code>xml</code><a id="3" href="#b3">(3)</a>布局中请求启用<br><a href="http://developer.android.com/reference/android/view/Window.html#FEATURE_ACTIVITY_TRANSITIONS" target="_blank" rel="external"><code>Window.FEATURE_ACTIVITY_TRANSITIONS</code></a> 窗口特性，<br>使用Material主题的应用默认已开启。</p>
</li>
<li><p>为A和B单独设置 <a href="https://developer.android.com/reference/android/view/Window.html#setExitTransition(android.transition.Transition)" target="_blank" rel="external"><strong>exit</strong></a> 和 <a href="https://developer.android.com/reference/android/view/Window.html#setEnterTransition(android.transition.Transition)" target="_blank" rel="external"><strong>enter</strong></a> Content Transition 。<br>Material主题的 <a href="https://developer.android.com/reference/android/view/Window.html#setExitTransition(android.transition.Transition)" target="_blank" rel="external"><strong>exit</strong></a> 和 <a href="https://developer.android.com/reference/android/view/Window.html#setEnterTransition(android.transition.Transition)" target="_blank" rel="external"><strong>enter</strong></a> Content Transition 默认分别是<br><code>null</code>和<code>Fade</code>。如果没有明确定义 <a href="https://developer.android.com/reference/android/view/Window.html#setSharedElementReenterTransition(android.transition.Transition)" target="_blank" rel="external"><strong>reenter</strong></a> 或 <a href="https://developer.android.com/reference/android/view/Window.html#setReturnTransition(android.transition.Transition)" target="_blank" rel="external"><strong>return</strong></a><br>Content Transition 将会使用 Activity 的 <a href="https://developer.android.com/reference/android/view/Window.html#setExitTransition(android.transition.Transition)" target="_blank" rel="external"><strong>exit</strong></a> 和 <a href="https://developer.android.com/reference/android/view/Window.html#setEnterTransition(android.transition.Transition)" target="_blank" rel="external"><strong>enter</strong></a><br> Transition 来代替。</p>
</li>
<li><p>为 A 和 B 设置 <a href="https://developer.android.com/reference/android/view/Window.html#setExitTransition(android.transition.Transition)" target="_blank" rel="external"><strong>exit</strong></a> 和 <a href="https://developer.android.com/reference/android/view/Window.html#setEnterTransition(android.transition.Transition)" target="_blank" rel="external"><strong>enter</strong></a> 共享元素 Transition。<br>Material主题中共享元素默认设置 <a href="https://github.com/android/platform_frameworks_base/blob/lollipop-release/core/res/res/transition/move.xml" target="_blank" rel="external"><code>@android:transition/move</code></a> 作为<br><a href="https://developer.android.com/reference/android/view/Window.html#setExitTransition(android.transition.Transition)" target="_blank" rel="external"><strong>exit</strong></a> 和 <a href="https://developer.android.com/reference/android/view/Window.html#setEnterTransition(android.transition.Transition)" target="_blank" rel="external"><strong>enter</strong></a> 过渡动画。如果没有明确定义<br><a href="https://developer.android.com/reference/android/view/Window.html#setSharedElementReenterTransition(android.transition.Transition)" target="_blank" rel="external"><strong>reenter</strong></a> 和 <a href="https://developer.android.com/reference/android/view/Window.html#setReturnTransition(android.transition.Transition)" target="_blank" rel="external"><strong>return</strong></a> 的过渡动画将会使用 Activity 的<br><a href="https://developer.android.com/reference/android/view/Window.html#setExitTransition(android.transition.Transition)" target="_blank" rel="external"><strong>exit</strong></a> 和 <a href="https://developer.android.com/reference/android/view/Window.html#setEnterTransition(android.transition.Transition)" target="_blank" rel="external"><strong>enter</strong></a> 过渡动画作为替代。</p>
</li>
<li><p>启动一个包含 Content Transition 和 共享元素 Transition 的 Activity 时要调用<br><code>startActivity(Context, Bundle)</code>方法，其中第二参数 Bundle 通过下面这段代码获得：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ActivityOptions.makeSceneTransitionAnimation(activity, pairs).toBundle();</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>pairs</strong> 是一个 <strong>Pair&lt; View, String &gt;</strong> 数组，记录Activity间<a id="4" href="#b4">(4)</a> 共享元素的View 和 相对应的特征字符串。别忘了在<a href="https://developer.android.com/reference/android/view/View.html#setTransitionName(java.lang.String)" target="_blank" rel="external">程序</a>中或 <a href="https://developer.android.com/reference/android/view/View.html#attr_android:transitionName" target="_blank" rel="external">xml</a> 文件里给共享元素设置不重复的名称，否则过渡动画不会正常运行。</p>
<ul>
<li><p>通过启动程序返回一个 Transition，调用 <strong>finishAfterTransition()</strong> 代替 <strong>finish()</strong>。</p>
</li>
<li><p>Material主题应用默认会在他们的<strong>退出/重入</strong> Transition 完成前一点点启动<strong>进入/返回</strong> Content Transition，这样会在两个动画间产生一些重叠，让过渡动画更好看。如果你想关闭这个特性可以调用 <a href="http://developer.android.com/reference/android/view/Window.html#setAllowEnterTransitionOverlap(boolean)" target="_blank" rel="external"> setWindowAllowEnterTransitionOverlap()</a> 和 <a href="http://developer.android.com/reference/android/view/Window.html#setAllowReturnTransitionOverlap(boolean)" target="_blank" rel="external">setWindowAllowReturnTransitionOverlap()</a> 方法或者在xml文件里给定适当的属性</p>
</li>
</ul>
<p>##Fragment 的 Transition API</p>
<p>如果你使用 Fragment 的 transition API，大部分 API 相似，但是会有一些小的不同:</p>
<ul>
<li><p>Content 的<a href="https://developer.android.com/reference/android/view/Window.html#setExitTransition(android.transition.Transition)" target="_blank" rel="external">退出</a>，<a href="https://developer.android.com/reference/android/view/Window.html#setEnterTransition(android.transition.Transition)" target="_blank" rel="external">进入</a>，<a href="https://developer.android.com/reference/android/view/Window.html#setSharedElementReenterTransition(android.transition.Transition)" target="_blank" rel="external">重入</a>和<a href="https://developer.android.com/reference/android/view/Window.html#setReturnTransition(android.transition.Transition)" target="_blank" rel="external">返回</a> 过渡动画应该在 Fragment 的<code>.java</code>文件中调用对应的方法或者在 xml 属性声明里设置。</p>
</li>
<li><p>共享元素 的<a href="https://developer.android.com/reference/android/view/Window.html#setEnterTransition(android.transition.Transition)" target="_blank" rel="external">进入</a>和 <a href="https://developer.android.com/reference/android/view/Window.html#setReturnTransition(android.transition.Transition)" target="_blank" rel="external">返回</a> 过渡动画应该在 Fragment 的<code>.java</code>文件中调用对应的方法或者在 xml 属性声明里设置。</p>
</li>
<li><p>鉴于Activity的 Transition 是通过调用 <strong>startActivity()</strong> 和 <strong>finishAfterTransition()</strong> 直接启动的,Fragment 的过渡是在 Fragment<br>被add, remove, attach, detach, show,或 hidden 后由 FragmentTransaction 自动启动。</p>
</li>
<li><p>共享元素应该在transaction(事务)提交前调用<a href="https://developer.android.com/reference/android/app/FragmentTransaction.html#addSharedElement(android.view.View,%20java.lang.String)" target="_blank" rel="external"><code>addSharedElement(View, String)</code></a>声明为 <strong>FragmentTransaction</strong> 的一部分。</p>
</li>
</ul>
<p>##结语</p>
<p>这篇文章里我们只是简单的介绍了 Activitiy 和 Fragment transition API，但是在接下来的文章你会发现扎实的基础给你带来的好处，尤其是在讲到<strong>自定义过渡动画</strong>时。后面我们会非常深入的讲解 Content Transition 和 共享元素 Transition，让你更加了解 Activity 和 Fragment 背后的工作。</p>
<p>希望你喜欢我的文章，感谢观看～</p>
<ol>
<li><p>如果你想尝试这个例子，这里有<a href="https://gist.github.com/alexjlockwood/a96781b876138c37e88e" target="_blank" rel="external">xml代码</a> <a id="b1" href="#1">↩</a></p>
</li>
<li><p>第一眼看上去可能感觉是Activity A fade in/out 屏幕, 事实上是Activity B 在 Activity A 的上面渐变. A 中的 View 事实上是没有动画的. 你可以在被调用 Activity 的 Window 中使用 <a href="http://developer.android.com/reference/android/view/Window.html#setTransitionBackgroundFadeDuration(long)" target="_blank" rel="external">setTransitionBackgroundFadeDuration()</a> 方法调节背景渐变持续时间。 <a id="b2" href="#2">↩</a></p>
</li>
<li><p>了解更多关于 <strong>FEATURE_ACTIVITY_TRANSITIONS</strong> 和 <strong>FEATURE_CONTENT_TRANSITIONS</strong> 窗口特性的不同可以看<a href="http://stackoverflow.com/questions/28975840/feature-activity-transitions-vs-feature-content-transitions" target="_blank" rel="external">这里StackOverflow Post</a><a id="b3" href="#3">↩</a></p>
</li>
<li><p>启动一个包含Content Transition 而不是共享元素 Transition 的Activity,可以这样创建<strong>Bundle</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ActivityOptions.makeSceneTransitionAnimation(activity).toBundle()</div></pre></td></tr></table></figure>
<p>如果想完全禁用Content Transition 和 共享元素 Transition 可以将 Bundle 设为 <strong>null</strong>. <a id="b4" href="#4">↩</a></p>
</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/开始使用 Transitions（过渡动画） (part 1)/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/开始使用 Transitions（过渡动画） (part 1)/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/拖拽RecyclerView/" title="拖拽RecyclerView" itemprop="url">拖拽RecyclerView</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://medium.com/@ipaulpro/drag-and-swipe-with-recyclerview-b9456d2b1aaf" target="_blank" rel="external">Drag and Swipe with RecyclerView</a></li>
<li>原文作者 : <a href="https://medium.com/@ipaulpro" target="_blank" rel="external">Paul Burke</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/objectlife" target="_blank" rel="external">objectlife</a> </li>
<li>校对者: <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a> </li>
<li>状态 : 完成</li>
</ul>
<video loop video="" autoplay class="graf-image" data-image-id="1*4Cqfs-75ibhvC_3BMEIvVA.gif" data-width="1440" data-height="600"><source src="https://d262ilb51hltx0.cloudfront.net/max/2000/1*4Cqfs-75ibhvC_3BMEIvVA.mp4" type="video/mp4"></video>



<p>现在有很多使用RecyclerView实现“<strong>拖拽(drag &amp; drop)</strong>”和“<strong>滑动消失(swipe-to-dismiss)</strong>”效果的教程、库、和示例代码。虽然现在有更新的、更好的方式可以实现但是大部分的代码仍旧使用了旧的API<em><a href="http://developer.android.com/guide/topics/ui/drag-drop.html" target="_blank" rel="external">View.OnDragListener</a></em>或者使用Roman Nurik’s <em><a href="https://github.com/romannurik/Android-SwipeToDismiss" target="_blank" rel="external">SwipeToDismiss</a></em>这个库中的处理方式。有一部分使用了新的API，但主要是依赖GestureDetectors 和 onInterceptTouchEvent或者实现的方式很复杂。实际上有非常简单的方式就可以把新特性添加到RecyclerView中。只需要一个类，并且它已经包含在Android Support Library之中。</p>
<p>###<a href="https://developer.android.com/reference/android/support/v7/widget/helper/ItemTouchHelper.html" target="_blank" rel="external">ItemTouchHelper</a></p>
<p>ItemTouchHelper是一个非常强大的工具类用于处理当你添加drag&amp;drop 和 swipe-to-dismiss特性到RecyclerView时所关心的那些问题。它是<a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.ItemDecoration.html" target="_blank" rel="external">RecyclerView.ItemDecoration</a>的子类,意味着可以向已经存在的LayoutManager 和 Adapter(!)中添加任何东西，并且也可以处理已经存在的item animations、type-restricted、drop settling animations甚至更多。<br>在这篇文章我将示范一下ItemTouchHelper的简单实现，稍后，在这一系列的文章中我们将延伸扩展更多特性。</p>
<p>##忽略开头</p>
<p>只对代码感兴趣？ Github源码: <em><a href="https://github.com/iPaulPro/Android-ItemTouchHelper-Demo" target="_blank" rel="external">Android-ItemTouchHelper-Demo</a></em>,<br>Apk下载:<em><a href="https://github.com/iPaulPro/Android-ItemTouchHelper-Demo/releases" target="_blank" rel="external">from here</a></em>.</p>
<p>##配置</p>
<p>首先我们需要对RecyclerView进行配置，如果没有准备好，请先更新你的build.gradle，添加RecyclerView依赖。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'com.android.support:recyclerview-v7:22.2.0'</span></div></pre></td></tr></table></figure>
<p>在任意RecyclerView.Adapter 和 LayoutManager都可以使用ItemTouchHelper，这篇文章代码的基本文件在这：</p>
<p><a href="https://gist.github.com/iPaulPro/2216ea5e14818056cfcc" target="_blank" rel="external">https://gist.github.com/iPaulPro/2216ea5e14818056cfcc</a></p>
<p>##使用ItemTouchHelper 和 ItemTouchHelper.Callback</p>
<p>为了使用ItemTouchHelper，你必须得先创建<em><a href="https://developer.android.com/reference/android/support/v7/widget/helper/ItemTouchHelper.Callback.html" target="_blank" rel="external">ItemTouchHelper.Callback</a></em>。这是一个接口用于监听“move” 和 “swipe”的状态。也可用于你要控制所选的view的状态和重写默认动画。如果你只是想使用基本实现你可以使用系统提供的一个帮助类<em><a href="https://developer.android.com/reference/android/support/v7/widget/helper/ItemTouchHelper.SimpleCallback.html" target="_blank" rel="external">SimpleCallback</a></em>，但是本着学习的目的，我们还是自己来实现。</p>
<p>实现基本的drag &amp; drop 和 swipe-to-dismiss必须实现以下主要的回调函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">getMovementFlags(RecyclerView, ViewHolder)</div><div class="line">onMove(RecyclerView, ViewHolder, ViewHolder)</div><div class="line">onSwiped(ViewHolder, <span class="keyword">int</span>)</div></pre></td></tr></table></figure>
<p>使用两个帮助函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">isLongPressDragEnabled()</div><div class="line">isItemViewSwipeEnabled()</div></pre></td></tr></table></figure>
<p>我们将逐个进行介绍.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMovementFlags</span><span class="params">(RecyclerView recyclerView, </span></span></div><div class="line">        RecyclerView.ViewHolder viewHolder) &#123;</div><div class="line">    <span class="keyword">int</span> dragFlags = ItemTouchHelper.UP | ItemTouchHelper.DOWN;</div><div class="line">    <span class="keyword">int</span> swipeFlags = ItemTouchHelper.START | ItemTouchHelper.END;</div><div class="line">    <span class="keyword">return</span> makeMovementFlags(dragFlags, swipeFlags);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ItemTouchHelper允许非常简单的判断屏幕事件的走向。必须重写<strong>getMovementFlags()</strong>来说明支持哪个方向的拖拽和滑动。使用帮助类<strong>ItemTouchHelper.makeMovementFlags(int, int)</strong>来管理returned标志。这样就可以在同一个方向进行拖拽和滑动了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLongPressDragEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ItemTouchHelper可以只支持drag而不支持swipe(or vice versa)，所以你必须明确指出你希望支持的类型。为了支持长按 RecyclerView item 对其进行拖动，<strong>isLongPressDragEnabled()</strong>函数实现应该返回true. 此外在开始拖拽时<strong>ItemTouchHelper.startDrag(RecyclerView.ViewHolder)</strong>将会被调用。这个我们稍后再讨论。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isItemViewSwipeEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果在viwe中可以随意滑动，<strong>isItemViewSwipeEnabled()</strong>函数返回true. 此外手动拖动时<strong>ItemTouchHelper.startSwipe(RecyclerView.ViewHolder)</strong>会被调用。</p>
<p><strong>onMove()</strong> 和 <strong>onSwiped()</strong>负责主要数据的更新。故首先我们需要创建一个允许传递事件回调的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemTouchHelperAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemMove</span><span class="params">(<span class="keyword">int</span> fromPosition, <span class="keyword">int</span> toPosition)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemDismiss</span><span class="params">(<span class="keyword">int</span> position)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em><a href="https://gist.github.com/iPaulPro/5d43325ac7ae579760a9" target="_blank" rel="external">ItemTouchHelperAdapter.java Gist</a></em></p>
<p>最简单的方式就是下面这样，让我们的RecyclerListAdapter实现ItemTouchHelperAdapter。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclerListAdapter</span> <span class="keyword">extends</span> </span></div><div class="line">        <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">ItemViewHolder</span>&gt; </div><div class="line">        <span class="keyword">implements</span> <span class="title">ItemTouchHelperAdapter</span> &#123;</div><div class="line"><span class="comment">// ... code from [gist]()</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemDismiss</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    mItems.remove(position);</div><div class="line">    notifyItemRemoved(position);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemMove</span><span class="params">(<span class="keyword">int</span> from, <span class="keyword">int</span> to)</span> </span>&#123;</div><div class="line">    Collections.swap(mItems, from, to);</div><div class="line">    notifyItemMoved(from, to);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>notifyItemRemoved()</strong> 和 <strong>notifyItemMoved()</strong>的调用是非常重要，因此Adapter是可以感受到这些变化的,同样重要的是要注意当我们改变item的Position的时候view的index也时刻在改变，<strong>并不是在“drop”事件结束后再改变</strong>。</p>
<p>现在我们回过头来创建我们自己的<strong>SimpleItemTouchHelperCallback</strong>并且必须override onMove() 和 onSwiped()。首先添加一个构造函数和Adapter变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ItemTouchHelperAdapter mAdapter;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">SimpleItemTouchHelperCallback</span><span class="params">(</span></span></div><div class="line">        ItemTouchHelperAdapter adapter) &#123;</div><div class="line">    mAdapter = adapter;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>之后 override the remaining events and notify the adapter:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onMove</span><span class="params">(RecyclerView recyclerView, </span></span></div><div class="line">        RecyclerView.ViewHolder viewHolder, </div><div class="line">        RecyclerView.ViewHolder target) &#123;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">mAdapter.onItemMove(viewHolder.getAdapterPosition(), </div><div class="line">            target.getAdapterPosition());</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSwiped</span><span class="params">(RecyclerView.ViewHolder viewHolder, </span></span></div><div class="line">        <span class="keyword">int</span> direction) &#123;</div><div class="line">    mAdapter.onItemDismiss(viewHolder.getAdapterPosition());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>写完之后回调类应该像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleItemTouchHelperCallback</span> <span class="keyword">extends</span> <span class="title">ItemTouchHelper</span>.<span class="title">Callback</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ItemTouchHelperAdapter mAdapter;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleItemTouchHelperCallback</span><span class="params">(ItemTouchHelperAdapter adapter)</span> </span>&#123;</div><div class="line">        mAdapter = adapter;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLongPressDragEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isItemViewSwipeEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMovementFlags</span><span class="params">(RecyclerView recyclerView, ViewHolder viewHolder)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> dragFlags = ItemTouchHelper.UP | ItemTouchHelper.DOWN;</div><div class="line">        <span class="keyword">int</span> swipeFlags = ItemTouchHelper.START | ItemTouchHelper.END;</div><div class="line">        <span class="keyword">return</span> makeMovementFlags(dragFlags, swipeFlags);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onMove</span><span class="params">(RecyclerView recyclerView, ViewHolder viewHolder, </span></span></div><div class="line">            ViewHolder target) &#123;</div><div class="line">        mAdapter.onItemMove(viewHolder.getAdapterPosition(), target.getAdapterPosition());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSwiped</span><span class="params">(ViewHolder viewHolder, <span class="keyword">int</span> direction)</span> </span>&#123;</div><div class="line">        mAdapter.onItemDismiss(viewHolder.getAdapterPosition());</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>随着我们Callback的完成，再创建ItemTouchHelper并且调用<strong>attachToRecyclerView(RecyclerView)</strong> (e.g. in <a href="https://gist.github.com/iPaulPro/2216ea5e14818056cfcc#file-mainfragment-java" target="_blank" rel="external">MainFragment.java</a>):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">ItemTouchHelper.Callback callback = </div><div class="line">    <span class="keyword">new</span> SimpleItemTouchHelperCallback(adapter);</div><div class="line">ItemTouchHelper touchHelper = <span class="keyword">new</span> ItemTouchHelper(callback);</div><div class="line">touchHelper.attachToRecyclerView(recyclerView);</div></pre></td></tr></table></figure>
<p>程序运行结果：</p>
<video loop video="" autoplay class="graf-image" data-image-id="1*FdJbZnF5I-iOw0wgiuVJGQ.gif" data-width="360" data-height="508"><br><source src="https://d262ilb51hltx0.cloudfront.net/max/1600/1*FdJbZnF5I-iOw0wgiuVJGQ.mp4" type="video/mp4">Your browser does not support the video tag.</video>


<p>##结束语</p>
<p>这是一种极其简单的对ItemTouchHelper的实现写法。但是应该清楚的知道，使用RecyclerView实现基本的拖拽和滑动消失效果是不需要引入三方library的。在下一篇中我们将对拖拽进行更加丰富的控制实现。</p>
<p>##源代码</p>
<p><a href="https://github.com/iPaulPro/Android-ItemTouchHelper-Demo" target="_blank" rel="external">Android-ItemTouchHelper-Demo</a>.</p>
<p>关注我: <a href="http://google.com/+PaulBurke" target="_blank" rel="external">Google+</a> and <a href="https://twitter.com/ipaulpro" target="_blank" rel="external">Twitter</a></p>
<p>© 2015 Paul Burke</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/拖拽RecyclerView/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/拖拽RecyclerView/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/手动实现布局Transitions动画-第一部分/" title="手动实现布局Transitions动画-第一部分" itemprop="url">手动实现布局Transitions动画-第一部分</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://blog.stylingandroid.com/manual-layout-transitions-part-1/" target="_blank" rel="external">Manual Layout Transitions – Part 1</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a></li>
</ul>
<p>布局切换动画在Material design中是一个重要的方面,因为它们能够指明应用的工作流程，并且能够将UI上的可视化元素绑定在一起作为用户的导航。两个重要的工具可以实现这种效果，分别为Activity转场动画和布局动画（Layout Transitions）。然后布局动画需要在API 19及其之后才支持。在这一系列文章中，我们会学习到即使在无法调用transitions APIs时如何实现很好的转场动画。</p>
<p>在我们开始之前，值得指出的是有一个后向兼容的Transitions API提供了到API 14的兼容。然而我决定不使用它，因为我从来没有尝试过使用它。我坚持使用核心的Android API来完成此功能，这个系列文章的目的就是探索transitions API本身使用的技术，从而达到运用自如的效果。</p>
<p>在<a href="https://blog.stylingandroid.com/dirty-phrasebook-part-1/" target="_blank" rel="external">上一个系列</a>中当进行转场时会有一些简单的动画。可以到这个<a href="https://youtu.be/vXuY7q3Y5zw" target="_blank" rel="external">视频地址</a>进行观看效果 。</p>
<p>我决定手动地实现这些效果，这种实现必须要具备后向兼容性。在开始处理更复杂的动画之前我们先来看看这些简单动画是如何实现的。</p>
<p>让我们来看看上述视频示例中的布局。    </p>
<p>res/layout/activity_main.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">  <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">  <span class="attr">xmlns:sa</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">  <span class="attr">android:id</span>=<span class="string">"@+id/layout_container"</span></div><div class="line">  <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">  <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">  <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">  <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</div><div class="line"> </div><div class="line">  <span class="tag">&lt;<span class="name">android.support.v7.widget.Toolbar</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"?attr/actionBarSize"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span></div><div class="line">    <span class="attr">android:theme</span>=<span class="string">"@style/ThemeOverlay.AppCompat.Dark.ActionBar"</span></div><div class="line">    <span class="attr">sa:popupTheme</span>=<span class="string">"@style/ThemeOverlay.AppCompat.Light"</span>&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">Spinner</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/language"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</div><div class="line"> </div><div class="line">  <span class="tag">&lt;/<span class="name">android.support.v7.widget.Toolbar</span>&gt;</span></div><div class="line"> </div><div class="line">  <span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/input_view"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">    <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></div><div class="line">    <span class="attr">android:clipChildren</span>=<span class="string">"false"</span>&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:clipChildren</span>=<span class="string">"false"</span></div><div class="line">      <span class="attr">android:padding</span>=<span class="string">"@dimen/card_padding"</span>&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">View</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/focus_holder"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">        <span class="attr">android:focusableInTouchMode</span>=<span class="string">"true"</span> /&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/input"</span></div><div class="line">        <span class="attr">style</span>=<span class="string">"@style/Widget.TextView.Input"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:inputType</span>=<span class="string">"textMultiLine"</span></div><div class="line">        <span class="attr">android:imeOptions</span>=<span class="string">"flagNoFullscreen|actionDone"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"top"</span></div><div class="line">        <span class="attr">android:hint</span>=<span class="string">"@string/type_here"</span> /&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/clear_input"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_alignTop</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_alignEnd</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_alignRight</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:padding</span>=<span class="string">"8dp"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@drawable/ic_clear"</span></div><div class="line">        <span class="attr">android:visibility</span>=<span class="string">"invisible"</span></div><div class="line">        <span class="attr">android:contentDescription</span>=<span class="string">"@string/clear_input"</span> /&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/input_done"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"32dip"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"32dip"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@drawable/done_background"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@drawable/ic_arrow_forward"</span></div><div class="line">        <span class="attr">android:padding</span>=<span class="string">"2dp"</span></div><div class="line">        <span class="attr">android:layout_margin</span>=<span class="string">"8dp"</span></div><div class="line">        <span class="attr">tools:ignore</span>=<span class="string">"UnusedAttribute"</span></div><div class="line">        <span class="attr">android:elevation</span>=<span class="string">"4dp"</span></div><div class="line">        <span class="attr">android:visibility</span>=<span class="string">"invisible"</span></div><div class="line">        <span class="attr">android:layout_alignBottom</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_alignEnd</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_alignRight</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:contentDescription</span>=<span class="string">"@string/done"</span> /&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"> </div><div class="line">  <span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></div><div class="line"> </div><div class="line">  <span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/translation_panel"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">    <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></div><div class="line">    <span class="attr">android:padding</span>=<span class="string">"@dimen/translation_outer_margin"</span>&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/translation_copy"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:foreground</span>=<span class="string">"@drawable/click_foreground"</span>&gt;</div><div class="line"> </div><div class="line">        <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">          <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">          <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">          <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">          <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span></div><div class="line">          <span class="attr">tools:ignore</span>=<span class="string">"UselessParent"</span>&gt;</div><div class="line"> </div><div class="line">          <span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/translation_speak"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:foreground</span>=<span class="string">"@drawable/click_foreground"</span></div><div class="line">            <span class="attr">android:padding</span>=<span class="string">"@dimen/translation_inner_margin"</span>&gt;</div><div class="line"> </div><div class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">              <span class="attr">android:id</span>=<span class="string">"@+id/translation_label"</span></div><div class="line">              <span class="attr">style</span>=<span class="string">"@style/Widget.TextView.Label"</span></div><div class="line">              <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">              <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">              <span class="attr">android:textAllCaps</span>=<span class="string">"true"</span></div><div class="line">              <span class="attr">android:drawableStart</span>=<span class="string">"@drawable/ic_tts"</span></div><div class="line">              <span class="attr">android:drawableLeft</span>=<span class="string">"@drawable/ic_tts"</span></div><div class="line">              <span class="attr">android:drawablePadding</span>=<span class="string">"4dip"</span></div><div class="line">              <span class="attr">android:text</span>=<span class="string">"@string/sample_language"</span> /&gt;</div><div class="line">          <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div><div class="line"> </div><div class="line">          <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/translation"</span></div><div class="line">            <span class="attr">style</span>=<span class="string">"@style/Widget.TextView.Translation"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"@dimen/translation_inner_margin"</span></div><div class="line">            <span class="attr">android:layout_marginStart</span>=<span class="string">"@dimen/translation_inner_margin"</span></div><div class="line">            <span class="attr">android:layout_marginRight</span>=<span class="string">"@dimen/translation_inner_margin"</span></div><div class="line">            <span class="attr">android:layout_marginEnd</span>=<span class="string">"@dimen/translation_inner_margin"</span></div><div class="line">            <span class="attr">android:layout_marginBottom</span>=<span class="string">"@dimen/translation_inner_margin"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@string/sample_translation"</span>/&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></div><div class="line"> </div><div class="line">  <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这里需要我们关心的关键组件是Toolbar、id为input_view的CardView、ID为input_done的ImageView以及id为translation_panel的FrameLayout。其他的我们需要关心的就是id为focus_holder且可视状态为invisible的用来抢占焦点的视图。在EditText和focus_holder之间触发焦点时触发进入或者退出输入模式，以此来决定启动对应的动画。</p>
<p>该动画将input_view上移到能够覆盖Toolbar的位置，然后将input_done视图以淡入的形式显示出来，并且将translation_panel淡出。当用户退出输入模式时则执行该动画的反向形式。在上述视频中你可以看到它的具体效果。</p>
<p>我们先看看MainActivity : </p>
<p>MainActivity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"> </div><div class="line">        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</div><div class="line">        setSupportActionBar(toolbar);</div><div class="line">        setTitle(R.string.sample_language);</div><div class="line"> </div><div class="line">        View input = findViewById(R.id.input);</div><div class="line">        View inputDone = findViewById(R.id.input_done);</div><div class="line">        <span class="keyword">final</span> View focusHolder = findViewById(R.id.focus_holder);</div><div class="line"> </div><div class="line">        input.setOnFocusChangeListener(Part1TransitionController.newInstance(<span class="keyword">this</span>));</div><div class="line">        inputDone.setOnClickListener(</div><div class="line">                <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(@NonNull View v)</span> </span>&#123;</div><div class="line">                        focusHolder.requestFocus();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个实现直截了当： 它所做的几UI是初始化Toolbar和视图的焦点逻辑。创建transitions的逻辑是执行在Part1TransitionController类中，我将这部分逻辑抽象到Part1TransitionController中使得我们在该系列的后续文章中能够更容易的包装其他实现。Part1TransitionController类继承自包含了通用逻辑的TransitionController类。</p>
<p>TransitionController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TransitionController</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnFocusChangeListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;Activity&gt; activityWeakReference;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AnimatorBuilder animatorBuilder;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransitionController</span><span class="params">(WeakReference&lt;Activity&gt; activityWeakReference, @NonNull AnimatorBuilder animatorBuilder)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.activityWeakReference = activityWeakReference;</div><div class="line">        <span class="keyword">this</span>.animatorBuilder = animatorBuilder;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFocusChange</span><span class="params">(View v, <span class="keyword">boolean</span> hasFocus)</span> </span>&#123;</div><div class="line">        Activity mainActivity = activityWeakReference.get();</div><div class="line">        <span class="keyword">if</span> (mainActivity != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (hasFocus) &#123;</div><div class="line">                enterInputMode(mainActivity);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                exitInputMode(mainActivity);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">protected</span> AnimatorBuilder <span class="title">getAnimatorBuilder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> animatorBuilder;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">enterInputMode</span><span class="params">(Activity mainActivity)</span></span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">exitInputMode</span><span class="params">(Activity mainActivity)</span></span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">closeIme</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Activity mainActivity = activityWeakReference.get();</div><div class="line">        <span class="keyword">if</span> (mainActivity != <span class="keyword">null</span>) &#123;</div><div class="line">            InputMethodManager imm = (InputMethodManager) mainActivity.getSystemService(</div><div class="line">                    Context.INPUT_METHOD_SERVICE);</div><div class="line">            imm.hideSoftInputFromWindow(view.getWindowToken(), <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">ImeCloseListener</span> <span class="keyword">extends</span> <span class="title">AnimatorListenerAdapter</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> View view;</div><div class="line"> </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ImeCloseListener</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.view = view;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(@NonNull Animator animation)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.onAnimationEnd(animation);</div><div class="line">            closeIme(view);</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在该类型中处理了onFocusChanged()事件，并且根据焦点调用相应的函数进入或者退出输入模式。在该类中包含了一个用于确认在退出输入模式时隐藏输入法的AnimatorListener类。另外还含有一个我们重复使用的、构建了一些原子属性的animators的AnimatorBuilder实例，我们看看AnimatorBuilder类的实现。</p>
<p>AnimatorBuilder.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnimatorBuilder</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSLATION_Y = <span class="string">"translationY"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALPHA = <span class="string">"alpha"</span>;</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> duration;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AnimatorBuilder <span class="title">newInstance</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> duration = context.getResources().getInteger(android.R.integer.config_mediumAnimTime);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AnimatorBuilder(duration);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    AnimatorBuilder(<span class="keyword">int</span> duration) &#123;</div><div class="line">        <span class="keyword">this</span>.duration = duration;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">buildTranslationYAnimator</span><span class="params">(View view, <span class="keyword">int</span> startY, <span class="keyword">int</span> endY)</span> </span>&#123;</div><div class="line">        Animator animator = ObjectAnimator.ofFloat(view, TRANSLATION_Y, startY, endY);</div><div class="line">        animator.setDuration(duration);</div><div class="line">        <span class="keyword">return</span> animator;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">buildShowAnimator</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> buildAlphaAnimator(view, <span class="number">0f</span>, <span class="number">1f</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">buildHideAnimator</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> buildAlphaAnimator(view, <span class="number">1f</span>, <span class="number">0f</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">buildAlphaAnimator</span><span class="params">(View view, <span class="keyword">float</span> startAlpha, <span class="keyword">float</span> endAlpha)</span> </span>&#123;</div><div class="line">        Animator animator = ObjectAnimator.ofFloat(view, ALPHA, startAlpha, endAlpha);</div><div class="line">        animator.setDuration(duration);</div><div class="line">        <span class="keyword">return</span> animator;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有两个基本的animator在这里被构建 : 一个是通过修改translationY属性移动View的动画，另一个是修改View的透明度实现修改alpha属性的动画。还有一个是组合了Alpha动画和提供了一些工具方法来将视图从完全不透明变化到透明，以及相反的过程。</p>
<p>所有这些我们只需要看看Part1TransitionController类中如何将这些功能结合在一起运用。</p>
<p>part1/Part1TransitionController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Part1TransitionController</span> <span class="keyword">extends</span> <span class="title">TransitionController</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TransitionController <span class="title">newInstance</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        WeakReference&lt;Activity&gt; mainActivityWeakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</div><div class="line">        AnimatorBuilder animatorBuilder = AnimatorBuilder.newInstance(activity);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Part1TransitionController(mainActivityWeakReference, animatorBuilder);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    Part1TransitionController(WeakReference&lt;Activity&gt; mainActivityWeakReference, AnimatorBuilder animatorBuilder) &#123;</div><div class="line">        <span class="keyword">super</span>(mainActivityWeakReference, animatorBuilder);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">enterInputMode</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        View inputView = activity.findViewById(R.id.input_view);</div><div class="line">        View inputDone = activity.findViewById(R.id.input_done);</div><div class="line">        View translation = activity.findViewById(R.id.translation_panel);</div><div class="line">        View toolbar = activity.findViewById(R.id.toolbar);</div><div class="line"> </div><div class="line">        inputDone.setVisibility(View.VISIBLE);</div><div class="line"> </div><div class="line">        AnimatorSet animatorSet = <span class="keyword">new</span> AnimatorSet();</div><div class="line">        AnimatorBuilder animatorBuilder = getAnimatorBuilder();</div><div class="line">        Animator moveInputView = animatorBuilder.buildTranslationYAnimator(inputView, <span class="number">0</span>, -toolbar.getHeight());</div><div class="line">        Animator showInputDone = animatorBuilder.buildShowAnimator(inputDone);</div><div class="line">        Animator hideTranslation = animatorBuilder.buildHideAnimator(translation);</div><div class="line">        animatorSet.playTogether(moveInputView, showInputDone, hideTranslation);</div><div class="line">        animatorSet.start();</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">exitInputMode</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> View inputView = activity.findViewById(R.id.input_view);</div><div class="line">        View inputDone = activity.findViewById(R.id.input_done);</div><div class="line">        View translation = activity.findViewById(R.id.translation_panel);</div><div class="line">        View toolbar = activity.findViewById(R.id.toolbar);</div><div class="line"> </div><div class="line">        AnimatorSet animatorSet = <span class="keyword">new</span> AnimatorSet();</div><div class="line">        AnimatorBuilder animatorBuilder = getAnimatorBuilder();</div><div class="line">        Animator moveInputView = animatorBuilder.buildTranslationYAnimator(inputView, -toolbar.getHeight(), <span class="number">0</span>);</div><div class="line">        Animator hideInputDone = animatorBuilder.buildHideAnimator(inputDone);</div><div class="line">        Animator showTranslation = animatorBuilder.buildShowAnimator(translation);</div><div class="line">        animatorSet.playTogether(moveInputView, hideInputDone, showTranslation);</div><div class="line">        animatorSet.addListener(<span class="keyword">new</span> ImeCloseListener(inputDone));</div><div class="line">        animatorSet.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Part1TransitionController类中我们实现了两个抽象方法，分别为exitInputMode和enterInputMode方法。在这两个函数中我们会找到对应的View，在enterInputMode函数中我们会构建一个包含了移动View到toolbar位置、修改inputDone到不透明状态、translation到透明状态的动画集。在exitInputMode函数中，我们执行相反的动画，同时添加了一个ImeCloseListener实例来保证在动画完成时隐藏输入法。</p>
<p>至此，我们就完成了所需的功能。通过一些基本的属性动画组合我们就完成了复杂的动画功能。</p>
<p>然而，我们并不止步于此。这个示例非常的直截了当，但是TransitionController实例实现了运用于View上的动画逻辑。因此，相比transitions API提供的功能来说我们还有很长的路要走。在下一篇文章中我们会做一些小修改来实现根据View的状态来动态的构建Animators，而不是像这篇文章中的手动创建。</p>
<p>完整的代码在<a href="https://github.com/StylingAndroid/ManualLayoutTransitions/tree/Part1" target="_blank" rel="external">这里</a> 。</p>
<p class="cc-block"><a rel="external" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank"><img alt="CC BY-NC-SA 4.0" class="cc-button" src="https://blog.stylingandroid.com/wp-content/plugins/creative-commons-configurator-1/media/cc/by-nc-sa/4.0/88x31.png" scale="0"></a><br><br><br><a href="http://blog.stylingandroid.com/manual-layout-transitions-part-1/" title="Permalink to Manual Layout Transitions – Part 1" target="_blank" rel="external"><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Manual Layout Transitions – Part 1</span></a> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://blog.stylingandroid.com/author/admin/" property="cc:attributionName" rel="external" target="_blank">Styling Android</a> is licensed under a <a rel="external" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.<br>Permissions beyond the scope of this license may be available at <a xmlns:cc="http://creativecommons.org/ns#" href="http://blog.stylingandroid.com/license-information" rel="external" target="_blank">http://blog.stylingandroid.com/license-information</a>.</p>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/手动实现布局Transitions动画-第一部分/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/手动实现布局Transitions动画-第一部分/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/手动实现布局Transitions动画-第三部分/" title="手动实现布局Transitions动画-第三部分" itemprop="url">手动实现布局Transitions动画-第三部分</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://blog.stylingandroid.com/manual-layout-transitions-part-3/" target="_blank" rel="external">Manual Layout Transitions – Part 3</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a></li>
</ul>
<p>布局切换动画在Material design中是一个重要的方面,因为它们能够指明应用的工作流程，并且能够将UI上的可视化元素绑定在一起作为用户的导航。两个重要的工具可以实现这种效果，分别为Activity转场动画和布局动画（Layout Transitions）。然后布局动画需要在API 19及其之后才支持。</p>
<p>上一篇文章中我们创建了两个布局代表两个视图状态，我们通过setContentView来切换它们。这篇文章我们在它们切换时添加动画效果。</p>
<p>我们已经找掌握了关于动画的相关基础知识，现在我们就要在两个布局状态切换时加入动画。</p>
<p>我们定义的两个布局都有相同的View以及id,两个状态的切换只是会修改这些视图的可见性以及位置。因此我们仅仅需要检测这些自然变化，然后应用合适的位置变换或者alpha动画到每个视图上。值得注意的是，由于我们加载了一个新的布局，但是两个布局中的视图类型和id都是一样的，它们代表的是两个不同的视图对象。此时，我们需要切换到一个新的布局视图中，旧的布局视图就不会出现在我们的视野中，所以我们不能确定旧布局视图的控件状态。因此我们需要一种机制来存储旧布局中特定View的状态属性。</p>
<p>part3/ViewState.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewState</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> top;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> visibility;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewState <span class="title">ofView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> top = view.getTop();</div><div class="line">        <span class="keyword">int</span> visibility = view.getVisibility();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ViewState(top, visibility);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ViewState</span><span class="params">(<span class="keyword">int</span> top, <span class="keyword">int</span> visibility)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.top = top;</div><div class="line">        <span class="keyword">this</span>.visibility = visibility;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMovedVertically</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> view.getTop() != top;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasAppeared</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> newVisibility = view.getVisibility();</div><div class="line">        <span class="keyword">return</span> visibility != newVisibility &amp;&amp; newVisibility == View.VISIBLE;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasDisappeared</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> newVisibility = view.getVisibility();</div><div class="line">        <span class="keyword">return</span> visibility != newVisibility &amp;&amp; newVisibility != View.VISIBLE;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getY</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> top;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码非常简单，因为我们只关心各视图的竖直偏移量和可见性。此外也就是写辅助方法以便于我们能够确定视图对象是否发生了改变。</p>
<p>此时我们已经有了一套机制来存储不在可见范围的视图的状态,下面我们来看看我们如何运用的。当我们调用setContentView时，通过TransitionController我们已经有了切换布局的机制。下一步我们需要做的就是在我们切换布局之前捕获这些视图的状态，并且替换掉。我们会通过TransitionAnimator类来实现这些功能，它会计算并且执行动画。Part3TransitionController类的代码如下 : </p>
<p>part3/Part3TransitionController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Part3TransitionController</span> <span class="keyword">extends</span> <span class="title">TransitionController</span> </span>&#123;</div><div class="line"> </div><div class="line">    Part3TransitionController(WeakReference&lt;Activity&gt; activityWeakReference, AnimatorBuilder animatorBuilder) &#123;</div><div class="line">        <span class="keyword">super</span>(activityWeakReference, animatorBuilder);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TransitionController <span class="title">newInstance</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        WeakReference&lt;Activity&gt; activityWeakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</div><div class="line">        AnimatorBuilder animatorBuilder = AnimatorBuilder.newInstance(activity);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Part3TransitionController(activityWeakReference, animatorBuilder);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">enterInputMode</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        createTransitionAnimator(activity);</div><div class="line">        activity.setContentView(R.layout.activity_part2_input);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">exitInputMode</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        createTransitionAnimator(activity);</div><div class="line">        activity.setContentView(R.layout.activity_part2);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createTransitionAnimator</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        ViewGroup parent = (ViewGroup) activity.findViewById(android.R.id.content);</div><div class="line">        View inputView = parent.findViewById(R.id.input_view);</div><div class="line">        View inputDone = parent.findViewById(R.id.input_done);</div><div class="line">        View translation = parent.findViewById(R.id.translation);</div><div class="line"> </div><div class="line">        TransitionAnimator.begin(parent, inputView, inputDone, translation);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里添加了一个createTransitionAnimator函数来查找视图，并且调用了TransitionAnimator的begin函数。这个函数在enterInputMode和exitInputMode 函数中调用Activity的setContentView之前被调用。你需要注意的是TransitionAnimator只是在两个视图状态之间进行切换，因此除了那些我们感兴趣的视图之外我们不需要对这两个布局有额外的了解。</p>
<p>我们看看TransitionAnimator类 : </p>
<p>So let’s take a look at TransitionAnimator:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransitionAnimator</span> <span class="keyword">implements</span> <span class="title">ViewTreeObserver</span>.<span class="title">OnPreDrawListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ViewGroup parent;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;ViewState&gt; startStates;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AnimatorBuilder animatorBuilder;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(ViewGroup parent, View... views)</span> </span>&#123;</div><div class="line">        SparseArray&lt;ViewState&gt; startStates = buildViewStates(views);</div><div class="line">        AnimatorBuilder animatorBuilder = AnimatorBuilder.newInstance(parent.getContext());</div><div class="line">        <span class="keyword">final</span> TransitionAnimator transitionAnimator = <span class="keyword">new</span> TransitionAnimator(animatorBuilder, parent, startStates);</div><div class="line">        ViewTreeObserver viewTreeObserver = parent.getViewTreeObserver();</div><div class="line">        viewTreeObserver.addOnPreDrawListener(transitionAnimator);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">TransitionAnimator</span><span class="params">(AnimatorBuilder animatorBuilder, ViewGroup parent, SparseArray&lt;ViewState&gt; startStates)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.animatorBuilder = animatorBuilder;</div><div class="line">        <span class="keyword">this</span>.parent = parent;</div><div class="line">        <span class="keyword">this</span>.startStates = startStates;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SparseArray&lt;ViewState&gt; <span class="title">buildViewStates</span><span class="params">(View... views)</span> </span>&#123;</div><div class="line">        SparseArray&lt;ViewState&gt; viewStates = <span class="keyword">new</span> SparseArray&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (View view : views) &#123;</div><div class="line">            viewStates.put(view.getId(), ViewState.ofView(view));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> viewStates;</div><div class="line">    &#125;</div><div class="line">    .</div><div class="line">    .</div><div class="line">    .</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在TransitionController类中调用TransitionAnimator的begin函数来做一些准备。</p>
<p>在begin函数中首先会调用buildViewStates函数来遍历所有传递进来的视图，并且将这些视图的状态以视图id为key存储到SparseArray对象中。然后通过AnimatorBuilder对象和parent视图和存储了视图状态的SparseArray对象来创建一个TransitionAnimator实例。</p>
<p>现在的代码看起来聪明一点了。在旧布局还没有从我们的视野中消失时我们捕获了它的视图状态，但是需要在新的布局创建之前我们现在需要做些其他的事情。我们不能简单的加载一个布局并且运用它，因为布局中的子视图可能还在错误的位置，直到我们经过了测量和布局两个过程之后它们才会在正确的位置。但是现在我们做的只是在parent容器中注册了一个OnPreDrawListener.这使得我们在parent下次绘制之前能够触发一个OnPreDrawListener回调。当TransitionController类中调用setContentView函数时，这个回调会在新布局被加载、测量和布局过程完成之后被调用一次，但是这个调用会执行在视图绘制之前。</p>
<p>TransitionAnimator类实现了ViewTreeObserver.OnPreDrawListener，并且被注册为OnPreDrawLister。它的onPreDraw函数会在新布局会绘制前调用。onPreDraw函数如下 : </p>
<p>part3/TransitionAnimator.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">    ViewTreeObserver viewTreeObserver = parent.getViewTreeObserver();</div><div class="line">    viewTreeObserver.removeOnPreDrawListener(<span class="keyword">this</span>);</div><div class="line">    SparseArray&lt;View&gt; views = <span class="keyword">new</span> SparseArray&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; startStates.size(); i++) &#123;</div><div class="line">        <span class="keyword">int</span> resId = startStates.keyAt(i);</div><div class="line">        View view = parent.findViewById(resId);</div><div class="line">        views.put(view.getId(), view);</div><div class="line">    &#125;</div><div class="line">    Animator animator = buildAnimator(views);</div><div class="line">    animator.start();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在onPreDraw函数中首先将TransitionAnimator自身从ViewTreeObserver中注销，因为我们不需要在每次绘制之前都回调onPreDraw函数。如果我们忘记了注销那么它会变得相对重量级，以至于会影响动画的流畅度。我们只需要在替换布局时回调一次onPreDraw函数，然后我们会在次函数中开始执行切换动画。</p>
<p>下一步我们要做的是迭代前面构建的SparseArray中的ViewStates，从ViewStates中取出视图id，然后根据这个id到parent中找到对应的视图，最后将视图存储到另一个SparseArray对象中。最后将这个SparseArray对象传递给buildAnimator函数。</p>
<p>part3/TransitionAnimator.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Animator <span class="title">buildAnimator</span><span class="params">(SparseArray&lt;View&gt; views)</span> </span>&#123;</div><div class="line">    AnimatorSet animatorSet = <span class="keyword">new</span> AnimatorSet();</div><div class="line">    List&lt;Animator&gt; animators = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; views.size(); i++) &#123;</div><div class="line">        <span class="keyword">int</span> resId = views.keyAt(i);</div><div class="line">        ViewState startState = startStates.get(resId);</div><div class="line">        View view = views.get(resId);</div><div class="line">        animators.add(buildViewAnimator(view, startState));</div><div class="line">    &#125;</div><div class="line">    animatorSet.playTogether(animators);</div><div class="line">    <span class="keyword">return</span> animatorSet;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这会构建一个包含了所有独立视图Animator的集合，这些Animator会并行的执行。在构建合适的Animator时会又调用buildViewAnimator函数。</p>
<p>part3/TransitionAnimator.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Animator <span class="title">buildViewAnimator</span><span class="params">(<span class="keyword">final</span> View view, ViewState startState)</span> </span>&#123;</div><div class="line">    Animator animator = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (startState.hasAppeared(view)) &#123;</div><div class="line">        animator = animatorBuilder.buildShowAnimator(view);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (startState.hasDisappeared(view)) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> visibility = view.getVisibility();</div><div class="line">        view.setVisibility(View.VISIBLE);</div><div class="line">        animator = animatorBuilder.buildHideAnimator(view);</div><div class="line">        animator.addListener(</div><div class="line">                <span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(@NonNull Animator animation)</span> </span>&#123;</div><div class="line">                        <span class="keyword">super</span>.onAnimationEnd(animation);</div><div class="line">                        view.setVisibility(visibility);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (startState.hasMovedVertically(view)) &#123;</div><div class="line">        <span class="keyword">int</span> startY = startState.getY();</div><div class="line">        <span class="keyword">int</span> endY = view.getTop();</div><div class="line">        animator = animatorBuilder.buildTranslationYAnimator(view, startY - endY, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> animator;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在该函数中会调用ViewState中的辅助方法确定每个视图的转换的类型。这些转换类型有三种,分别为一个invisible的视图变为visible、一个visible的视图变为invisible、在y轴上移动视图。每个转换动画我们都会构建一个对应的Animator对象。</p>
<p>如果此时我们运行这个示例，我们会看到很好的效果。<a href="https://youtu.be/CuigoE_Hjb4" target="_blank" rel="external">视频地址</a>。</p>
<p>这些代码能够很好的工作，但是有一个明显的问题它需要起始布局中的所有的视图在结束布局都有对应的视图，也就是两个布局中都含有类型和id的子view。但是这不是并不是所有的情况下都会这样。在下一篇文章中我们看看如何适配这个特定的场景。</p>
<p>源代码在<a href="https://github.com/StylingAndroid/ManualLayoutTransitions/tree/Part3" target="_blank" rel="external">这里</a>。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/手动实现布局Transitions动画-第三部分/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/手动实现布局Transitions动画-第三部分/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/04/27/手动实现布局Transitions动画-第二部分/" title="手动实现布局Transitions动画-第二部分" itemprop="url">手动实现布局Transitions动画-第二部分</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-04-27T10:28:07.000Z" itemprop="datePublished"> 发表于 2017-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>原文链接 : <a href="https://blog.stylingandroid.com/manual-layout-transitions-part-2/" target="_blank" rel="external">Manual Layout Transitions – Part 2</a></li>
<li><a href="http://www.devtf.cn" target="_blank" rel="external">译文出自 :  开发技术前线 www.devtf.cn</a></li>
<li>译者 : <a href="https://github.com/bboyfeiyu" target="_blank" rel="external">Mr.Simple</a></li>
</ul>
<p>布局切换动画在Material design中是一个重要的方面,因为它们能够指明应用的工作流程，并且能够将UI上的可视化元素绑定在一起作为用户的导航。两个重要的工具可以实现这种效果，分别为Activity转场动画和布局动画（Layout Transitions）。然后布局动画需要在API 19及其之后才支持。在这一系列文章中，我们会学习到即使在无法调用transitions APIs时如何实现很好的转场动画。</p>
<p>布局切换框架引入了代表特定布局状态的Scenes概念，也就是场景。我们会定义两个分离的布局来模仿这些，其中一个代表默认的视图，另一个代表我们进入输入模式的视图。我们先来创建两个布局，它们都是基于Dirty Phrasebook布局，当然我们会做一些小修改以便大家能够更容易理解。</p>
<p>首先是默认布局。</p>
<p>res/layout/activity_part2.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">  <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">  <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">  <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">  <span class="attr">android:clipChildren</span>=<span class="string">"false"</span>&gt;</div><div class="line"> </div><div class="line">  <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">    <span class="attr">android:layout_weight</span>=<span class="string">"1"</span>&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"?attr/actionBarSize"</span></div><div class="line">      <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span> /&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/focus_holder"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">      <span class="attr">android:focusableInTouchMode</span>=<span class="string">"true"</span>&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">requestFocus</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">View</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/input_view"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></div><div class="line">      <span class="attr">android:layout_below</span>=<span class="string">"@id/toolbar"</span>&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/input"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:inputType</span>=<span class="string">"textMultiLine"</span> /&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/input_done"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"32dip"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"32dip"</span></div><div class="line">        <span class="attr">android:layout_alignBottom</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_alignEnd</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_alignRight</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"bottom|end"</span></div><div class="line">        <span class="attr">android:layout_margin</span>=<span class="string">"8dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@drawable/done_background"</span></div><div class="line">        <span class="attr">android:contentDescription</span>=<span class="string">"@string/done"</span></div><div class="line">        <span class="attr">android:padding</span>=<span class="string">"2dp"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@drawable/ic_arrow_forward"</span></div><div class="line">        <span class="attr">android:visibility</span>=<span class="string">"invisible"</span> /&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></div><div class="line"> </div><div class="line">  <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"> </div><div class="line">  <span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">    <span class="attr">android:layout_weight</span>=<span class="string">"1"</span>&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/translation"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">      <span class="attr">android:layout_margin</span>=<span class="string">"8dp"</span>&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">View</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这个布局与我们上一篇使用的布局基本一致，但是稍微有一点小修改。现在我们感兴趣只有id为toolbar, focus_holder, input, input_view, input_done和 translation的视图控件。</p>
<p>它看起来是这样的:</p>
<p><img src="https://blog.stylingandroid.com/wp-content/uploads/2015/05/Screenshot_2015-05-17-22-17-21-169x300.png" alt=""></p>
<p>The layout for when we’re in input mode is:</p>
<p>下面是进入输入模式的布局 : </p>
<p>res/layout/activity_part2_input.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">  <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">  <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">  <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">  <span class="attr">android:clipChildren</span>=<span class="string">"false"</span>&gt;</div><div class="line"> </div><div class="line">  <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">    <span class="attr">android:layout_weight</span>=<span class="string">"1"</span>&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"?attr/actionBarSize"</span></div><div class="line">      <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span> /&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/focus_holder"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">      <span class="attr">android:focusableInTouchMode</span>=<span class="string">"true"</span> /&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/input_view"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></div><div class="line">      <span class="attr">android:layout_alignParentTop</span>=<span class="string">"true"</span></div><div class="line">      <span class="attr">android:layout_marginBottom</span>=<span class="string">"?attr/actionBarSize"</span>&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/input"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:inputType</span>=<span class="string">"textMultiLine"</span>&gt;</div><div class="line"> </div><div class="line">        <span class="tag">&lt;<span class="name">requestFocus</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">EditText</span>&gt;</span></div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/input_done"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"32dip"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"32dip"</span></div><div class="line">        <span class="attr">android:layout_alignBottom</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_alignEnd</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_alignRight</span>=<span class="string">"@id/input"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"bottom|end"</span></div><div class="line">        <span class="attr">android:layout_margin</span>=<span class="string">"8dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@drawable/done_background"</span></div><div class="line">        <span class="attr">android:contentDescription</span>=<span class="string">"@string/done"</span></div><div class="line">        <span class="attr">android:padding</span>=<span class="string">"2dp"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@drawable/ic_arrow_forward"</span></div><div class="line">        <span class="attr">android:visibility</span>=<span class="string">"visible"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></div><div class="line"> </div><div class="line">  <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"> </div><div class="line">  <span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">    <span class="attr">android:layout_weight</span>=<span class="string">"1"</span>&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></div><div class="line">      <span class="attr">android:id</span>=<span class="string">"@+id/translation"</span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">      <span class="attr">android:layout_margin</span>=<span class="string">"8dp"</span></div><div class="line">      <span class="attr">android:visibility</span>=<span class="string">"invisible"</span>&gt;</div><div class="line"> </div><div class="line">      <span class="tag">&lt;<span class="name">View</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>该布局和上一布局也是基本相同，它们的区别在于 : </p>
<ol>
<li>id为input_view的视图现在依附在它的父视图的顶部，而不是在toolbar的下面，也就是说它现在覆盖住了toolbar;</li>
<li>input_done视图现在已经变为可见状态，上一个布局中它是invisible状态;</li>
<li>translation视图变为invisible，上一布局中它是visible状态。</li>
</ol>
<p>效果如下 : </p>
<p><img src="https://blog.stylingandroid.com/wp-content/uploads/2015/05/Screenshot_2015-05-17-22-17-26-169x300.png" alt=""></p>
<p>两个布局代表UI的两个状态，如果我们使用Transitions API那么它们就是我们所谓的场景。</p>
<p>我们现在要做的就是在这两个布局之间进行状态切换，也就是进入、退出输入模式。首先我们需要检测MainActivity中的焦点 : </p>
<p>part2/mainActivity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> View input;</div><div class="line">    <span class="keyword">private</span> TransitionController focusChangeListener;</div><div class="line">    <span class="keyword">private</span> View.OnClickListener onClickListener;</div><div class="line">    <span class="keyword">private</span> View focusHolder;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        focusChangeListener = Part2TransitionController.newInstance(<span class="keyword">this</span>);</div><div class="line">        onClickListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(@NonNull View v)</span> </span>&#123;</div><div class="line">                focusHolder.requestFocus();</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"> </div><div class="line">        setContentView(R.layout.activity_part2);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (input != <span class="keyword">null</span>) &#123;</div><div class="line">            input.setOnFocusChangeListener(<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.setContentView(layoutResID);</div><div class="line">        input = findViewById(R.id.input);</div><div class="line">        View inputDone = findViewById(R.id.input_done);</div><div class="line">        focusHolder = findViewById(R.id.focus_holder);</div><div class="line">        input.setOnFocusChangeListener(focusChangeListener);</div><div class="line">        inputDone.setOnClickListener(onClickListener);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为我们检测到焦点变化，因此我们还需要添加一些逻辑到setContentView函数中。这样一来我们在调用setContentView时就可以切换这两个布局，此时View的层级关系也会随着改变。因此我们每次都需要找到布局中的子视图，焦点listener我们也需要移除并且重新设置一个到input视图中。</p>
<p>和原来一样，我们需要一个TransitionController来处理焦点变化: </p>
<p>.part2.Part2TransitionController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Part2TransitionController</span> <span class="keyword">extends</span> <span class="title">TransitionController</span> </span>&#123;</div><div class="line"> </div><div class="line">    Part2TransitionController(WeakReference&lt;Activity&gt; activityWeakReference, AnimatorBuilder animatorBuilder) &#123;</div><div class="line">        <span class="keyword">super</span>(activityWeakReference, animatorBuilder);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TransitionController <span class="title">newInstance</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        WeakReference&lt;Activity&gt; activityWeakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</div><div class="line">        AnimatorBuilder animatorBuilder = AnimatorBuilder.newInstance(activity);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Part2TransitionController(activityWeakReference, animatorBuilder);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">enterInputMode</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        activity.setContentView(R.layout.activity_part2_input);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">exitInputMode</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        activity.setContentView(R.layout.activity_part2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们需要做的只是调用Activity的setContentView函数来切换两个布局。</p>
<p>如果我们现在运行上面的代码，我们可以看到两个布局毫无过度的切换，这必然不是我们想要的。在下一篇文章中，我们将讲解如何在布局切换时添加动画。</p>
<p>本文的源代码在<a href="https://github.com/StylingAndroid/ManualLayoutTransitions/tree/Part2" target="_blank" rel="external">这里</a>。</p>
<p class="cc-block"><a rel="external" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank"><img alt="CC BY-NC-SA 4.0" class="cc-button" src="https://blog.stylingandroid.com/wp-content/plugins/creative-commons-configurator-1/media/cc/by-nc-sa/4.0/88x31.png" scale="0"></a><br><br><br><a href="http://blog.stylingandroid.com/manual-layout-transitions-part-1/" title="Permalink to Manual Layout Transitions – Part 1" target="_blank" rel="external"><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Manual Layout Transitions – Part 1</span></a> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://blog.stylingandroid.com/author/admin/" property="cc:attributionName" rel="external" target="_blank">Styling Android</a> is licensed under a <a rel="external" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.<br>Permissions beyond the scope of this license may be available at <a xmlns:cc="http://creativecommons.org/ns#" href="http://blog.stylingandroid.com/license-information" rel="external" target="_blank">http://blog.stylingandroid.com/license-information</a>.</p>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/04/27/手动实现布局Transitions动画-第二部分/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/04/27/手动实现布局Transitions动画-第二部分/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/16/理解Java中的ThreadLocal/" title="理解Java中的ThreadLocal" itemprop="url">理解Java中的ThreadLocal</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-02-16T05:55:28.000Z" itemprop="datePublished"> 发表于 2017-02-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="理解Java中的ThreadLocal"><a href="#理解Java中的ThreadLocal" class="headerlink" title="理解Java中的ThreadLocal"></a>理解Java中的ThreadLocal</h1><p>之前面试的时候，面试官问题threadlocal怎么用？当时就懵逼了，只是见过，却不知道如何使用。</p>
<p>提到ThreadLocal，有些Android或者Java程序员可能有所陌生，可能会提出种种问题，它是做什么的，是不是和线程有关，怎么使用呢？等等问题，本文将总结一下我对ThreadLocal的理解和认识，希望让大家理解ThreadLocal更加透彻一些。</p>
<h4 id="ThreadLocal是什么？"><a href="#ThreadLocal是什么？" class="headerlink" title="ThreadLocal是什么？"></a>ThreadLocal是什么？</h4><p>ThreadLocal是一个关于创建线程局部变量的类。</p>
<p>通常情况下，我们创建的变量是可以被任何一个线程访问并修改的。而使用ThreadLocal创建的变量只能被当前线程访问，其他线程则无法访问和修改。</p>
<h3 id="用法简介"><a href="#用法简介" class="headerlink" title="用法简介"></a>用法简介</h3><ul>
<li><p>创建，支持泛型</p>
<p><code>ThreadLocal&lt;String&gt; mStringThreadLocal = new ThreadLocal&lt;&gt;();</code></p>
</li>
<li><p>set方法</p>
<p><code>mStringThreadLocal.set(&quot;droidyue.com&quot;);</code></p>
</li>
<li><p>get方法</p>
<p><code>mStringThreadLocal.get();</code></p>
</li>
</ul>
<h3 id="完整的使用示例"><a href="#完整的使用示例" class="headerlink" title="完整的使用示例"></a>完整的使用示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">private void testThreadLocal() &#123;</div><div class="line">    Thread t = new Thread() &#123;</div><div class="line">        ThreadLocal&lt;String&gt; mStringThreadLocal = new ThreadLocal&lt;&gt;();</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            super.run();</div><div class="line">            mStringThreadLocal.set(&quot;droidyue.com&quot;);</div><div class="line">            mStringThreadLocal.get();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    t.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li>实现单个线程单例以及单个线程上下文信息存储，比如交易id等</li>
<li>实现线程安全，非线程安全的对象使用ThreadLocal之后就会变得线程安全，因为每个线程都会有一个对应的实例</li>
<li>承载一些线程相关的数据，避免在方法中来回传递参数</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/02/16/理解Java中的ThreadLocal/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/02/16/理解Java中的ThreadLocal/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/15/Java之数组array和集合list、set、map/" title="数组与集合" itemprop="url">数组与集合</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2017-02-15T09:16:28.000Z" itemprop="datePublished"> 发表于 2017-02-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Java之数组array和集合list、set、map"><a href="#Java之数组array和集合list、set、map" class="headerlink" title="Java之数组array和集合list、set、map"></a>Java之数组array和集合list、set、map</h1><p>最基础的是array,所有的集合都是通过array实现的。</p>
<p>在代码中进行随机访问和存储，array的效率是最高的，但是array是固定的，不能动态改变，且一个array只能存放同一种数据类型。针对以上缺点，就出现了集合就是list,set,map。</p>
<p>java集合可以存储和操作不固定的一组数据，但是只能存放引用类型的数据，不能放基本数据类型。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/02/15/Java之数组array和集合list、set、map/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/02/15/Java之数组array和集合list、set、map/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/08/git命令使用大全/" title="Git命令使用大全" itemprop="url">Git命令使用大全</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kevin" target="_blank" itemprop="author">Kevin</a>
		
  <p class="article-time">
    <time datetime="2016-12-08T04:10:15.000Z" itemprop="datePublished"> 发表于 2016-12-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="1-新建代码库"><a href="#1-新建代码库" class="headerlink" title="1.新建代码库"></a>1.新建代码库</h4><ul>
<li><p>在当前目录新建一个Git代码库</p>
<p><code>$ git init</code></p>
</li>
<li><p>新建一个目录，将其初始化为Git代码库</p>
<p><code>$ git init [project-name]</code></p>
</li>
<li><p>下载一个项目和它的整个代码历史</p>
<p><code>$ git clone [url]</code></p>
</li>
</ul>
<h4 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h4><p>Git的设置文件为.gitconfig，它可以在用户主目录下（全局配置），也可以在项目目录下（项目配置）。</p>
<ul>
<li><p>显示当前的Git配置</p>
<p><code>$ git config —list</code></p>
</li>
<li><p>编辑Git配置文件</p>
<p><code>$ git config -e [—global]</code></p>
</li>
<li><p>设置提交代码时的用户信息</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git config [--global] user.name &quot;[name]&quot;</div><div class="line">$ git config [--global] user.email &quot;[email address]&quot;</div></pre></td></tr></table></figure>
<h4 id="3-增加-删除文件"><a href="#3-增加-删除文件" class="headerlink" title="3.增加/删除文件"></a>3.增加/删除文件</h4><ul>
<li><p>添加指定文件到暂存区</p>
<p><code>$ git add [file1][file2] …</code></p>
</li>
<li><p>添加指定目录到暂存区，包括子目录</p>
<p><code>$ git add [dir]</code></p>
</li>
<li><p>添加当前目录的所有文件到暂存区</p>
<p><code>$ git add .</code></p>
</li>
<li><p>添加每个变化前，都会要求确认,对于同一个文件的多处变化，可以实现分次提交</p>
<p><code>$ git add -p</code></p>
</li>
<li><p>删除工作区文件，并且将这次删除放入暂存区</p>
<p><code>$ git rm [file1][file2] …</code></p>
</li>
<li><p>停止追踪指定文件，但该文件会保留在工作区</p>
<p><code>$ git rm --cached [file]</code></p>
</li>
<li><p>改名文件，并且将这个改名放入暂存区</p>
<p><code>$ git mv [file-original][file-renamed]</code></p>
</li>
</ul>
        
        
        <p class="article-more-link">
          
            <a href="/2016/12/08/git命令使用大全/#more">阅读全文</a>
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/git/">git</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/12/08/git命令使用大全/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/12/08/git命令使用大全/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="kevin1202" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/git/" title="git">git<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/mac/" title="mac">mac<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/git/" title="git">git<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mac/" title="Mac">Mac<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Library/" title="Library">Library<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Spannable/" title="Spannable">Spannable<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/TimerTask/" title="TimerTask">TimerTask<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Timer/" title="Timer">Timer<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/size/" title="size">size<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Travis-CI/" title="Travis-CI">Travis-CI<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 每天进步一点，就是要付诸行动。光有进步一点的想法，而不付诸行动，那么这种想  <br/>
			法只是空想，是永远也不会有进步的。”路行之而成”，路是人走出来的；进步也是人 </p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/5052645262" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/kevin1202" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:yangkai1202@126.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Kevin">Kevin</a>
		
		
		</p>
		<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','DBjSFU5kGEcv8E-m-m_m','2.0.0');
</script>
</div></footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?575e1640d293c4bdc82c5d203e895c4f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
